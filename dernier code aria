<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="google-site-verification" content="t19y5zAMTFHWn1o4OKePtC58vda4rH0TLchciQZg9mE" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ARIA">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#667eea">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-touch-fullscreen" content="yes">
    <meta name="display" content="fullscreen">
    <meta name="orientation" content="portrait">
    <title>ARIA - V30 Ultimate</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"><!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="google-site-verification" content="t19y5zAMTFHWn1o4OKePtC58vda4rH0TLchciQZg9mE" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ARIA">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#667eea">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-touch-fullscreen" content="yes">
    <meta name="display" content="fullscreen">
    <meta name="orientation" content="portrait">
    <title>ARIA - V30 Ultimate</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
      /* 1. RESET DE BASE OBLIGATOIRE (MODIFI√â) */
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            -webkit-tap-highlight-color: transparent;
            overflow: hidden; /* Emp√™che le rebond √©lastique de Safari */
        }
        
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            min-height: 100dvh; /* Force la hauteur dynamique iOS */
            background-color: #667eea;
            position: fixed;
            inset: 0; /* Force l'ancrage aux 4 coins */
            overflow: hidden;
            overscroll-behavior: none;
        }

        /* 2. LE FOND MAGIQUE (FIX POUR MOBILE) */
        /* Au lieu de peindre le body, on cr√©e un calque virtuel derri√®re qui ne bouge jamais */
     body::before {
            content: "";
            position: fixed;
            top: -10vh; /* On remonte un peu pour centrer le d√©passement */
            left: 0;
            width: 100vw;
            height: 120vh; /* ASTUCE : Plus grand que l'√©cran pour √©viter la coupure en bas */
            z-index: -1;
            
            /* Ton d√©grad√© original */
            background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #4facfe 75%, #00f2fe 100%);
            background-size: 400% 400%;
            animation: gradient-shift 15s ease infinite;
            pointer-events: none; /* Important : permet de cliquer au travers */
        }

        /* 3. LE CONTENU (SCROLLABLE) */
        body {
            font-family: 'Segoe UI', sans-serif;
            overflow-x: hidden;
            /* Plus de background ici, c'est g√©r√© par ::before */
        }

        #app {
          position: absolute; /* Mieux que fixed pour le scroll interne */
            top: 0;
            left: 0;
            width: 100%;
            height: 100dvh; /* Hauteur exacte de la vue dynamique */
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            
            /* Gestion sp√©cifique de la barre du bas iPhone */
            padding-bottom: env(safe-area-inset-bottom, 20px); 
        }
        
        /* Fix pour iPhone - Prendre toute la hauteur de l'√©cran */
        @supports (-webkit-touch-callout: none) {
            html {
                height: -webkit-fill-available;
            }
            body {
                height: -webkit-fill-available;
                padding-bottom: env(safe-area-inset-bottom);
            }
            #app {
                height: -webkit-fill-available;
                padding-bottom: env(safe-area-inset-bottom);
            }
        }
        
        /* Masquer la barre d'adresse du navigateur sur mobile */
        @media screen and (display-mode: standalone) {
            body {
                padding-bottom: env(safe-area-inset-bottom) !important;
            }
        }
        
        /* Style pour mode plein √©cran - Prendre toute la hauteur */
        @media all and (display-mode: standalone) {
            html, body, #app {
                height: 100vh !important;
                height: 100dvh !important;
                height: -webkit-fill-available !important;
            }
        }
        
        /* Forcer la hauteur compl√®te sur mobile */
        @media (max-width: 768px) {
            html, body {
                min-height: 100vh;
                min-height: 100dvh;
                min-height: -webkit-fill-available;
            }
        }

        /* --- RESTE DE TON CSS (ANIMATIONS & COMPOSANTS) --- */

        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* Animations */
        @keyframes fadeIn { from {opacity:0; transform: translateY(10px);} to {opacity:1; transform: translateY(0);} }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        
        @keyframes popIn { 0%{transform: scale(0.9); opacity: 0;} 100%{transform: scale(1); opacity: 1;} }
        .pop-in { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        @keyframes slideUp { from {transform: translateY(20px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }
        .slide-up { animation: slideUp 0.4s ease-out forwards; }

        @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); } 20%, 40%, 60%, 80% { transform: translateX(5px); } }
        .animate-shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        
        /* Animations pour header moderne */
        @keyframes shimmer {
            0% { transform: translateX(-100%) skewX(-15deg); }
            100% { transform: translateX(200%) skewX(-15deg); }
        }
        .animate-shimmer { animation: shimmer 2s infinite; }
        
        @keyframes gradient-shift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        .animate-gradient-shift {
            background-size: 200% 200%;
            animation: gradient-shift 3s ease infinite;
        }
        
        @keyframes pulse-slow {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.1); }
        }
        .animate-pulse-slow { animation: pulse-slow 4s ease-in-out infinite; }
        
        @keyframes bounce-slow {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        .animate-bounce-slow { animation: bounce-slow 2s ease-in-out infinite; }
        
        /* Animation shine pour effet de brillance */
        @keyframes shine {
            0% { transform: translateX(-100%) skewX(-12deg); }
            100% { transform: translateX(200%) skewX(-12deg); }
        }
        .animate-shine { animation: shine 3s infinite; }
        
        /* Animation fadeIn pour modale */
        .animate-fadeIn { animation: fadeIn 0.3s ease-out forwards; }
        
        /* Confetti */
        .confetti { position: fixed; width: 10px; height: 10px; background-color: #f00; animation: fall linear forwards; z-index: 1; pointer-events: none !important; }
        @keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }
        
        /* Animation pour notification toast */
        @keyframes slide-in-right {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .animate-slide-in-right {
            animation: slide-in-right 0.3s ease-out forwards;
        }
        
        /* Transition Vue pour toast */
        .toast-enter-active {
            transition: all 0.3s ease-out;
        }
        .toast-leave-active {
            transition: all 0.3s ease-in;
        }
        .toast-enter-from {
            transform: translateX(100%);
            opacity: 0;
        }
        .toast-leave-to {
            transform: translateX(100%);
            opacity: 0;
        }

        /* Scrollbar Masqu√©e */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

        .logo-img { width: 20px; height: 20px; object-fit: contain; border-radius: 4px; }
        .badge-status { padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; }
        .custom-checkbox { width: 24px; height: 24px; cursor: pointer; accent-color: #2563EB; z-index: 50; position: relative; }

        /* Style sp√©cifique du Date Picker V22 */
        .date-card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        .date-card-selected {
            border-color: #2563EB; 
            background-color: #2563EB;
            color: white;
            box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.5), 0 4px 6px -2px rgba(37, 99, 235, 0.5);
        }

        /* Masquer la fl√®che du datalist */
        input::-webkit-calendar-picker-indicator {
            display: none !important;
        }

        /* --- NOUVEAUX STYLES POUR RENDRE-VOUS EN COURS --- */
        @keyframes status-pulse {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); } 
            70% { box-shadow: 0 0 0 8px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
        
        /* Animation BORDURE CARD (Demand√©e) */
        @keyframes border-pulse { 
            0% { border-color: rgba(34, 197, 94, 0.2); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); } 
            50% { border-color: rgba(34, 197, 94, 1); box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); } 
            100% { border-color: rgba(34, 197, 94, 0.2); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); } 
        }
        .live-animation { animation: border-pulse 2s infinite; border: 2px solid #22c55e !important; }

        .status-label-active {
            font-size: 10px; font-weight: 900; text-transform: uppercase; color: #22c55e;
            display: flex; align-items: center; padding: 4px 8px; border-radius: 6px;
            background-color: #f0fdf4; border: 1px solid #bbf7d0; letter-spacing: 0.5px;
            animation: fadeIn 0.4s ease-out forwards;
        }
        .status-label-active .live-dot {
            width: 8px; height: 8px; background-color: #22c55e; border-radius: 50%; margin-right: 6px;
            animation: status-pulse 1.5s infinite;
        }
       /* =========================================
           üéÖ TH√àME NO√ãL - ULTRA COMPLET üéÖ
           ========================================= */

        /* 1. CURSEUR SAPIN (Uniquement sur PC) */
        @media (min-width: 768px) {
            .theme-christmas, 
            .theme-christmas button, 
            .theme-christmas a, 
            .theme-christmas input {
                /* Remplace le curseur par un Sapin */
                cursor: url('https://img.icons8.com/color/32/christmas-tree.png'), auto !important;
            }
            /* Curseur "Main" devient un P√®re No√´l ou Cadeau */
            .theme-christmas .cursor-pointer {
                cursor: url('https://img.icons8.com/color/32/gift--v1.png'), pointer !important;
            }
        }

        /* 2. EFFET "GRELOT" (Les boutons tremblent au survol) */
        @keyframes jingle {
            0% { transform: rotate(0); }
            25% { transform: rotate(5deg); }
            50% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
            100% { transform: rotate(0); }
        }

        .theme-christmas button:hover,
        .theme-christmas .cursor-pointer:hover {
            animation: jingle 0.5s ease-in-out infinite; /* √áa grelotte ! */
            box-shadow: 0 0 15px rgba(220, 38, 38, 0.8) !important; /* Lueur rouge */
        }

        /* 3. NEIGE MAGIQUE (Tombe et ondule) */
        .snowflake {
            position: fixed; top: -5vh; color: #fff;
            text-shadow: 0 0 5px rgba(255,255,255,0.8);
            pointer-events: none !important; z-index: 1;
            animation: snowfall linear infinite;
        }
        @keyframes snowfall {
            0% { transform: translateY(0) translateX(0) rotate(0deg); opacity: 1; }
            25% { transform: translateY(25vh) translateX(15px) rotate(90deg); }
            50% { transform: translateY(50vh) translateX(-15px) rotate(180deg); }
            75% { transform: translateY(75vh) translateX(15px) rotate(270deg); }
            100% { transform: translateY(110vh) translateX(0) rotate(360deg); opacity: 0; }
        }

        /* 4. COULEURS & D√âGRAD√âS NO√ãL */
        .theme-christmas body { background-color: #fff1f2 !important; /* Fond ros√© hiver */ }

        /* Les boutons bleus deviennent ROUGE NO√ãL */
        .theme-christmas .bg-blue-600 { 
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%) !important; 
            border: 1px solid #fca5a5;
        }
        
        /* Les textes bleus deviennent VERT SAPIN */
        .theme-christmas .text-blue-600, 
        .theme-christmas .text-blue-500 { 
            color: #166534 !important; /* Vert fonc√© */
            font-weight: 800;
        }

        /* Fonds clairs (cartes) deviennent l√©g√®rement teint√©s */
        .theme-christmas .bg-blue-50 { background-color: #fef2f2 !important; border-color: #fecaca !important; }
        .theme-christmas .border-blue-200 { border-color: #fecaca !important; }

        /* 5. LOGO QUI RESPIRE (PULSE) */
        .theme-christmas .sidebar-logo {
            background: linear-gradient(135deg, #15803d 0%, #b91c1c 100%) !important;
            border: 2px solid #fbbf24; /* Bordure dor√©e */
            animation: christmas-pulse 3s infinite ease-in-out;
        }
        @keyframes christmas-pulse {
            0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); transform: scale(1); }
            50% { box-shadow: 0 0 20px 10px rgba(220, 38, 38, 0); transform: scale(1.1); }
            100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); transform: scale(1); }
        }

        /* 6. SUCRE D'ORGE (Barres de progression) */
        .theme-christmas .bg-blue-500, .theme-christmas .h-full.bg-black\/50 {
            background: repeating-linear-gradient(45deg, #dc2626, #dc2626 10px, #ffffff 10px, #ffffff 20px) !important;
            background-size: 28px 28px !important;
            animation: candy-stripe 1s linear infinite !important;
        }
        @keyframes candy-stripe { 0% { background-position: 0 0; } 100% { background-position: 28px 0; } }

        /* 7. ADAPTATION T√âL√âPHONE ("Typhons") */
        @media (max-width: 768px) {
            /* Sur mobile, le curseur redevient normal (pas de bug tactile) */
            .theme-christmas * { cursor: auto !important; }
            
            /* Les boutons importants respirent tout seuls (car pas de survol) */
            .theme-christmas button.bg-slate-900, /* Bouton Nouveau */
            .theme-christmas button.bg-blue-600 { /* Boutons actions */
                animation: heartbeat 2s infinite !important;
            }
            @keyframes heartbeat {
                0% { transform: scale(1); }
                10% { transform: scale(1.03); }
                20% { transform: scale(1); }
                100% { transform: scale(1); }
            }
        }

        /* --- AUTRES TH√àMES --- */
        .theme-summer .bg-blue-600 { background-color: #0ea5e9 !important; }
       /* =================================================================
           üéÉ HALLOWEEN : MODE "CYBER-WITCH" (Sombre & N√©on)
           ================================================================= */
        .theme-halloween body { 
            background: radial-gradient(circle at center, #2e1065 0%, #000000 100%) !important;
            color: #e4e4e7 !important;
        }
        
        /* Cartes "Verre Fum√©" */
        .theme-halloween .bg-white, .theme-halloween .bg-slate-50 { 
            background-color: rgba(20, 20, 20, 0.85) !important; 
            border: 1px solid rgba(139, 92, 246, 0.3); /* Bordure violette */
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            color: #fff !important;
        }

        /* Textes */
        .theme-halloween .text-slate-800, .theme-halloween .text-slate-700 { color: #fff !important; }
        .theme-halloween .text-slate-500 { color: #a1a1aa !important; }
        
        /* Boutons "Sortil√®ge" */
        .theme-halloween .bg-blue-600, .theme-halloween .bg-slate-900 { 
            background: linear-gradient(45deg, #f97316, #7c3aed) !important; 
            border: none;
            box-shadow: 0 0 15px #7c3aed;
            position: relative; overflow: hidden;
        }
        .theme-halloween .bg-blue-600:hover { box-shadow: 0 0 30px #f97316; transform: scale(1.02); }

        /* Cursors */
        @media (min-width: 768px) {
            .theme-halloween * { cursor: url('https://img.icons8.com/color/32/ghost.png'), auto !important; }
            .theme-halloween .cursor-pointer { cursor: url('https://img.icons8.com/color/32/halloween-pumpkin.png'), pointer !important; }
        }

        /* =================================================================
           ‚ù§Ô∏è TH√àME SAINT-VALENTIN : MODE "CALME & CHIC" (100% Fixe)
           ================================================================= */
        .theme-love body { 
            background: linear-gradient(to bottom, #fff1f2, #ffe4e6) !important; 
            color: #881337 !important;
        }

        /* Cartes fixes et propres */
        .theme-love .bg-white, .theme-love .bg-slate-50 { 
            background-color: #fff !important;
            border: 1px solid #fecdd3 !important;
            box-shadow: 0 4px 6px -1px rgba(225, 29, 72, 0.1); /* Ombre l√©g√®re rose */
            color: #4c0519 !important;
        }

        /* Textes */
        .theme-love .text-slate-800 { color: #881337 !important; }
        .theme-love .text-slate-500 { color: #9f1239 !important; }
        
        /* Boutons fixes (Pas de battement de coeur) */
        .theme-love .bg-blue-600, .theme-love .bg-slate-900 { 
            background: linear-gradient(135deg, #be123c 0%, #e11d48 100%) !important; 
            border: none;
            box-shadow: 0 4px 6px rgba(190, 18, 60, 0.2);
        }
        
        /* Survol simple (Juste un changement de couleur, pas de mouvement) */
        .theme-love .bg-blue-600:hover { 
            background: linear-gradient(135deg, #e11d48 0%, #be123c 100%) !important; 
        }

        /* Accents */
        .theme-love .text-blue-600 { color: #db2777 !important; }
        .theme-love .bg-blue-50 { background-color: #fff1f2 !important; border-color: #fda4af !important; }

        /* Logo fixe */
        .theme-love .sidebar-logo {
            background: linear-gradient(to bottom right, #fb7185, #be123c) !important;
            box-shadow: 0 0 0 2px rgba(251, 113, 133, 0.2);
        }

        /* Curseur standard (pour √©viter la fatigue visuelle) */
        @media (min-width: 768px) {
            .theme-love * { cursor: auto !important; }
            .theme-love .cursor-pointer { cursor: pointer !important; }
        }

        /* =================================================================
           üéÜ 14 JUILLET : MODE "R√âPUBLIQUE" (√âl√©gance Tricolore)
           ================================================================= */
        .theme-bastille body { background-color: #f1f5f9 !important; }

        /* Boutons Patriotiques (D√©grad√© Bleu Blanc Rouge subtil) */
        .theme-bastille .bg-blue-600, .theme-bastille .bg-slate-900 { 
            background: linear-gradient(90deg, #1e3a8a 0%, #1d4ed8 50%, #dc2626 100%) !important; 
            background-size: 200% auto;
            transition: 0.5s;
            border: 1px solid #fff;
            box-shadow: 0 4px 10px rgba(30, 58, 138, 0.3);
        }
        .theme-bastille .bg-blue-600:hover { background-position: right center !important; }

        /* Titres en Bleu Roi */
        .theme-bastille .text-slate-800 { color: #1e3a8a !important; }
        
        /* Logo qui √©tincelle */
        .theme-bastille .sidebar-logo {
            background: #dc2626 !important;
            animation: fireworks-flash 2s infinite;
        }
        @keyframes fireworks-flash {
            0%, 100% { box-shadow: 0 0 5px #1e3a8a; }
            50% { box-shadow: 0 0 20px #dc2626, 0 0 40px #fff; }
        }

        /* Cursors */
        @media (min-width: 768px) {
            .theme-bastille * { cursor: url('https://img.icons8.com/color/32/france.png'), auto !important; }
            .theme-bastille .cursor-pointer { cursor: url('https://img.icons8.com/color/32/firework.png'), pointer !important; }
        }

        /* =================================================================
           ‚òÄÔ∏è √âT√â / VACANCES : MODE "LAGON" (Fra√Æcheur & Soleil)
           ================================================================= */
        .theme-summer body { background-color: #ecfeff !important; } /* Cyan tr√®s p√¢le */

        /* Boutons "Mojito" (D√©grad√© Cyan/Jaune) */
        .theme-summer .bg-blue-600 { 
            background: linear-gradient(135deg, #06b6d4 0%, #f59e0b 100%) !important; 
            box-shadow: 0 4px 15px rgba(6, 182, 212, 0.4);
        }
        .theme-summer .bg-blue-600:hover { transform: rotate(-2deg) scale(1.05); }

        /* Cartes lumineuses */
        .theme-summer .bg-white { border-bottom: 4px solid #f59e0b !important; }

        /* Textes "Mer des Cara√Øbes" */
        .theme-summer .text-blue-600 { color: #0891b2 !important; }
        
        /* Logo Soleil qui tourne */
        .theme-summer .sidebar-logo {
            background: linear-gradient(to bottom, #f59e0b, #ea580c) !important;
            animation: spin-slow 20s linear infinite;
        }

        /* Cursors */
        @media (min-width: 768px) {
            .theme-summer * { cursor: url('https://img.icons8.com/color/32/sun--v1.png'), auto !important; }
            .theme-summer .cursor-pointer { cursor: url('https://img.icons8.com/color/32/melting-ice-cream.png'), pointer !important; }
        }

        /* =================================================================
           ‚ú® TH√àME MODERNE CHIC : MODE "LUXURY PREMIUM" (√âl√©gance & Sophistication)
           ================================================================= */
        
        /* Application du th√®me moderne par d√©faut */
        .theme-modern,
        body:not(.theme-christmas):not(.theme-halloween):not(.theme-love):not(.theme-bastille):not(.theme-summer):not(.theme-newyear) {
            /* Tous les styles modernes s'appliquent */
        }

        /* Effet Glassmorphism pour les cartes */
        .bg-white, .bg-slate-50 { 
            background: rgba(255, 255, 255, 0.95) !important;
            border: 1px solid rgba(255, 255, 255, 0.3) !important;
            box-shadow: 0 8px 32px 0 rgba(102, 126, 234, 0.15), 
                        0 4px 16px 0 rgba(118, 75, 162, 0.1) !important;
        }

        /* Header avec effet verre */
        header.bg-white\/80 {
            background: rgba(255, 255, 255, 0.9) !important;
            border-color: rgba(102, 126, 234, 0.2) !important;
        }

        /* Sidebar √©l√©gante */
        aside.bg-white {
            background: rgba(255, 255, 255, 0.95) !important;
            border-right: 1px solid rgba(102, 126, 234, 0.2) !important;
            box-shadow: 4px 0 24px rgba(102, 126, 234, 0.1) !important;
        }

        /* Boutons avec d√©grad√© premium */
        .bg-blue-600, .bg-slate-900 { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%) !important;
            border: none !important;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4),
                        0 4px 15px rgba(118, 75, 162, 0.3),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2) !important;
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }
        .bg-blue-600:hover, .bg-slate-900:hover {
            transform: translateY(-2px) scale(1.02) !important;
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.5),
                        0 6px 20px rgba(118, 75, 162, 0.4),
                        inset 0 1px 0 rgba(255, 255, 255, 0.3) !important;
        }
        .bg-blue-600:active, .bg-slate-900:active {
            transform: translateY(0) scale(0.98) !important;
        }

        /* Effet brillant sur les boutons */
        .bg-blue-600::before, .bg-slate-900::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }
        .bg-blue-600:hover::before, .bg-slate-900:hover::before {
            left: 100%;
        }

        /* Textes avec couleurs sophistiqu√©es */
        .text-slate-800, .text-slate-700 { 
            color: #1e1b4b !important; /* Indigo tr√®s fonc√© */
        }
        .text-slate-500 { 
            color: #6366f1 !important; /* Indigo moyen */
        }
        .text-blue-600, .text-blue-500 { 
            color: #667eea !important; /* Violet-bleu */
            font-weight: 600;
        }

        /* Zones actives avec fond d√©grad√© subtil */
        .bg-blue-50 { 
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%) !important;
            border-color: rgba(102, 126, 234, 0.3) !important;
        }
        .border-blue-200 { 
            border-color: rgba(102, 126, 234, 0.4) !important;
        }

        /* Logo avec effet premium */
        .sidebar-logo {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%) !important;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4),
                        inset 0 1px 0 rgba(255, 255, 255, 0.3) !important;
            animation: logo-glow 3s ease-in-out infinite !important;
        }
        @keyframes logo-glow {
            0%, 100% { 
                box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4),
                            inset 0 1px 0 rgba(255, 255, 255, 0.3);
            }
            50% { 
                box-shadow: 0 12px 32px rgba(118, 75, 162, 0.6),
                            inset 0 1px 0 rgba(255, 255, 255, 0.4);
            }
        }

        /* Cartes avec effet hover √©l√©gant */
        .rounded-2xl, .rounded-3xl, .rounded-xl {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }
        .rounded-2xl:hover, .rounded-3xl:hover {
            transform: translateY(-4px) !important;
            box-shadow: 0 12px 40px rgba(102, 126, 234, 0.2),
                        0 6px 20px rgba(118, 75, 162, 0.15) !important;
        }

        /* Scrollbar √©l√©gante */
        ::-webkit-scrollbar { 
            width: 8px; 
            height: 8px; 
        }
        ::-webkit-scrollbar-track { 
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            border: 2px solid transparent;
            background-clip: padding-box;
        }
        ::-webkit-scrollbar-thumb:hover { 
            background: linear-gradient(135deg, #764ba2 0%, #f093fb 100%);
        }

        /* Inputs avec style moderne */
        input, textarea, select {
            background: rgba(255, 255, 255, 0.9) !important;
            border-color: rgba(102, 126, 234, 0.3) !important;
            transition: all 0.3s !important;
        }
        input:focus, textarea:focus, select:focus {
            border-color: #667eea !important;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1) !important;
            background: rgba(255, 255, 255, 1) !important;
        }

        /* Badges avec d√©grad√© */
        .badge-status {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%) !important;
            border: 1px solid rgba(102, 126, 234, 0.3) !important;
        }

        /* Styles pour le calendrier semaine */
        .calendar-week-container {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: white;
        }
        .calendar-week-grid {
            display: grid;
            grid-template-columns: 60px repeat(7, 1fr);
            min-height: 600px;
        }
        .calendar-time-column {
            border-right: 2px solid #e2e8f0;
            background: #f8fafc;
        }
        .calendar-time-header {
            height: 60px;
            border-bottom: 2px solid #e2e8f0;
        }
        .calendar-time-cell {
            height: 60px;
            border-bottom: 1px solid #f1f5f9;
            padding: 4px 8px;
            font-size: 11px;
            color: #64748b;
            font-weight: 600;
            display: flex;
            align-items: flex-start;
            padding-top: 8px;
        }
        .calendar-day-column {
            border-right: 1px solid #e2e8f0;
            position: relative;
        }
        .calendar-day-column.today-column {
            background: #f0f9ff;
        }
        .calendar-day-header {
            min-height: 100px;
            border-bottom: 2px solid #e2e8f0;
            padding: 12px 8px;
            text-align: center;
            background: white;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .calendar-day-header.today-header {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }
        .calendar-day-header.today-header .text-xs {
            color: rgba(255, 255, 255, 0.9);
        }
        .calendar-day-column.closed-day {
            opacity: 0.5;
            background: #f8fafc;
        }
        .calendar-day-column.closed-day .calendar-time-slot {
            cursor: not-allowed;
        }
        .calendar-time-slots {
            position: relative;
        }
        .calendar-time-slot {
            height: 60px;
            border-bottom: 1px solid #f1f5f9;
            position: relative;
            cursor: pointer;
            transition: background 0.2s;
        }
        .calendar-time-slot:hover {
            background: #f8fafc;
        }
        .calendar-time-slot.current-time {
            background: #fef3c7;
        }
        .calendar-time-slot.closed-slot {
            background: #f8fafc;
            cursor: not-allowed;
            opacity: 0.4;
        }
        .calendar-time-slot.available-slot:hover {
            background: #f0f9ff;
            border-left: 3px solid #3b82f6;
        }
        .calendar-opening-line {
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background: #22c55e;
            z-index: 15;
            pointer-events: none;
        }
        .opening-line-label {
            position: absolute;
            left: 4px;
            top: -12px;
            background: #22c55e;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: bold;
            white-space: nowrap;
        }
        .calendar-event-block {
            position: absolute;
            left: 4px;
            right: 4px;
            padding: 6px 8px;
            border-radius: 6px;
            font-size: 11px;
            color: white;
            cursor: pointer;
            overflow: hidden;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
            transition: all 0.2s;
            border-left: 3px solid rgba(255, 255, 255, 0.5);
        }
        .calendar-event-block:hover {
            transform: translateX(2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.25);
            z-index: 20;
            border-left-width: 4px;
        }
        .event-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .event-time-badge {
            font-size: 9px;
            font-weight: 800;
            opacity: 0.95;
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 4px;
            border-radius: 3px;
            display: inline-block;
            width: fit-content;
        }
        .event-title-text {
            font-size: 11px;
            font-weight: 700;
            line-height: 1.3;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        /* Date picker avec style premium */
        .date-card-selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            border-color: #667eea !important;
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4) !important;
        }

        /* Statut actif avec animation √©l√©gante */
        .status-label-active {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.15) 0%, rgba(34, 197, 94, 0.1) 100%) !important;
            border-color: rgba(34, 197, 94, 0.4) !important;
        }

       

        /* Boutons de navigation avec style moderne */
        button.text-gray-500:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%) !important;
            color: #667eea !important;
        }

        /* Statistiques avec fond d√©grad√© subtil */
        .bg-white.border {
            background: rgba(255, 255, 255, 0.95) !important;
        }
    </style>
</head>
<body>

<div id="app" :class="currentTheme.classes" class="h-screen flex flex-col overflow-hidden text-slate-800 transition-colors duration-500">
   <div class="pointer-events-none fixed inset-0 z-[1] overflow-hidden">
        
        <div v-if="currentTheme.name === 'christmas'">
            <div v-for="n in 50" :key="n" class="snowflake pointer-events-none" :style="{ left: Math.random()*100 + 'vw', animationDuration: (Math.random()*5+5)+'s', animationDelay: '-'+Math.random()*5+'s', fontSize: (Math.random()*10+10)+'px' }">‚ùÑ</div>
            <div class="absolute bottom-[-20px] right-[-10px] opacity-20 text-9xl transform rotate-12 pointer-events-none">üéÑ</div>
        </div>

        <div v-if="currentTheme.name === 'halloween'">
            
            <div class="absolute top-[-20px] right-[-20px] opacity-20 text-[150px] pointer-events-none text-slate-500 rotate-12">üï∏Ô∏è</div>
            
            <div v-for="n in 6" :key="n" class="absolute text-3xl opacity-30 pointer-events-none" 
                 :style="{ 
                     left: Math.random()*100 + 'vw', 
                     top: Math.random()*60 + 'vh', 
                     animation: 'float-ghost ' + (Math.random()*5+5) + 's ease-in-out infinite',
                     fontSize: (Math.random()*20+20)+'px'
                 }">
                 ü¶á
            </div>
            <div v-if="currentTheme.name === 'bastille'">
            <div v-for="n in 5" :key="n" class="absolute w-2 h-2 rounded-full animate-ping pointer-events-none" 
                 :style="{ 
                    left: Math.random()*100 + 'vw', 
                    top: Math.random()*50 + 'vh', 
                    backgroundColor: ['#1e3a8a', '#dc2626', '#ffffff'][Math.floor(Math.random()*3)],
                    animationDuration: '1s', 
                    animationDelay: Math.random()+'s' 
                 }"></div>
             <div class="absolute bottom-4 right-4 opacity-20 text-8xl pointer-events-none">üá´üá∑</div>
        </div>
        

            <div class="absolute bottom-0 left-0 w-full h-32 bg-gradient-to-t from-purple-900/20 to-transparent pointer-events-none"></div>
        </div>

       <div v-if="currentTheme.name === 'love'">
            <div class="absolute bottom-[-30px] right-[-20px] opacity-10 text-[180px] pointer-events-none grayscale-[0.2] rotate-[-15deg]">üåπ</div>
        </div>

        <div v-if="currentTheme.name === 'summer'">
            <div class="sun-ray pointer-events-none"></div> <div class="absolute top-[-50px] right-[-50px] text-9xl text-yellow-400 opacity-20 animate-spin-slow pointer-events-none" style="animation-duration: 20s;">‚òÄÔ∏è</div>
            <div class="absolute bottom-10 left-10 text-6xl opacity-10 pointer-events-none">üç¶</div>
        </div>

        <div v-if="currentTheme.name === 'newyear'">
            <div v-for="n in 40" :key="n" class="confetti pointer-events-none" :style="{ left: Math.random()*100 + 'vw', top: '-10px', backgroundColor: ['#FFD700', '#C0C0C0', '#000'][Math.floor(Math.random()*3)], animationDuration: (Math.random()*3+2)+'s' }"></div>
        </div>

    </div>

    <!-- MODAL D√âCONNEXION FORC√âE -->
    <div v-if="forcedLogoutModal.open" class="fixed inset-0 bg-slate-900/90 z-[1000] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-md text-center pop-in border-4 border-red-100 relative">
            <div class="text-6xl mb-6" v-if="forcedLogoutModal.type === 'deleted'">üóëÔ∏è</div>
            <div class="text-6xl mb-6" v-if="forcedLogoutModal.type === 'blocked'">üö´</div>
            <h3 class="font-bold text-2xl mb-4 text-slate-800">{{ forcedLogoutModal.type === 'deleted' ? 'Votre profil a √©t√© supprim√©' : 'Votre compte a √©t√© bloqu√©' }}</h3>
            <p class="text-slate-600 text-lg mb-6 leading-relaxed">
                {{ forcedLogoutModal.type === 'deleted' ? 'Votre profil a √©t√© supprim√© par l\'administrateur. Vous allez √™tre redirig√© vers la page de connexion.' : 'Votre compte a √©t√© bloqu√©. Contactez l\'administrateur pour plus d\'informations.' }}
            </p>
            <button @click="forcedLogoutModal.open = false; logout()" class="w-full bg-gradient-to-r from-red-600 to-red-700 text-white py-4 rounded-xl font-bold text-lg hover:from-red-700 hover:to-red-800 transition-all shadow-lg transform hover:scale-105">
                Compris <i class="fa-solid fa-check ml-2"></i>
            </button>
        </div>
    </div>

    <!-- MESSAGE BLOCAGE SUR PAGE DE CONNEXION -->
    <div v-if="!user.logged && !isClientMode && blockedLoginMessage.show" class="fixed inset-0 bg-slate-900/90 z-[300] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-md text-center pop-in border-4 border-red-100 relative z-[301]">
            <div class="text-6xl mb-6">üö´</div>
            <h3 class="font-bold text-2xl mb-4 text-slate-800">Compte bloqu√©</h3>
            <p class="text-slate-600 text-lg mb-6 leading-relaxed">
                Votre compte a √©t√© bloqu√©. Contactez l'administrateur pour plus d'informations.
            </p>
            <button @click="blockedLoginMessage.show = false" class="w-full bg-gradient-to-r from-red-600 to-red-700 text-white py-4 rounded-xl font-bold text-lg hover:from-red-700 hover:to-red-800 transition-all shadow-lg transform hover:scale-105">
                Compris <i class="fa-solid fa-check ml-2"></i>
            </button>
        </div>
    </div>

    <!-- MESSAGE ERREUR CONNEXION (MAUVAIS MOT DE PASSE) -->
    <div v-if="!user.logged && !isClientMode && loginErrorModal.show" class="fixed inset-0 bg-slate-900/90 z-[300] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-md text-center pop-in border-4 border-orange-100 relative z-[301]">
            <div class="text-6xl mb-6">‚ö†Ô∏è</div>
            <h3 class="font-bold text-2xl mb-4 text-slate-800">Erreur de connexion</h3>
            <p class="text-slate-600 text-lg mb-6 leading-relaxed">
                {{ loginErrorModal.message }}
            </p>
            <button @click="loginErrorModal.show = false" class="w-full bg-gradient-to-r from-orange-600 to-orange-700 text-white py-4 rounded-xl font-bold text-lg hover:from-orange-700 hover:to-orange-800 transition-all shadow-lg transform hover:scale-105">
                R√©essayer <i class="fa-solid fa-redo ml-2"></i>
            </button>
        </div>
    </div>

    <div v-if="!user.logged && !isClientMode" class="fixed inset-0 bg-slate-900 z-[200] flex items-center justify-center p-4">
        
        <div v-if="!loginAdminSelection" class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center fade-in relative overflow-hidden">
            
            <div class="w-16 h-16 bg-blue-600 rounded-lg flex items-center justify-center text-white mx-auto mb-6 shadow-lg shadow-blue-500/30 relative z-10 overflow-hidden">
                <img v-if="globalSettings.appLogoUrl" :src="globalSettings.appLogoUrl" class="w-full h-full object-cover">
                <i v-else class="fa-solid fa-address-book text-3xl"></i>
            </div>
            
            <h1 class="text-2xl font-bold mb-2 relative z-10">ARIA</h1>
            <p class="text-sm text-slate-500 mb-6 relative z-10">Connexion</p>
            
            <div class="space-y-4 relative z-10">
                <input type="text" v-model="loginEmail" @keyup.enter="login" placeholder="Identifiant / Email" autocomplete="username" class="w-full p-4 border-2 border-gray-200 rounded-xl text-center text-lg mb-2 outline-none focus:border-blue-600 transition">
                <input type="password" v-model="loginPass" @keyup.enter="login" placeholder="Mot de passe" autocomplete="current-password" class="w-full p-4 border-2 border-gray-200 rounded-xl text-center text-lg tracking-widest outline-none focus:border-blue-600 transition">
            </div>

            <button @click="login" class="relative z-10 w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition transform active:scale-95 mt-6 mb-2">Se connecter</button>
            <div class="mt-4 text-xs text-gray-400 relative z-10">Acc√®s s√©curis√©</div>
        </div>

        <div v-else class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center pop-in">
            <h2 class="text-xl font-bold mb-6 text-slate-700">Qui se connecte ?</h2>
            <div class="grid grid-cols-2 gap-3 mb-4">
                <button v-for="name in adminNamesList" :key="name" @click="finalizeAdminLogin(name)" class="p-4 bg-slate-100 hover:bg-blue-100 border-2 border-transparent hover:border-blue-500 rounded-xl font-bold text-slate-700 hover:text-blue-700 transition flex flex-col items-center gap-2">
                    <i class="fa-solid fa-user-tie text-2xl"></i>
                    {{ name }}
                </button>
            </div>
            <button @click="loginAdminSelection=false" class="text-gray-400 hover:text-gray-600 underline text-sm">Retour</button>
        </div>
    </div>

    <div v-else class="flex flex-1 h-full relative">
        <div v-if="isClientMode && clientRdv" class="fixed inset-0 z-[100] flex flex-col items-center justify-center p-4 overflow-y-auto">
        
        <div class="bg-white/90 backdrop-blur-md w-full max-w-md rounded-3xl shadow-2xl overflow-hidden border border-white/50 relative animate-fadeIn">
            
            <div class="h-32 bg-gradient-to-br from-blue-600 to-purple-600 relative p-6 flex flex-col justify-between">
                <div class="flex justify-between items-start">
                    <span class="bg-white/20 text-white px-3 py-1 rounded-full text-xs font-bold backdrop-blur-sm">
                        C&N Solutions
                    </span>
                    <span v-if="clientRdv.statut === 'annule'" class="bg-red-500 text-white px-3 py-1 rounded-full text-xs font-bold shadow-lg">ANNUL√â</span>
                    <span v-else class="bg-green-500 text-white px-3 py-1 rounded-full text-xs font-bold shadow-lg flex items-center gap-1"><i class="fa-solid fa-check"></i> CONFIRM√â</span>
                </div>
                <h1 class="text-white text-2xl font-black mt-2">Bonjour {{ clientRdv.civilite }} {{ clientRdv.nom }}</h1>
            </div>

            <div class="p-6 -mt-6">
                <div class="bg-white rounded-2xl shadow-lg p-6 border border-slate-100">
                    <div class="flex items-center gap-4 mb-6">
                        <div class="w-16 h-16 bg-blue-50 text-blue-600 rounded-2xl flex flex-col items-center justify-center font-bold border-2 border-blue-100">
                            <span class="text-xl">{{ new Date(clientRdv.date).getDate() }}</span>
                            <span class="text-[10px] uppercase">{{ new Date(clientRdv.date).toLocaleDateString('fr-FR', {month:'short'}) }}</span>
                        </div>
                        <div>
                            <div class="text-slate-400 text-xs font-bold uppercase tracking-wider">Votre Rendez-vous</div>
                            <div class="text-2xl font-black text-slate-800">{{ clientRdv.heure }}</div>
                            <div class="text-sm text-slate-500 font-medium">{{ getBaseModele(clientRdv.modele) || clientRdv.modele }}</div>
                        </div>
                    </div>

                    <div v-if="clientRdv.statut !== 'annule' && !clientRdv.demandeClient" class="space-y-3">
                        <p class="text-center text-sm text-slate-400 mb-4">Un emp√™chement ?</p>
                        
                        <button @click="clientRequest.type='report'; clientRequest.showModal=true" class="w-full py-3.5 rounded-xl font-bold bg-blue-50 text-blue-600 hover:bg-blue-100 transition flex items-center justify-center gap-2">
                            <i class="fa-solid fa-calendar-days"></i> Demander un report
                        </button>
                        
                        <button @click="clientRequest.type='annulation'; clientRequest.showModal=true" class="w-full py-3.5 rounded-xl font-bold text-red-500 hover:bg-red-50 border-2 border-transparent hover:border-red-100 transition flex items-center justify-center gap-2">
                            <i class="fa-solid fa-ban"></i> Annuler le rendez-vous
                        </button>
                    </div>

                    <div v-if="clientRdv.demandeClient" class="bg-orange-50 border border-orange-200 rounded-xl p-4 text-center">
                        <div class="w-12 h-12 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center mx-auto mb-2">
                            <i class="fa-solid fa-hourglass-half"></i>
                        </div>
                        <h3 class="font-bold text-orange-800">Demande envoy√©e</h3>
                        <p class="text-xs text-orange-700 mt-1">
                            Votre demande de {{ clientRdv.demandeClient.type }} est en cours de traitement par notre √©quipe.
                        </p>
                    </div>
                </div>

                <div class="text-center mt-6">
                    <a :href="'tel:+33600000000'" class="inline-flex items-center gap-2 text-slate-400 hover:text-blue-600 transition font-bold text-sm">
                        <i class="fa-solid fa-phone"></i> Nous contacter
                    </a>
                </div>
            </div>
        </div>

        <div v-if="clientRequest.showModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[110] flex items-center justify-center p-4 animate-fadeIn">
            <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl">
                <h3 class="font-bold text-xl mb-4 text-slate-800">
                    {{ clientRequest.type === 'report' ? 'Reporter le RDV' : 'Annuler le RDV' }}
                </h3>
                
                <p class="text-sm text-slate-500 mb-4">Merci de nous indiquer la raison afin que nous puissions traiter votre demande rapidement.</p>
                
                <textarea v-model="clientRequest.motif" placeholder="Votre message (ex: Je suis malade, v√©hicule en panne...)" class="w-full p-4 border-2 border-slate-200 rounded-xl outline-none focus:border-blue-500 min-h-[100px] mb-4 bg-slate-50"></textarea>

                <div class="flex gap-3">
                    <button @click="clientRequest.showModal=false" class="flex-1 py-3 rounded-xl font-bold bg-slate-100 text-slate-500">Retour</button>
                    <button @click="submitClientRequest" class="flex-1 py-3 rounded-xl font-bold bg-blue-600 text-white shadow-lg">Envoyer</button>
                </div>
            </div>
        </div>

    </div>
        
        <div v-if="mobileMenuOpen" @click="mobileMenuOpen=false" class="fixed inset-0 bg-black/50 z-30 md:hidden"></div>

        <aside :class="mobileMenuOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0'" class="fixed md:relative w-64 bg-white shadow-xl flex flex-col z-40 h-full transition-transform duration-300 ease-in-out">
            <div class="p-6 border-b flex items-center gap-3">
            <div class="sidebar-logo w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold flex-shrink-0 transition-all duration-500 overflow-hidden relative">
    <img v-if="globalSettings.appLogoUrl" :src="globalSettings.appLogoUrl" class="w-full h-full object-cover">
    
    <div v-else class="flex items-center justify-center w-full h-full">
        <i v-if="currentTheme.name === 'modern'" class="fa-solid fa-sparkles text-lg"></i>
        <i v-else-if="currentTheme.name === 'christmas'" class="fa-solid fa-tree text-lg"></i>
        <i v-else-if="currentTheme.name === 'love'" class="fa-solid fa-heart text-xl text-white"></i>
        <i v-else-if="currentTheme.name === 'halloween'" class="fa-solid fa-hat-wizard text-lg"></i>
        <i v-else-if="currentTheme.name === 'bastille'" class="fa-solid fa-flag-usa text-lg"></i>
        <i v-else-if="currentTheme.name === 'newyear'" class="fa-solid fa-champagne-glasses text-lg"></i>
        <i v-else-if="currentTheme.name === 'summer'" class="fa-solid fa-sun text-lg"></i>
        <i v-else class="fa-solid fa-calendar-check"></i>
    </div>
</div>
                <div class="min-w-0">
                    <h1 class="font-bold text-lg leading-tight truncate">ARIA</h1>
                    <span class="text-[10px] bg-slate-100 px-2 py-0.5 rounded text-slate-500 uppercase font-bold truncate block">{{ user.name }}</span>
                </div>
                <button @click="mobileMenuOpen=false" class="ml-auto md:hidden text-gray-400"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>

            <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                <button @click="changeView('dashboard'); mobileMenuOpen=false" :class="view==='dashboard'?'bg-blue-50 text-blue-600 font-bold border-blue-200':'text-gray-500 hover:bg-gray-50 border-transparent'" class="w-full text-left p-3 rounded-xl flex items-center gap-3 border transition"><i class="fa-solid fa-chart-line w-5 text-center"></i> Tableau de bord</button>
                <button @click="changeView('list'); mobileMenuOpen=false" :class="view==='list'?'bg-blue-50 text-blue-600 font-bold border-blue-200':'text-gray-500 hover:bg-gray-50 border-transparent'" class="w-full text-left p-3 rounded-xl flex items-center gap-3 border transition"><i class="fa-solid fa-address-book w-5 text-center"></i> Tous les RDV</button>
                <button @click="changeView('portefeuille'); mobileMenuOpen=false" :class="view==='portefeuille'?'bg-blue-50 text-blue-600 font-bold border-blue-200':'text-gray-500 hover:bg-gray-50 border-transparent'" class="w-full text-left p-3 rounded-xl flex items-center gap-3 border transition"><i class="fa-solid fa-wallet w-5 text-center"></i> Portefeuille</button>
                <button v-if="user.role !== 'admin'" @click="changeView('a_traiter'); mobileMenuOpen=false" :class="view==='a_traiter'?'bg-orange-50 text-orange-600 font-bold border-orange-200':'text-gray-500 hover:bg-gray-50 border-transparent'" class="w-full text-left p-3 rounded-xl flex items-center gap-3 border transition relative"><i class="fa-solid fa-exclamation-triangle w-5 text-center"></i> √Ä traiter <span v-if="prospecteurUrgentCount > 0" class="ml-auto bg-red-600 text-white text-xs px-2 py-1 rounded-full font-bold">{{ prospecteurUrgentCount }}</span></button>
                <button v-if="user.role==='admin'" @click="changeView('bilan'); mobileMenuOpen=false" :class="view==='bilan'?'bg-blue-50 text-blue-600 font-bold border-blue-200':'text-gray-500 hover:bg-gray-50 border-transparent'" class="w-full text-left p-3 rounded-xl flex items-center gap-3 border transition relative"><i class="fa-solid fa-chart-pie w-5 text-center"></i> Bilan <span v-if="urgentBilanCount > 0" class="ml-auto bg-red-600 text-white text-xs px-2 py-1 rounded-full font-bold">{{ urgentBilanCount }}</span></button>
                <button @click="changeView('rappels'); mobileMenuOpen=false" :class="{'border-red-300 bg-red-50 text-red-600': rappelCount > 0}" class="w-full text-left p-3 rounded-xl flex items-center gap-3 border border-transparent hover:bg-gray-50 transition mt-4"><i class="fa-solid fa-bell w-5 text-center"></i> Rappels <span v-if="rappelCount>0" class="ml-auto bg-red-600 text-white text-xs px-2 py-1 rounded-full font-bold">{{ rappelCount }}</span></button>
                <button v-if="user.role==='admin'" @click="changeView('connexions'); mobileMenuOpen=false" :class="view==='connexions'?'bg-blue-50 text-blue-600 font-bold border-blue-200':'text-gray-500 hover:bg-gray-50 border-transparent'" class="w-full text-left p-3 rounded-xl flex items-center gap-3 border transition mt-4"><i class="fa-solid fa-users w-5 text-center"></i> Connexions <span v-if="connectedUsersCount > 0" class="ml-auto bg-green-600 text-white text-xs px-2 py-1 rounded-full font-bold">{{ connectedUsersCount }}</span></button>
                <button v-if="pendingStatusCount > 0" @click="changeView('pending_status'); mobileMenuOpen=false" class="w-full text-left p-3 rounded-2xl flex items-center gap-3 bg-purple-100 border border-purple-300 text-purple-700 mt-2 font-bold animate-pulse"><i class="fa-solid fa-clipboard-question w-5 text-center"></i> Statuts √† d√©finir <span class="ml-auto bg-purple-600 text-white text-xs px-2 py-1 rounded-full">{{ pendingStatusCount }}</span></button>
                <button v-if="confirmCount > 0" @click="changeView('confirmations'); mobileMenuOpen=false" class="w-full text-left p-3 rounded-2xl flex items-center gap-3 bg-orange-100 border border-orange-300 text-orange-700 mt-2 font-bold animate-pulse"><i class="fa-solid fa-circle-exclamation w-5 text-center"></i> √Ä Confirmer <span class="ml-auto bg-orange-600 text-white text-xs px-2 py-1 rounded-full">{{ confirmCount }}</span></button>
            </nav>

            <div class="p-4 border-t space-y-2">
                <button @click="changeView('trash'); mobileMenuOpen=false" :class="view==='trash'?'bg-gray-100 text-gray-800 font-bold':'text-gray-400 hover:text-gray-600 hover:bg-gray-50'" class="w-full text-left p-3 rounded-xl flex items-center gap-3 transition"><i class="fa-solid fa-trash-can w-5 text-center"></i> Corbeille <span v-if="trashCount > 0" class="ml-auto bg-gray-200 text-gray-600 text-xs px-2 py-1 rounded-full font-bold">{{ trashCount }}</span></button>
            </div>

            <div class="p-4 border-t space-y-2">
                <button v-if="user.role==='admin'" @click="openSettings(); mobileMenuOpen=false" class="w-full text-left p-3 rounded-xl flex items-center gap-3 text-slate-600 hover:bg-slate-100 transition font-bold"><i class="fa-solid fa-gear w-5 text-center"></i> R√©glages</button>
                <button @click="logout" class="w-full text-left p-3 rounded-xl flex items-center gap-3 text-red-400 hover:text-red-600 hover:bg-red-50 transition font-bold"><i class="fa-solid fa-power-off w-5 text-center"></i> D√©connexion</button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col bg-[#f8fafc] relative overflow-hidden h-full w-full fixed inset-0">
          <header class="p-4 md:p-6 z-10 flex items-center gap-3 relative">
            
            <button @click="mobileMenuOpen = !mobileMenuOpen" class="md:hidden w-12 h-12 bg-white border border-slate-200 rounded-2xl text-slate-700 shadow-sm flex items-center justify-center hover:bg-slate-50 transition active:scale-95">
                <i class="fa-solid fa-bars text-xl"></i>
            </button>


            <button @click="startWizard" class="bg-slate-900 hover:bg-slate-800 text-white px-6 py-3.5 rounded-2xl font-bold shadow-xl shadow-slate-300/50 flex items-center gap-3 transform active:scale-95 transition text-sm md:text-base">
                <div class="bg-white/20 w-6 h-6 rounded-full flex items-center justify-center">
                    <i class="fa-solid fa-plus text-xs"></i>
                </div>
                <span>Nouveau RDV</span>
            </button>

        </header>

            <div class="flex-1 overflow-y-auto p-4 md:p-6 pb-20 md:pb-6">
                <div v-if="view==='dashboard'" class="space-y-6 fade-in">
                    <div class="flex flex-col md:flex-row gap-6 mb-6 items-stretch">
                        <div class="flex-1 flex flex-col md:flex-row md:items-center gap-3">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl flex items-center justify-center shadow-lg shadow-purple-300">
                                    <i class="fa-solid fa-chart-line text-white text-xl"></i>
                                </div>
                                <h2 class="text-2xl md:text-3xl font-bold text-slate-800 uppercase tracking-tight">{{ currentFullDateLabel }}</h2>
                            </div>
                            
                            <!-- Indicateur de statut Google Calendar Admin -->
                           <button v-if="user.role === 'admin'" 
                                    @click="googleCalendarConnected && googleCalendarTokenValid ? googleCalendarInfoModal.open = true : (googleCalendarConnected && !googleCalendarTokenValid ? connectGoogleCalendar() : connectGoogleCalendar())"
                                    :class="[
                                        googleCalendarConnected && googleCalendarTokenValid ? 'bg-green-50 border-green-300 text-green-700 cursor-pointer hover:bg-green-100' : 
                                        googleCalendarConnected && !googleCalendarTokenValid ? 'bg-orange-50 border-orange-300 text-orange-700 hover:bg-orange-100 cursor-pointer' : 
                                        'bg-red-50 border-red-300 text-red-700 cursor-pointer hover:bg-red-100'
                                    ]"
                                    class="flex items-center gap-2 px-4 py-2 rounded-xl border-2 transition-all">
                                <i :class="[
                                    googleCalendarConnected && googleCalendarTokenValid ? 'fa-brands fa-google text-green-600' : 
                                    googleCalendarConnected && !googleCalendarTokenValid ? 'fa-solid fa-exclamation-triangle text-orange-600' : 
                                    'fa-solid fa-exclamation-triangle text-red-600'
                                ]" class="text-lg"></i>
                                <span class="text-xs font-bold">
                                    <span v-if="googleCalendarConnected && googleCalendarTokenValid">
                                        Google Calendar connect√©
                                        <span v-if="tokenTimeRemaining" class="ml-2 text-[10px] opacity-75">
                                            ({{ tokenTimeRemaining.minutes }}min {{ tokenTimeRemaining.seconds }}s)
                                        </span>
                                    </span>
                                    <span v-else-if="googleCalendarConnected && !googleCalendarTokenValid">Se reconnecter</span>
                                    <span v-else>Cliquez ici pour connecter Google Calendar</span>
                                </span>
                            </button>

                            <button v-if="user.role === 'admin' && googleCalendarConnected"
                                    @click="forceGlobalRefresh" 
                                    class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-4 py-2 rounded-xl border-2 border-blue-600 shadow-lg transition-all hover:scale-105 font-bold flex items-center gap-2">
                                <i class="fa-solid fa-rotate-right text-base"></i>
                                <span class="text-xs font-bold hidden md:inline">Forcer Update Global</span>
                            </button>

                            <!-- Indicateur de statut Google Calendar Prospecteur - M√äME QUE ADMIN -->
                            <button v-if="user.role !== 'admin'"
                                    @click="handleProspecteurGoogleCalendar"
                                    :class="[
                                        // Utiliser isGoogleCalendarConnected pour d√©tecter si vraiment connect√©
                                        isGoogleCalendarConnected 
                                            ? 'bg-green-50 border-green-300 text-green-700 cursor-pointer hover:bg-green-100' : 
                                        // Token expir√©
                                        (prospecteurGoogleCalendarConnected && prospecteurGoogleCalendarToken && prospecteurGoogleCalendarTokenExpired)
                                            ? 'bg-orange-50 border-orange-300 text-orange-700 hover:bg-orange-100 cursor-pointer' : 
                                        // Pas connect√© du tout
                                        'bg-red-50 border-red-300 text-red-700 cursor-pointer hover:bg-red-100'
                                    ]"
                                    class="flex items-center gap-2 px-4 py-2 rounded-xl border-2 transition-all">
                                <i :class="[
                                    // Utiliser isGoogleCalendarConnected
                                    isGoogleCalendarConnected
                                        ? 'fa-brands fa-google text-green-600' : 
                                    // Token expir√©
                                    (prospecteurGoogleCalendarConnected && prospecteurGoogleCalendarToken && prospecteurGoogleCalendarTokenExpired)
                                        ? 'fa-solid fa-exclamation-triangle text-orange-600' : 
                                    // Pas connect√©
                                    'fa-solid fa-exclamation-triangle text-red-600'
                                ]" class="text-lg"></i>
                                <span class="text-xs font-bold">
                                    <span v-if="isGoogleCalendarConnected">
                                        Google Calendar connect√©
                                        <span v-if="prospecteurDisplayTimeRemaining" class="ml-2 text-[10px] opacity-75">
                                            ({{ prospecteurDisplayTimeRemaining.minutes }}min {{ prospecteurDisplayTimeRemaining.seconds }}s)
                                        </span>
                                    </span>
                                    <span v-else-if="prospecteurGoogleCalendarConnected && prospecteurGoogleCalendarToken && prospecteurGoogleCalendarTokenExpired">Se reconnecter</span>
                                    <span v-else>Cliquez ici pour connecter Google Calendar</span>
                                </span>
                            </button>

                            <button v-if="user.role !== 'admin' && isGoogleCalendarConnected"
                                    @click="reloadProspecteurToken" 
                                    class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-4 py-2 rounded-xl border-2 border-blue-600 shadow-lg transition-all hover:scale-105 font-bold flex items-center gap-2">
                                <i class="fa-solid fa-rotate-right text-base"></i>
                                <span class="text-xs font-bold hidden md:inline">Recharger le token</span>
                            </button>
                           
                        </div>
                        <div class="flex flex-col md:flex-row gap-4">
                            <div @click="openStatsModal" class="cursor-pointer hover:scale-[1.02] transition-all duration-200 bg-gradient-to-br from-white via-purple-50/30 to-white rounded-2xl shadow-lg shadow-purple-200 border-2 border-purple-300 p-5 flex items-center gap-4 min-w-[300px] relative overflow-hidden hover:shadow-xl hover:shadow-purple-300 hover:border-purple-500" :class="conversionRateColor">
                                <div class="absolute inset-0 bg-white opacity-80 z-0"></div>
                                <div class="z-10 text-5xl emoji-bounce filter drop-shadow-lg">{{ conversionEmoji }}</div>
                                <div class="z-10 flex-1">
                                    <p class="text-xs font-bold uppercase tracking-widest text-purple-600 mb-1">Taux de conversion</p>
                                    <div class="flex items-baseline gap-2 mb-2">
                                        <span class="text-4xl font-black text-slate-800">{{ conversionRate }}%</span>
                                        <span class="text-xs font-medium text-slate-500">Honor√©s / Total</span>
                                    </div>
                                    <div class="w-full bg-slate-200 h-2 rounded-full overflow-hidden shadow-inner">
                                        <div class="h-full bg-gradient-to-r from-purple-500 to-purple-600 transition-all duration-1000 rounded-full shadow-sm" :style="{width: conversionRate + '%'}"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- CARTE CA TOTAL - MINIMALISTE MOBILE / COMPL√àTE DESKTOP -->
                    <div class="relative overflow-hidden bg-gradient-to-br from-purple-400 via-purple-500 to-purple-600 rounded-2xl md:rounded-3xl shadow-xl md:shadow-2xl shadow-purple-300/50 p-4 md:p-8 mb-6 border-2 border-purple-300/50">
                        <!-- VERSION MOBILE MINIMALISTE -->
                        <div class="md:hidden relative z-10">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center gap-2">
                                    <i class="fa-solid fa-euro-sign text-white text-lg"></i>
                                    <span class="text-white/90 text-xs font-bold uppercase tracking-wide">CA Total</span>
                                </div>
                                <span class="text-xs text-white/70">Sur RDV honor√©s</span>
                            </div>
                            <div class="text-3xl font-black text-white drop-shadow-lg mb-2">{{ formatPrice(stats.ca || 0) }}</div>
                            <div class="flex items-center gap-3 text-xs text-white/80">
                                <span><i class="fa-solid fa-calendar-check mr-1"></i>{{ stats.honored || 0 }} honor√©s</span>
                                <span>‚Ä¢</span>
                                <span>{{ (stats.honored && stats.honored > 0) ? formatPrice((stats.ca || 0) / stats.honored) : '0‚Ç¨' }} moyen</span>
                            </div>
                        </div>
                        <!-- VERSION DESKTOP COMPL√àTE -->
                        <div class="hidden md:flex relative z-10 flex-row items-center justify-between gap-6">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="w-16 h-16 bg-white/20 backdrop-blur-sm rounded-2xl flex items-center justify-center shadow-lg border border-white/30">
                                        <i class="fa-solid fa-euro-sign text-white text-3xl"></i>
                                    </div>
                                    <div>
                                        <h3 class="text-white/90 text-sm font-bold uppercase tracking-widest mb-1">Chiffre d'Affaires Total</h3>
                                        <p class="text-white/70 text-xs">Sur les RDV honor√©s uniquement</p>
                                    </div>
                                </div>
                                <div class="flex items-baseline gap-3">
                                    <span class="text-6xl md:text-7xl font-black text-white drop-shadow-lg">{{ formatPrice(stats.ca || 0) }}</span>
                                    <div class="px-3 py-1 bg-white/20 backdrop-blur-sm rounded-full border border-white/30">
                                        <span class="text-xs font-bold text-white">CA Total</span>
                                    </div>
                                </div>
                                <div class="mt-4 flex items-center gap-4">
                                    <div class="px-4 py-2 bg-white/20 backdrop-blur-sm rounded-xl border border-white/30">
                                        <p class="text-[10px] text-white/80 font-bold uppercase mb-1">RDV Honor√©s</p>
                                        <p class="text-2xl font-black text-white">{{ stats.honored || 0 }}</p>
                                    </div>
                                    <div class="px-4 py-2 bg-white/20 backdrop-blur-sm rounded-xl border border-white/30">
                                        <p class="text-[10px] text-white/80 font-bold uppercase mb-1">CA Moyen</p>
                                        <p class="text-2xl font-black text-white">{{ (stats.honored && stats.honored > 0) ? formatPrice((stats.ca || 0) / stats.honored) : '0‚Ç¨' }}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center justify-center">
                                <div class="w-32 h-32 bg-white/10 backdrop-blur-sm rounded-full border-4 border-white/30 flex items-center justify-center shadow-2xl">
                                    <div class="text-center">
                                        <i class="fa-solid fa-chart-line text-white text-5xl mb-2"></i>
                                        <p class="text-white/80 text-xs font-bold">Performance</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-white/30 to-transparent"></div>
                    </div>
                    
                   <!-- 4 COLONNES MODERNIS√âES -->
                   <div class="grid grid-cols-1 md:grid-cols-4 gap-4 md:gap-6">
                        <div @click="showUpcoming" class="relative overflow-hidden bg-gradient-to-br from-purple-400 via-purple-500 to-purple-600 rounded-2xl md:rounded-3xl shadow-xl shadow-purple-300/50 border-2 border-purple-300/50 hover:shadow-2xl hover:scale-[1.02] cursor-pointer transition-all duration-200 group p-5 md:p-6">
                            <div class="relative z-10 flex justify-between items-start">
                                <div class="flex-1">
                                    <p class="text-white/90 text-xs font-bold uppercase tracking-wider mb-2">√Ä venir</p>
                                    <p class="text-4xl md:text-5xl font-black text-white mb-1 drop-shadow-lg">{{ stats.upcoming }}</p>
                                    <p class="text-[10px] text-white/80 font-medium">RDV programm√©s</p>
                                </div>
                                <div class="w-14 h-14 md:w-16 md:h-16 bg-white/20 backdrop-blur-sm rounded-xl md:rounded-2xl flex items-center justify-center text-white text-xl md:text-2xl shadow-lg border-2 border-white/30 group-hover:scale-110 transition-transform">
                                    <i class="fa-solid fa-calendar-days"></i>
                                </div>
                            </div>
                            <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-white/30 to-transparent"></div>
                        </div>
                        <div @click="showHonored" class="relative overflow-hidden bg-gradient-to-br from-green-400 via-green-500 to-green-600 rounded-2xl md:rounded-3xl shadow-xl shadow-green-300/50 border-2 border-green-300/50 hover:shadow-2xl hover:scale-[1.02] cursor-pointer transition-all duration-200 group p-5 md:p-6">
                            <div class="relative z-10 flex justify-between items-start">
                                <div class="flex-1">
                                    <p class="text-white/90 text-xs font-bold uppercase tracking-wider mb-2">Honor√©s</p>
                                    <p class="text-4xl md:text-5xl font-black text-white mb-1 drop-shadow-lg">{{ stats.honored }}</p>
                                    <p class="text-[10px] text-white/80 font-medium">RDV honor√©s</p>
                                </div>
                                <div class="w-14 h-14 md:w-16 md:h-16 bg-white/20 backdrop-blur-sm rounded-xl md:rounded-2xl flex items-center justify-center text-white text-xl md:text-2xl shadow-lg border-2 border-white/30 group-hover:scale-110 transition-transform">
                                    <i class="fa-solid fa-check"></i>
                                </div>
                            </div>
                            <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-white/30 to-transparent"></div>
                        </div>
                        <div @click="showNoShow" class="relative overflow-hidden bg-gradient-to-br from-red-400 via-red-500 to-red-600 rounded-2xl md:rounded-3xl shadow-xl shadow-red-300/50 border-2 border-red-300/50 hover:shadow-2xl hover:scale-[1.02] cursor-pointer transition-all duration-200 group p-5 md:p-6">
                            <div class="relative z-10 flex justify-between items-start">
                                <div class="flex-1">
                                    <p class="text-white/90 text-xs font-bold uppercase tracking-wider mb-2">Pas Venus</p>
                                    <p class="text-4xl md:text-5xl font-black text-white mb-1 drop-shadow-lg">{{ stats.noshow }}</p>
                                    <p class="text-[10px] text-white/80 font-medium">Absents</p>
                                </div>
                                <div class="w-14 h-14 md:w-16 md:h-16 bg-white/20 backdrop-blur-sm rounded-xl md:rounded-2xl flex items-center justify-center text-white text-xl md:text-2xl shadow-lg border-2 border-white/30 group-hover:scale-110 transition-transform">
                                    <i class="fa-solid fa-user-xmark"></i>
                                </div>
                            </div>
                            <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-white/30 to-transparent"></div>
                        </div>
                        <div @click="showCancelled" class="relative overflow-hidden bg-gradient-to-br from-slate-400 via-slate-500 to-slate-600 rounded-2xl md:rounded-3xl shadow-xl shadow-slate-300/50 border-2 border-slate-300/50 hover:shadow-2xl hover:scale-[1.02] cursor-pointer transition-all duration-200 group p-5 md:p-6">
                            <div class="relative z-10 flex justify-between items-start">
                                <div class="flex-1">
                                    <p class="text-white/90 text-xs font-bold uppercase tracking-wider mb-2">Annul√©s</p>
                                    <p class="text-4xl md:text-5xl font-black text-white mb-1 drop-shadow-lg">{{ stats.cancelled }}</p>
                                    <p class="text-[10px] text-white/80 font-medium">RDV annul√©s</p>
                                </div>
                                <div class="w-14 h-14 md:w-16 md:h-16 bg-white/20 backdrop-blur-sm rounded-xl md:rounded-2xl flex items-center justify-center text-white text-xl md:text-2xl shadow-lg border-2 border-white/30 group-hover:scale-110 transition-transform">
                                    <i class="fa-solid fa-ban"></i>
                                </div>
                            </div>
                            <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-white/30 to-transparent"></div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-white via-purple-50/20 to-white rounded-3xl shadow-2xl border-2 border-purple-200 p-6 md:p-8 backdrop-blur-sm">
<div class="flex flex-col xl:flex-row justify-between items-start xl:items-center mb-6 gap-4">
                          <div class="flex items-center gap-3 flex-wrap">
                            <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl flex items-center justify-center shadow-lg shadow-purple-300">
                                <i class="fa-regular fa-clock text-white text-xl"></i>
                            </div>
                            <h2 class="text-2xl font-black text-slate-800">
                                <span>{{ isTimelineTomorrow ? 'Rendez-vous Demain' : 'Rendez-vous Aujourd\'hui' }}</span>
                            </h2>

                            <button @click="showTimelineTomorrow" 
                                    :class="isTimelineTomorrow ? 'bg-gradient-to-r from-purple-600 to-purple-700 text-white shadow-xl shadow-purple-300 border-purple-600' : 'bg-white text-slate-600 border-slate-300 hover:bg-gradient-to-r hover:from-purple-50 hover:to-purple-100 hover:border-purple-400'"
                                    class="px-5 py-2.5 rounded-xl text-xs font-bold transition-all duration-200 flex items-center gap-2 border-2 hover:scale-105 shadow-md">
                                <i class="fa-solid fa-calendar-day"></i>
                                <span>Demain</span>
                            </button>

                            <span class="text-xs md:text-sm font-black text-white bg-gradient-to-r from-purple-500 to-purple-600 px-4 py-2 rounded-full border-2 border-purple-400 flex items-center gap-2 shadow-lg">
                                <i class="fa-solid fa-calendar-day"></i>
                                {{ rdvTodayCount }} RDV
                            </span>
                        </div>
                            
                            <div class="flex flex-wrap gap-3 w-full xl:w-auto">
                                <select v-model="dashboardFilters.agencyId" @change="dashboardFilters.commercialId = ''" class="bg-white border-2 border-slate-300 text-slate-700 text-xs font-bold rounded-xl px-4 py-2.5 outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-200 shadow-md hover:border-purple-400 hover:shadow-lg transition-all">
                                    <option value="">Toutes les agences</option>
                                    <option v-for="ag in visibleAgencies" :key="ag.id" :value="ag.id">{{ ag.nom }}</option>
                                </select>

                                <select v-if="user.role === 'admin'" v-model="dashboardFilters.userId" class="bg-white border-2 border-slate-300 text-slate-700 text-xs font-bold rounded-xl px-4 py-2.5 outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-200 shadow-md hover:border-purple-400 hover:shadow-lg transition-all">
                                    <option value="">Toute l'√©quipe</option>
                                    <option v-for="u in allProspectors" :key="u" :value="u">{{ u }}</option>
                                </select>

                                <select v-if="dashboardFilters.agencyId && getAgencyCommerciaux(dashboardFilters.agencyId).length > 0" v-model="dashboardFilters.commercialId" class="bg-white border-2 border-slate-300 text-slate-700 text-xs font-bold rounded-xl px-4 py-2.5 outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-200 shadow-md hover:border-purple-400 hover:shadow-lg transition-all">
                                    <option value="">Tous les commerciaux</option>
                                    <option v-for="comm in getAgencyCommerciaux(dashboardFilters.agencyId)" :key="comm" :value="comm">{{ comm }}</option>
                                </select>

                                <select v-model="dashboardFilters.mois" class="bg-white border-2 border-slate-300 text-slate-700 text-xs font-bold rounded-xl px-4 py-2.5 outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-200 shadow-md hover:border-purple-400 hover:shadow-lg transition-all">
                                    <option value="">Mois</option>
                                    <option value="01">Janvier</option>
                                    <option value="02">F√©vrier</option>
                                    <option value="03">Mars</option>
                                    <option value="04">Avril</option>
                                    <option value="05">Mai</option>
                                    <option value="06">Juin</option>
                                    <option value="07">Juillet</option>
                                    <option value="08">Ao√ªt</option>
                                    <option value="09">Septembre</option>
                                    <option value="10">Octobre</option>
                                    <option value="11">Novembre</option>
                                    <option value="12">D√©cembre</option>
                                </select>

                                <select v-model="dashboardFilters.annee" class="bg-white border-2 border-slate-300 text-slate-700 text-xs font-bold rounded-xl px-4 py-2.5 outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-200 shadow-md hover:border-purple-400 hover:shadow-lg transition-all">
                                    <option value="">Ann√©e</option>
                                    <option v-for="y in dashboardYearOptions" :key="y" :value="y">{{ y }}</option>
                                </select>

                                <button @click="resetDashboardDateFilters" v-if="dashboardFilters.mois || dashboardFilters.annee" class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2.5 rounded-xl text-xs font-bold border border-slate-300 transition-all shadow-md hover:shadow-lg flex items-center gap-2" title="R√©initialiser au mois en cours">
                                    <i class="fa-solid fa-rotate-left"></i>
                                    Effacer
                                </button>

                              <button @click="dashboardFilters.onlyLive = !dashboardFilters.onlyLive" 
                                        :class="dashboardFilters.onlyLive ? 'bg-gradient-to-r from-green-500 to-green-600 text-white shadow-xl shadow-green-300 border-green-600' : (activeRdvCount > 0 ? 'bg-gradient-to-r from-green-50 to-green-100 text-green-700 border-green-300' : 'bg-white text-slate-500 border-slate-300')"
                                        class="px-5 py-2.5 rounded-xl text-xs font-bold transition-all duration-200 flex items-center gap-2 border-2 hover:scale-105 shadow-md">
                                    <span :class="activeRdvCount > 0 ? 'bg-green-500 animate-pulse shadow-lg w-3 h-3' : 'bg-slate-300 w-2.5 h-2.5'" class="rounded-full block"></span>
                                    {{ activeRdvCount }} En cours
                                </button>
                            </div>
                        </div>
                        <div class="space-y-3 relative">
                          <div v-for="rdv in sortedDaily" :key="rdv.id" @click="openRdvFiche(rdv)" 
     :class="[rdvMenuOpen === rdv.id ? 'z-[500] !transform-none !transition-none' : (isEnCours(rdv) ? 'live-animation border-green-400 shadow-green-200' : 'z-10 overflow-hidden')]" 
     class="relative flex flex-col md:flex-row md:items-center p-4 md:p-5 bg-gradient-to-br from-white via-purple-50/20 to-white rounded-xl md:rounded-2xl border-2 border-purple-200/80 hover:border-purple-400 hover:shadow-xl md:hover:shadow-2xl hover:scale-[1.01] cursor-pointer transition-all duration-200 group gap-3 md:gap-4 shadow-md md:shadow-lg backdrop-blur-sm">    
                                <div class="flex items-center w-full md:w-auto relative z-10">
                                    <div class="w-16 md:w-24 font-black text-lg md:text-xl text-white group-hover:text-purple-50 transition-all text-center bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl md:rounded-2xl py-2.5 md:py-3 mr-3 md:mr-4 shadow-lg md:shadow-xl shadow-purple-300/50 border-2 border-purple-400/80 flex-shrink-0" :class="isEnCours(rdv) ? 'from-green-500 to-green-600 border-green-400 animate-pulse' : ''">
                                        {{ rdv.heure }}
                                    </div>
                                    <div class="font-bold text-slate-800 text-lg flex items-center gap-2 md:hidden">
                                        {{ rdv.civilite }} {{ rdv.nom }} 
                                        <i v-if="isEnCours(rdv)" class="fa-solid fa-circle text-[10px] text-green-500 animate-pulse"></i>
                                        <span v-if="rdv.tag === 'OK M'" class="ml-2 bg-gradient-to-r from-purple-600 to-purple-700 text-white text-[10px] px-2 py-1 rounded-lg font-bold uppercase shadow-md shadow-purple-300">OK M</span>
                                        <span v-if="isNewRdvFromOther(rdv)" class="ml-1 bg-gradient-to-r from-purple-500 to-purple-600 text-white text-[9px] px-2 py-0.5 rounded-full font-bold animate-pulse shadow-md">
                                            <i class="fa-solid fa-user-plus text-[8px]"></i> Nouveau
                                        </span>
                                        <span v-if="isRdvApproaching(rdv)" class="ml-1 bg-gradient-to-r from-orange-500 to-orange-600 text-white text-[9px] px-2 py-0.5 rounded-full font-bold animate-pulse shadow-md">
                                            <i class="fa-solid fa-clock text-[8px]"></i> Bient√¥t
                                        </span>
                                        <span v-if="needsRappel(rdv)" class="ml-1 bg-gradient-to-r from-red-500 to-red-600 text-white text-[9px] px-2 py-0.5 rounded-full font-bold animate-pulse shadow-md">
                                            <i class="fa-solid fa-bell text-[8px]"></i> Rappel
                                        </span>
                                    </div>
                                </div>
                                <div class="flex-1 min-w-0 md:ml-4 relative z-10">
                                    <div class="font-bold text-slate-800 text-xl hidden md:flex items-center gap-2 flex-wrap">
                                        <span class="text-lg">{{ rdv.civilite }} {{ rdv.nom }}</span>
                                        <i v-if="isEnCours(rdv)" class="fa-solid fa-circle text-xs text-green-500 animate-pulse"></i>
                                        <span v-if="rdv.tag === 'OK M'" class="bg-gradient-to-r from-purple-600 to-purple-700 text-white text-xs px-3 py-1 rounded-lg font-bold uppercase shadow-lg shadow-purple-300">OK M</span>
                                        <span v-if="isNewRdvFromOther(rdv)" class="bg-gradient-to-r from-purple-500 to-purple-600 text-white text-xs px-2 py-1 rounded-full font-bold animate-pulse shadow-md" title="Nouveau RDV cr√©√© par un autre utilisateur">
                                            <i class="fa-solid fa-user-plus text-[9px]"></i> Nouveau
                                        </span>
                                        <span v-if="isRdvApproaching(rdv)" class="bg-gradient-to-r from-orange-500 to-orange-600 text-white text-xs px-2 py-1 rounded-full font-bold animate-pulse shadow-md" title="RDV dans moins de 15 minutes">
                                            <i class="fa-solid fa-clock text-[9px]"></i> Bient√¥t
                                        </span>
                                        <span v-if="needsRappel(rdv)" class="bg-gradient-to-r from-red-500 to-red-600 text-white text-xs px-2 py-1 rounded-full font-bold animate-pulse shadow-md" title="Rappel √† faire">
                                            <i class="fa-solid fa-bell text-[9px]"></i> Rappel
                                        </span>
                                        <span v-if="rdv.rappelFait" class="text-green-600" title="Rappel envoy√©">
                                            <i class="fa-solid fa-bell text-base"></i>
                                        </span>
                                        <span v-if="rdv.geste_commercial && user.role === 'admin'" class="text-red-500 text-2xl animate-bounce-slow" title="Geste Commercial appliqu√©">üéÅ</span>
                                        <span v-if="rdv.geste_commercial" class="bg-gradient-to-r from-red-100 to-red-200 text-red-700 text-xs px-3 py-1 rounded-full border-2 border-red-300 font-bold shadow-md">
                                            -{{ rdv.geste_commercial }}‚Ç¨
                                        </span>
                                    </div>
                                    <div v-if="isEnCours(rdv)" class="w-full max-w-xs h-2 bg-gradient-to-r from-slate-200 to-slate-300 rounded-full mt-3 overflow-hidden shadow-inner">
                                        <div class="h-full bg-gradient-to-r from-green-500 via-green-400 to-green-500 transition-all duration-1000 ease-linear shadow-lg shadow-green-300" :style="{width: getProgressPercent(rdv) + '%'}"></div>
                                    </div>
                                    <div class="text-sm text-slate-600 flex flex-wrap items-center gap-2 md:gap-3 mt-2 font-medium">
                                       <span class="bg-gradient-to-r from-slate-50 to-white px-3 py-1.5 rounded-xl border-2 border-slate-300 text-slate-700 shadow-sm font-bold">
                                           <i class="fa-solid fa-car text-purple-500 mr-1"></i> {{ getBaseModele(rdv.modele) || rdv.modele }}
                                       </span>
                                       <span class="flex items-center gap-2 bg-gradient-to-r from-white to-slate-50 px-3 py-1.5 rounded-xl border-2 border-slate-300 shadow-sm">
                                           <img :src="getLogo(rdv.source)" class="w-5 h-5 rounded-md">
                                           <span class="font-bold text-slate-700">{{ rdv.source }}</span>
                                       </span>
                                       <span v-if="getRelativeRdvLabel(rdv)" class="bg-gradient-to-r from-orange-500 to-orange-600 text-white px-3 py-1.5 rounded-xl text-xs font-black uppercase shadow-lg">
                                           {{ getRelativeRdvLabel(rdv) }}
                                       </span>
                                       <div class="w-full mt-2 flex flex-wrap gap-2">
                                           <span class="bg-gradient-to-r from-purple-500 to-purple-600 text-white text-xs font-bold uppercase px-3 py-1.5 rounded-xl border-2 border-purple-400 shadow-md shadow-purple-300">
                                               <i class="fa-solid fa-building mr-1"></i> {{ getAgenceName(rdv.agenceId) }}
                                           </span>
                                           <span class="bg-gradient-to-r from-slate-500 to-slate-600 text-white text-xs font-bold uppercase px-3 py-1.5 rounded-xl border-2 border-slate-400 shadow-md">
                                               <i class="fa-solid fa-user-tag mr-1"></i> {{ rdv.createdBy || 'Syst√®me' }}
                                           </span>
                                       </div>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between md:justify-end mt-2 md:mt-0 relative z-10 gap-2">
                                    <div v-if="rdv.dansAgenda" class="px-3 py-1.5 rounded-xl text-xs font-bold bg-gradient-to-r from-green-500 to-green-600 text-white border-2 border-green-400 flex items-center gap-2 shadow-lg" title="Plac√© dans l'agenda">
                                        <i class="fa-solid fa-calendar-check"></i> <span>Dans l'agenda</span>
                                    </div>
                                    <button 
                                        v-if="['confirme', 'a_confirmer'].includes(rdv.statut) && rdv.date && (() => { const today = new Date(); today.setHours(0,0,0,0); const rdvDate = new Date(rdv.date); rdvDate.setHours(0,0,0,0); return rdvDate >= today && Math.round((rdvDate - today) / 86400000) <= 5; })()"
                                        @click.stop="sendManualRappel(rdv, $event)"
                                        class="px-3 py-1.5 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-xl text-xs font-bold hover:from-red-600 hover:to-red-700 shadow-md flex items-center gap-1.5 transition transform active:scale-95"
                                        title="Envoyer un rappel"
                                    >
                                        <i class="fa-solid fa-bell text-[10px]"></i>
                                        <span class="hidden md:inline">Rappels</span>
                                    </button>
                                    <div v-if="isEnCours(rdv)" class="status-label-active mr-4 bg-gradient-to-r from-green-500 to-green-600 text-white px-4 py-2 rounded-xl font-bold shadow-lg border-2 border-green-400">
                                        <span class="live-dot"></span>En cours
                                    </div>
                                    <div v-else-if="isLateAndNoStatus(rdv)" class="mr-4 bg-gradient-to-r from-purple-500 to-purple-600 text-white px-4 py-2 rounded-xl font-bold text-xs animate-pulse border-2 border-purple-400 shadow-lg">
                                        <i class="fa-solid fa-clipboard-question mr-1"></i> STATUT ?
                                    </div>
                                    <span v-else :class="statusClass(rdv.statut)" class="badge-status shadow-lg px-4 py-2 rounded-xl font-bold border-2">{{ displayStatus(rdv) }}</span>
                                    <div class="ml-4 text-slate-400 group-hover:text-purple-600 transition-transform group-hover:translate-x-1">
                                        <i class="fa-solid fa-chevron-right text-xl"></i>
                                    </div>
                                </div>
                            </div>
                           <div v-if="filteredDaily.length > dashboardLimit" class="text-center pt-6 mt-4">
                            <button @click="dashboardLimit += 15" class="bg-gradient-to-r from-purple-500 to-purple-600 text-white px-8 py-3 rounded-xl text-sm font-bold hover:from-purple-600 hover:to-purple-700 hover:scale-105 transition-all shadow-xl shadow-purple-300 border-2 border-purple-400">
                                üëá Voir la suite ({{ filteredDaily.length - dashboardLimit }} de plus)
                            </button>
                        </div>
                        </div>
                    </div>
                </div>

               <div v-if="view==='list'" class="bg-gradient-to-br from-slate-50 via-purple-50/20 to-slate-50 rounded-[32px] shadow-xl border-2 border-purple-200/50 h-full flex flex-col overflow-hidden fade-in relative transition-all duration-500 font-sans backdrop-blur-sm">
    
    <div class="bg-gradient-to-br from-white via-purple-50/30 to-white border-b-2 border-purple-200/50 z-20 px-6 py-4 flex flex-col md:flex-row items-center justify-between gap-4 shadow-lg backdrop-blur-sm">
        
        <div class="flex-1 w-full md:w-auto flex items-center gap-4">
            <!-- BOUTON RETOUR INTELLIGENT -->
            <button v-if="currentFilter !== 'all' || listFilters.agenceId || listFilters.date || listFilters.prospecteur || fromDashboard" @click="goBackFromList" class="bg-gradient-to-br from-purple-100 to-purple-200 text-purple-700 hover:from-purple-200 hover:to-purple-300 w-10 h-10 rounded-xl flex items-center justify-center transition-all group shadow-md" title="Retour">
                <i class="fa-solid fa-arrow-left group-hover:-translate-x-1 transition"></i>
            </button>
            
            <div class="relative flex-1 max-w-md group">
                <i class="fa-solid fa-search absolute left-4 top-1/2 -translate-y-1/2 text-purple-400 text-lg group-focus-within:text-purple-600 transition"></i>
                <input 
                    v-model="search" 
                    placeholder="Rechercher client, v√©hicule, t√©l..." 
                    class="w-full pl-12 pr-10 py-3 bg-white border-2 border-purple-200 rounded-2xl font-bold text-slate-700 outline-none focus:border-purple-500 focus:bg-purple-50/50 focus:shadow-lg transition-all shadow-sm"
                >
                <button v-if="search" @click="search=''" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-300 hover:text-red-500 transition">
                    <i class="fa-solid fa-circle-xmark text-xl"></i>
                </button>
            </div>
        </div>

        <div class="flex flex-wrap items-center gap-2 w-full md:w-auto justify-center md:justify-end">
            
            <button @click="currentFilter = (currentFilter==='upcoming'?'all':'upcoming')" :class="currentFilter==='upcoming' ? 'bg-gradient-to-r from-purple-500 to-purple-600 text-white shadow-lg shadow-purple-300' : 'bg-white text-purple-600 border-2 border-purple-200 hover:bg-purple-50 hover:border-purple-400'" class="px-4 py-2 rounded-xl text-sm font-bold transition flex items-center gap-2 active:scale-95 shadow-md">
                <i class="fa-solid fa-clock"></i> √Ä venir
            </button>

            <button @click="currentFilter = (currentFilter==='live'?'all':'live')" :class="currentFilter==='live' ? 'bg-gradient-to-r from-green-500 to-green-600 text-white shadow-lg shadow-green-300' : 'bg-white text-green-600 border-2 border-green-200 hover:bg-green-50 hover:border-green-400'" class="px-4 py-2 rounded-xl text-sm font-bold transition flex items-center gap-2 active:scale-95 shadow-md group">
                <i class="fa-solid fa-clock fa-spin" style="animation-duration: 3s;"></i> 
                En cours ({{ activeRdvCount }})
            </button>

            <div class="relative">
                <select v-model="listFilters.agenceId" class="appearance-none bg-white border-2 border-purple-200 hover:border-purple-400 text-slate-700 font-bold text-sm rounded-xl pl-4 pr-8 py-2 outline-none cursor-pointer transition focus:border-purple-500 shadow-md">
                    <option value="">üè¢ Toutes agences</option>
                    <option v-for="ag in visibleAgencies" :key="ag.id" :value="ag.id">{{ ag.nom }}</option>
                </select>
                <i class="fa-solid fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-xs text-purple-400 pointer-events-none"></i>
            </div>

             <input type="date" v-model="listFilters.date" class="appearance-none bg-white border-2 border-purple-200 hover:border-purple-400 text-slate-700 font-bold text-sm rounded-xl px-4 py-2 outline-none cursor-pointer transition focus:border-purple-500 shadow-md" title="Filtrer par date">

             <button v-if="listFilters.agenceId || listFilters.date || listFilters.prospecteur || currentFilter !== 'all'" @click="resetListFilters" class="w-10 h-10 flex items-center justify-center bg-gradient-to-br from-red-100 to-red-200 text-red-600 rounded-xl hover:from-red-200 hover:to-red-300 transition shadow-md" title="Effacer tous les filtres">
                <i class="fa-solid fa-xmark"></i>
             </button>
             
             <button @click="quickRdvModal.open = true; quickRdvModal.agenceId = listFilters.agenceId || ''; quickRdvModal.date = listFilters.date || ''; quickRdvModal.source = ''; quickRdvModal.honore = false" class="px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl text-sm font-bold transition flex items-center gap-2 active:scale-95 shadow-md hover:shadow-lg">
                <i class="fa-solid fa-plus"></i>
                <span class="hidden sm:inline">Ajouter RDV rapide</span>
                <span class="sm:hidden">RDV rapide</span>
             </button>
        </div>
    </div>

    <div class="flex-1 overflow-y-auto p-6 bg-gradient-to-br from-slate-50 via-purple-50/10 to-slate-50 relative">
        
        <div v-if="filteredList.length === 0" class="flex flex-col items-center justify-center h-full fade-in pb-20">
            <div v-if="!search && currentFilter === 'all' && !listFilters.agenceId && !listFilters.date" class="text-center max-w-md">
                <div class="mb-6 p-8 bg-white rounded-[3rem] shadow-xl shadow-blue-50 inline-block animate-bounce-slow relative">
                    <div class="absolute inset-0 bg-blue-500 opacity-10  rounded-full"></div>
                    <i class="fa-solid fa-magnifying-glass-location text-6xl text-blue-500 relative z-10"></i>
                </div>
                <h2 class="text-3xl font-black text-slate-800 mb-3">Explorez vos RDV</h2>
                <p class="text-slate-500 font-medium text-lg leading-relaxed mb-8">Utilisez la recherche ou les filtres rapides ci-dessus.</p>
                <button @click="showUpcoming" class="bg-blue-600 text-white px-8 py-4 rounded-2xl font-bold shadow-lg shadow-blue-200 hover:bg-blue-700 hover:scale-105 transition-all transform flex items-center gap-3 mx-auto">
                    <i class="fa-regular fa-calendar-check text-xl"></i>
                    Voir les prochains RDV
                </button>
            </div>
            <div v-else class="text-center text-slate-400 opacity-70">
                 <i class="fa-regular fa-face-frown-open text-6xl mb-4"></i>
                 <p class="font-bold text-xl">Aucun rendez-vous trouv√©.</p>
            </div>
        </div>

        <div v-else>
            <div class="flex justify-between items-center mb-4 px-2">
                 <h3 class="font-bold text-slate-700 text-lg">R√©sultats</h3>
                 <span class="text-xs font-black text-slate-400 uppercase tracking-widest bg-white px-3 py-1 rounded-full shadow-sm border border-slate-100">{{ filteredList.length }} RDV trouv√©(s)</span>
            </div>

            <!-- MODIFICATION DESIGN : AFFICHAGE EN LIGNE COMME LE DASHBOARD -->
            <div class="space-y-4 pb-24 md:pb-0">
                <div v-for="rdv in displayedList" :key="rdv.id" @click="openRdvFiche(rdv)" :class="isEnCours(rdv) ? 'live-animation' : ''" class="relative z-10 flex flex-col md:flex-row md:items-center p-4 md:p-5 bg-gradient-to-br from-white via-purple-50/20 to-white rounded-xl md:rounded-2xl border-2 border-purple-200/80 hover:border-purple-400 hover:shadow-xl cursor-pointer transition-all duration-200 group gap-2 md:gap-0 overflow-hidden backdrop-blur-sm shadow-md">
                    
                    <!-- Selection Checkbox -->
                    <div v-if="user.role==='admin'" class="absolute top-2 right-2 md:top-auto md:bottom-auto md:left-2 md:right-auto md:relative md:mr-4 z-50" @click.stop>
                         <input type="checkbox" class="custom-checkbox w-5 h-5 shadow-sm border-2 border-slate-300 rounded" :checked="selectedIds.includes(rdv.id)" @change="toggleSelection(rdv.id)">
                    </div>

                    <div class="flex items-center w-full md:w-auto relative z-10">
                        <!-- Affichage Date & Heure Group√© -->
                        <div class="flex flex-col items-center bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl py-2.5 px-3 mr-4 shadow-lg border-2 border-purple-400/50 flex-shrink-0 min-w-[80px]">
                            <span class="text-[10px] font-bold text-white/80 uppercase">{{ formatDateShort(rdv.date) }}</span>
                            <span class="font-black text-lg text-white group-hover:text-purple-50 transition">{{ rdv.heure }}</span>
                        </div>
                        
                        <div class="font-bold text-slate-800 text-lg flex items-center gap-2 md:hidden">{{ rdv.civilite }} {{ rdv.nom }} <i v-if="isEnCours(rdv)" class="fa-solid fa-circle text-[10px] text-green-500 animate-pulse"></i><span v-if="rdv.tag === 'OK M'" class="ml-2 bg-blue-600 text-white text-[10px] px-2 py-0.5 rounded font-bold uppercase shadow-sm">OK M</span><span v-if="isNewRdvFromOther(rdv)" class="ml-1 bg-purple-500 text-white text-[8px] px-1.5 py-0.5 rounded-full font-bold animate-pulse">Nouveau</span><span v-if="isRdvApproaching(rdv)" class="ml-1 bg-orange-500 text-white text-[8px] px-1.5 py-0.5 rounded-full font-bold animate-pulse">Bient√¥t</span><span v-if="needsRappel(rdv)" class="ml-1 bg-red-500 text-white text-[8px] px-1.5 py-0.5 rounded-full font-bold animate-pulse">Rappel</span></div>
                    </div>

                    <div class="flex-1 min-w-0 md:ml-4 relative z-10">
                        <div class="font-bold text-slate-800 text-lg hidden md:flex items-center gap-2">
                            {{ rdv.civilite }} {{ rdv.nom }} 
                            <i v-if="isEnCours(rdv)" class="fa-solid fa-circle text-[10px] text-green-500 animate-pulse"></i>
                                        <span v-if="rdv.tag === 'OK M'" class="ml-2 bg-gradient-to-r from-purple-600 to-purple-700 text-white text-[10px] px-2 py-1 rounded-lg font-bold uppercase shadow-md">OK M</span>
                            <span v-if="isNewRdvFromOther(rdv)" class="ml-2 bg-purple-500 text-white text-[10px] px-2 py-0.5 rounded-full font-bold animate-pulse" title="Nouveau RDV cr√©√© par un autre utilisateur">
                                <i class="fa-solid fa-user-plus text-[8px]"></i> Nouveau
                            </span>
                            <span v-if="isRdvApproaching(rdv)" class="ml-2 bg-orange-500 text-white text-[10px] px-2 py-0.5 rounded-full font-bold animate-pulse" title="RDV dans moins de 15 minutes">
                                <i class="fa-solid fa-clock text-[8px]"></i> Bient√¥t
                            </span>
                            <span v-if="needsRappel(rdv)" class="ml-2 bg-red-500 text-white text-[10px] px-2 py-0.5 rounded-full font-bold animate-pulse" title="Rappel √† faire">
                                <i class="fa-solid fa-bell text-[8px]"></i> Rappel
                            </span>
                            <span v-if="rdv.rappelFait" class="ml-2 text-green-600" title="Rappel envoy√©">
                                <i class="fa-solid fa-bell text-sm"></i>
                            </span>
                            <span v-if="rdv.geste_commercial && user.role === 'admin'" class="ml-2 text-red-500 text-xl animate-bounce-slow" title="Geste Commercial appliqu√©">üéÅ</span>
                            <span v-if="rdv.geste_commercial" class="ml-2 bg-red-100 text-red-600 text-xs px-2 py-0.5 rounded-full border border-red-200 font-bold animate-fadeIn">
                                -{{ rdv.geste_commercial }}‚Ç¨
                            </span>
                        </div>
                        
                        <div v-if="isEnCours(rdv)" class="w-full max-w-xs h-1.5 bg-gray-200 rounded-full mt-2 overflow-hidden shadow-inner">
                            <div class="h-full bg-green-500 transition-all duration-1000 ease-linear shadow-[0_0_10px_rgba(34,197,94,0.6)]" :style="{width: getProgressPercent(rdv) + '%'}"></div>
                        </div>

                        <div class="text-sm text-slate-600 flex flex-wrap items-center gap-2 md:gap-3 mt-2 font-medium">
                           <span class="bg-gradient-to-r from-slate-50 to-white px-3 py-1.5 rounded-xl border-2 border-purple-200 text-slate-700 shadow-sm font-bold">
                                <i class="fa-solid fa-car text-purple-500 mr-1"></i> {{ getBaseModele(rdv.modele) || rdv.modele }}
                            </span>
                            <span class="flex items-center gap-1.5 bg-white px-3 py-1.5 rounded-xl border-2 border-purple-200 text-xs font-bold text-slate-700 shadow-sm">
                                <i class="fa-solid fa-phone text-purple-500"></i> {{ rdv.telephone }}
                            </span>
                            <span class="flex items-center gap-2 bg-white px-3 py-1.5 rounded-xl border-2 border-purple-200 text-xs font-bold text-slate-700 shadow-sm">
                                <img :src="getLogo(rdv.source)" class="w-5 h-5 rounded-md"> {{ rdv.source }}
                            </span>
                            <span v-if="getRelativeRdvLabel(rdv)" class="bg-gradient-to-r from-orange-500 to-orange-600 text-white px-3 py-1.5 rounded-xl text-xs font-black uppercase shadow-lg">
                                {{ getRelativeRdvLabel(rdv) }}
                            </span>
                            
                            <div class="w-full mt-2 flex flex-wrap gap-2">
                                <span class="bg-gradient-to-r from-purple-500 to-purple-600 text-white text-xs font-bold uppercase px-3 py-1.5 rounded-xl border-2 border-purple-400 shadow-md shadow-purple-300">
                                    <i class="fa-solid fa-building mr-1"></i> {{ getAgenceName(rdv.agenceId) }}
                                </span>
                                <span class="bg-gradient-to-r from-slate-500 to-slate-600 text-white text-xs font-bold uppercase px-3 py-1.5 rounded-xl border-2 border-slate-400 shadow-md">
                                    <i class="fa-solid fa-user-tag mr-1"></i> {{ rdv.createdBy || 'Syst√®me' }}
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center justify-between md:justify-end mt-2 md:mt-0 relative z-10 gap-2">
                        <div v-if="rdv.dansAgenda" class="px-2 py-1 rounded-lg text-[10px] font-bold bg-green-100 text-green-700 border border-green-300 flex items-center gap-1" title="Plac√© dans l'agenda">
                            <i class="fa-solid fa-calendar-check text-[10px]"></i> <span>Dans l'agenda</span>
                        </div>
                        <button 
                            v-if="['confirme', 'a_confirmer'].includes(rdv.statut) && rdv.date && (() => { const today = new Date(); today.setHours(0,0,0,0); const rdvDate = new Date(rdv.date); rdvDate.setHours(0,0,0,0); return rdvDate >= today && Math.round((rdvDate - today) / 86400000) <= 5; })()"
                            @click.stop="sendManualRappel(rdv, $event)"
                            class="px-3 py-1.5 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-xl text-xs font-bold hover:from-red-600 hover:to-red-700 shadow-md flex items-center gap-1.5 transition transform active:scale-95"
                            title="Envoyer un rappel"
                        >
                            <i class="fa-solid fa-bell text-[10px]"></i>
                            <span class="hidden md:inline">Rappels</span>
                        </button>
                        <div v-if="isEnCours(rdv)" class="status-label-active mr-4"><span class="live-dot"></span>Rendez-vous en cours</div>
                        <div v-else-if="isLateAndNoStatus(rdv)" class="mr-4 bg-purple-100 text-purple-600 px-3 py-1 rounded-full font-bold text-xs animate-pulse border border-purple-200 shadow-sm"><i class="fa-solid fa-clipboard-question"></i> STATUT ?</div>
                        <span v-else :class="statusClass(rdv.statut)" class="badge-status shadow-sm">{{ displayStatus(rdv) }}</span>
                        <div class="ml-4 text-slate-300 group-hover:text-blue-500 transition"><i class="fa-solid fa-chevron-right"></i></div>
                    </div>
                </div>
            </div>

            <div v-if="displayedList.length < filteredList.length" class="p-8 text-center">
                 <button @click="displayLimit += 20" class="bg-white border-2 border-slate-200 text-slate-500 px-8 py-3 rounded-full font-bold hover:bg-slate-50 hover:border-blue-300 hover:text-blue-600 transition shadow-sm active:scale-95">üëá Charger les suivants</button>
            </div>
        </div>
    </div>

    <div v-if="selectedIds.length > 0" class="absolute bottom-6 left-4 right-4 md:left-auto md:right-6 md:w-auto bg-slate-900 text-white p-4 rounded-full shadow-2xl flex items-center justify-between gap-6 slide-up z-[60] border border-slate-800">
        <div class="font-bold pl-2 flex items-center gap-2"><span class="bg-blue-500 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs">{{ selectedIds.length }}</span> <span class="hidden md:inline">s√©lectionn√©s</span></div>
        <div class="flex gap-2">
            <button @click="openBulkConfirm('soft_delete', 'Mettre √† la corbeille ?')" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-full font-bold text-sm transition flex items-center gap-2 shadow-lg shadow-red-500/30 active:scale-95">
                <i class="fa-solid fa-trash-can"></i> <span class="hidden md:inline">Corbeille</span>
            </button>
            <button @click="selectedIds=[]" class="text-slate-400 hover:text-white w-10 h-10 flex items-center justify-center rounded-full hover:bg-slate-800 transition" title="Annuler la s√©lection">‚úï</button>
        </div>
    </div>
</div>

    <!-- üîª le reste de la liste (table + mobile) NE BOUGE PAS -->


 <div v-if="view==='trash'" class="bg-white rounded-3xl shadow-sm border border-slate-100 h-full flex flex-col overflow-hidden fade-in relative">
                    
                    <div class="p-6 border-b bg-slate-50 flex justify-between items-center">
                        <h2 class="text-xl md:text-2xl font-bold text-gray-700"><i class="fa-solid fa-trash-can"></i> Corbeille</h2>
                        <div class="flex items-center gap-3">
                            <span class="text-sm text-gray-500">{{ trashList.length }} √©l√©ments</span>
                            <button v-if="trashList.length > 0 && user.role==='admin'" @click="openBulkConfirm('empty_trash', 'Vider TOUTE la corbeille ?')" class="bg-red-100 text-red-600 px-4 py-2 rounded-xl text-xs font-bold hover:bg-red-200 transition">Tout Vider</button>
                        </div>
                    </div>

                    <div class="overflow-auto flex-1 p-0 pb-20 hidden md:block">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-gradient-to-r from-slate-100 to-slate-50 text-slate-600 text-xs uppercase sticky top-0 z-10 shadow-md font-bold border-b-2 border-slate-200">
                                <tr>
                                    <th class="p-4 w-10"><input type="checkbox" class="custom-checkbox" @change="selectAll($event)" :checked="isAllSelected && trashList.length > 0"></th>
                                    <th class="p-4">Date</th>
                                    <th class="p-4">Client</th>
                                    <th class="p-4 hidden md:table-cell">Supprim√© par</th>
                                    <th class="p-4 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="text-sm bg-white">
                                <tr v-for="rdv in trashList" :key="rdv.id" class="border-b border-slate-100 hover:bg-gradient-to-r hover:from-red-50/50 hover:to-transparent transition-all duration-200" :class="{'bg-red-50/30': selectedIds.includes(rdv.id)}">
                                    <td class="p-4 text-center"><input type="checkbox" class="custom-checkbox" :checked="selectedIds.includes(rdv.id)" @change="toggleSelection(rdv.id)"></td>
                                    <td class="p-4 text-gray-500"><div class="font-bold line-through">{{ formatDateShort(rdv.date) }}</div></td>
                                    <td class="p-4 opacity-60"><div class="font-bold text-slate-700">{{ rdv.nom }}</div><div class="text-slate-500 text-xs">{{ getBaseModele(rdv.modele) || rdv.modele }}</div></td>
                                    <td class="p-4 text-xs font-bold text-gray-400 uppercase hidden md:table-cell">Utilisateur</td>
                                    <td class="p-4 text-right flex justify-end gap-2">
                                        <button @click="restoreRdv(rdv)" class="bg-gradient-to-r from-green-500 to-green-600 text-white px-3 py-1.5 rounded-lg font-bold text-xs hover:from-green-600 hover:to-green-700 transition shadow-md shadow-green-200" title="Restaurer"><i class="fa-solid fa-rotate-left"></i></button>
                                        <button v-if="user.role==='admin'" @click="hardDeleteRdv(rdv)" class="bg-gradient-to-r from-red-500 to-red-600 text-white px-3 py-1.5 rounded-lg font-bold text-xs hover:from-red-600 hover:to-red-700 transition shadow-md shadow-red-200" title="Supprimer d√©finitivement"><i class="fa-solid fa-ban"></i></button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="md:hidden flex-1 overflow-y-auto p-4 space-y-3 pb-24 bg-slate-100">
                        <div v-for="rdv in trashList" :key="rdv.id" 
                             class="p-4 rounded-2xl shadow-sm border relative transition-all duration-200"
                             :class="selectedIds.includes(rdv.id) ? 'bg-red-50 border-red-300 ring-1 ring-red-200' : 'bg-white border-red-100'">
                            
                            <div class="absolute top-4 right-4 z-10">
                                <input type="checkbox" class="custom-checkbox w-6 h-6" :checked="selectedIds.includes(rdv.id)" @change="toggleSelection(rdv.id)">
                            </div>

                            <div class="flex justify-between items-start mb-2 pr-8 opacity-60">
                                <div>
                                    <div class="text-xs font-bold text-slate-400 uppercase flex items-center gap-1 line-through"><i class="fa-regular fa-calendar"></i> {{ formatDateShort(rdv.date) }}</div>
                                    <div class="text-lg font-bold text-slate-800">{{ rdv.nom }}</div>
                                </div>
                            </div>
                            <div class="flex items-center gap-2 mb-3 text-sm text-slate-600 font-medium opacity-60"><i class="fa-solid fa-car"></i> {{ getBaseModele(rdv.modele) || rdv.modele }}</div>
                            
                            <div class="flex gap-2 justify-end mt-2 pt-2 border-t border-slate-100">
                                <button @click="restoreRdv(rdv)" class="bg-green-100 text-green-700 px-3 py-1.5 rounded-lg font-bold text-xs hover:bg-green-200 transition">Restaurer</button>
                                <button v-if="user.role==='admin'" @click="hardDeleteRdv(rdv)" class="bg-red-100 text-red-700 px-3 py-1.5 rounded-lg font-bold text-xs hover:bg-red-200 transition">Supprimer</button>
                            </div>
                        </div>
                        
                        <div v-if="trashList.length === 0" class="text-center text-gray-400 py-10 italic">La corbeille est vide.</div>
                    </div>

                    <div v-if="selectedIds.length > 0" class="absolute bottom-6 left-4 right-4 md:left-6 md:right-6 bg-slate-900 text-white p-4 rounded-2xl shadow-2xl flex flex-col md:flex-row items-center justify-between slide-up z-50 gap-3">
                        <div class="font-bold pl-2"><span class="text-blue-400 text-xl">{{ selectedIds.length }}</span> s√©lectionn√©s</div>
                        <div class="flex gap-2 w-full md:w-auto justify-end">
                            <button @click="openBulkConfirm('restore_trash', 'Restaurer la s√©lection ?')" class="bg-green-600 hover:bg-green-500 px-3 md:px-4 py-2 rounded-lg font-bold text-xs md:text-sm transition flex-1 md:flex-none">Restaurer</button>
                            <button v-if="user.role==='admin'" @click="openBulkConfirm('delete_trash', 'Supprimer D√âFINITIVEMENT ?')" class="bg-red-600 hover:bg-red-500 px-3 md:px-4 py-2 rounded-lg font-bold text-xs md:text-sm transition flex-1 md:flex-none">Supprimer</button>
                            <button @click="selectedIds=[]" class="ml-2 text-gray-400 hover:text-white px-2">‚úï</button>
                        </div>
                    </div>
                </div>
                
                <div v-if="view==='pending_status'" class="max-w-3xl mx-auto space-y-4 fade-in"><h2 class="text-xl md:text-2xl font-bold mb-6 text-purple-700"><i class="fa-solid fa-clipboard-question"></i> Statuts √† d√©finir</h2><div v-if="pendingStatusList.length===0" class="bg-white p-10 rounded-2xl text-center text-gray-400 border border-slate-100 shadow-sm"><i class="fa-solid fa-check-circle text-4xl mb-2 text-green-500"></i><br>Tous les statuts sont √† jour !</div><div v-for="r in pendingStatusList" :key="r.id" class="bg-white p-4 md:p-6 rounded-2xl shadow-sm border-l-4 border-purple-500 flex flex-col md:flex-row justify-between items-start md:items-center hover:shadow-md transition group" @click="openRdvFiche(r)"><div class="cursor-pointer flex-1"><div class="font-bold text-lg flex items-center gap-2">{{ r.civilite }} {{ r.nom }} <span class="text-xs bg-gray-100 text-gray-500 px-2 rounded">Termin√©</span></div><div class="text-slate-500">{{ formatDateFr(r.date) }} √† {{ r.heure }} ‚Ä¢ {{ r.modele }}</div><div class="text-sm font-bold text-blue-600 mt-1">{{ getAgenceName(r.agenceId) }}</div></div><div class="flex gap-2 w-full md:w-auto"><button @click.stop="updateStatus(r, 'honor_fact')" class="flex-1 md:flex-none bg-green-100 text-green-700 px-4 py-2 rounded-xl font-bold hover:bg-green-200 border border-green-200 text-sm"><i class="fa-solid fa-check"></i> Honor√©</button><button @click.stop="updateStatus(r, 'noshow')" class="flex-1 md:flex-none bg-red-100 text-red-700 px-4 py-2 rounded-xl font-bold hover:bg-red-200 border border-red-200 text-sm"><i class="fa-solid fa-user-xmark"></i> Lapin</button></div></div></div>
                <div v-if="view==='portefeuille'" class="max-w-7xl mx-auto space-y-6 fade-in">
                    <!-- VUE ADMIN -->
                    <div v-if="user.role==='admin'" class="space-y-6">
                        <!-- STATS ADMIN ULTRA MODERNES -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <!-- Solde du Jour -->
                            <div class="group relative transform transition-all duration-300 hover:scale-105">
                                <div class="absolute -inset-1 bg-gradient-to-r from-blue-400 via-cyan-400 to-blue-500 rounded-3xl opacity-60 group-hover:opacity-100 transition duration-300"></div>
                                <div class="relative bg-white rounded-3xl shadow-2xl p-8 overflow-hidden border border-blue-200">
                                    <!-- Grille de fond anim√©e -->
                                    <div class="absolute inset-0 opacity-5">
                                        <div class="absolute inset-0" style="background-image: linear-gradient(rgba(102,126,234,0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(102,126,234,0.1) 1px, transparent 1px); background-size: 20px 20px;"></div>
                                    </div>
                                    <!-- Particules flottantes -->
                                    <div class="absolute top-4 right-4 w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>
                                    <div class="absolute bottom-8 left-8 w-1 h-1 bg-cyan-500 rounded-full animate-pulse" style="animation-delay: 0.5s;"></div>
                                <div class="relative z-10">
                                        <div class="flex items-center justify-between mb-6">
                                            <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-2xl flex items-center justify-center shadow-lg shadow-blue-500/50">
                                                <i class="fa-solid fa-calendar-day text-3xl text-white"></i>
                                </div>
                                            <div class="px-3 py-1 bg-blue-100 rounded-full border border-blue-300">
                                                <span class="text-blue-700 text-xs font-bold uppercase tracking-wider">Aujourd'hui</span>
                            </div>
                                        </div>
                                        <p class="text-blue-600 text-xs font-bold uppercase mb-3 tracking-widest">Solde du Jour</p>
                                        <p class="text-5xl font-black mb-2 text-blue-600">{{ formatPrice(adminStats.caDaily) }}</p>
                                        <div class="flex items-center gap-2 mt-4">
                                            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                            <p class="text-slate-600 text-sm font-medium">CA brut en temps r√©el</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Solde du Mois Brut -->
                            <div class="group relative transform transition-all duration-300 hover:scale-105">
                                <div class="absolute -inset-1 bg-gradient-to-r from-emerald-400 via-green-400 to-emerald-500 rounded-3xl opacity-60 group-hover:opacity-100 transition duration-300"></div>
                                <div class="relative bg-white rounded-3xl shadow-2xl p-8 overflow-hidden border border-emerald-200">
                                    <!-- Grille de fond anim√©e -->
                                    <div class="absolute inset-0 opacity-5">
                                        <div class="absolute inset-0" style="background-image: linear-gradient(rgba(16,185,129,0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(16,185,129,0.1) 1px, transparent 1px); background-size: 20px 20px;"></div>
                                    </div>
                                    <!-- Particules flottantes -->
                                    <div class="absolute top-4 right-4 w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div>
                                    <div class="absolute bottom-8 left-8 w-1 h-1 bg-green-500 rounded-full animate-pulse" style="animation-delay: 0.5s;"></div>
                                <div class="relative z-10">
                                        <div class="flex items-center justify-between mb-6">
                                            <div class="w-16 h-16 bg-gradient-to-br from-emerald-500 to-green-500 rounded-2xl flex items-center justify-center shadow-lg shadow-emerald-500/50">
                                                <i class="fa-solid fa-chart-line text-3xl text-white"></i>
                                </div>
                                            <div class="px-3 py-1 bg-emerald-100 rounded-full border border-emerald-300">
                                                <span class="text-emerald-700 text-xs font-bold uppercase tracking-wider">Ce mois</span>
                            </div>
                                        </div>
                                        <p class="text-emerald-600 text-xs font-bold uppercase mb-3 tracking-widest">Solde Brut</p>
                                        <p class="text-5xl font-black mb-2 text-emerald-600">{{ formatPrice(adminStats.caMonthly) }}</p>
                                        <div class="flex items-center gap-2 mt-4">
                                            <div class="w-2 h-2 bg-yellow-500 rounded-full animate-pulse"></div>
                                            <p class="text-slate-600 text-sm font-medium">Avant commissions</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Solde du Mois Net -->
                            <div class="group relative transform transition-all duration-300 hover:scale-105">
                                <div class="absolute -inset-1 bg-gradient-to-r from-purple-400 via-pink-400 to-purple-500 rounded-3xl opacity-60 group-hover:opacity-100 transition duration-300"></div>
                                <div class="relative bg-white rounded-3xl shadow-2xl p-8 overflow-hidden border border-purple-200">
                                    <!-- Grille de fond anim√©e -->
                                    <div class="absolute inset-0 opacity-5">
                                        <div class="absolute inset-0" style="background-image: linear-gradient(rgba(168,85,247,0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(168,85,247,0.1) 1px, transparent 1px); background-size: 20px 20px;"></div>
                                    </div>
                                    <!-- Particules flottantes -->
                                    <div class="absolute top-4 right-4 w-2 h-2 bg-purple-500 rounded-full animate-pulse"></div>
                                    <div class="absolute bottom-8 left-8 w-1 h-1 bg-pink-500 rounded-full animate-pulse" style="animation-delay: 0.5s;"></div>
                                <div class="relative z-10">
                                        <div class="flex items-center justify-between mb-6">
                                            <div class="w-16 h-16 bg-gradient-to-br from-purple-500 to-pink-500 rounded-2xl flex items-center justify-center shadow-lg shadow-purple-500/50">
                                                <i class="fa-solid fa-wallet text-3xl text-white"></i>
                                            </div>
                                            <div class="px-3 py-1 bg-purple-100 rounded-full border border-purple-300">
                                                <span class="text-purple-700 text-xs font-bold uppercase tracking-wider">Net</span>
                                            </div>
                                        </div>
                                        <p class="text-purple-600 text-xs font-bold uppercase mb-3 tracking-widest">Solde Net</p>
                                        <p class="text-5xl font-black mb-2 text-purple-600">{{ formatPrice(adminStats.netMonthly) }}</p>
                                        <div class="flex items-center gap-2 mt-4">
                                            <div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>
                                            <p class="text-slate-600 text-sm font-medium">Apr√®s commissions</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- BARRE DE RECHERCHE -->
                        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-4">
                            <div class="relative">
                                <i class="fa-solid fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                <input 
                                    v-model="portefeuilleSearch" 
                                    @input="filterProspectors"
                                    type="text" 
                                    placeholder="Rechercher un prospecteur..." 
                                    class="w-full pl-12 pr-4 py-3 border-2 border-slate-200 rounded-xl font-medium text-slate-800 outline-none focus:border-blue-500 transition"
                                />
                            </div>
                        </div>

                        <!-- LISTE DES PROSPECTEURS EN CARTES -->
                        <div v-if="!selectedProspecteur">
                            <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                                <i class="fa-solid fa-users text-blue-500"></i>
                                Tous les prospecteurs ({{ onlyProspectors.length }})
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div 
                                    v-for="prosp in displayedProspectors" 
                                    :key="prosp.name"
                                    @click="selectProspecteur(prosp.name)"
                                    class="bg-white rounded-2xl shadow-sm border border-slate-200 hover:border-blue-400 hover:shadow-lg p-6 cursor-pointer transition-all group"
                                >
                                    <div class="flex items-start justify-between mb-4">
                                        <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center text-white text-xl font-black group-hover:scale-110 transition-transform">
                                            {{ prosp.name.charAt(0).toUpperCase() }}
                                        </div>
                                        <i class="fa-solid fa-chevron-right text-slate-300 group-hover:text-blue-500 transition"></i>
                                    </div>
                                    <h4 class="font-bold text-lg text-slate-800 mb-2">{{ prosp.name }}</h4>
                                    <div class="space-y-2">
                                        <div class="flex justify-between items-center">
                                            <span class="text-xs text-slate-500">CA ce mois</span>
                                            <span class="text-sm font-bold text-green-600">{{ formatPrice(prosp.ca) }}</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-xs text-slate-500">RDV Honor√©s</span>
                                            <span class="text-sm font-bold text-blue-600">{{ prosp.honoredCount }}</span>
                                        </div>
                                        <div class="pt-2 border-t border-slate-100">
                                            <div class="flex justify-between items-center">
                                                <span class="text-xs text-slate-500">Reste net</span>
                                                <span class="text-sm font-black" :class="prosp.net >= 0 ? 'text-green-600' : 'text-red-600'">
                                                    {{ formatPrice(prosp.net) }}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div v-if="displayedProspectors.length === 0" class="text-center py-12 bg-white rounded-2xl border border-slate-100">
                                <i class="fa-solid fa-search text-4xl text-slate-300 mb-3"></i>
                                <p class="text-slate-400 font-medium">Aucun prospecteur trouv√©</p>
                            </div>
                        </div>

                        <!-- Vue Transactions du prospecteur s√©lectionn√© -->
                        <div v-if="selectedProspecteur" class="space-y-6">
                            <!-- En-t√™te avec bouton retour -->
                            <div class="flex items-center justify-between mb-4">
                                <button @click="selectedProspecteur = null; portefeuilleSearch = ''" class="flex items-center gap-2 text-slate-600 hover:text-blue-600 font-medium transition">
                                    <i class="fa-solid fa-arrow-left"></i>
                                    <span>Retour √† la liste</span>
                                </button>
                            </div>
                            
                            <!-- Carte d'identit√© du prospecteur -->
                            <div class="bg-white rounded-3xl shadow-2xl p-6 border border-blue-200 relative overflow-hidden">
                                <div class="absolute top-0 right-0 w-64 h-64 bg-blue-100/30 rounded-full -mr-32 -mt-32"></div>
                                <div class="absolute bottom-0 left-0 w-48 h-48 bg-blue-100/30 rounded-full -ml-24 -mb-24"></div>
                                <div class="relative z-10 flex items-center justify-between">
                                    <div>
                                        <p class="text-blue-600 text-sm font-bold uppercase mb-1">Prospecteur</p>
                                        <h2 class="text-3xl font-black text-slate-800">{{ selectedProspecteur ? selectedProspecteur.split(' ')[0] : '' }}</h2>
                                    </div>
                                    <button @click="selectedProspecteur = null; portefeuilleSearch = ''" class="bg-blue-100 hover:bg-blue-200 text-blue-700 p-3 rounded-xl transition">
                                        <i class="fa-solid fa-arrow-left"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Transactions en premier -->
                            <div class="bg-white rounded-2xl shadow-lg border border-slate-200 p-6">
                                <div class="flex items-center justify-between mb-6">
                                    <h3 class="text-xl font-bold text-slate-800 flex items-center gap-3">
                                        <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center">
                                            <i class="fa-solid fa-list text-white"></i>
                                        </div>
                                        Transactions
                                    </h3>
                                    <span class="text-sm text-slate-500 font-medium bg-slate-100 px-3 py-1 rounded-full">{{ allTransactions.length }} transaction(s)</span>
                                </div>
                                <div class="space-y-3 max-h-[600px] overflow-y-auto pr-2">
                                    <div 
                                        v-for="trans in allTransactions" 
                                        :key="trans.id"
                                        @click="trans.rdvId && openRdvFiche(getRdvFromTransaction(trans))"
                                        class="p-5 bg-gradient-to-br from-white to-slate-50 hover:from-blue-50 hover:to-blue-100 rounded-2xl border-2 border-slate-200 hover:border-blue-400 hover:shadow-lg transition-all group cursor-pointer"
                                        :class="trans.hidden ? 'opacity-50' : ''"
                                    >
                                        <div class="flex items-start gap-4">
                                            <div class="w-14 h-14 rounded-2xl flex items-center justify-center flex-shrink-0 shadow-md" 
                                                 :class="trans.type === 'bonus' ? 'bg-gradient-to-br from-yellow-400 to-orange-500' : (trans.amount >= 0 ? 'bg-gradient-to-br from-green-400 to-emerald-500' : 'bg-gradient-to-br from-red-400 to-rose-500')">
                                                <i :class="getTransactionIcon(trans.type)" class="text-white text-xl"></i>
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <div class="flex items-center gap-2 mb-2">
                                                    <span class="font-bold text-lg text-slate-800">{{ trans.label }}</span>
                                                    <span v-if="trans.hidden" class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded-full font-bold">Masqu√©e</span>
                                                    <span v-if="trans.type === 'bonus'" class="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full font-bold animate-pulse">
                                                        <i class="fa-solid fa-star mr-1"></i>Bonus
                                                    </span>
                                                </div>
                                                <div class="text-sm text-slate-500 mb-3 font-medium">
                                                    <i class="fa-solid fa-clock mr-1"></i>{{ formatDateFr(trans.date) }}
                                                </div>
                                                <!-- D√©tails du RDV si disponible -->
                                                <div v-if="getRdvFromTransaction(trans)" class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3 p-3 bg-white/60 rounded-xl border border-slate-200">
                                                    <div v-if="getRdvFromTransaction(trans).agenceId" class="flex items-center gap-2 text-blue-700 font-medium">
                                                        <i class="fa-solid fa-building text-blue-500"></i>
                                                        <span>{{ getAgenceName(getRdvFromTransaction(trans).agenceId) }}</span>
                                                    </div>
                                                    <div v-if="getRdvFromTransaction(trans).civilite && getRdvFromTransaction(trans).nom" class="flex items-center gap-2 text-slate-700 font-medium">
                                                        <i class="fa-solid fa-user text-slate-500"></i>
                                                        <span>{{ getRdvFromTransaction(trans).civilite }} {{ getRdvFromTransaction(trans).nom }}</span>
                                                    </div>
                                                    <div v-if="getRdvFromTransaction(trans).date && getRdvFromTransaction(trans).heure" class="flex items-center gap-2 text-slate-600">
                                                        <i class="fa-solid fa-calendar text-slate-400"></i>
                                                        <span>{{ formatDateShort(getRdvFromTransaction(trans).date) }} √† {{ getRdvFromTransaction(trans).heure }}</span>
                                                    </div>
                                                    <div v-if="getRdvFromTransaction(trans).modele" class="flex items-center gap-2 text-slate-600">
                                                        <i class="fa-solid fa-car text-slate-400"></i>
                                                        <span>{{ getRdvFromTransaction(trans).modele }}</span>
                                                    </div>
                                                    <div v-if="getRdvFromTransaction(trans).telephone" class="flex items-center gap-2 text-slate-600">
                                                        <i class="fa-solid fa-phone text-slate-400"></i>
                                                        <span>{{ getRdvFromTransaction(trans).telephone }}</span>
                                                    </div>
                                                    <div v-if="trans.rdvId" class="flex items-center gap-2 text-blue-600 font-medium">
                                                        <i class="fa-solid fa-eye text-blue-500"></i>
                                                        <span>Cliquer pour voir le r√©capitulatif</span>
                                                    </div>
                                                </div>
                                                <!-- D√©tails bonus si c'est un bonus -->
                                                <div v-if="trans.type === 'bonus' && trans.bonusCount" class="mt-3 p-3 bg-yellow-50 rounded-xl border border-yellow-200">
                                                    <div class="text-sm text-yellow-800 font-medium">
                                                        <i class="fa-solid fa-trophy mr-2"></i>
                                                        Palier atteint : {{ trans.bonusCount }} RDV honor√©s
                                                    </div>
                                                </div>
                                                <!-- Note si disponible -->
                                                <div v-if="trans.note" class="mt-3 text-sm text-slate-600 italic bg-slate-100 p-3 rounded-xl border border-slate-200">
                                                    <i class="fa-solid fa-sticky-note mr-2 text-slate-400"></i>{{ trans.note }}
                                                </div>
                                            </div>
                                            <div class="flex flex-col items-end gap-2 flex-shrink-0">
                                                <span class="text-2xl font-black whitespace-nowrap" :class="trans.amount >= 0 ? 'text-green-600' : 'text-red-600'">
                                                    {{ trans.amount >= 0 ? '+' : '' }}{{ formatPrice(trans.amount) }}
                                                </span>
                                                <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition">
                                                    <button 
                                                        v-if="!trans.hidden"
                                                        @click.stop="hideTransaction(trans.id)" 
                                                        class="bg-red-100 text-red-600 p-2 rounded-lg hover:bg-red-200 transition shadow-sm"
                                                        title="Masquer cette transaction"
                                                    >
                                                        <i class="fa-solid fa-eye-slash text-xs"></i>
                                                    </button>
                                                    <button 
                                                        v-else
                                                        @click.stop="showTransaction(trans.id)" 
                                                        class="bg-green-100 text-green-600 p-2 rounded-lg hover:bg-green-200 transition shadow-sm"
                                                        title="Afficher cette transaction"
                                                    >
                                                        <i class="fa-solid fa-eye text-xs"></i>
                                                    </button>
                                                    <button 
                                                        @click.stop="deleteTransaction(trans.id)" 
                                                        class="bg-red-500 text-white p-2 rounded-lg hover:bg-red-600 transition shadow-sm"
                                                        title="Supprimer cette transaction"
                                                    >
                                                        <i class="fa-solid fa-trash text-xs"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div v-if="allTransactions.length === 0" class="text-center text-slate-400 py-12">
                                        <i class="fa-solid fa-inbox text-5xl mb-3"></i>
                                        <p class="text-lg font-medium">Aucune transaction</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Performance & Finances -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="bg-gradient-to-br from-green-50 to-white rounded-2xl shadow-lg border-2 border-green-100 p-6 relative overflow-hidden">
                                    <div class="absolute top-0 right-0 w-24 h-24 bg-green-200/30 rounded-full -mr-12 -mt-12"></div>
                                    <div class="relative z-10">
                                        <h3 class="text-lg font-bold mb-6 text-slate-800 flex items-center gap-2">
                                            <div class="w-10 h-10 bg-green-500 rounded-xl flex items-center justify-center">
                                                <i class="fa-solid fa-chart-line text-white"></i>
                                            </div>
                                            Performance
                                        </h3>
                                        <div class="space-y-4">
                                            <div class="bg-white/80 rounded-xl p-4 border border-green-100">
                                                <div class="flex justify-between items-center">
                                                    <span class="text-slate-600 font-medium">Chiffre d'affaires</span>
                                                    <span class="text-2xl font-black text-green-600">{{ formatPrice(prospecteurStats.ca) }}</span>
                                                </div>
                                            </div>
                                            <div class="bg-white/80 rounded-xl p-4 border border-blue-100">
                                                <div class="flex justify-between items-center">
                                                    <span class="text-slate-600 font-medium">RDV Honor√©s</span>
                                                    <span class="text-xl font-bold text-blue-600">{{ prospecteurStats.honoredCount }}</span>
                                                </div>
                                            </div>
                                            <div class="pt-3 border-t border-slate-200">
                                                <span class="text-xs font-bold text-slate-500 uppercase mb-3 block">Paliers atteints</span>
                                                <div class="space-y-2">
                                                    <div v-for="tier in prospecteurStats.tiers" :key="tier.level" class="flex items-center gap-3 p-2 rounded-lg" :class="tier.reached ? 'bg-green-50' : 'bg-slate-50'">
                                                        <i :class="tier.reached ? 'fa-solid fa-check-circle text-green-500 text-lg' : 'fa-regular fa-circle text-gray-300'"></i>
                                                        <span class="text-sm font-medium" :class="tier.reached ? 'font-bold text-green-700' : 'text-gray-400'">
                                                            Palier {{ tier.level }}: {{ tier.count }} RDV
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Finances -->
                                <div class="bg-gradient-to-br from-purple-50 to-white rounded-2xl shadow-lg border-2 border-purple-100 p-6 relative overflow-hidden">
                                    <div class="absolute top-0 right-0 w-24 h-24 bg-purple-200/30 rounded-full -mr-12 -mt-12"></div>
                                    <div class="relative z-10">
                                        <h3 class="text-lg font-bold mb-6 text-slate-800 flex items-center gap-2">
                                            <div class="w-10 h-10 bg-purple-500 rounded-xl flex items-center justify-center">
                                                <i class="fa-solid fa-calculator text-white"></i>
                                            </div>
                                            Finances
                                        </h3>
                                        <div class="space-y-3">
                                            <div class="bg-white/80 rounded-xl p-3 border border-green-100">
                                                <div class="flex justify-between items-center">
                                                    <span class="text-slate-600 text-sm font-medium">CA g√©n√©r√©</span>
                                                    <span class="text-lg font-bold text-green-600">+{{ formatPrice(prospecteurStats.ca) }}</span>
                                                </div>
                                            </div>
                                            <div class="bg-white/80 rounded-xl p-3 border border-red-100">
                                                <div class="flex justify-between items-center">
                                                    <span class="text-slate-600 text-sm font-medium">Primes</span>
                                                    <span class="text-lg font-bold text-red-600">-{{ formatPrice(prospecteurStats.commissions) }}</span>
                                                </div>
                                            </div>
                                            <div class="bg-white/80 rounded-xl p-3 border border-red-100">
                                                <div class="flex justify-between items-center">
                                                    <span class="text-slate-600 text-sm font-medium">Pourboires</span>
                                                    <span class="text-lg font-bold text-red-600">-{{ formatPrice(prospecteurStats.tips) }}</span>
                                                </div>
                                            </div>
                                            <div class="pt-4 mt-4 border-t-2 border-slate-300 bg-gradient-to-r from-slate-50 to-white rounded-xl p-4">
                                                <div class="flex justify-between items-center">
                                                    <span class="text-lg font-bold text-slate-800">Reste net</span>
                                                    <span class="text-3xl font-black" :class="prospecteurStats.net >= 0 ? 'text-green-600' : 'text-red-600'">
                                                        {{ formatPrice(prospecteurStats.net) }}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Gestion Pourboires -->
                            <div class="bg-gradient-to-br from-orange-50 to-white rounded-2xl shadow-lg border-2 border-orange-100 p-6">
                                <h3 class="text-lg font-bold mb-6 text-slate-800 flex items-center gap-2">
                                    <div class="w-10 h-10 bg-orange-500 rounded-xl flex items-center justify-center">
                                        <i class="fa-solid fa-hand-holding-dollar text-white"></i>
                                    </div>
                                    Gestion Pourboires
                                </h3>
                                <div class="flex justify-center">
                                    <button @click="openTipModal" class="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-8 py-4 rounded-2xl font-bold hover:from-purple-700 hover:to-pink-700 transition shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center gap-3 text-lg">
                                        <i class="fa-solid fa-hand-holding-dollar text-2xl"></i>
                                        G√©rer les Pourboires
                                            </button>
                                        </div>
                                    </div>
                                        </div>
                                    </div>

                    <!-- VUE PROSPECTEUR -->
                    <div v-else class="space-y-6">
                        <!-- Carte Bancaire R√©aliste -->
                        <div class="flex justify-center">
                            <div class="w-full max-w-md">
                                <div class="bg-white rounded-2xl shadow-2xl p-6 border-2 border-blue-200 relative overflow-hidden transform hover:scale-[1.01] transition-all duration-300" style="aspect-ratio: 1.586;">
                                    <!-- Effets de lumi√®re subtils -->
                                    <div class="absolute top-0 right-0 w-64 h-64 bg-blue-100/30 rounded-full -mr-32 -mt-32"></div>
                                    <div class="absolute bottom-0 left-0 w-48 h-48 bg-blue-100/30 rounded-full -ml-24 -mb-24"></div>
                                    
                                    <!-- Motif de fond discret -->
                                    <div class="absolute inset-0 opacity-5">
                                        <div class="absolute inset-0" style="background-image: radial-gradient(circle at 20% 50%, #667eea 1px, transparent 1px); background-size: 20px 20px;"></div>
                            </div>

                                    <!-- Contenu de la carte -->
                                    <div class="relative z-10 h-full flex flex-col justify-between">
                                        <!-- En-t√™te avec logo -->
                                <div class="flex items-center justify-between mb-4">
                                            <div class="text-slate-800 font-bold text-lg tracking-wide">C&N Solutions</div>
                                            <div class="flex items-center gap-2">
                                                <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                                                    <i class="fa-solid fa-credit-card text-sm text-blue-600"></i>
                                </div>
                                            </div>
                                                </div>
                                        
                                        <!-- Chip de carte -->
                                        <div class="absolute top-12 right-6 w-12 h-9 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-md shadow-lg flex items-center justify-center">
                                            <div class="w-full h-full bg-gradient-to-br from-transparent via-white/30 to-transparent rounded-md relative">
                                                <div class="absolute inset-0 flex items-center justify-center">
                                                    <div class="w-3 h-3 bg-white/40 rounded-sm"></div>
                                            </div>
                                        </div>
                                        </div>
                                        
                                        <!-- Num√©ro de carte masqu√© -->
                                        <div class="flex-1 flex items-center">
                                            <div class="w-full">
                                                <p class="text-blue-600 text-xs font-medium uppercase mb-3 tracking-widest">Num√©ro de compte</p>
                                                <div class="flex items-center gap-2 mb-6">
                                                    <span class="text-2xl font-mono font-bold tracking-widest text-slate-400">**** **** ****</span>
                                                    <span class="text-2xl font-mono font-bold tracking-widest text-slate-800">{{ String(Math.abs(userPortefeuille.total)).slice(-4).padStart(4, '0') }}</span>
                                    </div>
                                                
                                                <!-- Solde disponible -->
                                                <div class="mb-4">
                                                    <p class="text-blue-600 text-xs font-medium uppercase mb-1 tracking-widest">Solde disponible</p>
                                                    <p class="text-3xl font-black text-slate-800">{{ formatPrice(userPortefeuille.total) }}</p>
                                    </div>
                                </div>
                            </div>
                                        
                                        <!-- Bas de carte avec nom -->
                                        <div class="flex items-end justify-between pt-4 border-t border-slate-200">
                                            <div class="flex-1">
                                                <p class="text-blue-600 text-xs font-medium uppercase mb-1 tracking-widest">Titulaire</p>
                                                <p class="text-slate-800 text-lg font-bold uppercase tracking-wide truncate">{{ user.name }}</p>
                        </div>
                                            <div class="text-right">
                                                <div class="w-12 h-8 bg-blue-100 rounded flex items-center justify-center mb-1">
                                                    <div class="w-8 h-5 bg-gradient-to-br from-blue-400 to-blue-600 rounded-sm"></div>
                    </div>
                                                <p class="text-blue-600 text-[8px] font-medium uppercase">VISA</p>
                                    </div>
                                    </div>
                                </div>
                                </div>
                            </div>
                        </div>

                        <!-- Historique des Transactions -->
                        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                                <i class="fa-solid fa-history text-blue-500"></i>
                                Historique des transactions
                            </h3>
                                <button @click="loadUserTransactions()" class="bg-blue-100 text-blue-600 p-2 rounded-lg hover:bg-blue-200 transition" title="Actualiser">
                                    <i class="fa-solid fa-sync-alt"></i>
                                </button>
                            </div>
                            <div class="space-y-3">
                                <div 
                                    v-for="trans in visibleTransactions" 
                                    :key="trans.id"
                                    @click="trans.rdvId && openRdvFiche(getRdvFromTransaction(trans))"
                                    class="p-5 bg-gradient-to-br from-white to-slate-50 hover:from-blue-50 hover:to-blue-100 rounded-2xl border-2 transition-all cursor-pointer shadow-sm hover:shadow-md"
                                    :class="trans.hidden ? 'opacity-60 border-slate-300' : (trans.amount >= 0 ? 'border-green-200 hover:border-green-400' : 'border-red-200 hover:border-red-400')"
                                >
                                    <div class="flex items-start gap-4">
                                        <div class="w-14 h-14 rounded-2xl flex items-center justify-center flex-shrink-0 shadow-md" 
                                             :class="trans.type === 'bonus' ? 'bg-gradient-to-br from-yellow-400 to-orange-500' : (trans.amount >= 0 ? 'bg-gradient-to-br from-green-400 to-emerald-500' : 'bg-gradient-to-br from-red-400 to-rose-500')">
                                            <i :class="getTransactionIcon(trans.type)" class="text-white text-xl"></i>
                                            </div>
                                        <div class="flex-1 min-w-0">
                                            <div class="flex items-center gap-2 mb-2">
                                                <span class="font-bold text-lg text-slate-800">{{ trans.label }}</span>
                                                <span v-if="trans.type === 'bonus'" class="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full font-bold animate-pulse">
                                                    <i class="fa-solid fa-star mr-1"></i>Bonus
                                                </span>
                                            </div>
                                            <div class="text-sm text-slate-500 mb-3 font-medium">
                                                <i class="fa-solid fa-clock mr-1"></i>{{ formatDateFr(trans.date) }}
                                        </div>
                                            <!-- D√©tails du RDV si disponible -->
                                            <div v-if="getRdvFromTransaction(trans)" class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3 p-3 bg-white/60 rounded-xl border border-slate-200">
                                                <div v-if="getRdvFromTransaction(trans).agenceId" class="flex items-center gap-2 text-blue-700 font-medium">
                                                    <i class="fa-solid fa-building text-blue-500"></i>
                                                    <span>{{ getAgenceName(getRdvFromTransaction(trans).agenceId) }}</span>
                                                </div>
                                                <div v-if="getRdvFromTransaction(trans).civilite && getRdvFromTransaction(trans).nom" class="flex items-center gap-2 text-slate-700 font-medium">
                                                    <i class="fa-solid fa-user text-slate-500"></i>
                                                    <span>{{ getRdvFromTransaction(trans).civilite }} {{ getRdvFromTransaction(trans).nom }}</span>
                                                </div>
                                                <div v-if="getRdvFromTransaction(trans).date && getRdvFromTransaction(trans).heure" class="flex items-center gap-2 text-slate-600">
                                                    <i class="fa-solid fa-calendar text-slate-400"></i>
                                                    <span>{{ formatDateShort(getRdvFromTransaction(trans).date) }} √† {{ getRdvFromTransaction(trans).heure }}</span>
                                                </div>
                                                <div v-if="getRdvFromTransaction(trans).modele" class="flex items-center gap-2 text-slate-600">
                                                    <i class="fa-solid fa-car text-slate-400"></i>
                                                    <span>{{ getRdvFromTransaction(trans).modele }}</span>
                                                </div>
                                                <div v-if="trans.rdvId" class="flex items-center gap-2 text-blue-600 font-medium">
                                                    <i class="fa-solid fa-eye text-blue-500"></i>
                                                    <span>Cliquer pour voir le r√©capitulatif</span>
                                                </div>
                                            </div>
                                            <!-- D√©tails bonus si c'est un bonus -->
                                            <div v-if="trans.type === 'bonus' && trans.bonusCount" class="mt-3 p-3 bg-yellow-50 rounded-xl border border-yellow-200">
                                                <div class="text-sm text-yellow-800 font-medium">
                                                    <i class="fa-solid fa-trophy mr-2"></i>
                                                    Palier atteint : {{ trans.bonusCount }} RDV honor√©s
                                                </div>
                                            </div>
                                            <!-- Note si disponible -->
                                            <div v-if="trans.note" class="mt-3 text-sm text-slate-600 italic bg-slate-100 p-3 rounded-xl border border-slate-200">
                                                <i class="fa-solid fa-sticky-note mr-2 text-slate-400"></i>{{ trans.note }}
                                            </div>
                                        </div>
                                        <div class="flex flex-col items-end gap-2 flex-shrink-0">
                                            <span class="text-2xl font-black whitespace-nowrap" :class="trans.amount >= 0 ? 'text-green-600' : 'text-red-600'">
                                                {{ trans.amount >= 0 ? '+' : '' }}{{ formatPrice(trans.amount) }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div v-if="visibleTransactions.length === 0" class="text-center text-slate-400 py-8">
                                    <i class="fa-solid fa-inbox text-4xl mb-2"></i>
                                    <p>Aucune transaction visible</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VUE BILAN -->
                <div v-if="view==='bilan'" class="max-w-7xl mx-auto space-y-6 fade-in">
                    <!-- Onglets Bilan -->
                    <div class="bg-slate-100 p-2 rounded-xl flex gap-2 mb-6">
                        <button @click="bilanTab = 'main'" :class="bilanTab==='main' ? 'bg-white text-blue-600 shadow-md' : 'text-slate-600'" class="flex-1 px-4 py-3 rounded-lg font-bold transition">
                            <i class="fa-solid fa-chart-pie mr-2"></i> Bilan
                        </button>
                        <button @click="bilanTab = 'urgent'" :class="bilanTab==='urgent' ? 'bg-white text-orange-600 shadow-md' : 'text-slate-600'" class="flex-1 px-4 py-3 rounded-lg font-bold transition relative">
                            <i class="fa-solid fa-exclamation-triangle mr-2"></i> √Ä traiter urgent
                            <span v-if="urgentBilanCount > 0" class="absolute -top-1 -right-1 bg-red-600 text-white text-xs px-2 py-1 rounded-full font-bold">{{ urgentBilanCount }}</span>
                        </button>
                        <button @click="bilanTab = 'objectifs'" :class="bilanTab==='objectifs' ? 'bg-white text-green-600 shadow-md' : 'text-slate-600'" class="flex-1 px-4 py-3 rounded-lg font-bold transition">
                            <i class="fa-solid fa-bullseye mr-2"></i> Objectifs
                        </button>
                    </div>

                    <!-- Contenu principal du Bilan -->
                    <div v-if="bilanTab==='main'">
                    <h2 class="text-2xl md:text-3xl font-bold text-slate-800 mb-6 flex items-center gap-3">
                        <i class="fa-solid fa-chart-pie text-blue-500"></i>
                        Bilan & Facturation
                    </h2>

                    <!-- Dashboard Bilan -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 md:gap-6 mb-6">
                        <div class="bg-white rounded-2xl shadow-lg border border-slate-200 p-4 md:p-6">
                            <div class="text-xs font-bold text-slate-500 uppercase mb-2">CA {{ bilanConfig.tvaActive ? 'HT' : '' }}</div>
                            <div class="text-2xl md:text-3xl font-black text-blue-600">{{ formatBilanPrice(bilanStats.ht) }}‚Ç¨</div>
                            <div class="text-xs md:text-sm text-slate-500 mt-2">{{ bilanStats.rdv }} RDV</div>
                        </div>
                        <div v-if="bilanConfig.tvaActive" class="bg-white rounded-2xl shadow-lg border border-slate-200 p-4 md:p-6">
                            <div class="text-xs font-bold text-slate-500 uppercase mb-2">TVA Collect√©e</div>
                            <div class="text-2xl md:text-3xl font-black text-orange-600">{{ formatBilanPrice(bilanStats.tva) }}‚Ç¨</div>
                        </div>
                        <div v-if="bilanConfig.tvaActive" class="bg-white rounded-2xl shadow-lg border border-slate-200 p-4 md:p-6 sm:col-span-2 md:col-span-1">
                            <div class="text-xs font-bold text-slate-500 uppercase mb-2">Total TTC</div>
                            <div class="text-2xl md:text-3xl font-black text-green-600">{{ formatBilanPrice(bilanStats.ttc) }}‚Ç¨</div>
                        </div>
                    </div>

                    <!-- Boutons d'action -->
                    <div class="flex flex-wrap gap-2 md:gap-3 mb-6">
                        <button @click="syncAllHonoredRdv" class="bg-purple-600 hover:bg-purple-700 text-white px-4 md:px-6 py-2 md:py-3 rounded-xl font-bold shadow-lg flex items-center gap-2 text-sm md:text-base">
                            <i class="fa-solid fa-sync-alt"></i> <span class="hidden sm:inline">Synchroniser RDV honor√©s</span><span class="sm:hidden">Sync</span>
                        </button>
                       <button @click="openBillingSummary" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 md:px-6 py-2 md:py-3 rounded-xl font-bold shadow-lg flex items-center gap-2 text-sm md:text-base">
    <i class="fa-solid fa-file-invoice-dollar"></i> <span class="hidden sm:inline">√âtat Facturation</span>
</button>
                       
                        <button @click="exportMonthPdfAll" class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 md:px-6 py-2 md:py-3 rounded-xl font-bold border border-slate-300 flex items-center gap-2 text-sm md:text-base">
                            <i class="fa-solid fa-file-pdf"></i> <span class="hidden sm:inline">PDF</span>
                        </button>
                        <button @click="exportComptaExcel" class="bg-green-100 hover:bg-green-200 text-green-700 px-4 md:px-6 py-2 md:py-3 rounded-xl font-bold border border-green-300 flex items-center gap-2 text-sm md:text-base">
                            <i class="fa-solid fa-file-excel"></i> <span class="hidden sm:inline">Excel</span>
                        </button>
                        <button v-if="user.role==='admin'" @click="openBilanSettings" class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 md:px-6 py-2 md:py-3 rounded-xl font-bold border border-slate-300 flex items-center gap-2 text-sm md:text-base">
                            <i class="fa-solid fa-gear"></i> <span class="hidden sm:inline">R√©glages</span>
                        </button>
                    </div>

                    <!-- Formulaire de saisie -->
                    <div class="bg-white rounded-2xl shadow-lg border border-slate-200 p-6 mb-6">
                        <h3 class="text-lg font-bold text-slate-800 mb-4">Ajouter des RDV factur√©s</h3>
                        <form @submit.prevent="saveBilanRdv" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Date</label>
                                    <input type="date" v-model="bilanForm.date" required class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-blue-500 outline-none">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Report facturation</label>
                                    <button type="button" @click="toggleBilanReport" :class="bilanForm.reporte ? 'bg-orange-100 text-orange-700 border-orange-300' : 'bg-slate-100 text-slate-700 border-slate-300'" class="w-full px-4 py-3 rounded-xl font-bold border-2">
                                        {{ bilanForm.reporte ? 'OUI (Report M+1)' : 'NON (Mois en cours)' }}
                                    </button>
                                </div>
                            </div>
                            <div id="bilanRdvBlocks" class="space-y-3">
                                <div v-for="(block, idx) in bilanForm.blocks" :key="idx" class="flex flex-wrap gap-2 md:gap-3 items-center p-3 md:p-4 bg-slate-50 rounded-xl border border-slate-200">
                                    <select v-model="block.agenceId" @change="onBilanAgenceChange(idx)" required class="flex-1 min-w-[140px] px-3 md:px-4 py-2 md:py-3 border-2 border-slate-200 rounded-xl focus:border-blue-500 outline-none text-sm md:text-base">
                                        <option value="">Agence...</option>
                                        <option v-for="ag in agences" :key="ag.id" :value="ag.id">{{ ag.nom }}</option>
                                    </select>
                                    <select v-if="hasBilanCommerciaux(idx)" v-model="block.commercial" required class="flex-1 min-w-[140px] px-3 md:px-4 py-2 md:py-3 border-2 border-slate-200 rounded-xl focus:border-blue-500 outline-none text-sm md:text-base">
                                        <option value="">Commercial...</option>
                                        <option v-for="comm in getBilanCommerciaux(idx)" :key="comm" :value="comm">{{ comm }}</option>
                                    </select>
                                    <input type="number" v-model.number="block.rdv" placeholder="Nb" required min="1" class="w-16 md:w-24 px-2 md:px-4 py-2 md:py-3 border-2 border-slate-200 rounded-xl focus:border-blue-500 outline-none text-center font-bold text-sm md:text-base">
                                    <input type="number" v-model.number="block.tarif" placeholder="‚Ç¨" required min="0" step="0.01" class="w-20 md:w-32 px-2 md:px-4 py-2 md:py-3 border-2 border-slate-200 rounded-xl focus:border-blue-500 outline-none text-center text-sm md:text-base">
                                    <button type="button" @click="removeBilanBlock(idx)" class="text-red-600 hover:text-red-800 font-bold text-lg md:text-xl px-2">√ó</button>
                                </div>
                            </div>
                            <div class="flex gap-3">
                                <button type="button" @click="addBilanBlock" class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-6 py-3 rounded-xl font-bold border border-slate-300 flex items-center gap-2">
                                    <i class="fa-solid fa-plus"></i> Ajouter ligne
                                </button>
                                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl font-bold shadow-lg flex items-center gap-2">
                                    <i class="fa-solid fa-save"></i> Enregistrer
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Filtres -->
                    <div class="bg-white rounded-2xl shadow-lg border border-slate-200 p-3 md:p-4 mb-6">
                        <div class="grid grid-cols-2 md:flex md:flex-wrap gap-2 md:gap-3 items-center">
                            <input type="text" v-model="bilanFilters.search" @input="renderBilanTable" placeholder="üîç Rechercher par agence ou commercial..." class="col-span-2 md:col-span-1 px-3 md:px-4 py-2 border-2 border-slate-200 rounded-xl focus:border-blue-500 outline-none text-sm md:text-base">
                            <input type="date" v-model="bilanFilters.jour" @change="renderBilanTable" class="col-span-2 md:col-span-1 px-3 md:px-4 py-2 border-2 border-slate-200 rounded-xl focus:border-blue-500 outline-none text-sm md:text-base">
                            <select v-model="bilanFilters.mois" @change="renderBilanTable" class="col-span-1 px-3 md:px-4 py-2 border-2 border-slate-200 rounded-xl focus:border-blue-500 outline-none text-sm md:text-base">
                                <option value="">Mois</option>
                                <option value="01">Janvier</option>
                                <option value="02">F√©vrier</option>
                                <option value="03">Mars</option>
                                <option value="04">Avril</option>
                                <option value="05">Mai</option>
                                <option value="06">Juin</option>
                                <option value="07">Juillet</option>
                                <option value="08">Ao√ªt</option>
                                <option value="09">Septembre</option>
                                <option value="10">Octobre</option>
                                <option value="11">Novembre</option>
                                <option value="12">D√©cembre</option>
                            </select>
                            <select v-model="bilanFilters.annee" @change="renderBilanTable" class="col-span-1 px-3 md:px-4 py-2 border-2 border-slate-200 rounded-xl focus:border-blue-500 outline-none text-sm md:text-base">
                                <option value="">Ann√©e</option>
                                <option v-for="y in bilanYearOptions" :key="y" :value="y">{{ y }}</option>
                            </select>
                            <select v-model="bilanFilters.agence" @change="renderBilanTable" class="col-span-2 md:col-span-1 px-3 md:px-4 py-2 border-2 border-slate-200 rounded-xl focus:border-blue-500 outline-none text-sm md:text-base">
                                <option value="">Toutes les agences</option>
                                <option v-for="ag in agences" :key="ag.id" :value="ag.nom">{{ ag.nom }}</option>
                            </select>
                            <select v-model="bilanFilters.commercial" @change="renderBilanTable" class="col-span-2 md:col-span-1 px-3 md:px-4 py-2 border-2 border-slate-200 rounded-xl focus:border-blue-500 outline-none text-sm md:text-base">
                                <option value="">Tous les commerciaux</option>
                            </select>
                            <button @click="goToPreviousMonth" class="col-span-1 bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 md:px-4 py-2 rounded-xl font-bold border border-blue-300 text-sm md:text-base flex items-center justify-center gap-2">
                                <i class="fa-solid fa-chevron-left"></i> Mois pr√©c√©dent
                            </button>
                            <button @click="clearBilanFilters" class="col-span-1 bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 md:px-4 py-2 rounded-xl font-bold border border-slate-300 text-sm md:text-base">
                                Effacer
                            </button>
                            <button @click="deleteSelectedBilan" class="col-span-1 bg-red-100 hover:bg-red-200 text-red-700 px-3 md:px-4 py-2 rounded-xl font-bold border border-red-300 text-sm md:text-base">
                                Suppr.
                            </button>
                        </div>
                    </div>

                    <!-- Tableau Desktop -->
                    <div class="bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden hidden md:block">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-slate-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase"><input type="checkbox" @change="toggleAllBilan($event)" :checked="isAllBilanSelected" class="custom-checkbox"></th>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase">Date</th>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase">Agence</th>
                                        <th class="px-4 py-3 text-right text-xs font-bold text-slate-600 uppercase">RDV</th>
                                        <th class="px-4 py-3 text-right text-xs font-bold text-slate-600 uppercase">Tarif</th>
                                        <th v-if="bilanConfig.tvaActive" class="px-4 py-3 text-right text-xs font-bold text-slate-600 uppercase">HT</th>
                                        <th v-if="bilanConfig.tvaActive" class="px-4 py-3 text-right text-xs font-bold text-slate-600 uppercase">TVA</th>
                                        <th class="px-4 py-3 text-right text-xs font-bold text-slate-600 uppercase">Total</th>
                                        <th class="px-4 py-3 text-right text-xs font-bold text-slate-600 uppercase">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="r in displayedBilanRows" :key="r.id" class="border-t border-slate-100 hover:bg-slate-50">
                                        <td class="px-4 py-3"><input type="checkbox" :value="r.id" v-model="selectedBilanIds" class="custom-checkbox"></td>
                                        <td class="px-4 py-3 font-medium">{{ formatBilanDate(r.periodDate || r.date) }}</td>
                                        <td class="px-4 py-3">
                                            <div class="font-bold">{{ r.agence }}</div>
                                            <div v-if="r.commercial" class="text-xs text-slate-500">{{ r.commercial }}</div>
                                        </td>
                                        <td class="px-4 py-3 text-right font-bold">{{ r.rdv }}</td>
                                        <td class="px-4 py-3 text-right">{{ formatBilanPrice(r.tarif) }}‚Ç¨</td>
                                        <td v-if="bilanConfig.tvaActive" class="px-4 py-3 text-right">{{ formatBilanPrice(getBilanLineVals(r).ht) }}‚Ç¨</td>
                                        <td v-if="bilanConfig.tvaActive" class="px-4 py-3 text-right text-slate-500">{{ formatBilanPrice(getBilanLineVals(r).tva) }}‚Ç¨</td>
                                        <td class="px-4 py-3 text-right font-bold">
                                            <div>{{ formatBilanPrice(bilanConfig.tvaActive ? getBilanLineVals(r).ttc : getBilanLineVals(r).ht) }}‚Ç¨</div>
                                            <div v-if="r.reporte" class="text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded mt-1 inline-block">REPORT√â</div>
                                        </td>
                                        <td class="px-4 py-3 text-right">
                                            <button @click="openBilanEdit(r)" class="text-blue-600 hover:text-blue-800 font-bold">
                                                <i class="fa-solid fa-pen"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div v-if="displayedBilanRows.length === 0" class="text-center py-12 text-slate-400">
                            <i class="fa-solid fa-inbox text-4xl mb-3"></i>
                            <p>Aucun RDV factur√©</p>
                        </div>
                    </div>

                    <!-- Version Mobile Minimaliste -->
                    <div class="md:hidden space-y-3">
                        <!-- Checkbox pour s√©lectionner tout -->
                        <div class="bg-white rounded-xl p-3 border border-slate-200 flex items-center gap-3">
                            <input type="checkbox" @change="toggleAllBilan($event)" :checked="isAllBilanSelected" class="custom-checkbox">
                            <span class="text-sm font-bold text-slate-700">S√©lectionner tout</span>
                        </div>
                        
                        <!-- Cartes pour chaque RDV -->
                        <div v-for="r in displayedBilanRows" :key="r.id" class="bg-white rounded-xl p-4 border border-slate-200 shadow-sm">
                            <div class="flex items-start justify-between mb-3">
                                <div class="flex items-center gap-3 flex-1">
                                    <input type="checkbox" :value="r.id" v-model="selectedBilanIds" class="custom-checkbox flex-shrink-0">
                                    <div class="flex-1 min-w-0">
                                        <div class="font-bold text-slate-800 truncate">{{ r.agence }}</div>
                                        <div class="text-xs text-slate-500 mt-1">{{ formatBilanDate(r.periodDate || r.date) }}</div>
                                        <div v-if="r.commercial" class="text-xs text-blue-600 mt-1">{{ r.commercial }}</div>
                                    </div>
                                </div>
                                <button @click="openBilanEdit(r)" class="text-blue-600 hover:text-blue-800 font-bold p-2 flex-shrink-0">
                                    <i class="fa-solid fa-pen text-lg"></i>
                                </button>
                            </div>
                            <div class="flex items-center justify-between pt-3 border-t border-slate-100">
                                <div class="text-sm text-slate-600">
                                    <span class="font-bold">{{ r.rdv }}</span> RDV
                                </div>
                                <div class="text-right">
                                    <div class="font-bold text-lg text-blue-600">{{ formatBilanPrice(bilanConfig.tvaActive ? getBilanLineVals(r).ttc : getBilanLineVals(r).ht) }}‚Ç¨</div>
                                    <div v-if="r.reporte" class="text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded mt-1 inline-block">REPORT√â</div>
                                </div>
                            </div>
                        </div>
                        
                        <div v-if="displayedBilanRows.length === 0" class="text-center py-12 text-slate-400 bg-white rounded-xl border border-slate-200">
                            <i class="fa-solid fa-inbox text-4xl mb-3"></i>
                            <p>Aucun RDV factur√©</p>
                        </div>
                    </div>

                    <!-- Pagination -->
                    <div class="flex justify-end gap-3 items-center">
                        <button @click="changeBilanPage(-1)" :disabled="bilanCurrentPage === 1" class="px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-xl font-bold disabled:opacity-50">Pr√©c.</button>
                        <span class="text-sm font-bold">Page {{ bilanCurrentPage }} / {{ bilanTotalPages }}</span>
                        <button @click="changeBilanPage(1)" :disabled="bilanCurrentPage >= bilanTotalPages" class="px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-xl font-bold disabled:opacity-50">Suiv.</button>
                    </div>
                    </div>

                    <!-- Onglet √Ä traiter urgent -->
                    <div v-if="bilanTab==='urgent'" class="space-y-6">
                        <h2 class="text-2xl md:text-3xl font-bold text-orange-600 mb-6 flex items-center gap-3">
                            <i class="fa-solid fa-exclamation-triangle text-orange-500"></i>
                            √Ä traiter urgent
                        </h2>
                        <p class="text-slate-600 mb-4">RDV honor√©s n√©cessitant l'assignation d'un commercial. V√©rifiez l'agenda Google Calendar du professionnel pour identifier le commercial.</p>
                        
                        <div class="bg-white rounded-2xl shadow-lg border border-orange-200 overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-orange-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase">Date</th>
                                            <th class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase">Agence</th>
                                            <th class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase">Client</th>
                                            <th class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase">T√©l√©phone</th>
                                            <th class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase">Voir Agenda</th>
                                            <th class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="r in urgentBilanRows" :key="r.id" class="border-t border-slate-100 hover:bg-orange-50">
                                            <td class="px-4 py-3 font-medium">{{ formatBilanDate(r.date) }}</td>
                                            <td class="px-4 py-3 font-bold">{{ r.agence }}</td>
                                            <td class="px-4 py-3">{{ getUrgentRdvClient(r) }}</td>
                                            <td class="px-4 py-3">{{ getUrgentRdvPhone(r) }}</td>
                                            <td class="px-4 py-3">
                                                <a v-if="r.googleCalendarEventId" :href="`https://calendar.google.com/calendar/r/eventedit/${r.googleCalendarEventId}`" target="_blank" class="text-blue-600 hover:text-blue-800 font-bold text-sm flex items-center gap-1">
                                                    <i class="fa-solid fa-external-link"></i> Voir Agenda
                                                </a>
                                                <span v-else class="text-slate-400 text-sm">N/A</span>
                                            </td>
                                            <td class="px-4 py-3">
                                                <button @click="openUrgentCommercialModal(r)" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-xl font-bold text-sm flex items-center gap-2">
                                                    <i class="fa-solid fa-check"></i> J'ai le commercial
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div v-if="urgentBilanRows.length === 0" class="text-center py-12 text-slate-400">
                                <i class="fa-solid fa-check-circle text-4xl mb-3 text-green-500"></i>
                                <p class="font-bold">Aucun RDV urgent √† traiter</p>
                            </div>
                        </div>
                    </div>

                    <!-- Onglet Objectifs -->
                    <div v-if="bilanTab==='objectifs'" class="space-y-6">
                        <h2 class="text-2xl md:text-3xl font-bold text-green-600 mb-6 flex items-center gap-3">
                            <i class="fa-solid fa-bullseye text-green-500"></i>
                            Objectifs par Agence / Commercial
                        </h2>

                        <!-- Filtres et s√©lection -->
                        <div class="bg-white rounded-2xl shadow-lg border border-slate-200 p-4 md:p-6 mb-6">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">P√©riode</label>
                                    <select v-model="objectifsFilters.mois" @change="updateObjectifsStats" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-green-500 outline-none text-sm md:text-base">
                                        <option value="">Tous les mois</option>
                                        <option v-for="opt in bilanMonthOptions" :key="opt.value" :value="opt.value">{{ opt.label }}</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Agence</label>
                                    <select v-model="objectifsFilters.agence" @change="updateObjectifsStats" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-green-500 outline-none text-sm md:text-base">
                                        <option value="">Toutes les agences</option>
                                        <option v-for="ag in agences" :key="ag.id" :value="ag.id">{{ ag.nom }}</option>
                                    </select>
                                </div>
                                <div class="flex items-end">
                                    <button @click="openObjectifModal(null)" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2">
                                        <i class="fa-solid fa-plus"></i> D√©finir un objectif
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Statistiques par agence -->
                        <div class="space-y-6">
                            <div v-for="agStat in objectifsStats" :key="agStat.agenceId" class="bg-white rounded-3xl shadow-xl border-2 border-slate-200 overflow-hidden hover:shadow-2xl transition-all duration-300">
                                <div class="p-6 bg-gradient-to-br from-green-500 via-blue-500 to-purple-600 border-b-4 border-blue-400">
                                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                                        <div class="flex items-center gap-4">
                                            <div class="w-16 h-16 rounded-2xl bg-white/20 backdrop-blur-sm flex items-center justify-center shadow-xl">
                                                <i class="fa-solid fa-building text-white text-2xl"></i>
                                            </div>
                                            <div>
                                                <h3 class="text-2xl md:text-3xl font-black text-white mb-2 drop-shadow-lg">{{ agStat.agenceNom }}</h3>
                                                <div class="flex flex-wrap gap-4 text-sm">
                                                    <div class="bg-white/20 backdrop-blur-sm px-3 py-1.5 rounded-lg">
                                                        <span class="text-white/90">Total RDV:</span>
                                                        <span class="font-black text-white ml-2 text-lg">{{ agStat.totalRdv }}</span>
                                                    </div>
                                                    <div v-if="agStat.objectifAgence" class="bg-white/20 backdrop-blur-sm px-3 py-1.5 rounded-lg">
                                                        <span class="text-white/90">Objectif:</span>
                                                        <span class="font-black text-white ml-2 text-lg">{{ agStat.objectifAgence }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="flex gap-3 flex-shrink-0">
                                            <button @click="openObjectifModal(agStat.agenceId, null)" class="bg-white hover:bg-blue-50 text-blue-600 px-5 py-3 rounded-xl font-bold text-sm flex items-center gap-2 shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
                                                <i class="fa-solid fa-bullseye"></i> <span class="hidden sm:inline">Objectif</span>
                                            </button>
                                            <button @click="openTarifPersonnaliseModal(agStat.agenceId)" class="bg-white hover:bg-purple-50 text-purple-600 px-5 py-3 rounded-xl font-bold text-sm flex items-center gap-2 shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
                                                <i class="fa-solid fa-euro-sign"></i> <span class="hidden sm:inline">Tarifs</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- D√©tail par commercial -->
                                <div class="p-4 md:p-6">
                                    <div v-if="agStat.commerciaux && agStat.commerciaux.length > 0" class="space-y-3">
                                        <div v-for="comm in agStat.commerciaux" :key="comm.nom" class="group relative bg-gradient-to-r from-white to-slate-50 rounded-2xl border-2 border-slate-200 hover:border-blue-300 transition-all duration-300 shadow-sm hover:shadow-md p-5">
                                            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                                                <div class="flex-1 min-w-0">
                                                    <div class="flex items-center gap-3 mb-2">
                                                        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center shadow-lg">
                                                            <i class="fa-solid fa-user text-white text-sm"></i>
                                                        </div>
                                                        <div>
                                                            <div class="font-black text-lg text-slate-800">{{ comm.nom || 'Agence (Direct)' }}</div>
                                                            <div class="flex flex-wrap gap-3 text-sm mt-1">
                                                                <div class="flex items-center gap-1.5">
                                                                    <span class="text-slate-500">RDV:</span>
                                                                    <span class="font-bold text-slate-800 bg-blue-50 px-2 py-0.5 rounded-lg">{{ comm.rdv }}</span>
                                                                </div>
                                                                <div v-if="comm.objectif" class="flex items-center gap-1.5">
                                                                    <span class="text-slate-500">Objectif:</span>
                                                                    <span class="font-bold text-slate-800 bg-purple-50 px-2 py-0.5 rounded-lg">{{ comm.objectif }}</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="flex items-center gap-4 flex-shrink-0">
                                                    <div class="text-center min-w-[140px]">
                                                        <div v-if="comm.objectif" class="text-xs font-bold text-slate-500 uppercase mb-2 tracking-wide">Progression</div>
                                                        <div class="flex items-center gap-3">
                                                            <div class="w-32 bg-slate-200 rounded-full h-4 overflow-hidden shadow-inner">
                                                                <div :class="getObjectifProgressClass(comm.rdv, comm.objectif)" 
                                                                     :style="{ width: getObjectifProgressPercent(comm.rdv, comm.objectif) + '%' }" 
                                                                     class="h-full transition-all duration-500 rounded-full shadow-sm"></div>
                                                            </div>
                                                            <span :class="getObjectifStatusClass(comm.rdv, comm.objectif)" class="text-base font-black min-w-[45px]">
                                                                {{ getObjectifProgressPercent(comm.rdv, comm.objectif) }}%
                                                            </span>
                                                        </div>
                                                        <div v-if="comm.objectif" class="mt-2">
                                                            <span :class="comm.rdv >= comm.objectif ? 'bg-green-100 text-green-700 border-green-300' : 'bg-orange-100 text-orange-700 border-orange-300'" 
                                                                  class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-bold border-2">
                                                                <i :class="comm.rdv >= comm.objectif ? 'fa-solid fa-check-circle' : 'fa-solid fa-clock'"></i>
                                                                {{ comm.rdv >= comm.objectif ? 'Objectif atteint' : 'En cours' }}
                                                            </span>
                                                        </div>
                                                    </div>
                                                    <button @click="openObjectifModal(agStat.agenceId, comm.nom)" class="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white px-5 py-2.5 rounded-xl font-bold text-sm flex items-center gap-2 shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
                                                        <i class="fa-solid fa-edit"></i> <span class="hidden sm:inline">Modifier</span>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div v-else class="text-center py-12 text-slate-400 bg-gradient-to-br from-slate-50 to-white rounded-xl border-2 border-dashed border-slate-200">
                                        <i class="fa-solid fa-users text-5xl mb-3 text-slate-300"></i>
                                        <p class="font-bold text-slate-500">Aucun commercial dans cette agence</p>
                                    </div>
                                </div>
                            </div>

                            <div v-if="objectifsStats.length === 0" class="text-center py-12 text-slate-400 bg-white rounded-2xl border border-slate-200">
                                <i class="fa-solid fa-bullseye text-4xl mb-3"></i>
                                <p class="font-bold">Aucune donn√©e disponible</p>
                                <p class="text-sm mt-2">D√©finissez des objectifs pour commencer</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VUE √Ä TRAITER POUR PROSPECTEURS -->
                <div v-if="view==='a_traiter' && user.role !== 'admin'" class="max-w-7xl mx-auto space-y-6 fade-in">
                    <h2 class="text-2xl md:text-3xl font-bold text-orange-600 mb-6 flex items-center gap-3">
                        <i class="fa-solid fa-exclamation-triangle text-orange-500"></i>
                        √Ä traiter urgent
                    </h2>
                    <p class="text-slate-600 mb-4">RDV honor√©s n√©cessitant l'assignation d'un commercial. V√©rifiez l'agenda Google Calendar du professionnel pour identifier le commercial.</p>
                    
                    <div class="bg-white rounded-2xl shadow-lg border border-orange-200 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-orange-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase">Date</th>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase">Agence</th>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase">Client</th>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase">T√©l√©phone</th>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase">Voir Agenda</th>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="r in prospecteurUrgentRows" :key="r.id" class="border-t border-slate-100 hover:bg-orange-50">
                                        <td class="px-4 py-3 font-medium">{{ formatBilanDate(r.date) }}</td>
                                        <td class="px-4 py-3 font-bold">{{ r.agence }}</td>
                                        <td class="px-4 py-3">{{ getUrgentRdvClient(r) }}</td>
                                        <td class="px-4 py-3">{{ getUrgentRdvPhone(r) }}</td>
                                        <td class="px-4 py-3">
                                            <a v-if="r.googleCalendarEventId" :href="`https://calendar.google.com/calendar/r/eventedit/${r.googleCalendarEventId}`" target="_blank" class="text-blue-600 hover:text-blue-800 font-bold text-sm flex items-center gap-1">
                                                <i class="fa-solid fa-external-link"></i> Voir Agenda
                                            </a>
                                            <span v-else class="text-slate-400 text-sm">N/A</span>
                                        </td>
                                        <td class="px-4 py-3">
                                            <button @click="openUrgentCommercialModal(r)" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-xl font-bold text-sm flex items-center gap-2">
                                                <i class="fa-solid fa-check"></i> J'ai le commercial
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div v-if="prospecteurUrgentRows.length === 0" class="text-center py-12 text-slate-400">
                            <i class="fa-solid fa-check-circle text-4xl mb-3 text-green-500"></i>
                            <p class="font-bold">Aucun RDV urgent √† traiter</p>
                        </div>
                    </div>
                </div>

                <!-- VUE CONNEXIONS -->
                <div v-if="view==='connexions' && user.role==='admin'" class="max-w-5xl mx-auto space-y-6 fade-in">
                    <div class="bg-gradient-to-br from-blue-50 to-purple-50 rounded-2xl p-6 border-2 border-blue-200 mb-6">
                        <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-3 mb-2">
                            <i class="fa-solid fa-users text-blue-600"></i>
                            Suivi des connexions
                        </h2>
                        <p class="text-sm text-slate-600">Cliquez sur un utilisateur connect√© pour voir son historique</p>
                    </div>
                    
                    <!-- Utilisateurs actuellement connect√©s -->
                    <div class="bg-white rounded-2xl shadow-lg border-2 border-green-200 p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-bold text-lg text-green-700 flex items-center gap-2">
                                <i class="fa-solid fa-circle text-green-500 text-xs"></i>
                                Actuellement connect√©s ({{ connectedUsers.length }})
                            </h3>
                            <button @click="loadConnexionsHistory" :disabled="loadingConnexions" :class="loadingConnexions ? 'opacity-50 cursor-not-allowed' : ''" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl font-bold text-sm transition flex items-center gap-2">
                                <i :class="loadingConnexions ? 'fa-solid fa-spinner fa-spin' : 'fa-solid fa-sync-alt'"></i>
                                {{ loadingConnexions ? 'Chargement...' : 'Actualiser' }}
                            </button>
                        </div>
                        <div v-if="connectedUsers.length === 0" class="text-center py-8 text-slate-400">
                            <i class="fa-solid fa-user-slash text-4xl mb-2 block opacity-50"></i>
                            <p>Aucun utilisateur connect√©</p>
                        </div>
                        <div v-else class="space-y-3">
                            <div v-for="user in connectedUsers" :key="user.name" @click="openUserHistoryModal(user)" class="bg-green-50 rounded-xl p-4 border border-green-200 flex items-center justify-between cursor-pointer hover:bg-green-100 hover:border-green-300 transition transform hover:scale-[1.02]">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center text-white font-bold">
                                        {{ user.name.charAt(0).toUpperCase() }}
                                    </div>
                                    <div>
                                        <div class="font-bold text-slate-800">{{ user.name }}</div>
                                        <div class="text-xs text-slate-500">Connect√© depuis {{ user.connecteDepuis }}</div>
                                    </div>
                                </div>
                                <div class="text-right flex items-center gap-3">
                                    <div>
                                        <div class="text-xs text-green-600 font-bold">En ligne</div>
                                        <div class="text-xs text-slate-500">{{ user.heureConnexion }}</div>
                                    </div>
                                    <i class="fa-solid fa-chevron-right text-green-500"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div v-if="view==='rappels' || view==='confirmations'" class="max-w-3xl mx-auto space-y-4 fade-in">
    <div class="flex items-center gap-3 mb-6">
        <div class="w-12 h-12 bg-gradient-to-br rounded-xl flex items-center justify-center shadow-lg" :class="view==='rappels' ? 'from-red-500 to-red-600' : 'from-orange-500 to-orange-600'">
            <i :class="view==='rappels' ? 'fa-solid fa-bell' : 'fa-solid fa-calendar-check'" class="text-white text-xl"></i>
        </div>
        <h2
            class="text-xl md:text-2xl font-bold"
            :class="view==='rappels' ? 'text-red-600' : 'text-orange-600'"
        >
            {{ view==='rappels' ? 'Rappels √† effectuer' : 'Rendez-vous √† confirmer' }}
        </h2>
    </div>

    <!-- üî¥ Filtres internes uniquement pour l'onglet Rappels -->
    <div v-if="view==='rappels'" class="bg-gradient-to-br from-white via-red-50/30 to-white rounded-2xl border-2 border-red-200/80 p-4 md:p-5 mb-4 shadow-lg space-y-3 backdrop-blur-sm relative z-10">
        <!-- Onglets Aujourd'hui / Demain (Veille) -->
        <div class="flex gap-2">
            <button
                @click.stop.prevent="rappelFilters.day = 'today'"
                type="button"
                class="flex-1 px-4 py-2.5 rounded-xl text-xs font-bold uppercase tracking-wide border-2 transition-all duration-200 shadow-sm relative z-10"
                :class="rappelFilters.day === 'today'
                    ? 'bg-gradient-to-r from-red-600 to-red-700 text-white border-red-600 shadow-lg shadow-red-200 scale-105'
                    : 'bg-white text-red-600 border-red-200 hover:bg-red-50 hover:border-red-300 hover:shadow-md'"
            >
                <i class="fa-solid fa-calendar-day mr-1"></i> Aujourd'hui <span class="ml-1 px-2 py-0.5 rounded-full text-[10px] font-bold" :class="rappelFilters.day === 'today' ? 'bg-white/20 text-white' : 'bg-red-100 text-red-600'">{{ rappelsJourCount }}</span>
            </button>
            <button
                @click.stop.prevent="rappelFilters.day = 'tomorrow'"
                type="button"
                class="flex-1 px-4 py-2.5 rounded-xl text-xs font-bold uppercase tracking-wide border-2 transition-all duration-200 shadow-sm relative z-10"
                :class="rappelFilters.day === 'tomorrow'
                    ? 'bg-gradient-to-r from-red-600 to-red-700 text-white border-red-600 shadow-lg shadow-red-200 scale-105'
                    : 'bg-white text-red-600 border-red-200 hover:bg-red-50 hover:border-red-300 hover:shadow-md'"
            >
                <i class="fa-solid fa-calendar-plus mr-1"></i> Demain <span class="ml-1 px-2 py-0.5 rounded-full text-[10px] font-bold" :class="rappelFilters.day === 'tomorrow' ? 'bg-white/20 text-white' : 'bg-red-100 text-red-600'">{{ rappelsVeilleCount }}</span>
            </button>
        </div>

        <!-- Filtres Agence / Cr√©√© par -->
        <div class="flex flex-wrap gap-2 items-center">
            <div class="relative flex-1 min-w-[150px]">
                <select
                    v-model="rappelFilters.agenceId"
                    class="appearance-none bg-white border-2 border-red-200 px-3 py-2 pr-8 rounded-xl text-xs font-bold text-slate-700 outline-none focus:border-red-500 focus:ring-2 focus:ring-red-200 shadow-sm transition-all"
                >
                    <option value="">Toutes les agences</option>
                    <option v-for="ag in visibleAgencies" :key="ag.id" :value="ag.id">
                        {{ ag.nom }}
                    </option>
                </select>
                <i class="fa-solid fa-chevron-down absolute right-3 top-2.5 text-[10px] text-red-400 pointer-events-none"></i>
            </div>

            <div class="relative flex-1 min-w-[150px]">
                <select v-if="user.role === 'admin'"
                    v-model="rappelFilters.userId"
                    class="appearance-none bg-white border-2 border-red-200 px-3 py-2 pr-8 rounded-xl text-xs font-bold text-slate-700 outline-none focus:border-red-500 focus:ring-2 focus:ring-red-200 shadow-sm transition-all"
                >
                    <option value="">Tous les utilisateurs</option>
                    <option v-for="u in allProspectors" :key="u" :value="u">
                        {{ u }}
                    </option>
                </select>
                <i v-if="user.role === 'admin'" class="fa-solid fa-chevron-down absolute right-3 top-2.5 text-[10px] text-red-400 pointer-events-none"></i>
            </div>

            <button
                v-if="rappelFilters.day !== 'today' || rappelFilters.agenceId || rappelFilters.userId"
                @click="rappelFilters.day = 'today'; rappelFilters.agenceId=''; rappelFilters.userId='';"
                class="px-4 py-2 rounded-xl text-xs font-bold text-red-600 border-2 border-red-300 bg-white hover:bg-red-50 hover:border-red-400 transition-all shadow-sm"
            >
                <i class="fa-solid fa-rotate-left mr-1"></i> R√©initialiser
            </button>
        </div>
    </div>

    <!-- Message "Tout est √† jour" -->
    <div
        v-if="(view==='rappels' && rappelsDisplay.length === 0) ||
               (view==='confirmations' && confirmList.length === 0)"
        class="bg-white p-10 rounded-2xl text-center text-gray-400 border border-slate-100 shadow-sm"
    >
        <i class="fa-solid fa-check-circle text-4xl mb-2 text-green-500"></i><br>
        Tout est √† jour !
    </div>

    <!-- Liste des rappels / confirmations -->
    <!-- AJOUT CLICK SUR LIGNE ET CLICK STOP SUR BOUTONS -->
    <div
        v-for="r in (view==='rappels' ? rappelsDisplay : confirmList)"
        :key="r.id"
        @click="openRdvFiche(r)"
        class="bg-gradient-to-br from-white via-purple-50/20 to-white p-4 md:p-6 rounded-xl md:rounded-2xl shadow-md border-l-4 flex flex-col md:flex-row justify-between items-start md:items-center hover:shadow-xl hover:scale-[1.01] transition-all duration-200 gap-4 cursor-pointer backdrop-blur-sm"
        :class="view==='rappels' ? 'border-red-500 hover:border-red-600' : 'border-orange-500 hover:border-orange-600'"
    >
        <div class="flex-1">
            <div class="flex items-center gap-2 mb-2">
                <div class="font-bold text-lg text-slate-800">
                    {{ r.civilite }} {{ r.nom }}
                </div>
                <div class="w-2 h-2 rounded-full animate-pulse" :class="view==='rappels' ? 'bg-red-500' : 'bg-orange-500'"></div>
            </div>
            <div class="flex flex-wrap items-center gap-2 text-sm text-slate-600 mb-2">
                <span class="flex items-center gap-1">
                    <i class="fa-solid fa-calendar text-purple-500"></i>
                    {{ formatDateFr(r.date) }}
                </span>
                <span class="text-slate-400">‚Ä¢</span>
                <span class="flex items-center gap-1">
                    <i class="fa-solid fa-clock text-purple-500"></i>
                    {{ r.heure }}
                </span>
                <span class="text-slate-400">‚Ä¢</span>
                <span class="flex items-center gap-1">
                    <i class="fa-solid fa-car text-purple-500"></i>
                    {{ r.modele }}
                </span>
            </div>
            <div class="inline-flex items-center gap-1 px-3 py-1 bg-gradient-to-r from-purple-100 to-purple-50 rounded-lg border border-purple-200">
                <i class="fa-solid fa-building text-purple-600 text-xs"></i>
                <span class="text-xs font-bold text-purple-700">{{ getAgenceName(r.agenceId) }}</span>
            </div>
        </div>

        <div class="flex flex-wrap gap-2 w-full md:w-auto" @click.stop>
            <a
                :href="generateMsgLink(r, view==='rappels' ? getRappelType(r) : 'confirm')"
                target="_blank"
                class="flex-1 md:flex-none justify-center bg-gradient-to-r from-slate-700 to-slate-800 text-white px-4 py-2.5 rounded-xl font-bold hover:from-slate-800 hover:to-slate-900 flex items-center gap-2 shadow-lg shadow-slate-200 transition-all"
            >
                <i class="fa-solid fa-comment-sms"></i>
                <span class="hidden md:inline">{{ view==='rappels' ? getRappelLabel(r) : 'Envoyer la confirmation' }}</span>
                <span class="md:hidden">{{ view==='rappels' ? 'Rappel' : 'Confirmer' }}</span>
            </a>

            <button
                v-if="view==='confirmations' && !r.dansAgenda"
                @click.stop="handleAddToAgendaClick(r)"
                class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-4 py-2.5 rounded-xl font-bold hover:from-blue-600 hover:to-blue-700 shadow-lg shadow-blue-200 flex items-center gap-2 transition transform active:scale-95"
                title="Ajouter √† l'agenda"
            >
                <i class="fa-solid fa-calendar-plus"></i>
                <span class="hidden md:inline">Agenda</span>
            </button>

            <button
                @click.stop="validateAction(r, view)"
                class="bg-gradient-to-r from-green-500 to-green-600 text-white px-4 py-2.5 rounded-xl font-bold hover:from-green-600 hover:to-green-700 shadow-lg shadow-green-200 transition transform active:scale-95"
            >
                <i class="fa-solid fa-check"></i>
            </button>

            <button
                v-if="view==='confirmations'"
                @click.stop="quickCancel(r)"
                class="bg-white text-red-500 border-2 border-red-300 px-4 py-2.5 rounded-xl font-bold hover:bg-red-50 hover:border-red-400 transition shadow-sm"
            >
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
    </div>
</div>

    <!-- MODALE APER√áU MESSAGE -->
    <div v-if="messagePreviewModal.open" class="fixed inset-0 bg-slate-900/80 z-[500] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden flex flex-col">
            <div class="bg-gradient-to-r from-purple-500 to-purple-600 px-6 py-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <i class="fa-solid fa-eye text-white text-xl"></i>
                    <h3 class="text-white font-bold text-lg">{{ messagePreviewModal.title }}</h3>
                </div>
                <button @click="messagePreviewModal.open=false" class="w-8 h-8 rounded-full hover:bg-white/20 flex items-center justify-center transition text-white">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto flex-1">
                <div class="bg-gradient-to-br from-slate-50 to-purple-50/30 border-2 border-purple-200 rounded-xl p-6">
                    <div class="bg-white p-4 rounded-lg border-2 border-purple-300 shadow-inner">
                        <div class="text-slate-800 whitespace-pre-line font-medium leading-relaxed">{{ messagePreviewModal.message }}</div>
                    </div>
                </div>
            </div>
            <div class="px-6 py-4 bg-slate-50 border-t border-slate-200 flex gap-3">
                <button @click="messagePreviewModal.open=false" class="flex-1 bg-slate-200 text-slate-700 py-3 rounded-xl font-bold hover:bg-slate-300 transition">
                    Fermer
                </button>
            </div>
        </div>
    </div>
    
    <!-- FIX Z-INDEX MODALE CLIENT -->
    <!-- FICHE RENDEZ-VOUS SIMPLIFI√âE -->
    <div v-if="clientModal.open" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[300] flex items-center justify-center p-0 md:p-4 animate-fadeIn">
        <div class="bg-white w-full h-full md:w-full md:max-w-2xl md:h-[90vh] md:rounded-3xl shadow-2xl overflow-hidden flex flex-col relative">
            
            <!-- BANDEAU STATUT -->
            <div v-if="getRdvTimeStatus(clientModal.rdv) === 'en_cours'" class="absolute top-3 left-3 z-20 bg-gradient-to-r from-emerald-500 to-green-600 text-white px-2 py-1 rounded-lg font-bold text-xs flex items-center gap-1">
                <i class="fa-solid fa-circle-dot animate-pulse"></i>
            </div>
            <div v-else-if="getRdvTimeStatus(clientModal.rdv) === 'bientot'" class="absolute top-3 left-3 z-20 bg-gradient-to-r from-amber-500 to-orange-500 text-white px-2 py-1 rounded-lg font-bold text-xs flex items-center gap-1">
                <i class="fa-solid fa-clock"></i>
            </div>
            <!-- HEADER MODERNE -->
            <div class="relative bg-gradient-to-br from-purple-500 via-purple-600 to-purple-700 text-white shadow-2xl">
                <div class="absolute top-3 right-3 flex gap-2 z-20">
                    <button @click="openEdit(clientModal.rdv)" class="w-9 h-9 bg-white/20 hover:bg-white/30 backdrop-blur-md rounded-xl flex items-center justify-center transition-all shadow-lg" title="Modifier">
                        <i class="fa-solid fa-pencil text-xs"></i>
                    </button>
                    <button @click="softDeleteRdv(clientModal.rdv)" class="w-9 h-9 bg-red-500/90 hover:bg-red-600 backdrop-blur-md rounded-xl flex items-center justify-center transition-all shadow-lg" title="Supprimer">
                        <i class="fa-solid fa-trash-can text-xs"></i>
                    </button>
                    <button @click="clientModal.open=false" class="w-9 h-9 bg-white/20 hover:bg-white/30 backdrop-blur-md rounded-xl flex items-center justify-center transition-all shadow-lg">
                        <i class="fa-solid fa-times text-sm"></i>
                    </button>
                </div>

                <div class="relative z-10 p-5 md:p-6">
                    <div class="flex items-center gap-4">
                        <div class="relative flex-shrink-0">
                            <div :class="{'ring-4 ring-emerald-400 animate-pulse shadow-2xl shadow-emerald-300': getRdvTimeStatus(clientModal.rdv)==='en_cours'}" class="w-20 h-20 md:w-24 md:h-24 bg-white/20 backdrop-blur-xl border-4 border-white/50 rounded-2xl flex items-center justify-center text-3xl md:text-4xl font-black shadow-2xl">
                                {{ clientModal.rdv.civilite === 'M.' ? 'M' : 'F' }}
                            </div>
                            <div v-if="clientModal.rdv.rappelFait" class="absolute -top-1 -right-1 w-6 h-6 bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-full flex items-center justify-center border-3 border-white shadow-lg">
                                <i class="fa-solid fa-bell text-white text-[9px]"></i>
                            </div>
                        </div>
                        
                        <div class="flex-1 min-w-0">
                            <h1 class="text-2xl md:text-3xl font-black text-white mb-2 drop-shadow-lg">
                                {{ clientModal.rdv.nom }}
                            </h1>
                            
                            <div class="flex items-center gap-2 mb-3 flex-wrap">
                                <span :class="statusClass(clientModal.rdv.statut)" class="px-3 py-1 rounded-full text-xs font-bold uppercase shadow-md">
                                    {{ displayStatus(clientModal.rdv) }}
                                </span>
                                <span v-if="clientModal.rdv.tag === 'OK M'" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-3 py-1 rounded-full text-xs font-bold shadow-md">
                                    OK M
                                </span>
                                <span v-if="clientModal.rdv.rappelFait" class="bg-gradient-to-r from-emerald-500 to-emerald-600 text-white px-3 py-1 rounded-full text-xs font-bold shadow-md flex items-center gap-1">
                                    <i class="fa-solid fa-bell text-[9px]"></i>
                                    Rappel
                                </span>
                            </div>

                            <div class="flex items-center gap-2 flex-wrap">
                                <a :href="'tel:' + normalizePhone(clientModal.rdv.telephone)" class="bg-white/20 hover:bg-white/30 backdrop-blur-md text-white px-4 py-2 rounded-xl font-bold text-xs transition-all flex items-center gap-2 shadow-lg">
                                    <i class="fa-solid fa-phone"></i>
                                    <span class="font-mono">{{ clientModal.rdv.telephone }}</span>
                                </a>
                                <a :href="generateMsgLink(clientModal.rdv, 'confirm')" target="_blank" class="bg-white/15 hover:bg-white/25 backdrop-blur-md text-white px-3 py-1.5 rounded-xl font-bold text-[10px] transition-all flex items-center gap-1.5 shadow-md" title="Renvoyer la confirmation au client">
                                    <i class="fa-solid fa-message"></i>
                                    <span class="hidden sm:inline">Renvoyer confirmation</span>
                                    <span class="sm:hidden">Renvoyer</span>
                                </a>
                                <button @click="handleSendRappel(clientModal.rdv)" class="bg-white/15 hover:bg-white/25 backdrop-blur-md text-white px-3 py-1.5 rounded-xl font-bold text-[10px] transition-all flex items-center gap-1.5 shadow-md" title="Envoyer un rappel au client">
                                    <i class="fa-solid fa-bell"></i>
                                    <span class="hidden sm:inline">Envoyer rappel</span>
                                    <span class="sm:hidden">Rappel</span>
                                </button>
                                <div v-if="clientModal.rdv?.dansAgenda" class="bg-gradient-to-r from-green-500 to-green-600 text-white px-3 py-1.5 rounded-xl font-bold text-xs flex items-center gap-1.5 shadow-lg">
                                    <i class="fa-solid fa-calendar-check"></i>
                                    <span>Agenda</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CONTENU PRINCIPAL -->
            <div v-if="clientModal.view === 'main'" class="flex-1 overflow-y-auto p-3 md:p-5 bg-gradient-to-br from-slate-50 via-purple-50/20 to-slate-50">
                <!-- INFORMATIONS PRINCIPALES - VERSION SIMPLIFI√âE -->
                <div class="bg-white rounded-xl shadow-md border border-purple-100 p-3 md:p-4 mb-3">
                    <div class="space-y-3">
                        <!-- V√©hicule -->
                        <div>
                            <div class="text-[10px] font-bold text-purple-600 uppercase mb-1 flex items-center gap-1">
                                <i class="fa-solid fa-car text-purple-500"></i>
                                V√©hicule
                            </div>
                            <div v-if="getBaseModele(clientModal.rdv.modele)" class="text-sm font-black text-slate-800 mb-2">{{ getBaseModele(clientModal.rdv.modele) }}</div>
                            <div v-if="formatCaracteristiquesForDisplay(clientModal.rdv.modele).caracteristiques.length > 0" class="text-xs text-slate-700 space-y-1 pt-2 border-t border-purple-100">
                                <div v-for="(carac, idx) in formatCaracteristiquesForDisplay(clientModal.rdv.modele).caracteristiques" :key="idx" class="flex items-start">
                                    <span class="font-bold text-slate-800 w-32 md:w-36 flex-shrink-0 text-right pr-2">{{ carac.label }}</span>
                                    <span class="text-slate-600 flex-shrink-0">:</span>
                                    <span class="text-slate-600 ml-2">{{ carac.value }}</span>
                        </div>
                            </div>
                            <div v-else-if="!getBaseModele(clientModal.rdv.modele)" class="text-sm font-black text-slate-800">{{ clientModal.rdv.modele || 'Non sp√©cifi√©' }}</div>
                            </div>
                        
                        <!-- Informations en ligne compacte -->
                        <div class="grid grid-cols-2 gap-2 pt-2 border-t border-purple-100">
                            <div>
                                <div class="text-[9px] font-bold text-slate-500 uppercase mb-0.5">Source</div>
                                <div class="flex items-center gap-1.5">
                                    <img v-if="clientModal.rdv.source && clientModal.rdv.source.trim() && getLogo(clientModal.rdv.source)" :src="getLogo(clientModal.rdv.source)" class="w-3 h-3 rounded" @error="$event.target.style.display='none'" @load="$event.target.style.display='block'">
                                    <span class="text-xs font-bold text-slate-800">{{ clientModal.rdv.source || 'N/A' }}</span>
                                    <button v-if="clientModal.rdv.rappelSent" @click.stop class="ml-1 text-green-600 hover:text-green-700 transition cursor-default" :title="'Rappel envoy√© le ' + formatDateFr(clientModal.rdv.rappelSent.date) + ' √† ' + clientModal.rdv.rappelSent.heure + ' par ' + (clientModal.rdv.rappelSent.par || 'N/A')">
                                        <i class="fa-solid fa-bell text-xs"></i>
                                    </button>
                        </div>
                            </div>
                            <div>
                                <div class="text-[9px] font-bold text-slate-500 uppercase mb-0.5">Agence</div>
                                <div class="text-xs font-bold text-slate-800">{{ getAgenceName(clientModal.rdv.agenceId) || 'N/A' }}</div>
                        </div>
                            <div class="col-span-2">
                                <div class="text-[9px] font-bold text-slate-500 uppercase mb-0.5">Date & Heure</div>
                                <div class="text-xs font-bold text-slate-800">{{ formatDateFr(clientModal.rdv.date) }} √† {{ clientModal.rdv.heure }}</div>
                            </div>
                        </div>
                            </div>
                    
                    <div class="flex gap-2 mt-3 pt-3 border-t border-purple-100">
                        <button @click="openRescheduleModal(clientModal.rdv)" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg font-bold text-xs transition-all flex items-center justify-center gap-1.5">
                            <i class="fa-solid fa-calendar-days text-[10px]"></i>
                        Reporter
                    </button>
                    </div>
                </div>

                <!-- BOUTON HISTORIQUE -->
                <button @click="clientModal.view='history'" class="w-full bg-gradient-to-br from-white via-purple-50/30 to-white rounded-2xl shadow-lg border-2 border-purple-200/80 p-4 mb-4 hover:shadow-xl hover:scale-[1.01] transition-all flex items-center justify-between group backdrop-blur-sm">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center shadow-md group-hover:shadow-lg transition">
                            <i class="fa-solid fa-clock-rotate-left text-white"></i>
                        </div>
                        <div class="text-left">
                            <div class="text-sm font-bold text-slate-800">Historique & Notes</div>
                            <div class="text-xs text-slate-500 font-medium">
                                {{ ((clientModal.rdv.notes || []).length + (clientModal.rdv.note && clientModal.rdv.note.trim() ? 1 : 0)) }} note{{ ((clientModal.rdv.notes || []).length + (clientModal.rdv.note && clientModal.rdv.note.trim() ? 1 : 0)) > 1 ? 's' : '' }}
                            </div>
                        </div>
                    </div>
                    <i class="fa-solid fa-chevron-right text-purple-400 group-hover:text-purple-600 group-hover:translate-x-1 transition"></i>
                </button>

                <!-- ACTIONS RAPIDES COMPACTES -->
                <div class="bg-gradient-to-br from-white via-purple-50/30 to-white rounded-2xl shadow-lg border-2 border-purple-200/80 p-4 md:p-5 backdrop-blur-sm">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-xl flex items-center justify-center shadow-md">
                            <i class="fa-solid fa-bolt text-white"></i>
                        </div>
                        <h3 class="text-sm font-bold text-slate-800 uppercase">Actions</h3>
                    </div>
                    <div class="flex items-center gap-2 flex-wrap">
                        <button @click="openHonorCheck(clientModal.rdv)" class="bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white px-4 py-2.5 rounded-xl transition-all flex items-center justify-center gap-2 shadow-md shadow-emerald-200 font-bold text-xs">
                            <i class="fa-solid fa-check-circle"></i>
                            <span>Honorer</span>
                        </button>
                        <button @click="updateStatus(clientModal.rdv, 'noshow')" class="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white px-4 py-2.5 rounded-xl transition-all flex items-center justify-center gap-2 shadow-md shadow-red-200 font-bold text-xs">
                            <i class="fa-solid fa-user-xmark"></i>
                            <span>Pas venu</span>
                        </button>
                        <button v-if="['honore','pas_venu','annule'].includes(clientModal.rdv.statut)" @click="updateStatus(clientModal.rdv, 'reset')" class="bg-gradient-to-r from-slate-400 to-slate-500 hover:from-slate-500 hover:to-slate-600 text-white px-4 py-2.5 rounded-xl font-bold text-xs transition-all flex items-center justify-center gap-2 shadow-md">
                            <i class="fa-solid fa-rotate-left"></i>
                            <span>Reset</span>
                        </button>
                        <button @click="openCancelChoice(clientModal.rdv)" class="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white px-4 py-2.5 rounded-xl transition-all flex items-center justify-center gap-2 shadow-md shadow-red-200 font-bold text-xs">
                            <i class="fa-solid fa-ban"></i>
                            <span>Annuler</span>
                        </button>
                    </div>
                    
                    <!-- BOUTONS AGENDA GOOGLE (toujours visibles) -->
                    <div class="mt-4 pt-4 border-t-2 border-purple-200/50">
                        <div class="flex items-center gap-2 mb-3">
                            <i class="fa-brands fa-google text-purple-600"></i>
                            <div class="text-xs font-bold text-slate-700 uppercase">Google Calendar</div>
                        </div>
                        <div class="flex gap-2">
                            <button 
                                v-if="!clientModal.rdv.dansAgenda" 
                                @click="handleAddToAgendaClick(clientModal.rdv)" 
                                class="flex-1 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white py-2.5 rounded-xl font-bold text-xs transition-all flex items-center justify-center gap-2 shadow-lg shadow-green-200">
                                <i class="fa-solid fa-plus"></i>
                                Ajouter √† l'agenda
                            </button>
                            <button 
                                v-else 
                                @click="handleRemoveFromAgendaClick(clientModal.rdv)" 
                                :disabled="clientModal.removingFromAgenda"
                                :class="clientModal.removingFromAgenda ? 'opacity-50 cursor-not-allowed' : 'hover:from-red-600 hover:to-red-700'"
                                class="flex-1 bg-gradient-to-r from-red-500 to-red-600 text-white py-2.5 rounded-xl font-bold text-xs transition-all flex items-center justify-center gap-2 shadow-lg shadow-red-200">
                                <i v-if="clientModal.removingFromAgenda" class="fa-solid fa-spinner fa-spin"></i>
                                <i v-else class="fa-solid fa-minus"></i>
                                {{ clientModal.removingFromAgenda ? 'Suppression...' : 'Retirer de l\'agenda' }}
                            </button>
                        </div>
                    </div>
                    <div v-if="clientModal.rdv.geste_commercial && user.role==='admin'" class="mt-4 bg-gradient-to-r from-red-50 to-red-100 border-2 border-red-300 p-3 rounded-xl text-center shadow-sm">
                        <div class="text-sm font-black text-red-700">
                            -{{ clientModal.rdv.geste_commercial }}‚Ç¨ ({{ clientModal.rdv.motif_geste }})
                        </div>
                        <button @click="removeDiscount" class="mt-2 text-xs text-red-500 hover:text-red-700 font-bold underline">Supprimer</button>
                    </div>
                </div>
            </div>

            <!-- VUE HISTORIQUE -->
            <div v-if="clientModal.view === 'history'" class="flex-1 overflow-y-auto p-5 bg-slate-50 flex flex-col">
                <div class="mb-4 flex items-center gap-3">
                    <button @click="clientModal.view='main'" class="w-8 h-8 bg-white rounded-lg flex items-center justify-center hover:bg-slate-100 transition border border-slate-200">
                        <i class="fa-solid fa-arrow-left text-slate-600 text-xs"></i>
                    </button>
                    <h3 class="text-sm font-bold text-slate-800 flex items-center gap-2">
                        <i class="fa-solid fa-clock-rotate-left text-blue-500"></i>
                        Historique & Notes
                    </h3>
                </div>

                <div class="flex-1 space-y-3 mb-4 overflow-y-auto">
                    <div v-if="clientModal.rdv.note && clientModal.rdv.note.trim()" class="bg-amber-50 border-l-4 border-amber-400 p-3 rounded-lg">
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <i class="fa-solid fa-note-sticky text-amber-600 text-xs"></i>
                                <span class="text-amber-800 font-bold text-xs">{{ clientModal.rdv.createdBy || 'Syst√®me' }}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-[10px] text-slate-500">{{ getCreatedDate(clientModal.rdv.created) }} {{ getCreatedTime(clientModal.rdv.created) }}</span>
                                <button v-if="user.role === 'admin'" @click="editMainNote(clientModal.rdv)" class="text-blue-400 hover:text-blue-600 transition" title="Modifier">
                                    <i class="fa-solid fa-pencil text-xs"></i>
                                </button>
                                <button v-if="user.role === 'admin'" @click="deleteMainNote(clientModal.rdv)" class="text-red-400 hover:text-red-600 transition" title="Supprimer">
                                    <i class="fa-solid fa-trash-can text-xs"></i>
                                </button>
                            </div>
                        </div>
                        <div class="text-sm text-amber-900">{{ clientModal.rdv.note }}</div>
                    </div>
                    <div v-if="(!clientModal.rdv.notes || clientModal.rdv.notes.length === 0) && (!clientModal.rdv.note || !clientModal.rdv.note.trim())" class="text-center text-slate-400 py-8">
                        <i class="fa-solid fa-inbox text-3xl mb-2 block"></i>
                        <p class="text-sm font-medium">Aucun historique</p>
                    </div>
                    <div v-for="(n, idx) in (clientModal.rdv.notes || [])" :key="idx" :class="n.type === 'rappel' ? 'bg-emerald-50 border-l-4 border-emerald-500' : 'bg-blue-50 border-l-4 border-blue-500'" class="p-3 rounded-lg">
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <i v-if="n.type === 'rappel'" class="fa-solid fa-bell text-emerald-600 text-xs"></i>
                                <i v-else class="fa-solid fa-note-sticky text-blue-600 text-xs"></i>
                                <span :class="n.type === 'rappel' ? 'text-emerald-800' : 'text-blue-800'" class="font-bold text-xs">{{ n.author || 'Syst√®me' }}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-[10px] text-slate-500">{{ n.date ? (new Date(n.date).toLocaleDateString('fr-FR', {day:'2-digit', month:'short'}) + ' ' + new Date(n.date).toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'})) : '' }}</span>
                                <button @click="deleteNote(clientModal.rdv, idx)" class="text-red-400 hover:text-red-600 transition" title="Supprimer">
                                    <i class="fa-solid fa-trash-can text-xs"></i>
                                </button>
                            </div>
                        </div>
                        <div :class="n.type === 'rappel' ? 'text-emerald-700' : 'text-slate-700'" class="text-sm font-medium">{{ n.text }}</div>
                    </div>
                </div>

                <div class="flex gap-2 pt-4 border-t border-slate-200">
                    <input v-model="newNoteText" @keyup.enter="addNote" placeholder="Ajouter une note..." class="flex-1 bg-white border border-slate-300 focus:border-blue-500 p-2.5 rounded-lg text-sm outline-none transition-all">
                    <button @click="addNote" class="bg-blue-500 hover:bg-blue-600 text-white w-10 h-10 rounded-lg flex items-center justify-center transition-all">
                        <i class="fa-solid fa-paper-plane text-xs"></i>
                    </button>
                </div>
                <button v-if="clientModal.rdv.rappelFait" @click="resendReminder(clientModal.rdv)" class="mt-2 w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg font-bold text-xs transition-all flex items-center justify-center gap-1.5">
                    <i class="fa-solid fa-bell text-xs"></i>
                    Renvoyer rappel
                </button>
            </div>

            <!-- FOOTER -->
            <div class="bg-slate-50 border-t border-slate-200 p-3 safe-area-bottom">
                <div class="text-[10px] text-slate-500 space-y-0.5 mb-2">
                    <div v-if="clientModal.rdv && getCreatedDate(clientModal.rdv)" class="flex items-center gap-1.5">
                        <i class="fa-solid fa-calendar-plus text-slate-400 text-[9px]"></i>
                        <span>Cr√©√© le {{ formatDateFr(getCreatedDate(clientModal.rdv)) }} √† {{ getCreatedTime(clientModal.rdv) }}</span>
                    </div>
                    <div v-if="clientModal.rdv && clientModal.rdv.createdBy" class="flex items-center gap-1.5">
                        <i class="fa-solid fa-user text-slate-400 text-[9px]"></i>
                        <span>Par {{ clientModal.rdv.createdBy }}</span>
                    </div>
                </div>
                <button @click="updateRdv(clientModal.rdv)" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2.5 rounded-lg font-bold text-sm transition-all flex items-center justify-center gap-2">
                    <i class="fa-solid fa-floppy-disk text-xs"></i>
                    Enregistrer
                </button>
            </div>

        </div>
    </div>

    <!-- MODALE GESTE COMMERCIAL Z-INDEX FIX -->
    <div v-if="discountModal.open" class="fixed inset-0 bg-slate-900/80 z-[350] flex items-center justify-center p-4 ">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-sm pop-in border border-slate-200 relative">
             <div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl shadow-lg">
                <i class="fa-solid fa-gift"></i>
            </div>
            <h3 class="font-bold text-2xl mb-6 text-slate-800 text-center">Geste Commercial</h3>
            
            <div class="space-y-4">
                <div>
                     <label class="text-xs font-bold text-gray-400 uppercase mb-1 block">Montant (‚Ç¨)</label>
                     <input type="number" v-model.number="discountModal.amount" class="w-full p-4 border-2 border-red-100 rounded-xl font-black text-red-600 text-center text-2xl outline-none focus:border-red-400" placeholder="0">
                </div>
                <div>
                     <label class="text-xs font-bold text-gray-400 uppercase mb-1 block">Motif</label>
                     <div class="grid grid-cols-1 gap-2 mb-2">
                         <button v-for="r in ['V√©hicule KO', 'Client pensait voir l\'acheteur', 'Autre']" 
                                 @click="discountModal.reason = r"
                                 :class="discountModal.reason === r ? 'bg-red-500 text-white shadow-md' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'"
                                 class="py-2 px-3 rounded-lg text-xs font-bold transition">
                             {{ r }}
                         </button>
                     </div>
                     <input v-if="discountModal.reason === 'Autre'" v-model="discountModal.customReason" placeholder="Pr√©cisez..." class="w-full p-3 border-2 border-slate-200 rounded-xl text-sm font-bold text-slate-700 outline-none focus:border-red-400">
                </div>
                <!-- Message d'erreur int√©gr√© -->
                <p v-if="discountModal.error" class="text-red-500 text-xs font-bold text-center animate-shake">{{ discountModal.error }}</p>
            </div>

            <div class="flex gap-3 mt-8">
                 <button @click="discountModal.open=false" class="flex-1 bg-gray-100 text-gray-500 py-3 rounded-xl font-bold hover:bg-gray-200">Annuler</button>
                 <button @click="saveDiscount" class="flex-1 bg-red-500 text-white py-3 rounded-xl font-bold hover:bg-red-600 shadow-lg transform active:scale-95">Valider</button>
            </div>
        </div>
    </div>

    <!-- MODAL POURBOIRE MODERNE -->
    <div v-if="tipModal.open" class="fixed inset-0 bg-slate-900/80 z-[400] flex items-center justify-center p-4 ">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden fade-in">
            <div class="bg-gradient-to-r from-purple-600 to-pink-600 p-6 text-white">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-white/20  rounded-xl flex items-center justify-center">
                            <i class="fa-solid fa-hand-holding-dollar text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-xl">Gestion Pourboire</h3>
                            <p class="text-purple-100 text-sm">{{ selectedProspecteur || user.name }}</p>
                        </div>
                    </div>
                    <button @click="tipModal.open=false" class="w-8 h-8 rounded-full hover:bg-white/20 flex items-center justify-center transition">
                        <i class="fa-solid fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6 space-y-6">
                <!-- Type d'op√©ration -->
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase mb-3 block">Type d'op√©ration</label>
                    <div class="grid grid-cols-2 gap-3">
                        <button 
                            @click="tipModal.operation = 'add'"
                            :class="tipModal.operation === 'add' ? 'bg-green-500 text-white shadow-lg' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'"
                            class="p-4 rounded-xl font-bold transition transform active:scale-95 flex items-center justify-center gap-2"
                        >
                            <i class="fa-solid fa-plus-circle"></i>
                            Ajouter
                        </button>
                        <button 
                            @click="tipModal.operation = 'remove'"
                            :class="tipModal.operation === 'remove' ? 'bg-red-500 text-white shadow-lg' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'"
                            class="p-4 rounded-xl font-bold transition transform active:scale-95 flex items-center justify-center gap-2"
                        >
                            <i class="fa-solid fa-minus-circle"></i>
                            Retirer
                        </button>
                    </div>
                </div>

                <!-- Montant -->
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Montant (‚Ç¨)</label>
                    <input 
                        type="number" 
                        v-model.number="tipModal.amount" 
                        placeholder="0.00"
                        step="0.01"
                        min="0"
                        class="w-full p-4 border-2 border-slate-200 rounded-xl font-bold text-slate-800 text-lg outline-none focus:border-purple-500 transition"
                    />
                </div>

                <!-- Motif -->
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Motif</label>
                    <select 
                        v-model="tipModal.reason" 
                        class="w-full p-4 border-2 border-slate-200 rounded-xl font-bold text-slate-800 outline-none focus:border-purple-500 bg-white"
                    >
                        <option value="">S√©lectionner un motif</option>
                        <option value="Client satisfait">Client satisfait</option>
                        <option value="Performance exceptionnelle">Performance exceptionnelle</option>
                        <option value="Bonus mensuel">Bonus mensuel</option>
                        <option value="Remboursement">Remboursement</option>
                        <option value="Ajustement">Ajustement</option>
                        <option value="Autre">Autre</option>
                    </select>
                    <input 
                        v-if="tipModal.reason === 'Autre'"
                        v-model="tipModal.customReason"
                        placeholder="Pr√©cisez le motif..."
                        class="w-full mt-3 p-3 border-2 border-slate-200 rounded-xl font-medium text-slate-700 outline-none focus:border-purple-500"
                    />
                </div>

                <!-- Note -->
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Note (optionnel)</label>
                    <textarea 
                        v-model="tipModal.note"
                        placeholder="Ajoutez une note ou un commentaire..."
                        rows="3"
                        class="w-full p-3 border-2 border-slate-200 rounded-xl font-medium text-slate-700 outline-none focus:border-purple-500 resize-none"
                    ></textarea>
                </div>

                <!-- Message d'erreur -->
                <p v-if="tipModal.error" class="text-red-500 text-sm font-bold text-center animate-shake bg-red-50 p-3 rounded-xl">
                    {{ tipModal.error }}
                </p>
            </div>

            <div class="bg-slate-50 p-6 flex gap-3 border-t border-slate-200">
                <button 
                    @click="tipModal.open=false" 
                    class="flex-1 bg-white text-slate-600 border-2 border-slate-200 py-3 rounded-xl font-bold hover:bg-slate-50 transition"
                >
                    Annuler
                </button>
                <button 
                    @click="saveTipTransaction" 
                    :class="tipModal.operation === 'add' ? 'bg-green-500 hover:bg-green-600' : 'bg-red-500 hover:bg-red-600'"
                    class="flex-1 text-white py-3 rounded-xl font-bold shadow-lg transform active:scale-95 transition"
                >
                    <i :class="tipModal.operation === 'add' ? 'fa-solid fa-plus' : 'fa-solid fa-minus'" class="mr-2"></i>
                    {{ tipModal.operation === 'add' ? 'Ajouter' : 'Retirer' }}
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL CONFIRMATION RAPPEL -->
    <div v-if="rappelConfirmModal.open" class="fixed inset-0 bg-slate-900/90 z-[500] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden fade-in">
            <div class="bg-gradient-to-r from-green-500 to-green-600 p-6 text-white">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                            <i class="fa-solid fa-bell text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-xl">Rappel envoy√©</h3>
                            <p class="text-green-100 text-sm">Le message a-t-il bien √©t√© envoy√© ?</p>
                        </div>
                    </div>
                    <button @click="rappelConfirmModal.open=false" class="w-8 h-8 rounded-full hover:bg-white/20 flex items-center justify-center transition">
                        <i class="fa-solid fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6 space-y-4">
                <div class="bg-blue-50 border-2 border-blue-200 rounded-xl p-4">
                    <p class="text-sm text-blue-800 font-bold text-center">
                        <i class="fa-solid fa-info-circle mr-2"></i>
                        Confirmez que le rappel a bien √©t√© envoy√© au client
                    </p>
                </div>
            </div>

            <div class="bg-slate-50 p-6 flex gap-3 border-t border-slate-200">
                <button 
                    @click="rappelConfirmModal.open=false" 
                    class="flex-1 bg-white text-slate-600 border-2 border-slate-200 py-3 rounded-xl font-bold hover:bg-slate-50 transition"
                >
                    Non
                </button>
                <a 
                    :href="rappelConfirmModal.smsLink" 
                    target="_blank"
                    @click="confirmRappelSent(rappelConfirmModal.rdv)"
                    class="flex-1 bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl font-bold shadow-lg transform active:scale-95 transition text-center flex items-center justify-center gap-2"
                >
                    <i class="fa-solid fa-check"></i>
                    Oui, envoy√©
                </a>
            </div>
        </div>
    </div>

    <!-- MODAL RDV RAPIDE -->
    <div v-if="quickRdvModal.open" class="fixed inset-0 bg-slate-900/90 z-[500] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden fade-in max-h-[90vh] overflow-y-auto">
            <div class="bg-gradient-to-r from-blue-500 to-blue-600 p-6 text-white">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                            <i class="fa-solid fa-plus-circle text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-xl">Ajouter RDV rapide</h3>
                            <p class="text-blue-100 text-sm">Cr√©er un rendez-vous rapidement</p>
                        </div>
                    </div>
                    <button @click="quickRdvModal.open=false" class="w-8 h-8 rounded-full hover:bg-white/20 flex items-center justify-center transition">
                        <i class="fa-solid fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6 space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Nom du client (facultatif)</label>
                    <input v-model="quickRdvModal.nom" type="text" placeholder="Nom du client" class="w-full px-4 py-3 bg-slate-50 border-2 border-slate-200 rounded-xl font-bold text-slate-700 outline-none focus:border-blue-500 focus:bg-white transition">
                </div>
                
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Mod√®le du v√©hicule (facultatif)</label>
                    <input v-model="quickRdvModal.modele" type="text" placeholder="Mod√®le du v√©hicule" class="w-full px-4 py-3 bg-slate-50 border-2 border-slate-200 rounded-xl font-bold text-slate-700 outline-none focus:border-blue-500 focus:bg-white transition">
                </div>
                
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Source *</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button 
                            v-for="src in sourcesList" 
                            @click="quickRdvModal.source = src" 
                            :class="quickRdvModal.source === src ? 'border-blue-500 bg-blue-50 ring-2 ring-blue-200 shadow-md' : 'border-slate-200 bg-white hover:border-blue-300 hover:bg-slate-50'" 
                            class="p-3 rounded-xl border-2 flex flex-col items-center gap-2 transition transform active:scale-95"
                        >
                            <img :src="getLogo(src)" class="w-6 h-6 rounded bg-gray-50 object-contain">
                            <span class="text-xs font-bold text-slate-700">{{ src }}</span>
                        </button>
                    </div>
                </div>
                
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Note (pourquoi ce RDV)</label>
                    <textarea v-model="quickRdvModal.note" placeholder="Note explicative..." rows="3" class="w-full px-4 py-3 bg-slate-50 border-2 border-slate-200 rounded-xl font-bold text-slate-700 outline-none focus:border-blue-500 focus:bg-white transition resize-none"></textarea>
                </div>
                
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Agence *</label>
                    <select v-model="quickRdvModal.agenceId" @change="quickRdvModal.commercialId = ''; if (!quickRdvHasCommerciaux) quickRdvModal.commercialId = ''" class="w-full px-4 py-3 bg-slate-50 border-2 border-slate-200 rounded-xl font-bold text-slate-700 outline-none focus:border-blue-500 focus:bg-white transition appearance-none">
                        <option value="">S√©lectionner une agence</option>
                        <option v-for="ag in visibleAgencies" :key="ag.id" :value="ag.id">{{ ag.nom }}</option>
                    </select>
                </div>
                
                <div v-if="quickRdvModal.agenceId && quickRdvHasCommerciaux">
                    <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Commercial *</label>
                    <select v-model="quickRdvModal.commercialId" class="w-full px-4 py-3 bg-slate-50 border-2 border-slate-200 rounded-xl font-bold text-slate-700 outline-none focus:border-blue-500 focus:bg-white transition appearance-none">
                        <option value="">Je ne sais pas</option>
                        <option v-for="u in quickRdvCommerciaux" :key="u.id" :value="u.id">{{ u.name }}</option>
                    </select>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Date (facultatif)</label>
                        <input v-model="quickRdvModal.date" type="date" class="w-full px-4 py-3 bg-slate-50 border-2 border-slate-200 rounded-xl font-bold text-slate-700 outline-none focus:border-blue-500 focus:bg-white transition">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Heure (facultatif)</label>
                        <input v-model="quickRdvModal.heure" type="time" class="w-full px-4 py-3 bg-slate-50 border-2 border-slate-200 rounded-xl font-bold text-slate-700 outline-none focus:border-blue-500 focus:bg-white transition">
                    </div>
                </div>
                
                <div class="flex items-center gap-3 p-4 bg-green-50 border-2 border-green-200 rounded-xl">
                    <input 
                        type="checkbox" 
                        v-model="quickRdvModal.honore" 
                        id="honore-checkbox"
                        class="w-5 h-5 rounded border-2 border-green-500 text-green-600 focus:ring-green-500 focus:ring-2 cursor-pointer"
                    >
                    <label for="honore-checkbox" class="text-sm font-bold text-green-700 cursor-pointer flex items-center gap-2">
                        <i class="fa-solid fa-check-circle"></i>
                        Rendez-vous honor√© (comptabilis√© dans le CA)
                    </label>
                </div>
            </div>

            <div class="bg-slate-50 p-6 flex gap-3 border-t border-slate-200">
                <button 
                    @click="quickRdvModal.open=false" 
                    class="flex-1 bg-white text-slate-600 border-2 border-slate-200 py-3 rounded-xl font-bold hover:bg-slate-50 transition"
                >
                    Annuler
                </button>
                <button 
                    @click="createQuickRdv" 
                    :disabled="!quickRdvModal.agenceId || !quickRdvModal.source"
                    :class="(!quickRdvModal.agenceId || !quickRdvModal.source) ? 'opacity-50 cursor-not-allowed' : 'hover:bg-blue-600'"
                    class="flex-1 bg-blue-500 text-white py-3 rounded-xl font-bold shadow-lg transform active:scale-95 transition"
                >
                    <i class="fa-solid fa-check mr-2"></i>
                    Valider
                </button>
            </div>
        </div>
    </div>

    <!-- MODALE STATUTS MANQUANTS (NOUVELLE) -->
    <div v-if="pendingStatusModal.open" class="fixed inset-0 bg-slate-900/90 z-[450] flex items-center justify-center p-4 ">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-sm text-center pop-in border-4 border-purple-100">
            <div class="w-16 h-16 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl shadow-lg animate-pulse">
                <i class="fa-solid fa-clipboard-question"></i>
            </div>
            <h3 class="font-bold text-2xl mb-2 text-slate-800">Statuts manquants</h3>
            <p class="text-slate-500 font-medium mb-6">
                Vous avez <strong class="text-purple-600">{{ pendingStatusCount }} rendez-vous</strong> pass√©s dont le statut n'est pas √† jour.
            </p>
            
            <div class="space-y-3">
                <button @click="pendingStatusModal.open=false; changeView('pending_status')" class="w-full bg-purple-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-purple-200 hover:bg-purple-700 transition transform active:scale-95">
                    Voir les statuts
                </button>
                <button @click="pendingStatusModal.open=false" class="w-full bg-white text-slate-400 border-2 border-slate-100 py-3 rounded-xl font-bold hover:bg-slate-50 hover:text-slate-600 transition">
                   Ignorer
                </button>
            </div>
        </div>
    </div>

    <!-- NOUVELLE MODALE ALERTE RAPPELS CONNEXION (LOGIQUE CORRIG√âE) Z-INDEX FIX -->
    <div v-if="reminderAlertModal.open" class="fixed inset-0 bg-slate-900/90 z-[400] flex items-center justify-center p-4 ">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-sm text-center pop-in border-4 border-red-100">
             <div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl shadow-lg animate-pulse">
                <i class="fa-solid fa-bell"></i>
            </div>
            <h3 class="font-bold text-2xl mb-2 text-slate-800">Rappels en attente</h3>
            <p class="text-slate-500 font-medium mb-6">
                Vous avez <strong class="text-red-500" v-if="rappelsVeilleCount>0">{{ rappelsVeilleCount }} pour Demain</strong>
                <span v-if="rappelsVeilleCount>0 && rappelsJourCount>0"> et </span>
                <strong class="text-red-500" v-if="rappelsJourCount>0">{{ rappelsJourCount }} pour Aujourd'hui</strong>.
            </p>
            
            <div class="space-y-3">
                <button @click="reminderAlertModal.open=false; changeView('rappels')" class="w-full bg-red-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-red-200 hover:bg-red-700 transition transform active:scale-95">
                    Voir les rappels
                </button>
                <button @click="reminderAlertModal.open=false" class="w-full bg-white text-slate-400 border-2 border-slate-100 py-3 rounded-xl font-bold hover:bg-slate-50 hover:text-slate-600 transition">
                   Ignorer
                </button>
            </div>
        </div>
    </div>
    
    <!-- MODALE STATS DETAILL√âES Z-INDEX FIX -->
    <div v-if="statsModal.open" class="fixed inset-0 bg-slate-900/80 z-[350] flex items-center justify-center p-4 ">
        <div class="bg-white rounded-3xl shadow-2xl overflow-hidden w-full max-w-4xl max-h-[90vh] flex flex-col pop-in">
             <div class="bg-slate-100 p-6 flex justify-between items-center border-b">
                 <h3 class="font-bold text-xl text-slate-800">üìä Statistiques D√©taill√©es</h3>
                 <div class="flex items-center gap-3">
                     <button @click="exportStatsPdf" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl font-bold flex items-center gap-2 text-sm transition shadow-md">
                         <i class="fa-solid fa-file-pdf"></i> T√©l√©charger PDF
                     </button>
                     <button @click="statsModal.open=false" class="w-8 h-8 rounded-full bg-white hover:bg-red-50 hover:text-red-500 flex items-center justify-center transition">‚úï</button>
                 </div>
             </div>
             
             <!-- FILTRES STATS -->
             <div class="p-6 bg-white border-b border-slate-100 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                 <div>
                    <label class="text-xs font-bold text-gray-400 uppercase mb-1 block">Filtrer par Agence</label>
                    <select v-model="statsFilterAgency" class="w-full p-2 border border-slate-200 rounded-xl font-bold text-slate-700">
                        <option value="">Toutes les agences</option>
                        <option v-for="ag in visibleAgencies" :key="ag.id" :value="ag.id">{{ ag.nom }}</option>
                    </select>
                 </div>
                 <!-- RESTRICTION UTILISATEUR ICI -->
                 <div v-if="user.role === 'admin'">
                    <label class="text-xs font-bold text-gray-400 uppercase mb-1 block">Filtrer par Commercial</label>
                    <select v-model="statsFilterUser" class="w-full p-2 border border-slate-200 rounded-xl font-bold text-slate-700">
                        <option value="">Toute l'√©quipe</option>
                        <option v-for="u in allProspectors" :key="u" :value="u">{{ u }}</option>
                    </select>
                 </div>
                 <div>
                    <label class="text-xs font-bold text-gray-400 uppercase mb-1 block">Mois</label>
                    <select v-model="statsFilterMonth" class="w-full p-2 border border-slate-200 rounded-xl font-bold text-slate-700">
                        <option value="">Mois</option>
                        <option value="01">Janvier</option>
                        <option value="02">F√©vrier</option>
                        <option value="03">Mars</option>
                        <option value="04">Avril</option>
                        <option value="05">Mai</option>
                        <option value="06">Juin</option>
                        <option value="07">Juillet</option>
                        <option value="08">Ao√ªt</option>
                        <option value="09">Septembre</option>
                        <option value="10">Octobre</option>
                        <option value="11">Novembre</option>
                        <option value="12">D√©cembre</option>
                    </select>
                 </div>
                 <div>
                    <label class="text-xs font-bold text-gray-400 uppercase mb-1 block">Ann√©e</label>
                    <select v-model="statsFilterYear" class="w-full p-2 border border-slate-200 rounded-xl font-bold text-slate-700">
                        <option value="">Ann√©e</option>
                        <option v-for="y in dashboardYearOptions" :key="y" :value="y">{{ y }}</option>
                    </select>
                 </div>
                 <div class="flex items-end">
                    <button @click="resetStatsModalDateFilters" v-if="statsFilterMonth || statsFilterYear" class="w-full bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-xl text-xs font-bold border border-slate-300 transition-all shadow-md hover:shadow-lg flex items-center justify-center gap-2" title="R√©initialiser au mois en cours">
                        <i class="fa-solid fa-rotate-left"></i>
                        Effacer
                    </button>
                 </div>
             </div>

             <div class="flex-1 overflow-y-auto p-6 bg-slate-50">
                 
                 <!-- CHIFFRES CLES FILTR√âS -->
                 <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                     <div class="bg-gradient-to-br from-white to-slate-50 p-5 rounded-2xl shadow-md border border-slate-200 text-center hover:shadow-lg transition-shadow">
                         <p class="text-xs font-bold text-slate-500 uppercase mb-2">Total Plac√©</p>
                         <p class="text-3xl font-black text-slate-800">{{ detailedStats.total }}</p>
                         <p class="text-[10px] text-slate-400 mt-1">RDV ce mois</p>
                     </div>
                     <div class="bg-gradient-to-br from-green-50 to-green-100 p-5 rounded-2xl shadow-md border border-green-200 text-center hover:shadow-lg transition-shadow">
                         <p class="text-xs font-bold text-green-600 uppercase mb-2">Honor√©s</p>
                         <p class="text-3xl font-black text-green-700">{{ detailedStats.honored }}</p>
                         <p class="text-[10px] text-green-500 mt-1">RDV honor√©s</p>
                     </div>
                     <div class="bg-gradient-to-br from-red-50 to-red-100 p-5 rounded-2xl shadow-md border border-red-200 text-center hover:shadow-lg transition-shadow">
                         <p class="text-xs font-bold text-red-600 uppercase mb-2">Pas Venu</p>
                         <p class="text-3xl font-black text-red-700">{{ detailedStats.noshow }}</p>
                         <p class="text-[10px] text-red-500 mt-1">No-show</p>
                     </div>
                     <div class="bg-gradient-to-br from-blue-600 to-blue-700 text-white p-5 rounded-2xl shadow-lg shadow-blue-300 text-center flex flex-col justify-center hover:shadow-xl transition-shadow">
                         <p class="text-xs font-bold opacity-90 uppercase mb-2">Taux Transfo.</p>
                         <p class="text-3xl font-black">{{ detailedStats.rate }}%</p>
                         <p class="text-[10px] opacity-75 mt-1">Taux de transformation</p>
                     </div>
                 </div>


                <!-- ONGLETS MODERNIS√âS -->
                <div class="mb-6">
                    <div class="flex gap-3 bg-slate-100 p-1.5 rounded-2xl">
                        <button 
                            @click="statsModal.activeTab = 'overview'"
                            :class="statsModal.activeTab === 'overview' ? 'bg-white text-blue-600 shadow-md font-bold' : 'text-slate-600 hover:text-slate-800'"
                            class="flex-1 px-6 py-3 rounded-xl transition-all duration-200 flex items-center justify-center gap-2">
                            <i class="fa-solid fa-building"></i>
                            <span>Vue d'ensemble</span>
                        </button>
                        <button 
                            @click="statsModal.activeTab = 'performance'"
                            :class="statsModal.activeTab === 'performance' ? 'bg-white text-blue-600 shadow-md font-bold' : 'text-slate-600 hover:text-slate-800'"
                            class="flex-1 px-6 py-3 rounded-xl transition-all duration-200 flex items-center justify-center gap-2">
                            <i class="fa-solid fa-chart-bar"></i>
                            <span>Performances</span>
                        </button>
                    </div>
                </div>

                <!-- ONGLET 1: VUE D'ENSEMBLE -->
                <div v-if="statsModal.activeTab === 'overview'">
                    <!-- STATISTIQUES MANDATS PAR AGENCE -->
                    <div class="bg-white rounded-2xl shadow-md border border-slate-200 p-6 mb-6">
                        <div class="flex items-center gap-3 mb-5">
                            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center shadow-md">
                                <i class="fa-solid fa-building text-white"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-lg text-slate-800">Mandats sign√©s par Agence</h4>
                                <p class="text-xs text-slate-500">Bas√© sur les RDV honor√©s uniquement - {{ statsModalSelectedPeriod }}</p>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <div v-for="stat in mandatsParAgence" :key="stat.agenceId" class="bg-gradient-to-br from-white via-blue-50/20 to-white rounded-xl p-6 border-2 border-blue-200 shadow-lg hover:shadow-xl hover:scale-[1.01] transition-all duration-200">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="font-bold text-slate-800 text-lg flex items-center gap-2">
                                        <i class="fa-solid fa-building text-blue-500"></i>
                                        {{ stat.nom || 'Sans agence' }}
                                    </div>
                                    <div class="px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full shadow-md">
                                        <span class="text-xs font-bold text-white">
                                            {{ stat.total > 0 ? Math.round((stat.mandatsSignes / stat.total) * 100) : 0 }}% de mandats
                                        </span>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <div class="bg-gradient-to-br from-slate-50 to-white rounded-xl p-4 border-2 border-slate-300 shadow-md">
                                        <div class="text-xs font-bold text-slate-600 uppercase mb-2">Total RDV Honor√©s</div>
                                        <div class="text-3xl font-black text-slate-800">{{ stat.total }}</div>
                                        <div class="text-[10px] text-slate-500 mt-1">RDV honor√©s ce mois</div>
                                    </div>
                                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-4 border-2 border-blue-400 shadow-lg">
                                        <div class="text-xs font-bold text-white/90 uppercase mb-2">Mandats sign√©s</div>
                                        <div class="text-3xl font-black text-white">{{ stat.mandatsSignes }}</div>
                                        <div class="text-[10px] text-white/80 mt-1">Avec mandat OK M</div>
                                    </div>
                                </div>
                                <div v-if="stat.total > 0" class="mt-4 w-full bg-slate-200 h-4 rounded-full overflow-hidden shadow-inner">
                                    <div class="h-full bg-gradient-to-r from-blue-500 via-blue-600 to-blue-700 transition-all duration-700 rounded-full shadow-lg" :style="{width: (stat.mandatsSignes / stat.total * 100) + '%'}"></div>
                                </div>
                            </div>
                            <div v-if="mandatsParAgence.length === 0" class="text-center text-slate-400 py-12 bg-slate-50 rounded-xl border-2 border-dashed border-slate-300">
                                <i class="fa-solid fa-inbox text-4xl mb-3 block opacity-50"></i>
                                <p class="text-sm font-medium">Aucune donn√©e pour ce mois</p>
                            </div>
                        </div>
                    </div>

                    <!-- HISTORIQUE DES ACTIONS -->
                    <div v-if="user.role === 'admin' && actionHistory.length > 0" class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6">
                        <h4 class="font-bold text-lg text-slate-800 mb-4 flex items-center gap-2">
                            <i class="fa-solid fa-history text-slate-600"></i>
                            Historique des Actions (100 derni√®res)
                        </h4>
                        <div class="space-y-2 max-h-60 overflow-y-auto">
                            <div v-for="log in actionHistory.slice(0, 20)" :key="log.id" class="bg-slate-50 rounded-lg p-3 border border-slate-200 text-xs">
                                <div class="flex items-center justify-between mb-1">
                                    <span class="font-bold text-slate-700">{{ log.user }}</span>
                                    <span class="text-slate-500">{{ new Date(log.timestamp).toLocaleString('fr-FR') }}</span>
                                </div>
                                <div class="text-slate-600">
                                    <span class="font-bold">{{ log.action }}</span>
                                    <span v-if="log.details.client"> - {{ log.details.client }}</span>
                                    <span v-if="log.details.motif"> ({{ log.details.motif }})</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ONGLET 2: PERFORMANCES -->
                <div v-if="statsModal.activeTab === 'performance'">
                    <!-- STATISTIQUES AVANC√âES D√âTAILL√âES -->
                    <div class="bg-gradient-to-br from-white via-purple-50/30 to-white rounded-3xl shadow-lg border-2 border-purple-100 p-6 mb-6">
                        <div class="flex items-center justify-between mb-5">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl flex items-center justify-center shadow-md">
                                    <i class="fa-solid fa-chart-line text-white text-xl"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-xl text-slate-800">Statistiques Avanc√©es</h4>
                                    <p class="text-xs text-slate-500 font-medium">P√©riode : {{ new Date().toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' }) }}</p>
                                </div>
                            </div>
                            <div class="px-3 py-1 bg-purple-100 rounded-full">
                                <span class="text-xs font-bold text-purple-700">Mois en cours</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="bg-white/80 backdrop-blur-sm rounded-xl p-4 border border-purple-200 shadow-sm hover:shadow-md transition-all hover:scale-105">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="text-xs font-bold text-purple-600 uppercase">Taux Conversion</div>
                                    <i class="fa-solid fa-arrow-trend-up text-purple-400 text-sm"></i>
                                </div>
                                <div class="text-2xl font-black text-purple-700 mb-1">{{ statsModalData.tauxConversion }}%</div>
                                <div class="text-[10px] text-slate-500">RDV honor√©s / Total RDV</div>
                                <div class="text-[9px] text-purple-500 mt-1">Bas√© sur {{ statsModalData.totalRdv }} RDV</div>
                            </div>
                            <div class="bg-white/80 backdrop-blur-sm rounded-xl p-4 border border-red-200 shadow-sm hover:shadow-md transition-all hover:scale-105">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="text-xs font-bold text-red-600 uppercase">Taux Annulation</div>
                                    <i class="fa-solid fa-ban text-red-400 text-sm"></i>
                                </div>
                                <div class="text-2xl font-black text-red-700 mb-1">{{ statsModalData.tauxAnnulation }}%</div>
                                <div class="text-[10px] text-slate-500">RDV annul√©s / Total RDV</div>
                                <div class="text-[9px] text-red-500 mt-1">Sur {{ statsModalData.totalRdv }} RDV total</div>
                            </div>
                            <div class="bg-white/80 backdrop-blur-sm rounded-xl p-4 border border-orange-200 shadow-sm hover:shadow-md transition-all hover:scale-105">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="text-xs font-bold text-orange-600 uppercase">Taux No-Show</div>
                                    <i class="fa-solid fa-user-xmark text-orange-400 text-sm"></i>
                                </div>
                                <div class="text-2xl font-black text-orange-700 mb-1">{{ statsModalData.tauxNoShow }}%</div>
                                <div class="text-[10px] text-slate-500">Client absent / Total RDV</div>
                                <div class="text-[9px] text-orange-500 mt-1">Sur {{ statsModalData.totalRdv }} RDV total</div>
                            </div>
                            <div class="bg-white/80 backdrop-blur-sm rounded-xl p-4 border border-green-200 shadow-sm hover:shadow-md transition-all hover:scale-105">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="text-xs font-bold text-green-600 uppercase">CA Moyen / RDV</div>
                                    <i class="fa-solid fa-euro-sign text-green-400 text-sm"></i>
                                </div>
                                <div class="text-2xl font-black text-green-700 mb-1">{{ statsModalData.caMoyenParRdv }}‚Ç¨</div>
                                <div class="text-[10px] text-slate-500">Par RDV honor√©</div>
                                <div class="text-[9px] text-green-500 mt-1">Sur {{ statsModalData.honored }} RDV honor√©s</div>
                            </div>
                        </div>
                    </div>

                    <!-- CA PAR JOUR DE LA SEMAINE -->
                    <div class="bg-gradient-to-br from-white via-purple-50/30 to-white rounded-2xl shadow-lg border-2 border-purple-200/80 p-4 md:p-6 mb-6 backdrop-blur-sm">
                        <div class="flex flex-col md:flex-row md:items-center justify-between mb-5 gap-3">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl flex items-center justify-center shadow-md shadow-purple-300">
                                    <i class="fa-solid fa-calendar-week text-white"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-base md:text-lg text-slate-800">CA par Jour de la Semaine</h4>
                                    <p class="text-xs text-slate-500">R√©partition du CA selon les jours</p>
                                </div>
                            </div>
                            <select v-model="statsModal.selectedMonth" class="px-4 py-2 border-2 border-purple-300 rounded-xl text-sm font-bold text-slate-700 bg-white hover:border-purple-400 focus:border-purple-500 focus:outline-none transition-colors shadow-md">
                                <option value="current">Ce mois</option>
                                <option value="previous">Mois pr√©c√©dent</option>
                            </select>
                        </div>
                        <!-- VERSION DESKTOP: Grille 7 colonnes -->
                        <div class="hidden md:grid grid-cols-7 gap-3">
                            <div v-for="(ca, jour) in (statsModal.selectedMonth === 'current' ? statsModalData.caParJourSemaine : statsModalData.caParJourSemainePrevious)" :key="jour" class="bg-gradient-to-br from-slate-50 to-white rounded-xl p-4 border-2 border-slate-200 text-center hover:shadow-lg transition-all hover:scale-105" :class="ca > 0 ? 'border-purple-300 bg-purple-50/40 shadow-md' : ''">
                                <div class="text-xs font-bold text-slate-500 uppercase mb-2">{{ ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'][jour] }}</div>
                                <div class="text-xl font-black" :class="ca > 0 ? 'text-purple-600' : 'text-slate-300'">{{ formatPrice(ca) }}</div>
                                <div v-if="ca > 0" class="text-[9px] text-purple-500 mt-1 font-medium">CA g√©n√©r√©</div>
                            </div>
                        </div>
                        <!-- VERSION MOBILE: Liste verticale -->
                        <div class="md:hidden space-y-2">
                            <div v-for="(ca, jour) in (statsModal.selectedMonth === 'current' ? statsModalData.caParJourSemaine : statsModalData.caParJourSemainePrevious)" :key="jour" class="bg-gradient-to-br from-white to-slate-50 rounded-xl p-3 border-2 flex items-center justify-between shadow-sm" :class="ca > 0 ? 'border-purple-300 bg-purple-50/40' : 'border-slate-200'">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 rounded-lg flex items-center justify-center font-bold text-white shadow-md" :class="ca > 0 ? 'bg-gradient-to-br from-purple-500 to-purple-600' : 'bg-slate-300'">
                                        {{ ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'][jour] }}
                                    </div>
                                    <div>
                                        <div class="text-xs font-bold text-slate-500 uppercase">{{ ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'][jour] }}</div>
                                        <div v-if="ca > 0" class="text-[10px] text-purple-500 font-medium">CA g√©n√©r√©</div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-lg font-black" :class="ca > 0 ? 'text-purple-600' : 'text-slate-300'">{{ formatPrice(ca) }}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- STATISTIQUES PAR SOURCE -->
                    <div v-if="Object.keys(statsModalData.statsBySource).length > 0" class="bg-white rounded-2xl shadow-md border border-slate-200 p-6 mb-6">
                        <div class="flex items-center gap-3 mb-5">
                            <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl flex items-center justify-center shadow-md shadow-purple-300">
                                <i class="fa-solid fa-chart-pie text-white"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-lg text-slate-800">Performance par Source</h4>
                                <p class="text-xs text-slate-500">CA g√©n√©r√© par source de prospection</p>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <div v-for="(stat, source) in statsModalData.statsBySource" :key="source" class="bg-gradient-to-r from-purple-50/50 to-white rounded-xl p-4 border border-purple-200 shadow-sm hover:shadow-md transition-all">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="font-bold text-slate-800 flex items-center gap-2">
                                        <i class="fa-solid fa-circle text-purple-400 text-xs"></i>
                                        {{ source || 'Non renseign√©' }}
                                    </div>
                                    <div class="text-lg font-bold text-purple-600">{{ formatPrice(stat.ca) }}</div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <div class="text-xs text-slate-500">
                                        <i class="fa-solid fa-calendar-check text-purple-400 mr-1"></i>
                                        {{ stat.count }} RDV honor√©s
                                    </div>
                                    <div class="text-xs font-bold text-purple-500">
                                        CA moyen: {{ formatPrice(stat.count > 0 ? (stat.ca / stat.count) : 0) }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- STATISTIQUES PAR AGENCE -->
                    <div v-if="Object.keys(statsModalData.statsByAgency).length > 0" class="bg-white rounded-2xl shadow-md border border-slate-200 p-6 mb-6">
                        <div class="flex items-center gap-3 mb-5">
                            <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl flex items-center justify-center shadow-md shadow-purple-300">
                                <i class="fa-solid fa-building text-white"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-lg text-slate-800">Performance par Agence</h4>
                                <p class="text-xs text-slate-500">Bas√© sur les RDV honor√©s avec mandat sign√©</p>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <div v-for="(stat, agence) in statsModalData.statsByAgency" :key="agence" class="bg-gradient-to-r from-purple-50/50 to-white rounded-xl p-4 border border-purple-200 shadow-sm hover:shadow-md transition-all">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="font-bold text-slate-800 flex items-center gap-2">
                                        <i class="fa-solid fa-building text-purple-400"></i>
                                        {{ agence || 'Sans agence' }}
                                    </div>
                                    <div class="text-lg font-bold text-purple-600">{{ formatPrice(stat.ca) }}</div>
                                </div>
                                <div class="text-xs text-slate-500">
                                    <i class="fa-solid fa-calendar-check text-purple-400 mr-1"></i>
                                    {{ stat.count }} RDV honor√©s
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- PERFORMANCE PAR COMMERCIAL -->
                    <div v-if="user.role === 'admin' && Object.keys(statsModalData.perfByCommercial).length > 0" class="bg-white rounded-2xl shadow-md border border-slate-200 p-6 mb-6">
                        <div class="flex items-center gap-3 mb-5">
                            <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl flex items-center justify-center shadow-md shadow-purple-300">
                                <i class="fa-solid fa-users text-white"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-lg text-slate-800">Performance par Commercial</h4>
                                <p class="text-xs text-slate-500">P√©riode : {{ new Date().toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' }) }}</p>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <div v-for="(perf, commercial) in statsModalData.perfByCommercial" :key="commercial" class="bg-gradient-to-r from-purple-50/50 to-white rounded-xl p-4 border border-purple-200 shadow-sm hover:shadow-md transition-all">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="font-bold text-slate-800 flex items-center gap-2">
                                        <i class="fa-solid fa-user text-purple-400"></i>
                                        {{ commercial }}
                                    </div>
                                    <div class="text-lg font-bold text-purple-600">{{ formatPrice(perf.ca) }}</div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <div class="text-xs text-slate-500">
                                        <i class="fa-solid fa-calendar-check text-purple-400 mr-1"></i>
                                        {{ perf.count }} RDV honor√©s
                                    </div>
                                    <div class="text-xs font-bold text-purple-500">
                                        CA moyen: {{ formatPrice(perf.count > 0 ? (perf.ca / perf.count) : 0) }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                
            </div>
        </div>
    </div>
    
    <!-- MODALE EDITION EQUIPE Z-INDEX FIX -->
    <div v-if="teamEditModal.open" class="fixed inset-0 bg-slate-900/80 z-[350] flex items-center justify-center p-4 ">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm pop-in max-h-[90vh] overflow-y-auto">
            <h3 class="font-bold text-lg mb-4">Modifier Membre</h3>
            <div class="space-y-3">
                <input v-model="teamEditModal.name" placeholder="Nom" class="w-full p-3 border rounded-xl outline-none focus:border-blue-500">
                <input v-model="teamEditModal.email" placeholder="Email / Identifiant" class="w-full p-3 border rounded-xl outline-none focus:border-blue-500">
                <input v-model="teamEditModal.password" placeholder="Nouveau mot de passe (optionnel)" class="w-full p-3 border rounded-xl outline-none focus:border-blue-500" autocomplete="new-password">
            </div>
            
            <div class="mt-4 border-t pt-4">
                <h4 class="font-bold text-xs uppercase text-gray-500 mb-2">Agences Attribu√©es</h4>
                <div class="max-h-40 overflow-y-auto space-y-2 border rounded-xl p-2 bg-slate-50">
                    <div v-for="ag in agences" :key="ag.id" class="flex items-center gap-2">
                        <input type="checkbox" :id="'edit-ag-'+ag.id" :value="ag.id" v-model="teamEditModal.assignedAgencies" class="custom-checkbox w-4 h-4">
                        <label :for="'edit-ag-'+ag.id" class="text-sm font-medium text-slate-700 cursor-pointer select-none">{{ ag.nom }}</label>
                    </div>
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button @click="teamEditModal.open=false" class="flex-1 bg-gray-100 text-gray-500 py-2 rounded-xl font-bold">Annuler</button>
                <button @click="saveTeamMemberEdit" class="flex-1 bg-blue-600 text-white py-2 rounded-xl font-bold">Sauvegarder</button>
            </div>
        </div>
    </div>

    <!-- MODALE MODIFICATION MOT DE PASSE -->
    <div v-if="passwordEditModal.open" class="fixed inset-0 bg-slate-900/80 z-[350] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm pop-in">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fa-solid fa-key text-2xl"></i>
                </div>
                <h3 class="font-bold text-xl mb-2 text-slate-800">Modifier le mot de passe</h3>
                <p class="text-slate-600 text-sm">{{ passwordEditModal.member?.name }}</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Nouveau mot de passe</label>
                    <input 
                        v-model="passwordEditModal.password" 
                        type="password" 
                        placeholder="Entrez le nouveau mot de passe" 
                        class="w-full p-4 border-2 border-slate-200 rounded-xl outline-none focus:border-blue-500 transition"
                        @keyup.enter="savePasswordEdit"
                        autocomplete="new-password"
                    >
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button @click="passwordEditModal.open = false; passwordEditModal.password = ''" class="flex-1 bg-gray-100 text-gray-600 py-3 rounded-xl font-bold hover:bg-gray-200 transition">Annuler</button>
                <button @click="savePasswordEdit" :disabled="!passwordEditModal.password || passwordEditModal.password.trim() === ''" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition">Enregistrer</button>
            </div>
        </div>
    </div>
    
    <!-- MODALE CONFIRMATION UNIVERSELLE Z-INDEX FIX -->
    <div v-if="customConfirmModal.open" class="fixed inset-0 bg-slate-900/80 z-[400] flex items-center justify-center p-4 ">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm text-center pop-in border border-slate-200">
             <div class="w-16 h-16 bg-slate-100 text-slate-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                <i class="fa-solid fa-circle-question"></i>
            </div>
            <h3 class="font-bold text-xl mb-2 text-slate-800">{{ customConfirmModal.title }}</h3>
            <p class="text-slate-500 mb-6">{{ customConfirmModal.message }}</p>
            <div class="grid grid-cols-2 gap-4">
                <button @click="customConfirmModal.open=false" class="bg-slate-100 text-slate-600 py-3 rounded-xl font-bold hover:bg-slate-200 transition text-sm">Non</button>
                <button @click="customConfirmModal.onConfirm" class="bg-slate-800 text-white py-3 rounded-xl font-bold hover:bg-slate-900 transition shadow-lg text-sm">Oui</button>
            </div>
        </div>
    </div>

    <!-- MODAL MODIFIER NOTE -->
    <div v-if="editNoteModal.open" class="fixed inset-0 bg-slate-900/80 z-[400] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md pop-in border border-slate-200">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-12 h-12 bg-amber-100 text-amber-600 rounded-xl flex items-center justify-center">
                    <i class="fa-solid fa-pencil text-xl"></i>
                </div>
                <h3 class="font-bold text-xl text-slate-800">Modifier la note</h3>
            </div>
            <textarea v-model="editNoteModal.note" rows="4" class="w-full px-4 py-3 bg-slate-50 border-2 border-slate-200 rounded-xl font-medium text-slate-700 outline-none focus:border-amber-500 focus:bg-white transition resize-none" placeholder="Saisissez votre note..."></textarea>
            <div class="flex gap-3 mt-6">
                <button @click="editNoteModal.open = false; editNoteModal.rdv = null; editNoteModal.note = ''" class="flex-1 bg-slate-100 text-slate-600 py-3 rounded-xl font-bold hover:bg-slate-200 transition text-sm">
                    Annuler
                </button>
                <button @click="saveNoteEdit" class="flex-1 bg-amber-500 text-white py-3 rounded-xl font-bold hover:bg-amber-600 transition shadow-lg text-sm">
                    <i class="fa-solid fa-check mr-2"></i>
                    Enregistrer
                </button>
            </div>
        </div>
    </div>

    <!-- SETTINGS Z-INDEX FIX -->
    <div v-if="settingsModal.open" class="fixed inset-0 bg-slate-900/80 z-[300] flex md:items-center md:justify-center p-0 md:p-4">
        <div class="bg-white w-full h-full md:w-full md:max-w-4xl md:h-[90vh] md:rounded-3xl shadow-2xl overflow-hidden flex flex-col fade-in">
            <!-- Header avec titre et bouton fermer -->
            <div class="bg-gradient-to-r from-slate-800 to-slate-900 p-4 md:p-6 text-white flex items-center justify-between border-b border-slate-700 sticky top-0 z-10">
                <div class="flex items-center gap-3">
                    <button v-if="settingsModal.view === 'page'" @click="settingsModal.view='menu'" class="w-10 h-10 flex items-center justify-center text-white hover:bg-white/20 rounded-full transition active:scale-95">
                        <i class="fa-solid fa-arrow-left text-lg"></i>
                    </button>
                <h2 class="text-lg md:text-2xl font-bold flex items-center gap-2">
                    <i class="fa-solid fa-gear text-lg md:text-xl"></i> 
                    <span class="hidden sm:inline">R√©glages</span>
                    <span class="sm:hidden">Param√®tres</span>
                </h2>
                </div>
                <button @click="settingsModal.open=false; settingsModal.view='menu'" class="w-10 h-10 flex items-center justify-center text-white hover:bg-white/20 rounded-full transition active:scale-95">
                    <i class="fa-solid fa-times text-lg md:text-xl"></i>
                </button>
            </div>
            
            <!-- Menu de s√©lection des onglets -->
            <div v-if="settingsModal.view === 'menu'" class="flex-1 overflow-y-auto p-6 md:p-8 bg-gradient-to-br from-slate-50 to-blue-50">
                <div class="max-w-4xl mx-auto">
                    <h3 class="text-xl font-bold text-slate-800 mb-6 text-center">Choisissez une section</h3>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        <button @click="settingsModal.tab='Tarification'; settingsModal.view='page'" class="bg-white p-6 rounded-2xl border-2 border-slate-200 hover:border-blue-400 hover:shadow-lg transition flex flex-col items-center gap-3 group">
                            <span class="text-4xl">üí∂</span>
                            <span class="font-bold text-slate-700 text-sm">Tarification</span>
                    </button>
                        <button @click="settingsModal.tab='Agences'; settingsModal.view='page'" class="bg-white p-6 rounded-2xl border-2 border-slate-200 hover:border-blue-400 hover:shadow-lg transition flex flex-col items-center gap-3 group">
                            <span class="text-4xl">üè¢</span>
                            <span class="font-bold text-slate-700 text-sm">Agences</span>
                    </button>
                        <button @click="settingsModal.tab='Equipe'; settingsModal.view='page'" class="bg-white p-6 rounded-2xl border-2 border-slate-200 hover:border-blue-400 hover:shadow-lg transition flex flex-col items-center gap-3 group">
                            <span class="text-4xl">üë•</span>
                            <span class="font-bold text-slate-700 text-sm">√âquipe</span>
                    </button>
                        <button @click="settingsModal.tab='Admins'; settingsModal.view='page'" class="bg-white p-6 rounded-2xl border-2 border-slate-200 hover:border-blue-400 hover:shadow-lg transition flex flex-col items-center gap-3 group">
                            <span class="text-4xl">üëë</span>
                            <span class="font-bold text-slate-700 text-sm">Admins</span>
                    </button>
                        <button @click="settingsModal.tab='Messages'; settingsModal.view='page'" class="bg-white p-6 rounded-2xl border-2 border-slate-200 hover:border-blue-400 hover:shadow-lg transition flex flex-col items-center gap-3 group">
                            <span class="text-4xl">üí¨</span>
                            <span class="font-bold text-slate-700 text-sm">SMS</span>
                    </button>
                        <button @click="settingsModal.tab='Sources'; settingsModal.view='page'" class="bg-white p-6 rounded-2xl border-2 border-slate-200 hover:border-blue-400 hover:shadow-lg transition flex flex-col items-center gap-3 group">
                            <span class="text-4xl">üîó</span>
                            <span class="font-bold text-slate-700 text-sm">Sources</span>
                    </button>
                        <button @click="settingsModal.tab='Motifs'; settingsModal.view='page'" class="bg-white p-6 rounded-2xl border-2 border-slate-200 hover:border-blue-400 hover:shadow-lg transition flex flex-col items-center gap-3 group">
                            <span class="text-4xl">üè∑Ô∏è</span>
                            <span class="font-bold text-slate-700 text-sm">Motifs</span>
                    </button>
                        <button @click="settingsModal.tab='Formatage'; settingsModal.view='page'" class="bg-white p-6 rounded-2xl border-2 border-slate-200 hover:border-blue-400 hover:shadow-lg transition flex flex-col items-center gap-3 group">
                            <i class="fa-solid fa-palette text-4xl text-blue-600"></i>
                            <span class="font-bold text-slate-700 text-sm">Formatage</span>
                    </button>
                        <button v-if="user.role==='admin'" @click="settingsModal.tab='GoogleCalendar'; settingsModal.view='page'" class="bg-white p-6 rounded-2xl border-2 border-slate-200 hover:border-blue-400 hover:shadow-lg transition flex flex-col items-center gap-3 group">
                            <i class="fa-brands fa-google text-4xl text-blue-600"></i>
                            <span class="font-bold text-slate-700 text-sm">Google</span>
                    </button>
                        <button v-if="user.role==='admin'" @click="settingsModal.tab='Logs'; settingsModal.view='page'" class="bg-white p-6 rounded-2xl border-2 border-slate-200 hover:border-blue-400 hover:shadow-lg transition flex flex-col items-center gap-3 group">
                            <i class="fa-solid fa-list text-4xl text-blue-600"></i>
                            <span class="font-bold text-slate-700 text-sm">Journaux</span>
                        </button>
                        <button v-if="user.role==='admin'" @click="settingsModal.tab='Fermetures'; settingsModal.view='page'" class="bg-white p-6 rounded-2xl border-2 border-slate-200 hover:border-red-400 hover:shadow-lg transition flex flex-col items-center gap-3 group">
                            <i class="fa-solid fa-calendar-xmark text-4xl text-red-600"></i>
                            <span class="font-bold text-slate-700 text-sm">Fermetures</span>
                    </button>
                        <button v-if="user.role==='admin'" @click="settingsModal.tab='Dashboard'; settingsModal.view='page'" class="bg-white p-6 rounded-2xl border-2 border-slate-200 hover:border-blue-400 hover:shadow-lg transition flex flex-col items-center gap-3 group">
                            <i class="fa-solid fa-chart-line text-4xl text-blue-600"></i>
                            <span class="font-bold text-slate-700 text-sm">Stats</span>
                    </button>
                    </div>
                </div>
            </div>
            
            <!-- Contenu de la page s√©lectionn√©e -->
            <div v-if="settingsModal.view === 'page'" class="flex-1 overflow-y-auto p-4 md:p-6 bg-white pb-24 md:pb-6">
                
                <!-- ONGLET TARIFICATION (GLOBAL) -->
                <div v-if="settingsModal.tab==='Tarification'" class="space-y-4 md:space-y-6">
                    <div class="bg-gradient-to-br from-slate-50 to-blue-50 p-4 md:p-6 rounded-xl md:rounded-2xl border-2 border-slate-200 shadow-sm">
                        <h3 class="font-bold text-base md:text-lg mb-4 text-slate-700 flex items-center gap-2">
                            <i class="fa-solid fa-sack-dollar text-blue-600"></i> 
                            <span class="text-sm md:text-base">Salaire & Bonus</span>
                        </h3>
                        
                        <div class="space-y-4 mb-4">
                            <div>
                                <label class="text-xs font-bold text-slate-600 block mb-2">Salaire de Base par RDV (‚Ç¨)</label>
                                <input type="number" v-model.number="globalCommission.base" class="w-full p-3 border-2 border-slate-300 rounded-lg font-bold text-blue-600 text-base md:text-lg focus:border-blue-500 outline-none">
                            </div>
                        </div>

                        <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                            <h4 class="font-bold text-xs uppercase text-yellow-700 mb-3">Logique Palier R√©current</h4>
                            <div class="space-y-3">
                                <div class="flex flex-col md:flex-row md:flex-wrap md:items-center gap-2 text-sm font-bold text-slate-700">
                                    <span class="text-xs md:text-sm">√Ä partir de</span>
                                    <input type="number" v-model.number="globalCommission.threshold" class="w-full md:w-20 p-2 rounded-lg border-2 border-slate-300 text-center focus:border-blue-500 outline-none">
                                    <span class="text-xs md:text-sm">RDV, ajouter</span>
                                    <input type="number" v-model.number="globalCommission.amount" class="w-full md:w-24 p-2 rounded-lg border-2 border-slate-300 text-center text-green-600 font-bold focus:border-green-500 outline-none">
                                    <span class="text-xs md:text-sm">‚Ç¨ tous les</span>
                                    <input type="number" v-model.number="globalCommission.step" class="w-full md:w-20 p-2 rounded-lg border-2 border-slate-300 text-center focus:border-blue-500 outline-none">
                                    <span class="text-xs md:text-sm">RDV suivants.</span>
                            </div>
                            </div>
                            <p class="text-[10px] text-slate-500 mt-3 leading-relaxed">Exemple: √Ä partir de 21 RDV, tous les 10 RDV = 100‚Ç¨. 21 RDV = +100‚Ç¨, 31 RDV = +200‚Ç¨, 41 RDV = +300‚Ç¨...</p>
                        </div>
                        
                        <button @click="saveGlobalSettings" class="w-full md:w-auto mt-4 bg-slate-800 text-white px-6 py-3 rounded-lg font-bold hover:bg-slate-900 transition shadow-md">
                            Sauvegarder
                        </button>
                    </div>

                </div>

                <div v-if="settingsModal.tab==='Equipe'" class="space-y-4 md:space-y-6">
                    <div class="bg-gradient-to-br from-slate-50 to-blue-50 p-4 md:p-6 rounded-xl md:rounded-2xl border-2 border-slate-200 shadow-sm">
                        <h3 class="font-bold text-base md:text-lg mb-4 text-slate-700 flex items-center gap-2">
                            <i class="fa-solid fa-user-plus text-blue-600"></i>
                            <span>Ajouter un Prospecteur</span>
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3 md:gap-4 mb-4">
                            <input v-model="newMember.name" placeholder="Nom / Pr√©nom" class="p-3 border rounded-xl outline-none focus:border-blue-500 bg-slate-50">
                            <input v-model="newMember.email" placeholder="Identifiant / Email" class="p-3 border rounded-xl outline-none focus:border-blue-500 bg-slate-50">
                            <input v-model="newMember.password" placeholder="Mot de passe" class="p-3 border rounded-xl outline-none focus:border-blue-500 bg-slate-50">
                            <button @click="addTeamMember" :disabled="!newMember.name || !newMember.email || !newMember.password" class="bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 disabled:opacity-50 transition">Ajouter</button>
                        </div>
                        
                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                            <h4 class="font-bold text-xs uppercase text-gray-500 mb-2">Agences Attribu√©es (pour le nouveau membre)</h4>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-2 max-h-32 overflow-y-auto">
                                <div v-for="ag in agences" :key="ag.id" class="flex items-center gap-2">
                                    <input type="checkbox" :id="'new-ag-'+ag.id" :value="ag.id" v-model="newMember.assignedAgencies" class="custom-checkbox w-4 h-4">
                                    <label :for="'new-ag-'+ag.id" class="text-sm font-medium text-slate-700 cursor-pointer select-none">{{ ag.nom }}</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-100 text-slate-500 text-xs uppercase font-bold"><tr><th class="p-4">Nom</th><th class="p-4">Identifiant</th><th class="p-4">Agences</th><th class="p-4 hidden md:table-cell">Statut</th><th class="p-4 text-right">Actions</th></tr></thead>
                            <tbody class="divide-y"><tr v-for="member in teamList" :key="member.id" class="hover:bg-slate-50 transition"><td class="p-4 font-bold flex items-center gap-2">{{ member.name }} <button @click="openTeamEdit(member)" class="text-slate-300 hover:text-blue-500 transition"><i class="fa-solid fa-pencil text-xs"></i></button></td><td class="p-4 text-blue-600 font-medium text-xs md:text-sm">{{ member.email }}</td><td class="p-4 text-xs text-gray-500 font-bold">{{ (member.assignedAgencies || []).length }} acc√®s</td><td class="p-4 hidden md:table-cell"><span v-if="member.blocked" class="bg-red-100 text-red-600 px-3 py-1 rounded-full text-xs font-bold uppercase">Bloqu√©</span><span v-else class="bg-green-100 text-green-600 px-3 py-1 rounded-full text-xs font-bold uppercase">Actif</span></td><td class="p-4 text-right space-x-2"><button @click="openPasswordEdit(member)" class="bg-blue-100 text-blue-600 hover:bg-blue-200 px-3 py-1.5 rounded-lg font-bold text-xs transition"><i class="fa-solid fa-key"></i> Mot de passe</button><button @click="toggleBlockTeamMember(member)" :class="member.blocked ? 'bg-green-100 text-green-600 hover:bg-green-200' : 'bg-orange-100 text-orange-600 hover:bg-orange-200'" class="px-3 py-1.5 rounded-lg font-bold text-xs transition">{{ member.blocked ? 'D√©bloquer' : 'Bloquer' }}</button><button @click="deleteTeamMember(member)" class="bg-red-100 text-red-600 hover:bg-red-200 px-3 py-1.5 rounded-lg font-bold text-xs transition"><i class="fa-solid fa-trash"></i></button></td></tr></tbody>
                        </table>
                    </div>
                </div>

                <div v-if="settingsModal.tab==='Agences'" class="space-y-4 md:space-y-6">
                    <div class="bg-gradient-to-br from-blue-50 to-purple-50 p-4 rounded-xl border-2 border-blue-200 mb-4 shadow-sm">
                        <h3 class="font-bold text-base md:text-lg text-slate-700 flex items-center gap-2 mb-2">
                            <i class="fa-solid fa-building text-blue-600"></i>
                            <span>Gestion des Agences</span>
                        </h3>
                        <p class="text-xs text-slate-600">Ajoutez, modifiez ou supprimez vos agences</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-4">
                        <div @click="openAgencyEdit(null)" class="border-2 border-dashed border-gray-300 rounded-2xl flex flex-col items-center justify-center p-6 text-gray-400 hover:border-blue-500 hover:text-blue-500 hover:bg-blue-50 cursor-pointer transition min-h-[150px]"><i class="fa-solid fa-plus text-4xl mb-2"></i><span class="font-bold">Ajouter Agence</span></div>
                        <div v-for="ag in agences" :key="ag.id" class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 hover:border-blue-400 transition relative group">
                            <div class="flex justify-between items-start mb-2"><h3 class="font-bold text-xl">{{ ag.nom }}</h3><div class="flex gap-2 opacity-100 md:opacity-0 group-hover:opacity-100 transition"><button @click.stop="openAgencyEdit(ag)" class="w-8 h-8 rounded-lg bg-blue-100 text-blue-600 hover:bg-blue-200"><i class="fa-solid fa-pen"></i></button><button @click.stop="deleteAgency(ag.id)" class="w-8 h-8 rounded-lg bg-red-100 text-red-600 hover:bg-red-200"><i class="fa-solid fa-trash"></i></button></div></div>
                            <p class="text-sm text-gray-500 mb-4 h-10 overflow-hidden">{{ ag.adresse }}</p>
                            <div class="flex justify-between items-center mt-auto pt-4 border-t"><span class="font-bold text-lg text-slate-700">{{ formatPrice(ag.prix) }} <span class="text-[10px] text-gray-400 uppercase">{{ ag.tva ? 'TTC' : 'HT' }}</span></span><span :class="ag.statut_activite==='pause'?'bg-red-100 text-red-600':'bg-green-100 text-green-600'" class="px-2 py-1 rounded text-xs font-bold uppercase">{{ ag.statut_activite === 'pause' ? 'Pause' : 'Actif' }}</span></div>
                        </div>
                    </div>
                </div>

                <div v-if="settingsModal.tab==='Admins'" class="space-y-4 md:space-y-6">
                    <div class="bg-gradient-to-br from-slate-50 to-purple-50 p-4 md:p-6 rounded-xl md:rounded-2xl border-2 border-slate-200 shadow-sm">
                        <h3 class="font-bold text-base md:text-lg mb-4 text-slate-700 flex items-center gap-2">
                            <i class="fa-solid fa-crown text-purple-600"></i>
                            <span>Configuration Globale</span>
                        </h3>
                       <div class="mb-6 border p-4 rounded-xl bg-slate-50 flex items-center gap-4">
    <div class="w-16 h-16 bg-white border-2 border-slate-200 rounded-xl flex items-center justify-center overflow-hidden flex-shrink-0 shadow-sm">
        <img v-if="globalSettings.appLogoUrl" :src="globalSettings.appLogoUrl" class="w-full h-full object-cover">
        <i v-else class="fa-solid fa-image text-slate-300 text-2xl"></i>
    </div>
    
    <div class="flex-1">
        <label class="text-xs font-bold text-gray-500 uppercase block mb-1">Lien du Logo (URL)</label>
        <div class="flex gap-2">
            <input v-model="globalSettings.appLogoUrl" placeholder="https://..." class="flex-1 p-2 border rounded-lg font-bold text-slate-700 outline-none focus:border-blue-500 bg-white transition">
            <button @click="saveGlobalSettings" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold text-xs hover:bg-blue-700 transition shadow-md flex items-center gap-2 flex-shrink-0 active:scale-95">
                <i class="fa-solid fa-floppy-disk"></i> Sauvegarder
            </button>
        </div>
        <p class="text-[10px] text-gray-400 mt-1">Collez l'adresse de votre image (clic droit > copier l'adresse de l'image) et validez.</p>
    </div>
</div>
                        <!-- CONFIG NOTIF HEURE -->
                        <div class="mb-6 flex flex-col gap-4 border p-4 rounded-xl bg-slate-50">
                            <!-- RAPPEL JOUR J -->
                            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                                <div>
                                    <label class="text-xs font-bold text-gray-500 uppercase block mb-1">Heure d√©but notifications Rappels (Jour J)</label>
                                    <p class="text-xs text-gray-400">Avant cette heure, pas d'alerte pour les RDV d'aujourd'hui.</p>
                                </div>
                                <input type="time" v-model="globalSettings.reminderStartTime" class="p-2 border rounded-lg font-bold text-slate-700 bg-white shadow-sm w-32">
                            </div>
                            
                            <!-- RAPPEL VEILLE (NOUVEAU) -->
                            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 border-t border-slate-200 pt-4">
                                <div>
                                    <label class="text-xs font-bold text-gray-500 uppercase block mb-1">Heure d√©but notifications Rappels (Veille)</label>
                                    <p class="text-xs text-gray-400">Avant cette heure, pas d'alerte pour les RDV de demain.</p>
                                </div>
                                <input type="time" v-model="globalSettings.reminderEveTime" class="p-2 border rounded-lg font-bold text-slate-700 bg-white shadow-sm w-32">
                            </div>

                            <button @click="saveGlobalSettings" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold text-xs hover:bg-blue-700 transition self-end mt-2">Sauvegarder</button>
                        </div>

                        <!-- CONFIG URL BASE LIEN RDV -->
                        <div class="mb-6 flex flex-col gap-4 border p-4 rounded-xl bg-slate-50">
                            <div class="flex flex-col gap-2">
                                <label class="text-xs font-bold text-gray-500 uppercase block">URL de base pour les liens rendez-vous</label>
                                <p class="text-xs text-gray-400">URL de base pour g√©n√©rer les liens clients (ex: https://votresite.com). Si vide, utilise l'URL actuelle.</p>
                                <input v-model="globalSettings.rdvLinkBaseUrl" placeholder="https://votresite.com" class="p-3 border rounded-lg font-bold text-slate-700 bg-white shadow-sm outline-none focus:border-blue-500">
                            </div>
                            <button @click="saveGlobalSettings" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold text-xs hover:bg-blue-700 transition self-end">Sauvegarder</button>
                        </div>

                        <h3 class="font-bold text-lg mb-4 text-slate-700">G√©rer les Noms d'Administrateurs</h3>
                        <div class="flex gap-2 mb-6">
                            <input v-model="newAdminName" placeholder="Nouveau pr√©nom (ex: Charl√®ne)" class="flex-1 p-3 border rounded-xl outline-none focus:border-blue-500 bg-slate-50">
                            <button @click="addAdminName" class="bg-blue-600 text-white px-6 rounded-xl font-bold hover:bg-blue-700">Ajouter</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <div v-for="name in adminNamesList" :key="name" class="flex items-center justify-between p-3 border rounded-xl bg-white hover:border-blue-300 transition group">
                                <span class="font-bold text-slate-700 ml-2">{{ name }}</span>
                                <button @click="removeAdminName(name)" class="text-gray-300 hover:text-red-500 transition"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div v-if="settingsModal.tab==='Messages'" class="flex flex-col lg:grid lg:grid-cols-3 gap-4 md:gap-6">
                    <div class="lg:col-span-1 border-r lg:pr-6 space-y-4 overflow-y-auto max-h-[200px] lg:max-h-full">
                        <h3 class="font-bold text-gray-500 uppercase text-xs tracking-wider mb-2">1. Choisir l'Agence</h3>
                        <div class="space-y-2"><button v-for="ag in agences" @click="editingMsgAgence = ag" :class="editingMsgAgence?.id === ag.id ? 'bg-blue-600 text-white shadow-md' : 'bg-white hover:bg-slate-100 text-slate-700'" class="w-full text-left px-4 py-3 rounded-xl font-bold transition text-sm flex items-center justify-between"><span>{{ ag.nom }}</span><i v-if="editingMsgAgence?.id === ag.id" class="fa-solid fa-chevron-right"></i></button></div>
                        <h3 class="font-bold text-gray-500 uppercase text-xs tracking-wider mt-6 mb-2">2. Type de Message</h3>
                        <div class="space-y-2"><button v-for="(label, key) in msgLabels" :key="key" @click="editingMsgType = key" :class="editingMsgType === key ? 'bg-slate-800 text-white shadow-md' : 'bg-white border hover:bg-slate-50 text-slate-600'" class="w-full text-left px-4 py-2 rounded-lg font-bold transition text-xs flex justify-between"><span>{{ label }}</span></button></div>
                    </div>
                    <div class="lg:col-span-2 flex flex-col h-full overflow-y-auto">
                        <div v-if="editingMsgAgence" class="flex-1 flex flex-col">
                            <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-lg text-blue-900 leading-tight">√âditer : {{ msgLabels[editingMsgType] }} <span class="text-gray-400 text-sm font-normal block md:inline">({{ editingMsgAgence.nom }})</span></h3><button @click="saveAgency(editingMsgAgence)" class="bg-green-500 hover:bg-green-600 text-white px-4 md:px-6 py-2 rounded-lg font-bold transition shadow-md text-sm">Enregistrer</button></div>
                            <div class="flex flex-wrap gap-2 mb-2 p-3 bg-slate-100 rounded-xl border border-slate-200"><button v-for="tag in ['{{NOM}}','{{DATE_LONG}}','{{HEURE}}','{{AGENCE}}','{{ADRESSE}}','{{PRIX}}','{{PLAN}}']" @click="insertTag(tag)" class="bg-white border border-slate-300 text-slate-600 px-2 py-1 rounded text-[10px] font-bold hover:bg-blue-50 hover:border-blue-300 transition">{{ tag }}</button></div>
                            <textarea :value="editingMsgAgence.templates?.[editingMsgType] || getDefaultTemplate(editingMsgType)" @input="e => { if(!editingMsgAgence.templates) editingMsgAgence.templates={}; editingMsgAgence.templates[editingMsgType] = e.target.value }" class="w-full flex-1 p-4 border-2 border-slate-200 rounded-2xl outline-none focus:border-blue-500 font-medium text-slate-700 leading-relaxed resize-none bg-slate-50 focus:bg-white transition min-h-[200px]"></textarea>
                            
                            <!-- Aper√ßu du message avec variables remplac√©es -->
                            <div v-if="editingMsgType === 'confirm'" class="mt-4 p-4 bg-gradient-to-br from-blue-50 to-purple-50 rounded-xl border-2 border-blue-200">
                                <div class="flex items-center gap-2 mb-2">
                                    <i class="fa-solid fa-eye text-blue-600"></i>
                                    <h4 class="font-bold text-sm text-blue-900">Aper√ßu du message (avec message de f√™te si applicable)</h4>
                                </div>
                                <div class="bg-white p-4 rounded-lg border border-blue-100 text-sm font-medium text-slate-700 whitespace-pre-wrap">{{ getMessagePreview(editingMsgAgence, editingMsgType) }}</div>
                                <p class="text-xs text-blue-600 mt-2 flex items-center gap-1">
                                    <i class="fa-solid fa-info-circle"></i>
                                    <span>Le message de f√™te sera automatiquement ajout√© selon la p√©riode de l'ann√©e</span>
                                </p>
                            </div>
                        </div>
                        <div v-else class="flex-1 flex items-center justify-center text-center text-gray-400 border-2 border-dashed border-gray-200 rounded-2xl p-8">S√©lectionnez une agence.</div>
                    </div>
                </div>

                <div v-if="settingsModal.tab==='Sources'" class="space-y-4 md:space-y-6">
                    <div class="bg-slate-50 p-4 md:p-6 rounded-xl md:rounded-2xl border border-slate-200">
                        <h3 class="font-bold text-base md:text-lg mb-4 text-slate-700">G√©rer les Sources</h3>
                        <div class="flex gap-2 mb-6"><input v-model="newSource" placeholder="Nouvelle source..." class="flex-1 p-3 border rounded-xl outline-none focus:border-blue-500 bg-slate-50"><button @click="addSource" class="bg-blue-600 text-white px-6 rounded-xl font-bold hover:bg-blue-700">Ajouter</button></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div v-for="src in sourcesList" :key="src" class="flex items-center justify-between p-3 border rounded-xl bg-white hover:border-blue-300 transition group"><div class="flex items-center gap-3"><img :src="getLogo(src)" class="w-6 h-6 rounded bg-gray-50 object-contain cursor-pointer hover:opacity-80" @click="changeSourceLogo(src)" title="Changer le logo"><span class="font-bold text-slate-700">{{ src }}</span></div><button @click="removeSource(src)" class="text-gray-300 hover:text-red-500 transition"><i class="fa-solid fa-trash"></i></button></div>
                        </div>
                    </div>
                </div>

                <div v-if="settingsModal.tab==='Motifs'" class="space-y-4 md:space-y-6">
                    <!-- Motifs de Rendez-vous -->
                    <div class="bg-slate-50 p-4 md:p-6 rounded-xl md:rounded-2xl border border-slate-200">
                        <h3 class="font-bold text-base md:text-lg mb-4 text-slate-700 flex items-center gap-2">
                            <i class="fa-solid fa-tag text-blue-600"></i>
                            G√©rer les Motifs de Rendez-vous
                        </h3>
                        <p class="text-xs text-slate-500 mb-4">Ces motifs appara√Ætront dans la liste d√©roulante lors de la cr√©ation d'un rendez-vous. Les utilisateurs peuvent √©galement saisir un motif personnalis√©.</p>
                        <div class="flex gap-2 mb-6">
                            <input v-model="newMotif" placeholder="Nouveau motif (ex: Essai, Achat, R√©vision...)" class="flex-1 p-3 border rounded-xl outline-none focus:border-blue-500 bg-slate-50">
                            <button @click="addMotif" class="bg-blue-600 text-white px-6 rounded-xl font-bold hover:bg-blue-700">Ajouter</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div v-for="motif in motifsList" :key="motif" class="flex items-center justify-between p-3 border rounded-xl bg-white hover:border-blue-300 transition group">
                                <div class="flex items-center gap-3">
                                    <i class="fa-solid fa-tag text-blue-500"></i>
                                    <span class="font-bold text-slate-700">{{ motif }}</span>
                                </div>
                                <button @click="removeMotif(motif)" class="text-gray-300 hover:text-red-500 transition">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Motifs d'Annulation -->
                    <div class="bg-red-50 p-4 md:p-6 rounded-xl md:rounded-2xl border border-red-200">
                        <h3 class="font-bold text-base md:text-lg mb-4 text-slate-700 flex items-center gap-2">
                            <i class="fa-solid fa-ban text-red-600"></i>
                            G√©rer les Motifs d'Annulation
                        </h3>
                        <p class="text-xs text-slate-500 mb-4">Ces motifs appara√Ætront dans la liste d√©roulante lors de l'annulation d'un rendez-vous. Les utilisateurs peuvent √©galement choisir "Autre" pour saisir un motif personnalis√©.</p>
                        <div class="flex gap-2 mb-6">
                            <input v-model="newCancelMotif" placeholder="Nouveau motif d'annulation (ex: Client indisponible...)" class="flex-1 p-3 border rounded-xl outline-none focus:border-red-500 bg-white">
                            <button @click="addCancelMotif" class="bg-red-600 text-white px-6 rounded-xl font-bold hover:bg-red-700">Ajouter</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div v-for="motif in cancelMotifsList" :key="motif" class="flex items-center justify-between p-3 border rounded-xl bg-white hover:border-red-300 transition group">
                                <div class="flex items-center gap-3">
                                    <i class="fa-solid fa-ban text-red-500"></i>
                                    <span class="font-bold text-slate-700">{{ motif }}</span>
                                </div>
                                <button @click="removeCancelMotif(motif)" class="text-gray-300 hover:text-red-500 transition">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Motifs de Report -->
                    <div class="bg-slate-50 p-4 md:p-6 rounded-xl border border-slate-200">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-bold text-base md:text-lg text-slate-700">√âditer : Messages de Report</h3>
                            <button @click="saveRescheduleSMSMessages" class="px-4 py-1.5 bg-green-600 text-white rounded-lg text-xs font-bold hover:bg-green-700 transition flex items-center gap-1.5">
                                <i class="fa-solid fa-save"></i> Enregistrer
                            </button>
                        </div>
                        <p class="text-xs text-slate-500 mb-4">Les messages configur√©s ici s'appliqueront √† toutes les agences.</p>
                        
                        <div class="space-y-4">
                            <!-- S√©lecteur de type de message -->
                            <div class="bg-white p-3 rounded-lg border-2 border-slate-200">
                                <label class="text-xs font-bold text-slate-700 mb-2 block">Type de message :</label>
                                <div class="flex gap-2">
                                    <button @click="editingRescheduleType='interne'" :class="editingRescheduleType === 'interne' ? 'bg-purple-600 text-white' : 'bg-slate-100 text-slate-700'" class="px-4 py-2 rounded-lg text-xs font-bold transition flex-1">
                                        üè¢ Demande Interne (SMS)
                                    </button>
                                    <button @click="editingRescheduleType='client'" :class="editingRescheduleType === 'client' ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-700'" class="px-4 py-2 rounded-lg text-xs font-bold transition flex-1">
                                        üë§ √Ä la demande du client (Agenda)
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Info selon le type -->
                            <div v-if="editingRescheduleType === 'interne'" class="bg-purple-50 p-3 rounded-lg border-2 border-purple-200">
                                <p class="text-xs text-slate-700">
                                    <i class="fa-solid fa-comment-sms text-purple-600 mr-1"></i>
                                    <strong>Messages SMS :</strong> Ces messages seront envoy√©s automatiquement par SMS lors d'un report √† l'initiative de l'agence.
                                </p>
                            </div>
                            <div v-else class="bg-blue-50 p-3 rounded-lg border-2 border-blue-200">
                                <p class="text-xs text-slate-700">
                                    <i class="fa-solid fa-calendar text-blue-600 mr-1"></i>
                                    <strong>Messages Agenda :</strong> Ces messages appara√Ætront dans Google Agenda et la fiche du rendez-vous. Aucun SMS ne sera envoy√©.
                                </p>
                            </div>
                            
                            <!-- Liste des motifs (accord√©on) -->
                            <div v-for="(label, motifType) in rescheduleMotifsList" :key="motifType" class="bg-white rounded-xl border-2 border-slate-200 overflow-hidden transition-all">
                                <!-- Header cliquable -->
                                <button @click="openMotifs[motifType] = !openMotifs[motifType]" class="w-full flex items-center justify-between p-4 hover:bg-slate-50 transition text-left">
                                    <div class="flex items-center gap-3">
                                        <i :class="openMotifs[motifType] ? 'fa-solid fa-chevron-down' : 'fa-solid fa-chevron-right'" class="text-slate-400 transition-transform"></i>
                                        <h4 class="font-bold text-sm text-slate-800">{{ label }}</h4>
                                    </div>
                                    <button @click.stop="removeRescheduleMotif(motifType)" class="text-red-400 hover:text-red-600 transition text-xs px-2 py-1 rounded hover:bg-red-50">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </button>
                                
                                <!-- Contenu d√©pliable -->
                                <div v-show="openMotifs[motifType]" class="px-4 pb-4 border-t border-slate-100 animate-fadeIn">
                                    <!-- Zone d'√©dition -->
                                    <div class="mb-3 mt-3">
                                        <label class="text-xs font-bold text-slate-600 mb-1.5 block">
                                            Message {{ editingRescheduleType === 'interne' ? 'SMS (Demande Interne)' : 'Agenda (√Ä la demande du client)' }} :
                                        </label>
                                        <textarea 
                                            v-if="editingRescheduleType === 'interne'"
                                            :id="'textarea-interne-' + motifType"
                                            v-model="rescheduleSMSMessages[motifType]" 
                                            placeholder="Message SMS pour demande interne..." 
                                            class="w-full p-3 text-sm border-2 border-slate-200 rounded-lg text-slate-700 outline-none focus:border-purple-500 resize-none font-medium" 
                                            rows="4"
                                        ></textarea>
                                        <textarea 
                                            v-else
                                            :id="'textarea-client-' + motifType"
                                            v-model="rescheduleSMSMessagesClient[motifType]" 
                                            placeholder="Message pour Google Agenda (ex: Le rendez-vous a √©t√© report√© en raison des conditions m√©t√©orologiques...)" 
                                            class="w-full p-3 text-sm border-2 border-slate-200 rounded-lg text-slate-700 outline-none focus:border-blue-500 resize-none font-medium" 
                                            rows="4"
                                        ></textarea>
                                    </div>
                                    
                                    <!-- Aper√ßu -->
                                    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 border-2 border-blue-300 rounded-xl p-4">
                                        <div class="flex items-center gap-2 mb-2">
                                            <i class="fa-solid fa-eye text-blue-600"></i>
                                            <span class="text-xs font-bold text-blue-700">Aper√ßu du message :</span>
                                        </div>
                                        <div class="text-sm text-slate-800 bg-white p-3 rounded-lg border border-blue-200 whitespace-pre-line font-medium leading-relaxed min-h-[60px]">
                                            {{ getReschedulePreview(motifType) }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Ajouter un nouveau motif -->
                            <div class="bg-white p-4 rounded-xl border-2 border-slate-200 border-dashed">
                                <h4 class="font-bold text-sm text-slate-700 mb-3">‚ûï Ajouter un nouveau motif</h4>
                                <div class="grid grid-cols-3 gap-2 mb-3">
                                    <input v-model="newRescheduleMotif.label" placeholder="Label" class="p-2 text-xs border-2 border-slate-200 rounded-lg outline-none focus:border-blue-500">
                                    <input v-model="newRescheduleMotif.key" placeholder="Cl√© technique" class="p-2 text-xs border-2 border-slate-200 rounded-lg outline-none focus:border-blue-500">
                                    <button @click="addRescheduleMotif" class="px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-bold hover:bg-blue-700 transition">
                                        <i class="fa-solid fa-plus mr-1"></i> Ajouter
                                    </button>
                                </div>
                                <div class="flex flex-wrap gap-1.5 mb-3">
                                    <button @click="copyToClipboard('{{DATE_LONG}}')" class="px-2.5 py-1.5 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg text-[10px] font-medium transition">üìÖ {{DATE_LONG}}</button>
                                    <button @click="copyToClipboard('{{HEURE}}')" class="px-2.5 py-1.5 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg text-[10px] font-medium transition">üïê {{HEURE}}</button>
                                    <button @click="copyToClipboard('{{MODELE}}')" class="px-2.5 py-1.5 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg text-[10px] font-medium transition">üöó {{MODELE}}</button>
                                    <button @click="copyToClipboard('{{AGENCE}}')" class="px-2.5 py-1.5 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg text-[10px] font-medium transition">üè¢ {{AGENCE}}</button>
                                </div>
                                <textarea v-model="newRescheduleMotif.message" placeholder="Message SMS..." class="w-full p-3 text-sm border-2 border-slate-200 rounded-lg text-slate-700 outline-none focus:border-blue-500 resize-none" rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Motifs de Report - Demande Interne -->
                    <div class="bg-purple-50 p-4 md:p-6 rounded-xl border border-purple-200 mt-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-bold text-base md:text-lg text-slate-700">√âditer : Motifs de Report - Demande Interne</h3>
                            <button @click="saveRescheduleSMSMessages" class="px-4 py-1.5 bg-green-600 text-white rounded-lg text-xs font-bold hover:bg-green-700 transition flex items-center gap-1.5">
                                <i class="fa-solid fa-save"></i> Enregistrer
                            </button>
                        </div>
                        <p class="text-xs text-slate-500 mb-4">Les motifs configur√©s ici seront utilis√©s uniquement pour les reports √† la demande interne (SMS envoy√© par l'agence).</p>
                        
                        <div class="space-y-4">
                            <!-- Liste des motifs internes (accord√©on) -->
                            <div v-for="(label, motifType) in rescheduleMotifsListInterne" :key="motifType" class="bg-white rounded-xl border-2 border-purple-200 overflow-hidden transition-all">
                                <!-- Header cliquable -->
                                <button @click="openMotifs['interne_' + motifType] = !openMotifs['interne_' + motifType]" class="w-full flex items-center justify-between p-4 hover:bg-purple-50 transition text-left">
                                    <div class="flex items-center gap-3">
                                        <i :class="openMotifs['interne_' + motifType] ? 'fa-solid fa-chevron-down' : 'fa-solid fa-chevron-right'" class="text-purple-400 transition-transform"></i>
                                        <h4 class="font-bold text-sm text-slate-800">{{ label }}</h4>
                                    </div>
                                    <button @click.stop="removeRescheduleMotifInterne(motifType)" class="text-red-400 hover:text-red-600 transition text-xs px-2 py-1 rounded hover:bg-red-50">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </button>
                                
                                <!-- Contenu d√©pliable -->
                                <div v-show="openMotifs['interne_' + motifType]" class="px-4 pb-4 border-t border-purple-100 animate-fadeIn">
                                    <!-- Zone d'√©dition -->
                                    <div class="mb-3 mt-3">
                                        <label class="text-xs font-bold text-slate-600 mb-1.5 block">
                                            Message SMS (Demande Interne) :
                                        </label>
                                        <textarea 
                                            :id="'textarea-interne-motif-' + motifType"
                                            v-model="rescheduleSMSMessages[motifType]" 
                                            placeholder="Message SMS pour demande interne..." 
                                            class="w-full p-3 text-sm border-2 border-purple-200 rounded-lg text-slate-700 outline-none focus:border-purple-500 resize-none font-medium" 
                                            rows="4"
                                        ></textarea>
                                    </div>
                                    
                                    <!-- Aper√ßu -->
                                    <div class="bg-gradient-to-br from-purple-50 to-indigo-50 border-2 border-purple-300 rounded-xl p-4">
                                        <div class="flex items-center gap-2 mb-2">
                                            <i class="fa-solid fa-eye text-purple-600"></i>
                                            <span class="text-xs font-bold text-purple-700">Aper√ßu du message :</span>
                                        </div>
                                        <div class="text-sm text-slate-800 bg-white p-3 rounded-lg border border-purple-200 whitespace-pre-line font-medium leading-relaxed min-h-[60px]">
                                            {{ getReschedulePreview(motifType) }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Ajouter un nouveau motif interne -->
                            <div class="bg-white p-4 rounded-xl border-2 border-purple-200 border-dashed">
                                <h4 class="font-bold text-sm text-slate-700 mb-3">‚ûï Ajouter un nouveau motif interne</h4>
                                <div class="grid grid-cols-3 gap-2 mb-3">
                                    <input v-model="newRescheduleMotifInterne.label" placeholder="Label" class="p-2 text-xs border-2 border-purple-200 rounded-lg outline-none focus:border-purple-500">
                                    <input v-model="newRescheduleMotifInterne.key" placeholder="Cl√© technique" class="p-2 text-xs border-2 border-purple-200 rounded-lg outline-none focus:border-purple-500">
                                    <button @click="addRescheduleMotifInterne" class="px-3 py-2 bg-purple-600 text-white rounded-lg text-xs font-bold hover:bg-purple-700 transition">
                                        <i class="fa-solid fa-plus mr-1"></i> Ajouter
                                    </button>
                                </div>
                                <div class="flex flex-wrap gap-1.5 mb-3">
                                    <button @click="copyToClipboard('{{DATE_LONG}}')" class="px-2.5 py-1.5 bg-purple-100 hover:bg-purple-200 text-purple-700 rounded-lg text-[10px] font-medium transition">üìÖ {{DATE_LONG}}</button>
                                    <button @click="copyToClipboard('{{HEURE}}')" class="px-2.5 py-1.5 bg-purple-100 hover:bg-purple-200 text-purple-700 rounded-lg text-[10px] font-medium transition">üïê {{HEURE}}</button>
                                    <button @click="copyToClipboard('{{MODELE}}')" class="px-2.5 py-1.5 bg-purple-100 hover:bg-purple-200 text-purple-700 rounded-lg text-[10px] font-medium transition">üöó {{MODELE}}</button>
                                    <button @click="copyToClipboard('{{AGENCE}}')" class="px-2.5 py-1.5 bg-purple-100 hover:bg-purple-200 text-purple-700 rounded-lg text-[10px] font-medium transition">üè¢ {{AGENCE}}</button>
                                </div>
                                <textarea v-model="newRescheduleMotifInterne.message" placeholder="Message SMS..." class="w-full p-3 text-sm border-2 border-purple-200 rounded-lg text-slate-700 outline-none focus:border-purple-500 resize-none" rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="settingsModal.tab==='Formatage'" class="space-y-4 md:space-y-6">
                    <div class="bg-slate-50 p-4 md:p-6 rounded-xl md:rounded-2xl border border-slate-200">
                        <h3 class="font-bold text-base md:text-lg mb-4 text-slate-700 flex items-center gap-2">
                            <i class="fa-solid fa-palette text-blue-600"></i>
                            Formatage des Caract√©ristiques Facebook
                        </h3>
                        <p class="text-xs text-slate-500 mb-4">Configurez comment les caract√©ristiques Facebook sont format√©es et traduites dans l'agenda Google.</p>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="text-xs font-bold text-slate-600 uppercase mb-2 block">Traduction automatique</label>
                                <div class="flex items-center gap-3">
                                    <input type="checkbox" v-model="formatageSettings.autoTranslate" class="w-5 h-5 text-blue-600 border-slate-300 rounded focus:ring-blue-500">
                                    <span class="text-sm text-slate-700">Traduire automatiquement les termes anglais (Black ‚Üí Noir, Manual ‚Üí Manuelle, etc.)</span>
                                </div>
                            </div>
                            
                            <div>
                                <label class="text-xs font-bold text-slate-600 uppercase mb-2 block">Format dans Google Agenda</label>
                                <div class="space-y-2">
                                    <div class="flex items-center gap-3">
                                        <input type="checkbox" v-model="formatageSettings.boldLabels" class="w-5 h-5 text-blue-600 border-slate-300 rounded focus:ring-blue-500">
                                        <span class="text-sm text-slate-700">Mettre les labels en gras</span>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <input type="checkbox" v-model="formatageSettings.alignValues" class="w-5 h-5 text-blue-600 border-slate-300 rounded focus:ring-blue-500">
                                        <span class="text-sm text-slate-700">Aligner les valeurs</span>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <input type="checkbox" v-model="formatageSettings.spaceBetween" class="w-5 h-5 text-blue-600 border-slate-300 rounded focus:ring-blue-500">
                                        <span class="text-sm text-slate-700">Espacer les √©l√©ments (saut de ligne entre chaque)</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white p-4 rounded-lg border border-blue-200">
                                <label class="text-xs font-bold text-slate-600 uppercase mb-2 block">Aper√ßu</label>
                                <div class="text-xs text-slate-600 whitespace-pre-line" v-html="getFormatagePreview()"></div>
                            </div>
                            
                            <button @click="saveFormatageSettings" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 shadow-lg">Sauvegarder les param√®tres</button>
                        </div>
                    </div>
                </div>

                <!-- ONGLET FERMETURES -->
                <div v-if="settingsModal.tab==='Fermetures' && user.role==='admin'" class="space-y-4 md:space-y-6">
                    <div class="bg-slate-50 p-4 md:p-6 rounded-xl md:rounded-2xl border border-slate-200">
                        <h3 class="font-bold text-base md:text-lg mb-4 text-slate-700 flex items-center gap-2">
                            <i class="fa-solid fa-calendar-xmark text-red-600"></i>
                            Gestion des Fermetures d'Entreprise
                        </h3>
                        <p class="text-xs text-slate-500 mb-4">Planifiez les fermetures qui seront automatiquement ajout√©es dans les agendas Google Calendar des professionnels.</p>
                        
                        <button @click="fermetureModal.open=true" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 shadow-lg mb-4 flex items-center justify-center gap-2">
                            <i class="fa-solid fa-plus"></i>
                            Ajouter une fermeture
                        </button>
                        
                        <div class="space-y-3">
                            <div v-if="fermeturesList && fermeturesList.length > 0">
                                <div v-for="(ferm, idx) in fermeturesList" :key="idx" class="bg-white p-4 rounded-xl border-2 border-slate-200 mb-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <div>
                                            <div class="font-bold text-slate-800">{{ formatDateFr(ferm.dateDebut) }} - {{ formatDateFr(ferm.dateFin) }}</div>
                                            <div v-if="ferm.motif" class="text-sm text-slate-600 mt-1">{{ ferm.motif }}</div>
                                        </div>
                                        <div class="flex gap-2">
                                            <button @click="editFermeture(ferm)" class="w-8 h-8 bg-blue-100 hover:bg-blue-200 text-blue-600 rounded-lg flex items-center justify-center transition">
                                                <i class="fa-solid fa-pencil text-xs"></i>
                                            </button>
                                            <button @click="deleteFermeture(ferm.id)" class="w-8 h-8 bg-red-100 hover:bg-red-200 text-red-600 rounded-lg flex items-center justify-center transition">
                                                <i class="fa-solid fa-trash text-xs"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="text-xs text-slate-500">
                                        <span v-if="ferm.tousProfessionnels">Tous les professionnels</span>
                                        <span v-else>{{ ferm.professionnels ? ferm.professionnels.length : 0 }} professionnel(s)</span>
                                    </div>
                                </div>
                            </div>
                            <div v-else class="text-center text-slate-500 text-sm py-4">Aucune fermeture planifi√©e</div>
                        </div>
                    </div>
                </div>

                <!-- ONGLET GOOGLE CALENDAR (ADMIN UNIQUEMENT) -->
                <div v-if="settingsModal.tab==='GoogleCalendar' && user.role==='admin'" class="space-y-4 md:space-y-6">
                    <div class="bg-gradient-to-br from-purple-50 to-blue-50 rounded-2xl p-6 md:p-8 border-2 border-purple-200">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center gap-4">
                                <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center shadow-lg">
                                    <i class="fa-brands fa-google text-4xl text-purple-600"></i>
                                </div>
                                <div>
                                    <h3 class="text-xl font-bold text-slate-800">Connexion Google Calendar</h3>
                                    <p class="text-sm text-slate-600">Connectez-vous pour synchroniser automatiquement les rendez-vous</p>
                                </div>
                            </div>
                        </div>

                        <!-- Param√®tre de connexion obligatoire (toujours affich√©) -->
                        <div class="bg-white rounded-xl p-6 border-2 border-blue-200 mb-4">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <h4 class="font-bold text-slate-800 mb-1 flex items-center gap-2">
                                        <i class="fa-solid fa-lock text-blue-500"></i>
                                        Connexion obligatoire pour cr√©er un rendez-vous
                                    </h4>
                                    <p class="text-sm text-slate-600">
                                        Si activ√©, les utilisateurs devront se connecter √† Google Calendar avant de pouvoir cr√©er un rendez-vous.
                                    </p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer ml-4">
                                    <input type="checkbox" v-model="googleCalendarRequired" @change="saveGoogleCalendarRequired" class="sr-only peer">
                                    <div class="w-14 h-7 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                        </div>

                        <!-- V√©rification en cours -->
                        <div v-if="googleCalendarConnected && checkingToken" class="bg-white rounded-xl p-6 border-2 border-blue-300">
                            <div class="flex items-center justify-center gap-3 py-4">
                                <i class="fa-solid fa-spinner fa-spin text-blue-500 text-xl"></i>
                                <p class="text-sm text-slate-600 font-medium">V√©rification du token en cours...</p>
                            </div>
                        </div>

                        <!-- √âtat connect√© avec token valide -->
                        <div v-else-if="googleCalendarConnected && googleCalendarTokenValid" class="bg-white rounded-xl p-6 border-2 border-green-300">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center shadow-lg flex-shrink-0">
                                        <i class="fa-solid fa-check text-xl text-white"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-slate-800 text-base flex items-center gap-2">
                                            Connect√© √† Google Calendar
                                            <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full font-bold">Token valide</span>
                                        </h4>
                                        <p class="text-sm text-slate-600">{{ googleCalendarUserEmail }}</p>
                                    </div>
                                </div>
                                <button @click="disconnectGoogleCalendar" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-xl font-bold transition shadow-lg flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-sign-out-alt"></i>
                                    <span>Se d√©connecter</span>
                                </button>
                            </div>
                            <div class="bg-green-50 rounded-lg p-4 border border-green-200 mt-4">
                                <p class="text-sm text-green-700 font-medium mb-2">
                                    <i class="fa-solid fa-check-circle mr-2"></i>
                                    Les rendez-vous sont automatiquement ajout√©s √† Google Calendar lors de leur validation.
                                </p>
                                <p v-if="tokenTimeRemaining" class="text-xs text-green-600 font-bold flex items-center gap-2">
                                    <i class="fa-solid fa-clock"></i>
                                    Token valide encore : {{ tokenTimeRemaining.minutes }}min {{ tokenTimeRemaining.seconds }}s
                                </p>
                            </div>
                        </div>

                        <!-- √âtat connect√© mais token invalide/expir√© -->
                        <div v-else-if="googleCalendarConnected && !googleCalendarTokenValid" class="bg-white rounded-xl p-6 border-2 border-orange-300">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 bg-orange-500 rounded-full flex items-center justify-center shadow-lg flex-shrink-0">
                                        <i class="fa-solid fa-exclamation-triangle text-xl text-white"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-slate-800 text-base flex items-center gap-2">
                                            Connect√© mais token invalide
                                            <span class="text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded-full font-bold animate-pulse">Expir√©</span>
                                        </h4>
                                        <p class="text-sm text-slate-600">{{ googleCalendarUserEmail }}</p>
                                    </div>
                                </div>
                                <button @click="disconnectGoogleCalendar" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-xl font-bold transition shadow-lg flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-sign-out-alt"></i>
                                    <span>Se d√©connecter</span>
                                </button>
                            </div>
                            <div class="bg-orange-50 rounded-lg p-4 border border-orange-200 mb-4">
                                <p class="text-sm text-orange-800 font-bold mb-2 flex items-center gap-2">
                                    <i class="fa-solid fa-exclamation-triangle"></i>
                                    Attention : Votre session a expir√©
                                </p>
                                <p class="text-sm text-orange-700">
                                    Le token d'authentification n'est plus valide. Vous devez vous reconnecter pour que les rendez-vous soient ajout√©s √† l'agenda.
                                </p>
                            </div>
                            <button @click="connectGoogleCalendar" class="w-full bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-xl font-bold transition shadow-lg flex items-center justify-center gap-2">
                                <i class="fa-brands fa-google"></i>
                                <span>Se reconnecter √† Google Calendar</span>
                            </button>
                            <p v-if="tokenTimeRemaining" class="text-xs text-orange-600 font-bold text-center mt-2 flex items-center justify-center gap-2">
                                <i class="fa-solid fa-clock"></i>
                                Expiration dans : {{ tokenTimeRemaining.minutes }}min {{ tokenTimeRemaining.seconds }}s
                            </p>
                        </div>
                        
                        <!-- √âtat non connect√© -->
                        <div v-else-if="!googleCalendarConnected" class="bg-white rounded-xl p-6 border border-slate-200">
                            <div class="text-center py-4">
                                <div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i class="fa-brands fa-google text-3xl text-slate-400"></i>
                                </div>
                                <h4 class="text-lg font-bold text-slate-800 mb-2">Non connect√©</h4>
                                <p class="text-sm text-slate-600 mb-6">Connectez-vous pour synchroniser automatiquement les rendez-vous avec Google Calendar</p>
                                <button @click="connectGoogleCalendar" class="bg-blue-500 hover:bg-blue-600 text-white px-8 py-3 rounded-xl font-bold transition shadow-lg flex items-center justify-center gap-2 mx-auto">
                                    <i class="fa-brands fa-google"></i>
                                    <span>Se connecter</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- SECTION LOGS D√âTAILL√âS -->
                <div v-if="settingsModal.tab==='Logs' && user.role==='admin'" class="space-y-4 md:space-y-6">
                    <div class="bg-gradient-to-br from-slate-50 to-blue-50 rounded-2xl p-6 md:p-8 border-2 border-slate-200">
                        <h3 class="font-bold text-xl mb-4 text-slate-800 flex items-center gap-2">
                            <i class="fa-solid fa-list text-blue-600"></i>
                            Journaux d√©taill√©s des actions
                        </h3>
                        <p class="text-sm text-slate-600 mb-6">Historique complet de toutes les actions effectu√©es dans l'application (connexions, d√©connexions, cr√©ations, modifications, etc.)</p>
                        
                        <div class="bg-white rounded-xl p-4 border border-slate-200 max-h-[60vh] overflow-y-auto">
                            <div v-if="detailedLogs.length === 0" class="text-center py-8 text-slate-400">
                                <i class="fa-solid fa-inbox text-4xl mb-2 block opacity-50"></i>
                                <p>Aucun journal disponible</p>
                            </div>
                            <div v-else class="space-y-2">
                                <div v-for="log in detailedLogs" :key="log.id" class="bg-slate-50 rounded-lg p-3 border border-slate-200 text-xs hover:bg-slate-100 transition">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="font-bold text-slate-700">{{ log.user || log.details?.utilisateur || 'Syst√®me' }}</span>
                                        <span class="text-slate-500">{{ new Date(log.timestamp).toLocaleString('fr-FR', {day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit'}) }}</span>
                                    </div>
                                    <div class="text-slate-600">
                                        <span class="font-bold">{{ log.action }}</span>
                                        <span v-if="log.details?.client"> - {{ log.details.client }}</span>
                                        <span v-if="log.details?.motif"> ({{ log.details.motif }})</span>
                                        <span v-if="log.details?.heure"> - {{ log.details.heure }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <button @click="loadDetailedLogs" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-xl font-bold transition">
                            <i class="fa-solid fa-sync-alt mr-2"></i>
                            Actualiser les journaux
                        </button>
                    </div>
                </div>
                
                <!-- SECTION TABLEAU DE BORD -->
                <div v-if="settingsModal.tab==='Dashboard' && user.role==='admin'" class="space-y-4 md:space-y-6">
                    <div class="bg-gradient-to-br from-purple-50 to-blue-50 rounded-2xl p-6 md:p-8 border-2 border-purple-200">
                        <h3 class="font-bold text-xl mb-4 text-slate-800 flex items-center gap-2">
                            <i class="fa-solid fa-chart-line text-purple-600"></i>
                            Tableau de bord de performance
                        </h3>
                        <p class="text-sm text-slate-600 mb-6">Statistiques d√©taill√©es sur les 30 derniers jours</p>
                        
                        <!-- Statistiques principales -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                            <div class="bg-white rounded-xl p-4 border border-blue-200 shadow-sm">
                                <div class="text-xs text-slate-500 uppercase font-bold mb-1">Taux de confirmation</div>
                                <div class="text-2xl font-black text-blue-600 mb-1">{{ performanceStats.tauxConfirmation }}%</div>
                                <div class="text-xs text-slate-400">{{ performanceStats.totalConfirmes || 0 }} RDV confirm√©s</div>
                            </div>
                            <div class="bg-white rounded-xl p-4 border border-red-200 shadow-sm">
                                <div class="text-xs text-slate-500 uppercase font-bold mb-1">Taux d'annulation</div>
                                <div class="text-2xl font-black text-red-600 mb-1">{{ performanceStats.tauxAnnulation }}%</div>
                                <div class="text-xs text-slate-400">{{ performanceStats.totalAnnules || 0 }} RDV annul√©s</div>
                            </div>
                            <div class="bg-white rounded-xl p-4 border border-green-200 shadow-sm">
                                <div class="text-xs text-slate-500 uppercase font-bold mb-1">Taux d'honorisation</div>
                                <div class="text-2xl font-black text-green-600 mb-1">{{ performanceStats.tauxHonorisation }}%</div>
                                <div class="text-xs text-slate-400">{{ performanceStats.totalHonores || 0 }} RDV honor√©s</div>
                            </div>
                            <div class="bg-white rounded-xl p-4 border border-orange-200 shadow-sm">
                                <div class="text-xs text-slate-500 uppercase font-bold mb-1">Taux de pr√©sence</div>
                                <div class="text-2xl font-black text-orange-600 mb-1">{{ performanceStats.tauxPresence }}%</div>
                                <div class="text-xs text-slate-400">{{ performanceStats.totalPresents || 0 }} pr√©sents</div>
                            </div>
                        </div>
                        
                        <!-- Statistiques d√©taill√©es -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div class="bg-white rounded-xl p-4 border border-slate-200">
                                <h4 class="font-bold text-sm mb-3 text-slate-800 flex items-center gap-2">
                                    <i class="fa-solid fa-calendar-check text-blue-600"></i>
                                    R√©partition des statuts
                                </h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-slate-600">Total RDV (30j)</span>
                                        <span class="font-bold text-slate-800">{{ performanceStats.totalRdvs || 0 }}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-slate-600">En attente</span>
                                        <span class="font-bold text-orange-600">{{ performanceStats.totalEnAttente || 0 }}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-slate-600">Pas venus</span>
                                        <span class="font-bold text-red-600">{{ performanceStats.totalPasVenus || 0 }}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-xl p-4 border border-slate-200">
                                <h4 class="font-bold text-sm mb-3 text-slate-800 flex items-center gap-2">
                                    <i class="fa-solid fa-clock text-purple-600"></i>
                                    Activit√© r√©cente
                                </h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-slate-600">RDV cr√©√©s aujourd'hui</span>
                                        <span class="font-bold text-blue-600">{{ performanceStats.rdvAujourdhui || 0 }}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-slate-600">RDV cette semaine</span>
                                        <span class="font-bold text-purple-600">{{ performanceStats.rdvCetteSemaine || 0 }}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-slate-600">RDV ce mois</span>
                                        <span class="font-bold text-indigo-600">{{ performanceStats.rdvCeMois || 0 }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pr√©diction de charge -->
                        <div class="bg-white rounded-xl p-4 border border-slate-200">
                            <h4 class="font-bold text-lg mb-4 text-slate-800 flex items-center gap-2">
                                <i class="fa-solid fa-calendar-days text-green-600"></i>
                                Pr√©diction de charge de travail (7 prochains jours)
                            </h4>
                            <div class="space-y-2">
                                <div v-for="day in workloadPrediction" :key="day.date" class="flex items-center justify-between p-3 bg-gradient-to-r from-slate-50 to-white rounded-lg border" :class="day.count > 10 ? 'border-red-200' : day.count > 5 ? 'border-orange-200' : 'border-green-200'">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-lg flex items-center justify-center font-bold text-sm" :class="day.count > 10 ? 'bg-red-100 text-red-600' : day.count > 5 ? 'bg-orange-100 text-orange-600' : 'bg-green-100 text-green-600'">
                                            {{ day.count }}
                                        </div>
                                        <span class="font-medium text-slate-700">{{ day.label }}</span>
                                    </div>
                                    <span class="text-xs text-slate-500">{{ day.date }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            
        </div>
    </div>
    
    <!-- BULK MODAL Z-INDEX FIX -->
    <div v-if="bulkModal.open" class="fixed inset-0 bg-slate-900/60 z-[400] flex items-center justify-center p-4 ">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-sm text-center pop-in border border-slate-200">
            <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 shadow-xl" 
                 :class="bulkModal.action.includes('delete') || bulkModal.action.includes('trash') ? 'bg-red-100 text-red-500' : 'bg-blue-100 text-blue-600'">
                <i class="fa-solid text-3xl" :class="bulkModal.action.includes('delete') || bulkModal.action.includes('trash') ? 'fa-trash-can' : 'fa-circle-question'"></i>
            </div>
            <h3 class="font-bold text-2xl mb-3 text-slate-800">√ätes-vous s√ªr ?</h3>
            <p class="text-slate-600 mb-8 font-medium text-lg leading-relaxed">{{ bulkModal.label }}</p>
            <div class="grid grid-cols-2 gap-4">
                <button @click="bulkModal.open=false" class="bg-slate-100 text-slate-600 py-3 rounded-xl font-bold hover:bg-slate-200 transition text-sm">Non, annuler</button>
                <button @click="executeBulkAction" 
                        :class="bulkModal.action.includes('delete') || bulkModal.action.includes('trash') ? 'bg-red-600 hover:bg-red-700 shadow-red-200' : 'bg-blue-600 hover:bg-blue-700 shadow-blue-200'"
                        class="text-white py-3 rounded-xl font-bold transition shadow-lg transform active:scale-95 text-sm">
                    Oui, confirmer
                </button>
            </div>
        </div>
    </div>
    
    <!-- MODAL HISTORIQUE UTILISATEUR -->
    <div v-if="userHistoryModal.open" class="fixed inset-0 bg-slate-900/60 z-[400] flex items-center justify-center p-4" @click.self="userHistoryModal.open = false">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col pop-in border border-slate-200">
            <div class="p-6 border-b border-slate-200 bg-gradient-to-r from-blue-50 to-purple-50 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold text-lg">
                        {{ userHistoryModal.user?.name?.charAt(0).toUpperCase() || 'U' }}
                    </div>
                    <div>
                        <h3 class="font-bold text-xl text-slate-800">{{ userHistoryModal.user?.name || 'Utilisateur' }}</h3>
                        <p class="text-sm text-slate-600">Historique des connexions</p>
                    </div>
                </div>
                <button @click="userHistoryModal.open = false" class="bg-slate-100 hover:bg-slate-200 text-slate-600 w-10 h-10 rounded-full flex items-center justify-center transition">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-6">
                <div v-if="userHistoryModal.loading" class="text-center py-12">
                    <i class="fa-solid fa-spinner fa-spin text-4xl text-blue-500 mb-4"></i>
                    <p class="text-slate-600">Chargement de l'historique...</p>
                </div>
                <div v-else-if="userHistoryModal.history.length === 0" class="text-center py-12 text-slate-400">
                    <i class="fa-solid fa-inbox text-4xl mb-4 block opacity-50"></i>
                    <p>Aucun historique disponible</p>
                </div>
                <div v-else class="space-y-3">
                    <!-- R√©sum√© mensuel -->
                    <div v-if="monthlySummaries[userHistoryModal.user?.name]" class="bg-gradient-to-r from-purple-50 to-blue-50 rounded-xl p-4 border-2 border-purple-200 mb-4">
                        <h4 class="font-bold text-purple-700 mb-2 flex items-center gap-2">
                            <i class="fa-solid fa-chart-line"></i>
                            R√©sum√© mensuel
                        </h4>
                        <div class="grid grid-cols-3 gap-4 text-sm">
                            <div>
                                <div class="text-slate-600">Connexions</div>
                                <div class="font-bold text-lg text-purple-700">{{ monthlySummaries[userHistoryModal.user?.name]?.connexions || 0 }}</div>
                            </div>
                            <div>
                                <div class="text-slate-600">Temps total</div>
                                <div class="font-bold text-lg text-purple-700">{{ monthlySummaries[userHistoryModal.user?.name]?.tempsTotal || '0h' }}</div>
                            </div>
                            <div>
                                <div class="text-slate-600">Derni√®re connexion</div>
                                <div class="font-bold text-lg text-purple-700">{{ monthlySummaries[userHistoryModal.user?.name]?.derniereConnexion || '-' }}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Liste des connexions -->
                    <div v-for="log in userHistoryModal.history" :key="log.id" class="bg-slate-50 rounded-lg p-4 border-2 border-slate-200 hover:bg-slate-100 transition">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-sm" :class="log.action === 'connexion' ? 'bg-green-500' : 'bg-red-500'">
                                    <i :class="log.action === 'connexion' ? 'fa-solid fa-sign-in-alt' : 'fa-solid fa-sign-out-alt'" class="text-xs"></i>
                                </div>
                                <div>
                                    <div class="font-bold text-slate-800">
                                        {{ log.action === 'connexion' ? 'Connexion' : 'D√©connexion' }}
                                    </div>
                                    <div class="text-xs text-slate-500">{{ new Date(log.timestamp).toLocaleString('fr-FR', {day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit', second:'2-digit'}) }}</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs font-bold" :class="log.action === 'connexion' ? 'text-green-600' : 'text-red-600'">
                                    {{ log.action === 'connexion' ? '‚úì' : '‚úó' }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- EDITING AGENCY Z-INDEX FIX -->
    <div v-if="editingAgency" class="fixed inset-0 bg-slate-900/80 z-[350] flex items-center justify-center p-4 "><div class="bg-white w-full max-w-lg rounded-3xl shadow-2xl p-6 fade-in max-h-[90vh] overflow-y-auto"><h3 class="font-bold text-xl mb-6 text-slate-800">{{ editingAgency.id ? 'Modifier' : 'Nouvelle' }} Agence</h3><div class="space-y-4"><div><label class="text-xs font-bold text-gray-500 uppercase">Nom</label><input v-model="editingAgency.nom" class="w-full p-3 border rounded-xl outline-none focus:border-blue-500 bg-slate-50 font-bold"></div><div><label class="text-xs font-bold text-gray-500 uppercase">Adresse Postale</label><input v-model="editingAgency.adresse" class="w-full p-3 border rounded-xl outline-none focus:border-blue-500 bg-slate-50"></div><div><label class="text-xs font-bold text-gray-500 uppercase">Lien Google Maps (Short)</label><input v-model="editingAgency.maps" class="w-full p-3 border rounded-xl outline-none focus:border-blue-500 bg-slate-50 text-blue-600"></div><div><label class="text-xs font-bold text-gray-500 uppercase">Phrase d'accroche (SMS)</label><input v-model="editingAgency.tagline" placeholder="Ex: votre expert rachat" class="w-full p-3 border rounded-xl outline-none focus:border-blue-500 bg-slate-50"></div><div><label class="text-xs font-bold text-gray-500 uppercase">Agenda Google (Email)</label><input v-model="editingAgency.agendaEmail" type="email" placeholder="exemple@gmail.com" class="w-full p-3 border rounded-xl outline-none focus:border-purple-500 bg-slate-50 font-mono text-sm"><p class="text-[10px] text-gray-400 mt-1">Entrez l'adresse email de la personne qui partage son agenda Google avec vous. Si vide, l'agenda principal sera utilis√© par d√©faut.</p></div><div><label class="text-xs font-bold text-gray-500 uppercase mb-2 block">Couleur de l'√©v√©nement</label><div class="grid grid-cols-6 gap-2"><div v-for="(color, id) in {1:'Lavande',2:'Sauge',3:'Raisin',4:'Flamant',5:'Banane',6:'Mandarine',7:'Paon',8:'Graphite',9:'Myrtille',10:'Basilic',11:'Tomate'}" :key="id" @click="editingAgency.agendaColor = String(id)" :class="String(editingAgency.agendaColor) === String(id) ? 'ring-2 ring-purple-500 ring-offset-2' : ''" class="cursor-pointer rounded-lg p-2 border-2 transition hover:scale-110" :style="{backgroundColor: getCalendarColor(Number(id))}"><div class="w-full h-8 rounded" :style="{backgroundColor: getCalendarColor(Number(id))}"></div><p class="text-[8px] text-center mt-1 font-bold text-slate-600">{{ color }}</p></div></div><p class="text-[10px] text-gray-400 mt-2">Choisissez la couleur des √©v√©nements dans Google Calendar</p></div><div v-if="user.role==='admin'" class="pt-4 border-t"><div class="mb-4"><label class="flex items-center gap-2 font-bold text-slate-700 cursor-pointer"><input type="checkbox" v-model="editingAgency.horairesIdentiques" class="custom-checkbox" @change="applyHorairesToAllDays"> <span>M√™me horaire pour tous les jours</span></label></div><div class="mb-4"><label class="flex items-center gap-2 font-bold text-slate-700 cursor-pointer"><input type="checkbox" v-model="editingAgency.dimancheFerme" class="custom-checkbox"> <span>Dimanche ferm√©</span></label></div><div class="mb-4"><label class="flex items-center gap-2 font-bold text-slate-700 cursor-pointer"><input type="checkbox" v-model="editingAgency.samediFerme" class="custom-checkbox"> <span>Samedi ferm√©</span></label></div><label class="text-xs font-bold text-gray-500 uppercase mb-3 block">Horaires par jour</label><p class="text-[10px] text-gray-400 mb-3">D√©finissez les horaires d'ouverture et de fermeture pour chaque jour de la semaine</p><div class="space-y-2"><div v-for="(dayName, dayIndex) in ['Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi','Dimanche']" :key="dayIndex" :class="{'opacity-50': (dayIndex === 5 && editingAgency.samediFerme) || (dayIndex === 6 && editingAgency.dimancheFerme)}" class="grid grid-cols-4 gap-2 items-center p-2 rounded-lg" :style="(dayIndex === 5 && editingAgency.samediFerme) || (dayIndex === 6 && editingAgency.dimancheFerme) ? 'background: #fee2e2;' : ''"><div class="text-xs font-bold text-slate-600 col-span-1">{{ dayName }}</div><div class="col-span-3 grid grid-cols-2 gap-2"><input type="time" :v-model="`editingAgency.horaires_${dayIndex}_ouverture`" @input="editingAgency[`horaires_${dayIndex}_ouverture`] = $event.target.value" :value="editingAgency[`horaires_${dayIndex}_ouverture`] || ''" :disabled="(dayIndex === 5 && editingAgency.samediFerme) || (dayIndex === 6 && editingAgency.dimancheFerme)" placeholder="Ouverture" class="w-full p-2 border border-slate-200 rounded-lg bg-white text-xs font-bold"><input type="time" :v-model="`editingAgency.horaires_${dayIndex}_fermeture`" @input="editingAgency[`horaires_${dayIndex}_fermeture`] = $event.target.value" :value="editingAgency[`horaires_${dayIndex}_fermeture`] || ''" :disabled="(dayIndex === 5 && editingAgency.samediFerme) || (dayIndex === 6 && editingAgency.dimancheFerme)" placeholder="Fermeture" class="w-full p-2 border border-slate-200 rounded-lg bg-white text-xs font-bold"></div></div></div></div><div class="pt-2"><label class="text-xs font-bold text-gray-500 uppercase mb-2 block">Pause d√©jeuner (optionnel)</label><div class="grid grid-cols-2 gap-3"><div><label class="text-[10px] font-bold text-gray-400 uppercase mb-1 block">D√©but pause</label><input type="time" v-model="editingAgency.heurePauseDebut" class="w-full p-2 border border-slate-200 rounded-lg bg-white text-sm font-bold"></div><div><label class="text-[10px] font-bold text-gray-400 uppercase mb-1 block">Fin pause</label><input type="time" v-model="editingAgency.heurePauseFin" class="w-full p-2 border border-slate-200 rounded-lg bg-white text-sm font-bold"></div></div></div><div class="pt-4 border-t"><label class="text-xs font-bold text-gray-500 uppercase mb-2 block">Heure limite exceptionnelle (optionnel)</label><p class="text-[10px] text-gray-400 mb-3">D√©finissez une heure √† partir de laquelle l'agence ne prend plus de rendez-vous exceptionnellement (ex: 17h en hiver car il fait nuit t√¥t)</p><div class="space-y-3"><div class="flex gap-2 items-end"><div class="flex-1"><label class="text-[10px] font-bold text-gray-400 uppercase mb-1 block">Heure limite</label><input type="time" v-model="editingAgency.heureLimiteExceptionnelle" class="w-full p-2 border border-slate-200 rounded-lg bg-white text-sm font-bold"></div><button v-if="editingAgency.heureLimiteExceptionnelle" @click="editingAgency.heureLimiteExceptionnelle=''; editingAgency.motifHeureLimite=''" class="text-red-600 hover:text-red-800 font-bold px-3 py-2 border border-red-200 rounded-lg hover:bg-red-50 transition" title="Supprimer l'heure limite"><i class="fa-solid fa-trash"></i></button></div><div v-if="editingAgency.heureLimiteExceptionnelle"><label class="text-[10px] font-bold text-gray-400 uppercase mb-1 block">Motif</label><input type="text" v-model="editingAgency.motifHeureLimite" placeholder="Ex: Il fait nuit t√¥t en hiver, on ne voit pas le v√©hicule" class="w-full p-2 border border-slate-200 rounded-lg bg-white text-sm"></div></div></div><div class="grid grid-cols-2 gap-4"><div><label class="text-xs font-bold text-gray-500 uppercase">Prix HT (‚Ç¨)</label><input type="number" v-model="editingAgency.prix_ht" @input="calculateTTC" class="w-full p-3 border rounded-xl outline-none focus:border-blue-500 bg-slate-50"></div><div><label class="text-xs font-bold text-gray-500 uppercase">TVA (%)</label><input type="number" v-model="editingAgency.tva_taux" @input="calculateTTC" placeholder="20" class="w-full p-3 border rounded-xl outline-none focus:border-blue-500 bg-slate-50"></div></div><div class="flex items-center justify-between p-3 bg-slate-100 rounded-xl"><span class="font-bold text-slate-700">Prix Affich√© (TTC)</span><span class="text-xl font-black text-blue-600">{{ formatPrice(editingAgency.prix) }}</span></div><div><label class="flex items-center gap-2 font-bold text-slate-700 cursor-pointer"><input type="checkbox" v-model="editingAgency.tva" class="custom-checkbox"> <span>Afficher "TTC" dans les SMS</span></label></div><div class="pt-4 border-t"><label class="text-xs font-bold text-gray-500 uppercase mb-2 block">√âtat de l'agence</label><div class="flex gap-2"><button @click="editingAgency.statut_activite='actif'" :class="editingAgency.statut_activite==='actif' ? 'bg-green-500 text-white shadow-md' : 'bg-slate-100 text-slate-500'" class="flex-1 py-2 rounded-xl font-bold transition">Actif</button><button @click="editingAgency.statut_activite='pause'" :class="editingAgency.statut_activite==='pause' ? 'bg-red-500 text-white shadow-md' : 'bg-slate-100 text-slate-500'" class="flex-1 py-2 rounded-xl font-bold transition">En Pause</button></div></div><div v-if="editingAgency.statut_activite==='pause'" class="space-y-3 bg-red-50 p-4 rounded-xl border border-red-100 animate-fadeIn"><div><label class="text-xs font-bold text-red-500 uppercase">Motif de la pause</label><select v-model="pauseReasonSelect" @change="updatePauseReason" class="w-full p-2 border border-red-200 rounded-lg outline-none bg-white font-bold text-slate-700 mt-1"><option value="Vacances">Vacances</option><option value="Complet">Complet / Surcharg√©</option><option value="Travaux">Travaux</option><option value="Autre">Autre (personnalis√©)</option></select><input v-if="pauseReasonSelect==='Autre'" v-model="editingAgency.motif_pause" placeholder="Pr√©cisez le motif..." class="w-full mt-2 p-2 border border-red-200 rounded-lg outline-none bg-white"></div><div v-if="pauseReasonSelect==='Vacances'" class="grid grid-cols-2 gap-2"><div><label class="text-[10px] font-bold text-red-400 uppercase">D√©but</label><input type="date" v-model="editingAgency.date_pause_debut" class="w-full p-2 border border-red-200 rounded-lg bg-white text-sm"></div><div><label class="text-[10px] font-bold text-red-400 uppercase">Fin (inclus)</label><input type="date" v-model="editingAgency.date_pause_fin" class="w-full p-2 border border-red-200 rounded-lg bg-white text-sm"></div></div></div><div class="pt-4 border-t"><label class="text-xs font-bold text-gray-500 uppercase mb-3 block">Cong√©s / Fermetures exceptionnelles</label><p class="text-[10px] text-gray-400 mb-3">D√©finissez des dates pr√©cises o√π l'agence sera ferm√©e. Aucun rendez-vous ne pourra √™tre pris ces jours-l√†.</p><div class="space-y-2 max-h-60 overflow-y-auto bg-orange-50 p-3 rounded-xl border border-orange-200"><div v-for="(fermeture, idx) in editingAgencyFermetures" :key="idx" class="flex flex-col gap-2 bg-white p-3 rounded-lg border border-orange-200"><div class="flex gap-2 items-end"><div class="flex-1 grid grid-cols-2 gap-2"><div><label class="text-[10px] font-bold text-orange-600 uppercase mb-1 block">Date d√©but</label><input type="date" v-model="fermeture.date_debut" class="w-full px-2 py-2 border border-orange-200 rounded-lg text-xs font-bold outline-none focus:border-orange-500"></div><div><label class="text-[10px] font-bold text-orange-600 uppercase mb-1 block">Date fin (inclus)</label><input type="date" v-model="fermeture.date_fin" class="w-full px-2 py-2 border border-orange-200 rounded-lg text-xs font-bold outline-none focus:border-orange-500"></div></div><button @click="saveFermetureIndividuelle(idx)" :disabled="!fermeture.date_debut || !fermeture.date_fin" :class="fermeture.date_debut && fermeture.date_fin ? 'bg-green-500 hover:bg-green-600 text-white' : 'bg-gray-300 text-gray-500 cursor-not-allowed'" class="px-3 py-2 rounded-lg font-bold text-xs transition flex items-center gap-1 self-end" title="Enregistrer cette fermeture"><i class="fa-solid fa-check"></i> <span class="hidden sm:inline">OK</span></button><button @click="removeAgencyFermeture(idx)" class="text-red-600 hover:text-red-800 font-bold px-2 py-2 self-end"><i class="fa-solid fa-trash"></i></button></div><div v-if="fermeture.date_debut && fermeture.date_fin && isFermetureValide(fermeture)" class="text-xs text-green-600 font-bold flex items-center gap-1"><i class="fa-solid fa-check-circle"></i> Fermeture enregistr√©e</div></div><button @click="addAgencyFermeture" class="w-full bg-orange-100 text-orange-600 px-4 py-2 rounded-lg font-bold text-sm hover:bg-orange-200 transition flex items-center justify-center gap-2"><i class="fa-solid fa-plus"></i> Ajouter une fermeture exceptionnelle</button></div></div><div class="pt-4 border-t"><label class="text-xs font-bold text-gray-500 uppercase mb-3 block">Commerciaux (pour le Bilan)</label><p class="text-[10px] text-gray-400 mb-3">Si l'agence a des commerciaux, ils seront demand√©s lors de l'honorisation des RDV. Si vide, les RDV seront automatiquement ajout√©s au Bilan.</p><div class="space-y-2 max-h-60 overflow-y-auto bg-slate-50 p-3 rounded-xl border border-slate-200"><div v-for="(comm, idx) in editingAgencyCommerciaux" :key="idx" class="flex gap-2 items-center bg-white p-2 rounded-lg border border-slate-200"><input type="text" v-model="comm.name" placeholder="Nom du commercial" class="flex-1 px-3 py-2 border border-slate-200 rounded-lg text-sm font-medium outline-none focus:border-blue-500"><input type="number" v-model.number="comm.obj" placeholder="Obj." class="w-20 px-2 py-2 border border-slate-200 rounded-lg text-sm font-bold text-center outline-none focus:border-blue-500"><button @click="removeAgencyCommercial(idx)" class="text-red-600 hover:text-red-800 font-bold px-2"><i class="fa-solid fa-trash"></i></button></div><button @click="addAgencyCommercial" class="w-full bg-blue-100 text-blue-600 px-4 py-2 rounded-lg font-bold text-sm hover:bg-blue-200 transition flex items-center justify-center gap-2"><i class="fa-solid fa-plus"></i> Ajouter un commercial</button></div></div></div><div class="flex gap-4 mt-6"><button @click="editingAgency=null" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-bold hover:bg-gray-300">Annuler</button><button @click="saveEditingAgency" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700">Enregistrer</button></div></div></div>
    <!-- WIZARD Z-INDEX FIX -->
    <div v-if="wizard.open" class="fixed inset-0 bg-slate-100 z-[500] flex flex-col h-screen overflow-hidden">
        
        <div class="bg-white p-2 shadow-sm border-b border-slate-200 sticky top-0 z-[510] flex justify-between items-center flex-shrink-0">
            <h3 class="font-bold text-lg text-slate-800 flex items-center gap-2">
                <span class="bg-blue-600 text-white w-7 h-7 rounded-lg flex items-center justify-center text-xs font-black">{{ wizard.step }}/6</span>
                <span>Nouveau RDV</span>
            </h3>
            <button @click="wizard.open=false" class="bg-red-500 hover:bg-red-600 text-white font-bold px-4 py-2 rounded-xl transition flex items-center gap-2 shadow-md">
                <i class="fa-solid fa-xmark"></i> Fermer
            </button>
        </div>

        <div class="flex-1 overflow-y-auto p-2 md:p-4 flex items-start justify-center">
            <div class="w-full max-w-lg bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden fade-in my-auto">
                
                <div class="p-4 md:p-6 space-y-4">

                    <div v-if="wizard.step===1">
                        <h4 class="text-center font-black text-2xl mb-2 text-slate-800">Choisir l'Agence</h4>
                        <p class="text-center text-slate-400 text-sm mb-6">O√π aura lieu le rendez-vous ?</p>
                        
                        <div class="relative mb-4">
                            <i class="fa-solid fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            <input v-model="agencySearch" placeholder="Rechercher..." class="w-full pl-12 p-4 border-2 border-slate-200 rounded-2xl font-bold outline-none focus:border-blue-500 transition">
                        </div>

                        <div class="space-y-3 max-h-[50vh] overflow-y-auto pr-1">
                            <button v-for="ag in filteredAgences" :key="ag.id" @click="checkAgenceAndProceed(ag)" :class="[
                                ag.statut_activite==='pause' ? 'border-red-200 bg-red-50 opacity-80' : 'border-slate-200 hover:border-blue-500 hover:bg-blue-50',
                                ag.statut_activite !== 'pause' && isAgenceFermeeAujourdhui(ag) ? 'border-orange-300 bg-orange-50 opacity-80' : ''
                            ]" class="w-full p-5 border-2 rounded-2xl text-left transition group relative flex flex-col justify-center">
                                <div class="font-bold text-lg text-slate-800 group-hover:text-blue-600 mb-1">{{ ag.nom }}</div>
                                <div class="text-xs text-gray-500 truncate">{{ ag.adresse }}</div>
                                <div v-if="ag.statut_activite==='pause'" class="absolute top-1/2 -translate-y-1/2 right-4 text-red-500 font-black text-xs border border-red-200 bg-white px-2 py-1 rounded">PAUSE</div>
                                <div v-else-if="isAgenceFermeeAujourdhui(ag)" class="absolute top-1/2 -translate-y-1/2 right-4 text-orange-600 font-black text-xs border border-orange-200 bg-white px-2 py-1 rounded">FERM√â</div>
                                <i v-else class="fa-solid fa-chevron-right absolute top-1/2 -translate-y-1/2 right-4 text-slate-300 group-hover:text-blue-500"></i>
                            </button>
                            <div v-if="filteredAgences.length === 0" class="text-center text-gray-400 py-4 italic">Aucune agence trouv√©e.</div>
                        </div>
                    </div>

                    <div v-if="wizard.step===2">
                        <h4 class="text-center font-black text-2xl mb-8 text-slate-800">Informations Client</h4>
                        
                        <div class="flex gap-4 mb-6">
                            <button @click="form.civilite='M.'" :class="form.civilite==='M.'?'bg-blue-600 text-white shadow-lg scale-105':'bg-slate-100 text-slate-500 hover:bg-slate-200'" class="flex-1 py-3 rounded-xl font-bold transition transform">Monsieur</button>
                            <button @click="form.civilite='Mme'" :class="form.civilite==='Mme'?'bg-pink-500 text-white shadow-lg scale-105':'bg-slate-100 text-slate-500 hover:bg-slate-200'" class="flex-1 py-3 rounded-xl font-bold transition transform">Madame</button>
                        </div>

                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-1 ml-1">Nom Complet</label>
                                <input v-model="form.nom" @input="formatNameRealTime" @blur="onWizardNameBlur" @paste="onWizardNamePaste" placeholder="Ex: Dupont Jean" class="w-full text-lg font-bold border-2 border-slate-200 rounded-2xl p-4 outline-none focus:border-blue-500 bg-slate-50 focus:bg-white transition">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-1 ml-1">T√©l√©phone</label>
                                <div class="relative">
                                    <input type="tel" :value="form.telephone" @input="onWizardPhoneInput" :disabled="form.pasDeNumero" placeholder="06 12 34 56 78" class="w-full text-lg font-mono font-bold border-2 border-slate-200 rounded-2xl p-4 outline-none focus:border-blue-500 tracking-widest bg-slate-50 focus:bg-white transition text-center disabled:opacity-50 disabled:cursor-not-allowed">
                                    <button @click="pastePhoneNumber" :disabled="form.pasDeNumero" class="absolute right-3 top-1/2 -translate-y-1/2 text-blue-600 hover:text-blue-800 bg-blue-100 p-2 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed" title="Coller"><i class="fa-solid fa-paste"></i></button>
                                </div>
                                <label class="flex items-center gap-2 mt-3 cursor-pointer">
                                    <input type="checkbox" v-model="form.pasDeNumero" class="w-4 h-4 text-blue-600 border-slate-300 rounded focus:ring-blue-500">
                                    <span class="text-sm text-slate-600 font-medium">Cette personne n'a pas de num√©ro de t√©l√©phone</span>
                                </label>
                            </div>
                        </div>

                        <p v-if="clientExists" class="text-green-600 text-sm text-center mt-4 font-bold animate-pulse bg-green-50 p-2 rounded-xl border border-green-100">‚ú® Client existant d√©tect√© !</p>

                        <div class="flex gap-3 mt-8 pt-4 border-t border-slate-100">
                            <button @click="wizard.step--" class="px-6 bg-slate-100 text-slate-500 rounded-xl font-bold hover:bg-slate-200">Retour</button>
                            <button @click="wizard.step++" :disabled="!form.nom || (!form.pasDeNumero && normalizePhone(form.telephone).length<10)" class="flex-1 bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-blue-700 disabled:opacity-50 disabled:shadow-none transition transform active:scale-95">Suivant</button>
                        </div>
                    </div>

                    <div v-if="wizard.step===3">
                        <h4 class="text-center font-black text-2xl mb-8 text-slate-800">Date & Heure</h4>
                        
                        <div class="mb-8">
                            <div class="flex items-center justify-between mb-4">
                                <label class="text-xs font-bold text-slate-400 uppercase tracking-widest ml-1">Le Jour</label>
                                <input type="date" v-model="form.date" @change="form.heure=null" class="bg-slate-50 border-none rounded-lg text-sm font-bold text-slate-600 outline-none focus:text-blue-600 cursor-pointer">
                            </div>
                            
                            <div class="flex overflow-x-auto gap-3 pb-2 snap-x hide-scrollbar">
                                <button v-for="d in dateOptions" :key="d.val" @click="form.date=d.val; form.heure=null" 
                                    :class="[
                                        form.date===d.val ? 'bg-slate-800 text-white shadow-lg scale-105' : 'bg-white border text-slate-500 hover:border-slate-400',
                                        form.agence && isDateInFermeture(d.val, form.agence) ? 'border-red-300 bg-red-50 opacity-75' : 'border-slate-200'
                                    ]" 
                                    class="flex-shrink-0 w-16 h-20 rounded-2xl flex flex-col items-center justify-center transition-all duration-300 snap-center group relative">
                                    <span class="text-[10px] font-bold uppercase mb-1 opacity-70">{{ d.dayName }}</span>
                                    <span class="text-2xl font-black leading-none">{{ d.dayNum }}</span>
                                    <span v-if="d.isToday" class="mt-1 w-1 h-1 rounded-full bg-blue-500"></span>
                                    <span v-if="form.agence && isDateInFermeture(d.val, form.agence)" class="absolute top-1 right-1 text-red-500 text-xs"><i class="fa-solid fa-ban"></i></span>
                                </button>
                            </div>
                        </div>

                        <div v-if="form.date" class="animate-fadeIn">
                            <!-- Message d'alerte si la date est en fermeture -->
                            <div v-if="form.agence && isDateInFermeture(form.date, form.agence)" class="mb-4 p-4 bg-red-50 border-2 border-red-200 rounded-xl animate-fadeIn">
                                <div class="flex items-start gap-3">
                                    <i class="fa-solid fa-ban text-red-500 text-xl mt-0.5"></i>
                                    <div class="flex-1">
                                        <p class="font-bold text-red-700 mb-1">‚ö†Ô∏è Agence ferm√©e</p>
                                        <p class="text-sm text-red-600">{{ getFermetureMessage(form.date, form.agence) }}</p>
                                        <p class="text-xs text-red-500 mt-2">Aucun rendez-vous ne peut √™tre pris cette journ√©e.</p>
                                    </div>
                                </div>
                            </div>
                            
                            <label class="text-xs font-bold text-slate-400 uppercase tracking-widest ml-1 mb-3 block">L'Heure</label>
                            
                            <div v-if="!form.agence || !isDateInFermeture(form.date, form.agence)" class="flex flex-wrap gap-2 justify-center">
                                <button v-for="h in timeSlots" :key="h" 
                                    @click="checkHeureFermetureAndConfirm(() => { form.heure=h; wizard.step++; })" 
                                    class="px-4 py-2 rounded-full border border-slate-200 text-slate-600 font-bold text-sm hover:bg-slate-800 hover:text-white hover:border-slate-800 hover:shadow-lg transition transform active:scale-95">
                                    {{ h }}
                                </button>
                            </div>
                            
                            <div v-else class="text-center p-6 bg-red-50 border-2 border-red-200 rounded-xl">
                                <p class="text-red-600 font-bold">Les cr√©neaux horaires ne sont pas disponibles</p>
                            </div>

                            <div v-if="!form.agence || !isDateInFermeture(form.date, form.agence)" class="mt-8 flex justify-center border-t border-slate-100 pt-6">
                                <div class="relative group">
                                    <input type="time" v-model="form.heure" @input="handleTimeInput" @change="handleTimeInput" class="pl-10 pr-4 py-2 bg-slate-50 rounded-xl text-sm font-bold text-slate-500 border border-transparent hover:bg-white hover:border-slate-200 focus:bg-white focus:border-blue-500 focus:text-blue-600 outline-none transition text-center shadow-inner">
                                    <i class="fa-regular fa-clock absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div v-else class="text-center p-8 text-slate-300 text-sm italic font-medium bg-slate-50 rounded-2xl border border-dashed border-slate-200">
                            üëÜ S√©lectionnez une date ci-dessus
                        </div>

                        <div class="flex gap-3 mt-8 pt-6 border-t border-slate-100">
                            <button @click="wizard.step--" class="px-6 bg-white border border-slate-200 text-slate-500 rounded-xl font-bold hover:bg-slate-50 transition text-sm">Retour</button>
                            <button v-if="form.heure && (!form.agence || !isDateInFermeture(form.date, form.agence))" @click="checkHeureFermetureAndConfirm(() => wizard.step++)" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition text-sm">Suivant <i class="fa-solid fa-arrow-right ml-2"></i></button>
                        </div>
                    </div>

                    <div v-if="wizard.step===4">
                        <h4 class="text-center font-black text-2xl mb-8 text-slate-800">Source du RDV</h4>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <button v-for="src in sourcesList" @click="selectSource(src)" :class="form.source === src ? 'border-blue-500 bg-blue-50 ring-2 ring-blue-200 shadow-md' : 'border-slate-200 bg-white hover:border-blue-300 hover:bg-slate-50'" class="p-6 rounded-2xl border-2 flex flex-col items-center gap-3 transition transform active:scale-95">
                                <img :src="getLogo(src)" class="w-10 h-10 rounded-lg object-contain">
                                <span class="font-bold text-slate-700 text-sm">{{ src }}</span>
                            </button>
                        </div>

                        <div class="flex gap-3 mt-8 pt-4 border-t border-slate-100">
                            <button @click="wizard.step--" class="w-full bg-slate-100 text-slate-500 py-3 rounded-xl font-bold hover:bg-slate-200">Retour</button>
                        </div>
                    </div>

                    <div v-if="wizard.step===5">
                        <h4 class="text-center font-black text-2xl mb-8 text-slate-800">V√©hicule</h4>
                        
                        <!-- CHAMP INTELLIGENT POUR LE BON COIN, LA CENTRALE ET FACEBOOK -->
                        <div v-if="form.source === 'Leboncoin' || form.source === 'La Centrale' || form.source === 'Facebook'" class="mb-3 p-3 bg-gradient-to-br from-blue-50 to-purple-50 border-2 border-blue-200 rounded-2xl">
                            <div class="flex items-center justify-between mb-1.5">
                                <label class="text-xs font-bold text-blue-700 uppercase flex items-center gap-2">
                                    <i class="fa-solid fa-magic"></i>
                                    <span v-if="form.source === 'Facebook'">
                                        <i class="fa-brands fa-facebook text-blue-600"></i>
                                        Caract√©ristiques Facebook Intelligent
                                    </span>
                                    <span v-else-if="form.source === 'La Centrale'">
                                        Mode Intelligent (Collez depuis La Centrale)
                                    </span>
                                    <span v-else>
                                        Mode Intelligent (Collez depuis Le Bon Coin)
                                    </span>
                                </label>
                                <button @click="showIntelligentModeHelp = true" class="text-blue-600 hover:text-blue-800 text-xs flex items-center gap-1 transition" title="Aide sur le mode intelligent">
                                    <i class="fa-solid fa-circle-question"></i>
                                    <span class="hidden sm:inline">Aide</span>
                                </button>
                            </div>
                            <p v-if="form.source === 'Leboncoin' || form.source === 'La Centrale'" class="text-xs text-slate-600 mb-2 p-1.5 bg-blue-50 border border-blue-200 rounded-lg">
                                <i class="fa-solid fa-info-circle text-blue-600"></i>
                                <strong>Astuce :</strong> Collez au minimum le <strong>nom du v√©hicule</strong> (obligatoire) et le <strong>prix</strong> (recommand√©). Le syst√®me d√©tectera automatiquement ces informations.
                            </p>
                            <textarea 
                                v-model="intelligentPaste" 
                                @paste="handleIntelligentPaste" 
                                @input="handleIntelligentPaste"
                                :placeholder="form.source === 'Facebook' ? 'Collez ici les caract√©ristiques et informations du v√©hicule depuis Facebook...\n\nExemple complet :\n2007 Citro√´n C3\n2 300 ‚Ç¨\n132 500 km au compteur\nBo√Æte de vitesse manuelle\nCouleur ext√©rieure : Black ¬∑ Couleur int√©rieure : Black\nType de carburant : Diesel\n2 propri√©taires' : form.source === 'La Centrale' ? 'Collez ici le texte copi√© depuis La Centrale (titre, infos, prix)...\nExemple:\nAUDI Q2 1.5 35 TFSI - 150 - BV S-tronic Design\nGanges ¬∑ 2023 ¬∑ 32950 km ¬∑ Essence\n26 990 ‚Ç¨' : 'Collez ici le texte copi√© depuis Le Bon Coin (titre, infos, prix)...\nExemple:\nAUDI Q2 1.5 35 TFSI - 150 - BV S-tronic Design\nGanges ¬∑ 2023 ¬∑ 32950 km ¬∑ Essence\n26 990 ‚Ç¨'"
                                class="w-full p-2 text-sm border-2 border-blue-300 rounded-xl outline-none focus:border-blue-500 transition bg-white text-slate-700 font-medium min-h-[50px] resize-none"
                            ></textarea>
                            <div v-if="form.source === 'Facebook' && form.facebookCaracteristiquesFormatees" class="mt-2 p-2 bg-white border border-blue-300 rounded-lg">
                                <p class="text-xs font-bold text-slate-600 mb-1">Aper√ßu format√© :</p>
                                <div class="text-xs text-slate-700 whitespace-pre-line font-mono">{{ form.facebookCaracteristiquesFormatees }}</div>
                            </div>
                            <p class="text-xs text-blue-600 mt-1.5 flex items-center gap-1">
                                <i class="fa-solid fa-lightbulb"></i>
                                <span v-if="form.source === 'Facebook'">
                                    Le syst√®me d√©tecte automatiquement le mod√®le, le prix et formate les caract√©ristiques
                                </span>
                                <span v-else>
                                    Le syst√®me d√©tecte automatiquement le mod√®le (premi√®re ligne) et le prix
                                </span>
                            </p>
                        </div>
                        
                        <div class="w-full relative group mb-2">
                            <i class="fa-solid fa-car absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm group-focus-within:text-blue-500 transition"></i>
                            <input v-model="form.modele" @input="form.modele = form.modele.toUpperCase()" @blur="form.modele = formatModeleName(form.modele)" @paste="setTimeout(() => { form.modele = formatModeleName(form.modele); }, 0)" placeholder="Marque, Mod√®le, Finition..." class="w-full pl-9 p-2 text-sm border-2 border-slate-200 rounded-xl outline-none focus:border-blue-600 transition bg-slate-50 focus:bg-white font-bold text-slate-700 shadow-sm uppercase">
                        </div>
                        <p v-if="form.source !== 'Leboncoin' && form.source !== 'La Centrale' && form.source !== 'Facebook'" class="text-center text-xs text-slate-400 mb-2">Saisissez le v√©hicule manuellement.</p>
                        <p v-else class="text-center text-xs text-slate-400 mb-2">Saisissez le v√©hicule manuellement ou utilisez le mode intelligent ci-dessus.</p>

                        <div class="w-full relative group mb-2">
                            <i class="fa-solid fa-euro-sign absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm group-focus-within:text-blue-500 transition"></i>
                            <input v-model.number="form.prix" type="text" @input="formatPrixInput" @paste="handlePrixPaste" @keypress="(e) => { if (!/[0-9.,]/.test(e.key) && !['Backspace', 'Delete', 'Tab', 'Enter'].includes(e.key)) e.preventDefault(); }" placeholder="Prix du v√©hicule (‚Ç¨)" class="w-full pl-9 p-2 text-sm border-2 border-slate-200 rounded-xl outline-none focus:border-blue-600 transition bg-slate-50 focus:bg-white font-bold text-slate-700 shadow-sm">
                        </div>

                        <div v-if="form.source !== 'Facebook'" class="w-full relative group mb-4">
                            <i class="fa-solid fa-link absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-lg group-focus-within:text-blue-500 transition"></i>
                            <input v-model="form.lienAnnonce" type="url" @blur="handleLienAnnonceBlur" @paste="handleLienAnnoncePaste" placeholder="Collez le lien de l'annonce (Le Bon Coin d√©tect√© automatiquement)" class="w-full pl-12 pr-20 p-4 text-sm border-2 border-slate-200 rounded-2xl outline-none focus:border-blue-600 transition bg-slate-50 focus:bg-white font-medium text-slate-700 shadow-sm">
                            <i v-if="loadingLienAnnonce" class="fa-solid fa-spinner fa-spin absolute right-12 top-1/2 -translate-y-1/2 text-blue-500"></i>
                            <button 
                                v-if="form.lienAnnonce && form.lienAnnonce.includes('leboncoin')" 
                                @click="openLeboncoinInNewTab"
                                class="absolute right-4 top-1/2 -translate-y-1/2 text-blue-600 hover:text-blue-800 text-xs font-bold flex items-center gap-1"
                                title="Ouvrir dans un nouvel onglet pour copier les infos"
                            >
                                <i class="fa-solid fa-external-link"></i>
                            </button>
                        </div>
                        <p v-if="loadingLienAnnonce" class="text-center text-xs text-blue-600 mb-4 font-bold animate-pulse">üîÑ R√©cup√©ration des informations depuis Le Bon Coin...</p>

                        <div class="w-full relative group mb-2">
                            <i class="fa-solid fa-tag absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-lg group-focus-within:text-blue-500 transition z-10"></i>
                            <select v-model="form.motif" class="w-full pl-12 pr-10 p-4 text-sm border-2 border-slate-200 rounded-2xl outline-none focus:border-blue-600 transition bg-slate-50 focus:bg-white font-medium text-slate-700 shadow-sm appearance-none">
                                <option value="">S√©lectionner un motif (facultatif)</option>
                                <option v-for="motif in motifsList" :key="motif" :value="motif">{{ motif }}</option>
                                <option value="__CUSTOM__">Autre (saisie libre)</option>
                            </select>
                            <i class="fa-solid fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                        </div>
                        <div v-if="form.motif === '__CUSTOM__'" class="w-full relative group mb-2">
                            <i class="fa-solid fa-pen absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-lg group-focus-within:text-blue-500 transition"></i>
                            <input v-model="form.motifCustom" placeholder="Pr√©cisez le motif..." class="w-full pl-12 p-4 text-sm border-2 border-slate-200 rounded-2xl outline-none focus:border-blue-600 transition bg-slate-50 focus:bg-white font-medium text-slate-700 shadow-sm">
                        </div>

                        <div class="flex gap-3 mt-12 pt-4 border-t border-slate-100">
                            <button @click="wizard.step--" class="px-6 bg-slate-100 text-slate-500 rounded-xl font-bold hover:bg-slate-200">Retour</button>
                            <button @click="wizard.step++" :disabled="!form.modele" class="flex-1 bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-blue-700 disabled:opacity-50 disabled:shadow-none transition transform active:scale-95">Suivant</button>
                        </div>
                    </div>

                    <div v-if="wizard.step===6">
                        <h4 class="text-center font-black text-2xl mb-6 text-blue-900">R√©capitulatif</h4>
                        
                        <div class="bg-slate-50 p-6 rounded-2xl space-y-3 text-sm border border-slate-200">
                            <div class="flex justify-between border-b border-slate-200 pb-2">
                                <span class="text-slate-500">Agence</span>
                                <b class="text-slate-800">{{ form.agence.nom }}</b>
                            </div>
                            <div class="flex justify-between border-b border-slate-200 pb-2">
                                <span class="text-slate-500">Client</span>
                                <b class="text-slate-800">{{ form.civilite }} {{ form.nom }}</b>
                            </div>
                            <div class="flex justify-between border-b border-slate-200 pb-2">
                                <span class="text-slate-500">T√©l√©phone</span>
                                <b class="font-mono text-slate-800">{{ form.telephone }}</b>
                            </div>
                            <div class="border-b border-slate-200 pb-2">
                                <div class="flex justify-between mb-2">
                                <span class="text-slate-500">V√©hicule</span>
                                    <b class="text-slate-800">{{ getBaseModele(form.modele) || form.modele }}</b>
                                </div>
                                <div v-if="formatCaracteristiquesForDisplay(form.modele).caracteristiques.length > 0" class="mt-2 pt-2 border-t border-slate-100">
                                    <div class="text-xs text-slate-600 space-y-1">
                                        <div v-for="(carac, idx) in formatCaracteristiquesForDisplay(form.modele).caracteristiques" :key="idx" class="flex">
                                            <span class="font-bold text-slate-700 w-32 flex-shrink-0">{{ carac.label }} :</span>
                                            <span class="text-slate-600">{{ carac.value }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div v-if="form.prix" class="flex justify-between border-b border-slate-200 pb-2">
                                <span class="text-slate-500">Prix</span>
                                <b class="text-slate-800">{{ formatPrice(form.prix) }}</b>
                            </div>
                            <div class="flex justify-between border-b border-slate-200 pb-2">
                                <span class="text-slate-500">Date</span>
                                <b class="text-blue-600">{{ formatDateFr(form.date) }} √† {{ form.heure }}</b>
                            </div>
                            <div class="flex justify-between border-b border-slate-200 pb-2">
                                <span class="text-slate-500">Source</span>
                                <div class="flex items-center gap-2">
                                    <img :src="getLogo(form.source)" class="w-4 h-4 rounded">
                                    <b>{{ form.source }}</b>
                                </div>
                            </div>
                            <div v-if="form.lienAnnonce" class="flex justify-between border-b border-slate-200 pb-2">
                                <span class="text-slate-500">Lien de l'annonce</span>
                                <a :href="form.lienAnnonce" target="_blank" class="text-blue-600 hover:text-blue-800 font-medium flex items-center gap-2 underline">
                                    <i class="fa-solid fa-external-link text-xs"></i>
                                    Voir l'annonce
                                </a>
                            </div>
                            <div v-if="form.motif || form.motifCustom" class="flex justify-between">
                                <span class="text-slate-500">Motif</span>
                                <b class="text-slate-800">{{ form.motif === '__CUSTOM__' ? form.motifCustom : form.motif }}</b>
                            </div>
                        </div>

                        <div class="mt-8 space-y-3">
                            <button v-if="!wizard.loading" @click="validateAndSendSMS" class="block w-full bg-green-500 text-white py-4 rounded-2xl font-bold text-center shadow-xl hover:bg-green-600 hover:shadow-2xl flex items-center justify-center gap-3 transform active:scale-95 transition text-lg">
                                <i class="fa-solid fa-paper-plane"></i> 
                                Valider & SMS
                            </button>
                            <button v-else disabled class="w-full bg-green-500 text-white py-4 rounded-2xl font-bold text-center shadow-xl opacity-50 cursor-not-allowed flex items-center justify-center gap-3">
                                <i class="fa-solid fa-spinner fa-spin"></i>
                                Cr√©ation en cours...
                            </button>
                            
                            <button @click="finalizeRdv('confirme')" :disabled="wizard.loading" :class="wizard.loading ? 'opacity-50 cursor-not-allowed' : 'hover:bg-blue-600'" class="w-full bg-blue-500 text-white py-3 rounded-xl font-bold transition flex items-center justify-center gap-2">
                                <i v-if="wizard.loading" class="fa-solid fa-spinner fa-spin"></i>
                                <i v-else class="fa-solid fa-check"></i> 
                                {{ wizard.loading ? 'Cr√©ation en cours...' : 'Confirmer sans SMS' }}
                            </button>
                            
                            <div class="grid grid-cols-2 gap-3 mt-6">
                                <button @click="wizard.step--" :disabled="wizard.loading" :class="wizard.loading ? 'opacity-50 cursor-not-allowed' : 'hover:bg-slate-200'" class="bg-slate-100 text-slate-500 py-3 rounded-xl font-bold transition">Retour</button>
                                <button @click="finalizeRdv('a_confirmer')" :disabled="wizard.loading" :class="wizard.loading ? 'opacity-50 cursor-not-allowed' : 'hover:bg-orange-500 hover:text-white hover:shadow-lg'" class="bg-orange-50 text-orange-600 border-2 border-orange-300 py-3 rounded-xl font-bold transition transform active:scale-95 flex items-center justify-center gap-2 shadow-sm">
                                    <i v-if="wizard.loading" class="fa-solid fa-spinner fa-spin"></i>
                                    <i v-else class="fa-solid fa-clock"></i>
                                    {{ wizard.loading ? 'Cr√©ation...' : 'Confirmer + Tard' }}
                                </button>
                            </div>
                    </div>
                </div>
                
                
            </div>
        </div>
    </div>
    </div>
    
    <!-- MODAL INFO GOOGLE CALENDAR -->
    <div v-if="googleCalendarInfoModal.open" class="fixed inset-0 bg-slate-900/80 z-[600] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-md text-center animate-fadeIn border-2 border-blue-100 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-32 h-32 bg-blue-50 rounded-full -mr-16 -mt-16 opacity-50"></div>
            <div class="relative z-10">
                <div class="w-20 h-20 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-xl">
                    <i class="fa-brands fa-google text-4xl"></i>
                </div>
                <h3 class="font-black text-2xl mb-3 text-slate-800">Google Calendar connect√©</h3>
                <p class="text-slate-600 mb-6 font-medium leading-relaxed">
                    Si vous n'√™tes plus connect√© √† Google, il faudra appuyer sur ce bouton pour vous reconnecter afin que vos rendez-vous se placent bien dans l'agenda.
                </p>
                <button @click="googleCalendarInfoModal.open=false" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg transition transform active:scale-95 flex items-center justify-center gap-2">
                    <i class="fa-solid fa-check"></i>
                    Compris
                </button>
            </div>
        </div>
    </div>
    
    <!-- MODAL AIDE MODE INTELLIGENT -->
    <div v-if="showIntelligentModeHelp" class="fixed inset-0 bg-slate-900/80 z-[600] flex items-center justify-center p-4" @click.self="showIntelligentModeHelp = false">
        <div class="bg-white rounded-xl shadow-2xl p-4 w-full max-w-md text-left animate-fadeIn border-2 border-blue-100 relative">
            <div class="relative z-10">
                <div class="flex items-center gap-2 mb-3">
                    <i class="fa-solid fa-magic text-blue-600 text-lg"></i>
                    <h3 class="font-bold text-lg text-slate-800">Mode Intelligent</h3>
                </div>
                <div class="space-y-2 text-slate-700 text-xs">
                    <div>
                        <h4 class="font-bold text-sm mb-1 flex items-center gap-1">
                            <i class="fa-solid fa-wand-magic-sparkles text-blue-600 text-xs"></i>
                            √Ä quoi √ßa sert ?
                        </h4>
                        <p class="text-xs leading-tight mb-1.5">
                            Collez directement depuis <strong>Le Bon Coin</strong>, <strong>La Centrale</strong> ou <strong>Facebook</strong>. Le syst√®me d√©tecte automatiquement :
                        </p>
                        <ul class="list-disc list-inside text-xs space-y-0.5 ml-3 mb-2">
                            <li>Le <strong>nom du v√©hicule</strong> (obligatoire)</li>
                            <li>Le <strong>prix</strong> (recommand√©)</li>
                            <li>Les <strong>caract√©ristiques</strong> (Facebook)</li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="font-bold text-sm mb-1 flex items-center gap-1">
                            <i class="fa-brands fa-leboncoin text-orange-600 text-xs"></i>
                            Le Bon Coin / La Centrale
                        </h4>
                        <p class="text-xs leading-tight mb-1">
                            Collez au minimum le <strong>nom</strong> et le <strong>prix</strong>.
                        </p>
                        <div class="bg-slate-50 p-2 rounded text-[10px] font-mono text-slate-600 mb-1.5">
                            Exemple : AUDI Q2 1.5 35 TFSI ‚Ä¢ Ganges 2023 ‚Ä¢ 26 990 ‚Ç¨
                        </div>
                    </div>
                    <div>
                        <h4 class="font-bold text-sm mb-1 flex items-center gap-1">
                            <i class="fa-brands fa-facebook text-blue-600 text-xs"></i>
                            Facebook
                        </h4>
                        <p class="text-xs leading-tight mb-1">
                            Collez le <strong>nom</strong>, le <strong>prix</strong> et les <strong>caract√©ristiques</strong>.
                        </p>
                        <div class="bg-slate-50 p-2 rounded text-[10px] font-mono text-slate-600 mb-2">
                            Exemple : 2007 Citro√´n C3 ‚Ä¢ 2 300 ‚Ç¨ ‚Ä¢ 132 500 km ‚Ä¢ Manuel
                        </div>
                    </div>
                </div>
                <button @click="showIntelligentModeHelp = false" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg font-bold shadow-md transition transform active:scale-95 flex items-center justify-center gap-2 mt-3 text-sm">
                    <i class="fa-solid fa-check"></i>
                    Compris
                </button>
            </div>
        </div>
    </div>
    
    <!-- MODAL CONFIRMATION AGENDA -->
    <div v-if="confirmAgendaModal.open" class="fixed inset-0 bg-slate-900/80 z-[600] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-md text-center animate-fadeIn border-2 border-blue-100 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-32 h-32 bg-blue-50 rounded-full -mr-16 -mt-16 opacity-50"></div>
            <div class="relative z-10">
                <div class="w-20 h-20 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-xl">
                    <i class="fa-solid fa-calendar-check text-4xl"></i>
                </div>
                <h3 class="font-black text-2xl mb-3 text-slate-800">V√©rification Agenda</h3>
                <p class="text-slate-600 mb-6 font-medium leading-relaxed">
                    Ce rendez-vous n'est pas encore dans l'agenda.
                </p>
                <p class="text-slate-700 mb-8 font-bold text-lg">
                    Avez-vous bien plac√© ce rendez-vous dans l'agenda avant de valider ?
                </p>
                <div class="flex gap-3">
                    <button @click="confirmAgendaModal.open=false; if(confirmAgendaModal.onConfirm) confirmAgendaModal.onConfirm(false)" class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-700 py-4 rounded-xl font-bold shadow-md transition transform active:scale-95 flex items-center justify-center gap-2">
                        <i class="fa-solid fa-times"></i>
                        Non
                    </button>
                    <button @click="confirmAgendaModal.open=false; if(confirmAgendaModal.onConfirm) confirmAgendaModal.onConfirm(true)" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-4 rounded-xl font-bold shadow-lg transition transform active:scale-95 flex items-center justify-center gap-2">
                        <i class="fa-solid fa-check"></i>
                        Oui
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODAL RECONNEXION POUR AGENDA -->
    <div v-if="reconnectAgendaModal.open" class="fixed inset-0 bg-slate-900/80 z-[600] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-md text-center animate-fadeIn border-2 border-orange-100 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-32 h-32 bg-orange-50 rounded-full -mr-16 -mt-16 opacity-50"></div>
            <div class="relative z-10">
                <div class="w-20 h-20 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-xl animate-pulse">
                    <i class="fa-brands fa-google text-4xl"></i>
                </div>
                <h3 class="font-black text-2xl mb-3 text-slate-800">Connexion requise</h3>
                <p class="text-slate-600 mb-6 font-medium leading-relaxed">
                    Appuyez sur ce bouton pour vous reconnecter et pouvoir ajouter ce rendez-vous dans l'agenda.
                </p>
                <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
                    <p class="text-sm font-bold text-blue-800">
                        <i class="fa-solid fa-info-circle mr-2"></i>
                        D√®s que vous serez reconnect√©, le rendez-vous sera automatiquement ajout√© √† l'agenda.
                    </p>
                </div>
                <div class="flex gap-3">
                    <button @click="reconnectAgendaModal.open=false" class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-700 py-4 rounded-xl font-bold shadow-md transition transform active:scale-95 flex items-center justify-center gap-2">
                        <i class="fa-solid fa-times"></i>
                        Annuler
                    </button>
                    <button @click="handleReconnectForAgenda(reconnectAgendaModal.rdv)" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg transition transform active:scale-95 flex items-center justify-center gap-2">
                        <i class="fa-brands fa-google"></i>
                        Se reconnecter
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- GOOGLE CALENDAR DISCONNECTED MODAL -->
    <div v-if="googleCalendarDisconnectedModal.open" class="fixed inset-0 bg-slate-900/80 z-[600] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-md text-center animate-fadeIn border-2 border-orange-100 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-32 h-32 bg-orange-50 rounded-full -mr-16 -mt-16 opacity-50"></div>
            <div class="relative z-10">
                <div class="w-20 h-20 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-xl animate-pulse">
                    <i class="fa-brands fa-google text-4xl"></i>
                </div>
                <h3 class="font-black text-2xl mb-3 text-slate-800">Connexion Google Agenda requise</h3>
                <p class="text-slate-600 mb-6 font-medium leading-relaxed">
                    Votre session a expir√© ou le token a expir√©.
                </p>
                <div class="bg-slate-50 rounded-2xl p-5 mb-6 border border-slate-200 text-left">
                    <p class="text-sm font-bold text-slate-700 mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-list-check text-orange-500"></i>
                        Pour ajouter ce rendez-vous √† l'agenda :
                    </p>
                    <ol class="space-y-2 text-sm text-slate-600">
                        <li class="flex items-start gap-2">
                            <span class="font-bold text-orange-500">1.</span>
                            <span>Cliquez sur "Se connecter" ci-dessous</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="font-bold text-orange-500">2.</span>
                            <span>Autorisez l'acc√®s √† Google Calendar</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="font-bold text-orange-500">3.</span>
                            <span>Revenez sur ce rendez-vous pour le valider</span>
                        </li>
                    </ol>
                </div>
                <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
                    <p class="text-sm font-bold text-blue-800">
                        <i class="fa-solid fa-info-circle mr-2"></i>
                        Le rendez-vous a √©t√© cr√©√© avec le statut "Confirmer + Tard" et sera ajout√© √† l'agenda une fois reconnect√©.
                    </p>
                </div>
                <div class="flex gap-3">
                    <button @click="handleCloseDisconnectedModal()" class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-700 py-4 rounded-xl font-bold shadow-md transition transform active:scale-95 flex items-center justify-center gap-2">
                        <i class="fa-solid fa-times"></i>
                        {{ googleCalendarDisconnectedModal.fromWizard && googleCalendarRequired ? 'Ignorer' : 'Fermer' }}
                    </button>
                    <button @click="user.role === 'admin' ? connectGoogleCalendar() : connectProspecteurGoogleCalendar()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg transition transform active:scale-95 flex items-center justify-center gap-2">
                        <i class="fa-brands fa-google"></i>
                        Se connecter
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- WELCOME MODAL Z-INDEX FIX -->
    <!-- GLOBAL SEARCH MODAL -->
    <div v-if="globalSearchModal.open" class="fixed inset-0 bg-slate-900/80 z-[500] flex items-center justify-center p-4" @click.self="globalSearchModal.open=false; globalSearchModal.query=''">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[80vh] flex flex-col">
            <div class="p-6 border-b">
                <div class="relative">
                    <i class="fa-solid fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                    <input 
                        id="globalSearchInput"
                        v-model="globalSearchModal.query" 
                        @input="performGlobalSearch"
                        @keyup.enter="selectFirstResult"
                        placeholder="Rechercher par nom, pr√©nom, v√©hicule, t√©l√©phone, date..." 
                        class="w-full pl-12 pr-4 py-4 border-2 border-slate-200 rounded-xl text-lg font-medium outline-none focus:border-blue-500"
                        autofocus
                    >
                    <button @click="globalSearchModal.open=false; globalSearchModal.query=''" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 hover:text-red-500">
                        <i class="fa-solid fa-times text-xl"></i>
                    </button>
                </div>
                <p class="text-xs text-slate-500 mt-2">Appuyez sur Entr√©e pour s√©lectionner, ESC pour fermer</p>
            </div>
            <div class="flex-1 overflow-y-auto p-4">
                <div v-if="globalSearchModal.query && globalSearchModal.results.length === 0" class="text-center py-8 text-slate-400">
                    <i class="fa-solid fa-search text-4xl mb-2"></i>
                    <p>Aucun r√©sultat trouv√©</p>
                </div>
                <div v-else-if="globalSearchModal.results.length > 0" class="space-y-2">
                    <div 
                        v-for="(result, idx) in globalSearchModal.results" 
                        :key="result.id"
                        @click="openRdvFiche(result); globalSearchModal.open=false; globalSearchModal.query=''"
                        class="p-4 border border-slate-200 rounded-xl hover:border-blue-500 hover:bg-blue-50 cursor-pointer transition"
                        :class="idx === 0 ? 'bg-blue-50 border-blue-300' : ''"
                    >
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <div class="font-bold text-lg text-slate-800">{{ result.civilite }} {{ result.nom }}</div>
                                <div class="text-sm text-slate-600 mt-1">
                                    <span v-if="result.modele">{{ result.modele }} ‚Ä¢ </span>
                                    <span v-if="result.telephone">{{ result.telephone }} ‚Ä¢ </span>
                                    <span>{{ formatDateFr(result.date) }} √† {{ result.heure }}</span>
                                </div>
                                <div class="mt-2">
                                    <span :class="statusClass(result.statut)" class="text-xs px-2 py-1 rounded-full font-bold">{{ displayStatus(result) }}</span>
                                </div>
                            </div>
                            <i class="fa-solid fa-chevron-right text-slate-400"></i>
                        </div>
                    </div>
                </div>
                <div v-else class="text-center py-8 text-slate-400">
                    <i class="fa-solid fa-keyboard text-4xl mb-2"></i>
                    <p class="font-bold mb-1">Raccourcis disponibles</p>
                    <div class="text-xs space-y-1 mt-3">
                        <p><kbd class="bg-slate-100 px-2 py-1 rounded">Ctrl/Cmd + K</kbd> Recherche globale</p>
                        <p><kbd class="bg-slate-100 px-2 py-1 rounded">Ctrl/Cmd + N</kbd> Nouveau RDV</p>
                        <p><kbd class="bg-slate-100 px-2 py-1 rounded">ESC</kbd> Fermer</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div v-if="welcomeModal.open" class="fixed inset-0 bg-slate-900/80 z-[400] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-sm text-center pop-in border-4 border-blue-100">
            <div class="text-6xl mb-4 animate-bounce" style="animation: wave 1s ease-in-out infinite;">
                üëã
            </div>
            <h3 class="font-bold text-2xl mb-2 text-slate-800 animate-slide-in" style="animation: slideIn 0.5s ease-out;">
                {{ welcomeModal.title }}
            </h3>
            <p class="text-slate-600 font-medium mb-6">{{ welcomeModal.message }}</p>
        </div>
    </div>

    <!-- MODAL TUTORIEL PREMI√àRE CONNEXION -->

    <div v-if="tutorialModal.open" class="fixed inset-0 bg-slate-900/80 z-[450] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-lg text-center pop-in border-4 border-blue-100 relative z-[460]">
            <!-- √âTAPE 1 : Bienvenue -->
            <div v-if="tutorialModal.step === 1">
                <div class="text-6xl mb-6 animate-bounce">üëã</div>
                <h3 class="font-bold text-3xl mb-2 text-slate-800 bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                    Bonjour {{ tutorialModal.userName }} !
                </h3>
                <h4 class="font-bold text-2xl mb-6 text-blue-600">Bienvenue sur ARIA</h4>
                <p class="text-slate-700 text-lg mb-6 leading-relaxed">
                    Le service de prise de rendez-vous qui vous simplifie la vie !
                </p>
                <div class="bg-gradient-to-br from-blue-50 to-purple-50 rounded-2xl p-6 mb-6 text-left space-y-4 border-2 border-blue-200">
                    <div>
                        <p class="text-slate-800 font-bold text-lg mb-2 flex items-center gap-2">
                            <span>‚ú®</span> √Ä quoi √ßa sert ?
                        </p>
                        <p class="text-slate-700 font-medium leading-relaxed">
                            Vous allez pouvoir <strong class="text-blue-600">placer des rendez-vous</strong>, <strong class="text-blue-600">suivre vos rendez-vous</strong> et <strong class="text-blue-600">g√©rer vos rendez-vous</strong> facilement.
                    </p>
                </div>
                    <div class="pt-4 border-t-2 border-blue-200">
                        <p class="text-slate-700 font-semibold mb-3 flex items-center gap-2">
                            <span class="text-2xl">üí¨</span> Besoin d'aide ?
                        </p>
                        <p class="text-slate-600 text-sm mb-4 leading-relaxed">
                            Contactez directement <strong class="text-blue-600">C&N Solutions</strong> sur WhatsApp ou au <strong class="text-blue-600">07 56 96 95 02</strong>
                        </p>
                        <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-4 border-2 border-green-200 mb-3">
                            <p class="text-slate-700 text-sm flex items-start gap-2">
                                <span class="text-2xl mt-0.5">üé•</span>
                                <span>Une <strong>vid√©o tutoriel</strong> vous sera envoy√©e sur WhatsApp ou par email via WeTransfer pour comprendre le fonctionnement de l'application.</span>
                            </p>
                        </div>
                    </div>
                </div>
                <div class="flex gap-3 mt-6">
                    <a href="https://wa.me/33756969502?text=Bonjour%20j%27aimerais%20avoir%20la%20vid√©o%20de%20tuto%20pour%20ARIA" target="_blank" class="flex-1 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white py-4 rounded-xl font-bold text-base transition-all shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center justify-center gap-2">
                        <i class="fa-brands fa-whatsapp text-xl"></i>
                        WhatsApp
                    </a>
                    <button @click="tutorialModal.step = 2" class="flex-1 bg-gradient-to-r from-blue-600 to-purple-600 text-white py-4 rounded-xl font-bold text-lg hover:from-blue-700 hover:to-purple-700 transition-all shadow-lg hover:shadow-xl transform hover:scale-105">
                        Compris
                </button>
            </div>
            </div>

            <!-- √âTAPE 2 : Fin du tutoriel -->
            <div v-if="tutorialModal.step === 2">
                <div class="text-6xl mb-6 animate-bounce">üéâ</div>
                <h3 class="font-bold text-3xl mb-4 text-green-600">C'est bon, vous √™tes pr√™ts !</h3>
                <p class="text-slate-700 text-lg mb-6">
                    Vous pouvez maintenant commencer √† utiliser ARIA. 
                </p>
                <button @click="tutorialModal.open = false" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 text-white py-4 rounded-xl font-bold text-lg hover:from-green-700 hover:to-emerald-700 transition-all shadow-lg transform hover:scale-105">
                        Commencer <i class="fa-solid fa-check ml-2"></i>
                    </button>
            </div>
        </div>
    </div>

    <!-- MODAL VID√âO TUTORIEL -->
    <div v-if="tutorialVideoModal.open && globalSettings.tutorialVideoUrl" class="fixed inset-0 bg-slate-900/80 z-[500] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="bg-gradient-to-r from-blue-600 to-purple-600 p-4 text-white flex items-center justify-between">
                <h3 class="font-bold text-xl">üìπ Vid√©o Tutoriel - ARIA</h3>
                <button @click="tutorialVideoModal.open = false" class="text-white hover:text-slate-200 transition">
                    <i class="fa-solid fa-times text-2xl"></i>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-6">
                <div class="aspect-video w-full bg-black rounded-lg overflow-hidden">
                    <iframe 
                        :src="globalSettings.tutorialVideoUrl" 
                        class="w-full h-full" 
                        frameborder="0" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen>
                    </iframe>
                </div>
            </div>
        </div>
    </div>

    <style>
        @keyframes wave {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(20deg); }
            75% { transform: rotate(-20deg); }
        }
        @keyframes slideIn {
            0% { 
                transform: translateY(-20px);
                opacity: 0;
            }
            100% { 
                transform: translateY(0);
                opacity: 1;
            }
        }
        .animate-slide-in {
            animation: slideIn 0.5s ease-out;
        }
    </style>
    
    <!-- CANCEL MODAL Z-INDEX FIX -->
    <div v-if="cancelModal.open" class="fixed inset-0 bg-slate-900/60 z-[350] flex items-center justify-center p-4" @click.self="cancelModal.open=false; cancelModal.motif=''; cancelModal.motifCustom=''; cancelModal.selectedMotif=''; cancelModal.sendSMS=false; cancelModal.who=''">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md text-center relative">
            <button @click="cancelModal.open=false; cancelModal.motif=''; cancelModal.motifCustom=''; cancelModal.selectedMotif=''; cancelModal.sendSMS=false; cancelModal.who=''" class="absolute top-4 right-4 w-8 h-8 rounded-full hover:bg-slate-100 flex items-center justify-center text-slate-400 hover:text-slate-600 transition">
                <i class="fa-solid fa-times"></i>
            </button>
            <h3 class="font-bold text-lg mb-4">Annuler le rendez-vous</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2 text-left">Qui a annul√© ?</label>
                    <div class="flex gap-3">
                        <button @click="cancelModal.who='client'" :class="cancelModal.who==='client'?'bg-blue-600 text-white shadow-lg':'bg-slate-100 text-slate-700 hover:bg-slate-200'" class="flex-1 py-3 rounded-xl font-bold transition">Le Client</button>
                        <button @click="cancelModal.who='agence'" :class="cancelModal.who==='agence'?'bg-blue-600 text-white shadow-lg':'bg-slate-100 text-slate-700 hover:bg-slate-200'" class="flex-1 py-3 rounded-xl font-bold transition">L'Agence</button>
                    </div>
                </div>
                <!-- Motif obligatoire seulement si c'est le client qui annule -->
                <div v-if="cancelModal.who === 'client'">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2 text-left">Motif d'annulation *</label>
                    <select v-model="cancelModal.selectedMotif" @change="cancelModal.motifCustom=''" class="w-full p-3 border-2 border-slate-200 rounded-xl text-sm font-medium text-slate-700 outline-none focus:border-blue-500 bg-white">
                        <option value="">S√©lectionner un motif...</option>
                        <option v-for="motif in cancelMotifsList" :key="motif" :value="motif">{{ motif }}</option>
                        <option value="autre">Autre (saisir manuellement)</option>
                    </select>
                    <input v-if="cancelModal.selectedMotif === 'autre'" v-model="cancelModal.motifCustom" placeholder="Saisir le motif d'annulation..." class="w-full mt-3 p-3 border-2 border-slate-200 rounded-xl text-sm font-medium text-slate-700 outline-none focus:border-blue-500 bg-white">
                </div>
                <!-- Pour l'agence, pas de motif requis -->
                <div v-if="cancelModal.who === 'agence'" class="p-3 bg-blue-50 rounded-xl border border-blue-200">
                    <p class="text-sm text-blue-700 font-medium">L'annulation par l'agence ne n√©cessite pas de motif. Vous pouvez directement valider et envoyer le SMS.</p>
                </div>
                <!-- Option SMS -->
                <div v-if="cancelModal.who" class="flex items-center gap-2 p-3 bg-slate-50 rounded-xl">
                    <input type="checkbox" v-model="cancelModal.sendSMS" id="sendSMS" class="w-5 h-5 rounded border-slate-300 text-blue-600 focus:ring-blue-500">
                    <label for="sendSMS" class="text-sm font-medium text-slate-700 cursor-pointer">Envoyer un SMS au client</label>
                </div>
                <!-- Boutons de validation -->
                <div v-if="cancelModal.who" class="flex gap-3 mt-4">
                    <button @click="cancelModal.open=false; cancelModal.motif=''; cancelModal.motifCustom=''; cancelModal.selectedMotif=''; cancelModal.sendSMS=false; cancelModal.who=''" class="flex-1 bg-gray-100 text-gray-500 py-3 rounded-xl font-bold hover:bg-gray-200">Retour</button>
                    <button v-if="cancelModal.who === 'agence'" @click="confirmCancel(cancelModal.rdv, cancelModal.who, '', cancelModal.sendSMS)" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-3 rounded-xl font-bold shadow-md transition">Valider & SMS</button>
                    <button v-else @click="confirmCancel(cancelModal.rdv, cancelModal.who, cancelModal.selectedMotif === 'autre' ? cancelModal.motifCustom : cancelModal.selectedMotif, cancelModal.sendSMS)" :disabled="!cancelModal.selectedMotif || (cancelModal.selectedMotif === 'autre' && !cancelModal.motifCustom)" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-3 rounded-xl font-bold shadow-md disabled:opacity-50 disabled:cursor-not-allowed transition">Confirmer l'annulation</button>
                </div>
                <button v-if="!cancelModal.who" @click="cancelModal.open=false; cancelModal.motif=''; cancelModal.motifCustom=''; cancelModal.selectedMotif=''; cancelModal.sendSMS=false; cancelModal.who=''" class="block w-full mt-4 text-gray-400 hover:text-gray-600 text-sm font-bold">Retour</button>
            </div>
        </div>
    </div>
    
    <!-- PAUSED AGENCY Z-INDEX FIX (Z-INDEX 500 pour √™tre devant Wizard) -->
    <div v-if="pausedAgencyModal.open" class="fixed inset-0 bg-slate-900/60 z-[500] flex items-center justify-center p-4 "><div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-sm text-center animate-shake border-4 border-red-100"><div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl"><i class="fa-solid fa-ban"></i></div><h3 class="font-bold text-xl mb-2 text-slate-800">Agence Indisponible</h3><p class="text-slate-600 mb-6 font-medium">{{ getPauseMessage(pausedAgencyModal.agency) }}</p><button @click="pausedAgencyModal.open=false" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold hover:bg-slate-900 transition">Compris</button></div></div>
    
    <!-- RESCHEDULE Z-INDEX FIX -->
    <!-- MODAL CONFIRMATION RETRAIT AGENDA -->
    <div v-if="removeAgendaConfirmModal.open" class="fixed inset-0 bg-slate-900/80 z-[400] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden pop-in">
            <div class="p-6">
                <div class="flex items-center justify-center w-16 h-16 bg-red-100 rounded-full mx-auto mb-4">
                    <i class="fa-solid fa-calendar-times text-red-600 text-2xl"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-800 text-center mb-2">Retirer de l'agenda ?</h3>
                <p class="text-sm text-slate-600 text-center mb-6">√ätes-vous s√ªr de vouloir retirer ce rendez-vous de l'agenda Google Calendar ?</p>
                <div class="flex gap-3">
                    <button @click="removeAgendaConfirmModal.open=false" class="flex-1 bg-slate-100 text-slate-700 py-3 rounded-xl font-bold hover:bg-slate-200 transition">Annuler</button>
                    <button @click="confirmRemoveFromAgenda" class="flex-1 bg-red-600 text-white py-3 rounded-xl font-bold hover:bg-red-700 transition shadow-lg">Confirmer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL AJOUTER/√âDITER FERMETURE -->
    <div v-if="fermetureModal.open" class="fixed inset-0 bg-slate-900/80 z-[400] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full overflow-hidden pop-in">
            <div class="bg-gradient-to-r from-red-600 to-red-700 p-5 text-white flex justify-between items-center">
                <h3 class="font-bold text-lg flex items-center gap-2">
                    <i class="fa-solid fa-calendar-xmark"></i>
                    {{ fermetureModal.editingId ? 'Modifier la Fermeture' : 'Ajouter une Fermeture' }}
                </h3>
                <button @click="fermetureModal.open=false; fermetureModal.dateDebut=''; fermetureModal.dateFin=''; fermetureModal.motif=''; fermetureModal.tousProfessionnels=false; fermetureModal.editingId=null" class="w-8 h-8 rounded-full hover:bg-white/20 flex items-center justify-center transition">‚úï</button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-700 mb-2 block">Date de d√©but *</label>
                    <input type="date" v-model="fermetureModal.dateDebut" class="w-full p-3 border-2 border-slate-200 rounded-xl text-sm font-medium text-slate-700 outline-none focus:border-red-500">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-700 mb-2 block">Date de fin *</label>
                    <input type="date" v-model="fermetureModal.dateFin" :min="fermetureModal.dateDebut" class="w-full p-3 border-2 border-slate-200 rounded-xl text-sm font-medium text-slate-700 outline-none focus:border-red-500">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-700 mb-2 block">Motif (optionnel)</label>
                    <input type="text" v-model="fermetureModal.motif" placeholder="Ex: Cong√©s annuels, Jour f√©ri√©..." class="w-full p-3 border-2 border-slate-200 rounded-xl text-sm font-medium text-slate-700 outline-none focus:border-red-500">
                </div>
                <div class="bg-red-50 border-2 border-red-200 rounded-xl p-4">
                    <p class="text-xs text-slate-600 mb-3">
                        <i class="fa-solid fa-info-circle text-red-600 mr-2"></i>
                        <span v-if="fermetureModal.editingId">Cette fermeture sera mise √† jour dans l'agenda Google Calendar.</span>
                        <span v-else>Cette fermeture sera automatiquement ajout√©e dans l'agenda Google Calendar de <strong>tous les professionnels</strong> pour toute la journ√©e.</span>
                    </p>
                </div>
                <div class="flex gap-3">
                    <button @click="fermetureModal.open=false; fermetureModal.dateDebut=''; fermetureModal.dateFin=''; fermetureModal.motif=''; fermetureModal.tousProfessionnels=false; fermetureModal.editingId=null" class="flex-1 bg-slate-100 text-slate-700 py-3 rounded-xl font-bold hover:bg-slate-200 transition">Annuler</button>
                    <button @click="fermetureModal.editingId ? updateFermeture() : createFermeture()" :disabled="!fermetureModal.dateDebut || !fermetureModal.dateFin" class="flex-1 bg-red-600 text-white py-3 rounded-xl font-bold hover:bg-red-700 transition shadow-lg disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                        <i :class="fermetureModal.editingId ? 'fa-solid fa-save' : 'fa-solid fa-calendar-plus'"></i>
                        {{ fermetureModal.editingId ? 'Sauvegarder' : 'Cr√©er la fermeture' }}
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODAL CONFIRMATION SUPPRESSION FERMETURE -->
    <div v-if="fermetureDeleteConfirmModal.open" class="fixed inset-0 bg-slate-900/80 z-[400] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden pop-in">
            <div class="p-6">
                <div class="flex items-center justify-center w-16 h-16 bg-red-100 rounded-full mx-auto mb-4">
                    <i class="fa-solid fa-trash text-red-600 text-2xl"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-800 text-center mb-2">Supprimer la fermeture ?</h3>
                <p class="text-sm text-slate-600 text-center mb-6">√ätes-vous s√ªr de vouloir supprimer cette fermeture ? Les √©v√©nements seront retir√©s des agendas Google Calendar.</p>
                <div class="flex gap-3">
                    <button @click="fermetureDeleteConfirmModal.open=false; fermetureDeleteConfirmModal.fermetureId=null" class="flex-1 bg-slate-100 text-slate-700 py-3 rounded-xl font-bold hover:bg-slate-200 transition">Annuler</button>
                    <button @click="confirmDeleteFermeture" class="flex-1 bg-red-600 text-white py-3 rounded-xl font-bold hover:bg-red-700 transition shadow-lg">Confirmer</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODAL CONFIRMATION HEURE PROCHE FERMETURE -->
    <div v-if="heureFermetureConfirmModal.open" class="fixed inset-0 bg-slate-900/80 z-[400] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden pop-in">
            <div class="p-6">
                <div class="flex items-center justify-center w-16 h-16 bg-orange-100 rounded-full mx-auto mb-4">
                    <i class="fa-solid fa-clock text-orange-600 text-2xl"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-800 text-center mb-2">Heure proche de la fermeture</h3>
                <p class="text-sm text-slate-600 text-center mb-4">
                    L'heure s√©lectionn√©e (<strong>{{ heureFermetureConfirmModal.heure }}</strong>) est proche de l'heure de fermeture de l'agence (<strong>{{ heureFermetureConfirmModal.heureFermeture }}</strong>).
                </p>
                <p class="text-sm text-slate-500 text-center mb-6">√ätes-vous s√ªr de vouloir placer ce rendez-vous √† cette heure ?</p>
                <div class="flex gap-3">
                    <button @click="heureFermetureConfirmModal.open=false; heureFermetureConfirmModal.onConfirm=null" class="flex-1 bg-slate-100 text-slate-700 py-3 rounded-xl font-bold hover:bg-slate-200 transition">Annuler</button>
                    <button @click="confirmHeureFermeture" class="flex-1 bg-orange-600 text-white py-3 rounded-xl font-bold hover:bg-orange-700 transition shadow-lg">Oui, confirmer</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODAL HEURE LIMITE EXCEPTIONNELLE -->
    <div v-if="heureLimiteExceptionnelleModal.open" class="fixed inset-0 bg-slate-900/80 z-[500] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden pop-in">
            <div class="p-6">
                <div class="flex items-center justify-center w-16 h-16 bg-red-100 rounded-full mx-auto mb-4">
                    <i class="fa-solid fa-ban text-red-600 text-2xl"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-800 text-center mb-2">Heure limite d√©pass√©e</h3>
                <p class="text-sm text-slate-600 text-center mb-4">
                    Cette agence ne prend plus de rendez-vous √† partir de <strong>{{ heureLimiteExceptionnelleModal.heureLimite }}</strong>.
                </p>
                <p v-if="heureLimiteExceptionnelleModal.motif" class="text-sm text-slate-500 text-center mb-2 bg-slate-50 p-3 rounded-lg border border-slate-200">
                    <strong>Motif :</strong> {{ heureLimiteExceptionnelleModal.motif }}
                </p>
                <p class="text-sm text-slate-500 text-center mb-6">L'heure s√©lectionn√©e (<strong>{{ heureLimiteExceptionnelleModal.heure }}</strong>) est apr√®s cette limite.</p>
                <div class="flex gap-3">
                    <button @click="heureLimiteExceptionnelleModal.open=false" class="flex-1 bg-slate-100 text-slate-700 py-3 rounded-xl font-bold hover:bg-slate-200 transition">Fermer</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODAL CONFIRMATION HEURE APR√àS FERMETURE -->
    <div v-if="heureApresFermetureModal.open" class="fixed inset-0 bg-slate-900/80 z-[500] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden pop-in">
            <div class="p-6">
                <div class="flex items-center justify-center w-16 h-16 bg-red-100 rounded-full mx-auto mb-4">
                    <i class="fa-solid fa-clock text-red-600 text-2xl"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-800 text-center mb-2">Agence ferm√©e √† cette heure</h3>
                <p class="text-sm text-slate-600 text-center mb-4">
                    L'heure s√©lectionn√©e (<strong>{{ heureApresFermetureModal.heure }}</strong>) est apr√®s l'heure de fermeture de l'agence (<strong>{{ heureApresFermetureModal.heureFermeture }}</strong>).
                </p>
                <p class="text-sm text-slate-500 text-center mb-6">L'agence est ferm√©e √† cette heure. Souhaitez-vous vraiment placer ce rendez-vous ?</p>
                <div class="flex gap-3">
                    <button @click="heureApresFermetureModal.open=false; heureApresFermetureModal.onConfirm=null" class="flex-1 bg-slate-100 text-slate-700 py-3 rounded-xl font-bold hover:bg-slate-200 transition">Annuler</button>
                    <button @click="confirmHeureApresFermeture" class="flex-1 bg-red-600 text-white py-3 rounded-xl font-bold hover:bg-red-700 transition shadow-lg">Oui, continuer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL REPORTER RENDEZ-VOUS -->
    <div v-if="rescheduleModal.open" class="fixed inset-0 bg-slate-900/80 z-[350] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh] fade-in">
            <div class="bg-gradient-to-r from-blue-600 to-blue-700 p-5 text-white flex justify-between items-center">
                <h3 class="font-bold text-lg flex items-center gap-2">
                    <i class="fa-solid fa-calendar-xmark"></i>
                    Reporter Rendez-Vous
                </h3>
                <button @click="rescheduleModal.open=false; rescheduleModal.demandePar=''" class="w-8 h-8 rounded-full hover:bg-white/20 flex items-center justify-center transition">‚úï</button>
            </div>
            
            <div v-if="rescheduleModal.step===1" class="p-6 overflow-y-auto space-y-4 bg-white">
                <div class="bg-blue-50 border-2 border-blue-200 rounded-xl p-4 mb-4">
                    <p class="text-sm font-bold text-blue-700 text-center">RDV Actuel: {{ formatDateFr(rescheduleModal.rdv.date) }} √† {{ rescheduleModal.rdv.heure }}</p>
                </div>
                
                <!-- S√©lection type de demande -->
                <div v-if="!rescheduleModal.demandePar" class="mb-4">
                    <label class="text-xs font-bold text-slate-700 mb-3 block uppercase tracking-wide">Type de demande *</label>
                    <div class="grid grid-cols-2 gap-3">
                        <button @click="rescheduleModal.demandePar='client'" class="p-5 bg-gradient-to-br from-blue-50 to-indigo-50 border-2 border-blue-300 rounded-xl hover:border-blue-500 hover:shadow-lg transition-all text-left group">
                            <div class="text-3xl mb-2">üë§</div>
                            <div class="font-bold text-slate-800 mb-1 text-sm">√Ä la demande du client</div>
                            <div class="text-xs text-slate-600">Le client souhaite reporter</div>
                        </button>
                        <button @click="rescheduleModal.demandePar='interne'" class="p-5 bg-gradient-to-br from-purple-50 to-pink-50 border-2 border-purple-300 rounded-xl hover:border-purple-500 hover:shadow-lg transition-all text-left group">
                            <div class="text-3xl mb-2">üè¢</div>
                            <div class="font-bold text-slate-800 mb-1 text-sm">Demande interne</div>
                            <div class="text-xs text-slate-600">Report √† l'initiative de l'agence</div>
                        </button>
                    </div>
                </div>
                
                <!-- Date (pour demande client ou interne) -->
                <div v-if="rescheduleModal.demandePar === 'client' || rescheduleModal.demandePar === 'interne'">
                    <div class="mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <h5 class="text-xs font-black uppercase text-slate-500 tracking-wider">
                            <i class="fa-solid fa-calendar-alt text-blue-500"></i> Choisir le Nouveau Jour :
                        </h5>
                        <input type="date" v-model="rescheduleModal.date" @change="rescheduleModal.heure=null" class="p-1 border border-slate-200 rounded-lg text-xs font-bold text-slate-700 outline-none focus:border-blue-500 shadow-sm cursor-pointer hover:bg-blue-50">
                    </div>
                    <div class="overflow-x-auto pb-2 hide-scrollbar snap-x flex space-x-2">
                        <button v-for="d in dateOptions" :key="d.val" @click="rescheduleModal.date=d.val; rescheduleModal.heure=null;" :class="[rescheduleModal.date===d.val ? 'bg-blue-600 text-white shadow-lg transform scale-[1.05] date-card-selected' : 'bg-white border-gray-200 text-gray-600 hover:border-blue-400', d.isToday ? 'border-2 border-green-500 shadow-md' : '']" class="flex-shrink-0 w-16 h-20 rounded-lg flex flex-col items-center justify-center text-sm transition-all duration-300 snap-center date-card p-1">
                            <span :class="rescheduleModal.date===d.val ? 'text-blue-200' : 'text-slate-400'" class="text-[9px] font-bold uppercase mb-0 transition-colors">{{ d.dayName }}</span>
                            <span class="text-2xl font-black leading-none">{{ d.dayNum }}</span>
                            <span class="text-[9px] font-medium opacity-80 mt-1">{{ d.month }}</span>
                        </button>
                    </div>
                </div>
                
                <!-- Heure -->
                <div v-if="rescheduleModal.date" class="overflow-y-auto hide-scrollbar p-2 border border-slate-100 rounded-lg bg-white shadow-inner animate-fadeIn max-h-[300px]">
                    <h5 class="text-xs font-black uppercase text-slate-500 tracking-wider mb-2">
                        <i class="fa-solid fa-clock text-green-500"></i> Choisir la Nouvelle Heure (09:00 - 19:00) :
                    </h5>
                    <div class="space-y-3">
                        <div class="grid grid-cols-4 gap-2">
                            <button v-for="h in timeSlots" :key="h" @click="rescheduleModal.heure=h" :class="rescheduleModal.heure===h ? 'bg-green-500 text-white shadow-md' : 'bg-slate-50 text-slate-600 hover:bg-green-50'" class="py-1.5 rounded-md text-xs font-bold transition-all duration-200">{{ h }}</button>
                        </div>
                        <div class="pt-2 flex justify-center border-t border-slate-100">
                            <input type="time" v-model="rescheduleModal.heure" class="border-2 border-blue-100 rounded-lg p-2 font-bold text-blue-900 text-center text-sm outline-none focus:border-blue-500 bg-blue-50 w-32">
                        </div>
                    </div>
                </div>
                    <div v-else class="flex-1 flex items-center justify-center text-center text-gray-400 border border-dashed border-gray-200 rounded-2xl">
                        <p class="text-sm font-medium p-8">üìÖ Veuillez d'abord s√©lectionner une date ci-dessus.</p>
                    </div>
                </div>
                
                <!-- Motif (apr√®s date/heure pour demande client ou interne) -->
                <div v-if="(rescheduleModal.demandePar === 'client' || rescheduleModal.demandePar === 'interne') && rescheduleModal.date && rescheduleModal.heure" class="mt-4 space-y-3">
                    <label class="text-xs font-bold text-slate-700 uppercase mb-3 block tracking-wide flex items-center gap-2">
                        <i class="fa-solid fa-note-sticky text-blue-600"></i> 
                        <span>Motif du d√©placement *</span>
                    </label>
                    <div class="space-y-2">
                        <button @click="motifSelectionModal.open=true" class="w-full p-4 border-2 border-slate-200 rounded-xl text-sm font-medium text-slate-700 outline-none focus:border-blue-500 bg-white shadow-sm transition-all text-left flex items-center justify-between hover:bg-blue-50 hover:border-blue-400 hover:shadow-md group">
                            <span class="font-semibold">{{ rescheduleModal.motifType ? getMotifLabel(rescheduleModal.motifType) : 'üìã S√©lectionner un motif...' }}</span>
                            <i class="fa-solid fa-chevron-right text-slate-400 group-hover:text-blue-500 transition"></i>
                        </button>
                        <div class="relative">
                            <input v-model="rescheduleModal.motif" :placeholder="rescheduleModal.motifType === 'autre' ? 'Saisissez votre motif personnalis√©...' : 'Le motif sera automatiquement rempli selon votre s√©lection'" :readonly="rescheduleModal.motifType !== 'autre' && rescheduleModal.motifType !== ''" :class="!rescheduleModal.motif ? 'border-red-300 focus:border-red-400' : 'border-slate-200 focus:border-blue-500'" class="w-full p-3.5 border-2 rounded-xl text-sm font-medium text-slate-700 outline-none transition-all bg-white" :style="rescheduleModal.motifType !== 'autre' && rescheduleModal.motifType !== '' ? 'background-color: #f8fafc; cursor: not-allowed;' : ''" required>
                        </div>
                        
                        <!-- Aper√ßu SMS automatique complet (pour demande interne) - D√©roulable -->
                        <div v-if="rescheduleModal.demandePar === 'interne' && rescheduleModal.motifType && rescheduleModal.smsMessage" class="bg-gradient-to-br from-blue-50 to-indigo-50 border-2 border-blue-300 rounded-xl mt-3 shadow-sm overflow-hidden">
                            <button @click="openMotifs['sms_preview_reschedule'] = !openMotifs['sms_preview_reschedule']" class="w-full flex items-center justify-between p-4 hover:bg-blue-100/50 transition">
                                <div class="flex items-center gap-2">
                                    <i class="fa-solid fa-comment-sms text-blue-600 text-lg"></i>
                                    <span class="text-sm font-bold text-blue-700">Aper√ßu du message SMS</span>
                                </div>
                                <i :class="openMotifs['sms_preview_reschedule'] ? 'fa-solid fa-chevron-up' : 'fa-solid fa-chevron-down'" class="text-blue-600 transition-transform"></i>
                            </button>
                            <div v-show="openMotifs['sms_preview_reschedule']" class="px-4 pb-4 border-t border-blue-200 animate-fadeIn">
                                <div class="text-sm text-slate-800 bg-white p-4 rounded-lg border-2 border-blue-200 whitespace-pre-line font-medium leading-relaxed shadow-inner mt-3">{{ rescheduleModal.smsMessage }}</div>
                            </div>
                        </div>
                        <div v-else-if="rescheduleModal.demandePar === 'interne' && rescheduleModal.motifType && !rescheduleModal.smsMessage" class="bg-slate-50 border-2 border-slate-200 rounded-xl p-3 mt-3">
                            <p class="text-xs text-slate-500 italic">Aucun message SMS automatique configur√© pour ce motif.</p>
                        </div>
                        <!-- Aper√ßu d√©roulable pour demande client (motif pour Google Agenda) -->
                        <div v-else-if="rescheduleModal.demandePar === 'client' && rescheduleModal.motifType && rescheduleModal.motif" class="bg-gradient-to-br from-purple-50 to-indigo-50 border-2 border-purple-300 rounded-xl mt-3 shadow-sm overflow-hidden">
                            <button @click="openMotifs['motif_preview_client'] = !openMotifs['motif_preview_client']" class="w-full flex items-center justify-between p-4 hover:bg-purple-100/50 transition">
                                <div class="flex items-center gap-2">
                                    <i class="fa-solid fa-file-lines text-purple-600 text-lg"></i>
                                    <span class="text-sm font-bold text-purple-700">Aper√ßu du motif (Google Agenda)</span>
                                </div>
                                <i :class="openMotifs['motif_preview_client'] ? 'fa-solid fa-chevron-up' : 'fa-solid fa-chevron-down'" class="text-purple-600 transition-transform"></i>
                            </button>
                            <div v-show="openMotifs['motif_preview_client']" class="px-4 pb-4 border-t border-purple-200 animate-fadeIn">
                                <div class="text-sm text-slate-800 bg-white p-4 rounded-lg border-2 border-purple-200 whitespace-pre-line font-medium leading-relaxed shadow-inner mt-3">{{ rescheduleModal.motif }}</div>
                            </div>
                        </div>
                        <div v-else-if="rescheduleModal.demandePar === 'client' && rescheduleModal.motifType && !rescheduleModal.motif" class="bg-slate-50 border-2 border-slate-200 rounded-xl p-3 mt-3">
                            <p class="text-xs text-slate-500 italic">Le motif sera enregistr√© dans Google Agenda et la fiche du rendez-vous. Aucun SMS ne sera envoy√© pour un report √† la demande du client.</p>
                        </div>
                    </div>
                </div>
                
                <div class="flex gap-2 mt-4">
                    <button @click="rescheduleModal.open=false; rescheduleModal.demandePar=''" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-bold hover:bg-gray-300">Annuler</button>
                    <button @click="confirmRescheduleStep1" :disabled="!rescheduleModal.demandePar || ((rescheduleModal.demandePar === 'client' || rescheduleModal.demandePar === 'interne') && (!rescheduleModal.date || !rescheduleModal.heure || (rescheduleModal.date === rescheduleModal.rdv.date && rescheduleModal.heure === rescheduleModal.rdv.heure))) || !rescheduleModal.motif || rescheduleModal.motif.trim() === ''" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold shadow-md flex items-center justify-center gap-2 transition transform active:scale-95 disabled:opacity-50">Confirmer Report <i class="fa-solid fa-arrow-right"></i></button>
                </div>
            </div>
            
            <div v-if="rescheduleModal.step===2" class="p-8 text-center animate-fadeIn flex flex-col items-center justify-center h-full">
                <div class="w-20 h-20 bg-green-100 text-green-500 text-4xl rounded-full flex items-center justify-center mb-6 shadow-lg shadow-green-200/50 animate-bounce">
                    <i class="fa-solid fa-check"></i>
                </div>
                <h4 class="text-2xl font-black text-slate-800 mb-2">Report valid√© !</h4>
                <p class="text-slate-600 font-medium mb-8 max-w-xs mx-auto">Le rendez-vous a bien √©t√© d√©plac√© au <br><strong class="text-blue-600">{{ formatDateLong(rescheduleModal.rdv.date) }} √† {{ rescheduleModal.rdv.heure }}</strong>.</p>
                <div class="bg-slate-50 p-6 rounded-2xl border border-slate-100 w-full">
                    <p class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-4">Voulez-vous pr√©venir le client ?</p>
                    <div class="grid grid-cols-1 gap-3">
                        <button @click="sendRescheduleSMS" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold hover:bg-blue-700 shadow-lg shadow-blue-200 transition transform active:scale-95 flex items-center justify-center gap-3">
                            <i class="fa-solid fa-comment-sms text-xl"></i> OUI, envoyer le SMS
                        </button>
                        <button @click="rescheduleModal.open=false; clientModal.open=false; rescheduleModal.step=1" class="w-full bg-white text-slate-400 border-2 border-slate-100 py-3 rounded-xl font-bold hover:bg-slate-50 hover:text-slate-600 transition">Non, revenir au RDV</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL SELECTION MOTIF MODERNE -->
    <div v-if="motifSelectionModal.open" class="fixed inset-0 bg-slate-900/80 z-[400] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl max-w-lg w-full max-h-[85vh] overflow-hidden flex flex-col">
            <div class="bg-gradient-to-r from-blue-600 to-blue-700 p-5 text-white flex justify-between items-center">
                <h3 class="font-bold text-lg flex items-center gap-2">
                    <i class="fa-solid fa-list-check"></i>
                    S√©lectionner un Motif
                </h3>
                <button @click="motifSelectionModal.open=false" class="w-8 h-8 rounded-full hover:bg-white/20 flex items-center justify-center transition">‚úï</button>
            </div>
            <div class="flex-1 overflow-y-auto p-5 bg-gradient-to-b from-slate-50 to-white">
                <div class="space-y-2">
                    <button v-for="(label, motifType) in (rescheduleModal.demandePar === 'interne' ? rescheduleMotifsListInterne : rescheduleMotifsList)" :key="motifType" @click="selectMotif(motifType)" class="w-full p-4 bg-white border-2 border-slate-200 rounded-xl hover:border-blue-500 hover:bg-blue-50 hover:shadow-md transition-all text-left group">
                        <div class="font-bold text-slate-800 text-sm">{{ label }}</div>
                        <i class="fa-solid fa-chevron-right text-slate-300 group-hover:text-blue-500 float-right mt-[-20px] transition"></i>
                    </button>
                    <button @click="selectMotif('autre')" class="w-full p-4 bg-white border-2 border-slate-200 rounded-xl hover:border-blue-500 hover:bg-blue-50 hover:shadow-md transition-all text-left group">
                        <div class="font-bold text-slate-800 text-sm">‚úèÔ∏è Autre</div>
                        <i class="fa-solid fa-chevron-right text-slate-300 group-hover:text-blue-500 float-right mt-[-20px] transition"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL SELECTION MOTIF MODERNE (SUPPRIM√â - REMPLAC√â PAR VERSION MINIMALISTE) -->
    <div v-if="false && motifSelectionModal.open" class="fixed inset-0 bg-slate-900/80 z-[400] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden flex flex-col">
            <div class="bg-gradient-to-r from-blue-500 to-blue-600 p-5 text-white flex justify-between items-center">
                <h3 class="font-bold text-lg flex items-center gap-2">
                    <i class="fa-solid fa-list-check"></i>
                    S√©lectionner un Motif
                </h3>
                <button @click="motifSelectionModal.open=false" class="w-8 h-8 rounded-full hover:bg-white/20 flex items-center justify-center transition">‚úï</button>
            </div>
            <div class="flex-1 overflow-y-auto p-6">
                <div class="space-y-4">
                    <!-- M√©t√©o -->
                    <div>
                        <h4 class="text-xs font-bold text-slate-500 uppercase mb-3 flex items-center gap-2">
                            <span class="text-lg">üå¶Ô∏è</span> M√©t√©o
                        </h4>
                        <button @click="selectMotif('meteo_route_dangereuse')" class="w-full p-4 bg-white border-2 border-slate-200 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition text-left flex items-center justify-between group">
                            <div>
                                <div class="font-bold text-slate-800">‚ö†Ô∏è Conditions de la route dangereuse</div>
                                <div class="text-xs text-slate-500 mt-1">Neige, verglas ou forte inondations</div>
                            </div>
                            <i class="fa-solid fa-chevron-right text-slate-400 group-hover:text-blue-500"></i>
                        </button>
                    </div>
                    
                    <!-- V√©hicule -->
                    <div>
                        <h4 class="text-xs font-bold text-slate-500 uppercase mb-3 flex items-center gap-2">
                            <span class="text-lg">üöó</span> V√©hicule
                        </h4>
                        <button @click="selectMotif('vehicule_immobilise')" class="w-full p-4 bg-white border-2 border-slate-200 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition text-left flex items-center justify-between group">
                            <div>
                                <div class="font-bold text-slate-800">üîß V√©hicule immobilis√©</div>
                                <div class="text-xs text-slate-500 mt-1">Le v√©hicule ne peut pas bouger</div>
                            </div>
                            <i class="fa-solid fa-chevron-right text-slate-400 group-hover:text-blue-500"></i>
                        </button>
                    </div>
                    
                    <!-- Contrainte professionnelle -->
                    <div>
                        <h4 class="text-xs font-bold text-slate-500 uppercase mb-3 flex items-center gap-2">
                            <span class="text-lg">üíº</span> Contrainte professionnelle
                        </h4>
                        <button @click="selectMotif('contrainte_pro')" class="w-full p-4 bg-white border-2 border-slate-200 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition text-left flex items-center justify-between group">
                            <div>
                                <div class="font-bold text-slate-800">üìû Urgence personnel</div>
                                <div class="text-xs text-slate-500 mt-1">R√©union de derni√®re minute, ne peut pas quitter son poste</div>
                            </div>
                            <i class="fa-solid fa-chevron-right text-slate-400 group-hover:text-blue-500"></i>
                        </button>
                    </div>
                    
                    <!-- Contrainte personnelle -->
                    <div>
                        <h4 class="text-xs font-bold text-slate-500 uppercase mb-3 flex items-center gap-2">
                            <span class="text-lg">üë§</span> Contrainte personnelle
                        </h4>
                        <button @click="selectMotif('contrainte_personnelle')" class="w-full p-4 bg-white border-2 border-slate-200 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition text-left flex items-center justify-between group">
                            <div>
                                <div class="font-bold text-slate-800">üè† Contrainte personnelle</div>
                                <div class="text-xs text-slate-500 mt-1">Ne peut pas se d√©placer pour des raisons personnelles</div>
                            </div>
                            <i class="fa-solid fa-chevron-right text-slate-400 group-hover:text-blue-500"></i>
                        </button>
                    </div>
                    
                    <!-- Probl√®me d'organisation -->
                    <div>
                        <h4 class="text-xs font-bold text-slate-500 uppercase mb-3 flex items-center gap-2">
                            <span class="text-lg">üìÑ</span> Probl√®me d'organisation
                        </h4>
                        <button @click="selectMotif('documents_manquants')" class="w-full p-4 bg-white border-2 border-slate-200 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition text-left flex items-center justify-between group">
                            <div>
                                <div class="font-bold text-slate-800">üìã Oubli des documents</div>
                                <div class="text-xs text-slate-500 mt-1">Le client n'a pas tous les documents</div>
                            </div>
                            <i class="fa-solid fa-chevron-right text-slate-400 group-hover:text-blue-500"></i>
                        </button>
                    </div>
                    
                    <!-- Emp√™chement m√©dical -->
                    <div>
                        <h4 class="text-xs font-bold text-slate-500 uppercase mb-3 flex items-center gap-2">
                            <span class="text-lg">üè•</span> Emp√™chement m√©dical
                        </h4>
                        <button @click="selectMotif('empechement_medical')" class="w-full p-4 bg-white border-2 border-slate-200 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition text-left flex items-center justify-between group">
                            <div>
                                <div class="font-bold text-slate-800">üíä Motif de sant√©</div>
                                <div class="text-xs text-slate-500 mt-1">Incapacit√© de conduire, maladie, blessure</div>
                            </div>
                            <i class="fa-solid fa-chevron-right text-slate-400 group-hover:text-blue-500"></i>
                        </button>
                    </div>
                    
                    <!-- Autre -->
                    <div>
                        <button @click="selectMotif('autre')" class="w-full p-4 bg-white border-2 border-slate-200 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition text-left flex items-center justify-between group">
                            <div>
                                <div class="font-bold text-slate-800">‚úèÔ∏è Autre</div>
                                <div class="text-xs text-slate-500 mt-1">Motif personnalis√©</div>
                            </div>
                            <i class="fa-solid fa-chevron-right text-slate-400 group-hover:text-blue-500"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- BILAN MODALES -->
    <div v-if="bilanEditModal.open" class="fixed inset-0 bg-slate-900/80 z-[350] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg">Modifier RDV</h3>
                <button @click="bilanEditModal.open=false" class="text-slate-400 hover:text-slate-600">√ó</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">Date</label>
                    <input type="date" v-model="bilanEditModal.form.date" class="w-full px-4 py-2 border-2 border-slate-200 rounded-xl">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">Agence</label>
                    <input type="text" v-model="bilanEditModal.form.agence" readonly class="w-full px-4 py-2 border-2 border-slate-200 rounded-xl bg-slate-50">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Commercial</label>
                        <input type="text" v-model="bilanEditModal.form.commercial" class="w-full px-4 py-2 border-2 border-slate-200 rounded-xl">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Tarif</label>
                        <input type="number" v-model.number="bilanEditModal.form.tarif" class="w-full px-4 py-2 border-2 border-slate-200 rounded-xl">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">Nombre RDV</label>
                    <input type="number" v-model.number="bilanEditModal.form.rdv" class="w-full px-4 py-2 border-2 border-slate-200 rounded-xl text-center font-bold text-lg">
                </div>
                <div class="bg-orange-50 p-3 rounded-xl border border-orange-200">
                    <label class="block text-xs font-bold text-orange-700 mb-2">FACTURATION</label>
                    <button type="button" @click="bilanEditModal.form.reporte = !bilanEditModal.form.reporte" :class="bilanEditModal.form.reporte ? 'bg-orange-100 text-orange-700 border-orange-300' : 'bg-slate-100 text-slate-700 border-slate-300'" class="w-full px-4 py-2 rounded-xl font-bold border-2">
                        {{ bilanEditModal.form.reporte ? 'OUI (Report M+1)' : 'NON (Mois en cours)' }}
                    </button>
                </div>
                <button @click="saveBilanEdit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold">Valider</button>
            </div>
        </div>
    </div>

    <div v-if="bilanSettingsModal.open" class="fixed inset-0 bg-slate-900/80 z-[350] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg">R√©glages Bilan & TVA</h3>
                <button @click="bilanSettingsModal.open=false" class="text-slate-400 hover:text-slate-600">√ó</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-2">Logo (Haut PDF)</label>
                    <input type="file" accept="image/*" @change="handleBilanLogo" class="w-full">
                    <img v-if="bilanConfig.logo" :src="bilanConfig.logo" class="mt-2 w-20 h-20 object-contain border border-slate-200 rounded">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-2">Cachet / Signature (Bas PDF)</label>
                    <input type="file" accept="image/*" @change="handleBilanSignature" class="w-full">
                    <img v-if="bilanConfig.signature" :src="bilanConfig.signature" class="mt-2 w-32 h-16 object-contain border border-slate-200 rounded">
                </div>
                <div class="flex items-center gap-3 p-4 border-2 border-slate-200 rounded-xl cursor-pointer" @click="bilanConfig.tvaActive = !bilanConfig.tvaActive">
                    <i :class="bilanConfig.tvaActive ? 'fa-solid fa-check-circle text-green-600' : 'fa-regular fa-circle text-slate-400'" class="text-xl"></i>
                    <div class="flex-1">
                        <div class="font-bold">Assujetti √† la TVA</div>
                        <div class="text-xs text-slate-500">Activer le calcul automatique</div>
                    </div>
                </div>
                <div v-if="bilanConfig.tvaActive" class="space-y-3 bg-slate-50 p-4 rounded-xl">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Taux de TVA (%)</label>
                        <input type="number" v-model.number="bilanConfig.tvaRate" class="w-full px-4 py-2 border-2 border-slate-200 rounded-xl">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Date d√©but TVA</label>
                        <input type="date" v-model="bilanConfig.tvaStart" class="w-full px-4 py-2 border-2 border-slate-200 rounded-xl">
                        <div class="text-xs text-slate-500 mt-1">(La TVA s'appliquera aux RDV apr√®s cette date)</div>
                    </div>
                </div>
                <button @click="saveBilanSettings" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold">Enregistrer</button>
            </div>
        </div>
    </div>

    <div v-if="bilanModal.open" class="fixed inset-0 bg-slate-900/80 z-[350] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg">Bilans & Objectifs</h3>
                <button @click="bilanModal.open=false" class="text-slate-400 hover:text-slate-600">√ó</button>
            </div>
            <div class="flex gap-3 mb-4">
                <button @click="setBilanPeriod('month')" :class="bilanPeriod==='month' ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-700'" class="flex-1 px-4 py-2 rounded-xl font-bold">Mois</button>
                <button @click="setBilanPeriod('year')" :class="bilanPeriod==='year' ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-700'" class="flex-1 px-4 py-2 rounded-xl font-bold">Ann√©e</button>
            </div>
            <div id="bilanContent" class="space-y-4"></div>
        </div>
    </div>

    <!-- Modal Assigner Commercial Urgent -->
    <div v-if="urgentCommercialModal.open" class="fixed inset-0 bg-slate-900/80 z-[350] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg text-orange-600">Assigner un commercial</h3>
                <button @click="urgentCommercialModal.open=false" class="text-slate-400 hover:text-slate-600">√ó</button>
            </div>
            <div class="space-y-4">
                <div>
                    <p class="text-sm text-slate-600 mb-2"><strong>Agence:</strong> {{ urgentCommercialModal.rdv?.agence }}</p>
                    <p class="text-sm text-slate-600 mb-4"><strong>Date:</strong> {{ formatBilanDate(urgentCommercialModal.rdv?.date) }}</p>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-700 mb-2">Quel commercial a sign√© ?</label>
                    <select v-model="urgentCommercialModal.commercial" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl text-sm font-medium focus:border-blue-500 outline-none">
                        <option value="">-- S√©lectionner --</option>
                        <option v-for="comm in getUrgentCommerciaux()" :key="comm" :value="comm">{{ comm }}</option>
                    </select>
                </div>
                <div class="flex gap-3">
                    <button @click="urgentCommercialModal.open=false" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-700 py-3 rounded-xl font-bold">Annuler</button>
                    <button @click="saveUrgentCommercial" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-bold">Valider</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Objectif -->
    <div v-if="objectifModal.open" class="fixed inset-0 bg-slate-900/80 z-[350] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg text-green-600">D√©finir un objectif</h3>
                <button @click="objectifModal.open=false" class="text-slate-400 hover:text-slate-600">√ó</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-700 mb-2">Agence *</label>
                    <select v-model="objectifModal.agenceId" @change="onObjectifAgenceChange" required class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl text-sm font-medium focus:border-green-500 outline-none">
                        <option value="">-- S√©lectionner une agence --</option>
                        <option v-for="ag in agences" :key="ag.id" :value="ag.id">{{ ag.nom }}</option>
                    </select>
                </div>
                <div v-if="objectifModal.agenceId && hasObjectifCommerciaux()">
                    <label class="block text-xs font-bold text-slate-700 mb-2">Commercial</label>
                    <select v-model="objectifModal.commercial" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl text-sm font-medium focus:border-green-500 outline-none">
                        <option value="">Objectif pour toute l'agence</option>
                        <option v-for="comm in getObjectifCommerciaux()" :key="comm" :value="comm">{{ comm }}</option>
                    </select>
                    <p class="text-xs text-slate-500 mt-1">Laissez vide pour d√©finir un objectif global √† l'agence</p>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-700 mb-2">Objectif (nombre de RDV) *</label>
                    <input type="number" v-model.number="objectifModal.objectif" min="1" required class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl text-sm font-medium focus:border-green-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-700 mb-2">P√©riode</label>
                    <select v-model="objectifModal.periode" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl text-sm font-medium focus:border-green-500 outline-none">
                        <option value="month">Mensuel</option>
                        <option value="year">Annuel</option>
                    </select>
                </div>
                <div class="flex gap-3">
                    <button @click="objectifModal.open=false" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-700 py-3 rounded-xl font-bold">Annuler</button>
                    <button @click="saveObjectif" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-bold">Enregistrer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Tarifs Personnalis√©s -->
    <div v-if="tarifPersonnaliseModal.open" class="fixed inset-0 bg-slate-900/80 z-[350] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg text-purple-600">Tarifs personnalis√©s par agence</h3>
                <button @click="tarifPersonnaliseModal.open=false" class="text-slate-400 hover:text-slate-600">√ó</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-700 mb-2">Agence *</label>
                    <select v-model="tarifPersonnaliseModal.agenceId" required class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl text-sm font-medium focus:border-purple-500 outline-none">
                        <option value="">-- S√©lectionner une agence --</option>
                        <option v-for="ag in agences" :key="ag.id" :value="ag.id">{{ ag.nom }}</option>
                    </select>
                </div>
                <div class="bg-purple-50 p-4 rounded-xl border border-purple-200">
                    <p class="text-sm text-slate-700 mb-4">
                        <i class="fa-solid fa-info-circle text-purple-600 mr-2"></i>
                        D√©finissez des tarifs progressifs. Exemple : 50‚Ç¨ pour les premiers RDV, puis 60‚Ç¨ √† partir du 21e RDV.
                    </p>
                    <div class="space-y-3">
                        <div v-for="(tarif, idx) in tarifPersonnaliseModal.tarifs" :key="idx" class="flex gap-3 items-center bg-white p-3 rounded-xl border border-purple-200">
                            <div class="flex-1">
                                <label class="block text-xs font-bold text-slate-600 mb-1">√Ä partir du RDV n¬∞</label>
                                <input type="number" v-model.number="tarif.rdvMin" min="1" class="w-full px-3 py-2 border-2 border-slate-200 rounded-lg text-sm focus:border-purple-500 outline-none">
                            </div>
                            <div class="flex-1">
                                <label class="block text-xs font-bold text-slate-600 mb-1">Tarif (‚Ç¨)</label>
                                <input type="number" v-model.number="tarif.montant" min="0" step="0.01" class="w-full px-3 py-2 border-2 border-slate-200 rounded-lg text-sm focus:border-purple-500 outline-none">
                            </div>
                            <button @click="removeTarifPersonnalise(idx)" v-if="tarifPersonnaliseModal.tarifs.length > 1" class="text-red-600 hover:text-red-800 font-bold text-xl px-2">√ó</button>
                        </div>
                        <button @click="addTarifPersonnalise" class="w-full bg-purple-100 hover:bg-purple-200 text-purple-700 py-2 rounded-xl font-bold text-sm flex items-center justify-center gap-2">
                            <i class="fa-solid fa-plus"></i> Ajouter un palier
                        </button>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button @click="tarifPersonnaliseModal.open=false" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-700 py-3 rounded-xl font-bold">Annuler</button>
                    <button @click="saveTarifPersonnalise" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-xl font-bold">Enregistrer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- HONOR MODAL Z-INDEX FIX -->
    <div v-if="honorModal.open" class="fixed inset-0 bg-slate-900/80 z-[350] flex items-center justify-center p-4 ">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-sm text-center pop-in border border-slate-200 relative overflow-hidden">
            <div class="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-xl animate-pulse">
                <i class="fa-solid fa-file-signature text-3xl"></i>
            </div>
            <h3 class="font-bold text-2xl mb-2 text-slate-800">Rendez-vous honor√© ?</h3>
            <p class="text-slate-500 font-medium mb-4">Le client a-t-il sign√© un Mandat (OK M) ?</p>
            
            <!-- S√©lection du commercial si n√©cessaire -->
            <div v-if="honorModal.needsCommercial" class="mb-6 text-left">
                <label class="block text-xs font-bold text-slate-700 mb-2">Quel commercial a sign√© ? <span class="text-red-600">*</span></label>
                <select v-model="honorModal.commercial" @change="honorModal.error = ''" required :class="honorModal.error ? 'border-red-500' : 'border-slate-200'" class="w-full px-4 py-2 border-2 rounded-xl text-sm font-medium focus:border-blue-500 outline-none">
                    <option value="">-- S√©lectionner --</option>
                    <option value="Je ne sais pas">Je ne sais pas</option>
                    <option v-for="comm in getHonorCommerciaux()" :key="comm" :value="comm">{{ comm }}</option>
                </select>
                <p v-if="honorModal.error" class="text-xs text-red-600 mt-2 font-bold flex items-center gap-1">
                    <i class="fa-solid fa-exclamation-circle"></i>
                    {{ honorModal.error }}
                </p>
                <p v-else-if="user.role === 'admin'" class="text-xs text-orange-600 mt-2 font-medium flex items-center gap-1">
                    <i class="fa-solid fa-exclamation-triangle"></i>
                    Si vous choisissez "Je ne sais pas", le RDV sera dans "√Ä traiter urgent" du Bilan jusqu'√† ce qu'un commercial soit assign√©.
                </p>
                <p v-else class="text-xs text-orange-600 mt-2 font-medium flex items-center gap-1">
                    <i class="fa-solid fa-exclamation-triangle"></i>
                    De temps en temps, v√©rifiez si le commercial a mis son nom et allez dans "√Ä traiter" pour mettre son nom et valider. Sinon, les g√©rants C&N Solutions prendront le relais √† la fin du mois si vous ne l'avez pas fait.
                </p>
            </div>
            
            <div class="space-y-3">
                <button @click="finalizeHonor(true)" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-blue-200 hover:bg-blue-700 transition transform active:scale-95 flex items-center justify-center gap-3">
                    <i class="fa-solid fa-check-double text-xl"></i> ‚úÖ Oui, avec Mandat (OK M)
                </button>
                <button @click="finalizeHonor(false)" class="w-full bg-green-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-green-200 hover:bg-green-700 transition transform active:scale-95 flex items-center justify-center gap-3">
                    <i class="fa-solid fa-check-circle text-xl"></i> Oui, honor√© (sans mandat)
                </button>
                <button @click="honorModal.open=false" class="w-full bg-white text-slate-600 border-2 border-slate-200 py-3 rounded-xl font-bold hover:bg-slate-50 hover:text-slate-800 transition">
                   Annuler
                </button>
            </div>
        </div>
    </div>

    <!-- NOTIFICATION TOAST MODERNE -->
    <transition name="toast">
        <div v-if="notificationToast.open" class="fixed top-4 right-4 z-[400] max-w-md">
            <div class="bg-white rounded-2xl shadow-2xl border-2 overflow-hidden animate-slide-in-right cursor-pointer" 
                 :class="notificationToast.type === 'success' ? 'border-green-300' : notificationToast.type === 'warning' ? 'border-orange-300' : 'border-blue-300'"
                 @click="notificationToast.actionUrl ? (changeView(notificationToast.actionUrl), notificationToast.open = false) : null">
                <div class="flex items-center gap-4 p-4">
                    <div class="flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center text-xl"
                         :class="notificationToast.type === 'success' ? 'bg-green-100 text-green-600' : notificationToast.type === 'warning' ? 'bg-orange-100 text-orange-600' : 'bg-blue-100 text-blue-600'">
                        <i :class="'fa-solid ' + notificationToast.icon"></i>
                    </div>
                    <div class="flex-1">
                        <p class="font-bold text-slate-800 text-sm leading-tight">{{ notificationToast.message }}</p>
                        <button v-if="notificationToast.actionUrl" @click.stop="changeView(notificationToast.actionUrl); notificationToast.open = false" class="mt-2 bg-blue-600 hover:bg-blue-700 text-white text-xs px-3 py-1.5 rounded-lg font-bold transition">
                            <i class="fa-solid fa-eye mr-1"></i> Voir
                        </button>
                    </div>
                    <button @click.stop="notificationToast.open = false" class="flex-shrink-0 text-slate-400 hover:text-slate-600 transition">
                        <i class="fa-solid fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
    </transition>

    <!-- MODALE √âDITION CLIENT - VERSION OPTIMIS√âE ORDINATEUR -->
    <div v-if="editModal.open" class="fixed inset-0 bg-slate-900/80 z-[350] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-3xl rounded-2xl shadow-2xl overflow-hidden flex flex-col pop-in max-h-[90vh]">
            <div class="bg-gradient-to-r from-slate-800 to-slate-700 p-4 md:p-5 text-white flex justify-between items-center flex-shrink-0">
                <h3 class="font-bold text-lg md:text-xl flex items-center gap-2">
                    <i class="fa-solid fa-pencil"></i>
                    Modifier les informations du client
                </h3>
                <button @click="editModal.open=false" class="w-8 h-8 rounded-full hover:bg-white/20 flex items-center justify-center transition text-lg">‚úï</button>
            </div>
            <div class="flex-1 overflow-y-auto p-5 md:p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                    <!-- Colonne gauche -->
                    <div class="space-y-4">
                <div>
                            <label class="text-xs font-bold text-gray-600 uppercase mb-2 block">Civilit√©</label>
                    <div class="flex gap-3">
                                <button @click="editModal.form.civilite='M.'" :class="editModal.form.civilite==='M.'?'bg-blue-600 text-white shadow-lg':'bg-slate-100 text-slate-600 hover:bg-slate-200'" class="flex-1 py-3 rounded-xl font-bold transition">Monsieur</button>
                                <button @click="editModal.form.civilite='Mme'" :class="editModal.form.civilite==='Mme'?'bg-pink-500 text-white shadow-lg':'bg-slate-100 text-slate-600 hover:bg-slate-200'" class="flex-1 py-3 rounded-xl font-bold transition">Madame</button>
                    </div>
                </div>
                <div>
                            <label class="text-xs font-bold text-gray-600 uppercase mb-2 block">Nom complet</label>
                    <input v-model="editModal.form.nom" @input="formatNameRealTimeEdit" @blur="onEditModalNameBlur" @paste="onEditModalNamePaste" class="w-full p-3 border-2 border-slate-200 rounded-xl font-bold text-slate-800 outline-none focus:border-blue-500">
                </div>
                <div>
                            <label class="text-xs font-bold text-gray-600 uppercase mb-2 block">T√©l√©phone</label>
                            <input v-model="editModal.form.telephone" type="tel" class="w-full p-3 border-2 border-slate-200 rounded-xl font-bold text-slate-800 outline-none focus:border-blue-500">
                </div>
                <div>
                            <label class="text-xs font-bold text-gray-600 uppercase mb-2 block">Agence</label>
                    <select v-model="editModal.form.agenceId" class="w-full p-3 border-2 border-slate-200 rounded-xl font-bold text-slate-800 outline-none focus:border-blue-500 bg-white">
                        <option v-for="ag in visibleAgencies" :key="ag.id" :value="ag.id">{{ ag.nom }}</option>
                    </select>
                </div>
                <div>
                            <label class="text-xs font-bold text-gray-600 uppercase mb-2 block">Source</label>
                    <div class="flex flex-wrap gap-2">
                                <button v-for="src in sourcesList" :key="src" @click="editModal.form.source=src" :class="editModal.form.source===src ? 'bg-blue-600 text-white shadow-md' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'" class="px-4 py-2 rounded-lg text-xs font-bold transition">
                            {{ src }}
                        </button>
                    </div>
                </div>
            </div>
                    
                    <!-- Colonne droite -->
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs font-bold text-gray-600 uppercase mb-2 block">Mod√®le du v√©hicule</label>
                            <input v-model="editModal.form.baseModele" @input="updateEditModalModele" placeholder="Marque, Mod√®le, Finition..." class="w-full p-3 border-2 border-slate-200 rounded-xl font-bold text-slate-800 outline-none focus:border-blue-500">
                        </div>
                        <div class="bg-slate-50 p-3 rounded-xl border-2 border-slate-200">
                            <div class="flex items-center justify-between mb-2.5">
                                <label class="text-xs font-bold text-gray-600 uppercase">Caract√©ristiques</label>
                                <button @click="addNewCaracteristique" class="px-2.5 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-[10px] font-bold transition flex items-center gap-1">
                                    <i class="fa-solid fa-plus text-[9px]"></i>
                                    Ajouter
                                </button>
                            </div>
                            <div v-if="editModal.form.caracteristiques && editModal.form.caracteristiques.length > 0" class="space-y-2">
                                <div v-for="(carac, idx) in editModal.form.caracteristiques" :key="idx" class="flex items-center gap-1.5">
                                    <input v-model="carac.label" @input="updateEditModalModele" placeholder="Label" maxlength="20" class="w-28 flex-shrink-0 p-1.5 border-2 border-slate-200 rounded-lg text-xs font-bold text-slate-800 outline-none focus:border-blue-500">
                                    <span class="text-slate-600 flex-shrink-0 text-xs">:</span>
                                    <input v-model="carac.value" @input="updateEditModalModele" placeholder="Valeur" class="flex-1 min-w-0 p-1.5 border-2 border-slate-200 rounded-lg text-xs text-slate-800 outline-none focus:border-blue-500">
                                    <button @click="removeCaracteristique(idx)" class="w-6 h-6 flex-shrink-0 bg-red-100 hover:bg-red-200 text-red-600 rounded flex items-center justify-center transition">
                                        <i class="fa-solid fa-times text-[9px]"></i>
                                    </button>
                                </div>
                            </div>
                            <div v-else class="text-[10px] text-slate-500 italic text-center py-1.5">Aucune caract√©ristique</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-5 md:p-6 border-t border-slate-200 flex-shrink-0 bg-slate-50 flex gap-3">
                <button @click="editModal.open=false" class="px-6 py-3 bg-white border-2 border-slate-300 text-slate-700 rounded-xl font-bold hover:bg-slate-50 transition">Annuler</button>
                <button @click="saveEdit" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 shadow-lg transform active:scale-95 transition">Sauvegarder les modifications</button>
            </div>
        </div>
    </div>
<div v-if="billingSummaryModal.open" class="fixed inset-0 bg-slate-900/80 z-[400] flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col pop-in">
        <div class="bg-slate-100 p-6 flex justify-between items-center border-b">
            <div class="flex-1">
                <h3 class="font-bold text-xl text-slate-800 mb-2">
                    <i class="fa-solid fa-file-invoice-dollar text-indigo-600 mr-2"></i>Synth√®se Facturation
                </h3>
                
                <div class="flex items-center gap-2 flex-wrap">
                    <input type="text" v-model="billingSummarySearch" placeholder="üîç Rechercher par agence..." class="bg-white border-2 border-indigo-100 text-indigo-900 text-sm font-bold rounded-xl px-4 py-2 outline-none focus:border-indigo-500 shadow-sm transition hover:border-indigo-300 flex-1 min-w-[200px]">
                    <select v-model="bilanFilters.mois" class="bg-white border-2 border-indigo-100 text-indigo-900 text-sm font-bold rounded-xl px-4 py-2 outline-none focus:border-indigo-500 shadow-sm cursor-pointer transition hover:border-indigo-300">
                        <option value="">Mois</option>
                        <option value="01">Janvier</option>
                        <option value="02">F√©vrier</option>
                        <option value="03">Mars</option>
                        <option value="04">Avril</option>
                        <option value="05">Mai</option>
                        <option value="06">Juin</option>
                        <option value="07">Juillet</option>
                        <option value="08">Ao√ªt</option>
                        <option value="09">Septembre</option>
                        <option value="10">Octobre</option>
                        <option value="11">Novembre</option>
                        <option value="12">D√©cembre</option>
                    </select>
                    <select v-model="bilanFilters.annee" class="bg-white border-2 border-indigo-100 text-indigo-900 text-sm font-bold rounded-xl px-4 py-2 outline-none focus:border-indigo-500 shadow-sm cursor-pointer transition hover:border-indigo-300">
                        <option value="">Ann√©e</option>
                        <option v-for="y in bilanYearOptions" :key="y" :value="y">{{ y }}</option>
                    </select>
                </div>
            </div>
            <button @click="billingSummaryModal.open=false" class="w-8 h-8 rounded-full bg-white hover:bg-red-50 hover:text-red-500 flex items-center justify-center transition shadow-sm ml-4">‚úï</button>
        </div>
        
        <div class="flex-1 overflow-y-auto p-6 bg-slate-50">
            <div class="space-y-4">
                <div v-for="(agData, agName) in filteredBillingStatsGrouped" :key="agName" class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-4 bg-gradient-to-r from-indigo-50 to-blue-50 border-b border-slate-200 flex justify-between items-center">
                        <div class="flex-1">
                            <div class="font-black text-lg text-slate-800 mb-1">{{ agName }}</div>
                            <div class="flex items-center gap-4 text-sm">
                                <div class="text-indigo-600 font-black text-xl">{{ formatBilanPrice(agData.totalTTC) }} ‚Ç¨ <span class="text-xs text-slate-400 font-normal">TTC</span></div>
                                <div v-if="bilanConfig.tvaActive" class="text-slate-600">
                                    <span class="text-xs">HT:</span> <span class="font-bold">{{ formatBilanPrice(agData.totalHT) }} ‚Ç¨</span>
                                </div>
                            </div>
                        </div>
                        <button @click="exportBilanAgencePDF(agName, agData)" class="bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white px-4 py-2 rounded-xl font-bold text-sm flex items-center gap-2 shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
                            <i class="fa-solid fa-file-pdf"></i> <span class="hidden sm:inline">T√©l√©charger Bilan</span>
                        </button>
                    </div>
                    <div class="p-4">
                        <table class="w-full text-sm table-fixed">
                            <thead class="bg-gradient-to-r from-indigo-50 to-blue-50 border-b-2 border-indigo-200">
                                <tr>
                                    <th class="px-3 py-3 text-left text-xs text-indigo-700 uppercase font-bold w-2/5">Commercial / D√©tail</th>
                                    <th class="px-3 py-3 text-center text-xs text-indigo-700 uppercase font-bold w-16">Nb RDV</th>
                                    <th class="px-3 py-3 text-right text-xs text-indigo-700 uppercase font-bold w-24">Total HT</th>
                                    <th v-if="bilanConfig.tvaActive" class="px-3 py-3 text-right text-xs text-indigo-700 uppercase font-bold w-24">TVA</th>
                                    <th class="px-3 py-3 text-right text-xs text-indigo-700 uppercase font-bold w-28">Total TTC</th>
                                    <th class="px-3 py-3 text-center text-xs text-indigo-700 uppercase font-bold w-20">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-200">
                                <tr v-for="comm in agData.commerciaux" :key="comm.nom" class="hover:bg-indigo-50/50 transition-colors">
                                    <td class="px-3 py-3 font-medium text-slate-800 truncate">{{ comm.nom || 'Agence (Direct)' }}</td>
                                    <td class="px-3 py-3 text-center font-bold text-slate-700">{{ comm.rdv }}</td>
                                    <td class="px-3 py-3 text-right font-bold text-slate-800 whitespace-nowrap">{{ formatBilanPrice(comm.ht) }} ‚Ç¨</td>
                                    <td v-if="bilanConfig.tvaActive" class="px-3 py-3 text-right text-slate-600 whitespace-nowrap">{{ formatBilanPrice(comm.tva || 0) }} ‚Ç¨</td>
                                    <td class="px-3 py-3 text-right font-bold text-indigo-600 whitespace-nowrap">{{ formatBilanPrice(comm.ttc || comm.ht) }} ‚Ç¨</td>
                                    <td class="px-3 py-3 text-center">
                                        <button @click="exportBilanCommercialPDF(agName, comm.nom || 'Agence (Direct)', comm)" class="bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white px-3 py-1.5 rounded-lg font-bold text-xs flex items-center justify-center gap-1.5 shadow-md hover:shadow-lg transition-all transform hover:scale-105">
                                            <i class="fa-solid fa-file-pdf"></i> PDF
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                 <div v-if="Object.keys(filteredBillingStatsGrouped).length === 0" class="text-center py-10 text-slate-400">
                    <i class="fa-solid fa-inbox text-4xl mb-2"></i>
                    <p v-if="billingSummarySearch">Aucune agence ne correspond √† votre recherche.</p>
                    <p v-else>Aucune donn√©e de facturation pour cette s√©lection.</p>
                </div>
            </div>
        </div>

        <div class="p-4 bg-white border-t border-slate-200 flex justify-end">
            <button @click="billingSummaryModal.open=false" class="bg-slate-800 text-white px-6 py-3 rounded-xl font-bold hover:bg-slate-900 transition">Fermer</button>
        </div>
    </div>
</div>
  
<script>
    // Masquer la barre d'adresse du navigateur sur mobile (iPhone)
    (function() {
        // Fonction pour masquer la barre d'adresse
        function hideAddressBar() {
            if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
                // Forcer le redimensionnement pour masquer la barre
                window.scrollTo(0, 1);
                setTimeout(function() {
                    window.scrollTo(0, 0);
                }, 0);
                
                // Masquer la barre apr√®s le chargement
                setTimeout(function() {
                    window.scrollTo(0, 1);
                }, 100);
            }
        }
        
        // Masquer au chargement
        if (document.readyState === 'complete') {
            hideAddressBar();
        } else {
            window.addEventListener('load', hideAddressBar);
            window.addEventListener('orientationchange', function() {
                setTimeout(hideAddressBar, 500);
            });
        }
        
        // Masquer lors du scroll
        let lastScrollTop = 0;
        window.addEventListener('scroll', function() {
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            if (scrollTop > lastScrollTop && scrollTop > 10) {
                // Scroll vers le bas - masquer la barre
                setTimeout(hideAddressBar, 100);
            }
            lastScrollTop = scrollTop;
        }, false);
        
        // Pr√©venir le zoom sur double-tap
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    })();
    
    const firebaseConfig = {
        apiKey: "AIzaSyDi3NFvmg_acIxicfShqhEd4uQEDMDcizM",
        authDomain: "bon-de-commande-b05f6.firebaseapp.com",
        projectId: "bon-de-commande-b05f6",
        storageBucket: "bon-de-commande-b05f6.firebasestorage.app",
        messagingSenderId: "884603881750",
        appId: "1:884603881750:web:816da99e2502225779a837"
    };
    firebase.initializeApp(firebaseConfig);
    // --- PERSISTANCE INSTANTAN√âE ---
    firebase.firestore().enablePersistence()
        .catch((err) => {
            if (err.code == 'failed-precondition') {
                console.warn("Persistance non active (onglet multiple).");
            } else if (err.code == 'unimplemented') {
                console.warn("Persistance non support√©e par le navigateur.");
            }
        });
    const db = firebase.firestore();

    const { createApp, ref, reactive, computed, onMounted, watch } = Vue;

    createApp({
        setup() {
            
            const user = reactive({ logged:false, role:'', name:'', email:'', id:'' });
            const forcedLogoutModal = reactive({ open: false, type: '' }); // 'deleted' ou 'blocked'
            const blockedLoginMessage = reactive({ show: false });
            const loginErrorModal = reactive({ show: false, message: '' });
            let userStatusListener = null;
            // --- MODE CLIENT (DOCTOLIB) ---
const isClientMode = ref(false); // Est-ce qu'on est en vue client ?
const clientRdv = ref(null); // Le RDV charg√© pour le client
const clientRequest = reactive({ type: '', motif: '', showModal: false }); // Pour g√©rer la demande
const appUrl = window.location.origin + window.location.pathname; // L'URL de base de ton site
            const loginEmail = ref('');
            const loginPass = ref('');
            const loginAdminSelection = ref(false); 
            
            const view = ref('dashboard');
            const currentFilter = ref('all'); 
            const listFilters = reactive({ agenceId: '', date: '', prospecteur: '' }); 
            const fromDashboard = ref(false);
            const rdvMenuOpen = ref(null);

            // Initialiser avec le mois et l'ann√©e actuels
            const currentDate = new Date();
            const currentMonth = String(currentDate.getMonth() + 1).padStart(2, '0');
            const currentYear = String(currentDate.getFullYear());
            const dashboardFilters = reactive({ agencyId: '', userId: '', commercialId: '', onlyLive: false, mois: currentMonth, annee: currentYear });
            const dashboardLimit = ref(15);
            const displayLimit = ref(20); 

            const now = ref(new Date()); 
            const rdvList = ref([]);
            let rdvListener = null;
            
            // Google Calendar API
            const googleCalendarConnected = ref(false);
            const googleCalendarUserEmail = ref('');
            const googleAccessToken = ref('');
            let googleTokenClient = null;
            
            // Google Calendar API pour les prospecteurs (M√äME STRUCTURE QUE ADMIN)
            const prospecteurGoogleCalendarConnected = ref(false);
            const prospecteurGoogleCalendarUserEmail = ref('');
            const prospecteurGoogleCalendarToken = ref('');
            const prospecteurGoogleCalendarTokenExpired = ref(false);
            const prospecteurTokenExpirationTime = ref(null); // Timestamp d'expiration du token prospecteur
            const prospecteurTokenTimerTick = ref(Date.now()); // Pour le compteur en temps r√©el
            let prospecteurGoogleTokenClient = null;
            let prospecteurTokenRefreshInterval = null;
            
            // Mettre √† jour le temps toutes les secondes pour les prospecteurs
            setInterval(() => {
                if (prospecteurTokenExpirationTime.value && prospecteurGoogleCalendarConnected.value && !prospecteurGoogleCalendarTokenExpired.value) {
                    prospecteurTokenTimerTick.value = Date.now();
                }
            }, 1000);
            
            // Calcul du temps restant avant expiration pour les prospecteurs
            const prospecteurTokenTimeRemaining = computed(() => {
                if (!prospecteurTokenExpirationTime.value || !prospecteurGoogleCalendarConnected.value || prospecteurGoogleCalendarTokenExpired.value) {
                    return null;
                }
                const remaining = prospecteurTokenExpirationTime.value - prospecteurTokenTimerTick.value;
                if (remaining <= 0) return null;
                
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);
                return { minutes, seconds };
            });
            
            // Computed pour le d√©compte des prospecteurs (token propre OU token admin)
            const prospecteurDisplayTimeRemaining = computed(() => {
                // Si le prospecteur a son propre token valide, utiliser celui-ci
                if (prospecteurTokenTimeRemaining.value) {
                    return prospecteurTokenTimeRemaining.value;
                }
                // Sinon, si connect√© via admin, utiliser le token admin
                if (tokenTimeRemaining.value && googleCalendarConnected.value && googleAccessToken.value) {
                    return tokenTimeRemaining.value;
                }
                return null;
            });

            const agences = ref([]);
            const sourcesList = ref(['Leboncoin', 'La Centrale', 'Facebook', 'Google', 'Instagram']);
            const sourceLogos = ref({}); 
            const adminNamesList = ref(['Nathana√´l', 'Charl√®ne', 'Admin']);
            const motifsList = ref(['Essai', 'Achat', 'R√©vision', 'R√©paration', 'Vente']);
            // Cherchez cette ligne et remplacez-la par :
            const globalSettings = ref({ reminderStartTime: '08:00', reminderEveTime: '16:00', appLogoUrl: '', rdvLinkBaseUrl: '', tutorialVideoUrl: '' });
            
            // GLOBAL COMMISSION SETTINGS
            const globalCommission = reactive({ base: 10, threshold: 21, step: 10, amount: 100 });
            const tips = reactive({}); // { memberId: currentMonthTipAmount }
            
            // R√©glages de synchronisation
            const syncSettings = reactive({
                syncAfterRdvTime: false, // Synchroniser seulement apr√®s l'heure du rendez-vous
                syncInterval: 30 // Intervalle de synchronisation en secondes
            });

            const selectedIds = ref([]);
            const bulkModal = reactive({ open: false, action: '', label: '' });
            const agencySearch = ref('');

            const wizard = reactive({ open:false, step:1, loading:false });
            const form = reactive({});
            const clientModal = reactive({ open:false, rdv:null, removingFromAgenda: false });
            const historyModal = reactive({ open:false, rdv:null });
            const settingsModal = reactive({ open:false, tab:'Agences', view:'menu' });
            const rappelConfirmModal = reactive({ open:false, rdv:null, smsLink:'' });
            const quickRdvModal = reactive({ open:false, nom:'', modele:'', note:'', agenceId:'', commercialId:'', date:'', heure:'', source:'', honore:false });
            const formatageSettings = reactive({ 
                autoTranslate: true, 
                boldLabels: true, 
                alignValues: true, 
                spaceBetween: true 
            });
            const cancelModal = reactive({ open:false, rdv:null, motif:'', motifCustom:'', selectedMotif:'', sendSMS:false, who:'' });
            const rescheduleModal = reactive({ open:false, step:1, date:'', heure:'', rdv:null, oldDate:null, oldHeure:null, motif:'', motifType:'', demandePar:'', autoSMS:false, smsMessage:'' });
            const motifSelectionModal = reactive({ open: false });
            const messagePreviewModal = reactive({ open: false, message: '', title: 'Aper√ßu du message' });
            const rescheduleSMSMessages = reactive({ meteo_route_dangereuse: '', vehicule_immobilise: '', contrainte_pro: '', contrainte_personnelle: '', documents_manquants: '', empechement_medical: '', agence_fermee: '', commercial_retard: '', agence_retard: '', intemperie: '', absence_imprevue: '' });
            const rescheduleSMSMessagesClient = reactive({ meteo_route_dangereuse: '', vehicule_immobilise: '', contrainte_pro: '', contrainte_personnelle: '', documents_manquants: '', empechement_medical: '' });
            const editingRescheduleType = ref('interne'); // 'interne' ou 'client'
            const openMotifs = reactive({}); // Pour suivre quels motifs sont ouverts
            const rescheduleMotifsList = reactive({ meteo_route_dangereuse: '‚ö†Ô∏è Conditions de la route dangereuse', vehicule_immobilise: 'üîß V√©hicule immobilis√©', contrainte_pro: 'üíº R√©union de derni√®re minute', contrainte_personnelle: 'üè† Contrainte personnelle', documents_manquants: 'üìã Oubli des documents', empechement_medical: 'üíä Motif de sant√©' });
            // Motifs sp√©cifiques pour demande interne
            const rescheduleMotifsListInterne = reactive({ 
                agence_fermee: 'üè¢ L\'agence sera ferm√©e', 
                commercial_retard: '‚è∞ Le commercial aura un peu de retard', 
                agence_retard: '‚è∞ L\'agence aura un peu de retard', 
                intemperie: 'üåßÔ∏è Intemp√©rie', 
                absence_imprevue: 'üö´ Absence impr√©vue'
            });
            const newRescheduleMotif = reactive({ label: '', key: '', message: '' });
            const newRescheduleMotifInterne = reactive({ label: '', key: '', message: '' });
            const fermetureModal = reactive({ open:false, dateDebut:'', dateFin:'', motif:'', professionnels:[], tousProfessionnels:false, editingId:null });
            const fermetureDeleteConfirmModal = reactive({ open:false, fermetureId:null });
            const fermeturesList = ref([]);
            const heureFermetureConfirmModal = reactive({ open:false, heure:'', heureFermeture:'', onConfirm:null });
            const heureLimiteExceptionnelleModal = reactive({ open:false, heure:'', heureLimite:'', motif:'' });
            const heureApresFermetureModal = reactive({ open:false, heure:'', heureFermeture:'', onConfirm:null });
            const removeAgendaConfirmModal = reactive({ open:false, rdv:null });
            const pausedAgencyModal = reactive({ open:false, agency:null });
            
            const honorModal = reactive({ open: false, rdv: null, commercial: '', needsCommercial: false, error: '' });
            const editModal = reactive({ open: false, rdv: null, form: {} });
            const discountModal = reactive({ open: false, amount: null, reason: '', customReason: '', error: '' });
            const reminderAlertModal = reactive({ open: false });
            const pendingStatusModal = reactive({ open: false });
            const teamEditModal = reactive({ open: false, member: null, name: '', email: '', password: '', assignedAgencies: [] });
            const passwordEditModal = reactive({ open: false, member: null, password: '' });
            const globalSearchModal = reactive({ open: false, query: '', results: [] });
            const actionHistory = ref([]); // Historique des actions
            const detailedLogs = ref([]); // Logs d√©taill√©s depuis Firestore
            const performanceStats = reactive({
                tauxConfirmation: 0,
                tauxAnnulation: 0,
                tauxHonorisation: 0,
                tauxPresence: 0,
                totalRdvs: 0,
                totalConfirmes: 0,
                totalAnnules: 0,
                totalHonores: 0,
                totalPresents: 0,
                totalEnAttente: 0,
                totalPasVenus: 0,
                rdvAujourdhui: 0,
                rdvCetteSemaine: 0,
                rdvCeMois: 0
            });
            const workloadPrediction = ref([]); // Pr√©diction de charge
            const connectedUsers = ref([]); // Utilisateurs actuellement connect√©s
            const connexionsHistory = ref([]); // Historique des connexions/d√©connexions
            const connectedUsersCount = computed(() => connectedUsers.value.length);
            const loadingConnexions = ref(false); // √âtat de chargement
            const selectedConnexionLogs = ref([]); // Logs s√©lectionn√©s pour suppression
            const connexionDeleteModal = ref({ open: false, mode: 'selected' }); // Modal de confirmation suppression
            const isDeletingLogs = ref(false); // Flag pour emp√™cher le rechargement automatique pendant la suppression
            const userHistoryModal = ref({ open: false, user: null, history: [], loading: false }); // Modal historique utilisateur
            const monthlySummaries = ref({}); // R√©sum√©s mensuels par utilisateur
            const dashboardModal = reactive({ open: false, widgets: [] });
            const reportSettings = reactive({ 
                open: false, 
                weekly: false, 
                monthly: false, 
                email: '',
                dayOfWeek: 1, // Lundi par d√©faut
                dayOfMonth: 1 // 1er du mois par d√©faut
            });
            const customConfirmModal = reactive({ open: false, title: '', message: '', onConfirm: null });
            const editNoteModal = reactive({ open: false, rdv: null, note: '' });
            const statsModal = reactive({ open: false, activeTab: 'overview', selectedMonth: 'current' });
            const tipModal = reactive({ open: false, operation: 'add', amount: null, reason: '', customReason: '', note: '', error: '' });
            const googleCalendarDisconnectedModal = reactive({ open: false, fromWizard: false });
            const googleCalendarRequired = ref(false); // Param√®tre pour rendre la connexion obligatoire
            const connectingFromSelectSource = ref(false); // Flag pour savoir si la connexion vient de la s√©lection de Google comme source
            const googleCalendarInfoModal = reactive({ open: false });
            const confirmAgendaModal = reactive({ open: false, rdv: null, onConfirm: null });
            const reconnectAgendaModal = reactive({ open: false, rdv: null });
            const notificationToast = reactive({ open: false, message: '', type: 'success', icon: '', persistent: false, actionUrl: null });
            const showIntelligentModeHelp = ref(false); // Modal d'aide pour le mode intelligent

            // Fonction pour afficher une notification moderne
            const showNotification = (message, type = 'success', icon = '', persistent = false, actionUrl = null, duration = null) => {
                notificationToast.message = message;
                notificationToast.type = type;
                notificationToast.icon = icon || (type === 'success' ? 'fa-check-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle');
                notificationToast.persistent = persistent;
                notificationToast.actionUrl = actionUrl;
                notificationToast.open = true;
                if (!persistent) {
                    const timeoutDuration = duration !== null ? duration : 4000;
                    setTimeout(() => {
                        notificationToast.open = false;
                    }, timeoutDuration);
                }
            };

            // PORTAFEUILLE
            const portefeuilleSearch = ref('');
            const selectedProspecteur = ref(null);
            const filteredProspectors = ref([]);
            const transactions = ref([]);
            const prospecteurEdit = reactive({ tips: 0 });
            let transactionListener = null;
            let adminTransactionListener = null;

            // BILAN & FACTURATION
            const bilanRows = ref([]);
            const bilanConfig = reactive({ tvaActive: false, tvaRate: 20, logo: "", signature: "", tvaStart: "" });
            const bilanForm = reactive({ date: new Date().toISOString().split('T')[0], reporte: false, blocks: [{ agenceId: '', commercial: '', rdv: 1, tarif: 0 }] });
            // Initialiser avec le mois et l'ann√©e actuels
            const bilanFilters = reactive({ jour: '', mois: currentMonth, annee: currentYear, agence: '', commercial: '', search: '' });
            const selectedBilanIds = ref([]);
            const bilanCurrentPage = ref(1);
            const bilanPeriod = ref('month');
            const bilanTab = ref('main');
            const bilanModal = reactive({ open: false });
            const bilanEditModal = reactive({ open: false, rdv: null, form: {} });
            const bilanSettingsModal = reactive({ open: false });
            const urgentCommercialModal = reactive({ open: false, rdv: null, commercial: '' });
            const bilanMonthOptions = ref([]);
            const bilanYearOptions = ref([]);
            const dashboardYearOptions = ref([]);
            const ITEMS_PER_PAGE_BILAN = 15;

            // OBJECTIFS
            const objectifsFilters = reactive({ mois: '', agence: '' });
            const objectifsStats = ref([]);
            const objectifsData = ref([]);
            const objectifModal = reactive({ open: false, agenceId: '', commercial: '', objectif: 0, periode: 'month' });
            const tarifPersonnaliseModal = reactive({ open: false, agenceId: '', tarifs: [{ rdvMin: 1, montant: 0 }] });
            const tarifsPersonnalises = ref({});

            // Flag de session pour les v√©rifications au d√©marrage
            const checksDone = ref(false);
            const startupTimer = ref(null);

            const statsFilterAgency = ref('');
            const statsFilterUser = ref('');
            const statsFilterMonth = ref('');
            const statsFilterYear = ref('');

            const newSource = ref('');
            const newMotif = ref('');
            const cancelMotifsList = ref(['Client indisponible', 'V√©hicule en r√©paration', 'Client a annul√©', 'Agence indisponible']);
            const newCancelMotif = ref('');
            const newAdminName = ref('');
            const showDiscountInput = ref(false);
            const newNoteText = ref('');

            const editingAgency = ref(null);
            const editingAgencyCommerciaux = ref([]);
            const editingAgencyFermetures = ref([]);
            const editingMsgAgence = ref(null);
            const editingMsgType = ref('confirm');
            const clientExists = ref(false);
            const pauseReasonSelect = ref('Vacances');
            const showCustomTime = ref(false);
            const mobileMenuOpen = ref(false);
            
            // Variable pour suivre si l'admin a un token actif (partag√© avec tous les prospecteurs)
            const currentTheme = computed(() => {
                // Th√®me moderne chic toujours actif
                return { name: 'modern', label: 'Mode Premium', icon: '‚ú®', classes: 'theme-modern' };
                
                // Th√®mes saisonniers d√©sactiv√©s - d√©commenter pour les r√©activer
                // const d = new Date();
                // const month = d.getMonth() + 1; 
                // const day = d.getDate();
                // if (month === 12) return { name: 'christmas', label: 'Joyeuses F√™tes', icon: 'üéÖ', classes: 'theme-christmas' };
                // if (month === 1 && day <= 15) return { name: 'newyear', label: 'Bonne Ann√©e', icon: 'ü•Ç', classes: 'theme-newyear' };
                // if (month === 2 && day >= 10 && day <= 15) return { name: 'love', label: 'Love is in the air', icon: '‚ù§Ô∏è', classes: 'theme-love' };
                // if (month === 10 && day >= 15) return { name: 'halloween', label: 'Bouuh !', icon: 'üéÉ', classes: 'theme-halloween' };
                // if (month >= 6 && month <= 8) return { name: 'summer', label: 'Mode √ât√©', icon: 'üòé', classes: 'theme-summer' };
                // if (month === 7 && day >= 13 && day <= 15) return { name: 'bastille', label: 'F√™te Nationale', icon: 'üéÜ', classes: 'theme-bastille' };
                // return { name: 'default', label: '', icon: '', classes: '' };
            });

            const welcomeModal = reactive({ open: false, title: '', message: '', icon: '' });
            const tutorialModal = reactive({ open: false, step: 1, userName: '' });
            const tutorialVideoModal = reactive({ open: false });
            const teamList = ref([]);
            const newMember = reactive({ name:'', email:'', password:'', assignedAgencies: [] });

            const msgLabels = { 'confirm': 'Confirmation', 'rappel': 'Rappel Veille', 'rappel_today': 'Rappel Jour J', 'reschedule': 'Report', 'cancel_ag': 'Annulation Agence', 'cancel_clt': 'Annulation Client', 'noshow': 'Lapin', 'noshow_today': 'Lapin (Jour J)' };
            const filters = reactive({ date: new Date().toISOString().split('T')[0] });
            const timelineShowTomorrow = ref(false); // √âtat pour savoir si on affiche "demain" ou "aujourd'hui"
            const search = ref('');
            const normalizePhone = (value) => (value || '').replace(/\D/g, '');
            const formatPhone = (digits) => digits.replace(/(\d{2})(?=\d)/g, '$1 ').trim();

onMounted(async () => { // Note le 'async' ajout√© ici
    
    // --- D√âTECTION MODE CLIENT ---
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');

    if (token) {
        isClientMode.value = true;
        try {
            // On charge le RDV sp√©cifique
            const doc = await db.collection('rendezvous').doc(token).get();
            if (doc.exists) {
                clientRdv.value = { id: doc.id, ...doc.data() };
            } else {
                alert("Ce rendez-vous n'existe plus ou le lien est expir√©.");
                isClientMode.value = false;
            }
        } catch (e) {
            console.error("Erreur chargement client", e);
        }
    }
    // -----------------------------

    // 1. Initialisation de l'outil Google (reste de ton code...)

                // 2. Initialiser les options d'ann√©e pour le dashboard
                initDashboardYearOptions();
                
                // 2.5. D√©marrer la v√©rification p√©riodique des SMS programm√©s
                startScheduledSMSChecker();
                
                // 3. Restauration de la session utilisateur
                const savedUser = localStorage.getItem('crm_user');

                if (savedUser) {
                    const parsed = JSON.parse(savedUser);
                    user.logged = true;
                    user.role = parsed.role;
                    user.name = parsed.name;
                    user.email = parsed.email || '';
                    user.id = parsed.id || '';
                    loadRdvData();
                    
                    // Charger les fermetures si admin
                    if (user.role === 'admin') {
                        loadFermetures();
                    }
                    
                    // Initialiser Google Calendar pour les prospecteurs apr√®s chargement de l'utilisateur
                    if (user.role !== 'admin' && typeof google !== 'undefined' && google.accounts) {
                        initProspecteurGoogleCalendar();
                    }
                }
// √âcoute des ordres de l'admin sur mon propre profil utilisateur ET v√©rification du statut (bloqu√©/supprim√©)
                    if (user.logged && user.role !== 'admin' && user.id) {
                        // Nettoyer l'ancien listener si existe
                        if (userStatusListener) userStatusListener();
                        // Note: Assure-toi que user.id est bien disponible ici
                        // Stocker l'√©tat initial du blocage
                        let previousBlockedState = false;
                        // D'abord r√©cup√©rer l'√©tat initial
                        db.collection('users').doc(user.id).get().then(doc => {
                            if (doc.exists) {
                                previousBlockedState = doc.data().blocked === true;
                            }
                        });
                        
                        userStatusListener = db.collection('users').doc(user.id).onSnapshot(doc => {
                            if (!doc.exists) {
                                // Le profil a √©t√© supprim√©
                                forcedLogoutModal.type = 'deleted';
                                forcedLogoutModal.open = true;
                                return;
                            }
                            
                            const data = doc.data();
                            
                            if (data) {
                                const isBlocked = data.blocked === true;
                                // Ne d√©connecter que si on passe de non-bloqu√© √† bloqu√©
                                if (isBlocked && !previousBlockedState) {
                                    forcedLogoutModal.type = 'blocked';
                                    forcedLogoutModal.open = true;
                                }
                                previousBlockedState = isBlocked; // Mettre √† jour l'√©tat pr√©c√©dent
                            }
                            
                            // Si l'admin a envoy√© l'ordre "force_google_connect"
                            if (data && data.force_google_connect === true) {
                                console.log("‚ö° Ordre de connexion re√ßu de l'Admin !");
                                
                                // 1. On lance la connexion
                                connectProspecteurGoogleCalendar();
                                
                                // 2. On remet le flag √† false pour ne pas boucler
                                db.collection('users').doc(user.id).update({ force_google_connect: false });
                            }
                            
                            // Si l'admin a envoy√© l'ordre "force_google_disconnect"
                            if (data && data.force_google_disconnect === true) {
                                console.log("‚ö° Ordre de d√©connexion re√ßu de l'Admin !");
                                
                                // 1. On lance la d√©connexion
                                disconnectProspecteurGoogleCalendar();
                                
                                // 2. On remet le flag √† false pour ne pas boucler
                                db.collection('users').doc(user.id).update({ force_google_disconnect: false });
                            }
                        });
                    }
                // --- FIX : RESTAURATION DE LA SESSION GOOGLE (ADMIN SEULEMENT) ---
                // On v√©rifie le localStorage maintenant que l'utilisateur est charg√©
                if (user.role === 'admin') {
                    const savedToken = localStorage.getItem('google_calendar_token');
                    const savedEmail = localStorage.getItem('google_calendar_email');

                    if (savedToken && savedEmail) {
                        // On teste si le token est encore valide
                        fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                            headers: { 'Authorization': `Bearer ${savedToken}` }
                        })
                        .then(async (res) => {
                            if (res.ok) {
                                // Le token est bon, on r√©tablit la connexion
                                googleAccessToken.value = savedToken;
                                googleCalendarUserEmail.value = savedEmail;
                                googleCalendarConnected.value = true;
                                console.log("‚úÖ Session Google Agenda restaur√©e");
                                // On recharge la liste des agendas pour que le menu soit √† jour
                                await fetchGoogleCalendarList();
                                // Initialiser le TokenClient si ce n'est pas d√©j√† fait pour permettre le rafra√Æchissement
                                if (!googleTokenClient && typeof google !== 'undefined' && google.accounts && GOOGLE_CLIENT_ID) {
                                    googleTokenClient = google.accounts.oauth2.initTokenClient({
                                        client_id: GOOGLE_CLIENT_ID,
                                        scope: 'https://www.googleapis.com/auth/calendar.events https://www.googleapis.com/auth/calendar.readonly',
                                        callback: (tokenResponse) => {
                                            if (tokenResponse.access_token) {
                                                // Rafra√Æchir le token sauvegard√©
                                                googleAccessToken.value = tokenResponse.access_token;
                                                localStorage.setItem('google_calendar_token', tokenResponse.access_token);
                                                // Sauvegarder aussi dans Firestore pour l'admin
                                                db.collection('settings').doc('google_token').set({
                                                    token: tokenResponse.access_token,
                                                    email: savedEmail,
                                                    updatedAt: new Date().toISOString()
                                                }).catch(e => console.error("Erreur sauvegarde token:", e));
                                            }
                                        }
                                    });
                                }
                            } else {
                                // Le token est expir√©, on essaie de le rafra√Æchir automatiquement
                                console.log("üîÑ Token Google expir√©, tentative de rafra√Æchissement automatique...");
                                // Initialiser le TokenClient si ce n'est pas d√©j√† fait
                                if (typeof google !== 'undefined' && google.accounts && GOOGLE_CLIENT_ID) {
                                    if (!googleTokenClient) {
                                        googleTokenClient = google.accounts.oauth2.initTokenClient({
                                            client_id: GOOGLE_CLIENT_ID,
                                            scope: 'https://www.googleapis.com/auth/calendar.events https://www.googleapis.com/auth/calendar.readonly',
                                            callback: (tokenResponse) => {
                                                if (tokenResponse.access_token) {
                                                    // Token rafra√Æchi avec succ√®s
                                                    googleAccessToken.value = tokenResponse.access_token;
                                                    googleCalendarUserEmail.value = savedEmail;
                                                    googleCalendarConnected.value = true;
                                                    localStorage.setItem('google_calendar_token', tokenResponse.access_token);
                                                    console.log("‚úÖ Token Google rafra√Æchi automatiquement");
                                                    // Sauvegarder dans Firestore
                                                    db.collection('settings').doc('google_token').set({
                                                        token: tokenResponse.access_token,
                                                        email: savedEmail,
                                                        updatedAt: new Date().toISOString()
                                                    }).catch(e => console.error("Erreur sauvegarde token:", e));
                                                    // Charger la liste des agendas
                                                    fetchGoogleCalendarList();
                                                }
                                            }
                                        });
                                    }
                                    // Essayer de rafra√Æchir le token silencieusement (prompt: 'none')
                                    try {
                                        googleTokenClient.requestAccessToken({ prompt: 'none' });
                                    } catch (e) {
                                        // Si le rafra√Æchissement silencieux √©choue, on nettoie
                                        console.warn("‚ö†Ô∏è Impossible de rafra√Æchir le token automatiquement, d√©connexion");
                                        localStorage.removeItem('google_calendar_token');
                                        localStorage.removeItem('google_calendar_email');
                                        googleCalendarConnected.value = false;
                                    }
                                } else {
                                    // Google API pas encore charg√©e, on nettoie
                                    localStorage.removeItem('google_calendar_token');
                                    localStorage.removeItem('google_calendar_email');
                                    googleCalendarConnected.value = false;
                                }
                            }
                        })
                        .catch(() => {
                            googleCalendarConnected.value = false;
                        });
                    }
                }
                
                // --- RESTAURATION DE LA SESSION GOOGLE (PROSPECTEURS) ---
                if (user.role !== 'admin') {
                    const savedProspecteurToken = localStorage.getItem('prospecteur_google_calendar_token');
                    const savedProspecteurEmail = localStorage.getItem('prospecteur_google_calendar_email');
                    
                    if (savedProspecteurToken && savedProspecteurEmail) {
    // 1. On affiche le bouton en VERT tout de suite (on pr√©sume que c'est bon)
    prospecteurGoogleCalendarToken.value = savedProspecteurToken;
    prospecteurGoogleCalendarConnected.value = true;
    prospecteurGoogleCalendarTokenValid.value = true; 
    prospecteurGoogleCalendarTokenExpired.value = false;
    prospecteurTokenExpirationTime.value = Date.now() + (55 * 60 * 1000);

    // 2. On lance la v√©rification Google en arri√®re-plan (silencieux)
    fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
        headers: { 'Authorization': `Bearer ${savedProspecteurToken}` }
    }).then(res => {
        if (!res.ok) {
            // Le token est expir√©, on essaie de le rafra√Æchir automatiquement
            console.log("üîÑ Token prospecteur expir√©, tentative de rafra√Æchissement automatique...");
            // Initialiser le TokenClient si ce n'est pas d√©j√† fait
            if (typeof google !== 'undefined' && google.accounts && GOOGLE_CLIENT_ID) {
                if (!prospecteurGoogleTokenClient) {
                    prospecteurGoogleTokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: GOOGLE_CLIENT_ID,
                        scope: 'https://www.googleapis.com/auth/calendar.events https://www.googleapis.com/auth/calendar.readonly',
                        callback: (tokenResponse) => {
                            if (tokenResponse.access_token) {
                                // Token rafra√Æchi avec succ√®s
                                prospecteurGoogleCalendarToken.value = tokenResponse.access_token;
                                prospecteurGoogleCalendarConnected.value = true;
                                prospecteurGoogleCalendarTokenExpired.value = false;
                                prospecteurGoogleCalendarTokenValid.value = true;
                                prospecteurTokenExpirationTime.value = Date.now() + (55 * 60 * 1000);
                                localStorage.setItem('prospecteur_google_calendar_token', tokenResponse.access_token);
                                localStorage.setItem('prospecteur_google_calendar_email', savedProspecteurEmail);
                                localStorage.setItem('prospecteur_google_calendar_token_date', new Date().toISOString());
                                console.log("‚úÖ Token prospecteur rafra√Æchi automatiquement");
                                // D√©marrer le rafra√Æchissement automatique
                                startProspecteurTokenRefresh();
                                // Mettre √† jour le statut dans Firestore
                                if (user.logged && user.role !== 'admin' && user.id) {
                                    db.collection('users').doc(user.id).update({
                                        googleStatus: 'connected',
                                        googleTokenExpires: prospecteurTokenExpirationTime.value,
                                        lastSeen: new Date().toISOString()
                                    }).catch(e => console.log("Erreur mise √† jour statut", e));
                                }
                            }
                        }
                    });
                }
                // Essayer de rafra√Æchir le token silencieusement (prompt: 'none')
                try {
                    prospecteurGoogleTokenClient.requestAccessToken({ prompt: 'none' });
                } catch (e) {
                    // Si le rafra√Æchissement silencieux √©choue, on marque comme expir√©
                    console.warn("‚ö†Ô∏è Impossible de rafra√Æchir le token prospecteur automatiquement");
                    prospecteurGoogleCalendarTokenValid.value = false;
                    prospecteurGoogleCalendarTokenExpired.value = true;
                }
            } else {
                // Google API pas encore charg√©e, on marque comme expir√©
                prospecteurGoogleCalendarTokenValid.value = false;
                prospecteurGoogleCalendarTokenExpired.value = true;
            }
        } else {
            // Token valide, d√©marrer le rafra√Æchissement automatique
            startProspecteurTokenRefresh();
        }
    }).catch(() => {
        prospecteurGoogleCalendarTokenValid.value = false;
    });
}
                }
                // ------------------------------------------------------------------

                // 3. Fermeture des menus au clic ext√©rieur
                document.addEventListener('click', (e) => {
                    if (rdvMenuOpen.value) {
                        const clickedMenu = e.target.closest('div[style*="z-index: 9999"]');
                        const clickedButton = e.target.closest('button[title="Options"]');
                        const clickedGear = e.target.closest('.fa-gear') || e.target.closest('button[title="Options"]');

                        if (!clickedMenu && !clickedButton && !clickedGear) {
                            rdvMenuOpen.value = null;
                        }
                    }
                });

                // 4. Chargement des donn√©es Firebase (Agences, Settings, Users)
                db.collection('agences').onSnapshot(snap => agences.value = snap.docs.map(d => ({
                    id: d.id,
                    templates: {},
                    ...d.data()
                })));

                db.collection('settings').doc('global').onSnapshot(snap => {
                    if (snap.exists) {
                        const data = snap.data();
                        if (data.sources) sourcesList.value = data.sources;
                        if (data.motifs) motifsList.value = data.motifs;
                        if (data.cancelMotifs) cancelMotifsList.value = data.cancelMotifs;
                        if (data.reminderStartTime) globalSettings.value.reminderStartTime = data.reminderStartTime;
                        if (data.reminderEveTime) globalSettings.value.reminderEveTime = data.reminderEveTime;
                        if (data.appLogoUrl) globalSettings.value.appLogoUrl = data.appLogoUrl;
                        if (data.rdvLinkBaseUrl !== undefined) globalSettings.value.rdvLinkBaseUrl = data.rdvLinkBaseUrl || '';
                        if (data.tutorialVideoUrl !== undefined) globalSettings.value.tutorialVideoUrl = data.tutorialVideoUrl || '';
                        if (data.logos) sourceLogos.value = data.logos;
                        if (data.adminNames) adminNamesList.value = data.adminNames;
                    }
                });
                
                db.collection('settings').doc('formatage').onSnapshot(snap => {
                    if (snap.exists) {
                        const data = snap.data();
                        if (data.autoTranslate !== undefined) formatageSettings.autoTranslate = data.autoTranslate;
                        if (data.boldLabels !== undefined) formatageSettings.boldLabels = data.boldLabels;
                        if (data.alignValues !== undefined) formatageSettings.alignValues = data.alignValues;
                        if (data.spaceBetween !== undefined) formatageSettings.spaceBetween = data.spaceBetween;
                    }
                });
                
                // Charger le param√®tre de connexion obligatoire
                db.collection('settings').doc('google_calendar_required').onSnapshot(snap => {
                    if (snap.exists) {
                        const data = snap.data();
                        googleCalendarRequired.value = data.required || false;
                        if (data.commission) Object.assign(globalCommission, data.commission);
                    }
                });

                db.collection('users').onSnapshot(snap => {
                    teamList.value = snap.docs.map(d => {
                        const data = d.data();
                        const currentMonthKey = `${new Date().getMonth()}-${new Date().getFullYear()}`;
                        if (data.tips && data.tips[currentMonthKey]) {
                            tips[d.id] = data.tips[currentMonthKey];
                        } else {
                            tips[d.id] = 0;
                        }
                        return {
                            id: d.id,
                            assignedAgencies: [],
                            ...data
                        };
                    });
                });

            // 5. --- SYNCHRONISATION GOOGLE CALENDAR CLOUD ---
            db.collection('settings').doc('google_token').onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    if (data && data.token) {
                        
                        // Si le token a chang√© (ou si c'est la premi√®re connexion), on reset le timer
                        const currentToken = user.role === 'admin' ? googleAccessToken.value : prospecteurGoogleCalendarToken.value;
                        const hasChanged = currentToken !== data.token;

                        // 1. Mise √† jour des variables
                        googleAccessToken.value = data.token;
                        googleCalendarUserEmail.value = data.email || '';

                        // 2. Admin
                        googleCalendarConnected.value = true;
                        
                        // 3. Prospecteur
                        if (user.role !== 'admin') {
                            prospecteurGoogleCalendarConnected.value = true;
                            prospecteurGoogleCalendarToken.value = data.token;
                            prospecteurGoogleCalendarTokenValid.value = true;
                            prospecteurGoogleCalendarTokenExpired.value = false;
                        }

                      // --- FORCER LE RESET DU TIMER √Ä 55 MIN POUR TOUT LE MONDE ---
// Si le token vient d'√™tre mis √† jour (par l'intervalle auto), on remet le temps au max
const newExpiry = Date.now() + (55 * 60 * 1000);

if (user.role === 'admin') {
    tokenExpirationTime.value = newExpiry;
    
    // --- FIX: Affichage imm√©diat du compteur ---
    googleCalendarTokenValid.value = true; // On force l'affichage imm√©diatement
    tokenTimerTick.value = Date.now();     // On lance le tic-tac du compteur
    // ------------------------------------------

    // On force la v√©rification visuelle (arri√®re-plan)
    setTimeout(() => checkAndUpdateTokenStatus(false), 50);
    localStorage.setItem('google_calendar_token', data.token);
} else {
    prospecteurTokenExpirationTime.value = newExpiry;
    // On force la v√©rification visuelle
    setTimeout(() => checkAndUpdateProspecteurTokenStatus(), 50);
}

                    } else {
                        // ... (Code de d√©connexion identique √† avant) ...
                        googleAccessToken.value = '';
                        googleCalendarUserEmail.value = '';
                        googleCalendarConnected.value = false;
                        googleCalendarTokenValid.value = false;
                        if (user.role !== 'admin') {
                            prospecteurGoogleCalendarConnected.value = false;
                            prospecteurGoogleCalendarToken.value = '';
                            prospecteurGoogleCalendarTokenValid.value = false;
                        }
                    }
                } else {
                    // ... (Code suppression identique √† avant) ...
                    googleAccessToken.value = '';
                    googleCalendarConnected.value = false;
                    if (user.role !== 'admin') {
                        prospecteurGoogleCalendarConnected.value = false;
                    }
                }
            });
            
            // 6. --- SYNCHRONISATION GOOGLE CALENDAR POUR PROSPECTEURS (Token individuel) ---
            // Chaque prospecteur a son propre token stock√© dans users/{userId}/googleToken
            if (user.role !== 'admin' && user.id) {
                db.collection('users').doc(user.id).onSnapshot((userDoc) => {
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        // Si l'utilisateur a un token individuel, on l'utilise
                        // Sinon, on garde le token du localStorage
                        if (userData.googleToken && userData.googleToken.token) {
                            const savedLocalToken = localStorage.getItem('prospecteur_google_calendar_token');
                            // Si le token Firestore est diff√©rent du localStorage, mettre √† jour
                            if (savedLocalToken !== userData.googleToken.token) {
                                // V√©rifier si le token Firestore est valide
                                fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                                    headers: { 'Authorization': `Bearer ${userData.googleToken.token}` }
                                })
                                .then(res => {
                                    if (res.ok) {
                                        // Token valide, l'utiliser
                                        prospecteurGoogleCalendarToken.value = userData.googleToken.token;
                                        prospecteurGoogleCalendarConnected.value = true;
                                        prospecteurGoogleCalendarTokenValid.value = true;
                                        prospecteurGoogleCalendarTokenExpired.value = false;
                                        prospecteurTokenExpirationTime.value = userData.googleToken.expires || (Date.now() + (55 * 60 * 1000));
                                        localStorage.setItem('prospecteur_google_calendar_token', userData.googleToken.token);
                                        localStorage.setItem('prospecteur_google_calendar_email', userData.googleToken.email || '');
                                        startProspecteurTokenRefresh();
                                    }
                                })
                                .catch(() => {
                                    // Token invalide, ne pas l'utiliser
                                });
                            }
                        }
                    }
                });
            }
                // 6. Horloge
                setInterval(() => {
                    now.value = new Date();
                    // Mettre √† jour filters.date pour la coh√©rence (mais on utilise timelineShowTomorrow pour la logique)
                    const todayStr = new Date().toISOString().split('T')[0];
                    if (!timelineShowTomorrow.value) {
                        // Si on est en mode "aujourd'hui", s'assurer que filters.date est √† jour
                        if (filters.date !== todayStr) {
                            filters.date = todayStr;
                        }
                    }
                }, 1000); // V√©rifier toutes les secondes pour d√©tecter le changement de jour rapidement
            });
           // --- ANTI-DECONNEXION (GLOBAL TOUTES LES 5 MINUTES) ---
            setInterval(() => {
                // Seul l'admin connect√© g√©n√®re le nouveau token pour tout le monde
                if (user.role === 'admin' && googleCalendarConnected.value && googleTokenClient) {
                    console.log("üîÑ Cycle auto 5min : Renouvellement du token...");
                    googleTokenClient.requestAccessToken({ prompt: 'none' });
                }
            }, 5 * 60 * 1000); // 5 minutes exactes
                
            // --- V√âRIFICATION P√âRIODIQUE DU TOKEN (Toutes les 30 secondes pour d√©tection en temps r√©el) ---
                setInterval(() => {
                    if (user.role === 'admin' && googleCalendarConnected.value && googleAccessToken.value) {
                        checkAndUpdateTokenStatus();
                    }
                    // V√©rifier aussi le token prospecteur
                    if (user.role !== 'admin' && (prospecteurGoogleCalendarConnected.value || googleCalendarConnected.value)) {
                        checkAndUpdateProspecteurTokenStatus();
                    }
                }, 30000); // V√©rifier toutes les 30 secondes
                
            // --- RACCOURCIS CLAVIER ---
            document.addEventListener('keydown', (e) => {
                // Ctrl/Cmd + K : Recherche globale
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    if (user.logged) {
                        globalSearchModal.open = true;
                        setTimeout(() => {
                            const input = document.querySelector('#globalSearchInput');
                            if (input) input.focus();
                        }, 100);
                    }
                }
                // Ctrl/Cmd + N : Nouveau RDV
                if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                    e.preventDefault();
                    if (user.logged && !wizard.open) {
                        startWizard();
                    }
                }
                // ESC : Fermer les modals
                if (e.key === 'Escape') {
                    if (globalSearchModal.open) globalSearchModal.open = false;
                    if (wizard.open) wizard.open = false;
                    if (clientModal.open) clientModal.open = false;
                    if (settingsModal.open) settingsModal.open = false;
                }
            });
                
            // --- V√âRIFICATION EXPIRATION TOKEN PROSPECTEURS (Toutes les 5 minutes) ---
                if (user.role !== 'admin') {
                    // V√©rifier imm√©diatement
                    setTimeout(() => {
                        checkProspecteurTokenExpiration();
                    }, 5000);
                    
                    // Puis v√©rifier toutes les 5 minutes
                    setInterval(() => {
                        checkProspecteurTokenExpiration();
                    }, 5 * 60 * 1000);
                }
            // Charger les r√©glages de synchronisation
            db.collection('settings').doc('calendar_sync').onSnapshot((snap) => {
                if (snap.exists) {
                    const data = snap.data();
                    if (data.syncAfterRdvTime !== undefined) {
                        syncSettings.syncAfterRdvTime = data.syncAfterRdvTime;
                    }
                    if (data.syncInterval) {
                        syncSettings.syncInterval = data.syncInterval;
                    }
                } else {
                    // Valeurs par d√©faut
                    syncSettings.syncAfterRdvTime = false;
                    syncSettings.syncInterval = 30;
                }
            });

            // Fonction pour d√©marrer/red√©marrer la synchronisation p√©riodique
            const startPeriodicSync = () => {
                // Arr√™ter l'ancien intervalle si existe
                if (window.calendarSyncInterval) {
                    clearInterval(window.calendarSyncInterval);
                    window.calendarSyncInterval = null;
                }

                if (googleCalendarConnected.value && googleAccessToken.value) {
                    const intervalMs = syncSettings.syncInterval * 1000;
                    console.log(`üîÑ D√©marrage synchronisation automatique toutes les ${syncSettings.syncInterval} secondes`);
                    
                    window.calendarSyncInterval = setInterval(async () => {
                        if (googleCalendarConnected.value && googleAccessToken.value) {
                            try {
                                const now = new Date();
                                const startDate = new Date(now);
                                startDate.setDate(startDate.getDate() - 7);
                                startDate.setHours(0, 0, 0, 0);
                                const endDate = new Date(now);
                                endDate.setDate(endDate.getDate() + 7);
                                endDate.setHours(23, 59, 59, 999);
                                
                                const timeMin = startDate.toISOString();
                                const timeMax = endDate.toISOString();
                                
                                const calendarIds = ['primary'];
                                agences.value.forEach(agence => {
                                    if (agence.agendaEmail && agence.agendaEmail.trim()) {
                                        calendarIds.push(agence.agendaEmail.trim());
                                    }
                                });
                                
                                const allGoogleEvents = [];
                                for (const calendarId of calendarIds) {
                                    try {
                                        const encodedId = encodeURIComponent(calendarId);
                                        const url = `https://www.googleapis.com/calendar/v3/calendars/${encodedId}/events?timeMin=${timeMin}&timeMax=${timeMax}&singleEvents=true&orderBy=startTime`;
                                        
                                        const response = await fetch(url, {
                                            headers: {
                                                'Authorization': `Bearer ${googleAccessToken.value}`
                                            }
                                        });
                                        
                                        if (response.ok) {
                                            const data = await response.json();
                                            if (data.items) {
                                                allGoogleEvents.push(...data.items);
                                            }
                                        }
                                    } catch (err) {
                                        console.warn(`Erreur synchronisation calendrier ${calendarId}:`, err);
                                    }
                                }
                                
                                console.log('‚úÖ Synchronisation automatique Google Calendar effectu√©e');
                            } catch (err) {
                                console.error('Erreur synchronisation automatique:', err);
                            }
                        }
                    }, intervalMs);
                }
            };

            // Synchronisation p√©riodique Google Calendar (s√©par√©e du onMounted)
            watch([googleCalendarConnected, googleAccessToken], ([connected, token]) => {
                if (connected && token) {
                    startPeriodicSync();
                } else {
                    // Arr√™ter la synchronisation si d√©connect√©
                    if (window.calendarSyncInterval) {
                        clearInterval(window.calendarSyncInterval);
                        window.calendarSyncInterval = null;
                    }
                }
            });

            // Red√©marrer la synchronisation si les r√©glages changent
            watch([() => syncSettings.syncInterval], () => {
                if (googleCalendarConnected.value && googleAccessToken.value) {
                    startPeriodicSync();
                }
            });

            const visibleAgencies = computed(() => {
                if (user.role === 'admin') return agences.value;
                const currentUserObj = teamList.value.find(u => u.name === user.name);
                const allowedIds = currentUserObj?.assignedAgencies || [];
                return agences.value.filter(a => allowedIds.includes(a.id));
            });

            const loadRdvData = () => {
                if(rdvListener) rdvListener();
                let query = db.collection('rendezvous');
                if(user.role !== 'admin') {
                    query = query.where('createdBy', '==', user.name);
                }
                rdvListener = query.onSnapshot(snap => {
                    const newRdvs = snap.docs.map(d => {
                        const data = d.data();
                        const created = data.created && data.created.toDate ? data.created.toDate() : (data.created ? new Date(data.created) : null);
                        return {id:d.id, ...data, created};
                    });
                    
                    // D√©tecter les changements de statut pour supprimer les transactions
                    // Note: On ne cr√©e PAS les transactions ici car elles sont cr√©√©es manuellement dans finalizeHonor/updateStatus
                    // Cela √©vite les doublons
                    if (rdvList.value.length > 0) {
                        for (const newRdv of newRdvs) {
                            const oldRdv = rdvList.value.find(r => r.id === newRdv.id);
                            if (oldRdv) {
                                // Si le RDV √©tait honor√© et ne l'est plus, supprimer les transactions
                                if (oldRdv.statut === 'honore' && newRdv.statut !== 'honore') {
                                    deleteTransactionsForRdv(newRdv.id);
                                }
                                // On ne cr√©e PAS les transactions ici pour √©viter les doublons
                                // Elles sont cr√©√©es dans finalizeHonor() et updateStatus()
                            }
                        }
                    }
                    
                    rdvList.value = newRdvs;

                    // Charger les transactions si on est connect√© et dans le portefeuille
                    if (user.logged && user.role !== 'admin' && user.name && view.value === 'portefeuille') {
                        loadUserTransactions();
                    }

                    // V√âRIFICATION D√âMARRAGE (Debounce pour attendre chargement complet)
                    if (user.logged && !checksDone.value) {
                        if (startupTimer.value) clearTimeout(startupTimer.value);
                        startupTimer.value = setTimeout(() => {
                            performStartupChecks();
                        }, 1000); 
                    }
                });
            };

            const performStartupChecks = () => {
                if (checksDone.value) return; 
                
                // 1. STATUTS MANQUANTS (Priorit√© Absolue)
                const pendingCount = rdvList.value.filter(r => { 
                    if(!['confirme', 'a_confirmer'].includes(r.statut)) return false; 
                    if(!r.date || !r.heure) return false; 
                    const end = new Date(r.date+'T'+r.heure).getTime() + 3600000; 
                    return new Date().getTime() > end; 
                }).length;

                if (pendingCount > 0) {
                    pendingStatusModal.open = true;
                    checksDone.value = true;
                    return; // Bloque les autres alertes
                }

                // 2. RAPPELS
                const currentHour = new Date().getHours();
                const startHour = parseInt(globalSettings.value.reminderStartTime.split(':')[0] || "8");
                const canShowToday = currentHour >= startHour;
                const eveStartHour = parseInt(globalSettings.value.reminderEveTime.split(':')[0] || "16");
                const canShowVeille = currentHour >= eveStartHour;

                const hasVeille = rappelsVeilleCount.value > 0;
                const hasJour = rappelsJourCount.value > 0;

                if ((hasVeille && canShowVeille) || (hasJour && canShowToday)) {
                    reminderAlertModal.open = true;
                }
                
                // 3. RAPPELS COMMERCIAUX (apr√®s les autres v√©rifications)
                setTimeout(() => {
                    checkCommercialReminders();
                }, 2000); // Attendre 2 secondes pour que les donn√©es soient charg√©es
                
                checksDone.value = true;
            };

            // Fonction pour v√©rifier et afficher les rappels quotidiens pour les commerciaux
            const checkCommercialReminders = (forceImmediate = false) => {
                if (!user.logged) return;
                
                const now = new Date();
                const currentHour = now.getHours();
                const today = now.toISOString().split('T')[0]; // Format YYYY-MM-DD
                
                // R√©cup√©rer les notifications d√©j√† affich√©es aujourd'hui
                const reminderKey = `commercial_reminder_${user.name}_${today}`;
                const shownReminders = JSON.parse(localStorage.getItem(reminderKey) || '[]');
                
                // Compter les RDV √† traiter
                let urgentCount = 0;
                if (user.role === 'admin') {
                    urgentCount = urgentBilanCount.value;
                } else {
                    urgentCount = prospecteurUrgentCount.value;
                }
                
                // Si pas de RDV √† traiter, ne rien afficher
                if (urgentCount === 0) return;
                
                // Si forceImmediate est true, afficher imm√©diatement (premi√®re fois qu'on d√©tecte un RDV √† traiter)
                if (forceImmediate && !shownReminders.includes('immediate')) {
                    const message = `‚ö†Ô∏è √Ä traiter : ${urgentCount} rendez-vous n√©cessitent l'assignation d'un commercial. V√©rifiez si le commercial a mis son nom.`;
                    showNotification(message, 'warning', 'fa-exclamation-triangle', true, 'a_traiter');
                    shownReminders.push('immediate');
                    localStorage.setItem(reminderKey, JSON.stringify(shownReminders));
                }
                
                // Premi√®re notification : √† partir de 10h (premi√®re connexion de la journ√©e)
                if (currentHour >= 10 && !shownReminders.includes('morning')) {
                    const message = `‚ö†Ô∏è √Ä traiter : ${urgentCount} rendez-vous n√©cessitent l'assignation d'un commercial. V√©rifiez si le commercial a mis son nom.`;
                    showNotification(message, 'warning', 'fa-exclamation-triangle', true, 'a_traiter');
                    shownReminders.push('morning');
                    localStorage.setItem(reminderKey, JSON.stringify(shownReminders));
                }
                
                // Deuxi√®me notification : √† partir de 13h
                if (currentHour >= 13 && !shownReminders.includes('afternoon')) {
                    const message = `‚ö†Ô∏è √Ä traiter : ${urgentCount} rendez-vous n√©cessitent encore l'assignation d'un commercial. V√©rifiez si le commercial a mis son nom.`;
                    showNotification(message, 'warning', 'fa-exclamation-triangle', true, 'a_traiter');
                    shownReminders.push('afternoon');
                    localStorage.setItem(reminderKey, JSON.stringify(shownReminders));
                }
            };

            // V√©rifier p√©riodiquement les rappels commerciaux (toutes les heures)
            setInterval(() => {
                if (user.logged) {
                    checkCommercialReminders();
                }
            }, 3600000); // Toutes les heures

            // Fonction de recherche globale am√©lior√©e
            const performGlobalSearch = () => {
                if (!globalSearchModal.query || globalSearchModal.query.length < 2) {
                    globalSearchModal.results = [];
                    return;
                }
                const query = globalSearchModal.query.toLowerCase().trim();
                const queryWords = query.split(/\s+/); // S√©parer en mots pour recherche par pr√©nom/nom
                const results = rdvList.value.filter(rdv => {
                    if (!rdv || rdv.statut === 'poubelle') return false;
                    
                    // Recherche dans nom complet (inclut pr√©nom et nom)
                    if (rdv.nom) {
                        const nomLower = rdv.nom.toLowerCase();
                        // Recherche exacte dans le nom complet
                        if (nomLower.includes(query)) return true;
                        // Recherche par mots individuels (pr√©nom ou nom s√©par√©ment)
                        const nomWords = nomLower.split(/\s+/);
                        if (queryWords.some(qw => nomWords.some(nw => nw.includes(qw) || qw.includes(nw)))) return true;
                    }
                    
                    // Recherche dans t√©l√©phone (format flexible)
                    if (rdv.telephone) {
                        const phoneClean = rdv.telephone.replace(/\D/g, '');
                        const queryClean = query.replace(/\D/g, '');
                        if (phoneClean.includes(queryClean) || queryClean.includes(phoneClean)) return true;
                    }
                    
                    // Recherche dans mod√®le
                    if (rdv.modele && rdv.modele.toLowerCase().includes(query)) return true;
                    
                    // Recherche dans date (format flexible)
                    if (rdv.date) {
                        const dateStr = formatDateFr(rdv.date).toLowerCase();
                        if (dateStr.includes(query)) return true;
                        // Recherche par mots-cl√©s date
                        if (query.includes('aujourd') && rdv.date === new Date().toISOString().split('T')[0]) return true;
                        if (query.includes('demain')) {
                            const tomorrow = new Date();
                            tomorrow.setDate(tomorrow.getDate() + 1);
                            if (rdv.date === tomorrow.toISOString().split('T')[0]) return true;
                        }
                    }
                    return false;
                }).slice(0, 10); // Limiter √† 10 r√©sultats
                globalSearchModal.results = results;
            };
            
            const selectFirstResult = () => {
                if (globalSearchModal.results.length > 0) {
                    openRdvFiche(globalSearchModal.results[0]);
                    globalSearchModal.open = false;
                    globalSearchModal.query = '';
                }
            };
            
            // Fonction pour enregistrer une action dans l'historique
            const logAction = (action, details) => {
                const logEntry = {
                    id: Date.now().toString(),
                    timestamp: new Date().toISOString(),
                    user: user.name,
                    role: user.role,
                    action: action,
                    details: details
                };
                actionHistory.value.unshift(logEntry);
                // Garder seulement les 100 derni√®res actions
                if (actionHistory.value.length > 100) {
                    actionHistory.value = actionHistory.value.slice(0, 100);
                }
                // Sauvegarder dans Firestore
                db.collection('actionLogs').add(logEntry).catch(err => console.error('Erreur sauvegarde log:', err));
            };
            
            // Fonction pour charger les logs d√©taill√©s depuis Firestore
            const loadDetailedLogs = async () => {
                try {
                    const logsSnapshot = await db.collection('actionLogs')
                        .orderBy('timestamp', 'desc')
                        .limit(500)
                        .get();
                    
                    detailedLogs.value = logsSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                } catch(err) {
                    console.error('Erreur chargement logs:', err);
                    showNotification('Erreur lors du chargement des logs', 'error', 'fa-exclamation-triangle');
                }
            };
            
            // Fonction pour charger l'historique des connexions
            const loadConnexionsHistory = async () => {
                loadingConnexions.value = true;
                try {
                    // M√©thode principale : charger tous les logs r√©cents et filtrer c√¥t√© client
                    // Cela √©vite les probl√®mes d'index Firestore
                    const allLogsSnapshot = await db.collection('actionLogs')
                        .orderBy('timestamp', 'desc')
                        .limit(1000)
                        .get();
                    
                    const filteredLogs = allLogsSnapshot.docs
                        .map(doc => ({ id: doc.id, ...doc.data() }))
                        .filter(log => {
                            const action = log.action;
                            const hasUser = log.user || log.details?.utilisateur;
                            return (action === 'connexion' || action === 'deconnexion') && hasUser;
                        })
                        .slice(0, 200);
                    
                    connexionsHistory.value = filteredLogs;
                    
                    // Calculer qui est actuellement connect√©
                    calculateConnectedUsers();
                    
                    console.log(`‚úÖ ${filteredLogs.length} connexions/d√©connexions charg√©es, ${connectedUsers.value.length} utilisateurs connect√©s`);
                } catch(err) {
                    console.error('Erreur chargement historique connexions:', err);
                    showNotification(`Erreur: ${err.message || 'Impossible de charger l\'historique'}`, 'error', 'fa-exclamation-triangle');
                } finally {
                    loadingConnexions.value = false;
                }
            };
            
            // Fonction pour calculer qui est actuellement connect√©
            const calculateConnectedUsers = () => {
                const userStates = {}; // { userName: { lastAction: 'connexion'|'deconnexion', timestamp: ... } }
                const now = new Date();
                
                // Trier l'historique par timestamp (du plus ancien au plus r√©cent)
                const sortedLogs = [...connexionsHistory.value].sort((a, b) => 
                    new Date(a.timestamp) - new Date(b.timestamp)
                );
                
                // Parcourir l'historique chronologiquement pour d√©terminer l'√©tat final de chaque utilisateur
                sortedLogs.forEach(log => {
                    const userName = log.user || log.details?.utilisateur;
                    if(!userName || userName === 'Syst√®me') return;
                    
                    // Mettre √† jour l'√©tat de l'utilisateur avec la derni√®re action
                    if(!userStates[userName] || new Date(log.timestamp) > new Date(userStates[userName].timestamp)) {
                        userStates[userName] = {
                            lastAction: log.action,
                            timestamp: log.timestamp,
                            role: log.details?.role || log.role || 'prospecteur',
                            log: log
                        };
                    }
                });
                
                // Filtrer pour ne garder que ceux qui sont connect√©s (derni√®re action = connexion)
                const connected = Object.entries(userStates)
                    .filter(([userName, state]) => state.lastAction === 'connexion')
                    .map(([userName, state]) => {
                        const log = state.log;
                        return {
                            name: userName,
                            role: state.role,
                            heureConnexion: new Date(state.timestamp).toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'}),
                            dateConnexion: new Date(state.timestamp).toISOString().split('T')[0],
                            timestamp: state.timestamp
                        };
                    });
                
                // Calculer le temps depuis la connexion
                connectedUsers.value = connected.map(u => {
                    const connecteDepuis = new Date(u.timestamp);
                    const diff = now - connecteDepuis;
                    const heures = Math.floor(diff / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    
                    let tempsDepuis = '';
                    if(heures > 0) {
                        tempsDepuis = `${heures}h ${minutes}min`;
                    } else if(minutes > 0) {
                        tempsDepuis = `${minutes}min`;
                    } else {
                        tempsDepuis = '√Ä l\'instant';
                    }
                    
                    return {
                        ...u,
                        connecteDepuis: tempsDepuis
                    };
                });
            };
            
            // Listener en temps r√©el pour les nouvelles connexions/d√©connexions
            let connexionsListener = null;
            let connexionsInterval = null;
            const startConnexionsListener = () => {
                if(connexionsListener) connexionsListener(); // D√©tacher l'ancien listener
                if(connexionsInterval) clearInterval(connexionsInterval);
                
                // Utiliser un listener simple sur toutes les actions r√©centes
                try {
                    connexionsListener = db.collection('actionLogs')
                        .orderBy('timestamp', 'desc')
                        .limit(50)
                        .onSnapshot((snapshot) => {
                            // Ne pas recharger si on est en train de supprimer
                            if(isDeletingLogs.value) return;
                            
                            // Filtrer pour ne garder que les connexions/d√©connexions
                            const recentLogs = snapshot.docs
                                .map(doc => ({ id: doc.id, ...doc.data() }))
                                .filter(log => log.action === 'connexion' || log.action === 'deconnexion');
                            
                            // Si on a de nouveaux logs, recharger
                            if(recentLogs.length > 0 && view.value === 'connexions') {
                                loadConnexionsHistory();
                            }
                        }, (error) => {
                            console.warn('Listener connexions non disponible:', error);
                        });
                } catch(err) {
                    console.warn('Erreur listener, utilisation du polling uniquement');
                }
            };
            
            const stopConnexionsListener = () => {
                if(connexionsListener) {
                    connexionsListener();
                    connexionsListener = null;
                }
                if(connexionsInterval) {
                    clearInterval(connexionsInterval);
                    connexionsInterval = null;
                }
            };
            
            // Fonction pour s√©lectionner/d√©s√©lectionner un log
            const toggleConnexionLogSelection = (logId) => {
                const index = selectedConnexionLogs.value.indexOf(logId);
                if(index > -1) {
                    selectedConnexionLogs.value.splice(index, 1);
                } else {
                    selectedConnexionLogs.value.push(logId);
                }
            };
            
            // Fonction pour supprimer les logs s√©lectionn√©s ou tout supprimer
            const deleteConnexionLogs = async () => {
                try {
                    // 1. Activer isDeletingLogs.value = true d√®s le d√©but
                    isDeletingLogs.value = true;
                    
                    // 2. Calculer les logs √† supprimer
                    let logsToDelete = [];
                    
                    if(connexionDeleteModal.value.mode === 'all') {
                        logsToDelete = connexionsHistory.value.map(log => log.id);
                    } else {
                        logsToDelete = [...selectedConnexionLogs.value];
                    }
                    
                    if(logsToDelete.length === 0) {
                        showNotification('Aucun log √† supprimer', 'warning', 'fa-exclamation-triangle');
                        connexionDeleteModal.value.open = false;
                        isDeletingLogs.value = false;
                        return;
                    }
                    
                    // Fermer la modale imm√©diatement
                    connexionDeleteModal.value.open = false;
                    
                    // Supprimer de Firestore
                    const batch = db.batch();
                    logsToDelete.forEach(logId => {
                        const logRef = db.collection('actionLogs').doc(logId);
                        batch.delete(logRef);
                    });
                    
                    await batch.commit();
                    
                    // 3. Apr√®s await batch.commit(), filtrer manuellement connexionsHistory.value pour retirer les logs supprim√©s
                    connexionsHistory.value = connexionsHistory.value.filter(log => !logsToDelete.includes(log.id));
                    
                    // 4. Vider selectedConnexionLogs.value et appeler calculateConnectedUsers()
                    selectedConnexionLogs.value = [];
                    calculateConnectedUsers();
                    
                    showNotification(`${logsToDelete.length} log(s) supprim√©(s) avec succ√®s`, 'success', 'fa-check-circle');
                    
                    // 5. Utiliser un setTimeout de 1.5s avant de remettre isDeletingLogs.value √† false et relancer loadConnexionsHistory()
                    setTimeout(() => {
                        isDeletingLogs.value = false;
                        loadConnexionsHistory();
                    }, 1500);
                } catch(err) {
                    console.error('Erreur suppression logs:', err);
                    showNotification('Erreur lors de la suppression', 'error', 'fa-exclamation-triangle');
                    isDeletingLogs.value = false;
                }
            };
            
            // Fonction pour ouvrir le modal d'historique d'un utilisateur
            const openUserHistoryModal = async (user) => {
                userHistoryModal.value = {
                    open: true,
                    user: user,
                    history: [],
                    loading: true
                };
                
                // Charger l'historique de l'utilisateur
                await loadUserHistory(user.name);
            };
            
            // Fonction pour charger l'historique d'un utilisateur sp√©cifique
            const loadUserHistory = async (userName) => {
                try {
                    userHistoryModal.value.loading = true;
                    
                    // Charger tous les logs de connexion/d√©connexion pour cet utilisateur
                    const allLogsSnapshot = await db.collection('actionLogs')
                        .orderBy('timestamp', 'desc')
                        .limit(1000)
                        .get();
                    
                    const userLogs = allLogsSnapshot.docs
                        .map(doc => ({ id: doc.id, ...doc.data() }))
                        .filter(log => {
                            const logUser = log.user || log.details?.utilisateur;
                            return (log.action === 'connexion' || log.action === 'deconnexion') && logUser === userName;
                        })
                        .slice(0, 200); // Limiter √† 200 entr√©es
                    
                    userHistoryModal.value.history = userLogs;
                    
                    // Calculer le r√©sum√© mensuel
                    calculateMonthlySummary(userName, userLogs);
                    
                } catch(err) {
                    console.error('Erreur chargement historique utilisateur:', err);
                    showNotification('Erreur lors du chargement de l\'historique', 'error', 'fa-exclamation-triangle');
                } finally {
                    userHistoryModal.value.loading = false;
                }
            };
            
            // Fonction pour calculer le r√©sum√© mensuel d'un utilisateur
            const calculateMonthlySummary = (userName, logs) => {
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                
                // Filtrer les logs du mois en cours
                const monthLogs = logs.filter(log => {
                    const logDate = new Date(log.timestamp);
                    return logDate.getMonth() === currentMonth && logDate.getFullYear() === currentYear;
                });
                
                // Compter les connexions
                const connexions = monthLogs.filter(log => log.action === 'connexion').length;
                
                // Calculer le temps total connect√©
                let tempsTotal = 0; // en millisecondes
                let derniereConnexion = null;
                let derniereDeconnexion = null;
                
                // Parcourir les logs pour calculer le temps
                for(let i = 0; i < monthLogs.length; i++) {
                    const log = monthLogs[i];
                    if(log.action === 'connexion') {
                        derniereConnexion = new Date(log.timestamp);
                        // Chercher la d√©connexion suivante
                        for(let j = i + 1; j < monthLogs.length; j++) {
                            if(monthLogs[j].action === 'deconnexion') {
                                derniereDeconnexion = new Date(monthLogs[j].timestamp);
                                tempsTotal += derniereDeconnexion - derniereConnexion;
                                break;
                            }
                        }
                        // Si pas de d√©connexion trouv√©e et que c'est la derni√®re connexion, calculer jusqu'√† maintenant
                        if(i === 0 && !derniereDeconnexion) {
                            tempsTotal += now - derniereConnexion;
                        }
                    }
                }
                
                // Convertir en heures et minutes
                const heures = Math.floor(tempsTotal / (1000 * 60 * 60));
                const minutes = Math.floor((tempsTotal % (1000 * 60 * 60)) / (1000 * 60));
                const tempsTotalFormate = heures > 0 ? `${heures}h ${minutes}min` : `${minutes}min`;
                
                // Derni√®re connexion format√©e
                const derniereConnexionFormatee = derniereConnexion 
                    ? derniereConnexion.toLocaleDateString('fr-FR', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'})
                    : '-';
                
                monthlySummaries.value[userName] = {
                    connexions: connexions,
                    tempsTotal: tempsTotalFormate,
                    derniereConnexion: derniereConnexionFormatee
                };
            };
            
            // Fonction pour g√©n√©rer automatiquement un r√©sum√© mensuel √† la fin de chaque mois
            const generateMonthlySummary = async () => {
                const now = new Date();
                const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                const isLastDay = now.getDate() === lastDayOfMonth.getDate();
                
                // V√©rifier si on est le dernier jour du mois
                if(isLastDay) {
                    try {
                        // R√©cup√©rer tous les logs r√©cents (m√©thode alternative sans filtre 'in')
                        const allLogsSnapshot = await db.collection('actionLogs')
                            .orderBy('timestamp', 'desc')
                            .limit(5000)
                            .get();
                        
                        const allLogs = allLogsSnapshot.docs
                            .map(doc => ({ id: doc.id, ...doc.data() }))
                            .filter(log => log.action === 'connexion' || log.action === 'deconnexion');
                        
                        const uniqueUsers = [...new Set(allLogs.map(log => log.user || log.details?.utilisateur).filter(Boolean))];
                        
                        // Calculer le r√©sum√© du mois pr√©c√©dent
                        const previousMonth = now.getMonth() === 0 ? 11 : now.getMonth() - 1;
                        const previousYear = now.getMonth() === 0 ? now.getFullYear() - 1 : now.getFullYear();
                        
                        // G√©n√©rer un r√©sum√© pour chaque utilisateur
                        for(const userName of uniqueUsers) {
                            const userLogs = allLogs.filter(log => {
                                const logUser = log.user || log.details?.utilisateur;
                                return logUser === userName;
                            });
                            
                            const monthLogs = userLogs.filter(log => {
                                const logDate = new Date(log.timestamp);
                                return logDate.getMonth() === previousMonth && logDate.getFullYear() === previousYear;
                            });
                            
                            if(monthLogs.length > 0) {
                                // V√©rifier si le r√©sum√© existe d√©j√†
                                const existingSummary = await db.collection('monthlySummaries')
                                    .where('userName', '==', userName)
                                    .where('month', '==', previousMonth + 1)
                                    .where('year', '==', previousYear)
                                    .get();
                                
                                if(existingSummary.empty) {
                                    // Sauvegarder le r√©sum√© dans Firestore
                                    await db.collection('monthlySummaries').add({
                                        userName: userName,
                                        month: previousMonth + 1,
                                        year: previousYear,
                                        connexions: monthLogs.filter(log => log.action === 'connexion').length,
                                        timestamp: new Date(),
                                        logs: monthLogs.map(log => ({
                                            action: log.action,
                                            timestamp: log.timestamp
                                        }))
                                    });
                                }
                            }
                        }
                        
                        console.log('‚úÖ R√©sum√©s mensuels g√©n√©r√©s automatiquement');
                    } catch(err) {
                        console.error('Erreur g√©n√©ration r√©sum√©s mensuels:', err);
                    }
                }
            };
            
            // V√©rifier chaque jour √† minuit si on doit g√©n√©rer les r√©sum√©s
            const checkAndGenerateMonthlySummary = () => {
                const now = new Date();
                const nextCheck = new Date(now);
                nextCheck.setDate(now.getDate() + 1);
                nextCheck.setHours(0, 0, 0, 0);
                
                const timeUntilCheck = nextCheck - now;
                
                setTimeout(() => {
                    generateMonthlySummary();
                    // V√©rifier ensuite chaque jour
                    setInterval(generateMonthlySummary, 24 * 60 * 60 * 1000);
                }, timeUntilCheck);
            };
            
            // Fonction pour calculer les statistiques de performance
            const calculatePerformanceStats = () => {
                const now = new Date();
                const last30Days = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                const today = now.toISOString().split('T')[0];
                const startOfWeek = new Date(now);
                startOfWeek.setDate(now.getDate() - now.getDay());
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                
                const recentRdvs = rdvList.value.filter(r => {
                    const rdvDate = new Date(r.created || r.date);
                    return rdvDate >= last30Days;
                });
                
                if(recentRdvs.length === 0) {
                    Object.keys(performanceStats).forEach(key => performanceStats[key] = 0);
                    return;
                }
                
                const confirmes = recentRdvs.filter(r => ['confirme', 'a_confirmer'].includes(r.statut));
                const annules = recentRdvs.filter(r => r.statut === 'annule');
                const honores = recentRdvs.filter(r => r.statut === 'honore');
                const pasVenus = recentRdvs.filter(r => r.statut === 'pas_venu');
                const enAttente = recentRdvs.filter(r => r.statut === 'a_confirmer');
                const total = recentRdvs.length;
                
                // Calculs des taux
                performanceStats.tauxConfirmation = Math.round((confirmes.length / total) * 100);
                performanceStats.tauxAnnulation = Math.round((annules.length / total) * 100);
                performanceStats.tauxHonorisation = Math.round((honores.length / total) * 100);
                const presents = honores.length + (total - annules.length - pasVenus.length - honores.length);
                performanceStats.tauxPresence = Math.round((presents / (total - annules.length)) * 100) || 0;
                
                // Totaux
                performanceStats.totalRdvs = total;
                performanceStats.totalConfirmes = confirmes.length;
                performanceStats.totalAnnules = annules.length;
                performanceStats.totalHonores = honores.length;
                performanceStats.totalPresents = presents;
                performanceStats.totalEnAttente = enAttente.length;
                performanceStats.totalPasVenus = pasVenus.length;
                
                // Statistiques temporelles
                performanceStats.rdvAujourdhui = rdvList.value.filter(r => {
                    const rdvDate = new Date(r.created || r.date);
                    return rdvDate.toISOString().split('T')[0] === today;
                }).length;
                
                performanceStats.rdvCetteSemaine = rdvList.value.filter(r => {
                    const rdvDate = new Date(r.created || r.date);
                    return rdvDate >= startOfWeek;
                }).length;
                
                performanceStats.rdvCeMois = rdvList.value.filter(r => {
                    const rdvDate = new Date(r.created || r.date);
                    return rdvDate >= startOfMonth;
                }).length;
            };
            
            // Fonction pour pr√©dire la charge de travail
            const calculateWorkloadPrediction = () => {
                const prediction = [];
                const today = new Date();
                
                for(let i = 0; i < 7; i++) {
                    const date = new Date(today);
                    date.setDate(date.getDate() + i);
                    const dateStr = date.toISOString().split('T')[0];
                    
                    const rdvs = rdvList.value.filter(r => 
                        r.date === dateStr && 
                        ['confirme', 'a_confirmer'].includes(r.statut)
                    );
                    
                    const dayNames = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
                    const label = i === 0 ? "Aujourd'hui" : 
                                  i === 1 ? "Demain" : 
                                  dayNames[date.getDay()] + ' ' + date.getDate() + '/' + (date.getMonth() + 1);
                    
                    prediction.push({
                        date: dateStr,
                        label: label,
                        count: rdvs.length
                    });
                }
                
                workloadPrediction.value = prediction;
            };

            const checkAndShowWelcome = (email, name) => {
                const today = new Date().toISOString().split('T')[0];
                const lastLoginKey = 'lastWelcome_' + email;
                const lastLoginDate = localStorage.getItem(lastLoginKey);
                const firstLoginKey = 'firstLogin_' + email;
                const hasLoggedInBefore = localStorage.getItem(firstLoginKey);
                
                // V√©rifier si c'est la premi√®re connexion (pour les prospecteurs uniquement)
                if (user.role === 'prospecteur' && !hasLoggedInBefore) {
                    // Premi√®re connexion : afficher le tutoriel
                    tutorialModal.userName = name;
                    tutorialModal.step = 1;
                    tutorialModal.open = true;
                    localStorage.setItem(firstLoginKey, 'true');
                    return;
                }
                
                // Connexions suivantes : afficher le message de bienvenue normal
                if (lastLoginDate !== today) {
                    welcomeModal.title = `Bonjour ${name} ! üëã`;
                    welcomeModal.message = `Bienvenue dans ARIA !`;
                    welcomeModal.icon = 'üëã';
                    welcomeModal.open = true;
                    launchFireworks();
                    localStorage.setItem(lastLoginKey, today);
                    // Fermer automatiquement apr√®s 2 secondes
                    setTimeout(() => {
                        welcomeModal.open = false;
                    }, 2000);
                }
            };

            const saveGlobalSettings = async () => {
                await db.collection('settings').doc('global').set({
                    reminderStartTime: globalSettings.value.reminderStartTime,
                    reminderEveTime: globalSettings.value.reminderEveTime,
                    appLogoUrl: globalSettings.value.appLogoUrl || '',
                    rdvLinkBaseUrl: globalSettings.value.rdvLinkBaseUrl || '',
                    tutorialVideoUrl: globalSettings.value.tutorialVideoUrl || '',
                    commission: globalCommission
                }, { merge: true });
                alert("Param√®tres sauvegard√©s !");
            };
            
            const getFormatagePreview = () => {
                const sample = [
                    { label: 'Kilom√©trage', value: '132 500 km' },
                    { label: 'Bo√Æte de vitesse', value: 'manuelle' },
                    { label: 'Couleur ext√©rieure', value: 'Noir' },
                    { label: 'Type de carburant', value: 'Diesel' }
                ];
                
                return sample.map(carac => {
                    const label = formatageSettings.boldLabels ? `<b>${carac.label} :</b>` : `${carac.label} :`;
                    return `${label} ${carac.value}`;
                }).join(formatageSettings.spaceBetween ? '<br><br>' : '<br>');
            };
            
            const saveFormatageSettings = async () => {
                await db.collection('settings').doc('formatage').set(formatageSettings, { merge: true });
                showNotification('‚úÖ Param√®tres de formatage sauvegard√©s', 'success', 'fa-check-circle');
            };
            
            const loadRescheduleSMSMessages = async () => {
                try {
                    // Charger depuis les settings globaux
                    const settingsDoc = await db.collection('settings').doc('rescheduleMessages').get();
                    const globalMessages = settingsDoc.exists ? settingsDoc.data() : {};
                    
                    const messages = globalMessages.rescheduleSMSMessages || {};
                    const messagesClient = globalMessages.rescheduleSMSMessagesClient || {};
                    const motifs = globalMessages.rescheduleMotifsList || {};
                    
                    // Messages par d√©faut pour demande interne (SMS)
                    const defaultMessagesInterne = {
                        'meteo_route_dangereuse': `Bonjour, nous vous informons que votre rendez-vous pr√©vu le {{DATE_LONG}} √† {{HEURE}} √† notre agence {{AGENCE}} pour votre v√©hicule {{MODELE}} doit √™tre report√© en raison des conditions m√©t√©orologiques. Nous vous contacterons prochainement pour convenir d'une nouvelle date.`,
                        'vehicule_immobilise': `Bonjour, nous vous informons que votre rendez-vous pr√©vu le {{DATE_LONG}} √† {{HEURE}} √† notre agence {{AGENCE}} pour votre v√©hicule {{MODELE}} doit √™tre report√© car le v√©hicule ne peut pas bouger. Nous vous contacterons prochainement pour convenir d'une nouvelle date.`,
                        'contrainte_pro': `Bonjour, nous vous informons que votre rendez-vous pr√©vu le {{DATE_LONG}} √† {{HEURE}} √† notre agence {{AGENCE}} pour votre v√©hicule {{MODELE}} doit √™tre report√©. Nous vous contacterons prochainement pour convenir d'une nouvelle date.`,
                        'contrainte_personnelle': `Bonjour, nous vous informons que votre rendez-vous pr√©vu le {{DATE_LONG}} √† {{HEURE}} √† notre agence {{AGENCE}} pour votre v√©hicule {{MODELE}} doit √™tre report√©. Nous vous contacterons prochainement pour convenir d'une nouvelle date.`,
                        'documents_manquants': `Bonjour, nous vous informons que votre rendez-vous pr√©vu le {{DATE_LONG}} √† {{HEURE}} √† notre agence {{AGENCE}} pour votre v√©hicule {{MODELE}} doit √™tre report√© car des documents sont manquants. Nous vous contacterons prochainement pour convenir d'une nouvelle date.`,
                        'empechement_medical': `Bonjour, nous vous informons que votre rendez-vous pr√©vu le {{DATE_LONG}} √† {{HEURE}} √† notre agence {{AGENCE}} pour votre v√©hicule {{MODELE}} doit √™tre report√© pour motif de sant√©. Nous vous contacterons prochainement pour convenir d'une nouvelle date.`,
                        // Messages pour les motifs internes sp√©cifiques
                        'agence_fermee': `Bonjour, nous vous informons que votre rendez-vous pr√©vu le {{DATE_LONG}} √† {{HEURE}} √† notre agence {{AGENCE}} pour votre v√©hicule {{MODELE}} doit √™tre report√© car notre agence sera ferm√©e ce jour-l√†. Nous vous contacterons prochainement pour convenir d'une nouvelle date. Merci de votre compr√©hension.`,
                        'commercial_retard': `Bonjour, nous vous informons que votre rendez-vous pr√©vu le {{DATE_LONG}} √† {{HEURE}} √† notre agence {{AGENCE}} pour votre v√©hicule {{MODELE}} doit √™tre report√© car le commercial aura un peu de retard. Nous vous contacterons prochainement pour convenir d'une nouvelle date. Merci de votre compr√©hension.`,
                        'agence_retard': `Bonjour, nous vous informons que votre rendez-vous pr√©vu le {{DATE_LONG}} √† {{HEURE}} √† notre agence {{AGENCE}} pour votre v√©hicule {{MODELE}} doit √™tre report√© car notre agence aura un peu de retard ce jour-l√†. Nous vous contacterons prochainement pour convenir d'une nouvelle date. Merci de votre compr√©hension.`,
                        'intemperie': `Bonjour, nous vous informons que votre rendez-vous pr√©vu le {{DATE_LONG}} √† {{HEURE}} √† notre agence {{AGENCE}} pour votre v√©hicule {{MODELE}} doit √™tre report√© en raison des intemp√©ries. Nous vous contacterons prochainement pour convenir d'une nouvelle date. Merci de votre compr√©hension.`,
                        'absence_imprevue': `Bonjour, nous vous informons que votre rendez-vous pr√©vu le {{DATE_LONG}} √† {{HEURE}} √† notre agence {{AGENCE}} pour votre v√©hicule {{MODELE}} doit √™tre report√© en raison d'une absence impr√©vue. Nous vous contacterons prochainement pour convenir d'une nouvelle date. Merci de votre compr√©hension.`
                    };
                    
                    // Messages par d√©faut pour demande client (Agenda)
                    const defaultMessagesClient = {
                        'meteo_route_dangereuse': 'Le rendez-vous a √©t√© report√© en raison des conditions m√©t√©orologiques (conditions de la route dangereuse : neige, verglas ou forte inondations)',
                        'vehicule_immobilise': 'Le rendez-vous a √©t√© report√© car le v√©hicule ne peut pas bouger',
                        'contrainte_pro': 'Le rendez-vous a √©t√© report√© car le client ne peut pas quitter son poste ou une r√©union de derni√®re minute l\'emp√™che de venir au rendez-vous',
                        'contrainte_personnelle': 'Le rendez-vous a √©t√© report√© car le client ne peut pas se d√©placer pour des raisons personnelles. Nous sommes dans l\'obligation de d√©placer le rendez-vous.',
                        'documents_manquants': 'Le rendez-vous a √©t√© report√© car le client se rend compte qu\'il n\'a pas tous les documents avec lui',
                        'empechement_medical': 'Le rendez-vous a √©t√© report√© pour motif de sant√© : incapacit√© de conduire, maladie soudaine, blessure ou fatigue extr√™me, rendant la conduite dangereuse pour le client'
                    };
                    
                    // Charger les messages internes (utiliser les personnalis√©s ou les d√©fauts)
                    Object.keys(rescheduleSMSMessages).forEach(key => {
                        rescheduleSMSMessages[key] = messages[key] || defaultMessagesInterne[key] || '';
                    });
                    
                    // Charger les messages client (utiliser les personnalis√©s ou les d√©fauts)
                    Object.keys(rescheduleSMSMessagesClient).forEach(key => {
                        rescheduleSMSMessagesClient[key] = messagesClient[key] || defaultMessagesClient[key] || '';
                    });
                    
                    // Charger les motifs personnalis√©s
                    Object.keys(motifs).forEach(key => {
                        if (rescheduleMotifsList[key] !== undefined) {
                            rescheduleMotifsList[key] = motifs[key];
                        }
                    });
                    
                    // Charger les motifs internes personnalis√©s
                    const motifsInterne = globalMessages.rescheduleMotifsListInterne || {};
                    Object.keys(motifsInterne).forEach(key => {
                        if (rescheduleMotifsListInterne[key] !== undefined) {
                            rescheduleMotifsListInterne[key] = motifsInterne[key];
                        }
                    });
                    
                    // Charger les messages SMS pour les motifs internes (utiliser les personnalis√©s ou les d√©fauts)
                    Object.keys(rescheduleMotifsListInterne).forEach(key => {
                        // V√©rifier d'abord dans les messages personnalis√©s
                        if (messages[key] && messages[key].trim()) {
                            rescheduleSMSMessages[key] = messages[key];
                        } else if (defaultMessagesInterne[key]) {
                            rescheduleSMSMessages[key] = defaultMessagesInterne[key];
                        } else {
                            rescheduleSMSMessages[key] = '';
                        }
                    });
                } catch (err) {
                    console.error('Erreur chargement messages:', err);
                }
            };
            
            const saveRescheduleSMSMessages = async () => {
                try {
                    await db.collection('settings').doc('rescheduleMessages').set({
                        rescheduleSMSMessages: { ...rescheduleSMSMessages },
                        rescheduleSMSMessagesClient: { ...rescheduleSMSMessagesClient },
                        rescheduleMotifsList: { ...rescheduleMotifsList },
                        rescheduleMotifsListInterne: { ...rescheduleMotifsListInterne }
                    }, { merge: true });
                    showNotification('‚úÖ Messages de report sauvegard√©s pour toutes les agences', 'success', 'fa-check-circle');
                } catch (err) {
                    console.error('Erreur sauvegarde messages:', err);
                    showNotification('Erreur lors de la sauvegarde', 'error', 'fa-exclamation-triangle');
                }
            };
            
            const insertVariable = (variable, motifType) => {
                const textareaId = editingRescheduleType.value === 'interne' 
                    ? 'textarea-interne-' + motifType 
                    : 'textarea-client-' + motifType;
                
                const textarea = document.getElementById(textareaId);
                if (textarea) {
                    const start = textarea.selectionStart || 0;
                    const end = textarea.selectionEnd || 0;
                    const current = editingRescheduleType.value === 'interne'
                        ? rescheduleSMSMessages[motifType] || ''
                        : rescheduleSMSMessagesClient[motifType] || '';
                    
                    const newText = current.substring(0, start) + variable + current.substring(end);
                    
                    if (editingRescheduleType.value === 'interne') {
                        rescheduleSMSMessages[motifType] = newText;
                    } else {
                        rescheduleSMSMessagesClient[motifType] = newText;
                    }
                    
                    // Remettre le curseur apr√®s la variable ins√©r√©e
                    setTimeout(() => {
                        textarea.focus();
                        const newPosition = start + variable.length;
                        textarea.setSelectionRange(newPosition, newPosition);
                    }, 10);
                } else {
                    // Fallback si le textarea n'est pas trouv√©
                    if (editingRescheduleType.value === 'interne') {
                        const current = rescheduleSMSMessages[motifType] || '';
                        rescheduleSMSMessages[motifType] = current + variable;
                    } else {
                        const current = rescheduleSMSMessagesClient[motifType] || '';
                        rescheduleSMSMessagesClient[motifType] = current + variable;
                    }
                }
            };
            
            const getReschedulePreview = (motifType) => {
                const message = editingRescheduleType.value === 'interne' 
                    ? rescheduleSMSMessages[motifType] 
                    : rescheduleSMSMessagesClient[motifType];
                
                if (!message) return 'Aucun message configur√©';
                
                // Remplacer les variables par des exemples
                return message
                    .replace(/{{DATE_LONG}}/g, 'mardi 6 janvier')
                    .replace(/{{HEURE}}/g, '14:30')
                    .replace(/{{MODELE}}/g, 'Peugeot 308')
                    .replace(/{{AGENCE}}/g, 'Notre agence');
            };
            
            const updateReschedulePreview = (motifType, type) => {
                // Cette fonction est appel√©e automatiquement lors de l'input
                // Le preview est calcul√© en temps r√©el via getReschedulePreview
            };
            
            const addRescheduleMotif = () => {
                if (!newRescheduleMotif.label || !newRescheduleMotif.key) {
                    showNotification('Veuillez remplir le label et la cl√©', 'error', 'fa-exclamation-triangle');
                    return;
                }
                if (rescheduleMotifsList[newRescheduleMotif.key]) {
                    showNotification('Ce motif existe d√©j√†', 'error', 'fa-exclamation-triangle');
                    return;
                }
                rescheduleMotifsList[newRescheduleMotif.key] = newRescheduleMotif.label;
                rescheduleSMSMessages[newRescheduleMotif.key] = newRescheduleMotif.message || '';
                newRescheduleMotif.label = '';
                newRescheduleMotif.key = '';
                newRescheduleMotif.message = '';
                showNotification('‚úÖ Motif ajout√© (pensez √† enregistrer)', 'success', 'fa-check-circle');
            };
            
            const removeRescheduleMotif = (motifType) => {
                if (!confirm(`√ätes-vous s√ªr de vouloir supprimer le motif "${rescheduleMotifsList[motifType]}" ?`)) return;
                delete rescheduleMotifsList[motifType];
                delete rescheduleSMSMessages[motifType];
                showNotification('‚úÖ Motif supprim√© (pensez √† enregistrer)', 'success', 'fa-check-circle');
            };
            
            // Fonctions pour g√©rer les motifs internes
            const addRescheduleMotifInterne = () => {
                if (!newRescheduleMotifInterne.label || !newRescheduleMotifInterne.key) {
                    showNotification('Veuillez remplir le label et la cl√©', 'error', 'fa-exclamation-triangle');
                    return;
                }
                if (rescheduleMotifsListInterne[newRescheduleMotifInterne.key]) {
                    showNotification('Ce motif existe d√©j√†', 'error', 'fa-exclamation-triangle');
                    return;
                }
                rescheduleMotifsListInterne[newRescheduleMotifInterne.key] = newRescheduleMotifInterne.label;
                rescheduleSMSMessages[newRescheduleMotifInterne.key] = newRescheduleMotifInterne.message || '';
                newRescheduleMotifInterne.label = '';
                newRescheduleMotifInterne.key = '';
                newRescheduleMotifInterne.message = '';
                showNotification('‚úÖ Motif interne ajout√© (pensez √† enregistrer)', 'success', 'fa-check-circle');
            };
            
            const removeRescheduleMotifInterne = (motifType) => {
                if (!confirm(`√ätes-vous s√ªr de vouloir supprimer le motif "${rescheduleMotifsListInterne[motifType]}" ?`)) return;
                delete rescheduleMotifsListInterne[motifType];
                delete rescheduleSMSMessages[motifType];
                showNotification('‚úÖ Motif interne supprim√© (pensez √† enregistrer)', 'success', 'fa-check-circle');
            };
            
            const copyToClipboard = async (text) => {
                try {
                    await navigator.clipboard.writeText(text);
                    showNotification(`‚úÖ "${text}" copi√© !`, 'success', 'fa-check-circle');
                } catch (err) {
                    // Fallback pour les navigateurs plus anciens
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    textarea.style.position = 'fixed';
                    textarea.style.opacity = '0';
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    showNotification(`‚úÖ "${text}" copi√© !`, 'success', 'fa-check-circle');
                }
            };
            
            const saveTip = async (memberId) => {
                const amount = tips[memberId];
                if (amount === undefined || amount === null) return;
                const currentMonthKey = `${new Date().getMonth()}-${new Date().getFullYear()}`;
                
                // Get existing tips map or create new
                const memberRef = db.collection('users').doc(memberId);
                const doc = await memberRef.get();
                let existingTips = doc.data().tips || {};
                
                existingTips[currentMonthKey] = amount;
                
                await memberRef.update({ tips: existingTips });
                alert("Pourboire enregistr√© !");
            };

            const openTipModal = () => {
                tipModal.open = true;
                tipModal.operation = 'add';
                tipModal.amount = null;
                tipModal.reason = '';
                tipModal.customReason = '';
                tipModal.note = '';
                tipModal.error = '';
            };

            const saveTipTransaction = async () => {
                tipModal.error = '';
                
                // Validation
                if (!tipModal.amount || tipModal.amount <= 0) {
                    tipModal.error = "Veuillez entrer un montant valide.";
                    return;
                }
                
                if (!tipModal.reason) {
                    tipModal.error = "Veuillez s√©lectionner un motif.";
                    return;
                }
                
                if (tipModal.reason === 'Autre' && !tipModal.customReason) {
                    tipModal.error = "Veuillez pr√©ciser le motif.";
                    return;
                }
                
                const targetUser = selectedProspecteur.value || user.name;
                if (!targetUser) {
                    tipModal.error = "Utilisateur non trouv√©.";
                    return;
                }
                
                try {
                    const finalReason = tipModal.reason === 'Autre' ? tipModal.customReason : tipModal.reason;
                    const amount = tipModal.operation === 'add' ? tipModal.amount : -tipModal.amount;
                    
                    // Cr√©er la transaction
                    const transactionData = {
                        userId: targetUser,
                        type: 'pourboire',
                        amount: amount,
                        label: `Pourboire ${tipModal.operation === 'add' ? 'ajout√©' : 'retir√©'} - ${finalReason}`,
                        date: new Date(),
                        reason: finalReason,
                        note: tipModal.note || '',
                        hidden: false,
                        createdAt: new Date()
                    };
                    
                    await db.collection('transactions').add(transactionData);
                    
                    // Mettre √† jour le total des pourboires du mois dans le profil utilisateur
                    const member = teamList.value.find(m => m.name === targetUser);
                    if (member) {
                        const currentMonth = new Date().getMonth() + 1;
                        const currentYear = new Date().getFullYear();
                        const currentMonthKey = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
                        
                        const memberRef = db.collection('users').doc(member.id);
                        const doc = await memberRef.get();
                        let existingTips = doc.data().tips || {};
                        const currentTips = (existingTips[currentMonthKey] || 0) + amount;
                        existingTips[currentMonthKey] = Math.max(0, currentTips); // Ne pas aller en n√©gatif
                        
                        await memberRef.update({ tips: existingTips });
                    }
                    
                    // Recharger les transactions imm√©diatement
                    if (user.role === 'admin' && selectedProspecteur.value) {
                        await loadProspecteurData(selectedProspecteur.value);
                    } else if (user.role !== 'admin') {
                        // Forcer le rechargement des transactions
                        await loadUserTransactions();
                    }
                    
                    tipModal.open = false;
                    
                    // Attendre un peu pour que Firestore se synchronise
                    setTimeout(async () => {
                        if (user.role !== 'admin') {
                            await loadUserTransactions();
                        }
                    }, 500);
                } catch (err) {
                    console.error('Erreur sauvegarde pourboire:', err);
                    tipModal.error = "Erreur lors de la sauvegarde. Veuillez r√©essayer.";
                }
            };

            // PORTAFEUILLE FUNCTIONS
            const filterProspectors = () => {
                // La recherche est g√©r√©e par displayedProspectors computed
            };

            const selectProspecteur = async (name) => {
                selectedProspecteur.value = name;
                portefeuilleSearch.value = '';
                filteredProspectors.value = [];
                
                // Charger les donn√©es du prospecteur
                await loadProspecteurData(name);
            };

            const loadProspecteurData = async (name) => {
                // D√©truire l'ancien listener s'il existe
                if (adminTransactionListener) {
                    adminTransactionListener();
                    adminTransactionListener = null;
                }
                
                // Charger d'abord les transactions une fois pour avoir les donn√©es imm√©diatement
                try {
                    const transSnapshot = await db.collection('transactions')
                        .where('userId', '==', name)
                        .get();
                    
                    transactions.value = transSnapshot.docs.map(doc => {
                        const data = doc.data();
                        return {
                            id: doc.id,
                            ...data,
                            date: data.date && data.date.toDate ? data.date.toDate() : (data.date ? new Date(data.date) : new Date())
                        };
                    });
                    
                    // Trier par date d√©croissante
                    transactions.value.sort((a, b) => {
                        const dateA = a.date instanceof Date ? a.date.getTime() : new Date(a.date).getTime();
                        const dateB = b.date instanceof Date ? b.date.getTime() : new Date(b.date).getTime();
                        return dateB - dateA;
                    });
                } catch (err) {
                    console.error('Erreur chargement transactions:', err);
                    transactions.value = [];
                }
                
                // Cr√©er un listener en temps r√©el pour les transactions (admin)
                const query = db.collection('transactions')
                    .where('userId', '==', name);
                
                adminTransactionListener = query.onSnapshot(snap => {
                    const newTransactions = snap.docs.map(doc => {
                        const data = doc.data();
                        return {
                            id: doc.id,
                            ...data,
                            date: data.date && data.date.toDate ? data.date.toDate() : (data.date ? new Date(data.date) : new Date())
                        };
                    });
                    
                    // Trier par date d√©croissante
                    newTransactions.sort((a, b) => {
                        const dateA = a.date instanceof Date ? a.date.getTime() : new Date(a.date).getTime();
                        const dateB = b.date instanceof Date ? b.date.getTime() : new Date(b.date).getTime();
                        return dateB - dateA;
                    });
                    
                    transactions.value = newTransactions;
                }, err => {
                    console.error('Erreur listener transactions admin:', err);
                    // En cas d'erreur, recharger une fois
                    db.collection('transactions')
                        .where('userId', '==', name)
                        .get()
                        .then(transSnapshot => {
                            transactions.value = transSnapshot.docs.map(doc => {
                                const data = doc.data();
                                return {
                                    id: doc.id,
                                    ...data,
                                    date: data.date && data.date.toDate ? data.date.toDate() : (data.date ? new Date(data.date) : new Date())
                                };
                            });
                            transactions.value.sort((a, b) => {
                                const dateA = a.date instanceof Date ? a.date.getTime() : new Date(a.date).getTime();
                                const dateB = b.date instanceof Date ? b.date.getTime() : new Date(b.date).getTime();
                                return dateB - dateA;
                            });
                        });
                });

                // Charger les param√®tres du prospecteur
                const member = teamList.value.find(m => m.name === name);
                if (member) {
                    const currentMonth = new Date().getMonth() + 1;
                    const currentYear = new Date().getFullYear();
                    const currentMonthKey = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
                    
                    prospecteurEdit.tips = (member.tips && member.tips[currentMonthKey]) || 0;
                }
            };

            const saveProspecteurSettings = async () => {
                // Cette fonction n'est plus utilis√©e car on utilise maintenant le modal pourboire
                // Conserv√©e pour compatibilit√© mais ne fait plus rien
            };

            const hideTransaction = async (transId) => {
                await db.collection('transactions').doc(transId).update({ hidden: true });
                const trans = transactions.value.find(t => t.id === transId);
                if (trans) trans.hidden = true;
            };

            const showTransaction = async (transId) => {
                await db.collection('transactions').doc(transId).update({ hidden: false });
                const trans = transactions.value.find(t => t.id === transId);
                if (trans) trans.hidden = false;
            };

            const deleteTransaction = async (transId) => {
                openCustomConfirm("Supprimer la transaction", "Voulez-vous vraiment supprimer cette transaction ? Cette action est irr√©versible.", async () => {
                    await db.collection('transactions').doc(transId).delete();
                    customConfirmModal.open = false;
                });
            };

            // Obtenir les d√©tails du RDV depuis une transaction
            const getRdvFromTransaction = (trans) => {
                if (trans.rdvId) {
                    return rdvList.value.find(r => r.id === trans.rdvId);
                }
                return null;
            };

            const getTransactionIcon = (type) => {
                const icons = {
                    'salaire': 'fa-solid fa-money-bill-wave',
                    'prime': 'fa-solid fa-trophy',
                    'pourboire': 'fa-solid fa-hand-holding-dollar',
                    'virement': 'fa-solid fa-exchange-alt',
                    'ca': 'fa-solid fa-euro-sign',
                    'rdv_honore': 'fa-solid fa-check-circle',
                    'bonus': 'fa-solid fa-star'
                };
                return icons[type] || 'fa-solid fa-circle';
            };

            // Cr√©er une transaction automatiquement quand un RDV est honor√© (10‚Ç¨ par RDV)
            const createTransactionForRdv = async (rdv) => {
                if (!rdv || !rdv.createdBy) return;
                
                // Ne pas cr√©er de transaction si c'est un admin qui a cr√©√© le RDV
                const userObj = teamList.value.find(u => u.name === rdv.createdBy);
                const isRoleAdmin = userObj && userObj.role === 'admin';
                const isNameInAdminList = adminNamesList.value.includes(rdv.createdBy);
                
                if (isNameInAdminList || isRoleAdmin) {
                    // C'est un admin, on ne cr√©e pas de transaction (l'admin garde tout le CA)
                    return;
                }
                
                try {
                    const basePrice = parseFloat(globalCommission.base) || 10;
                    
                    // V√©rifier si une transaction existe d√©j√† pour ce RDV (v√©rification renforc√©e)
                    const existingTrans = await db.collection('transactions')
                        .where('rdvId', '==', rdv.id)
                        .where('type', '==', 'rdv_honore')
                        .get();
                    
                    if (!existingTrans.empty) {
                        // Transaction d√©j√† cr√©√©e, ne pas en cr√©er une nouvelle
                        console.log('Transaction d√©j√† existante pour RDV:', rdv.id);
                        return;
                    }
                    
                    // Double v√©rification : v√©rifier aussi dans les transactions locales
                    const localExisting = transactions.value.find(t => t.rdvId === rdv.id && t.type === 'rdv_honore');
                    if (localExisting) {
                        console.log('Transaction d√©j√† existante localement pour RDV:', rdv.id);
                        return;
                    }
                    
                    const transactionData = {
                        userId: rdv.createdBy,
                        type: 'rdv_honore',
                        amount: basePrice,
                        label: `RDV honor√© - ${rdv.civilite} ${rdv.nom}${rdv.tag === 'OK M' ? ' (OK M)' : ''}`,
                        date: rdv.date ? new Date(rdv.date) : new Date(),
                        rdvId: rdv.id,
                        agenceId: rdv.agenceId || null,
                        hidden: false,
                        createdAt: new Date()
                    };
                    
                    await db.collection('transactions').add(transactionData);
                    console.log('Transaction cr√©√©e pour RDV:', rdv.id, 'Montant:', basePrice, '‚Ç¨ (m√™me avec ou sans mandat)');
                    
                    // V√©rifier et cr√©er les transactions de bonus si n√©cessaire
                    await checkAndCreateBonusTransactions(rdv.createdBy);
                } catch (err) {
                    console.error('Erreur cr√©ation transaction RDV:', err);
                }
            };

            // Supprimer les transactions associ√©es √† un RDV quand le statut "honor√©" est retir√©
            const deleteTransactionsForRdv = async (rdvId) => {
                try {
                    // R√©cup√©rer toutes les transactions associ√©es √† ce RDV
                    const transactions = await db.collection('transactions')
                        .where('rdvId', '==', rdvId)
                        .get();
                    
                    // Supprimer toutes les transactions trouv√©es
                    const batch = db.batch();
                    transactions.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    
                    if (transactions.docs.length > 0) {
                        await batch.commit();
                        
                        // V√©rifier et recalculer les bonus apr√®s suppression
                        const rdv = rdvList.value.find(r => r.id === rdvId);
                        if (rdv && rdv.createdBy) {
                            await checkAndCreateBonusTransactions(rdv.createdBy);
                        }
                    }
                } catch (err) {
                    console.error('Erreur suppression transactions RDV:', err);
                }
            };

            // V√©rifier et cr√©er les transactions de bonus quand les paliers sont atteints
            const checkAndCreateBonusTransactions = async (userId) => {
                try {
                    const basePrice = parseFloat(globalCommission.base) || 10;
                    const bonusThreshold = parseInt(globalCommission.threshold) || 21;
                    const bonusStep = parseInt(globalCommission.step) || 10;
                    const bonusAmount = parseFloat(globalCommission.amount) || 100;

                    const now = new Date();
                    const currentMonth = now.getMonth();
                    const currentYear = now.getFullYear();

                   // R√©cup√©rer tous les RDV honor√©s du mois en cours (AVEC OU SANS AGENCE)
const honoredRdvs = rdvList.value.filter(r => {
    // MODIFICATION : On a retir√© "!r.agenceId" pour inclure tout le monde
    if(r.statut !== 'honore' || !r.date) return false;
    const d = new Date(r.date);
    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
});

                    const count = honoredRdvs.length;

                    if (count < bonusThreshold) return; // Pas encore de bonus

                    // Calculer le nombre de paliers atteints
                    const tiersReached = Math.floor((count - bonusThreshold) / bonusStep) + 1;

                    // R√©cup√©rer les transactions de bonus existantes pour ce mois
                    const existingBonus = await db.collection('transactions')
                        .where('userId', '==', userId)
                        .where('type', '==', 'bonus')
                        .get();

                    const existingTiers = new Set();
                    existingBonus.docs.forEach(doc => {
                        const data = doc.data();
                        if (data.bonusTier) {
                            existingTiers.add(data.bonusTier);
                        }
                    });

                    // Cr√©er les transactions de bonus manquantes
                    for (let tier = 1; tier <= tiersReached; tier++) {
                        if (existingTiers.has(tier)) continue; // Bonus d√©j√† cr√©√© pour ce palier

                        const transactionData = {
                            userId: userId,
                            type: 'bonus',
                            amount: bonusAmount,
                            label: `Bonus Palier ${tier} - ${count} RDV honor√©s`,
                            date: new Date(),
                            bonusTier: tier,
                            bonusCount: bonusThreshold + (tier - 1) * bonusStep,
                            hidden: false,
                            createdAt: new Date()
                        };

                        await db.collection('transactions').add(transactionData);
                    }
                } catch (err) {
                    console.error('Erreur cr√©ation transactions bonus:', err);
                }
            };

            const currentFullDateLabel = computed(() => new Date().toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }));
            const conversionRate = computed(() => {
                // Utiliser les filtres du dashboard ou le mois/ann√©e actuel par d√©faut
                const selectedMonth = dashboardFilters.mois ? parseInt(dashboardFilters.mois) - 1 : new Date().getMonth();
                const selectedYear = dashboardFilters.annee ? parseInt(dashboardFilters.annee) : new Date().getFullYear();
                const currentMonth = selectedMonth;
                const currentYear = selectedYear;
                
                let filteredRdvs = rdvList.value;
                
                // Filtrer par commercial si s√©lectionn√©
                if (dashboardFilters.commercialId && dashboardFilters.agencyId) {
                    // R√©cup√©rer les RDV du bilan qui ont ce commercial
                    const bilanRdvsWithCommercial = bilanRows.value.filter(b => {
                        const sameAgency = b.clientId === dashboardFilters.agencyId || 
                                          (agences.value.find(a => a.id === dashboardFilters.agencyId)?.nom === b.agence);
                        return sameAgency && b.commercial === dashboardFilters.commercialId;
                    });
                    
                    // Extraire tous les rdvIds
                    const rdvIds = new Set();
                    bilanRdvsWithCommercial.forEach(b => {
                        if (b.rdvId) rdvIds.add(b.rdvId);
                        if (b.rdvIds && Array.isArray(b.rdvIds)) {
                            b.rdvIds.forEach(id => rdvIds.add(id));
                        }
                    });
                    
                    // Filtrer rdvList avec ces IDs
                    if (rdvIds.size > 0) {
                        filteredRdvs = filteredRdvs.filter(r => rdvIds.has(r.id));
                    } else {
                        // Si aucun RDV trouv√© dans le bilan pour ce commercial, retourner 100% si c'est le d√©but du mois
                        const today = new Date();
                        if (today.getDate() === 1 && today.getMonth() === currentMonth && today.getFullYear() === currentYear) {
                            return 100;
                        }
                        return 0;
                    }
                }
                
                // Appliquer les autres filtres
                if (dashboardFilters.agencyId) {
                    filteredRdvs = filteredRdvs.filter(r => r.agenceId === dashboardFilters.agencyId);
                }
                if (dashboardFilters.userId) {
                    filteredRdvs = filteredRdvs.filter(r => r.createdBy === dashboardFilters.userId);
                }
                
                // Filtrer par mois/ann√©e s√©lectionn√©
                const honored = filteredRdvs.filter(r => {
                    if (r.statut !== 'honore' || !r.date) return false;
                    const d = new Date(r.date);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                }).length;
                
                const noshow = filteredRdvs.filter(r => {
                    if (r.statut !== 'pas_venu' || !r.date) return false;
                    const d = new Date(r.date);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                }).length;
                
                const totalFinished = honored + noshow;
                // Si aucun rendez-vous termin√© ce mois : 100% au d√©but du mois, sinon 0
                if (totalFinished === 0) {
                    const today = new Date();
                    // Si c'est le premier du mois et qu'on est dans le mois s√©lectionn√©, retourner 100%
                    if (today.getDate() === 1 && today.getMonth() === currentMonth && today.getFullYear() === currentYear) {
                        return 100;
                    }
                    return 0;
                }
                return Math.round((honored / totalFinished) * 100);
            });
            const conversionRateColor = computed(() => { const rate = conversionRate.value; if (rate < 50) return 'bg-red-50 border-red-200 text-red-700'; if (rate < 80) return 'bg-orange-50 border-orange-200 text-orange-700'; return 'bg-green-50 border-green-200 text-green-700'; });
            // V√©rification de l'√©tat de connexion Google Calendar
            const isGoogleCalendarConnected = computed(() => {
                // Pour l'admin, utiliser le token admin
                if (user.role === 'admin') {
                    return googleCalendarConnected.value && googleAccessToken.value && googleAccessToken.value.trim() !== '';
                }
                // Pour les prospecteurs : si l'admin est connect√©, ils sont automatiquement connect√©s
                // OU si le prospecteur a son propre token valide
                return (googleCalendarConnected.value && googleAccessToken.value && googleAccessToken.value.trim() !== '') ||
                       (prospecteurGoogleCalendarConnected.value && prospecteurGoogleCalendarToken.value && prospecteurGoogleCalendarToken.value.trim() !== '' && !prospecteurGoogleCalendarTokenExpired.value);
            });
            
            // Fonction pour obtenir le token actif (admin ou prospecteur)
            const getActiveGoogleToken = () => {
                // Admin utilise son propre token
                if (user.role === 'admin' && googleCalendarConnected.value && googleAccessToken.value) {
                    return googleAccessToken.value;
                }
                // Prospecteurs : d'abord v√©rifier si l'admin est connect√© (connexion automatique)
                if (user.role !== 'admin' && googleCalendarConnected.value && googleAccessToken.value && googleAccessToken.value.trim() !== '') {
                    return googleAccessToken.value; // Utiliser le token admin automatiquement
                }
                // Sinon, utiliser leur propre token s'ils en ont un
                if (user.role !== 'admin' && prospecteurGoogleCalendarConnected.value && prospecteurGoogleCalendarToken.value && !prospecteurGoogleCalendarTokenExpired.value) {
                    return prospecteurGoogleCalendarToken.value;
                }
                return null;
            };
            
            // Variable computed pour le token actif
            const activeGoogleToken = computed(() => getActiveGoogleToken());
            
            // √âtat r√©el de la validit√© du token (mis √† jour dynamiquement)
            const googleCalendarTokenValid = ref(false);
            const checkingToken = ref(false);
            const tokenExpirationTime = ref(null); // Timestamp d'expiration du token
            const lastTokenValue = ref(null); // Pour d√©tecter si le token a chang√©
            
            // √âtat r√©el de la validit√© du token prospecteur
            const prospecteurGoogleCalendarTokenValid = ref(false);
            const checkingProspecteurToken = ref(false);
            const lastProspecteurTokenValue = ref(null); // Pour d√©tecter si le token a chang√©
            
            // Fonction pour v√©rifier et mettre √† jour l'√©tat r√©el du token (ADMIN)
            const checkAndUpdateTokenStatus = async (manual = false) => {
                // 1. SI C'EST UN CLIC MANUEL : On force l'affichage √† 55min TOUT DE SUITE
                if (manual) {
                    tokenExpirationTime.value = Date.now() + (55 * 60 * 1000);
                    tokenTimerTick.value = Date.now(); // Force le rafra√Æchissement du calcul
                    showNotification('‚úÖ Token actualis√© et compteur r√©initialis√© !', 'success', 'fa-rotate-right');
                }

                if (checkingToken.value) return; 
                checkingToken.value = true;
                
                if (!googleCalendarConnected.value || !googleAccessToken.value) {
                    googleCalendarTokenValid.value = false;
                    tokenExpirationTime.value = null;
                    lastTokenValue.value = null;
                    checkingToken.value = false;
                    return;
                }
                
                try {
                    const isValid = await checkGoogleCalendarTokenValid();
                    const currentToken = googleAccessToken.value;
                    const tokenChanged = currentToken !== lastTokenValue.value;
                    
                    googleCalendarTokenValid.value = isValid;
                    
                    if (isValid) {
                        // Si le token a chang√© ou si on n'a pas de timer, on initialise
                        if (tokenChanged || !tokenExpirationTime.value) {
                            tokenExpirationTime.value = Date.now() + (55 * 60 * 1000);
                            lastTokenValue.value = currentToken;
                        }
                    } else {
                        tokenExpirationTime.value = null;
                        lastTokenValue.value = null;
                    }
                } catch (err) {
                    console.error('Erreur v√©rification token:', err);
                    googleCalendarTokenValid.value = false;
                    tokenExpirationTime.value = null;
                } finally {
                    checkingToken.value = false;
                }
            };
          // Fonction pour forcer un rafra√Æchissement GLOBAL (Admin only)
            const forceGlobalRefresh = () => {
                if (user.role === 'admin' && googleCalendarConnected.value && googleTokenClient) {
                    showNotification('üîÑ Actualisation manuelle du jeton...', 'info', 'fa-rotate');
                    
                    // On enl√®ve le prompt: 'none' pour le mode manuel.
                    // Comme √ßa, si la session est expir√©e, la fen√™tre s'ouvre pour te laisser te reconnecter proprement.
                    // Si la session est bonne, la fen√™tre s'ouvrira et se fermera toute seule instantan√©ment.
                    googleTokenClient.requestAccessToken({ prompt: '' }); 
                } else {
                    showNotification('Erreur : Admin non connect√© √† Google', 'error');
                }
            };
            // Fonction pour v√©rifier et mettre √† jour l'√©tat r√©el du token prospecteur
            const checkAndUpdateProspecteurTokenStatus = async () => {
                if (checkingProspecteurToken.value) return;
                checkingProspecteurToken.value = true;
                
                if (!prospecteurGoogleCalendarConnected.value || !prospecteurGoogleCalendarToken.value) {
                    prospecteurGoogleCalendarTokenValid.value = false;
                    checkingProspecteurToken.value = false;
                    return;
                }
                
                try {
                    // Tester le token en faisant une requ√™te simple √† l'API Google Calendar
                    const response = await fetch('https://www.googleapis.com/calendar/v3/users/me/calendarList?maxResults=1', {
                        headers: {
                            'Authorization': `Bearer ${prospecteurGoogleCalendarToken.value}`
                        }
                    });
                    
                    // Si 401 ou 403, le token est invalide ou expir√©
                    if (response.status === 401 || response.status === 403) {
                        prospecteurGoogleCalendarTokenValid.value = false;
                        prospecteurGoogleCalendarTokenExpired.value = true;
                        prospecteurTokenExpirationTime.value = null;
                    } else {
                        prospecteurGoogleCalendarTokenValid.value = response.ok;
                        if (response.ok) {
                            prospecteurGoogleCalendarTokenExpired.value = false;
                            const currentProspecteurToken = prospecteurGoogleCalendarToken.value;
                            const prospecteurTokenChanged = currentProspecteurToken !== lastProspecteurTokenValue.value;
                            
                            // Ne r√©initialiser le timer que si le token a chang√© ou si on n'a pas encore de timestamp
                            if (prospecteurTokenChanged || !prospecteurTokenExpirationTime.value) {
                                prospecteurTokenExpirationTime.value = Date.now() + (55 * 60 * 1000);
                                lastProspecteurTokenValue.value = currentProspecteurToken;
                            }
                        }
                    }
                } catch (err) {
                    console.error('Erreur v√©rification token prospecteur:', err);
                    prospecteurGoogleCalendarTokenValid.value = false;
                    prospecteurGoogleCalendarTokenExpired.value = true;
                    prospecteurTokenExpirationTime.value = null;
                } finally {
                    checkingProspecteurToken.value = false;
                }
            };
            
            // Variable r√©active pour forcer la mise √† jour du compteur en temps r√©el
            const tokenTimerTick = ref(Date.now());
            // 1. AJOUTER CETTE FONCTION DANS LE SETUP
const reportStatus = async (force = false) => {
    if (!user.logged || user.role === 'admin') return;

    // On envoie l'√©tat toutes les 10 secondes (pour ne pas surcharger) ou si le statut change
    const now = Date.now();
    if (!force && window.lastReportTime && (now - window.lastReportTime < 10000)) return;
    window.lastReportTime = now;

    try {
        await db.collection('users').doc(user.id).update({
            googleStatus: prospecteurGoogleCalendarConnected.value ? 'connected' : 'disconnected',
            googleTokenExpires: prospecteurTokenExpirationTime.value || null,
            lastSeen: new Date().toISOString()
        });
    } catch (e) { console.log("Erreur rapport statut", e); }
};

// Watcher pour mettre √† jour le statut imm√©diatement quand la connexion change
watch(prospecteurGoogleCalendarConnected, (newVal) => {
    if (user.logged && user.role !== 'admin') {
        reportStatus(true); // Force la mise √† jour imm√©diate
    }
});

// 2. CHERCHE TON INTERVALLE EXISTANT (celui du timer) ET AJOUTE L'APPEL
setInterval(() => {
    // ... ton code existant pour le timer ...
    if (prospecteurTokenExpirationTime.value && prospecteurGoogleCalendarTokenValid.value) {
        prospecteurTokenTimerTick.value = Date.now();
    }
    
    // üëá AJOUTE CETTE LIGNE ICI üëá
    reportStatus(); 
    
}, 1000);
            
            // Mettre √† jour le temps toutes les secondes pour que le compteur diminue en temps r√©el
            setInterval(() => {
                if (tokenExpirationTime.value && googleCalendarTokenValid.value) {
                    // Forcer la mise √† jour en cr√©ant une nouvelle valeur
                    tokenTimerTick.value = Date.now();
                }
                // Mettre √† jour aussi pour les prospecteurs
                if (prospecteurTokenExpirationTime.value && prospecteurGoogleCalendarTokenValid.value) {
                    // Forcer la mise √† jour en cr√©ant une nouvelle valeur
                    prospecteurTokenTimerTick.value = Date.now();
                }
            }, 1000);
            
            // Mettre √† jour aussi toutes les 100ms pour un affichage plus fluide des secondes
            setInterval(() => {
                if (tokenExpirationTime.value && googleCalendarTokenValid.value) {
                    tokenTimerTick.value = Date.now();
                }
                if (prospecteurTokenExpirationTime.value && prospecteurGoogleCalendarTokenValid.value) {
                    prospecteurTokenTimerTick.value = Date.now();
                }
            }, 100);
            
            // Calcul du temps restant avant expiration (mis √† jour en temps r√©el)
            const tokenTimeRemaining = computed(() => {
                if (!tokenExpirationTime.value || !googleCalendarTokenValid.value) {
                    return null;
                }
                const remaining = tokenExpirationTime.value - tokenTimerTick.value;
                if (remaining <= 0) {
                    // Si le temps est √©coul√©, v√©rifier √† nouveau le token
                    setTimeout(() => {
                        checkAndUpdateTokenStatus();
                    }, 1000);
                    return null;
                }
                
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);
                return { minutes, seconds };
            });
            
            // Charger les messages de report quand on ouvre l'onglet Motifs
            watch(() => settingsModal.tab, (newTab) => {
                if (newTab === 'Motifs' && user.role === 'admin') {
                    loadRescheduleSMSMessages();
                }
            });
            
            // V√©rifier le token quand on ouvre les param√®tres Google Calendar
            watch(() => settingsModal.tab, (newTab) => {
                if (newTab === 'GoogleCalendar' && user.role === 'admin') {
                    checkAndUpdateTokenStatus();
                }
                if (newTab === 'Logs' && user.role === 'admin') {
                    loadDetailedLogs();
                }
                if (newTab === 'Dashboard' && user.role === 'admin') {
                    calculatePerformanceStats();
                    calculateWorkloadPrediction();
                }
                if (newTab === 'Fermetures' && user.role === 'admin') {
                    loadFermetures();
                }
            });
            
            const conversionEmoji = computed(() => { const rate = conversionRate.value; if (rate < 50) return 'üò≠'; if (rate < 80) return 'ü§®'; return 'ü§©'; });

           const login = () => { 
                // Code secret Admin (inchang√©)
                if(loginEmail.value === 'contact@cetn-solutions.fr' && loginPass.value === '130724') {
                    loginAdminSelection.value = true;
                    return;
                }

                // V√©rifier si teamList est charg√©
                if (!teamList.value || teamList.value.length === 0) {
                    loginErrorModal.message = 'Chargement en cours, veuillez r√©essayer dans quelques instants.';
                    loginErrorModal.show = true;
                    return;
                }

                const match = teamList.value.find(u => u.email === loginEmail.value && u.password === loginPass.value);
                
                if(match) {
                    if(match.blocked) { 
                        blockedLoginMessage.show = true;
                        return; 
                    }
                    
                    // 1. On connecte l'utilisateur
                    setUserSession('prospecteur', match.name, match.email, match.id);
                    
                    // 2. On affiche le message de bienvenue
                    checkAndShowWelcome(match.email, match.name);

                    // --- AJOUT MAGIQUE ICI ---
                    // 3. On force la v√©rification Google TOUT DE SUITE
                    setTimeout(() => {
                        // Si c'est un prospecteur, on v√©rifie son token ou le token partag√©
                        checkAndUpdateProspecteurTokenStatus();
                        // On force aussi la mise √† jour visuelle du timer
                        if (prospecteurTokenExpirationTime.value) {
                             prospecteurTokenTimerTick.value = Date.now();
                        }
                    }, 500); // Petit d√©lai de 500ms pour √™tre s√ªr que la vue est charg√©e
                    
                    // 4. D√©marrer le listener pour v√©rifier le statut en temps r√©el
                    if (user.id) {
                        if (userStatusListener) userStatusListener(); // Nettoyer l'ancien listener si existe
                        let previousBlockedState = match.blocked; // Stocker l'√©tat initial
                        userStatusListener = db.collection('users').doc(user.id).onSnapshot(doc => {
                            if (!doc.exists) {
                                // Le profil a √©t√© supprim√©
                                forcedLogoutModal.type = 'deleted';
                                forcedLogoutModal.open = true;
                                return;
                            }
                            const data = doc.data();
                            if (data) {
                                const isBlocked = data.blocked === true;
                                // Ne d√©connecter que si on passe de non-bloqu√© √† bloqu√©
                                if (isBlocked && !previousBlockedState) {
                                    forcedLogoutModal.type = 'blocked';
                                    forcedLogoutModal.open = true;
                                }
                                previousBlockedState = isBlocked; // Mettre √† jour l'√©tat pr√©c√©dent
                            }
                        });
                    }
                } else {
                    loginErrorModal.message = 'Mot de passe ou identifiant incorrect. R√©essayez.';
                    loginErrorModal.show = true;
                }
            };
            const finalizeAdminLogin = (name) => {
                setUserSession('admin', name);
                checkAndShowWelcome(loginEmail.value, name);
                loginAdminSelection.value = false;
                // --- AJOUT MAGIQUE POUR ADMIN ---
                setTimeout(() => {
                    checkAndUpdateTokenStatus();
                     // On force aussi la mise √† jour visuelle du timer
                    if (tokenExpirationTime.value) {
                         tokenTimerTick.value = Date.now();
                    }
                }, 500);
            };
          
            

            const setUserSession = (role, name, email = '', id = '') => {
                user.logged = true; user.role = role; user.name = name; user.email = email; user.id = id;
                localStorage.setItem('crm_user', JSON.stringify({ role, name, email, id }));
                
                // Log de connexion
                logAction('connexion', {
                    utilisateur: name,
                    role: role,
                    email: loginEmail.value,
                    heure: new Date().toLocaleTimeString('fr-FR'),
                    date: new Date().toISOString().split('T')[0]
                });
                
                loadRdvData();
                
                // Initialiser Google Calendar pour les prospecteurs apr√®s connexion
                if (role !== 'admin' && typeof google !== 'undefined' && google.accounts) {
                    setTimeout(() => {
                        initProspecteurGoogleCalendar();
                        // Restaurer la session Google Calendar si elle existe
                        const savedProspecteurToken = localStorage.getItem('prospecteur_google_calendar_token');
                        const savedProspecteurEmail = localStorage.getItem('prospecteur_google_calendar_email');
                        
                        if (savedProspecteurToken && savedProspecteurEmail) {
                            // Tester si le token est encore valide
                            fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                                headers: { 'Authorization': `Bearer ${savedProspecteurToken}` }
                            })
                            .then(async (res) => {
                                if (res.ok) {
                                    // Le token est bon, on r√©tablit la connexion
                                    prospecteurGoogleCalendarToken.value = savedProspecteurToken;
                                    prospecteurGoogleCalendarConnected.value = true;
                                    prospecteurGoogleCalendarTokenValid.value = true;
                                    prospecteurGoogleCalendarTokenExpired.value = false;
                                    console.log("‚úÖ Session Google Agenda prospecteur restaur√©e");
                                    // V√©rifier le token pour confirmer
                                    checkAndUpdateProspecteurTokenStatus();
                                } else {
                                    // Le token est expir√©, on nettoie
                                    console.warn("‚ö†Ô∏è Token Google prospecteur expir√©");
                                    localStorage.removeItem('prospecteur_google_calendar_token');
                                    localStorage.removeItem('prospecteur_google_calendar_email');
                                    localStorage.removeItem('prospecteur_google_calendar_token_date');
                                    prospecteurGoogleCalendarConnected.value = false;
                                    prospecteurGoogleCalendarTokenValid.value = false;
                                }
                            })
                            .catch(() => {
                                prospecteurGoogleCalendarConnected.value = false;
                                prospecteurGoogleCalendarTokenValid.value = false;
                            });
                        }
                    }, 500);
                }
            };

            const logout = () => { 
                // Log de d√©connexion
                if(user.logged && user.name) {
                    logAction('deconnexion', {
                        utilisateur: user.name,
                        role: user.role,
                        heure: new Date().toLocaleTimeString('fr-FR'),
                        date: new Date().toISOString().split('T')[0]
                    });
                }
                
                // Arr√™ter le listener de statut
                if (userStatusListener) {
                    userStatusListener();
                    userStatusListener = null;
                }
                
                user.logged=false; user.email=''; user.id=''; loginPass.value=''; loginEmail.value=''; rdvList.value = [];
                checksDone.value = false; 
                localStorage.removeItem('crm_user'); 
                if(rdvListener) rdvListener();
                if(transactionListener) {
                    transactionListener();
                    transactionListener = null;
                }
                if(adminTransactionListener) {
                    adminTransactionListener();
                    adminTransactionListener = null;
                }
            };

            const addTeamMember = async () => { if(!newMember.name || !newMember.email || !newMember.password) return; await db.collection('users').add({ ...newMember, role: 'prospecteur', blocked: false, created: new Date() }); newMember.name = ''; newMember.email = ''; newMember.password = ''; newMember.assignedAgencies = []; };
            const toggleBlockTeamMember = async (member) => { 
                const wasBlocked = member.blocked;
                const willBeBlocked = !member.blocked;
                await db.collection('users').doc(member.id).update({ blocked: willBeBlocked });
                // Si on BLOQUE l'utilisateur (pas d√©bloque) ET qu'il est actuellement connect√©, le d√©connecter
                if (willBeBlocked && !wasBlocked && user.logged && user.email === member.email) {
                    forcedLogoutModal.type = 'blocked';
                    forcedLogoutModal.open = true;
                }
            };
            const deleteTeamMember = async (member) => { 
                openCustomConfirm("Supprimer un membre", "Voulez-vous vraiment supprimer l'acc√®s de " + member.name + " ?", async () => {
                    customConfirmModal.open = false;
                    // Si l'utilisateur est actuellement connect√©, le d√©connecter AVANT de supprimer
                    if (user.logged && user.email === member.email) {
                        // Ouvrir la modal de d√©connexion
                        forcedLogoutModal.type = 'deleted';
                        forcedLogoutModal.open = true;
                        // Supprimer le document apr√®s un court d√©lai pour que la modal s'affiche
                        setTimeout(async () => {
                            await db.collection('users').doc(member.id).delete();
                        }, 200);
                    } else {
                        // Si l'utilisateur n'est pas connect√©, supprimer directement
                        await db.collection('users').doc(member.id).delete();
                    }
                });
            };
            
            const openTeamEdit = (member) => {
                teamEditModal.member = member;
                teamEditModal.name = member.name;
                teamEditModal.email = member.email;
                teamEditModal.password = ''; 
                teamEditModal.assignedAgencies = member.assignedAgencies || [];
                teamEditModal.open = true;
            };

            const saveTeamMemberEdit = async () => {
                if (!teamEditModal.member) return;
                const updateData = { 
                    name: teamEditModal.name, 
                    email: teamEditModal.email, 
                    assignedAgencies: teamEditModal.assignedAgencies
                };
                if(teamEditModal.password && teamEditModal.password.trim() !== '') { updateData.password = teamEditModal.password; }
                await db.collection('users').doc(teamEditModal.member.id).update(updateData);
                teamEditModal.open = false;
            };

            const openPasswordEdit = (member) => {
                passwordEditModal.member = member;
                passwordEditModal.password = '';
                passwordEditModal.open = true;
            };

            const savePasswordEdit = async () => {
                if (!passwordEditModal.member || !passwordEditModal.password || passwordEditModal.password.trim() === '') {
                    return;
                }
                await db.collection('users').doc(passwordEditModal.member.id).update({ password: passwordEditModal.password });
                passwordEditModal.open = false;
                passwordEditModal.password = '';
                showNotification('Mot de passe modifi√© avec succ√®s', 'success');
            };

            const addAdminName = async () => { if(!newAdminName.value) return; const updated = [...adminNamesList.value, newAdminName.value]; await db.collection('settings').doc('global').set({adminNames: updated}, {merge:true}); newAdminName.value = ''; };
            const removeAdminName = async (name) => { const updated = adminNamesList.value.filter(n => n !== name); await db.collection('settings').doc('global').set({adminNames: updated}, {merge:true}); };

            const addNote = async () => {
                if(!newNoteText.value.trim() || !clientModal.rdv) return;
                const noteObj = { text: newNoteText.value, author: user.name, date: new Date().toISOString() };
                if(!clientModal.rdv.notes) clientModal.rdv.notes = [];
                clientModal.rdv.notes.push(noteObj);
                await db.collection('rendezvous').doc(clientModal.rdv.id).update({ notes: clientModal.rdv.notes });
                newNoteText.value = '';
            };
            const deleteNote = async (rdv, index) => {
                openCustomConfirm("Supprimer la note", "Voulez-vous supprimer cette note ?", async () => {
                    rdv.notes.splice(index, 1);
                    await db.collection('rendezvous').doc(rdv.id).update({ notes: rdv.notes });
                    customConfirmModal.open = false;
                });
            };
            
            const editMainNote = async (rdv) => {
                editNoteModal.rdv = rdv;
                editNoteModal.note = rdv.note || '';
                editNoteModal.open = true;
            };
            
            const saveNoteEdit = async () => {
                if (!editNoteModal.rdv) return;
                const newNote = editNoteModal.note.trim();
                if (newNote !== (editNoteModal.rdv.note || '')) {
                    await db.collection('rendezvous').doc(editNoteModal.rdv.id).update({ note: newNote });
                    editNoteModal.rdv.note = newNote;
                    showNotification('Note modifi√©e avec succ√®s', 'success');
                }
                editNoteModal.open = false;
                editNoteModal.rdv = null;
                editNoteModal.note = '';
            };
            
            const deleteMainNote = async (rdv) => {
                openCustomConfirm("Supprimer la note", "Voulez-vous supprimer cette note ?", async () => {
                    await db.collection('rendezvous').doc(rdv.id).update({ note: '' });
                    rdv.note = '';
                    customConfirmModal.open = false;
                    showNotification('Note supprim√©e avec succ√®s', 'success');
                });
            };

            const formatName = (name) => {
                if (!name) return '';
                // Nettoyer les espaces multiples et mettre une majuscule apr√®s chaque espace
                return name.trim().split(/\s+/).map(word => {
                    if (word.length === 0) return word;
                    return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
                }).join(' ');
            };
            const formatNameRealTime = (e) => {
                const input = e.target;
                const cursorPos = input.selectionStart;
                let value = input.value;
                
                // Formater : premi√®re lettre en majuscule, et apr√®s chaque espace
                let formatted = value;
                
                // Premi√®re lettre en majuscule
                if (formatted.length > 0 && /^[a-z]/.test(formatted)) {
                    formatted = formatted.charAt(0).toUpperCase() + formatted.slice(1);
                }
                
                // Mettre en majuscule la lettre apr√®s chaque espace
                formatted = formatted.replace(/(\s+)([a-z])/g, (match, spaces, letter) => {
                    return spaces + letter.toUpperCase();
                });
                
                // Si la valeur a chang√©, mettre √† jour
                if (formatted !== value) {
                    const oldLength = value.length;
                    const newLength = formatted.length;
                    const lengthDiff = newLength - oldLength;
                    
                    // Calculer la nouvelle position du curseur
                    let newCursorPos = cursorPos;
                    if (lengthDiff !== 0) {
                        // Si on est juste apr√®s un espace et qu'on a transform√© la lettre suivante
                        if (cursorPos > 0 && cursorPos <= oldLength && value[cursorPos - 1] === ' ') {
                            newCursorPos = cursorPos;
                        } else if (cursorPos === oldLength) {
                            newCursorPos = newLength;
                        }
                    }
                    
                    input.value = formatted;
                    // Utiliser nextTick pour s'assurer que Vue a mis √† jour le DOM
                    setTimeout(() => {
                        input.setSelectionRange(newCursorPos, newCursorPos);
                    }, 0);
                    form.nom = formatted;
                } else {
                    form.nom = value;
                }
            };
            const formatNameRealTimeEdit = (e) => {
                const input = e.target;
                const cursorPos = input.selectionStart;
                let value = input.value;
                
                // Formater : premi√®re lettre en majuscule, et apr√®s chaque espace
                let formatted = value;
                
                // Premi√®re lettre en majuscule
                if (formatted.length > 0 && /^[a-z]/.test(formatted)) {
                    formatted = formatted.charAt(0).toUpperCase() + formatted.slice(1);
                }
                
                // Mettre en majuscule la lettre apr√®s chaque espace
                formatted = formatted.replace(/(\s+)([a-z])/g, (match, spaces, letter) => {
                    return spaces + letter.toUpperCase();
                });
                
                // Si la valeur a chang√©, mettre √† jour
                if (formatted !== value) {
                    const oldLength = value.length;
                    const newLength = formatted.length;
                    const lengthDiff = newLength - oldLength;
                    
                    // Calculer la nouvelle position du curseur
                    let newCursorPos = cursorPos;
                    if (lengthDiff !== 0) {
                        // Si on est juste apr√®s un espace et qu'on a transform√© la lettre suivante
                        if (cursorPos > 0 && cursorPos <= oldLength && value[cursorPos - 1] === ' ') {
                            newCursorPos = cursorPos;
                        } else if (cursorPos === oldLength) {
                            newCursorPos = newLength;
                        }
                    }
                    
                    input.value = formatted;
                    // Utiliser nextTick pour s'assurer que Vue a mis √† jour le DOM
                    setTimeout(() => {
                        input.setSelectionRange(newCursorPos, newCursorPos);
                    }, 0);
                    editModal.form.nom = formatted;
                } else {
                    editModal.form.nom = value;
                }
            };
            const onWizardNameBlur = (e) => {
                form.nom = formatName(e.target.value);
            };
            const onWizardNamePaste = (e) => {
                // Attendre que le collage soit termin√© avant de formater
                setTimeout(() => {
                    form.nom = formatName(form.nom);
                }, 10);
            };
            const onEditModalNameBlur = (e) => {
                editModal.form.nom = formatName(e.target.value);
            };
            const onEditModalNamePaste = (e) => {
                // Attendre que le collage soit termin√© avant de formater
                setTimeout(() => {
                    editModal.form.nom = formatName(editModal.form.nom);
                }, 10);
            };
            const onWizardPhoneInput = (e) => { const digits = normalizePhone(e.target.value).slice(0, 10); form.telephone = formatPhone(digits); if (digits.length === 10) { const exist = rdvList.value.find(r => normalizePhone(r.telephone) === digits); if (exist) { form.nom = exist.nom; form.civilite = exist.civilite; form.modele = exist.modele; clientExists.value = true; } else { clientExists.value = false; } } else { clientExists.value = false; } };
            const onModalPhoneInput = (e) => { const digits = normalizePhone(e.target.value).slice(0, 10); if (!clientModal.rdv) return; clientModal.rdv.telephone = formatPhone(digits); };
            
            // Variable pour le chargement du lien annonce
            const loadingLienAnnonce = ref(false);
            const intelligentPaste = ref('');
            
            // Fonction pour extraire automatiquement le mod√®le et le prix depuis le texte coll√© (Le Bon Coin ou Facebook)
            const handleIntelligentPaste = () => {
                if (!intelligentPaste.value || !intelligentPaste.value.trim()) {
                    return;
                }
                
                const text = intelligentPaste.value.trim();
                const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);
                
                // Si la source est Facebook, traiter aussi les caract√©ristiques
                if (form.source === 'Facebook') {
                    // Formater les caract√©ristiques Facebook (m√™me logique que parseAndFormatFacebookCaracteristiques)
                    const formatted = [];
                    
                    lines.forEach(line => {
                        const lowerLine = line.toLowerCase();
                        
                        // FILTRER les lignes ind√©sirables (titre, prix, publication, etc.)
                        // Ignorer les lignes avec un prix (‚Ç¨) - le prix est d√©j√† dans le champ prix
                        if (/(\d[\d\s]*)\s*‚Ç¨/.test(line)) {
                            return;
                        }
                        
                        // Ignorer les lignes "Publi√© il y a..." ou "publi√©"
                        if (lowerLine.includes('publi√©') || lowerLine.includes('il y a')) {
                            return;
                        }
                        
                        // Ignorer les lignes "√Ä propos de ce v√©hicule" ou "√† propos"
                        if (lowerLine.includes('√† propos') || lowerLine.includes('propos de ce v√©hicule')) {
                            return;
                        }
                        
                        // Ignorer les lignes qui sont probablement le titre du v√©hicule (ann√©e + marque/mod√®le)
                        // Si la ligne contient une ann√©e (1900-2099) et du texte, c'est probablement le titre
                        const yearMatch = line.match(/\b(19|20)\d{2}\b/);
                        if (yearMatch && line.trim().length > 10 && !lowerLine.includes('km') && !lowerLine.includes('bo√Æte') && !lowerLine.includes('couleur') && !lowerLine.includes('carburant') && !lowerLine.includes('propri√©taires')) {
                            return; // C'est probablement le titre du v√©hicule
                        }
                        
                        // Ignorer les lignes qui contiennent uniquement "Couleur int√©rieure" (sans "ext√©rieure")
                        if (lowerLine.includes('couleur int√©rieure') && !lowerLine.includes('couleur ext√©rieure')) {
                            return;
                        }

                        // Kilom√©trage
                        const kmMatch = line.match(/(\d+(?:\s?\d+)*)\s*km/i);
                        if (kmMatch) {
                            const km = kmMatch[1].replace(/\s/g, '');
                            formatted.push(`Kilom√©trage : ${formatNumber(km)} km`);
                            return;
                        }

                        // Bo√Æte de vitesse
                        if (lowerLine.includes('bo√Æte de vitesse') || lowerLine.includes('transmission')) {
                            let transmission = line.replace(/.*bo√Æte de vitesse\s*/i, '').replace(/.*transmission\s*/i, '');
                            transmission = translateToFrench(transmission);
                            formatted.push(`Bo√Æte de vitesse : ${transmission}`);
                            return;
                        }

                        // Couleur ext√©rieure
                        if (lowerLine.includes('couleur ext√©rieure')) {
                            let color = line.replace(/.*couleur ext√©rieure\s*:\s*/i, '');
                            // Enlever "Couleur int√©rieure : ..." si pr√©sent (s√©par√© par ¬∑ ou autre)
                            if (color.includes('¬∑')) {
                                color = color.split('¬∑')[0].trim();
                            } else if (color.toLowerCase().includes('couleur int√©rieure')) {
                                color = color.split(/couleur int√©rieure/i)[0].trim();
                            }
                            color = translateToFrench(color);
                            formatted.push(`Couleur : ${color}`);
                            return;
                        }

                        // Type de carburant
                        if (lowerLine.includes('type de carburant') || lowerLine.includes('carburant')) {
                            let fuel = line.replace(/.*type de carburant\s*:\s*/i, '').replace(/.*carburant\s*:\s*/i, '');
                            fuel = translateToFrench(fuel);
                            formatted.push(`Type de carburant : ${fuel}`);
                            return;
                        }
                        
                        // Puissance (si pr√©sent)
                        if (lowerLine.includes('puissance') || lowerLine.includes('chevaux') || lowerLine.includes('cv') || lowerLine.includes('ch')) {
                            let power = line.replace(/.*puissance\s*:\s*/i, '').replace(/.*chevaux\s*/i, '').replace(/.*cv\s*/i, '').replace(/.*ch\s*/i, '');
                            power = translateToFrench(power);
                            formatted.push(`Puissance : ${power}`);
                            return;
                        }

                        // Nombre de propri√©taires
                        const ownersMatch = line.match(/(\d+)\s*propri√©taires?/i);
                        if (ownersMatch) {
                            formatted.push(`Propri√©taires : ${ownersMatch[1]}`);
                            return;
                        }

                        // Ignorer les autres lignes qui ne sont pas des caract√©ristiques connues
                        // (on ne garde que les caract√©ristiques format√©es ci-dessus)
                    });
                    
                    form.facebookCaracteristiquesFormatees = formatted.join('\n');
                    
                    // Pour Facebook, on ne met PAS les caract√©ristiques dans le mod√®le
                    // Elles restent s√©par√©es dans facebookCaracteristiquesFormatees
                }
                
                // 0. EXTRAIRE LE LIEN (chercher une URL Le Bon Coin dans le texte)
                const urlPattern = /https?:\/\/(www\.)?(leboncoin\.fr|leboncoin\.com)\/[^\s\)]+/gi;
                const urlMatch = text.match(urlPattern);
                if (urlMatch && urlMatch.length > 0) {
                    // Prendre le premier lien trouv√©
                    const lien = urlMatch[0].trim();
                    form.lienAnnonce = lien;
                    console.log('‚úÖ Lien extrait:', lien);
                }
                
                // 1. EXTRAIRE LE MOD√àLE/TITRE
                let modele = '';
                
                if (form.source === 'Facebook') {
                    // Pour Facebook : le titre du v√©hicule est TOUJOURS AVANT LE PRIX
                    // On cherche d'abord la ligne qui contient le prix
                    let prixLineIndex = -1;
                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i];
                        // Chercher une ligne qui contient un prix (mais pas "ou d√®s X ‚Ç¨ / mois")
                        if (/(\d[\d\s]*)\s*‚Ç¨(?!\s*\/\s*mois)/.test(line) && !/ou\s+d√®s/i.test(line)) {
                            prixLineIndex = i;
                            break;
                        }
                    }
                    
                    // Si on a trouv√© une ligne avec prix, le titre est juste avant
                    if (prixLineIndex > 0) {
                        // Chercher la premi√®re ligne avant le prix qui n'est pas une caract√©ristique
                        for (let i = prixLineIndex - 1; i >= 0; i--) {
                            const line = lines[i];
                            // Ignorer les lignes qui sont des caract√©ristiques
                            const isFacebookCarac = (
                                line.toLowerCase().includes('kilom√©trage') ||
                                line.toLowerCase().includes('km') ||
                                line.toLowerCase().includes('bo√Æte de vitesse') ||
                                line.toLowerCase().includes('transmission') ||
                                line.toLowerCase().includes('couleur') ||
                                line.toLowerCase().includes('carburant') ||
                                line.toLowerCase().includes('propri√©taires') ||
                                line.toLowerCase().includes('propri√©taire') ||
                                /^\d+/.test(line) && line.toLowerCase().includes('km') // Ligne qui commence par un nombre suivi de km
                            );
                            
                            if (!isFacebookCarac && line.trim().length > 2) {
                                modele = line.replace(/\s*¬∑\s*$/, '').trim();
                                if (modele && modele.length > 2) {
                                    form.modele = modele.toUpperCase();
                                    console.log('‚úÖ Titre du v√©hicule extrait (Facebook):', form.modele);
                                    break;
                                }
                            }
                        }
                    }
                    
                    // Si pas trouv√© avec cette m√©thode, prendre la premi√®re ligne qui n'est pas une caract√©ristique
                    if (!modele) {
                        for (const line of lines) {
                            const isPriceOnly = /^\s*(\d[\d\s]*)\s*‚Ç¨\s*$/.test(line);
                            const isMonthlyPayment = /ou\s+d√®s/i.test(line);
                            const isFacebookCarac = (
                                line.toLowerCase().includes('kilom√©trage') ||
                                line.toLowerCase().includes('bo√Æte de vitesse') ||
                                line.toLowerCase().includes('couleur') ||
                                line.toLowerCase().includes('carburant') ||
                                line.toLowerCase().includes('propri√©taires') ||
                                line.toLowerCase().includes('propri√©taire')
                            );
                            const hasPrice = /(\d[\d\s]*)\s*‚Ç¨/.test(line);
                            
                            if (!isPriceOnly && !isMonthlyPayment && !isFacebookCarac && !hasPrice && line.trim().length > 2) {
                                modele = line.replace(/\s*¬∑\s*$/, '').trim();
                                if (modele && modele.length > 2) {
                                    form.modele = modele.toUpperCase();
                                    console.log('‚úÖ Titre du v√©hicule extrait (Facebook fallback):', form.modele);
                                    break;
                                }
                            }
                        }
                    }
                } else {
                    // Pour Le Bon Coin : premi√®re ligne non vide qui ne contient pas de prix
                    for (const line of lines) {
                        // Ignorer les lignes qui contiennent uniquement un prix (ex: "26 990 ‚Ç¨")
                        const isPriceOnly = /^\s*(\d[\d\s]*)\s*‚Ç¨\s*$/.test(line);
                        // Ignorer les lignes avec "ou d√®s" (ex: "ou d√®s 438 ‚Ç¨ / mois")
                        const isMonthlyPayment = /ou\s+d√®s/i.test(line);
                        // Ignorer les lignes avec des dates (ex: "1 janvier 2026")
                        const isDate = /\d{1,2}\s+(janvier|f√©vrier|mars|avril|mai|juin|juillet|ao√ªt|septembre|octobre|novembre|d√©cembre)/i.test(line);
                        
                        if (!isPriceOnly && !isMonthlyPayment && !isDate) {
                            // Nettoyer le mod√®le (enlever les caract√®res sp√©ciaux en fin si n√©cessaire)
                            modele = line.replace(/\s*¬∑\s*$/, '').trim();
                            if (modele && modele.length > 2) { // Au moins 3 caract√®res
                                form.modele = modele.toUpperCase();
                                console.log('‚úÖ Mod√®le extrait:', form.modele);
                                break;
                            }
                        }
                    }
                }
                
                // 2. EXTRAIRE LE PRIX (chercher un nombre suivi de ‚Ç¨, mais pas "ou d√®s X ‚Ç¨ / mois")
                let prix = null;
                
                // Pour Facebook et Le Bon Coin : chercher ligne par ligne d'abord (plus pr√©cis)
                // On cherche une ligne qui contient UN PRIX suivi de ‚Ç¨ (pas un m√©lange avec une ann√©e)
                for (const line of lines) {
                    // Ignorer les lignes avec "ou d√®s" ou "/ mois"
                    if (/ou\s+d√®s|\/\s*mois/i.test(line)) {
                        continue;
                    }
                    
                    // Chercher une ligne qui contient principalement un prix (ligne de prix seule ou avec peu de texte)
                    // Pattern plus strict : ligne qui commence par un prix ou contient un prix suivi directement de ‚Ç¨
                    const prixPatternStrict = /^[\s]*(\d[\d\s]*)\s*‚Ç¨[\s]*$/; // Ligne avec seulement le prix et ‚Ç¨
                    const prixPatternLoose = /(\d[\d\s]*)\s*‚Ç¨/; // Ligne avec du texte et un prix avec ‚Ç¨
                    
                    let match = line.match(prixPatternStrict);
                    if (!match) {
                        // Si pas de ligne avec prix seul, chercher dans les lignes avec texte
                        // Mais s'assurer que c'est bien un prix (pas une ann√©e ou autre)
                        match = line.match(prixPatternLoose);
                        // V√©rifier que ce n'est pas juste une ann√©e (ex: "2007" suivi de texte)
                        if (match) {
                            const prixText = match[1].replace(/\s/g, '');
                            const prixNum = parseFloat(prixText);
                            // Ignorer si c'est un nombre de 4 chiffres qui ressemble √† une ann√©e (1900-2099)
                            // et que la ligne contient beaucoup de texte (probablement une ann√©e dans un titre)
                            if (prixNum >= 1900 && prixNum <= 2099 && line.trim().length > 10) {
                                // Probablement une ann√©e, pas un prix
                                continue;
                            }
                        }
                    }
                    
                    if (match) {
                        const prixText = match[1].replace(/\s/g, ''); // Enlever les espaces
                        const prixNum = parseFloat(prixText);
                        // V√©rifier que c'est un prix raisonnable (entre 1 et 10 millions)
                        if (prixNum && prixNum >= 1 && prixNum < 10000000) {
                            prix = prixNum;
                            console.log('‚úÖ Prix extrait depuis ligne:', prix, 'depuis:', line);
                            break;
                        }
                    }
                }
                
                // Si pas trouv√© ligne par ligne, chercher dans tout le texte (fallback)
                if (!prix) {
                    const prixPatterns = [
                        /(\d[\d\s]*)\s*‚Ç¨(?!\s*\/\s*mois)/g,  // "26 990 ‚Ç¨" mais pas "438 ‚Ç¨ / mois"
                        /(\d[\d\s]*)\s*euros?(?!\s*\/\s*mois)/gi,  // "26990 euros"
                    ];
                    
                    for (const pattern of prixPatterns) {
                        const matches = Array.from(text.matchAll(pattern));
                        // Prendre le plus grand nombre raisonnable (le prix principal, pas les mensualit√©s)
                        // Mais exclure les nombres de 4 chiffres qui ressemblent √† des ann√©es
                        let maxPrix = 0;
                        for (const match of matches) {
                            const prixText = match[1].replace(/\s/g, ''); // Enlever les espaces
                            const prixNum = parseFloat(prixText);
                            // Ignorer les ann√©es (1900-2099) et prendre seulement les prix raisonnables
                            if (prixNum && prixNum >= 1 && prixNum < 10000000 && !(prixNum >= 1900 && prixNum <= 2099 && prixNum < 10000)) {
                                if (prixNum > maxPrix) {
                                    maxPrix = prixNum;
                                }
                            }
                        }
                        if (maxPrix > 0) {
                            prix = maxPrix;
                            console.log('‚úÖ Prix extrait (fallback):', prix);
                            break;
                        }
                    }
                }
                
                // Mettre √† jour le prix si trouv√©
                if (prix) {
                    form.prix = prix;
                    // Formater le prix dans le champ en utilisant formatPrixInput
                    setTimeout(() => {
                        const prixInput = document.querySelector('input[placeholder*="Prix du v√©hicule"]');
                        if (prixInput) {
                            // Mettre la valeur brute (sans formatage) et laisser formatPrixInput faire le travail
                            prixInput.value = prix.toString().replace(/\s/g, ''); // Enlever les espaces existants
                            // D√©clencher l'√©v√©nement input pour formater correctement
                            const inputEvent = new Event('input', { bubbles: true });
                            prixInput.dispatchEvent(inputEvent);
                        }
                    }, 100);
                }
                
                // D√©finir automatiquement la source sur Leboncoin si pas d√©j√† d√©fini et si pas Facebook
                if (!form.source || form.source === '') {
                    form.source = 'Leboncoin';
                }
                
                // Afficher une notification
                const extracted = [];
                if (form.lienAnnonce) extracted.push('lien');
                if (form.modele) extracted.push('mod√®le');
                if (prix) extracted.push('prix');
                if (form.source === 'Facebook' && form.facebookCaracteristiquesFormatees) extracted.push('caract√©ristiques');
                
                if (form.source === 'Facebook') {
                    if (extracted.length >= 3) {
                        showNotification('‚úÖ Mod√®le, prix et caract√©ristiques extraits automatiquement !', 'success', 'fa-check-circle');
                    } else if (extracted.length === 2) {
                        showNotification(`‚úÖ ${extracted.join(' et ')} extraits automatiquement !`, 'success', 'fa-check-circle');
                    } else if (extracted.length === 1) {
                        showNotification(`‚úÖ ${extracted[0]} extrait !`, 'info', 'fa-info-circle');
                    } else {
                        showNotification('‚ö†Ô∏è Impossible d\'extraire les informations. V√©rifiez le format du texte.', 'warning', 'fa-exclamation-triangle');
                    }
                } else {
                    if (extracted.length === 3) {
                        showNotification('‚úÖ Lien, mod√®le et prix extraits automatiquement !', 'success', 'fa-check-circle');
                    } else if (extracted.length === 2) {
                        showNotification(`‚úÖ ${extracted.join(' et ')} extraits automatiquement !`, 'success', 'fa-check-circle');
                    } else if (extracted.length === 1) {
                        showNotification(`‚úÖ ${extracted[0]} extrait !`, 'info', 'fa-info-circle');
                    } else {
                        showNotification('‚ö†Ô∏è Impossible d\'extraire les informations. V√©rifiez le format du texte.', 'warning', 'fa-exclamation-triangle');
                    }
                }
                
                // Vider le champ intelligent apr√®s extraction
                setTimeout(() => {
                    intelligentPaste.value = '';
                }, 2000);
            };
            
            // Obtenir l'heure de fermeture de l'agence pour une date donn√©e
            const getHeureFermetureAgence = (agence, date) => {
                if (!agence) return null;
                
                let heureFermeture = null;
                
                if (date) {
                    const d = new Date(date);
                    const dayOfWeek = d.getDay();
                    
                    if (agence.horairesIdentiques) {
                        heureFermeture = agence.heureFermeture || null;
                    } else {
                        heureFermeture = agence[`horaires_${dayOfWeek}_fermeture`] || null;
                    }
                } else {
                    heureFermeture = agence.heureFermeture || null;
                }
                
                return heureFermeture;
            };
            
            // V√©rifier si une heure touche l'heure de fermeture (dans les 30 minutes avant)
            const isHeureProcheFermeture = (heure, agence, date) => {
                if (!heure || !agence) return false;
                
                const heureFermeture = getHeureFermetureAgence(agence, date);
                if (!heureFermeture) return false;
                
                // Convertir les heures en minutes
                const parseTime = (timeStr) => {
                    const [hours, minutes] = timeStr.split(':').map(Number);
                    return hours * 60 + minutes;
                };
                
                const heureMinutes = parseTime(heure);
                const fermetureMinutes = parseTime(heureFermeture);
                
                // Si l'heure est dans les 30 minutes avant la fermeture
                return heureMinutes >= fermetureMinutes - 30 && heureMinutes < fermetureMinutes;
            };
            
            // V√©rifier si une heure est apr√®s l'heure de fermeture
            const isHeureApresFermeture = (heure, agence, date) => {
                if (!heure || !agence) return false;
                
                const heureFermeture = getHeureFermetureAgence(agence, date);
                if (!heureFermeture) return false;
                
                // Convertir les heures en minutes
                const parseTime = (timeStr) => {
                    const [hours, minutes] = timeStr.split(':').map(Number);
                    return hours * 60 + minutes;
                };
                
                const heureMinutes = parseTime(heure);
                const fermetureMinutes = parseTime(heureFermeture);
                
                // Si l'heure est apr√®s la fermeture
                return heureMinutes >= fermetureMinutes;
            };
            
            // V√©rifier si une heure est dans les heures d'ouverture
            const isHeureValide = (heure, agence, date) => {
                if (!heure || !agence) return true; // Si pas d'agence, on accepte toutes les heures
                
                let heureOuverture = null;
                let heureFermeture = null;
                let heurePauseDebut = null;
                let heurePauseFin = null;
                
                if (date) {
                    const d = new Date(date);
                    const dayOfWeek = d.getDay();
                    
                    if (agence.horairesIdentiques) {
                        heureOuverture = agence.heureOuverture || null;
                        heureFermeture = agence.heureFermeture || null;
                        heurePauseDebut = agence.heurePauseDebut || null;
                        heurePauseFin = agence.heurePauseFin || null;
                    } else {
                        heureOuverture = agence[`horaires_${dayOfWeek}_ouverture`] || null;
                        heureFermeture = agence[`horaires_${dayOfWeek}_fermeture`] || null;
                        heurePauseDebut = agence[`horaires_${dayOfWeek}_pauseDebut`] || null;
                        heurePauseFin = agence[`horaires_${dayOfWeek}_pauseFin`] || null;
                    }
                } else {
                    heureOuverture = agence.heureOuverture || null;
                    heureFermeture = agence.heureFermeture || null;
                    heurePauseDebut = agence.heurePauseDebut || null;
                    heurePauseFin = agence.heurePauseFin || null;
                }
                
                if (!heureOuverture || !heureFermeture) return true; // Si pas d'horaires, on accepte
                
                const parseTime = (timeStr) => {
                    const [hours, minutes] = timeStr.split(':').map(Number);
                    return hours * 60 + minutes;
                };
                
                const heureMinutes = parseTime(heure);
                const ouvertureMinutes = parseTime(heureOuverture);
                const fermetureMinutes = parseTime(heureFermeture);
                
                // V√©rifier si l'heure est dans les heures d'ouverture
                if (heureMinutes < ouvertureMinutes || heureMinutes >= fermetureMinutes) {
                    return false;
                }
                
                // V√©rifier si l'heure est dans la pause
                if (heurePauseDebut && heurePauseFin) {
                    const pauseDebutMinutes = parseTime(heurePauseDebut);
                    const pauseFinMinutes = parseTime(heurePauseFin);
                    if (heureMinutes >= pauseDebutMinutes && heureMinutes < pauseFinMinutes) {
                        return false;
                    }
                }
                
                return true;
            };
            
            // Confirmer l'heure proche de la fermeture
            const confirmHeureFermeture = () => {
                if (heureFermetureConfirmModal.onConfirm) {
                    heureFermetureConfirmModal.onConfirm();
                }
                heureFermetureConfirmModal.open = false;
                heureFermetureConfirmModal.heure = '';
                heureFermetureConfirmModal.heureFermeture = '';
                heureFermetureConfirmModal.onConfirm = null;
            };
            
            // V√©rifier si l'heure d√©passe l'heure limite exceptionnelle
            const isHeureApresLimiteExceptionnelle = (heure, agence, date) => {
                if (!heure || !agence || !agence.heureLimiteExceptionnelle) return false;
                
                const parseTime = (timeStr) => {
                    const [hours, minutes] = timeStr.split(':').map(Number);
                    return hours * 60 + minutes;
                };
                
                // Obtenir l'heure de fermeture du jour
                const heureFermeture = getHeureFermetureAgence(agence, date);
                if (!heureFermeture) return false;
                
                const heureMinutes = parseTime(heure);
                const limiteMinutes = parseTime(agence.heureLimiteExceptionnelle);
                const fermetureMinutes = parseTime(heureFermeture);
                
                // L'heure limite exceptionnelle ne s'applique que si elle est AVANT l'heure de fermeture du jour
                // Si l'agence ferme naturellement plus t√¥t (ex: 13h), l'heure limite exceptionnelle ne s'applique pas
                if (limiteMinutes >= fermetureMinutes) {
                    return false; // L'heure limite n'est pas pertinente pour ce jour
                }
                
                // Utiliser > au lieu de >= pour que l'heure limite elle-m√™me soit encore autoris√©e
                return heureMinutes > limiteMinutes;
            };
            
            // Confirmer l'heure apr√®s la fermeture
            const confirmHeureApresFermeture = () => {
                if (heureApresFermetureModal.onConfirm) {
                    heureApresFermetureModal.onConfirm();
                }
                heureApresFermetureModal.open = false;
                heureApresFermetureModal.heure = '';
                heureApresFermetureModal.heureFermeture = '';
                heureApresFermetureModal.onConfirm = null;
            };
            
            // Fonction pour v√©rifier et demander confirmation si l'heure touche la fermeture
            const checkHeureFermetureAndConfirm = (callback) => {
                // D'abord v√©rifier l'heure limite exceptionnelle (avec la date pour v√©rifier si elle s'applique ce jour)
                if (isHeureApresLimiteExceptionnelle(form.heure, form.agence, form.date)) {
                    heureLimiteExceptionnelleModal.heure = form.heure;
                    heureLimiteExceptionnelleModal.heureLimite = form.agence.heureLimiteExceptionnelle;
                    heureLimiteExceptionnelleModal.motif = form.agence.motifHeureLimite || '';
                    heureLimiteExceptionnelleModal.open = true;
                    return; // Ne pas continuer
                }
                
                // Ensuite v√©rifier si apr√®s la fermeture
                if (isHeureApresFermeture(form.heure, form.agence, form.date)) {
                    const heureFermeture = getHeureFermetureAgence(form.agence, form.date);
                    heureApresFermetureModal.heure = form.heure;
                    heureApresFermetureModal.heureFermeture = heureFermeture;
                    heureApresFermetureModal.onConfirm = callback;
                    heureApresFermetureModal.open = true;
                    return;
                }
                
                // Ensuite v√©rifier si proche de la fermeture
                if (isHeureProcheFermeture(form.heure, form.agence, form.date)) {
                    const heureFermeture = getHeureFermetureAgence(form.agence, form.date);
                    heureFermetureConfirmModal.heure = form.heure;
                    heureFermetureConfirmModal.heureFermeture = heureFermeture;
                    heureFermetureConfirmModal.onConfirm = callback;
                    heureFermetureConfirmModal.open = true;
                } else {
                    callback();
                }
            };
            
            // Fonction pour g√©rer la saisie rapide de l'heure (14 -> 14:00)
            const handleTimeInput = (e) => {
                const value = e.target.value;
                // Si l'utilisateur tape juste un nombre (1-2 chiffres) sans ":"
                // Le champ type="time" peut accepter diff√©rents formats
                if (value) {
                    // Si c'est juste un nombre (ex: "14")
                    const match = value.match(/^(\d{1,2})$/);
                    if (match) {
                        const hour = parseInt(match[1]);
                        if (hour >= 0 && hour <= 23) {
                            // Formater avec ":00" et mettre √† jour
                            const formattedTime = `${hour.toString().padStart(2, '0')}:00`;
                            form.heure = formattedTime;
                            // Mettre √† jour la valeur de l'input apr√®s un court d√©lai
                            setTimeout(() => {
                                e.target.value = formattedTime;
                            }, 10);
                        }
                    }
                    // Si c'est au format "HH" (ex: "14" sans les minutes)
                    else if (value.match(/^\d{2}$/) && !value.includes(':')) {
                        const hour = parseInt(value);
                        if (hour >= 0 && hour <= 23) {
                            const formattedTime = `${hour.toString().padStart(2, '0')}:00`;
                            form.heure = formattedTime;
                            setTimeout(() => {
                                e.target.value = formattedTime;
                            }, 10);
                        }
                    }
                }
            };
            
            // Fonction pour r√©cup√©rer les informations depuis un lien Le Bon Coin
            // Fonction pour extraire les informations depuis Le Bon Coin
            const extractLeboncoinInfo = async (lien) => {
                if (!lien || !lien.trim()) {
                    console.log('‚ùå Pas de lien fourni');
                    return;
                }
                
                // V√©rifier si c'est un lien Le Bon Coin
                if (!lien.includes('leboncoin.fr') && !lien.includes('www.leboncoin.fr')) {
                    console.log('‚ùå Ce n\'est pas un lien Le Bon Coin:', lien);
                    return;
                }
                
                console.log('üîç D√©but extraction Le Bon Coin pour:', lien);
                
                // D√©finir automatiquement la source sur "Leboncoin"
                if (form.source !== 'Leboncoin') {
                    form.source = 'Leboncoin';
                }
                
                loadingLienAnnonce.value = true;
                
                try {
                    // Utiliser un proxy CORS pour r√©cup√©rer le contenu
                    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(lien)}`;
                    console.log('üì° Appel proxy:', proxyUrl);
                    
                    const response = await fetch(proxyUrl);
                    console.log('üì• R√©ponse re√ßue, status:', response.status);
                    
                    const data = await response.json();
                    console.log('üì¶ Donn√©es re√ßues:', data ? 'Oui' : 'Non', data?.contents ? `(${data.contents.length} caract√®res)` : '');
                    
                    if (data.contents) {
                        // Parser le HTML pour extraire les informations
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(data.contents, 'text/html');
                        
                        console.log('üìÑ HTML pars√©, titre de la page:', doc.title);
                        
                        // Essayer d'abord les meta tags Open Graph (souvent pr√©sents m√™me sans JS)
                        const ogTitle = doc.querySelector('meta[property="og:title"]')?.getAttribute('content');
                        const ogDescription = doc.querySelector('meta[property="og:description"]')?.getAttribute('content');
                        console.log('üè∑Ô∏è Meta OG Title:', ogTitle);
                        console.log('üìù Meta OG Description:', ogDescription);
                        
                        // 1. R√âCUP√âRER LE PRIX
                        let prix = null;
                        // Chercher le prix dans diff√©rents s√©lecteurs possibles
                        const prixSelectors = [
                            '[data-qa-id="adview_price"]',
                            '.price',
                            '[itemprop="price"]',
                            'span[data-qa-id="adview_price"]',
                            '.adview_price',
                            'h2[data-qa-id="adview_price"]'
                        ];
                        
                        for (const selector of prixSelectors) {
                            const prixElement = doc.querySelector(selector);
                            if (prixElement) {
                                let prixText = prixElement.textContent || prixElement.innerText || '';
                                // Nettoyer le texte du prix (enlever ‚Ç¨, espaces, etc.)
                                prixText = prixText.replace(/[^\d,.]/g, '').replace(/\s/g, '');
                                // Remplacer virgule par point pour parseFloat
                                prixText = prixText.replace(',', '.');
                                const prixNum = parseFloat(prixText);
                                if (prixNum && prixNum > 0) {
                                    prix = prixNum;
                                    break;
                                }
                            }
                        }
                        
                        // Si pas trouv√©, chercher dans les meta tags
                        if (!prix) {
                            const metaPrice = doc.querySelector('meta[property="product:price:amount"]')?.getAttribute('content');
                            if (metaPrice) {
                                const prixNum = parseFloat(metaPrice);
                                if (prixNum && prixNum > 0) {
                                    prix = prixNum;
                                    console.log('üí∞ Prix trouv√© dans meta:', prix);
                                }
                            }
                        }
                        
                        // Si pas trouv√©, chercher dans le texte de la page
                        if (!prix) {
                            const bodyText = doc.body?.textContent || '';
                            // Chercher un pattern de prix (ex: "15 000 ‚Ç¨" ou "15000‚Ç¨")
                            const prixMatch = bodyText.match(/(\d[\d\s]*)\s*‚Ç¨/);
                            if (prixMatch) {
                                const prixText = prixMatch[1].replace(/\s/g, '');
                                const prixNum = parseFloat(prixText);
                                if (prixNum && prixNum > 0) {
                                    prix = prixNum;
                                    console.log('üí∞ Prix trouv√© dans le texte:', prix);
                                }
                            }
                        }
                        
                        console.log('üí∞ Prix final:', prix);
                        
                        // 2. R√âCUP√âRER LE MOD√àLE
                        let titre = '';
                        
                        // Essayer d'abord les meta tags Open Graph (plus fiable)
                        const metaTitle = doc.querySelector('meta[property="og:title"]');
                        if (metaTitle) {
                            titre = metaTitle.getAttribute('content') || '';
                            console.log('üìå Titre depuis OG:', titre);
                        }
                        
                        // Sinon chercher dans le HTML
                        if (!titre) {
                            const titleElement = doc.querySelector('h1[data-qa-id="adview_title"]') || 
                                              doc.querySelector('h1') || 
                                              doc.querySelector('[data-qa-id="adview_title"]') ||
                                              doc.querySelector('span[data-qa-id="adview_title"]');
                            
                            if (titleElement) {
                                titre = titleElement.textContent.trim();
                                console.log('üìå Titre depuis HTML:', titre);
                            }
                        }
                        
                        // Si toujours rien, utiliser le titre de la page
                        if (!titre && doc.title) {
                            titre = doc.title;
                            console.log('üìå Titre depuis document.title:', titre);
                        }
                        
                        // Chercher aussi dans les d√©tails de l'annonce
                        const detailsElements = doc.querySelectorAll('[data-qa-id="criteria_item"]') || 
                                               doc.querySelectorAll('.properties .property') ||
                                               doc.querySelectorAll('[data-qa-id="adview_criteria_item"]');
                        
                        let marque = '';
                        let modele = '';
                        let annee = '';
                        
                        detailsElements.forEach(el => {
                            const label = el.querySelector('span')?.textContent?.toLowerCase() || '';
                            const value = el.textContent?.trim() || '';
                            
                            if (label.includes('marque') || label.includes('brand')) {
                                marque = value.replace(/marque|brand/gi, '').trim();
                            }
                            if (label.includes('mod√®le') || label.includes('model')) {
                                modele = value.replace(/mod√®le|model/gi, '').trim();
                            }
                            if (label.includes('ann√©e') || label.includes('year')) {
                                annee = value.replace(/ann√©e|year/gi, '').trim();
                            }
                        });
                        
                        // Mettre √† jour le formulaire
                        let infoRecuperees = false;
                        
                        // Mettre √† jour le mod√®le (seulement si pas d√©j√† rempli ou si on a trouv√© mieux)
                        if (titre || (marque && modele)) {
                            if (!form.modele || !form.modele.trim()) {
                                if (marque && modele) {
                                    form.modele = `${marque} ${modele}${annee ? ' ' + annee : ''}`.trim();
                                } else if (titre) {
                                    form.modele = titre.trim();
                                }
                                infoRecuperees = true;
                            }
                        }
                        
                        // Mettre √† jour le prix (seulement si pas d√©j√† rempli)
                        if (prix && (!form.prix || form.prix === 0)) {
                            form.prix = prix;
                            // Formater le prix dans le champ
                            const prixFormatted = prix.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ') + ',00';
                            // Trouver l'input prix et mettre √† jour sa valeur
                            setTimeout(() => {
                                const prixInput = document.querySelector('input[placeholder*="Prix du v√©hicule"]');
                                if (prixInput) {
                                    prixInput.value = prixFormatted;
                                }
                            }, 100);
                            infoRecuperees = true;
                        }
                        
                        if (infoRecuperees) {
                            showNotification('‚úÖ Informations r√©cup√©r√©es depuis Le Bon Coin (mod√®le' + (prix ? ' et prix' : '') + ')', 'success', 'fa-check-circle');
                            console.log('‚úÖ Succ√®s! Mod√®le:', form.modele, 'Prix:', form.prix);
                        } else {
                            console.log('‚ö†Ô∏è Aucune information r√©cup√©r√©e. Titre trouv√©:', titre, 'Prix trouv√©:', prix);
                            showNotification('‚ö†Ô∏è Impossible de r√©cup√©rer les informations. Le Bon Coin charge peut-√™tre le contenu via JavaScript. Ouvrez la console (F12) pour voir les d√©tails.', 'warning', 'fa-exclamation-triangle');
                        }
                    } else {
                        console.log('‚ùå Pas de contenu dans la r√©ponse');
                        showNotification('‚ö†Ô∏è Impossible de r√©cup√©rer le contenu de la page', 'error', 'fa-exclamation-triangle');
                    }
                } catch (error) {
                    console.error('‚ùå Erreur lors de la r√©cup√©ration des informations Le Bon Coin:', error);
                    showNotification('‚ö†Ô∏è Erreur: ' + (error.message || 'Impossible de r√©cup√©rer les informations'), 'error', 'fa-exclamation-triangle');
                } finally {
                    loadingLienAnnonce.value = false;
                }
            };
            
            // Fonction appel√©e au blur (quand on quitte le champ)
            const handleLienAnnonceBlur = async () => {
                await extractLeboncoinInfo(form.lienAnnonce);
            };
            
            // Fonction appel√©e au collage
            const handleLienAnnoncePaste = async (e) => {
                // Attendre un peu pour que le paste soit termin√©
                setTimeout(async () => {
                    await extractLeboncoinInfo(form.lienAnnonce);
                }, 100);
            };
            
            // Fonction pour ouvrir Le Bon Coin dans un nouvel onglet
            const openLeboncoinInNewTab = () => {
                if (form.lienAnnonce) {
                    window.open(form.lienAnnonce, '_blank');
                    showNotification('üìã Ouvrez la console (F12) et copiez les infos depuis la page Le Bon Coin', 'info', 'fa-info-circle');
                }
            };
            const startWizard = async (skipSteps = false) => { 
                Object.assign(form, { agence:null, civilite:'M.', nom:'', telephone:'', date:'', heure:'', modele:'', source:'', pasDeNumero: false, lienAnnonce:'', motif:'', motifCustom:'', prix: null, facebookCaracteristiques: '', facebookCaracteristiquesFormatees: '' }); 
                clientExists.value = false; 
                wizard.step = skipSteps && form.agence && form.date && form.heure ? 2 : 1; 
                wizard.open = true; 
                wizard.loading = false; 
                agencySearch.value = ''; 
                showCustomTime.value = false;
                
                // V√©rifier la connexion Google Calendar au d√©marrage
                // Pour les prospecteurs : si l'admin est connect√©, ils sont automatiquement connect√©s
                let isConnected = false;
                
                if (user.role === 'admin') {
                    const isTokenValid = await checkGoogleCalendarTokenValid();
                    isConnected = isGoogleCalendarConnected.value && isTokenValid;
                } else {
                    // Pour les prospecteurs : v√©rifier si l'admin est connect√© (connexion automatique)
                    // OU si le prospecteur a son propre token
                    const adminConnected = googleCalendarConnected.value && googleAccessToken.value && googleAccessToken.value.trim() !== '';
                    const prospecteurConnected = prospecteurGoogleCalendarConnected.value && prospecteurGoogleCalendarToken.value && prospecteurGoogleCalendarToken.value.trim() !== '' && !prospecteurGoogleCalendarTokenExpired.value;
                    
                    if (adminConnected) {
                        // L'admin est connect√©, les prospecteurs utilisent automatiquement son token
                        isConnected = true;
                    } else if (prospecteurConnected) {
                        // Le prospecteur a son propre token valide
                        const isTokenValid = await checkGoogleCalendarTokenValid();
                        isConnected = isTokenValid;
                    } else {
                        // Pas de connexion disponible
                        isConnected = false;
                    }
                }
                
                if (!isConnected) {
                    // Afficher le modal de connexion si pas connect√©
                    googleCalendarDisconnectedModal.fromWizard = true;
                    googleCalendarDisconnectedModal.open = true;
                }
            };
            
            // G√©rer la fermeture du modal de connexion
            const handleCloseDisconnectedModal = () => {
                googleCalendarDisconnectedModal.open = false;
                
                // Si le modal vient du wizard et que la connexion est obligatoire, fermer le wizard
                if (googleCalendarDisconnectedModal.fromWizard && googleCalendarRequired.value) {
                    wizard.open = false;
                }
                // Si pas obligatoire, le wizard reste ouvert et on peut continuer
                
                googleCalendarDisconnectedModal.fromWizard = false;
            };
            
            // Sauvegarder le param√®tre de connexion obligatoire
            const saveGoogleCalendarRequired = async () => {
                try {
                    await db.collection('settings').doc('google_calendar_required').set({
                        required: googleCalendarRequired.value
                    });
                } catch (err) {
                    console.error('Erreur sauvegarde param√®tre:', err);
                }
            };
            // Fonction pour v√©rifier si une date est dans une p√©riode de fermeture
            const isDateInFermeture = (date, ag) => {
                if(!ag || !ag.fermeturesExceptionnelles || !Array.isArray(ag.fermeturesExceptionnelles)) return false;
                const checkDate = new Date(date);
                for(const fermeture of ag.fermeturesExceptionnelles) {
                    if(fermeture.date_debut && fermeture.date_fin) {
                        const debut = new Date(fermeture.date_debut);
                        const fin = new Date(fermeture.date_fin);
                        // V√©rifier si la date est dans la plage (inclus)
                        if(checkDate >= debut && checkDate <= fin) {
                            return true;
                        }
                    }
                }
                return false;
            };
            
            // Fonction pour obtenir le message de fermeture pour une date donn√©e
            const getFermetureMessage = (date, ag) => {
                if(!ag || !ag.fermeturesExceptionnelles || !Array.isArray(ag.fermeturesExceptionnelles)) return null;
                const checkDate = new Date(date);
                for(const fermeture of ag.fermeturesExceptionnelles) {
                    if(fermeture.date_debut && fermeture.date_fin) {
                        const debut = new Date(fermeture.date_debut);
                        const fin = new Date(fermeture.date_fin);
                        if(checkDate >= debut && checkDate <= fin) {
                            const dateDebut = new Date(fermeture.date_debut).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });
                            const dateFin = new Date(fermeture.date_fin).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });
                            if(fermeture.date_debut === fermeture.date_fin) {
                                return `Cette agence est ferm√©e le ${dateDebut}.`;
                            } else {
                                return `Cette agence est ferm√©e du ${dateDebut} au ${dateFin}.`;
                            }
                        }
                    }
                }
                return null;
            };
            
            // Fonction helper pour v√©rifier si une agence est ferm√©e aujourd'hui
            const isAgenceFermeeAujourdhui = (ag) => {
                if(!ag) return false;
                const today = new Date().toISOString().split('T')[0];
                return isDateInFermeture(today, ag);
            };
            
            const checkAgenceAndProceed = async (ag) => { 
                // V√©rifier les vacances expir√©es
                if(ag.statut_activite === 'pause' && ag.motif_pause === 'Vacances' && ag.date_pause_fin) { 
                    const today = new Date().toISOString().split('T')[0]; 
                    if (today > ag.date_pause_fin) { 
                        await db.collection('agences').doc(ag.id).update({ statut_activite: 'actif', motif_pause: '', date_pause_debut: '', date_pause_fin: '' }); 
                        ag.statut_activite = 'actif'; 
                    } 
                } 
                // V√©rifier les fermetures exceptionnelles aujourd'hui
                const today = new Date().toISOString().split('T')[0];
                if(isDateInFermeture(today, ag)) {
                    pausedAgencyModal.agency = ag;
                    pausedAgencyModal.open = true;
                    return;
                }
                // V√©rifier si l'agence est en pause
                if(ag.statut_activite === 'pause') { 
                    pausedAgencyModal.agency = ag; 
                    pausedAgencyModal.open = true; 
                    return; 
                } 
                form.agence = ag; 
                wizard.step++; 
            };
            
            const getPauseMessage = (ag) => { 
                if(!ag) return ''; 
                // V√©rifier d'abord les fermetures exceptionnelles
                const today = new Date().toISOString().split('T')[0];
                const fermetureMsg = getFermetureMessage(today, ag);
                if(fermetureMsg) {
                    return fermetureMsg + ' (Fermeture exceptionnelle)';
                }
                // Ensuite v√©rifier les pauses normales
                if (ag.motif_pause === 'Vacances') {
                    if (ag.date_pause_debut && ag.date_pause_fin) {
                        const start = new Date(ag.date_pause_debut).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long' });
                        const end = new Date(ag.date_pause_fin).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long' });
                        return `Cette agence est en vacances du ${start} au ${end}.`; 
                    } else { return "Cette agence est en vacances (Dates non pr√©cis√©es)."; }
                }
                if(ag.motif_pause === 'Complet') return "Cette agence est compl√®te (Surcharg√©e)."; 
                if(ag.motif_pause === 'Travaux') return "Cette agence est ferm√©e pour travaux."; 
                return `Cette agence est indisponible pour le motif suivant : ${ag.motif_pause || 'Pause momentan√©e'}.`; 
            };
            
            const selectSource = async (src) => { 
                form.source = src; 
                
                // R√©initialiser le champ intelligent
                intelligentPaste.value = '';
                
                // Si ce n'est plus Facebook, r√©initialiser les caract√©ristiques Facebook
                if (src !== 'Facebook') {
                    form.facebookCaracteristiques = '';
                    form.facebookCaracteristiquesFormatees = '';
                } else {
                    // Si on passe √† Facebook, r√©initialiser aussi les caract√©ristiques pour repartir √† z√©ro
                    form.facebookCaracteristiques = '';
                    form.facebookCaracteristiquesFormatees = '';
                }
                
                // Si Google est s√©lectionn√© comme source, v√©rifier et connecter automatiquement si n√©cessaire
                if (src === 'Google' && user.role !== 'admin') {
                    const isTokenValid = await checkGoogleCalendarTokenValid();
                    const adminConnected = googleCalendarConnected.value && googleAccessToken.value && googleAccessToken.value.trim() !== '';
                    const prospecteurConnected = prospecteurGoogleCalendarConnected.value && prospecteurGoogleCalendarToken.value && prospecteurGoogleCalendarToken.value.trim() !== '' && !prospecteurGoogleCalendarTokenExpired.value;
                    
                    // Si pas connect√© (ni via admin ni via token propre valide), lancer la connexion automatiquement
                    if ((!adminConnected && !prospecteurConnected) || !isTokenValid) {
                        connectingFromSelectSource.value = true;
                        connectProspecteurGoogleCalendar();
                        // Ne pas passer √† l'√©tape suivante imm√©diatement, attendre la connexion
                        return;
                    }
                }
                
                wizard.step++; 
            };
            
            // Dictionnaire de traduction anglais -> fran√ßais
            const translateToFrench = (text) => {
                const translations = {
                    'Black': 'Noir', 'White': 'Blanc', 'Gray': 'Gris', 'Grey': 'Gris',
                    'Red': 'Rouge', 'Blue': 'Bleu', 'Green': 'Vert', 'Yellow': 'Jaune',
                    'Silver': 'Argent', 'Brown': 'Marron', 'Beige': 'Beige', 'Orange': 'Orange',
                    'Manual': 'Manuelle', 'Automatic': 'Automatique',
                    'Diesel': 'Diesel', 'Petrol': 'Essence', 'Gasoline': 'Essence', 'Electric': '√âlectrique',
                    'Hybrid': 'Hybride', 'LPG': 'GPL'
                };
                let translated = text;
                Object.keys(translations).forEach(eng => {
                    const regex = new RegExp(`\\b${eng}\\b`, 'gi');
                    translated = translated.replace(regex, translations[eng]);
                });
                return translated;
            };

            // Fonction pour formater un nombre avec des espaces comme s√©parateurs de milliers
            const formatNumber = (num) => {
                return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
            };

            // Fonction pour parser et formater les caract√©ristiques Facebook
            const parseAndFormatFacebookCaracteristiques = () => {
                if (form.source !== 'Facebook' || !form.facebookCaracteristiques || !form.facebookCaracteristiques.trim()) {
                    form.facebookCaracteristiquesFormatees = '';
                    return;
                }

                const text = form.facebookCaracteristiques.trim();
                const lines = text.split('\n').map(l => l.trim()).filter(l => l);
                const formatted = [];

                lines.forEach(line => {
                    // Ignorer les lignes qui contiennent uniquement "Couleur int√©rieure" (sans "ext√©rieure")
                    if (line.toLowerCase().includes('couleur int√©rieure') && !line.toLowerCase().includes('couleur ext√©rieure')) {
                        return;
                    }

                    // Kilom√©trage
                    const kmMatch = line.match(/(\d+(?:\s?\d+)*)\s*km/i);
                    if (kmMatch) {
                        const km = kmMatch[1].replace(/\s/g, '');
                        formatted.push(`Kilom√©trage : ${formatNumber(km)} km`);
                        return;
                    }

                    // Bo√Æte de vitesse
                    if (line.toLowerCase().includes('bo√Æte de vitesse') || line.toLowerCase().includes('transmission')) {
                        let transmission = line.replace(/.*bo√Æte de vitesse\s*/i, '').replace(/.*transmission\s*/i, '');
                        transmission = translateToFrench(transmission);
                        formatted.push(`Bo√Æte de vitesse : ${transmission}`);
                        return;
                    }

                    // Couleur ext√©rieure
                    if (line.toLowerCase().includes('couleur ext√©rieure')) {
                        let color = line.replace(/.*couleur ext√©rieure\s*:\s*/i, '');
                        // Enlever "Couleur int√©rieure : ..." si pr√©sent (s√©par√© par ¬∑ ou autre)
                        if (color.includes('¬∑')) {
                            color = color.split('¬∑')[0].trim();
                        } else if (color.toLowerCase().includes('couleur int√©rieure')) {
                            color = color.split(/couleur int√©rieure/i)[0].trim();
                        }
                        color = translateToFrench(color);
                        formatted.push(`Couleur : ${color}`);
                        return;
                    }

                    // Type de carburant
                    if (line.toLowerCase().includes('type de carburant') || line.toLowerCase().includes('carburant')) {
                        let fuel = line.replace(/.*type de carburant\s*:\s*/i, '').replace(/.*carburant\s*:\s*/i, '');
                        fuel = translateToFrench(fuel);
                        formatted.push(`Type de carburant : ${fuel}`);
                        return;
                    }

                    // Nombre de propri√©taires
                    const ownersMatch = line.match(/(\d+)\s*propri√©taires?/i);
                    if (ownersMatch) {
                        formatted.push(`Propri√©taires : ${ownersMatch[1]}`);
                        return;
                    }

                    // Autres lignes (on les garde telles quelles mais on traduit)
                    if (line && !line.toLowerCase().includes('couleur int√©rieure')) {
                        formatted.push(translateToFrench(line));
                    }
                });

                form.facebookCaracteristiquesFormatees = formatted.join('\n');
                
                // Mettre √† jour le mod√®le avec les caract√©ristiques format√©es (seulement si n√©cessaire)
                // On attend un peu pour √©viter les mises √† jour multiples pendant la saisie
                clearTimeout(window.facebookUpdateTimeout);
                window.facebookUpdateTimeout = setTimeout(() => {
                    updateModeleFromFacebook();
                }, 300);
            };

            // Fonction pour g√©rer le collage depuis Facebook
            const handleFacebookPaste = (e) => {
                // Laisser le collage se faire normalement, puis parser
                setTimeout(() => {
                    parseAndFormatFacebookCaracteristiques();
                }, 10);
            };

            // Fonction pour extraire le mod√®le de base (sans les caract√©ristiques)
            const getBaseModele = (modeleText) => {
                if (!modeleText) return '';
                // Si le mod√®le contient " - ", on prend seulement la partie avant
                if (modeleText.includes(' - ')) {
                    return modeleText.split(' - ')[0].trim();
                }
                // Si le mod√®le contient des caract√©ristiques format√©es (avec " : "), c'est probablement juste les caract√©ristiques
                if (modeleText.includes('Kilom√©trage :') || modeleText.includes('Bo√Æte de vitesse :')) {
                    return '';
                }
                return modeleText.trim();
            };

            // Fonction pour mettre √† jour automatiquement le mod√®le avec les caract√©ristiques Facebook format√©es
            // NOTE: Pour Facebook, on ne met PLUS les caract√©ristiques dans le mod√®le automatiquement
            // Le titre du v√©hicule reste s√©par√© des caract√©ristiques
            const updateModeleFromFacebook = () => {
                // D√©sactiv√© : les caract√©ristiques Facebook restent s√©par√©es du mod√®le
                // Le titre du v√©hicule est extrait s√©par√©ment et ne contient pas les caract√©ristiques
                return;
                
                /* ANCIEN CODE (d√©sactiv√©)
                if (form.source !== 'Facebook' || !form.facebookCaracteristiquesFormatees || !form.facebookCaracteristiquesFormatees.trim()) {
                    return;
                }
                
                const caracteristiques = form.facebookCaracteristiquesFormatees.trim();
                const caracteristiquesFormatees = caracteristiques.replace(/\n/g, ' | ');
                
                // Extraire le mod√®le de base actuel (sans les caract√©ristiques d√©j√† pr√©sentes)
                let baseModele = getBaseModele(form.modele);
                
                // V√©rifier si les caract√©ristiques sont d√©j√† dans le mod√®le
                // On compare la premi√®re caract√©ristique pour √©viter les doublons
                const firstCarac = caracteristiques.split('\n')[0];
                if (form.modele && form.modele.includes(firstCarac)) {
                    // Les caract√©ristiques sont d√©j√† pr√©sentes, on ne fait rien
                    return;
                }
                
                // Construire le mod√®le final
                if (baseModele && baseModele.trim()) {
                    form.modele = `${baseModele} - ${caracteristiquesFormatees}`;
                } else {
                    form.modele = caracteristiquesFormatees;
                }
                */
            };
            
            // Fonction pour formater l'affichage des caract√©ristiques de mani√®re propre
            const formatCaracteristiquesForDisplay = (modeleText) => {
                if (!modeleText || typeof modeleText !== 'string') return { base: '', caracteristiques: [] };
                
                // S√©parer le mod√®le de base et les caract√©ristiques
                let base = '';
                let caracteristiques = [];
                
                if (modeleText.includes(' - ')) {
                    const parts = modeleText.split(' - ');
                    base = parts[0].trim();
                    const caracteristiquesText = parts.slice(1).join(' - ');
                    
                    // Parser les caract√©ristiques s√©par√©es par " | "
                    caracteristiques = caracteristiquesText.split(' | ').filter(c => c.trim()).map(c => {
                        const trimmed = c.trim();
                        // Si c'est format√© "Label : valeur", on le garde tel quel
                        if (trimmed.includes(' : ')) {
                            let [label, value] = trimmed.split(' : ').map(s => s.trim());
                            // Normaliser les labels
                            if (label === 'Couleur ext√©rieure') label = 'Couleur';
                            if (label === 'Nombre de propri√©taires') label = 'Propri√©taires';
                            return { label, value };
                        }
                        return { label: '', value: trimmed };
                    });
                } else if (modeleText.includes('Kilom√©trage :') || modeleText.includes('Bo√Æte de vitesse :')) {
                    // C'est juste des caract√©ristiques, pas de mod√®le de base
                    caracteristiques = modeleText.split(' | ').filter(c => c.trim()).map(c => {
                        const trimmed = c.trim();
                        if (trimmed.includes(' : ')) {
                            let [label, value] = trimmed.split(' : ').map(s => s.trim());
                            // Normaliser les labels
                            if (label === 'Couleur ext√©rieure') label = 'Couleur';
                            if (label === 'Nombre de propri√©taires') label = 'Propri√©taires';
                            return { label, value };
                        }
                        return { label: '', value: trimmed };
                    });
                } else {
                    // C'est juste le mod√®le de base
                    base = modeleText.trim();
                }
                
                return { base, caracteristiques };
            };
            
            // Fonction pour valider et envoyer le SMS (avec v√©rification Google Calendar)
            const validateAndSendSMS = async () => {
                // Emp√™cher les doubles clics
                if (wizard.loading) return;
                
                // OUVRIR LE SMS IMM√âDIATEMENT avec les donn√©es du formulaire
                const tempRdv = {
                    ...form,
                    agenceId: form.agence.id,
                    statut: 'confirme'
                };
                const smsLink = generateMsgLink(tempRdv, 'confirm');
                if (smsLink) {
                    window.open(smsLink, '_blank');
                }
                
                // Cr√©er le RDV en arri√®re-plan (sans bloquer)
                finalizeRdv('confirme', false).catch(err => {
                    console.error('Erreur cr√©ation RDV:', err);
                });
            };
            
            // Fonction pour cr√©er un RDV "a_confirmer" avec SMS
            const finalizeRdvWithSMS = async (statut) => {
                // Emp√™cher les doubles clics
                if (wizard.loading) return;
                
                // Cr√©er le RDV
                await finalizeRdv(statut, false);
                
                // Ouvrir le SMS apr√®s cr√©ation
                const tempRdv = {
                    ...form,
                    agenceId: form.agence.id,
                    statut: statut
                };
                const smsLink = generateMsgLink(tempRdv, 'confirm');
                if (smsLink) {
                    window.open(smsLink, '_blank');
                }
            };
            
            const confirmRappelSent = async (rdv) => {
                if (!rdv || !rdv.id) return;
                
                try {
                    const now = new Date();
                    const rappelData = {
                        date: now.toISOString().split('T')[0],
                        heure: now.toTimeString().split(' ')[0].substring(0, 5),
                        par: user.name,
                        userId: user.id,
                        timestamp: now
                    };
                    
                    await db.collection('rendezvous').doc(rdv.id).update({
                        rappelSent: rappelData
                    });
                    
                    // Mettre √† jour le rdv local
                    if (clientModal.rdv && clientModal.rdv.id === rdv.id) {
                        clientModal.rdv.rappelSent = rappelData;
                    }
                    
                    // Mettre √† jour dans la liste des rdv
                    const rdvIndex = rdvList.value.findIndex(r => r.id === rdv.id);
                    if (rdvIndex !== -1) {
                        rdvList.value[rdvIndex].rappelSent = rappelData;
                    }
                    
                    rappelConfirmModal.open = false;
                    showNotification('Rappel enregistr√© avec succ√®s', 'success');
                } catch (error) {
                    console.error('Erreur lors de l\'enregistrement du rappel:', error);
                    showNotification('Erreur lors de l\'enregistrement du rappel', 'error');
                }
            };
            
            const handleSendRappel = (rdv) => {
                if (!rdv) return;
                const smsLink = generateMsgLink(rdv, getRappelType(rdv));
                // Ouvrir le SMS dans un nouvel onglet
                window.open(smsLink, '_blank');
                // Apr√®s 2 secondes, ouvrir le modal de confirmation
                setTimeout(() => {
                    rappelConfirmModal.rdv = rdv;
                    rappelConfirmModal.smsLink = smsLink;
                    rappelConfirmModal.open = true;
                }, 2000);
            };
            
            const createQuickRdv = async () => {
                if (!quickRdvModal.agenceId || !quickRdvModal.source) {
                    showNotification('Veuillez remplir tous les champs obligatoires', 'error');
                    return;
                }
                
                // V√©rifier si l'agence a des commerciaux
                // Une valeur vide (cha√Æne vide '') signifie "Je ne sais pas", ce qui est valide
                // On accepte donc une cha√Æne vide comme valeur valide
                // La validation est donc toujours pass√©e car commercialId est initialis√© √† '' et peut rester vide pour "Je ne sais pas"
                // Pas besoin de validation suppl√©mentaire ici
                
                try {
                    const agence = agences.value.find(a => a.id === quickRdvModal.agenceId);
                    if (!agence) {
                        showNotification('Agence introuvable', 'error');
                        return;
                    }
                    
                    // Utiliser la date d'aujourd'hui si non fournie
                    const today = new Date().toISOString().split('T')[0];
                    const rdvDate = quickRdvModal.date || today;
                    // Utiliser 12:00 par d√©faut si l'heure n'est pas fournie
                    const rdvHeure = quickRdvModal.heure || '12:00';
                    
                    // Sauvegarder l'√©tat honore avant r√©initialisation
                    const wasHonore = quickRdvModal.honore;
                    
                    const rdvData = {
                        nom: quickRdvModal.nom || '',
                        modele: quickRdvModal.modele || '',
                        note: quickRdvModal.note || '',
                        agenceId: quickRdvModal.agenceId,
                        commercialId: quickRdvModal.commercialId || '',
                        date: rdvDate,
                        heure: rdvHeure,
                        statut: wasHonore ? 'honore' : 'confirme',
                        honorBilling: wasHonore ? 'facture' : null,
                        prix: parseFloat(agence.prix) || 0,
                        created: new Date(),
                        createdBy: user.name,
source: quickRdvModal.source, // <--- CORRECTION : On garde le format original (ex: Leboncoin)                        rappelFait: false,
                        dansAgenda: false,
                        enAttenteAgenda: false
                    };
                    
                    const docRef = await db.collection('rendezvous').add(rdvData);
                    const newRdv = { id: docRef.id, ...rdvData };
                    
                    // Si le RDV est honor√©, le synchroniser automatiquement au bilan
                    if (wasHonore) {
                        try {
                            // R√©cup√©rer le nom du commercial si un commercialId est fourni
                            let commercialName = '';
                            if (quickRdvModal.commercialId && quickRdvModal.commercialId !== '') {
                                // Chercher dans teamList d'abord
                                let commercial = teamList.value.find(u => u.id === quickRdvModal.commercialId);
                                if (!commercial) {
                                    // Si pas trouv√© dans teamList, chercher dans les commerciaux des r√©glages
                                    const ag = agences.value.find(a => a.id === quickRdvModal.agenceId);
                                    if (ag) {
                                        if (ag.commerciauxDetails && ag.commerciauxDetails.length > 0) {
                                            const settingCommercial = ag.commerciauxDetails.find(c => {
                                                const name = typeof c === 'string' ? c : c.name;
                                                return `setting_${name.replace(/\s+/g, '_')}` === quickRdvModal.commercialId;
                                            });
                                            if (settingCommercial) {
                                                commercialName = typeof settingCommercial === 'string' ? settingCommercial : settingCommercial.name;
                                            }
                                        } else if (ag.commerciaux && ag.commerciaux.length > 0) {
                                            const settingCommercial = ag.commerciaux.find(name => 
                                                `setting_${name.replace(/\s+/g, '_')}` === quickRdvModal.commercialId
                                            );
                                            if (settingCommercial) {
                                                commercialName = settingCommercial;
                                            }
                                        }
                                    }
                                } else {
                                    commercialName = commercial.name;
                                }
                            } else if (quickRdvHasCommerciaux.value) {
                                // Si "Je ne sais pas" est s√©lectionn√© (valeur vide) ou si l'agence a des commerciaux mais aucun n'est s√©lectionn√©
                                commercialName = '√Ä traiter';
                            }
                            await syncRdvToBilan(newRdv, commercialName, quickRdvHasCommerciaux.value && !quickRdvModal.commercialId);
                        } catch (syncError) {
                            console.error('Erreur lors de la synchronisation au bilan:', syncError);
                            // Ne pas bloquer la cr√©ation du RDV si la sync √©choue
                        }
                    }
                    
                    // R√©initialiser le modal
                    quickRdvModal.nom = '';
                    quickRdvModal.modele = '';
                    quickRdvModal.note = '';
                    quickRdvModal.agenceId = '';
                    quickRdvModal.commercialId = '';
                    quickRdvModal.date = '';
                    quickRdvModal.heure = '';
                    quickRdvModal.source = '';
                    quickRdvModal.honore = false;
                    quickRdvModal.open = false;
                    
                    const statutMsg = wasHonore ? 'Rendez-vous honor√© cr√©√© avec succ√®s et synchronis√© au bilan' : 'Rendez-vous cr√©√© avec succ√®s';
                    showNotification(statutMsg, 'success');
                } catch (error) {
                    console.error('Erreur lors de la cr√©ation du RDV rapide:', error);
                    showNotification('Erreur lors de la cr√©ation du rendez-vous', 'error');
                }
            };
            
            const finalizeRdv = async (statut, openSMS = false) => {
                // Emp√™cher les doubles clics
                if (wizard.loading) return;
                wizard.loading = true;
                
                try {
                    // V√âRIFIER LA CONNEXION √Ä L'AGENDA AVANT D'ENVOYER LE SMS
                    const isTokenValid = await checkGoogleCalendarTokenValid();
                    const isConnected = isGoogleCalendarConnected.value && isTokenValid;
                    
                    const motifFinal = form.motif === '__CUSTOM__' ? (form.motifCustom || '') : (form.motif || '');
                    const rdvLinkId = generateRdvLinkId();
                    // Utiliser le prix du formulaire s'il existe, sinon celui de l'agence
                    const prixFinal = form.prix !== null && form.prix !== undefined ? parseFloat(form.prix) : (parseFloat(form.agence.prix) || 0);
                    const rdvData = {
                        ...form,
                        agenceId: form.agence.id,
                        prix: prixFinal,
                        statut,
                        motif: motifFinal,
                        created: new Date(),
                        createdBy: user.name,
                        rappelFait: false,
                        dansAgenda: false,
                        enAttenteAgenda: !isConnected, // Mettre en attente si pas connect√©
                        rdvLinkId: rdvLinkId // Lien unique pour le client
                    };
                    delete rdvData.motifCustom;
                    // Garder les caract√©ristiques format√©es pour Google Agenda, mais ne pas sauvegarder le texte brut
                    if (rdvData.source === 'Facebook' && form.facebookCaracteristiquesFormatees) {
                        rdvData.facebookCaracteristiquesFormatees = form.facebookCaracteristiquesFormatees;
                    }
                    delete rdvData.facebookCaracteristiques; // Ne pas sauvegarder le texte brut, seulement le format√©
                    
                    const docRef = await db.collection('rendezvous').add(rdvData);
                    const newRdv = { id: docRef.id, ...rdvData };
                    
                    // Log de la cr√©ation
                    logAction('creation_rdv', {
                        rdvId: docRef.id,
                        client: `${form.civilite} ${form.nom}`,
                        date: form.date,
                        heure: form.heure,
                        agence: getAgenceName(form.agenceId),
                        source: form.source,
                        statut: statut
                    });
                    
                    let placedInAgenda = false;
                    
                    // Ajouter automatiquement √† Google Calendar seulement si connect√©
                    if (isConnected) {
                        try {
                            const eventResult = await createGoogleCalendarEvent(newRdv);
                            // Marquer comme ajout√© dans l'agenda et stocker l'ID de l'√©v√©nement
                            await db.collection('rendezvous').doc(docRef.id).update({ 
                                dansAgenda: true,
                                googleCalendarEventId: eventResult.eventId || eventResult.id,
                                enAttenteAgenda: false
                            });
                            newRdv.dansAgenda = true;
                            newRdv.googleCalendarEventId = eventResult.eventId || eventResult.id;
                            newRdv.enAttenteAgenda = false;
                            placedInAgenda = true;
                        } catch (err) {
                            console.error('Erreur lors de l\'ajout √† Google Calendar:', err);
                            
                            // D√©tecter les erreurs de token m√™me apr√®s v√©rification
                            const errorMessage = err.message || '';
                            const isTokenError = errorMessage.includes('401') || 
                                               errorMessage.includes('403') || 
                                               errorMessage.includes('Invalid Credentials') ||
                                               errorMessage.includes('expired') ||
                                               errorMessage.includes('token');
                            
                            if (isTokenError) {
                                // Mettre en attente si erreur de token
                                await db.collection('rendezvous').doc(docRef.id).update({ 
                                    enAttenteAgenda: true
                                });
                            }
                            // Ne pas bloquer la cr√©ation du RDV si l'ajout √† Google Calendar √©choue
                        }
                    }
                    
                    // Afficher le message de confirmation moderne
                    if (placedInAgenda) {
                        showNotification('Rendez-vous cr√©√© et plac√© dans l\'agenda Google Calendar', 'success', 'fa-calendar-check');
                    } else if (!isConnected) {
                        // Ne pas afficher de notification si on n'est pas connect√© (le modal s'en charge)
                    } else {
                        showNotification('Rendez-vous cr√©√©. Connectez Google Calendar dans les param√®tres pour l\'ajouter √† l\'agenda', 'warning', 'fa-calendar-plus');
                    }
                    
                    // Ouvrir le SMS si demand√© et si le statut est "confirme"
                    if (openSMS && statut === 'confirme') {
                        const smsLink = generateMsgLink(newRdv, 'confirm');
                        if (smsLink) {
                            window.open(smsLink, '_blank');
                        }
                    }
                    
                    wizard.open = false;
                    
                    // Retourner le RDV cr√©√© pour pouvoir v√©rifier son √©tat
                    return newRdv;
                } catch (err) {
                    console.error('Erreur lors de la cr√©ation du rendez-vous:', err);
                    alert('‚ùå Erreur lors de la cr√©ation du rendez-vous. Veuillez r√©essayer.');
                    return null;
                } finally {
                    wizard.loading = false;
                }
            };
            
            const openRdvFiche = async (r) => { 
                // Charger les donn√©es compl√®tes depuis Firestore pour avoir les notes √† jour
                try {
                    const doc = await db.collection('rendezvous').doc(r.id).get();
                    const data = doc.data();
                    // Convertir les timestamps Firestore en conservant le format original pour compatibilit√©
                    const fullData = { 
                        id: doc.id, 
                        ...data,
                        // Conserver le timestamp Firestore tel quel, on le convertira √† l'affichage
                        created: data.created || r.created
                    };
                    clientModal.rdv = fullData; 
                    showDiscountInput.value = !!fullData.geste_commercial; 
                    clientModal.view = 'main';
                    clientModal.open = true;
                } catch (error) {
                    // Fallback si erreur
                    clientModal.rdv = { ...r }; 
                    showDiscountInput.value = !!r.geste_commercial; 
                    clientModal.view = 'main';
                    clientModal.open = true;
                }
            };
            const updateRdv = async (r) => { await db.collection('rendezvous').doc(r.id).update(r); clientModal.open = false; };
            const toggleOkM = async (rdv, e) => {
                if (e) e.stopPropagation();
                const newTag = rdv.tag === 'OK M' ? null : 'OK M';
                await db.collection('rendezvous').doc(rdv.id).update({ tag: newTag });
                rdv.tag = newTag;
            };
            const resendReminder = async (r) => {
                const rappelType = getRappelType(r);
                const link = generateMsgLink(r, rappelType);
                if(link) {
                    window.open(link, '_blank');
                }
            };
            
            // Fonction pour envoyer un rappel manuel depuis un rendez-vous √† venir
            const sendManualRappel = async (rdv, event) => {
                if (event) {
                    event.stopPropagation(); // Emp√™cher l'ouverture de la fiche
                }
                
                // V√©rifier si le rendez-vous est dans 5 jours ou moins
                if (!rdv.date) return;
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const rdvDate = new Date(rdv.date);
                rdvDate.setHours(0, 0, 0, 0);
                const diffDays = Math.round((rdvDate - today) / 86400000);
                
                if (diffDays < 0) {
                    showNotification('‚ö†Ô∏è Ce rendez-vous est d√©j√† pass√©', 'error', 'fa-exclamation-triangle');
                    return;
                }
                
                if (diffDays > 5) {
                    showNotification('‚ÑπÔ∏è Les rappels sont envoy√©s automatiquement pour les rendez-vous dans 5 jours ou moins', 'info', 'fa-info-circle');
                    return;
                }
                
                // D√©terminer le type de rappel selon le nombre de jours
                let rappelType = 'rappel';
                if (diffDays === 0) {
                    rappelType = 'rappel_today';
                } else if (diffDays === 1) {
                    rappelType = 'rappel';
                } else {
                    // Pour les rendez-vous dans 2 √† 5 jours, utiliser le type 'rappel'
                    rappelType = 'rappel';
                }
                
                const link = generateMsgLink(rdv, rappelType);
                if (link) {
                    window.open(link, '_blank');
                    
                    // Marquer comme rappel fait si ce n'est pas d√©j√† fait
                    if (!rdv.rappelFait) {
                        const now = new Date();
                        const note = { 
                            text: `üîî Rappel envoy√© manuellement`, 
                            author: user.name, 
                            date: now.toISOString(),
                            type: 'rappel'
                        };
                        let notes = rdv.notes || []; 
                        notes.push(note);
                        await db.collection('rendezvous').doc(rdv.id).update({ 
                            rappelFait: true,
                            rappelFaitDate: now.toISOString(),
                            rappelFaitHeure: now.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'}),
                            notes: notes
                        }); 
                        rdv.rappelFait = true;
                        rdv.rappelFaitDate = now.toISOString();
                        rdv.rappelFaitHeure = now.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});
                        rdv.notes = notes;
                        if(clientModal.rdv && clientModal.rdv.id === rdv.id) {
                            clientModal.rdv.rappelFait = true;
                            clientModal.rdv.rappelFaitDate = now.toISOString();
                            clientModal.rdv.rappelFaitHeure = now.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});
                            clientModal.rdv.notes = notes;
                        }
                    }
                    
                    showNotification('üì± Application SMS ouverte', 'success', 'fa-mobile-alt');
                }
            };
            
            // Fonction pour v√©rifier et envoyer les SMS programm√©s
            const checkAndSendScheduledSMS = async () => {
                try {
                    const now = new Date();
                    const nowISO = now.toISOString();
                    
                    // R√©cup√©rer les SMS programm√©s qui doivent √™tre envoy√©s maintenant (dans les 2 prochaines minutes)
                    const twoMinutesLater = new Date(now.getTime() + 2 * 60 * 1000).toISOString();
                    
                    const scheduledQuery = await db.collection('scheduledSMS')
                        .where('status', '==', 'pending')
                        .where('scheduledFor', '<=', twoMinutesLater)
                        .get();
                    
                    for(const doc of scheduledQuery.docs) {
                        const sms = doc.data();
                        
                        // Cr√©er le lien SMS et l'ouvrir automatiquement
                        const smsLink = `sms:${sms.telephone}?body=${encodeURIComponent(sms.message)}`;
                        
                        // Marquer comme envoy√©
                        await db.collection('scheduledSMS').doc(doc.id).update({
                            status: 'sent',
                            sentAt: nowISO
                        });
                        
                        // Ouvrir le SMS (cela d√©clenchera l'application SMS)
                        window.open(smsLink, '_blank');
                        
                        // Log de l'envoi
                        logAction('sms_programme_envoye', {
                            rdvId: sms.rdvId,
                            client: sms.client,
                            telephone: sms.telephone,
                            type: sms.type,
                            programmePour: sms.scheduledFor
                        });
                    }
                } catch(err) {
                    console.error('Erreur v√©rification SMS programm√©s:', err);
                }
            };
            
            // D√©marrer la v√©rification p√©riodique (toutes les minutes)
            const startScheduledSMSChecker = () => {
                // V√©rifier imm√©diatement
                checkAndSendScheduledSMS();
                // Puis toutes les minutes
                setInterval(checkAndSendScheduledSMS, 60 * 1000);
            };
            
            // G√©n√©rer un identifiant unique pour le lien client
            const generateRdvLinkId = () => {
                return Date.now().toString(36) + Math.random().toString(36).substring(2, 11);
            };
            
            // G√©n√©rer l'URL du lien client
            const getRdvClientLink = (rdvLinkId) => {
                if (!rdvLinkId) return '';
                // Utiliser l'URL configur√©e dans les r√©glages, sinon utiliser l'origine actuelle
                const baseUrl = globalSettings.value.rdvLinkBaseUrl || window.location.origin;
                // Nettoyer l'URL (enlever le slash final si pr√©sent)
                const cleanBaseUrl = baseUrl.replace(/\/$/, '');
                return `${cleanBaseUrl}/rdv.html?id=${rdvLinkId}`;
            };
            
            const softDeleteRdv = (r) => { selectedIds.value = [r.id]; clientModal.open = false; openBulkConfirm('soft_delete', 'Envoyer ce RDV √† la corbeille ?'); };
            const deleteRdv = softDeleteRdv;
            
            const openCancelChoice = (r) => { 
                cancelModal.rdv = r; 
                cancelModal.motif = ''; 
                cancelModal.motifCustom = ''; 
                cancelModal.selectedMotif = ''; 
                cancelModal.sendSMS = false; 
                cancelModal.who = ''; 
                cancelModal.open = true; 
            };
            const confirmCancel = async (r, who, motif, sendSMS) => { 
                // Le motif est obligatoire seulement si c'est le client qui annule
                if (who === 'client' && !motif) return;
                
                // --- 1. ENVOI SMS EN PRIORIT√â (AVANT TOUTE ATTENTE) ---
                // On le fait tout de suite pour que le navigateur ne bloque pas la fen√™tre
                if (sendSMS && r.telephone) {
                    const smsType = who === 'client' ? 'cancel_clt' : 'cancel_ag';
                    // On injecte temporairement le motif pour que le lien SMS soit g√©n√©r√© avec le bon motif
                    const tempRdvForSms = { ...r, motif: motif, statut: 'annule' };
                    const smsLink = generateLink(tempRdvForSms, smsType);
                    
                    if (smsLink) {
                        window.open(smsLink, '_blank');
                    }
                }
                // -------------------------------------------------------

                const wasHonored = r.statut === 'honore';
                
                // 2. Mise √† jour base de donn√©es
                await db.collection('rendezvous').doc(r.id).update({ 
                    statut: 'annule', 
                    motif: motif,
                    honorBilling: null 
                });
                
                // Log de l'action
                logAction('annulation', {
                    rdvId: r.id,
                    client: `${r.civilite} ${r.nom}`,
                    date: r.date,
                    heure: r.heure,
                    qui: who,
                    motif: motif,
                    smsEnvoye: sendSMS
                }); 
                
                // 3. Mise √† jour Agenda Google
                if (r.dansAgenda && r.googleCalendarEventId) {
                    // On force les donn√©es locales pour le titre et la description
                    r.statut = 'annule'; 
                    r.motif = motif; 
                    
                    if (googleCalendarConnected.value || prospecteurGoogleCalendarConnected.value) {
                         // On lance la mise √† jour en fond
                         updateGoogleCalendarEvent(r).then(() => console.log("Agenda mis √† jour (Annul√©)"));
                    }
                }
                
                // 4. Nettoyage si c'√©tait un RDV honor√©
                if (wasHonored) {
                    await deleteTransactionsForRdv(r.id);
                    await removeRdvFromBilan(r.id); 
                }
                
                // 5. Mise √† jour affichage local (Agenda visuel)
                if (r.date && calendarEvents.value[r.date]) {
                    const eventIndex = calendarEvents.value[r.date].findIndex(e => e.type === 'rdv' && e.id === r.id);
                    if (eventIndex >= 0) {
                        calendarEvents.value[r.date][eventIndex] = {
                            ...calendarEvents.value[r.date][eventIndex],
                            statut: 'annule',
                            motif: motif
                        };
                    }
                }
                
                // 6. Mise √† jour liste
                const rdvIndex = rdvList.value.findIndex(rdv => rdv.id === r.id);
                if (rdvIndex >= 0) {
                    rdvList.value[rdvIndex].statut = 'annule';
                    rdvList.value[rdvIndex].motif = motif;
                }
                
                if (view.value === 'calendar') {
                    setTimeout(() => {
                        refreshCalendarEvents();
                    }, 300);
                }
                
                // 7. Fermeture modales
                cancelModal.open = false; 
                cancelModal.motif = ''; 
                cancelModal.motifCustom = ''; 
                cancelModal.selectedMotif = ''; 
                cancelModal.sendSMS = false; 
                cancelModal.who = ''; 
                clientModal.open = false; 
            };
            const quickCancel = async (r) => { 
                // Utiliser le m√™me modal d'annulation avec motif
                openCancelChoice(r);
            };
            
            const openEdit = (r) => { 
                if (!r) return;
                editModal.rdv = r; 
                try {
                    const parsed = formatCaracteristiquesForDisplay(r.modele || '');
                    editModal.form = { 
                        civilite: r.civilite || 'M.', 
                        nom: r.nom || '', 
                        telephone: r.telephone || '', 
                        baseModele: parsed.base || '',
                        caracteristiques: parsed.caracteristiques && parsed.caracteristiques.length > 0 ? parsed.caracteristiques : [],
                        source: r.source || '', 
                        agenceId: r.agenceId || '',
                        prix: r.prix || null,
                        modele: r.modele || ''
                    }; 
                } catch (e) {
                    console.error('Erreur dans openEdit:', e);
                    editModal.form = { 
                        civilite: r.civilite || 'M.', 
                        nom: r.nom || '', 
                        telephone: r.telephone || '', 
                        baseModele: r.modele || '',
                        caracteristiques: [],
                        source: r.source || '', 
                        agenceId: r.agenceId || '',
                        prix: r.prix || null,
                        modele: r.modele || ''
                    };
                }
                editModal.open = true; 
            };
            
            // Fonction pour mettre √† jour le mod√®le complet √† partir du mod√®le de base et des caract√©ristiques
            const updateEditModalModele = () => {
                if (!editModal.form) return;
                const base = editModal.form.baseModele || '';
                const caracteristiques = editModal.form.caracteristiques || [];
                if (caracteristiques.length > 0) {
                    const caracStr = caracteristiques.map(c => `${c.label} : ${c.value}`).join(' | ');
                    editModal.form.modele = base ? `${base} - ${caracStr}` : caracStr;
                } else {
                    editModal.form.modele = base;
                }
            };
            
            // Fonction pour ajouter une nouvelle caract√©ristique
            const addNewCaracteristique = () => {
                if (!editModal.form.caracteristiques) {
                    editModal.form.caracteristiques = [];
                }
                editModal.form.caracteristiques.push({ label: '', value: '' });
            };
            
            // Fonction pour supprimer une caract√©ristique
            const removeCaracteristique = (idx) => {
                if (editModal.form.caracteristiques && editModal.form.caracteristiques.length > idx) {
                    editModal.form.caracteristiques.splice(idx, 1);
                    updateEditModalModele();
                }
            };
           const saveEdit = async () => {
                if(!editModal.rdv) return;

                // Mettre √† jour le mod√®le complet avant de sauvegarder
                updateEditModalModele();
                
                // Pr√©parer les caract√©ristiques format√©es pour Facebook si n√©cessaire
                if (editModal.form.source === 'Facebook' && editModal.form.caracteristiques && editModal.form.caracteristiques.length > 0) {
                    editModal.form.facebookCaracteristiquesFormatees = editModal.form.caracteristiques
                        .map(c => `${c.label} : ${c.value}`)
                        .join('\n');
                }

                // 1. D√©tection du changement d'agence
                const oldAgencyId = editModal.rdv.agenceId;
                const newAgencyId = editModal.form.agenceId;
                const agencyChanged = oldAgencyId !== newAgencyId;

                // On pr√©pare les donn√©es mises √† jour
                const updatedRdvData = { ...editModal.rdv, ...editModal.form };

                // Mise √† jour du prix si l'agence change (optionnel, selon ta logique)
                if (agencyChanged) {
                    const newAgency = agences.value.find(a => a.id === newAgencyId);
                    if (newAgency) { editModal.form.prix = parseFloat(newAgency.prix) || 0; }
                }

                // 2. Sauvegarde en Base de Donn√©es (Firebase)
                await db.collection('rendezvous').doc(editModal.rdv.id).update(editModal.form);

                // 3. GESTION INTELLIGENTE GOOGLE CALENDAR
                if (editModal.rdv.dansAgenda && editModal.rdv.googleCalendarEventId && googleCalendarConnected.value && googleAccessToken.value) {
                    try {
                        if (agencyChanged) {
                            // üö® CAS CRITIQUE : CHANGEMENT D'AGENCE
                            console.log("üîÑ Changement d'agence d√©tect√© : D√©placement du RDV...");

                            // A. On supprime l'√©v√©nement de l'ANCIEN agenda (en utilisant l'ancien ID agence)
                            // On cr√©e un faux objet RDV avec les vieilles infos juste pour la suppression
                            const oldRdvRef = { 
                                ...editModal.rdv, 
                                agenceId: oldAgencyId 
                            };
                            await deleteGoogleCalendarEvent(oldRdvRef);

                            // B. On cr√©e l'√©v√©nement dans le NOUVEL agenda
                            // On s'assure que les donn√©es envoy√©es ont le bon nouvel ID d'agence
                            updatedRdvData.agenceId = newAgencyId; 
                            const newEventResult = await createGoogleCalendarEvent(updatedRdvData);

                            // C. On met √† jour le nouvel ID Google dans la base de donn√©es
                            await db.collection('rendezvous').doc(editModal.rdv.id).update({
                                googleCalendarEventId: newEventResult.id
                            });

                            // D. Mise √† jour locale pour que l'interface soit juste
                            editModal.rdv.googleCalendarEventId = newEventResult.id;
                            console.log("‚úÖ RDV d√©plac√© avec succ√®s vers la nouvelle agence !");

                        } else {
                            // CAS STANDARD : M√™me agence, juste une modif d'heure/nom/etc.
                            await updateGoogleCalendarEvent(updatedRdvData);
                            console.log("‚úÖ RDV mis √† jour (m√™me agence)");
                        }
                    } catch (err) {
                        console.error('Erreur lors de la synchro Google Calendar:', err);
                        alert("‚ö†Ô∏è Donn√©es sauvegard√©es, mais erreur de synchro Google Calendar : " + err.message);
                    }
                }
                
                // Mise √† jour de l'affichage local final
                Object.assign(editModal.rdv, editModal.form);
                editModal.open = false;
            };

            const openHonorCheck = (r) => {
                honorModal.rdv = r;
                honorModal.commercial = '';
                honorModal.error = '';
                // V√©rifier si l'agence a des commerciaux
                const ag = agences.value.find(a => a.id === r.agenceId);
                if(ag && ((ag.commerciaux && ag.commerciaux.length > 0) || (ag.commerciauxDetails && ag.commerciauxDetails.length > 0))) {
                    honorModal.needsCommercial = true;
                } else {
                    honorModal.needsCommercial = false;
                }
                honorModal.open = true;
            };
           const finalizeHonor = async (withMandat) => {
                if(!honorModal.rdv) return;
                
                const r = honorModal.rdv;
                
                // R√©cup√©rer l'agence pour v√©rifier si elle a des commerciaux
                const ag = agences.value.find(a => a.id === r.agenceId);
                const hasCommerciaux = ag && ((ag.commerciaux && ag.commerciaux.length > 0) || (ag.commerciauxDetails && ag.commerciauxDetails.length > 0));
                
                // V√©rifier si un commercial doit √™tre s√©lectionn√©
                if (honorModal.needsCommercial && (!honorModal.commercial || honorModal.commercial.trim() === '')) {
                    honorModal.error = 'Merci de s√©lectionner un commercial ou de choisir "Je ne sais pas"';
                    return;
                }
                
                // R√©initialiser l'erreur
                honorModal.error = '';
                
                // On r√©cup√®re la valeur choisie
                let commercialChoice = honorModal.commercial;
                if (!hasCommerciaux) {
                    commercialChoice = ''; // Pas de commercial si l'agence n'en a pas
                }
                
                // Mise √† jour du RDV (Statut Vert)
                const patch = { statut: 'honore', honorBilling: 'facture', tag: withMandat ? 'OK M' : null };
                await db.collection('rendezvous').doc(r.id).update(patch);
                
                // Mise √† jour locale
                Object.assign(r, patch);
                if(clientModal.rdv && clientModal.rdv.id === r.id) { Object.assign(clientModal.rdv, patch); }
                
                // Cr√©ation transaction (si applicable)
                await createTransactionForRdv(r);
                
                // SYNCHRO BILAN : 
                // Si l'agence a des commerciaux ET que le choix est "Je ne sais pas" ou vide, on envoie TRUE pour forcer le "√Ä traiter"
                // Si l'agence n'a PAS de commerciaux, on va quand m√™me dans le bilan mais sans needsCommercial
                const isUrgent = hasCommerciaux && (commercialChoice === 'Je ne sais pas' || !commercialChoice || commercialChoice.trim() === '');
                await syncRdvToBilan(r, commercialChoice, isUrgent);
                
                launchFireworks();
                honorModal.open = false;
                clientModal.open = false;
            };
            
            // Fonction pour r√©cup√©rer les commerciaux de l'agence du RDV honor√©
            const getHonorCommerciaux = () => {
                if(!honorModal.rdv) return [];
                const ag = agences.value.find(a => a.id === honorModal.rdv.agenceId);
                if(!ag) return [];
                if(ag.commerciauxDetails) return ag.commerciauxDetails.map(c => c.name);
                if(ag.commerciaux) return ag.commerciaux;
                return [];
            };

            // Fonction pour r√©cup√©rer les commerciaux d'une agence
            const getAgencyCommerciaux = (agencyId) => {
                if(!agencyId) return [];
                const ag = agences.value.find(a => a.id === agencyId);
                if(!ag) return [];
                if(ag.commerciauxDetails) return ag.commerciauxDetails.map(c => c.name);
                if(ag.commerciaux) return ag.commerciaux;
                return [];
            };
            
            // Fonction de synchronisation vers le Bilan (VERSION STRICTE : Je ne sais pas = √Ä traiter)
            const syncRdvToBilan = async (rdv, commercial = '', forceNeedsCommercial = false) => {
                try {
                    if (!rdv) return;

                    // 1. On r√©cup√®re l'agence
                    let ag = null;
                    if (rdv.agenceId) {
                        ag = agences.value.find(a => a.id === rdv.agenceId);
                    }
                    if (!ag) {
                        ag = { id: 'sans-agence', nom: 'Ind√©pendant / Hors Agence', prix: 0, commerciaux: [] };
                    }

                    // V√©rifier si l'agence a des commerciaux
                    const hasCommerciaux = (ag.commerciaux && ag.commerciaux.length > 0) || (ag.commerciauxDetails && ag.commerciauxDetails.length > 0);

                    // 2. V√©rification anti-doublon (On ne cr√©e pas deux fois la ligne)
                    const existingRdv = await db.collection('bilan_rdv').where('rdvIds', 'array-contains', rdv.id).get();
                    if (!existingRdv.empty) { 
                        console.log('RDV d√©j√† dans le bilan:', rdv.id); 
                        return; 
                    }
                    
                    console.log('üîÑ Synchronisation RDV vers Bilan:', rdv.id, 'Agence:', ag.nom, 'Commercial:', commercial);

                    // 3. Pr√©paration finances
                    const rdvDate = rdv.date || new Date().toISOString().split('T')[0];
                    const targetMonth = monthKey(rdvDate);
                    
                    // 4. LOGIQUE "√Ä TRAITER" (SECURIT√â TOTALE) - DOIT √äTRE AVANT L'UTILISATION
                    let finalCommercial = commercial;
                    let needsCommercial = forceNeedsCommercial;
                    
                    // Si l'agence a des commerciaux ET que le commercial n'est pas choisi -> "√Ä traiter" avec alerte
                    if (hasCommerciaux && (!finalCommercial || finalCommercial === '' || finalCommercial === 'Je ne sais pas')) {
                        finalCommercial = '√Ä traiter'; // On force ce nom exact
                        needsCommercial = true;        // On active l'alerte
                    } else if (!hasCommerciaux) {
                        // Si l'agence n'a pas de commerciaux, on va dans le bilan avec commercial vide
                        finalCommercial = commercial || ''; // Commercial vide si pas de commerciaux dans l'agence
                        needsCommercial = false; // Pas d'alerte car pas de commercial requis
                    }
                    
                    // 5. V√©rifier si un tarif personnalis√© doit √™tre appliqu√© (apr√®s avoir d√©termin√© finalCommercial)
                    let prix = parseFloat(rdv.prix) || parseFloat(ag.prix) || 0;
                    const tarifPerso = getTarifPersonnalise(ag.id, finalCommercial, targetMonth);
                    if(tarifPerso !== null) {
                        prix = tarifPerso;
                    }
                    
                    const geste = parseFloat(rdv.geste_commercial) || 0;

                    // Si l'agence a des commerciaux ET que le commercial n'est pas choisi -> "√Ä traiter" avec alerte
                    if (hasCommerciaux && (!finalCommercial || finalCommercial === '' || finalCommercial === 'Je ne sais pas')) {
                        finalCommercial = '√Ä traiter'; // On force ce nom exact
                        needsCommercial = true;        // On active l'alerte
                    } else if (!hasCommerciaux) {
                        // Si l'agence n'a pas de commerciaux, on va dans le bilan avec commercial vide
                        finalCommercial = commercial || ''; // Commercial vide si pas de commerciaux dans l'agence
                        needsCommercial = false; // Pas d'alerte car pas de commercial requis
                    }

                    // 5. REGROUPEMENT (On cherche une ligne identique pour l'incr√©menter)
                    const existingLine = await db.collection('bilan_rdv')
                        .where('clientId', '==', ag.id)
                        .where('periodDate', '==', rdvDate)
                        .where('commercial', '==', finalCommercial) // On cherche la ligne '√Ä traiter'
                        .where('reporte', '==', false)
                        .get();

                    if (!existingLine.empty) {
                        // --- MISE √Ä JOUR (On ajoute +1 au compteur) ---
                        const existingDoc = existingLine.docs[0];
                        const existingData = existingDoc.data();
                        
                        const newRdvCount = (existingData.rdv || 0) + 1;
                        const newTotal = existingData.tarif * newRdvCount;
                        const newGeste = (existingData.gesteMontant || 0) + geste;
                        const newNetTotal = newTotal - newGeste;

                        const rdvIds = existingData.rdvIds || [];
                        if (!rdvIds.includes(rdv.id)) rdvIds.push(rdv.id);

                        await db.collection('bilan_rdv').doc(existingDoc.id).update({
                            rdv: newRdvCount,
                            total: newTotal,
                            netTotal: newNetTotal,
                            geste: newGeste > 0,
                            gesteMontant: newGeste,
                            rdvIds: rdvIds,
                            agence: ag.nom,
                            // Si c'est marqu√© "needsCommercial", √ßa reste true
                            needsCommercial: needsCommercial || existingData.needsCommercial || false
                        });
                        console.log('‚úÖ Bilan mis √† jour (ligne existante):', existingDoc.id);

                    } else {
                        // --- CR√âATION (Nouvelle ligne) ---
                        const newDocRef = await db.collection('bilan_rdv').add({
                            rdvId: rdv.id,
                            rdvIds: [rdv.id],
                            clientId: ag.id,
                            agence: ag.nom,
                            tarifPersonnalise: tarifPerso !== null,
                            commercial: finalCommercial, // Sera "√Ä traiter" si doute
                            rdv: 1,
                            tarif: prix,
                            total: prix,
                            netTotal: prix - geste,
                            date: rdvDate,
                            periodDate: rdvDate,
                            periodMonth: targetMonth,
                            reporte: false,
                            geste: geste > 0,
                            gesteMontant: geste,
                            needsCommercial: needsCommercial, // C'est ce true qui met l'alerte 
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        console.log('‚úÖ Nouvelle ligne bilan cr√©√©e:', newDocRef.id);
                    }
                } catch (e) {
                    console.error('‚ùå Erreur synchronisation Bilan:', e, rdv);
                    throw e; // Re-lancer l'erreur pour que l'appelant puisse la g√©rer
                }
            };
            
            const openDiscountModal = () => { discountModal.amount = null; discountModal.reason = ''; discountModal.customReason = ''; discountModal.error = ''; discountModal.open = true; };
            const saveDiscount = async () => {
                discountModal.error = '';
                if (!discountModal.amount && discountModal.amount !== 0) { discountModal.error = "Veuillez entrer un montant."; return; }
                let finalReason = discountModal.reason;
                if (finalReason === 'Autre') finalReason = discountModal.customReason;
                if (!finalReason) { discountModal.error = "Veuillez choisir ou saisir un motif."; return; }
                if (clientModal.rdv) {
                    clientModal.rdv.geste_commercial = discountModal.amount;
                    clientModal.rdv.motif_geste = finalReason;
                    await db.collection('rendezvous').doc(clientModal.rdv.id).update({ geste_commercial: discountModal.amount, motif_geste: finalReason });
                }
                discountModal.open = false;
            };
            const removeDiscount = async () => {
                openCustomConfirm("Supprimer le geste", "Voulez-vous retirer le geste commercial ?", async () => {
                    if (clientModal.rdv) {
                        clientModal.rdv.geste_commercial = null; clientModal.rdv.motif_geste = null;
                        await db.collection('rendezvous').doc(clientModal.rdv.id).update({ geste_commercial: firebase.firestore.FieldValue.delete(), motif_geste: firebase.firestore.FieldValue.delete() });
                        discountModal.open = false; customConfirmModal.open = false;
                    }
                });
            }

            // Fonction pour retirer un RDV du bilan
            const removeRdvFromBilan = async (rdvId) => {
                try {
                    if (!rdvId) return;
                    
                    // Chercher toutes les entr√©es du bilan qui contiennent ce RDV
                    const bilanEntries = await db.collection('bilan_rdv')
                        .where('rdvIds', 'array-contains', rdvId)
                        .get();
                    
                    if (bilanEntries.empty) {
                        // Essayer aussi avec rdvId (ancien format)
                        const oldFormatEntries = await db.collection('bilan_rdv')
                            .where('rdvId', '==', rdvId)
                            .get();
                        
                        if (!oldFormatEntries.empty) {
                            // Supprimer directement les entr√©es avec l'ancien format
                            const batch = db.batch();
                            oldFormatEntries.forEach(doc => {
                                batch.delete(doc.ref);
                            });
                            await batch.commit();
                        }
                        return;
                    }
                    
                    const batch = db.batch();
                    
                    bilanEntries.forEach(doc => {
                        const data = doc.data();
                        const rdvIds = data.rdvIds || [];
                        
                        // Si c'est le seul RDV dans cette ligne, supprimer la ligne compl√®te
                        if (rdvIds.length === 1) {
                            batch.delete(doc.ref);
                        } else {
                            // Sinon, retirer ce RDV de la liste et recalculer
                            const newRdvIds = rdvIds.filter(id => id !== rdvId);
                            const newRdvCount = newRdvIds.length;
                            const newTotal = data.tarif * newRdvCount;
                            
                            // Recalculer le geste commercial (on retire celui du RDV supprim√©)
                            // Note: on ne peut pas facilement r√©cup√©rer le geste du RDV supprim√©,
                            // donc on garde le gesteMontant actuel mais on ajuste le netTotal
                            const gesteMontant = data.gesteMontant || 0;
                            const newNetTotal = Math.max(0, newTotal - gesteMontant);
                            
                            batch.update(doc.ref, {
                                rdvIds: newRdvIds,
                                rdv: newRdvCount,
                                total: newTotal,
                                netTotal: newNetTotal
                            });
                        }
                    });
                    
                    await batch.commit();
                } catch (e) {
                    console.error('Erreur lors de la suppression du RDV du bilan:', e);
                }
            };

            const updateStatus = async (r, s) => { 
                if(s==='honor_fact') { openHonorCheck(r); return; } 
                
                // V√©rifier si le RDV √©tait honor√© avant le changement
                const wasHonored = r.statut === 'honore';
                
                const patch = { statut: s };
                if(s==='honor_free') { patch.statut='honore'; patch.honorBilling='gratuit'; launchFireworks(); } 
                if(s==='noshow') { patch.statut='pas_venu'; patch.honorBilling=null; const today = new Date().toISOString().split('T')[0]; let type = 'noshow'; if(r.date === today) type = 'noshow_today'; const link = generateMsgLink(r, type); if(link) window.open(link, '_blank'); } 
                if(s==='reset') { patch.statut='confirme'; patch.honorBilling=null; patch.motif=null; delete patch.geste_commercial; delete patch.motif_geste; patch.tag = null; } 
                // --- AJOUT : REMETTRE L'AGENDA COMME AVANT ---
                    if (r.dansAgenda && r.googleCalendarEventId) {
                        // On cr√©e une copie propre du RDV avec les nouvelles valeurs (statut confirm√©, plus de motif)
                        const cleanRdv = { ...r, ...patch };
                        // On lance la mise √† jour vers Google (qui va remettre la couleur et le titre d'origine)
                        if (googleCalendarConnected.value || prospecteurGoogleCalendarConnected.value) {
                             updateGoogleCalendarEvent(cleanRdv).then(() => console.log("Agenda r√©tabli (Reset)"));
                        }
                    }
                
                await db.collection('rendezvous').doc(r.id).update(patch); 
                Object.assign(r, patch);
                if(clientModal.rdv && clientModal.rdv.id === r.id) Object.assign(clientModal.rdv, patch);
                
                // Log de l'action
                logAction('changement_statut', {
                    rdvId: r.id,
                    client: `${r.civilite} ${r.nom}`,
                    ancienStatut: r.statut,
                    nouveauStatut: patch.statut,
                    date: r.date,
                    heure: r.heure
                });
                
                // Si le RDV √©tait honor√© et ne l'est plus, supprimer les transactions associ√©es et retirer du bilan
                if(wasHonored && patch.statut !== 'honore') {
                    await deleteTransactionsForRdv(r.id);
                    await removeRdvFromBilan(r.id); // Retirer automatiquement du bilan
                }
                
                // Cr√©er la transaction si le RDV est honor√©
                if(s==='honor_free') {
                    await createTransactionForRdv(r);
                    await checkAndCreateBonusTransactions(r.createdBy);
                    // Synchroniser avec le Bilan (sans commercial car honor_free)
                    await syncRdvToBilan(r, '');
                }
                
                clientModal.open = false; 
            };

            const launchFireworks = () => { for(let i=0; i<50; i++) { const c = document.createElement('div'); c.className = 'confetti'; c.style.left = Math.random() * 100 + 'vw'; c.style.top = -10 + 'px'; c.style.backgroundColor = ['#ff0', '#f00', '#0f0', '#00f', '#f0f'][Math.floor(Math.random()*5)]; c.style.animationDuration = (Math.random() * 2 + 1) + 's'; document.body.appendChild(c); setTimeout(() => c.remove(), 3000); } };

            const openRescheduleModal = async (r) => { 
                // V√©rifier la connexion Google avant d'ouvrir la modal
                if (!isGoogleCalendarConnected.value) {
                    showNotification('‚ö†Ô∏è Vous devez √™tre connect√© √† Google Calendar pour reporter un rendez-vous', 'error', 'fa-exclamation-triangle');
                    // Proposer de se connecter
                    if (user.role === 'admin') {
                        connectGoogleCalendar();
                    } else {
                        handleProspecteurGoogleCalendar();
                    }
                    return;
                }
                rescheduleModal.rdv = r; 
                rescheduleModal.date = r.date; 
                rescheduleModal.heure = r.heure; 
                rescheduleModal.oldDate = r.date; 
                rescheduleModal.oldHeure = r.heure; 
                rescheduleModal.motif = ''; 
                rescheduleModal.motifType = ''; 
                rescheduleModal.demandePar = ''; 
                rescheduleModal.autoSMS = false; 
                rescheduleModal.step = 1; 
                rescheduleModal.open = true; 
            };
            const handleMotifTypeChange = async () => {
                // R√©cup√©rer les textes de motifs depuis les settings globaux
                const rdv = rescheduleModal.rdv;
                let motifTexts = {
                    'meteo_route_dangereuse': 'Le rendez-vous a √©t√© report√© en raison des conditions m√©t√©orologiques (conditions de la route dangereuse : neige, verglas ou forte inondations)',
                    'vehicule_immobilise': 'Le rendez-vous a √©t√© report√© car le v√©hicule ne peut pas bouger',
                    'contrainte_pro': 'Le rendez-vous a √©t√© report√© car le client ne peut pas quitter son poste ou une r√©union de derni√®re minute l\'emp√™che de venir au rendez-vous',
                    'contrainte_personnelle': 'Le rendez-vous a √©t√© report√© car le client ne peut pas se d√©placer pour des raisons personnelles. Nous sommes dans l\'obligation de d√©placer le rendez-vous.',
                    'documents_manquants': 'Le rendez-vous a √©t√© report√© car le client se rend compte qu\'il n\'a pas tous les documents avec lui',
                    'empechement_medical': 'Le rendez-vous a √©t√© report√© pour motif de sant√© : incapacit√© de conduire, maladie soudaine, blessure ou fatigue extr√™me, rendant la conduite dangereuse pour le client',
                    // Motifs internes
                    'agence_fermee': 'Le rendez-vous a √©t√© report√© car notre agence sera ferm√©e ce jour-l√†',
                    'commercial_retard': 'Le rendez-vous a √©t√© report√© car le commercial aura un peu de retard',
                    'agence_retard': 'Le rendez-vous a √©t√© report√© car notre agence aura un peu de retard ce jour-l√†',
                    'intemperie': 'Le rendez-vous a √©t√© report√© en raison des intemp√©ries',
                    'absence_imprevue': 'Le rendez-vous a √©t√© report√© en raison d\'une absence impr√©vue'
                };
                
                // Charger les messages personnalis√©s depuis les settings globaux
                try {
                    const settingsDoc = await db.collection('settings').doc('rescheduleMessages').get();
                    const globalMessages = settingsDoc.exists ? settingsDoc.data() : {};
                    const customMessagesClient = globalMessages.rescheduleSMSMessagesClient || {};
                    const customMessagesInterne = globalMessages.rescheduleSMSMessages || {};
                    
                    // Si un message personnalis√© existe pour ce motif et que c'est une demande client, l'utiliser
                    if (rescheduleModal.demandePar === 'client' && rescheduleModal.motifType && customMessagesClient[rescheduleModal.motifType] && customMessagesClient[rescheduleModal.motifType].trim()) {
                        motifTexts[rescheduleModal.motifType] = customMessagesClient[rescheduleModal.motifType];
                    }
                    
                    // Si c'est une demande interne, charger le label du motif depuis rescheduleMotifsListInterne
                    if (rescheduleModal.demandePar === 'interne' && rescheduleModal.motifType && rescheduleMotifsListInterne[rescheduleModal.motifType]) {
                        // Utiliser le label du motif interne comme texte de motif
                        motifTexts[rescheduleModal.motifType] = `Le rendez-vous a √©t√© report√© : ${rescheduleMotifsListInterne[rescheduleModal.motifType]}`;
                    }
                } catch (err) {
                    console.error('Erreur chargement messages client:', err);
                }
                
                // Messages SMS automatiques pour certains motifs (avec vraies infos)
                const getSMSMessage = async (motifType) => {
                    const rdv = rescheduleModal.rdv;
                    if (!rdv) return '';
                    const ag = agences.value.find(a => a.id === rdv.agenceId) || {};
                    const baseModele = getBaseModele(rdv.modele || '');
                    
                    // Si demande interne : utiliser la date initiale, sinon la nouvelle date
                    let dateStr, heureStr;
                    if (rescheduleModal.demandePar === 'interne') {
                        dateStr = formatDateLong(rdv.date || '');
                        heureStr = rdv.heure || '';
                    } else {
                        dateStr = formatDateLong(rescheduleModal.date || rdv.date || '');
                        heureStr = rescheduleModal.heure || rdv.heure || '';
                    }
                    
                    try {
                        // Charger depuis les settings globaux
                        const settingsDoc = await db.collection('settings').doc('rescheduleMessages').get();
                        const globalMessages = settingsDoc.exists ? settingsDoc.data() : {};
                        
                        if (rescheduleModal.demandePar === 'interne') {
                            const customMessages = globalMessages.rescheduleSMSMessages || {};
                            // V√©rifier d'abord dans les messages personnalis√©s
                            if (customMessages[motifType] && customMessages[motifType].trim()) {
                                return customMessages[motifType]
                                    .replace(/{{DATE_LONG}}/g, dateStr)
                                    .replace(/{{HEURE}}/g, heureStr)
                                    .replace(/{{MODELE}}/g, baseModele)
                                    .replace(/{{AGENCE}}/g, ag.nom || '');
                            }
                            // Sinon utiliser les messages par d√©faut pour motifs internes
                            const defaultMessagesInterne = {
                                'agence_fermee': `Bonjour, nous vous informons que votre rendez-vous pr√©vu le ${dateStr} √† ${heureStr} √† notre agence ${ag.nom || ''} pour votre v√©hicule ${baseModele} doit √™tre report√© car notre agence sera ferm√©e ce jour-l√†. Nous vous contacterons prochainement pour convenir d'une nouvelle date. Merci de votre compr√©hension.`,
                                'commercial_retard': `Bonjour, nous vous informons que votre rendez-vous pr√©vu le ${dateStr} √† ${heureStr} √† notre agence ${ag.nom || ''} pour votre v√©hicule ${baseModele} doit √™tre report√© car le commercial aura un peu de retard. Nous vous contacterons prochainement pour convenir d'une nouvelle date. Merci de votre compr√©hension.`,
                                'agence_retard': `Bonjour, nous vous informons que votre rendez-vous pr√©vu le ${dateStr} √† ${heureStr} √† notre agence ${ag.nom || ''} pour votre v√©hicule ${baseModele} doit √™tre report√© car notre agence aura un peu de retard ce jour-l√†. Nous vous contacterons prochainement pour convenir d'une nouvelle date. Merci de votre compr√©hension.`,
                                'intemperie': `Bonjour, nous vous informons que votre rendez-vous pr√©vu le ${dateStr} √† ${heureStr} √† notre agence ${ag.nom || ''} pour votre v√©hicule ${baseModele} doit √™tre report√© en raison des intemp√©ries. Nous vous contacterons prochainement pour convenir d'une nouvelle date. Merci de votre compr√©hension.`,
                                'absence_imprevue': `Bonjour, nous vous informons que votre rendez-vous pr√©vu le ${dateStr} √† ${heureStr} √† notre agence ${ag.nom || ''} pour votre v√©hicule ${baseModele} doit √™tre report√© en raison d'une absence impr√©vue. Nous vous contacterons prochainement pour convenir d'une nouvelle date. Merci de votre compr√©hension.`
                            };
                            // V√©rifier si c'est un motif interne sp√©cifique
                            if (defaultMessagesInterne[motifType]) {
                                return defaultMessagesInterne[motifType];
                            }
                            // Message par d√©faut g√©n√©rique pour demande interne
                            return `Bonjour, nous vous informons que votre rendez-vous pr√©vu le ${dateStr} √† ${heureStr} √† notre agence ${ag.nom || ''} pour votre v√©hicule ${baseModele} doit √™tre report√©. Nous vous contacterons prochainement pour convenir d'une nouvelle date.`;
                        } else {
                            // √Ä la demande du client : pas de SMS
                            return '';
                        }
                    } catch (err) {
                        console.error('Erreur chargement message:', err);
                        // Fallback sur message par d√©faut
                        if (rescheduleModal.demandePar === 'interne') {
                            return `Bonjour, nous vous informons que votre rendez-vous pr√©vu le ${dateStr} √† ${heureStr} √† notre agence ${ag.nom || ''} pour votre v√©hicule ${baseModele} doit √™tre report√©. Nous vous contacterons prochainement pour convenir d'une nouvelle date.`;
                        }
                        return '';
                    }
                };
                
                if (rescheduleModal.motifType && motifTexts[rescheduleModal.motifType]) {
                    // Utiliser le message personnalis√© pour le motif (pour Google Agenda et la fiche)
                    if (rescheduleModal.demandePar === 'client') {
                        // √Ä la demande du client : utiliser le message configur√© (pas de SMS)
                        rescheduleModal.motif = motifTexts[rescheduleModal.motifType];
                        rescheduleModal.autoSMS = false;
                        rescheduleModal.smsMessage = '';
                    } else {
                        // Demande interne : utiliser le texte d√©taill√© par d√©faut
                        rescheduleModal.motif = motifTexts[rescheduleModal.motifType];
                        // Calculer le message SMS instantan√©ment (synchrone)
                        const rdv = rescheduleModal.rdv;
                        if (rdv) {
                            const ag = agences.value.find(a => a.id === rdv.agenceId) || {};
                            const baseModele = getBaseModele(rdv.modele || '');
                            let dateStr = formatDateLong(rdv.date || '');
                            let heureStr = rdv.heure || '';
                            
                            // Messages par d√©faut pour motifs internes (synchrone)
                            const defaultMessagesInterne = {
                                'agence_fermee': `Bonjour, nous vous informons que votre rendez-vous pr√©vu le ${dateStr} √† ${heureStr} √† notre agence ${ag.nom || ''} pour votre v√©hicule ${baseModele} doit √™tre report√© car notre agence sera ferm√©e ce jour-l√†. Nous vous contacterons prochainement pour convenir d'une nouvelle date. Merci de votre compr√©hension.`,
                                'commercial_retard': `Bonjour, nous vous informons que votre rendez-vous pr√©vu le ${dateStr} √† ${heureStr} √† notre agence ${ag.nom || ''} pour votre v√©hicule ${baseModele} doit √™tre report√© car le commercial aura un peu de retard. Nous vous contacterons prochainement pour convenir d'une nouvelle date. Merci de votre compr√©hension.`,
                                'agence_retard': `Bonjour, nous vous informons que votre rendez-vous pr√©vu le ${dateStr} √† ${heureStr} √† notre agence ${ag.nom || ''} pour votre v√©hicule ${baseModele} doit √™tre report√© car notre agence aura un peu de retard ce jour-l√†. Nous vous contacterons prochainement pour convenir d'une nouvelle date. Merci de votre compr√©hension.`,
                                'intemperie': `Bonjour, nous vous informons que votre rendez-vous pr√©vu le ${dateStr} √† ${heureStr} √† notre agence ${ag.nom || ''} pour votre v√©hicule ${baseModele} doit √™tre report√© en raison des intemp√©ries. Nous vous contacterons prochainement pour convenir d'une nouvelle date. Merci de votre compr√©hension.`,
                                'absence_imprevue': `Bonjour, nous vous informons que votre rendez-vous pr√©vu le ${dateStr} √† ${heureStr} √† notre agence ${ag.nom || ''} pour votre v√©hicule ${baseModele} doit √™tre report√© en raison d'une absence impr√©vue. Nous vous contacterons prochainement pour convenir d'une nouvelle date. Merci de votre compr√©hension.`
                            };
                            
                            // Charger les messages personnalis√©s de fa√ßon asynchrone mais mettre √† jour imm√©diatement avec le d√©faut
                            rescheduleModal.smsMessage = defaultMessagesInterne[rescheduleModal.motifType] || '';
                            rescheduleModal.autoSMS = !!rescheduleModal.smsMessage;
                            
                            // Ensuite charger depuis Firebase si disponible (mise √† jour en arri√®re-plan)
                            getSMSMessage(rescheduleModal.motifType).then(smsMsg => {
                                if (smsMsg && smsMsg.trim()) {
                                    rescheduleModal.smsMessage = smsMsg;
                                }
                            });
                        }
                    }
                } else if (rescheduleModal.motifType === 'autre') {
                    rescheduleModal.motif = '';
                    rescheduleModal.autoSMS = false;
                    rescheduleModal.smsMessage = '';
                }
            };
            
            // Fonction pour s√©lectionner un motif depuis le modal moderne
            const selectMotif = (motifType) => {
                rescheduleModal.motifType = motifType;
                motifSelectionModal.open = false;
                handleMotifTypeChange();
            };
            
            // Fonction pour obtenir le label d'un motif
            const getMotifLabel = (motifType) => {
                // Utiliser les motifs personnalis√©s depuis l'agence si disponibles
                const rdv = rescheduleModal.rdv;
                const demandePar = rescheduleModal.demandePar;
                
                // Si demande interne, utiliser les motifs internes
                if (demandePar === 'interne') {
                    if (rdv) {
                        const ag = agences.value.find(a => a.id === rdv.agenceId);
                        if (ag && ag.rescheduleMotifsListInterne && ag.rescheduleMotifsListInterne[motifType]) {
                            return ag.rescheduleMotifsListInterne[motifType];
                        }
                    }
                    return rescheduleMotifsListInterne[motifType] || 'üìã S√©lectionner un motif...';
                }
                
                // Sinon utiliser les motifs pour demande client
                if (rdv) {
                    const ag = agences.value.find(a => a.id === rdv.agenceId);
                    if (ag && ag.rescheduleMotifsList && ag.rescheduleMotifsList[motifType]) {
                        return ag.rescheduleMotifsList[motifType];
                    }
                }
                return rescheduleMotifsList[motifType] || 'üìã S√©lectionner un motif...';
            };
            const confirmRescheduleStep1 = async () => { 
                if (!rescheduleModal.demandePar) return alert('Veuillez s√©lectionner le type de demande');
                if (rescheduleModal.demandePar === 'client' && (!rescheduleModal.date || !rescheduleModal.heure)) return alert('Date/Heure requises pour un report √† la demande du client'); 
                if(!rescheduleModal.motif || rescheduleModal.motif.trim() === '') {
                    return alert('Le motif du d√©placement est obligatoire');
                }
                
                // Si demande interne, garder la date/heure initiale
                const newDate = rescheduleModal.demandePar === 'interne' ? rescheduleModal.rdv.date : rescheduleModal.date;
                const newHeure = rescheduleModal.demandePar === 'interne' ? rescheduleModal.rdv.heure : rescheduleModal.heure;
                const oldInfo = `Ancien : ${formatDateFr(rescheduleModal.rdv.date)} √† ${rescheduleModal.rdv.heure}`;
                const motifText = rescheduleModal.motif ? ` Motif: ${rescheduleModal.motif}` : '';
                const note = { text: `üìÖ RDV Report√©. ${oldInfo}${motifText}`, author: 'Syst√®me', date: new Date().toISOString() };
                let notes = rescheduleModal.rdv.notes || []; notes.push(note);
                
                // Mettre √† jour le RDV avec le motif de d√©placement
                const updateData = { 
                    date: newDate, 
                    heure: newHeure, 
                    notes: notes, 
                    rappelFait: false,
                    motifDeplacement: rescheduleModal.motif || null,
                    oldDate: rescheduleModal.oldDate,
                    oldHeure: rescheduleModal.oldHeure
                };
                
                await db.collection('rendezvous').doc(rescheduleModal.rdv.id).update(updateData); 
                
                // Mettre √† jour l'objet local
                Object.assign(rescheduleModal.rdv, updateData);
                if(clientModal.rdv && clientModal.rdv.id === rescheduleModal.rdv.id) { 
                    Object.assign(clientModal.rdv, updateData);
                }
                
                // Mettre √† jour l'√©v√©nement Google Calendar si pr√©sent
                if (googleCalendarConnected.value && googleAccessToken.value && rescheduleModal.rdv.dansAgenda && rescheduleModal.rdv.googleCalendarEventId) {
                    try {
                        await updateGoogleCalendarEvent(rescheduleModal.rdv);
                    } catch (err) {
                        console.error('Erreur lors de la mise √† jour Google Calendar:', err);
                    }
                }
                
                rescheduleModal.step = 2; 
            };
            const sendRescheduleSMS = () => {
                // Si un SMS automatique est d√©fini, l'utiliser
                if (rescheduleModal.autoSMS && rescheduleModal.smsMessage) {
                    const smsLink = generateMsgLink(rescheduleModal.rdv, 'reschedule', rescheduleModal.smsMessage);
                    if (smsLink) window.open(smsLink, '_blank');
                } else {
                    const link = generateMsgLink(rescheduleModal.rdv, 'reschedule');
                    if (link) window.open(link, '_blank');
                }
                rescheduleModal.open = false;
                clientModal.open = false;
                rescheduleModal.step = 1;
            };
            const openReschedule = (r) => openRescheduleModal(r);
            
            const changeView = async (v) => { 
                view.value = v; 
                displayLimit.value = 20; 
                if(v !== 'list') { currentFilter.value = 'all'; } 
                selectedIds.value = [];
                
                // Charger les transactions si on acc√®de au portefeuille (prospecteur)
                if (v === 'portefeuille' && user.role !== 'admin' && user.name) {
                    await loadUserTransactions();
                }
            };
            
            const loadUserTransactions = async () => {
                try {
                    // D√©truire l'ancien listener s'il existe
                    if (transactionListener) {
                        transactionListener();
                        transactionListener = null;
                    }
                    
                    // Cr√©er les transactions manquantes pour les RDV d√©j√† honor√©s
                    await createMissingTransactionsForUser(user.name);
                    
                    // Charger d'abord les transactions une fois pour avoir les donn√©es imm√©diatement
                try {
                    const transSnapshot = await db.collection('transactions')
                        .where('userId', '==', user.name)
                        .get();
                    
                    transactions.value = transSnapshot.docs.map(doc => {
                        const data = doc.data();
                        return {
                            id: doc.id,
                            ...data,
                            date: data.date && data.date.toDate ? data.date.toDate() : (data.date ? new Date(data.date) : new Date())
                        };
                        });
                        
                        // Trier par date d√©croissante
                        transactions.value.sort((a, b) => {
                            const dateA = a.date instanceof Date ? a.date.getTime() : new Date(a.date).getTime();
                            const dateB = b.date instanceof Date ? b.date.getTime() : new Date(b.date).getTime();
                            return dateB - dateA;
                        });
                    } catch (loadErr) {
                        console.error('Erreur chargement initial transactions:', loadErr);
                    }
                    
                    // Cr√©er un listener en temps r√©el pour les transactions (sans orderBy pour √©viter les probl√®mes d'index)
                    const query = db.collection('transactions')
                        .where('userId', '==', user.name);
                    
                    transactionListener = query.onSnapshot(snap => {
                        const newTransactions = snap.docs.map(doc => {
                            const data = doc.data();
                            return {
                                id: doc.id,
                                ...data,
                                date: data.date && data.date.toDate ? data.date.toDate() : (data.date ? new Date(data.date) : new Date())
                            };
                        });
                        
                        // Trier par date d√©croissante
                        newTransactions.sort((a, b) => {
                            const dateA = a.date instanceof Date ? a.date.getTime() : new Date(a.date).getTime();
                            const dateB = b.date instanceof Date ? b.date.getTime() : new Date(b.date).getTime();
                            return dateB - dateA;
                        });
                        
                        transactions.value = newTransactions;
                    }, err => {
                        console.error('Erreur listener transactions:', err);
                        // En cas d'erreur, recharger une fois
                        db.collection('transactions')
                            .where('userId', '==', user.name)
                            .get()
                            .then(transSnapshot => {
                                transactions.value = transSnapshot.docs.map(doc => {
                                    const data = doc.data();
                                    return {
                                        id: doc.id,
                                        ...data,
                                        date: data.date && data.date.toDate ? data.date.toDate() : (data.date ? new Date(data.date) : new Date())
                                    };
                                });
                                transactions.value.sort((a, b) => {
                                    const dateA = a.date instanceof Date ? a.date.getTime() : new Date(a.date).getTime();
                                    const dateB = b.date instanceof Date ? b.date.getTime() : new Date(b.date).getTime();
                                    return dateB - dateA;
                                });
                            });
                    });
                } catch (err) {
                    console.error('Erreur chargement transactions utilisateur:', err);
                    transactions.value = [];
                }
            };

            // Cr√©er les transactions manquantes pour les RDV honor√©s qui n'ont pas encore de transaction
            const createMissingTransactionsForUser = async (userId) => {
                try {
                    // R√©cup√©rer tous les RDV honor√©s de cet utilisateur
                    const honoredRdvs = rdvList.value.filter(r => 
                        r.statut === 'honore' && r.createdBy === userId
                    );
                    
                    if (honoredRdvs.length === 0) return;
                    
                    // R√©cup√©rer toutes les transactions existantes pour cet utilisateur
                    const existingTrans = await db.collection('transactions')
                        .where('userId', '==', userId)
                        .get();
                    
                    const existingRdvIds = new Set();
                    existingTrans.docs.forEach(doc => {
                        const data = doc.data();
                        if (data.rdvId && data.type === 'rdv_honore') {
                            existingRdvIds.add(data.rdvId);
                        }
                    });
                    
                    // Cr√©er les transactions manquantes
                    const transactionsToCreate = [];
                    
                    const basePrice = parseFloat(globalCommission.base) || 10;
                    
                    for (const rdv of honoredRdvs) {
                        if (existingRdvIds.has(rdv.id)) continue;
                        
                        const transactionData = {
                            userId: userId,
                            type: 'rdv_honore',
                            amount: basePrice,
                            label: `RDV honor√© - ${rdv.civilite} ${rdv.nom}${rdv.tag === 'OK M' ? ' (OK M)' : ''}`,
                            date: rdv.date ? new Date(rdv.date) : new Date(),
                            rdvId: rdv.id,
                            agenceId: rdv.agenceId || null,
                            hidden: false,
                            createdAt: new Date()
                        };
                        
                        transactionsToCreate.push(transactionData);
                    }
                    
                    // Cr√©er les transactions par batch de 500
                    if (transactionsToCreate.length > 0) {
                        for (let i = 0; i < transactionsToCreate.length; i += 500) {
                            const batch = db.batch();
                            const batchData = transactionsToCreate.slice(i, i + 500);
                            
                            batchData.forEach(transactionData => {
                                const transactionRef = db.collection('transactions').doc();
                                batch.set(transactionRef, transactionData);
                            });
                            
                            await batch.commit();
                        }
                    }
                    
                    // V√©rifier et cr√©er les transactions de bonus apr√®s avoir cr√©√© les transactions RDV
                    await checkAndCreateBonusTransactions(userId);
                } catch (err) {
                    console.error('Erreur cr√©ation transactions manquantes:', err);
                }
            };
            const resetListFilters = () => { search.value = ''; listFilters.agenceId = ''; listFilters.date = ''; listFilters.prospecteur = ''; currentFilter.value = 'all'; displayLimit.value=20; };
            const showUpcoming = () => { currentFilter.value = 'upcoming'; view.value = 'list'; displayLimit.value=20; fromDashboard.value = true; };
            const showLive = () => { currentFilter.value = 'live'; view.value = 'list'; displayLimit.value=20; fromDashboard.value = true; };
            const showHonored = () => { currentFilter.value = 'honored'; view.value = 'list'; displayLimit.value=20; fromDashboard.value = true; };
            const showNoShow = () => { currentFilter.value = 'noshow'; view.value = 'list'; displayLimit.value=20; fromDashboard.value = true; };
            const showCancelled = () => { currentFilter.value = 'cancelled'; view.value = 'list'; displayLimit.value=20; fromDashboard.value = true; };
            const goBackFromList = () => { if (fromDashboard.value) { view.value = 'dashboard'; fromDashboard.value = false; resetListFilters(); } else { resetListFilters(); } };

            const filteredAgences = computed(() => { 
                let source = visibleAgencies.value;
                // Ne pas filtrer les agences ferm√©es, on veut les afficher avec un message
                if(!agencySearch.value) return source; 
                const s = agencySearch.value.toLowerCase(); 
                return source.filter(ag => ag.nom.toLowerCase().includes(s)); 
            });
            const trashList = computed(() => rdvList.value.filter(r => r.statut === 'poubelle'));
            const trashCount = computed(() => trashList.value.length);
            const restoreRdv = (r) => { selectedIds.value = [r.id]; openBulkConfirm('restore_trash', 'Restaurer ce rendez-vous ?'); };
            const hardDeleteRdv = (r) => { selectedIds.value = [r.id]; openBulkConfirm('delete_trash', 'Supprimer D√âFINITIVEMENT ce rendez-vous ? (Irr√©versible)'); };

            const isEnCours = (r) => { if(!r.date || !r.heure) return false; const start = new Date(r.date+'T'+r.heure); const end = new Date(start.getTime() + 60*60*1000); return now.value >= start && now.value < end && ['confirme','a_confirmer'].includes(r.statut); };
            const activeRdvCount = computed(() => rdvList.value.filter(r => isEnCours(r)).length);

            const filteredList = computed(() => { 
                let l = rdvList.value.filter(r => r.statut !== 'poubelle'); 
                if (listFilters.agenceId) l = l.filter(r => r.agenceId === listFilters.agenceId);
                if (listFilters.prospecteur) l = l.filter(r => r.createdBy === listFilters.prospecteur);
                if (listFilters.date) l = l.filter(r => r.date === listFilters.date);
                if (currentFilter.value === 'upcoming') { if (!listFilters.date) { const today = new Date().toISOString().split('T')[0]; l = l.filter(r => r.statut === 'confirme' && r.date >= today); } } 
                else if (currentFilter.value === 'live') l = l.filter(r => isEnCours(r));
                else if (currentFilter.value === 'honored') {
                    l = l.filter(r => r.statut === 'honore');
                    // Filtrer par mois actuel par d√©faut (utiliser les filtres du dashboard si on vient du dashboard)
                    const moisFilter = fromDashboard.value && dashboardFilters.mois ? dashboardFilters.mois : null;
                    const anneeFilter = fromDashboard.value && dashboardFilters.annee ? dashboardFilters.annee : null;
                    if (!listFilters.date) {
                        // Si on vient du dashboard, utiliser ses filtres, sinon utiliser le mois/ann√©e actuels
                        const targetDate = new Date();
                        const targetMonth = moisFilter ? parseInt(moisFilter) - 1 : targetDate.getMonth();
                        const targetYear = anneeFilter ? parseInt(anneeFilter) : targetDate.getFullYear();
                        l = l.filter(r => {
                            if (!r.date) return false;
                            const d = new Date(r.date);
                            return d.getMonth() === targetMonth && d.getFullYear() === targetYear;
                        });
                    }
                }
                else if (currentFilter.value === 'noshow') l = l.filter(r => r.statut === 'pas_venu');
                else if (currentFilter.value === 'cancelled') l = l.filter(r => r.statut === 'annule');
                if (search.value) { const s = search.value.toLowerCase(); const sDigits = normalizePhone(search.value); l = l.filter(r => (r.nom || '').toLowerCase().includes(s) || (r.modele || '').toLowerCase().includes(s) || (sDigits && normalizePhone(r.telephone).includes(sDigits))); } 
                const noBaseFilter = currentFilter.value === 'all' && !listFilters.agenceId && !listFilters.prospecteur && !listFilters.date && !search.value;
                if (noBaseFilter) return [];
                return l.sort((a, b) => { if (a.date !== b.date) return a.date.localeCompare(b.date); return (a.heure || '').localeCompare(b.heure || ''); });
            });
            const displayedList = computed(() => filteredList.value.slice(0, displayLimit.value));

            const allProspectors = computed(() => { const activeTeam = teamList.value.map(u => u.name); const admins = adminNamesList.value; return Array.from(new Set([...activeTeam, ...admins])).sort(); });
            
            // Filtrer uniquement les prospecteurs (sans les admins)
            const onlyProspectors = computed(() => {
                return teamList.value.filter(u => {
                    const isAdminName = adminNamesList.value.includes(u.name);
                    const isAdminRole = u.role === 'admin';
                    return !isAdminName && !isAdminRole;
                });
            });
            
            // Computed pour les commerciaux d'une agence dans le modal RDV rapide
            const quickRdvCommerciaux = computed(() => {
                if (!quickRdvModal.agenceId) return [];
                const ag = agences.value.find(a => a.id === quickRdvModal.agenceId);
                if (!ag) return [];
                
                // R√©cup√©rer les commerciaux depuis teamList
                const teamCommerciaux = teamList.value.filter(u => 
                    u.role === 'commercial' && 
                    (u.agenceId === quickRdvModal.agenceId || 
                     (u.assignedAgencies && u.assignedAgencies.includes(quickRdvModal.agenceId)))
                );
                
                // R√©cup√©rer les commerciaux depuis les r√©glages de l'agence
                const settingsCommerciaux = [];
                if (ag.commerciauxDetails && ag.commerciauxDetails.length > 0) {
                    // Si commerciauxDetails existe, utiliser les noms
                    ag.commerciauxDetails.forEach(c => {
                        const commercialName = typeof c === 'string' ? c : c.name;
                        // V√©rifier si ce commercial n'est pas d√©j√† dans teamCommerciaux
                        if (!teamCommerciaux.find(tc => tc.name === commercialName)) {
                            settingsCommerciaux.push({
                                id: `setting_${commercialName.replace(/\s+/g, '_')}`,
                                name: commercialName
                            });
                        }
                    });
                } else if (ag.commerciaux && ag.commerciaux.length > 0) {
                    // Si commerciaux existe (tableau de strings)
                    ag.commerciaux.forEach(commercialName => {
                        // V√©rifier si ce commercial n'est pas d√©j√† dans teamCommerciaux
                        if (!teamCommerciaux.find(tc => tc.name === commercialName)) {
                            settingsCommerciaux.push({
                                id: `setting_${commercialName.replace(/\s+/g, '_')}`,
                                name: commercialName
                            });
                        }
                    });
                }
                
                // Combiner les deux listes
                return [...teamCommerciaux, ...settingsCommerciaux];
            });
            
            const quickRdvHasCommerciaux = computed(() => {
                if (!quickRdvModal.agenceId) return false;
                const ag = agences.value.find(a => a.id === quickRdvModal.agenceId);
                if (!ag) return false;
                // V√©rifier si l'agence a des commerciaux dans ses settings
                const hasCommerciauxInSettings = (ag.commerciaux && ag.commerciaux.length > 0) || (ag.commerciauxDetails && ag.commerciauxDetails.length > 0);
                // V√©rifier aussi dans teamList
                const hasCommerciauxInTeam = quickRdvCommerciaux.value.length > 0;
                return hasCommerciauxInSettings || hasCommerciauxInTeam;
            });
            const selectAll = (e) => { const list = view.value === 'trash' ? trashList.value : filteredList.value; if(e.target.checked) { selectedIds.value = list.map(r => r.id); } else { selectedIds.value = []; } };
            const toggleSelection = (id) => { if(selectedIds.value.includes(id)) { selectedIds.value = selectedIds.value.filter(i => i !== id); } else { selectedIds.value.push(id); } };
            const isAllSelected = computed(() => { const list = view.value === 'trash' ? trashList.value : filteredList.value; return list.length > 0 && selectedIds.value.length === list.length; });

            const openBulkConfirm = (action, label) => { bulkModal.action = action; bulkModal.label = label; bulkModal.open = true; };
            const openCustomConfirm = (title, message, onConfirm) => { customConfirmModal.title = title; customConfirmModal.message = message; customConfirmModal.onConfirm = onConfirm; customConfirmModal.open = true; };
            const executeBulkAction = async () => {
                const batch = db.batch();
                if (bulkModal.action === 'soft_delete') { 
                    // Capturer les IDs √† supprimer
                    const idsToDelete = [...selectedIds.value];
                    
                    // Vider selectedIds.value IMM√âDIATEMENT
                    selectedIds.value = [];
                    
                    // Fermer la modale IMM√âDIATEMENT
                    bulkModal.open = false;
                    
                    // Mettre √† jour la liste locale IMM√âDIATEMENT (changer le statut visuellement)
                    idsToDelete.forEach(id => {
                        const rdv = rdvList.value.find(r => r.id === id);
                        if(rdv) {
                            rdv.statut = 'poubelle';
                            rdv.dansAgenda = false;
                            rdv.googleCalendarEventId = null;
                        }
                    });
                    
                    // Effectuer ensuite la suppression Firebase
                    idsToDelete.forEach(id => { 
                        const ref = db.collection('rendezvous').doc(id); 
                        
                        // --- AJOUT : SUPPRESSION AUTOMATIQUE DE GOOGLE AGENDA ---
                        // On retrouve le RDV complet dans la liste pour avoir son ID Google
                        const rdvToDelete = rdvList.value.find(r => r.id === id);
                        
                        if (rdvToDelete && rdvToDelete.dansAgenda && rdvToDelete.googleCalendarEventId) {
                            // On lance la suppression Google
                            if (googleCalendarConnected.value || prospecteurGoogleCalendarConnected.value) {
                                deleteGoogleCalendarEvent(rdvToDelete).catch(err => console.error(err));
                            }
                            // On met √† jour la base pour dire qu'il n'est plus dans l'agenda
                            batch.update(ref, { statut: 'poubelle', dansAgenda: false, googleCalendarEventId: null }); 
                        } else {
                            // Si pas dans l'agenda, on met juste √† la poubelle
                        batch.update(ref, { statut: 'poubelle' }); 
                        }
                        // --------------------------------------------------------
                    }); 
                    await batch.commit();
                    
                    // Retirer du bilan tous les RDV supprim√©s
                    for (const id of idsToDelete) {
                        await removeRdvFromBilan(id);
                    }
                }
                else if (bulkModal.action === 'restore_selection' || bulkModal.action === 'restore_trash') { 
                    selectedIds.value.forEach(id => { 
                        const ref = db.collection('rendezvous').doc(id); 
                        batch.update(ref, { statut: 'confirme' }); 
                    }); 
                    await batch.commit();
                }
                else if (bulkModal.action === 'delete_selection' || bulkModal.action === 'delete_trash') { 
                    // 1. Capturer les IDs √† supprimer dans une constante
                    const idsToDelete = [...selectedIds.value];
                    
                    // 2. Vider selectedIds.value IMM√âDIATEMENT
                    selectedIds.value = [];
                    
                    // 3. Fermer la modale IMM√âDIATEMENT
                    bulkModal.open = false;
                    
                    // 4. Mettre √† jour la liste locale IMM√âDIATEMENT (retirer visuellement)
                    rdvList.value = rdvList.value.filter(r => !idsToDelete.includes(r.id));
                    
                    // 5. Effectuer ensuite la boucle de suppression Firebase (Bilan, Google Calendar et Firestore)
                    // Retirer du bilan avant de supprimer d√©finitivement
                    for (const id of idsToDelete) {
                        await removeRdvFromBilan(id);
                    }
                    // Supprimer les √©v√©nements Google Calendar avant de supprimer les RDV
                    if (googleCalendarConnected.value && googleAccessToken.value) {
                        for (const id of idsToDelete) {
                            const rdv = rdvList.value.find(r => r.id === id);
                            if (rdv && rdv.dansAgenda && rdv.googleCalendarEventId) {
                                try {
                                    await deleteGoogleCalendarEvent(rdv);
                                } catch (err) {
                                    console.error('Erreur suppression Google Calendar:', err);
                                }
                            }
                        }
                    }
                    // Supprimer de Firestore
                    idsToDelete.forEach(id => { 
                        const ref = db.collection('rendezvous').doc(id); 
                        batch.delete(ref); 
                    }); 
                    await batch.commit();
                }
                else if (bulkModal.action === 'empty_trash') { 
                    // Capturer les IDs √† supprimer
                    const idsToDelete = trashList.value.map(r => r.id);
                    
                    // Fermer la modale IMM√âDIATEMENT
                    bulkModal.open = false;
                    
                    // Mettre √† jour la liste locale IMM√âDIATEMENT (retirer visuellement)
                    rdvList.value = rdvList.value.filter(r => !idsToDelete.includes(r.id));
                    
                    // Effectuer ensuite la suppression Firebase
                    // Retirer du bilan avant de vider la corbeille
                    for (const id of idsToDelete) {
                        const r = trashList.value.find(rdv => rdv.id === id);
                        if(r) {
                            await removeRdvFromBilan(r.id);
                        }
                    }
                    // Supprimer les √©v√©nements Google Calendar avant de vider la corbeille
                    if (googleCalendarConnected.value && googleAccessToken.value) {
                        for (const r of trashList.value) {
                            if (r.dansAgenda && r.googleCalendarEventId) {
                                try {
                                    await deleteGoogleCalendarEvent(r);
                                } catch (err) {
                                    console.error('Erreur suppression Google Calendar:', err);
                                }
                            }
                        }
                    }
                    // Supprimer de Firestore
                    trashList.value.forEach(r => { 
                        const ref = db.collection('rendezvous').doc(r.id); 
                        batch.delete(ref); 
                    }); 
                    await batch.commit();
                }
                else { 
                    let patch = {}; 
                    if (bulkModal.action === 'honor_fact') { 
                        patch = { statut: 'honore', honorBilling: 'facture' }; 
                    } else if (bulkModal.action === 'noshow') { 
                        patch = { statut: 'pas_venu', honorBilling: null }; 
                    } 
                    if(Object.keys(patch).length > 0) { 
                        // Retirer du bilan les RDV qui √©taient honor√©s et ne le sont plus
                        if (bulkModal.action === 'noshow') {
                            for (const id of selectedIds.value) {
                                const rdv = rdvList.value.find(r => r.id === id);
                                if (rdv && rdv.statut === 'honore') {
                                    await removeRdvFromBilan(id);
                                }
                            }
                        }
                        selectedIds.value.forEach(id => { 
                            const ref = db.collection('rendezvous').doc(id); 
                            batch.update(ref, patch); 
                        }); 
                    } 
                    await batch.commit();
                }
                
                // Cr√©er les transactions pour les RDV honor√©s en masse
                if (bulkModal.action === 'honor_fact') {
                    for (const id of selectedIds.value) {
                        const rdv = rdvList.value.find(r => r.id === id);
                        if (rdv) {
                            await createTransactionForRdv(rdv);
                        }
                    }
                }
                
                // Ne pas vider selectedIds ici car c'est d√©j√† fait dans chaque bloc de suppression
                // bulkModal.open est aussi d√©j√† ferm√© dans chaque bloc
                // S'assurer que selectedIds est vide si on arrive ici et que la modale n'a pas √©t√© ferm√©e
                if(selectedIds.value.length > 0 && bulkModal.action !== 'delete_selection' && bulkModal.action !== 'delete_trash' && bulkModal.action !== 'soft_delete' && bulkModal.action !== 'empty_trash') {
                    selectedIds.value = [];
                }
                // Fermer la modale si elle n'a pas √©t√© ferm√©e dans le bloc sp√©cifique
                if(bulkModal.open && (bulkModal.action === 'restore_selection' || bulkModal.action === 'restore_trash' || bulkModal.action === 'honor_fact' || bulkModal.action === 'noshow')) {
                    bulkModal.open = false;
                }
            };

            const formatDateFr = (d) => d ? new Date(d).toLocaleDateString('fr-FR') : '';
            const formatDateShort = (d) => d ? new Date(d).toLocaleDateString('fr-FR', {day:'numeric', month:'short'}) : '';
            const formatDateLong = (d) => d ? new Date(d).toLocaleDateString('fr-FR', {weekday:'long', day:'numeric', month:'long'}) : '';
            const formatPrice = (p) => new Intl.NumberFormat('fr-FR', {style:'currency', currency:'EUR'}).format(p);
            
            // Fonction pour formater le prix avec des espaces et d√©cimales (ex: 1111111 -> 1 111 111,00)
            const formatPrixInput = (e) => {
                let value = e.target.value;
                
                // Enlever tous les espaces existants
                value = value.replace(/\s/g, '');
                
                // Remplacer les points par des virgules (format fran√ßais)
                value = value.replace(/\./g, ',');
                
                // Garder seulement les chiffres et virgules
                value = value.replace(/[^\d,]/g, '');
                
                // S'assurer qu'il n'y a qu'une seule virgule
                const parts = value.split(',');
                if (parts.length > 2) {
                    value = parts[0] + ',' + parts.slice(1).join('');
                }
                
                // Si la valeur est vide ou juste une virgule
                if (!value || value === ',') {
                    form.prix = null;
                    e.target.value = '';
                    return;
                }
                
                // Limiter √† 2 d√©cimales apr√®s la virgule
                let partsForFormat = value.split(',');
                if (partsForFormat.length === 2 && partsForFormat[1].length > 2) {
                    value = partsForFormat[0] + ',' + partsForFormat[1].substring(0, 2);
                    partsForFormat = value.split(',');
                }
                
                // Convertir en nombre (remplacer virgule par point pour parseFloat)
                const numValue = parseFloat(value.replace(',', '.')) || 0;
                if (numValue < 0 || isNaN(numValue)) {
                    form.prix = null;
                    e.target.value = '';
                    return;
                }
                
                // Formater avec des espaces pour les milliers et virgule pour les d√©cimales
                const integerPart = partsForFormat[0] || '0';
                let decimalPart = partsForFormat[1] || '';
                
                // Si l'utilisateur est en train de taper (pas de virgule encore), ne pas ajouter ,00
                if (!value.includes(',')) {
                    const formatted = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
                    form.prix = numValue;
                    e.target.value = formatted;
                    return;
                }
                
                // Si on a une virgule, formater avec les d√©cimales
                if (decimalPart.length === 0) {
                    decimalPart = '00';
                } else if (decimalPart.length === 1) {
                    decimalPart = decimalPart + '0';
                } else {
                    decimalPart = decimalPart.substring(0, 2);
                }
                
                const formatted = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ' ') + ',' + decimalPart;
                
                form.prix = numValue;
                e.target.value = formatted;
            };
            
            // Fonction pour g√©rer le collage dans le champ prix
            const handlePrixPaste = (e) => {
                e.preventDefault();
                const pastedText = (e.clipboardData || window.clipboardData).getData('text');
                
                // Nettoyer le texte coll√©
                let cleaned = pastedText.replace(/\s/g, ''); // Enlever les espaces
                cleaned = cleaned.replace(/‚Ç¨/g, ''); // Enlever le symbole ‚Ç¨
                cleaned = cleaned.replace(/EUR/g, ''); // Enlever EUR
                cleaned = cleaned.replace(/euros?/gi, ''); // Enlever "euro" ou "euros"
                
                // Remplacer les points par des virgules (format fran√ßais)
                cleaned = cleaned.replace(/\./g, ',');
                
                // Garder seulement les chiffres et virgules
                cleaned = cleaned.replace(/[^\d,]/g, '');
                
                // S'assurer qu'il n'y a qu'une seule virgule
                let parts = cleaned.split(',');
                if (parts.length > 2) {
                    cleaned = parts[0] + ',' + parts.slice(1).join('');
                    parts = cleaned.split(',');
                }
                
                if (!cleaned || cleaned === ',') {
                    form.prix = null;
                    e.target.value = '';
                    return;
                }
                
                // Limiter √† 2 d√©cimales apr√®s la virgule
                if (parts.length === 2 && parts[1].length > 2) {
                    cleaned = parts[0] + ',' + parts[1].substring(0, 2);
                    parts = cleaned.split(',');
                }
                
                // Convertir en nombre
                const numValue = parseFloat(cleaned.replace(',', '.')) || 0;
                if (numValue < 0 || isNaN(numValue)) {
                    form.prix = null;
                    e.target.value = '';
                    return;
                }
                
                // Formater avec des espaces pour les milliers et virgule pour les d√©cimales
                const integerPart = parts[0] || '0';
                let decimalPart = parts[1] || '00';
                
                // Si pas de d√©cimales, ajouter ,00
                if (parts.length === 1) {
                    decimalPart = '00';
                } else if (decimalPart.length === 0) {
                    decimalPart = '00';
                } else if (decimalPart.length === 1) {
                    decimalPart = decimalPart + '0';
                } else {
                    decimalPart = decimalPart.substring(0, 2);
                }
                
                const formatted = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ' ') + ',' + decimalPart;
                
                form.prix = numValue;
                e.target.value = formatted;
            };
            
            // Fonction pour formater le nom du v√©hicule (premi√®re lettre en majuscule, acronymes en majuscules)
            const formatModeleName = (text) => {
                if (!text) return '';
                // Mettre tout en majuscules
                return text.toUpperCase();
            };
            
            // Helper pour convertir les timestamps Firestore en Date
            const getCreatedDate = (rdv) => {
                if (!rdv || !rdv.created) return null;
                try {
                    let date = null;
                    if (rdv.created && typeof rdv.created.toDate === 'function') {
                        date = rdv.created.toDate();
                    } else if (rdv.created && rdv.created.seconds) {
                        date = new Date(rdv.created.seconds * 1000);
                    } else if (rdv.created) {
                        date = new Date(rdv.created);
                    }
                    // V√©rifier que la date est valide
                    if (date && !isNaN(date.getTime())) {
                        return date;
                    }
                } catch (e) {
                    console.error('Erreur conversion date:', e);
                }
                return null;
            };
            
            const getCreatedTime = (rdv) => {
                const date = getCreatedDate(rdv);
                if (!date) return '';
                try {
                    return date.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});
                } catch (e) {
                    return '';
                }
            };
            const getAgenceName = (id) => agences.value.find(a=>a.id===id)?.nom || 'Inconnue';
            // Fonction pour obtenir le prix de l'agence (utilise le prix de l'agence, pas celui du RDV)
            const getAgencePrice = (rdv) => {
                if (!rdv || !rdv.agenceId) return 0;
                const agence = agences.value.find(a => a.id === rdv.agenceId);
                return agence ? parseFloat(agence.prix) || 0 : 0;
            };
            const getRappelType = (r) => { if (!r.date) return 'rappel'; const today = new Date(); today.setHours(0,0,0,0); const d = new Date(r.date); d.setHours(0,0,0,0); const diffDays = Math.round((d - today) / 86400000); if (diffDays === 0) return 'rappel_today'; return 'rappel'; };
            const getRappelLabel = (r) => { const type = getRappelType(r); if(type === 'rappel_today') return 'Rappel Aujourd\'hui'; return 'Rappel Demain'; };
            
            // Fonction pour d√©tecter les p√©riodes de f√™tes et retourner un message appropri√©
            const getFeteMessage = () => {
                const now = new Date();
                const month = now.getMonth() + 1; // 1-12
                const day = now.getDate();
                const year = now.getFullYear();
                
                // Nouvel An (tout le mois de janvier)
                if(month === 1) {
                    return "üéâ Bonne ann√©e ! üéâ\n\n";
                }
                
                // Saint-Valentin (14 f√©vrier)
                if(month === 2 && day === 14) {
                    return "üíù Joyeuse Saint-Valentin ! üíù\n\n";
                }
                
                // P√¢ques (calcul approximatif : premier dimanche apr√®s la premi√®re pleine lune apr√®s l'√©quinoxe de printemps)
                // Pour simplifier, on prend g√©n√©ralement entre fin mars et fin avril
                // Approximation : entre le 22 mars et le 25 avril
                const easterDate = getEasterDate(year);
                const easterDay = easterDate.getDate();
                const easterMonth = easterDate.getMonth() + 1;
                if(month === easterMonth && day >= easterDay && day <= easterDay + 7) {
                    return "üê∞ Joyeuses P√¢ques ! üê∞\n\n";
                }
                
                // F√™te du Travail (1er mai)
                if(month === 5 && day === 1) {
                    return "üåπ Bon 1er mai ! üåπ\n\n";
                }
                
                // F√™te des M√®res (approximation : dernier dimanche de mai ou premier dimanche de juin)
                // Pour simplifier, on prend la p√©riode autour du 1er juin
                if(month === 6 && day >= 1 && day <= 7) {
                    return "üíê Joyeuse f√™te des M√®res ! üíê\n\n";
                }
                
                // F√™te des P√®res (approximation : troisi√®me dimanche de juin)
                if(month === 6 && day >= 15 && day <= 21) {
                    return "üëî Joyeuse f√™te des P√®res ! üëî\n\n";
                }
                
                // F√™te Nationale (14 juillet)
                if(month === 7 && day === 14) {
                    return "üá´üá∑ Bonne f√™te nationale ! üá´üá∑\n\n";
                }
                
                // Assomption (15 ao√ªt)
                if(month === 8 && day === 15) {
                    return "üôè Bonne f√™te de l'Assomption ! üôè\n\n";
                }
                
                // Toussaint (1er novembre)
                if(month === 11 && day === 1) {
                    return "üïØÔ∏è Bonne Toussaint ! üïØÔ∏è\n\n";
                }
                
                // Armistice (11 novembre)
                if(month === 11 && day === 11) {
                    return "üá´üá∑ Jour du Souvenir üá´üá∑\n\n";
                }
                
                // No√´l (24-26 d√©cembre)
                if(month === 12 && day >= 24 && day <= 26) {
                    return "üéÑ Joyeux No√´l ! üéÑ\n\n";
                }
                
                // Nouvel An (31 d√©cembre)
                if(month === 12 && day === 31) {
                    return "üéä Bonne ann√©e ! üéä\n\n";
                }
                
                return '';
            };
            
            // Fonction pour calculer la date de P√¢ques (algorithme de Gauss)
            const getEasterDate = (year) => {
                const a = year % 19;
                const b = Math.floor(year / 100);
                const c = year % 100;
                const d = Math.floor(b / 4);
                const e = b % 4;
                const f = Math.floor((b + 8) / 25);
                const g = Math.floor((b - f + 1) / 3);
                const h = (19 * a + b - d - g + 15) % 30;
                const i = Math.floor(c / 4);
                const k = c % 4;
                const l = (32 + 2 * e + 2 * i - h - k) % 7;
                const m = Math.floor((a + 11 * h + 22 * l) / 451);
                const month = Math.floor((h + l - 7 * m + 114) / 31);
                const day = ((h + l - 7 * m + 114) % 31) + 1;
                return new Date(year, month - 1, day);
            };
            
            const generateMsgLink = (data, type, customMessage = null) => {
                // 1. On r√©cup√®re l'agence concern√©e
                const ag = agences.value.find(a => a.id === data.agenceId) || data.agence || {};
                
                // 2. On r√©cup√®re vos mod√®les personnalis√©s (depuis R√©glages > Messages)
                const tpls = ag.templates || {}; 
                
                // 3. Si un message personnalis√© est fourni, l'utiliser directement
                let tpl = customMessage;
                
                // 4. Sinon, on essaie de trouver le message personnalis√© correspondant au type (ex: 'cancel_clt')
                if (!tpl) tpl = tpls[type]; 
                
                // 5. Si vous n'avez pas cr√©√© de message perso, on prend le message par d√©faut
                if (!tpl) tpl = getDefaultTemplate(type); 
                
                // Pr√©paration des variables sp√©ciales
                const showPrice = user.role === 'admin'; 
                const prixStr = (showPrice && ag.prix) ? (ag.prix + '‚Ç¨ ' + (ag.tva ? 'TTC' : 'HT')) : ''; 
                
                let dateRappelStr = ''; 
                if (data.date) { 
                    const today = new Date(); 
                    today.setHours(0,0,0,0); 
                    today.setMinutes(0,0,0);
                    today.setSeconds(0,0);
                    today.setMilliseconds(0);
                    let d;
                    if (typeof data.date === 'string') {
                        // Si c'est une cha√Æne au format YYYY-MM-DD, on la parse correctement
                        if (data.date.match(/^\d{4}-\d{2}-\d{2}/)) {
                            d = new Date(data.date + 'T00:00:00');
                        } else if (data.date.match(/^\d{2}\/\d{2}\/\d{4}/)) {
                            // Format DD/MM/YYYY
                            const parts = data.date.split('/');
                            d = new Date(parts[2] + '-' + parts[1] + '-' + parts[0] + 'T00:00:00');
                        } else {
                            d = new Date(data.date);
                        }
                    } else if (data.date instanceof Date) {
                        d = new Date(data.date.getTime());
                    } else {
                        d = new Date(data.date);
                    }
                    d.setHours(0,0,0,0);
                    d.setMinutes(0,0,0);
                    d.setSeconds(0,0);
                    d.setMilliseconds(0);
                    const diffDays = Math.floor((d.getTime() - today.getTime()) / 86400000); 
                    if (diffDays === 0) {
                        dateRappelStr = "aujourd'hui";
                    } else if (diffDays === 1) {
                        dateRappelStr = "demain le " + formatDateLong(data.date);
                    } else {
                        dateRappelStr = "le " + formatDateLong(data.date);
                    } 
                }
                
                let oldDateLong = ''; let oldHeure = ''; 
                if(type === 'reschedule' && rescheduleModal.oldDate) { 
                    oldDateLong = formatDateLong(rescheduleModal.oldDate); 
                    oldHeure = rescheduleModal.oldHeure || ''; 
                }

                // 5. On remplace les balises (dont {{MOTIF}} et {{RDV_LINK}})
                const rdvLink = data.rdvLinkId ? getRdvClientLink(data.rdvLinkId) : '';
                let msg = tpl
                    .replace(/{{CIVILITE}}/g, data.civilite||'')
                    .replace(/{{NOM}}/g, data.nom||'')
                    .replace(/{{PRENOM}}/g, data.nom||'')
                    .replace(/{{DATE_LONG}}/g, formatDateLong(data.date))
                    .replace(/{{DATE_RAPPEL}}/g, dateRappelStr || formatDateLong(data.date))
                    .replace(/{{HEURE}}/g, data.heure||'')
                    .replace(/{{MODELE}}/g, data.modele||'')
                    .replace(/{{AGENCE}}/g, ag.nom||'')
                    .replace(/{{ADRESSE}}/g, ag.adresse||'')
                    .replace(/{{PLAN}}/g, ag.maps||'')
                    .replace(/{{PRIX}}/g, prixStr)
                    .replace(/{{TAGLINE}}/g, ag.tagline||ag.nom||'')
                    .replace(/{{RDV_LINK}}/g, rdvLink)
                    // C'est ici que le motif d'annulation est inject√© dans votre message perso
                    .replace(/{{MOTIF}}/g, data.motif || ''); 

                if(type === 'reschedule' && rescheduleModal.oldDate) { 
                    msg = msg.replace(/{{OLD_DATE_LONG}}/g, oldDateLong).replace(/{{OLD_HEURE}}/g, oldHeure); 
                }
                
                // Remplacer "demain" en dur dans le template personnalis√© par la date calcul√©e (pour les rappels)
                if((type === 'rappel' || type === 'rappel_today') && data.date && dateRappelStr) {
                    // On remplace "demain" par la date calcul√©e selon si c'est aujourd'hui, demain ou apr√®s-demain
                    // On utilise \b pour matcher uniquement le mot "demain" et pas "demain" dans d'autres mots
                    msg = msg.replace(/\bdemain\b/gi, dateRappelStr);
                }
                
                // Ajouter le message de f√™te au d√©but pour les confirmations
                if(type === 'confirm') {
                    const feteMsg = getFeteMessage();
                    if(feteMsg) {
                        msg = feteMsg + msg;
                    }
                }
                
                const sep = navigator.userAgent.toLowerCase().includes('iphone') ? '&' : '?'; 
                return `sms:${normalizePhone(data.telephone)}${sep}body=${encodeURIComponent(msg)}`;
            };
            
            // Fonction pour obtenir le texte du message format√© (pour l'aper√ßu d√©roulable)
            const getMessagePreviewText = (rdv, type) => {
                // Si rdv.agence est un objet, l'utiliser directement, sinon chercher par ID
                const ag = rdv.agence && typeof rdv.agence === 'object' ? rdv.agence : (agences.value.find(a => a.id === rdv.agenceId) || rdv.agence || {});
                const tpls = ag.templates || {};
                let tpl = tpls[type] || getDefaultTemplate(type);
                
                const showPrice = user.role === 'admin';
                const prixStr = (showPrice && ag.prix) ? (ag.prix + '‚Ç¨ ' + (ag.tva ? 'TTC' : 'HT')) : '';
                
                let dateRappelStr = '';
                if (rdv.date) {
                    const today = new Date();
                    today.setHours(0,0,0,0);
                    today.setMinutes(0,0,0);
                    today.setSeconds(0,0);
                    today.setMilliseconds(0);
                    let d;
                    if (typeof rdv.date === 'string') {
                        // Si c'est une cha√Æne au format YYYY-MM-DD, on la parse correctement
                        if (rdv.date.match(/^\d{4}-\d{2}-\d{2}/)) {
                            d = new Date(rdv.date + 'T00:00:00');
                        } else if (rdv.date.match(/^\d{2}\/\d{2}\/\d{4}/)) {
                            // Format DD/MM/YYYY
                            const parts = rdv.date.split('/');
                            d = new Date(parts[2] + '-' + parts[1] + '-' + parts[0] + 'T00:00:00');
                        } else {
                            d = new Date(rdv.date);
                        }
                    } else if (rdv.date instanceof Date) {
                        d = new Date(rdv.date.getTime());
                    } else {
                        d = new Date(rdv.date);
                    }
                    d.setHours(0,0,0,0);
                    d.setMinutes(0,0,0);
                    d.setSeconds(0,0);
                    d.setMilliseconds(0);
                    const diffDays = Math.floor((d.getTime() - today.getTime()) / 86400000);
                    if (diffDays === 0) {
                        dateRappelStr = "aujourd'hui";
                    } else if (diffDays === 1) {
                        dateRappelStr = "demain le " + formatDateLong(rdv.date);
                    } else {
                        dateRappelStr = "le " + formatDateLong(rdv.date);
                    }
                }
                
                const rdvLink = rdv.rdvLinkId ? getRdvClientLink(rdv.rdvLinkId) : '';
                let msg = tpl
                    .replace(/{{CIVILITE}}/g, rdv.civilite||'')
                    .replace(/{{NOM}}/g, rdv.nom||'')
                    .replace(/{{PRENOM}}/g, rdv.nom||'')
                    .replace(/{{DATE_LONG}}/g, formatDateLong(rdv.date))
                    .replace(/{{DATE_RAPPEL}}/g, dateRappelStr || formatDateLong(rdv.date))
                    .replace(/{{HEURE}}/g, rdv.heure||'')
                    .replace(/{{MODELE}}/g, rdv.modele||'')
                    .replace(/{{AGENCE}}/g, ag.nom||'')
                    .replace(/{{ADRESSE}}/g, ag.adresse||'')
                    .replace(/{{PLAN}}/g, ag.maps||'')
                    .replace(/{{PRIX}}/g, prixStr)
                    .replace(/{{TAGLINE}}/g, ag.tagline||ag.nom||'')
                    .replace(/{{RDV_LINK}}/g, rdvLink)
                    .replace(/{{MOTIF}}/g, rdv.motif || '');
                
                // Remplacer "demain" en dur dans le template personnalis√© par la date calcul√©e (pour les rappels)
                if((type === 'rappel' || type === 'rappel_today') && rdv.date && dateRappelStr) {
                    // On remplace "demain" par la date calcul√©e selon si c'est aujourd'hui, demain ou apr√®s-demain
                    // On utilise \b pour matcher uniquement le mot "demain" et pas "demain" dans d'autres mots
                    msg = msg.replace(/\bdemain\b/gi, dateRappelStr);
                }
                
                if(type === 'confirm') {
                    const feteMsg = getFeteMessage();
                    if(feteMsg) {
                        msg = feteMsg + msg;
                    }
                }
                
                return msg;
            };
            
            // Fonction pour afficher l'aper√ßu du message (modale)
            const showMessagePreview = (rdv, type) => {
                const message = getMessagePreviewText(rdv, type);
                messagePreviewModal.message = message;
                messagePreviewModal.title = type === 'confirm' ? 'Aper√ßu - Message de confirmation' : (type === 'rappel' || type === 'rappel_today' ? 'Aper√ßu - Message de rappel' : 'Aper√ßu du message');
                messagePreviewModal.open = true;
            };
            
            const getDefaultTemplate = (t) => { 
                if(t==='confirm') return "Bonjour {{NOM}}, RDV confirm√© le {{DATE_LONG}} √† {{HEURE}} chez {{AGENCE}}.\n\nüìÖ G√©rez votre rendez-vous : {{RDV_LINK}}"; 
                if(t==='reschedule') return "Report Confirm√© ‚Äì {{AGENCE}}\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\nBonjour,\nVotre rendez-vous du {{OLD_DATE_LONG}} √† {{OLD_HEURE}} est report√©.\n\n‚óÜ Nouveau RDV :\n‚Üí Date & Heure : {{DATE_LONG}} √† {{HEURE}}\n‚Üí Mod√®le : {{MODELE}}\n‚óÜ Lieu : {{ADRESSE}}\n\nMerci de nous pr√©venir en cas d'impr√©vu\n\n√Ä bient√¥t,\nL'√©quipe {{AGENCE}}"; 
                if(t==='rappel') return "Bonjour, vous avez un rendez-vous {{DATE_RAPPEL}} √† {{HEURE}} chez {{AGENCE}}."; 
                if(t==='rappel_today') return "Bonjour, vous avez un rendez-vous aujourd'hui √† {{HEURE}} chez {{AGENCE}}."; 
                if(t==='noshow') return "Bonjour {{NOM}}, vous n'√™tes pas venu au RDV."; 
                if(t==='noshow_today') return "Bonjour {{NOM}}, vous aviez RDV aujourd'hui √† {{HEURE}} chez {{AGENCE}}. Vous n'√™tes pas venu."; 
                if(t==='cancel_clt') return "Bonjour {{NOM}},\n\nVotre rendez-vous du {{DATE_LONG}} √† {{HEURE}} chez {{AGENCE}} a √©t√© annul√©.\n\nMotif : {{MOTIF}}\n\nNous restons √† votre disposition pour reprogrammer un nouveau rendez-vous.\n\nCordialement,\nL'√©quipe {{AGENCE}}"; 
                if(t==='cancel_ag') return "Bonjour {{NOM}},\n\nNous sommes au regret de vous informer que votre rendez-vous du {{DATE_LONG}} √† {{HEURE}} chez {{AGENCE}} a √©t√© annul√©.\n\nMotif : {{MOTIF}}\n\nNous vous contacterons prochainement pour reprogrammer un nouveau rendez-vous.\n\nCordialement,\nL'√©quipe {{AGENCE}}"; 
                return ""; 
            };
            // Fonction pour g√©n√©rer l'aper√ßu du message avec variables remplac√©es
            const getMessagePreview = (ag, type) => {
                if(!ag) return '';
                
                // R√©cup√©rer le template
                const tpls = ag.templates || {};
                let tpl = tpls[type] || getDefaultTemplate(type);
                
                // Donn√©es d'exemple pour l'aper√ßu
                const exempleData = {
                    nom: 'Dupont',
                    civilite: 'M.',
                    date: new Date().toISOString().split('T')[0],
                    heure: '14:30',
                    modele: 'Peugeot 308',
                    agence: ag.nom || 'Nom de l\'agence',
                    adresse: ag.adresse || 'Adresse de l\'agence',
                    maps: ag.maps || 'https://maps.google.com',
                    prix: ag.prix ? (ag.prix + '‚Ç¨ ' + (ag.tva ? 'TTC' : 'HT')) : '',
                    tagline: ag.tagline || ag.nom || ''
                };
                
                // Calculer la date pour l'aper√ßu
                const today = new Date();
                today.setHours(0,0,0,0);
                const rdvDate = new Date(exempleData.date);
                rdvDate.setHours(0,0,0,0);
                const diffDays = Math.round((rdvDate - today) / 86400000);
                let dateRappelStr = '';
                if (diffDays === 0) dateRappelStr = "aujourd'hui";
                else if (diffDays === 1) dateRappelStr = "demain";
                else dateRappelStr = formatDateLong(exempleData.date);
                
                // Remplacer les variables
                let msg = tpl
                    .replace(/{{CIVILITE}}/g, exempleData.civilite)
                    .replace(/{{NOM}}/g, exempleData.nom)
                    .replace(/{{PRENOM}}/g, exempleData.nom)
                    .replace(/{{DATE_LONG}}/g, formatDateLong(exempleData.date))
                    .replace(/{{DATE_RAPPEL}}/g, dateRappelStr)
                    .replace(/{{HEURE}}/g, exempleData.heure)
                    .replace(/{{MODELE}}/g, exempleData.modele)
                    .replace(/{{AGENCE}}/g, exempleData.agence)
                    .replace(/{{ADRESSE}}/g, exempleData.adresse)
                    .replace(/{{PLAN}}/g, exempleData.maps)
                    .replace(/{{PRIX}}/g, exempleData.prix)
                    .replace(/{{TAGLINE}}/g, exempleData.tagline)
                    .replace(/{{MOTIF}}/g, '');
                
                // Ajouter le message de f√™te pour les confirmations
                if(type === 'confirm') {
                    const feteMsg = getFeteMessage();
                    if(feteMsg) {
                        msg = feteMsg + msg;
                    }
                }
                
                return msg;
            };
            
            const openSettings = () => { 
                settingsModal.open = true; 
                if(agences.value.length) {
                    editingMsgAgence.value = agences.value[0];
                    // Si on est dans l'onglet SMS Reports, charger les messages
                    if(settingsModal.tab === 'SMSReports') {
                        loadRescheduleSMSMessages();
                    }
                }
            };
            const openAgencyEdit = async (ag) => { 
                if(ag) { 
                    editingAgency.value = JSON.parse(JSON.stringify(ag)); 
                    if(editingAgency.value.motif_pause && !['Vacances','Complet','Travaux'].includes(editingAgency.value.motif_pause)) { 
                        pauseReasonSelect.value = 'Autre'; 
                    } else { 
                        pauseReasonSelect.value = editingAgency.value.motif_pause || 'Vacances'; 
                    }
                    // Initialiser la liste des commerciaux pour l'√©dition
                    if(editingAgency.value.commerciauxDetails) {
                        editingAgencyCommerciaux.value = JSON.parse(JSON.stringify(editingAgency.value.commerciauxDetails));
                    } else if(editingAgency.value.commerciaux) {
                        editingAgencyCommerciaux.value = editingAgency.value.commerciaux.map(name => ({ name, obj: 0 }));
                    } else {
                        editingAgencyCommerciaux.value = [];
                    }
                    // Initialiser la liste des fermetures exceptionnelles
                    if(editingAgency.value.fermeturesExceptionnelles && Array.isArray(editingAgency.value.fermeturesExceptionnelles)) {
                        editingAgencyFermetures.value = JSON.parse(JSON.stringify(editingAgency.value.fermeturesExceptionnelles));
                    } else {
                        editingAgencyFermetures.value = [];
                    }
                } else { 
                    editingAgency.value = { nom:'', adresse:'', maps:'', tagline:'', agendaEmail:'', agendaColor:'3', tva:true, prix:0, templates:{}, heureOuverture:'', heureFermeture:'', heurePauseDebut:'', heurePauseFin:'', horairesIdentiques:false, dimancheFerme:false, samediFerme:false, heureLimiteExceptionnelle:'', motifHeureLimite:'' }; 
                    editingAgencyCommerciaux.value = [];
                    editingAgencyFermetures.value = [];
                } 
                if(!editingAgency.value.statut_activite) editingAgency.value.statut_activite = 'actif'; 
                if(!editingAgency.value.agendaColor) editingAgency.value.agendaColor = '3'; 
                if(!editingAgency.value.heureOuverture) editingAgency.value.heureOuverture = '08:00'; 
                if(!editingAgency.value.heureFermeture) editingAgency.value.heureFermeture = '19:00';
                
                // Plus besoin de charger la liste des agendas, on utilise directement l'email 
            // Initialiser les horaires par jour si non d√©finis
            for(let i = 0; i < 7; i++) {
                if(!editingAgency.value[`horaires_${i}_ouverture`]) editingAgency.value[`horaires_${i}_ouverture`] = '';
                if(!editingAgency.value[`horaires_${i}_fermeture`]) editingAgency.value[`horaires_${i}_fermeture`] = '';
            }
            if(editingAgency.value.horairesIdentiques === undefined) editingAgency.value.horairesIdentiques = false;
            if(editingAgency.value.dimancheFerme === undefined) editingAgency.value.dimancheFerme = false;
            if(editingAgency.value.samediFerme === undefined) editingAgency.value.samediFerme = false;
            if(!editingAgency.value.heureLimiteExceptionnelle) editingAgency.value.heureLimiteExceptionnelle = '';
            if(!editingAgency.value.motifHeureLimite) editingAgency.value.motifHeureLimite = '';
            };
            
            const addAgencyCommercial = () => {
                editingAgencyCommerciaux.value.push({ name: '', obj: 0 });
            };
            
            const removeAgencyCommercial = (idx) => {
                editingAgencyCommerciaux.value.splice(idx, 1);
            };
            
            const addAgencyFermeture = () => {
                editingAgencyFermetures.value.push({ date_debut: '', date_fin: '' });
            };
            
            const removeAgencyFermeture = (idx) => {
                editingAgencyFermetures.value.splice(idx, 1);
            };
            
            const isFermetureValide = (fermeture) => {
                return fermeture.date_debut && fermeture.date_fin && fermeture.date_debut <= fermeture.date_fin;
            };
            
            const saveFermetureIndividuelle = async (idx) => {
                const fermeture = editingAgencyFermetures.value[idx];
                if(!fermeture.date_debut || !fermeture.date_fin) {
                    alert('Veuillez remplir les deux dates');
                    return;
                }
                if(fermeture.date_debut > fermeture.date_fin) {
                    alert('La date de fin doit √™tre sup√©rieure ou √©gale √† la date de d√©but');
                    return;
                }
                // Sauvegarder imm√©diatement si l'agence existe d√©j√†
                if(editingAgency.value && editingAgency.value.id) {
                    if(!editingAgency.value.fermeturesExceptionnelles) {
                        editingAgency.value.fermeturesExceptionnelles = [];
                    }
                    // Mettre √† jour la fermeture dans l'agence
                    const existingIdx = editingAgency.value.fermeturesExceptionnelles.findIndex(f => 
                        f.date_debut === fermeture.date_debut && f.date_fin === fermeture.date_fin
                    );
                    if(existingIdx === -1) {
                        editingAgency.value.fermeturesExceptionnelles.push({...fermeture});
                    } else {
                        editingAgency.value.fermeturesExceptionnelles[existingIdx] = {...fermeture};
                    }
                    await db.collection('agences').doc(editingAgency.value.id).update({
                        fermeturesExceptionnelles: editingAgency.value.fermeturesExceptionnelles
                    });
                    showNotification('‚úÖ Fermeture exceptionnelle enregistr√©e !', 'success', 'fa-calendar-times');
                } else {
                    showNotification('‚úÖ Fermeture ajout√©e (sera enregistr√©e avec l\'agence)', 'success', 'fa-calendar-times');
                }
            };
            
            const applyHorairesToAllDays = () => {
                if(editingAgency.value.horairesIdentiques && editingAgency.value.heureOuverture && editingAgency.value.heureFermeture) {
                    for(let i = 0; i < 6; i++) { // Pas le dimanche
                        editingAgency.value[`horaires_${i}_ouverture`] = editingAgency.value.heureOuverture;
                        editingAgency.value[`horaires_${i}_fermeture`] = editingAgency.value.heureFermeture;
                    }
                }
            };
            const updatePauseReason = () => { if(pauseReasonSelect.value !== 'Autre') { editingAgency.value.motif_pause = pauseReasonSelect.value; } else { editingAgency.value.motif_pause = ''; } };
            const calculateTTC = () => { const ht = parseFloat(editingAgency.value.prix_ht) || 0; const tva = parseFloat(editingAgency.value.tva_taux) || 0; editingAgency.value.prix = (ht * (1 + (tva / 100))).toFixed(2); };
            const saveEditingAgency = async () => { 
                if(!editingAgency.value.nom) return;
                
                // Nettoyer les commerciaux vides et pr√©parer les donn√©es
                const cleanedCommerciaux = editingAgencyCommerciaux.value.filter(c => c.name && c.name.trim() !== '');
                editingAgency.value.commerciaux = cleanedCommerciaux.map(c => c.name);
                editingAgency.value.commerciauxDetails = cleanedCommerciaux;
                
                // Sauvegarder les fermetures exceptionnelles (nettoyer celles sans dates)
                const cleanedFermetures = editingAgencyFermetures.value.filter(f => f.date_debut && f.date_fin);
                editingAgency.value.fermeturesExceptionnelles = cleanedFermetures;
                
                if(editingAgency.value.id) { 
                    await db.collection('agences').doc(editingAgency.value.id).update(editingAgency.value); 
                } else { 
                    await db.collection('agences').add(editingAgency.value); 
                } 
                editingAgency.value = null;
                editingAgencyCommerciaux.value = [];
                editingAgencyFermetures.value = [];
            };
            const saveAgency = async (ag) => { await db.collection('agences').doc(ag.id).update(ag); };
            const deleteAgency = async (id) => { openCustomConfirm("Supprimer Agence", "Voulez-vous vraiment supprimer cette agence ?", async () => { await db.collection('agences').doc(id).delete(); customConfirmModal.open = false; }); };
            const addSource = async () => { if(!newSource.value) return; const updated = [...sourcesList.value, newSource.value]; await db.collection('settings').doc('global').set({sources:updated}, {merge:true}); newSource.value = ''; };
            const removeSource = async (src) => { const updated = sourcesList.value.filter(s => s !== src); await db.collection('settings').doc('global').set({sources:updated}, {merge:true}); };
            const addMotif = async () => { if(!newMotif.value) return; const updated = [...motifsList.value, newMotif.value]; await db.collection('settings').doc('global').set({motifs:updated}, {merge:true}); newMotif.value = ''; };
            const removeMotif = async (motif) => { const updated = motifsList.value.filter(m => m !== motif); await db.collection('settings').doc('global').set({motifs:updated}, {merge:true}); };
            const addCancelMotif = async () => { if(!newCancelMotif.value) return; const updated = [...cancelMotifsList.value, newCancelMotif.value]; await db.collection('settings').doc('global').set({cancelMotifs:updated}, {merge:true}); newCancelMotif.value = ''; };
            const removeCancelMotif = async (motif) => { const updated = cancelMotifsList.value.filter(m => m !== motif); await db.collection('settings').doc('global').set({cancelMotifs:updated}, {merge:true}); };
            const changeSourceLogo = async (src) => { const url = prompt("Entrez l'URL de l'image pour " + src + " :"); if(url) { const newLogos = { ...sourceLogos.value, [src]: url }; await db.collection('settings').doc('global').set({ logos: newLogos }, { merge: true }); } };
            const getLogo = (src) => { if(!src) return ''; if(sourceLogos.value && sourceLogos.value[src]) return sourceLogos.value[src]; const s = (src||'').toLowerCase().trim().replace(/\s+/g, ''); if(s.includes('coin') || s === 'leboncoin' || s === 'leboncoin') return 'https://upload.wikimedia.org/wikipedia/commons/e/e1/Leboncoin_Logo_2016.svg'; if(s.includes('centrale')) return 'https://play-lh.googleusercontent.com/y3t-tGfqK_uJ0XQYV9xLqXoXwzX_zXwX_XwX_XwX_XwX_XwX_XwX_XwX_XwX_XwX_XwX_XwX_XwX_XwX_XwX_XwX_XwX_Xw'; if(s.includes('facebook')) return 'https://upload.wikimedia.org/wikipedia/commons/b/b8/2021_Facebook_icon.svg'; if(s.includes('google')) return 'https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg'; return `https://www.google.com/s2/favicons?domain=${s.replace(/\s+/g,'')}.com&sz=64`; };
            const insertTag = (tag) => { if(!editingMsgAgence.value) return; const area = document.querySelector('textarea'); if(area) { area.setRangeText(tag, area.selectionStart, area.selectionEnd, 'end'); editingMsgAgence.value.templates[editingMsgType.value] = area.value; } };
            
            const dateOptions = computed(() => { const arr = []; const today = new Date(); const days = ['Dim','Lun','Mar','Mer','Jeu','Ven','Sam']; const months = ['Jan','F√©v','Mar','Avr','Mai','Juin','Juil','Ao√ªt','Sep','Oct','Nov','D√©c']; for(let i=0; i<14; i++) { const d = new Date(); d.setDate(today.getDate()+i); const year = d.getFullYear(); const month = String(d.getMonth() + 1).padStart(2, '0'); const day = String(d.getDate()).padStart(2, '0'); const localDateString = `${year}-${month}-${day}`; arr.push({ val: localDateString, dayName: days[d.getDay()], dayNum: d.getDate(), month: months[d.getMonth()], isToday: i === 0 }); } return arr; });
            // Cr√©neaux horaires respectant les heures d'ouverture/fermeture de l'agence
            const timeSlots = computed(() => {
                const slots = [];
                const agence = form.agence;
                
                // S√©curit√© de base
                if (!agence || !form.date) return [];

                // --- 1. CALCUL DU JOUR (100% FIABLE) ---
                const dateParts = form.date.split('-'); 
                const safeDate = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]); 
                const jsDay = safeDate.getDay(); 
                // Conversion : 0=Lundi ... 5=Samedi, 6=Dimanche
                const dayIndex = jsDay === 0 ? 6 : jsDay - 1;

                // --- 2. V√âRIFICATION DES FERMETURES STRICTES ---
                if (dayIndex === 6 && agence.dimancheFerme) return []; // Dimanche ferm√©
                if (dayIndex === 5 && agence.samediFerme) return [];   // Samedi ferm√©

                // --- 3. LOGIQUE INTELLIGENTE DES HORAIRES ---
                let heureOuverture = null;
                let heureFermeture = null;
                let heurePauseDebut = null;
                let heurePauseFin = null;

                // A. On regarde d'abord si ce jour a des horaires SP√âCIFIQUES remplis
                const specificOpen = agence[`horaires_${dayIndex}_ouverture`];
                const specificClose = agence[`horaires_${dayIndex}_fermeture`];

                if (specificOpen && specificClose) {
                    // PRIORIT√â 1 : L'utilisateur a rempli ce jour pr√©cis (ex: Samedi 09h-13h)
                    // On utilise ces heures-l√†, PEU IMPORTE si "M√™me horaire" est coch√© ou pas.
                    heureOuverture = specificOpen;
                    heureFermeture = specificClose;
                    heurePauseDebut = agence[`horaires_${dayIndex}_pauseDebut`] || null;
                    heurePauseFin = agence[`horaires_${dayIndex}_pauseFin`] || null;
                } 
                else if (agence.horairesIdentiques) {
                    // PRIORIT√â 2 : Rien de sp√©cifique n'est rempli, mais "M√™me horaire" est coch√©
                    // On utilise les horaires g√©n√©raux
                    heureOuverture = agence.heureOuverture || '09:00';
                    heureFermeture = agence.heureFermeture || '19:00';
                    heurePauseDebut = agence.heurePauseDebut || null;
                    heurePauseFin = agence.heurePauseFin || null;
                } 
                else {
                    // PRIORIT√â 3 : Rien de sp√©cifique et "M√™me horaire" d√©coch√© => C'est ferm√©
                    return [];
                }

                // --- 4. CALCUL DES CR√âNEAUX ---
                const parseTime = (timeStr) => {
                    if (!timeStr) return null;
                    const [hours, minutes] = timeStr.split(':').map(Number);
                    return hours * 60 + minutes;
                };
                
                const openMinutes = parseTime(heureOuverture);
                const closeMinutes = parseTime(heureFermeture);
                const pauseStartMinutes = parseTime(heurePauseDebut);
                const pauseEndMinutes = parseTime(heurePauseFin);
                
                // Si les heures sont invalides ou si ouverture >= fermeture
                if (openMinutes === null || closeMinutes === null || openMinutes >= closeMinutes) return [];
                
                // Boucle de 30 minutes
                for (let minutes = openMinutes; minutes < closeMinutes; minutes += 30) {
                    
                    // Gestion de la pause d√©jeuner
                    if (pauseStartMinutes !== null && pauseEndMinutes !== null) {
                        if (minutes >= pauseStartMinutes && minutes < pauseEndMinutes) continue;
                    }

                    // Gestion de l'heure limite exceptionnelle (ex: Hiver)
                    if (agence.heureLimiteExceptionnelle) {
                        const limiteMinutes = parseTime(agence.heureLimiteExceptionnelle);
                        // La limite s'applique seulement si elle est avant la fermeture normale
                        if (limiteMinutes && limiteMinutes < closeMinutes) {
                            if (minutes > limiteMinutes) continue; 
                        }
                    }
                    
                    // Cr√©ation du format HH:mm
                    const hours = Math.floor(minutes / 60);
                    const mins = minutes % 60;
                    const hStr = String(hours).padStart(2, '0');
                    const mStr = String(mins).padStart(2, '0');
                    slots.push(`${hStr}:${mStr}`);
                }
                
                return slots;
            });

            const commonCars = ref([
                "Renault Clio", "Renault Megane", "Renault Captur", "Renault Austral", "Renault Arkana", "Renault Zoe", "Renault Scenic", "Renault Espace", "Renault Twingo", "Renault Kangoo",
                "Peugeot 208", "Peugeot 2008", "Peugeot 308", "Peugeot 3008", "Peugeot 5008", "Peugeot 508", "Peugeot Rifter", "Peugeot Traveller",
                "Citroen C3", "Citroen C3 Aircross", "Citroen C4", "Citroen C5 Aircross", "Citroen C5 X", "Citroen Berlingo",
                "Volkswagen Golf", "Volkswagen Polo", "Volkswagen Tiguan", "Volkswagen T-Roc", "Volkswagen T-Cross", "Volkswagen Passat", "Volkswagen Touareg", "Volkswagen ID.3", "Volkswagen ID.4", "Volkswagen Golf R-Line",
                "Audi A1", "Audi A3", "Audi A4", "Audi A5", "Audi A6", "Audi Q2", "Audi Q3", "Audi Q5", "Audi Q7", "Audi Q8", "Audi RS3", "Audi RSQ3",
                "BMW S√©rie 1", "BMW S√©rie 3", "BMW S√©rie 5", "BMW X1", "BMW X3", "BMW X5", "BMW M2", "BMW M3", "BMW M4",
                "Mercedes Classe A", "Mercedes Classe C", "Mercedes Classe E", "Mercedes GLA", "Mercedes CLA", "Mercedes GLE", "Mercedes GLC",
                "Toyota Yaris", "Toyota Corolla", "Toyota C-HR", "Toyota RAV4", "Toyota Aygo", "Toyota Highlander",
                "Ford Fiesta", "Ford Puma", "Ford Focus", "Ford Kuga", "Ford Ranger", "Ford Mustang",
                "Fiat 500", "Fiat Panda", "Fiat Tipo", "Fiat 500X",
                "Dacia Sandero", "Dacia Duster", "Dacia Jogger", "Dacia Spring",
                "Hyundai Tucson", "Hyundai Kona", "Hyundai i20", "Hyundai i30", "Hyundai Ioniq 5",
                "Kia Sportage", "Kia Niro", "Kia Picanto", "Kia Rio", "Kia EV6",
                "Tesla Model 3", "Tesla Model Y", "Tesla Model S", "Tesla Model X",
                "Nissan Qashqai", "Nissan Juke", "Nissan X-Trail", "Nissan Leaf",
                "Mini Cooper", "Mini Countryman", "Mini Clubman",
                "Seat Ibiza", "Seat Leon", "Seat Arona", "Seat Ateca", "Seat Cupra",
                "Skoda Fabia", "Skoda Octavia", "Skoda Kamiq", "Skoda Karoq", "Skoda Kodiaq",
                "Volvo XC40", "Volvo XC60", "Volvo XC90",
                "Land Rover Evoque", "Land Rover Velar", "Land Rover Sport",
                "Porsche Macan", "Porsche Cayenne", "Porsche 911"
            ]);

            const getCalendarColor = (colorId) => {
                const colors = {
                    1: '#7986CB', // Lavender
                    2: '#33B679', // Sage
                    3: '#8E24AA', // Grape (Raisin)
                    4: '#E67C73', // Flamingo
                    5: '#F6BF26', // Banana
                    6: '#F4511E', // Tangerine
                    7: '#039BE5', // Peacock
                    8: '#616161', // Graphite
                    9: '#3F51B5', // Blueberry
                    10: '#0B8043', // Basil
                    11: '#D50000'  // Tomato
                };
                return colors[colorId] || colors[3]; // Par d√©faut Raisin
            };
            
            const pastePhoneNumber = async () => {
                try {
                    const text = await navigator.clipboard.readText();
                    if (text) {
                        let cleaned = text.replace(/^\+33/, '0').replace(/^0033/, '0').replace(/\D/g, '');
                        if (cleaned.startsWith('33') && cleaned.length === 11) cleaned = '0' + cleaned.substring(2);
                        if (cleaned.length > 10) cleaned = cleaned.substring(0, 10);
                        if (cleaned.length === 10) {
                            form.telephone = formatPhone(cleaned);
                            const digits = normalizePhone(form.telephone);
                            const exist = rdvList.value.find(r => normalizePhone(r.telephone) === digits);
                            if (exist) {
                                form.nom = exist.nom;
                                form.civilite = exist.civilite;
                                form.modele = exist.modele;
                                clientExists.value = true;
                            } else {
                                clientExists.value = false;
                            }
                        }
                    }
                } catch (err) {
                    console.error('Erreur collage:', err);
                }
            };
            
            // Fonctions Google Calendar API
            // IMPORTANT : Vous devez obtenir un Client ID Google OAuth 2.0
            // 1. Allez sur https://console.cloud.google.com/
            // 2. Cr√©ez un projet ou s√©lectionnez-en un
            // 3. Activez l'API Google Calendar
            // 4. Cr√©ez des identifiants OAuth 2.0 (Application Web)
            // 5. Ajoutez votre domaine dans les URI de redirection autoris√©s
            // 6. Copiez le Client ID et collez-le ci-dessous
            const GOOGLE_CLIENT_ID = '827395252951-arojm83q4sthmlf0gk8bvn9aa95kgijc.apps.googleusercontent.com';
            
           const initGoogleCalendar = () => {
                if (typeof google !== 'undefined' && google.accounts && GOOGLE_CLIENT_ID) {
                    googleTokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: GOOGLE_CLIENT_ID,
                        scope: 'https://www.googleapis.com/auth/calendar.events https://www.googleapis.com/auth/calendar.readonly',
                        callback: (tokenResponse) => {
                            if (tokenResponse.access_token) {
                                // 1. On r√©cup√®re l'email pour confirmer qui est connect√©
                                fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                                    headers: { 'Authorization': `Bearer ${tokenResponse.access_token}` }
                                })
                                .then(res => res.json())
                                .then(async (data) => {
                                    const email = data.email || '';
                                    
                                    // 2. SAUVEGARDE CLOUD (FIREBASE)
                                    // Seul l'admin a le droit d'√©craser le token global
                                    if (user.role === 'admin') {
                                        
                                        try {
                                            await db.collection('settings').doc('google_token').set({
                                                token: tokenResponse.access_token,
                                                email: 'agendacetnsolutions@gmail.com',
                                                updatedAt: new Date().toISOString()
                                            });
                                            
                                            // Mise √† jour locale imm√©diate pour l'admin
                                            googleAccessToken.value = tokenResponse.access_token;
                                            googleCalendarUserEmail.value = 'agendacetnsolutions@gmail.com';
                                            googleCalendarConnected.value = true;
                                            
                                            // Charger la liste des agendas
                                            await fetchGoogleCalendarList();
                                            
                                            // V√©rifier le token apr√®s connexion
                                            setTimeout(() => {
                                                checkAndUpdateTokenStatus();
                                            }, 1000);
                                            
                                            showNotification("‚úÖ Connexion Google r√©ussie avec agendacetnsolutions@gmail.com et synchronis√©e avec toute l'√©quipe !", 'success', 'fa-check-circle', false, null, 2000);
                                            
                                            // Si on venait du wizard, fermer le modal de connexion
                                            if (googleCalendarDisconnectedModal.fromWizard) {
                                                googleCalendarDisconnectedModal.open = false;
                                                googleCalendarDisconnectedModal.fromWizard = false;
                                            }
                                        } catch (e) {
                                            console.error("Erreur sauvegarde token:", e);
                                            showNotification("Erreur lors de la sauvegarde de la connexion.", 'error', 'fa-exclamation-triangle', false);
                                        }
                                    } else {
                                        showNotification("Seul un administrateur peut modifier la connexion Google Agenda principale.", 'error', 'fa-exclamation-triangle', false);
                                    }
                                })
                                .catch(err => console.error('Erreur r√©cup√©ration email:', err));
                            }
                        }
                    });
                    
                    // V√©rifier et restaurer le token sauvegard√© si admin
                    if (user.role === 'admin') {
                        const savedToken = localStorage.getItem('google_calendar_token');
                        const savedEmail = localStorage.getItem('google_calendar_email');
                        if (savedToken && savedEmail) {
                            // V√©rifier si le token est encore valide en testant une requ√™te
                            fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                                headers: { 'Authorization': `Bearer ${savedToken}` }
                            })
                            .then(async (res) => {
                                if (res.ok) {
                                    googleAccessToken.value = savedToken;
                                    googleCalendarUserEmail.value = savedEmail;
                                    googleCalendarConnected.value = true;
                                    // Charger la liste des agendas au d√©marrage
                                    await fetchGoogleCalendarList();
                                } else {
                                    // Token invalide, nettoyer
                                    localStorage.removeItem('google_calendar_token');
                                    localStorage.removeItem('google_calendar_email');
                                    localStorage.removeItem('google_calendar_token_date');
                                }
                            })
                            .catch(() => {
                                // Erreur, nettoyer
                                localStorage.removeItem('google_calendar_token');
                                localStorage.removeItem('google_calendar_email');
                                localStorage.removeItem('google_calendar_token_date');
                            });
                        }
                    }
                }
            };
            
            const connectGoogleCalendar = () => {
                // R√©voquer le token existant pour forcer le choix du compte √† chaque fois
                const revokeAndConnect = () => {
                    // R√©initialiser le TokenClient √† chaque connexion pour forcer le choix
                    if (typeof google !== 'undefined' && google.accounts && GOOGLE_CLIENT_ID) {
                        googleTokenClient = google.accounts.oauth2.initTokenClient({
                            client_id: GOOGLE_CLIENT_ID,
                            scope: 'https://www.googleapis.com/auth/calendar.events https://www.googleapis.com/auth/calendar.readonly',
                            callback: (tokenResponse) => {
                                if (tokenResponse.access_token) {
                                    // 1. On r√©cup√®re l'email pour confirmer qui est connect√©
                                    fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                                        headers: { 'Authorization': `Bearer ${tokenResponse.access_token}` }
                                    })
                                    .then(res => res.json())
                                    .then(async (data) => {
                                        const email = data.email || '';
                                        
                                        // 2. SAUVEGARDE CLOUD (FIREBASE)
                                        // Seul l'admin a le droit d'√©craser le token global
                                        if (user.role === 'admin') {
                                          
                                            
                                            try {
                                                await db.collection('settings').doc('google_token').set({
                                                    token: tokenResponse.access_token,
                                                    email: 'agendacetnsolutions@gmail.com',
                                                    updatedAt: new Date().toISOString()
                                                });
                                                
                                                // Mise √† jour locale imm√©diate pour l'admin
                                                googleAccessToken.value = tokenResponse.access_token;
                                                googleCalendarUserEmail.value = 'agendacetnsolutions@gmail.com';
                                                googleCalendarConnected.value = true;
                                                
                                                // Charger la liste des agendas
                                                await fetchGoogleCalendarList();
                                                
                                                // V√©rifier le token apr√®s connexion
                                                setTimeout(() => {
                                                    checkAndUpdateTokenStatus();
                                                }, 1000);
                                                
                                                showNotification("‚úÖ Connexion Google r√©ussie avec agendacetnsolutions@gmail.com et synchronis√©e avec toute l'√©quipe !", 'success', 'fa-check-circle', false, null, 2000);
                                                
                                                // Si on venait du wizard, fermer le modal de connexion
                                                if (googleCalendarDisconnectedModal.fromWizard) {
                                                    googleCalendarDisconnectedModal.open = false;
                                                    googleCalendarDisconnectedModal.fromWizard = false;
                                                }
                                            } catch (e) {
                                                console.error("Erreur sauvegarde token:", e);
                                                showNotification("Erreur lors de la sauvegarde de la connexion.", 'error', 'fa-exclamation-triangle', false);
                                            }
                                        } else {
                                            showNotification("Seul un administrateur peut modifier la connexion Google Agenda principale.", 'error', 'fa-exclamation-triangle', false);
                                        }
                                    })
                                    .catch(err => console.error('Erreur r√©cup√©ration email:', err));
                                }
                            }
                        });
                        
                        // Forcer l'affichage du s√©lecteur de compte avec 'select_account' uniquement
                        // Cela garantit que l'utilisateur peut choisir son compte √† chaque fois
                        googleTokenClient.requestAccessToken({ prompt: 'consent select_account' });
                    }
                };
                
                // Si on vient du wizard avec connexion obligatoire, noter qu'on attend la connexion
                const wasFromWizard = googleCalendarDisconnectedModal.fromWizard && googleCalendarRequired.value;
                const wasConnectedBefore = googleCalendarConnected.value;
                
                // R√©voquer le token existant avant de demander un nouveau compte
                if (googleAccessToken.value && typeof google !== 'undefined' && google.accounts) {
                    google.accounts.oauth2.revoke(googleAccessToken.value, () => {
                        // Petit d√©lai pour s'assurer que la r√©vocation est bien prise en compte
                        setTimeout(() => {
                            revokeAndConnect();
                        }, 300);
                    });
                } else {
                    // Pas de token existant, demander directement avec choix du compte
                    revokeAndConnect();
                }
                
                // Si on vient du wizard avec connexion obligatoire, v√©rifier apr√®s un d√©lai si on s'est connect√©
                if (wasFromWizard) {
                    setTimeout(async () => {
                        // V√©rifier si on est maintenant connect√©
                        const isTokenValid = await checkGoogleCalendarTokenValid();
                        const isConnected = isGoogleCalendarConnected.value && isTokenValid;
                        
                        // Si on n'est toujours pas connect√© et que c'√©tait obligatoire, fermer le wizard
                        if (!isConnected && googleCalendarRequired.value && googleCalendarDisconnectedModal.fromWizard) {
                            wizard.open = false;
                            googleCalendarDisconnectedModal.open = false;
                            googleCalendarDisconnectedModal.fromWizard = false;
                        }
                    }, 2000); // Attendre 2 secondes pour laisser le temps √† la popup de se fermer
                }
            };
            
            const disconnectGoogleCalendar = async () => {
                if (googleAccessToken.value && typeof google !== 'undefined' && google.accounts) {
                    google.accounts.oauth2.revoke(googleAccessToken.value);
                }
                
                // Si c'est l'admin qui se d√©connecte, supprimer le token de Firestore pour d√©connecter tout le monde
                if (user.role === 'admin') {
                    try {
                        await db.collection('settings').doc('google_token').delete();
                    } catch (err) {
                        console.error('Erreur lors de la suppression du token:', err);
                    }
                }
                
                googleCalendarConnected.value = false;
                googleCalendarUserEmail.value = '';
                googleAccessToken.value = '';
                googleCalendarTokenValid.value = false; // R√©initialiser l'√©tat du token
                localStorage.removeItem('google_calendar_token');
                localStorage.removeItem('google_calendar_email');
                googleCalendarList.value = [];
            };
            
            // ====================================================================================
            // CORRECTION PROSPECTEUR GOOGLE CALENDAR
            // ====================================================================================

            // 1. Initialisation de l'outil (uniquement pour le rafra√Æchissement automatique, PAS pour la connexion)
            const initProspecteurGoogleCalendar = () => {
                // V√©rifier si le script Google est charg√©
                if (typeof google === 'undefined' || !google.accounts) {
                    console.warn("Librairie Google non charg√©e.");
                    return false;
                }

                // Si d√©j√† initialis√©, on ne refait pas
                if (prospecteurGoogleTokenClient) return true;

                try {
                    // TokenClient pour le rafra√Æchissement automatique uniquement
                    // Le callback de connexion est dans connectProspecteurGoogleCalendar
                    prospecteurGoogleTokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: GOOGLE_CLIENT_ID,
                        scope: 'https://www.googleapis.com/auth/calendar.events https://www.googleapis.com/auth/calendar.readonly',
                        callback: (tokenResponse) => {
                            // Ce callback est pour le rafra√Æchissement automatique ET manuel
                            // La connexion manuelle utilise connectProspecteurGoogleCalendar
                            if (tokenResponse.access_token) {
                                // Mise √† jour du token et remise du compteur √† 55 minutes
                                prospecteurGoogleCalendarToken.value = tokenResponse.access_token;
                                prospecteurGoogleCalendarTokenValid.value = true;
                                prospecteurGoogleCalendarTokenExpired.value = false;
                                prospecteurTokenExpirationTime.value = Date.now() + (55 * 60 * 1000); // Remettre √† 55 minutes
                                lastProspecteurTokenValue.value = tokenResponse.access_token;
                                
                                // Mettre √† jour le timer tick pour forcer la mise √† jour du compteur
                                prospecteurTokenTimerTick.value = Date.now();
                                
                                localStorage.setItem('prospecteur_google_calendar_token', tokenResponse.access_token);
                                localStorage.setItem('prospecteur_google_calendar_token_date', new Date().toISOString());
                                
                                // Sauvegarder dans Firestore
                                if (user.logged && user.role !== 'admin' && user.id) {
                                    db.collection('users').doc(user.id).update({
                                        googleToken: {
                                            token: tokenResponse.access_token,
                                            expires: prospecteurTokenExpirationTime.value,
                                            updatedAt: new Date().toISOString()
                                        },
                                        googleTokenExpires: prospecteurTokenExpirationTime.value,
                                        lastSeen: new Date().toISOString()
                                    }).catch(e => console.log("Erreur save Firestore", e));
                                }
                                
                                showNotification('‚úÖ Token recharg√© avec succ√®s ! Compte √† rebours r√©initialis√© √† 55 minutes', 'success', 'fa-check-circle');
                                console.log("‚úÖ Token prospecteur rafra√Æchi automatiquement");
                            }
                        }
                    });
                    return true;
                } catch (e) {
                    console.error("Erreur init client:", e);
                    return false;
                }
            };

            // 2. Gestion du clic sur le bouton (D√©connexion ou Connexion)
            const handleProspecteurGoogleCalendar = async () => {
                // TOUJOURS v√©rifier la validit√© r√©elle du token avant toute action
                const isTokenValid = await checkGoogleCalendarTokenValid();
                
                // V√©rifier si on est vraiment connect√© (token valide)
                const adminConnected = googleCalendarConnected.value && googleAccessToken.value && googleAccessToken.value.trim() !== '';
                const prospecteurConnected = prospecteurGoogleCalendarConnected.value && 
                                           prospecteurGoogleCalendarToken.value && 
                                           prospecteurGoogleCalendarToken.value.trim() !== '' && 
                                           !prospecteurGoogleCalendarTokenExpired.value;
                
                // Si vraiment connect√© ET token valide, afficher simplement le temps restant (token propre)
                if (isTokenValid && prospecteurConnected && !prospecteurGoogleCalendarTokenExpired.value) {
                    // Le prospecteur a son propre token valide, afficher le temps restant
                    const timeRemaining = prospecteurTokenTimeRemaining.value;
                    let message = '‚úÖ Vous √™tes connect√© √† Google Calendar';
                    if (timeRemaining) {
                        message += `\n‚è±Ô∏è Temps restant : ${timeRemaining.minutes} minutes ${timeRemaining.seconds} secondes`;
                    } else {
                        message += '\n‚è±Ô∏è Session active';
                    }
                    showNotification(message, 'success', 'fa-check-circle');
                    return;
                }
                
                // Si connect√© via admin ET token valide, afficher le temps restant
                if (isTokenValid && adminConnected && user.role !== 'admin') {
                    const timeRemaining = tokenTimeRemaining.value;
                    let message = '‚úÖ Connect√© via Admin';
                    if (timeRemaining) {
                        message += `\n‚è±Ô∏è Temps restant : ${timeRemaining.minutes} minutes ${timeRemaining.seconds} secondes`;
                    } else {
                        message += '\n‚è±Ô∏è Session active';
                    }
                    showNotification(message, 'success', 'fa-check-circle');
                    return;
                }
                
                // Dans TOUS les autres cas (pas connect√©, token invalide, token expir√©), lancer la connexion automatiquement
                // Pas de confirmation, on lance directement
                connectProspecteurGoogleCalendar();
            };

            // 3. La fonction qui lance la popup - EXACTEMENT COMME ADMIN
            const connectProspecteurGoogleCalendar = () => {
                // R√©voquer le token existant pour forcer le choix du compte √† chaque fois (COMME ADMIN)
                const revokeAndConnect = () => {
                    // R√©initialiser le TokenClient √† chaque connexion pour forcer le choix (COMME ADMIN)
                    if (typeof google !== 'undefined' && google.accounts && GOOGLE_CLIENT_ID) {
                        prospecteurGoogleTokenClient = google.accounts.oauth2.initTokenClient({
                            client_id: GOOGLE_CLIENT_ID,
                            scope: 'https://www.googleapis.com/auth/calendar.events https://www.googleapis.com/auth/calendar.readonly',
                            callback: (tokenResponse) => {
                                if (tokenResponse.access_token) {
                                    // 1. On r√©cup√®re l'email pour confirmer qui est connect√© (COMME ADMIN)
                                    fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                                        headers: { 'Authorization': `Bearer ${tokenResponse.access_token}` }
                                    })
                                    .then(res => res.json())
                                    .then(async (data) => {
                                        const email = data.email || '';
                                        
                                        // 2. SAUVEGARDE DU TOKEN (COMME ADMIN mais pour prospecteur)
                                        try {
                                            // Expiration 55 minutes
                                            const expiresTime = Date.now() + (55 * 60 * 1000);
                                            
                                            // Mise √† jour locale imm√©diate - TOUS LES FLAGS EN M√äME TEMPS (COMME ADMIN)
                                            prospecteurGoogleCalendarToken.value = tokenResponse.access_token;
                                            prospecteurGoogleCalendarConnected.value = true;
                                            prospecteurGoogleCalendarTokenValid.value = true;
                                            prospecteurGoogleCalendarTokenExpired.value = false;
                                            prospecteurTokenExpirationTime.value = expiresTime;
                                            
                                            // Mettre √† jour l'email (COMME ADMIN)
                                            prospecteurGoogleCalendarUserEmail.value = email;
                                            
                                            // Mettre √† jour lastProspecteurTokenValue pour √©viter que checkAndUpdateProspecteurTokenStatus invalide le token
                                            lastProspecteurTokenValue.value = tokenResponse.access_token;
                                            
                                            // Forcer la mise √† jour du statut pour que l'interface refl√®te la connexion
                                            // Pas besoin de v√©rifier le token, on vient de le recevoir de Google

                                            // Sauvegarde locale
                                            localStorage.setItem('prospecteur_google_calendar_token', tokenResponse.access_token);
                                            localStorage.setItem('prospecteur_google_calendar_email', email);
                                            localStorage.setItem('prospecteur_google_calendar_token_date', new Date().toISOString());

                                            // D√©marrer le refresh auto
                                            startProspecteurTokenRefresh();

                                            // Sauvegarder dans Firestore pour cet utilisateur sp√©cifique
                                            if (user.logged && user.role !== 'admin' && user.id) {
                                                await db.collection('users').doc(user.id).update({
                                                    googleStatus: 'connected',
                                                    googleToken: {
                                                        token: tokenResponse.access_token,
                                                        email: email,
                                                        expires: expiresTime,
                                                        updatedAt: new Date().toISOString()
                                                    },
                                                    googleTokenExpires: expiresTime,
                                                    lastSeen: new Date().toISOString()
                                                });
                                            }
                                            
                                            // Charger la liste des agendas (COMME ADMIN)
                                            await fetchGoogleCalendarList();
                                            
                                            // NE PAS v√©rifier le token imm√©diatement apr√®s connexion
                                            // Le token vient d'√™tre cr√©√© par Google, il est forc√©ment valide
                                            // La v√©rification se fera automatiquement plus tard si n√©cessaire
                                            // On √©vite ainsi que checkAndUpdateProspecteurTokenStatus invalide le token juste apr√®s connexion
                                            
                                            // Forcer la mise √† jour de l'interface IMM√âDIATEMENT pour que le bouton affiche "Connect√©"
                                            // On s'assure que tous les flags sont bien √† jour AVANT l'alert
                                            // Double v√©rification pour forcer Vue √† d√©tecter les changements
                                            prospecteurGoogleCalendarConnected.value = true;
                                            prospecteurGoogleCalendarToken.value = tokenResponse.access_token; // R√©assigner pour forcer la r√©activit√©
                                            prospecteurGoogleCalendarTokenValid.value = true;
                                            prospecteurGoogleCalendarTokenExpired.value = false;
                                            
                                            // Utiliser alert comme l'admin
                                            alert("‚úÖ Connexion Google r√©ussie avec " + email + " !");
                                            
                                            // Si on vient de selectSource, fermer le modal et continuer le wizard
                                            if (googleCalendarDisconnectedModal.fromWizard) {
                                                googleCalendarDisconnectedModal.open = false;
                                                googleCalendarDisconnectedModal.fromWizard = false;
                                            }
                                            
                                            // Si la connexion vient de la s√©lection de Google comme source, continuer le wizard
                                            if (connectingFromSelectSource.value) {
                                                connectingFromSelectSource.value = false;
                                                wizard.step++;
                                            }
                                        } catch (e) {
                                            console.error("Erreur sauvegarde token:", e);
                                            showNotification("Erreur lors de la sauvegarde de la connexion.", 'error', 'fa-exclamation-triangle', false);
                                        }
                                    })
                                    .catch(err => {
                                        console.error('Erreur r√©cup√©ration email:', err);
                                        connectingFromSelectSource.value = false;
                                    });
                                }
                            }
                        });
                        
                        // Forcer l'affichage du s√©lecteur de compte avec 'select_account consent' (COMME ADMIN - m√™me ordre)
                        prospecteurGoogleTokenClient.requestAccessToken({ prompt: 'consent select_account' });
                    }
                };
                
                // Si on vient du wizard avec connexion obligatoire, noter qu'on attend la connexion (COMME ADMIN)
                const wasFromWizard = googleCalendarDisconnectedModal.fromWizard && googleCalendarRequired.value;
                const wasConnectedBefore = prospecteurGoogleCalendarConnected.value;
                
                // R√©voquer le token existant avant de demander un nouveau compte (COMME ADMIN)
                if (prospecteurGoogleCalendarToken.value && typeof google !== 'undefined' && google.accounts) {
                    google.accounts.oauth2.revoke(prospecteurGoogleCalendarToken.value, () => {
                        // Petit d√©lai pour s'assurer que la r√©vocation est bien prise en compte
                        setTimeout(() => {
                            revokeAndConnect();
                        }, 300);
                    });
                } else {
                    // Pas de token existant, demander directement avec choix du compte
                    revokeAndConnect();
                }
                
                // Si on vient du wizard avec connexion obligatoire, v√©rifier apr√®s un d√©lai si on s'est connect√© (COMME ADMIN)
                if (wasFromWizard) {
                    setTimeout(async () => {
                        // V√©rifier si on est maintenant connect√©
                        const isTokenValid = await checkGoogleCalendarTokenValid();
                        const adminConnected = googleCalendarConnected.value && googleAccessToken.value && googleAccessToken.value.trim() !== '';
                        const prospecteurConnected = prospecteurGoogleCalendarConnected.value && 
                                                   prospecteurGoogleCalendarToken.value && 
                                                   prospecteurGoogleCalendarToken.value.trim() !== '' && 
                                                   !prospecteurGoogleCalendarTokenExpired.value;
                        const isConnected = (adminConnected || prospecteurConnected) && isTokenValid;
                        
                        // Si on n'est toujours pas connect√© et que c'√©tait obligatoire, fermer le wizard
                        if (!isConnected && googleCalendarRequired.value && googleCalendarDisconnectedModal.fromWizard) {
                            wizard.open = false;
                            googleCalendarDisconnectedModal.open = false;
                            googleCalendarDisconnectedModal.fromWizard = false;
                        }
                    }, 2000); // Attendre 2 secondes pour laisser le temps √† la popup de se fermer
                }
            };
            
            // Fonction pour se d√©connecter de Google Calendar (prospecteurs) - EXACTEMENT COMME ADMIN
         const disconnectProspecteurGoogleCalendar = async () => {
    if (prospecteurGoogleCalendarToken.value && typeof google !== 'undefined' && google.accounts) {
        google.accounts.oauth2.revoke(prospecteurGoogleCalendarToken.value);
    }
    
    // Supprimer le token de Firestore pour le prospecteur
    if (user.logged && user.role !== 'admin' && user.id) {
        try {
            await db.collection('users').doc(user.id).update({
                googleToken: null,
                googleStatus: 'disconnected'
            });
        } catch (err) {
            console.error('Erreur lors de la suppression du token:', err);
        }
    }
    
    prospecteurGoogleCalendarConnected.value = false;
    prospecteurGoogleCalendarUserEmail.value = '';
    prospecteurGoogleCalendarToken.value = '';
    prospecteurGoogleCalendarTokenValid.value = false; // R√©initialiser l'√©tat du token
    localStorage.removeItem('prospecteur_google_calendar_token');
    localStorage.removeItem('prospecteur_google_calendar_email');
    localStorage.removeItem('prospecteur_google_calendar_token_date');
};
            
         
           // Fonction pour recharger manuellement le token
            const reloadProspecteurToken = () => {
                // Pour les prospecteurs, simplement recharger la page
                if (user.role !== 'admin') {
                    location.reload();
                    return;
                }
                
                // Pour l'admin, garder l'ancien comportement
                if (user.role === 'admin') {
                    checkAndUpdateTokenStatus(true);
                    showNotification('Token v√©rifi√© et actualis√©', 'success', 'fa-check-circle');
                }
            };
            
            // Fonction pour d√©marrer le rafra√Æchissement automatique du token (toutes les 45 minutes)
            const startProspecteurTokenRefresh = () => {
                // Arr√™ter l'ancien intervalle si existe
                if (prospecteurTokenRefreshInterval) {
                    clearInterval(prospecteurTokenRefreshInterval);
                    prospecteurTokenRefreshInterval = null;
                }
                
                // Rafra√Æchir toutes les 45 minutes
                prospecteurTokenRefreshInterval = setInterval(() => {
                    if (prospecteurGoogleCalendarConnected.value && prospecteurGoogleCalendarToken.value && prospecteurGoogleTokenClient) {
                        console.log("üîÑ Rafra√Æchissement automatique du token Google Agenda (prospecteur)...");
                        prospecteurGoogleTokenClient.requestAccessToken({ prompt: 'none' });
                    }
                }, 45 * 60 * 1000); // 45 minutes
            };
            
          // Fonction pour v√©rifier l'expiration du token
            const checkProspecteurTokenExpiration = async () => {
                // Si l'admin est connect√©, on utilise son token
                if (googleCalendarConnected.value && googleAccessToken.value) {
                    prospecteurGoogleCalendarConnected.value = true;
                    prospecteurGoogleCalendarToken.value = googleAccessToken.value;
                    prospecteurGoogleCalendarTokenExpired.value = false;
                    // Utiliser le token admin, donc pas d'expiration pour le prospecteur
                    prospecteurTokenExpirationTime.value = null;
                    return;
                }
                
                // V√©rifier le token local du prospecteur
                if (prospecteurGoogleCalendarToken.value) {
                    try {
                        const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                            headers: { 'Authorization': `Bearer ${prospecteurGoogleCalendarToken.value}` }
                        });
                        
                        if (!response.ok) {
                            // Token expir√©
                            prospecteurGoogleCalendarTokenExpired.value = true;
                            prospecteurGoogleCalendarConnected.value = false;
                            prospecteurTokenExpirationTime.value = null;
                            
                            // --- LIGNE SUPPRIM√âE ICI ---
                            // showNotification('‚ö†Ô∏è Votre session Google Agenda a expir√©. Veuillez vous reconnecter.', 'warning', 'fa-exclamation-triangle'); 
                            
                        } else {
                            prospecteurGoogleCalendarTokenExpired.value = false;
                            // D√©finir l'expiration du token (55 minutes)
                            prospecteurTokenExpirationTime.value = Date.now() + (55 * 60 * 1000);
                        }
                    } catch (err) {
                        console.error('Erreur v√©rification token:', err);
                        prospecteurGoogleCalendarTokenExpired.value = true;
                        prospecteurTokenExpirationTime.value = null;
                    }
                }
            };
            
            // Liste des agendas Google
            const googleCalendarList = ref([]);
            const loadingCalendars = ref(false);
            
            // R√©cup√©rer la liste des agendas Google
            const fetchGoogleCalendarList = async () => {
                if (!googleAccessToken.value || !googleCalendarConnected.value) {
                    googleCalendarList.value = [];
                    return;
                }
                
                loadingCalendars.value = true;
                try {
                    // R√©cup√©rer TOUS les calendriers (sans aucun filtre)
                    const response = await fetch('https://www.googleapis.com/calendar/v3/users/me/calendarList?maxResults=250', {
                        headers: {
                            'Authorization': `Bearer ${googleAccessToken.value}`
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('üìÖ Calendriers re√ßus de Google:', data.items?.length || 0);
                        
                        // Prendre TOUS les calendriers sans filtre
                        const allCalendars = (data.items || []).map(cal => ({
                            id: cal.id,
                            summary: cal.summary || cal.id,
                            description: cal.description || '',
                            primary: cal.primary || false,
                            accessRole: cal.accessRole || '',
                            backgroundColor: cal.backgroundColor || '#8b5cf6',
                            foregroundColor: cal.foregroundColor || '#000000'
                        }));
                        
                        // Trier : agenda principal en premier, puis par nom
                        googleCalendarList.value = allCalendars.sort((a, b) => {
                            if (a.primary && !b.primary) return -1;
                            if (!a.primary && b.primary) return 1;
                            return a.summary.localeCompare(b.summary, 'fr');
                        });
                        
                        console.log('‚úÖ Liste finale des calendriers:', googleCalendarList.value.length);
                        
                        // SYNCHRONISER LES STATUTS apr√®s avoir charg√© la liste
                        try {
                            const now = new Date();
                            const startDate = new Date(now);
                            startDate.setDate(startDate.getDate() - 7);
                            startDate.setHours(0, 0, 0, 0);
                            const endDate = new Date(now);
                            endDate.setDate(endDate.getDate() + 7);
                            endDate.setHours(23, 59, 59, 999);
                            
                            const timeMin = startDate.toISOString();
                            const timeMax = endDate.toISOString();
                            
                            // R√©cup√©rer tous les calendriers (primary + agences)
                            const calendarIds = ['primary'];
                            agences.value.forEach(agence => {
                                if (agence.agendaEmail && agence.agendaEmail.trim()) {
                                    calendarIds.push(agence.agendaEmail.trim());
                                }
                            });
                            
                            const allGoogleEvents = [];
                            for (const calendarId of calendarIds) {
                                try {
                                    const encodedId = encodeURIComponent(calendarId);
                                    const url = `https://www.googleapis.com/calendar/v3/calendars/${encodedId}/events?timeMin=${timeMin}&timeMax=${timeMax}&singleEvents=true&orderBy=startTime`;
                                    
                                    const eventResponse = await fetch(url, {
                                        headers: {
                                            'Authorization': `Bearer ${googleAccessToken.value}`
                                        }
                                    });
                                    
                                    if (eventResponse.ok) {
                                        const eventData = await eventResponse.json();
                                        if (eventData.items) {
                                            allGoogleEvents.push(...eventData.items);
                                        }
                                    }
                                } catch (err) {
                                    console.warn(`Erreur synchronisation calendrier ${calendarId}:`, err);
                                }
                            }
                        } catch (syncErr) {
                            console.error('Erreur lors de la synchronisation des statuts:', syncErr);
                        }
                    } else if (response.status === 401) {
                        // Token expir√© ou invalide
                        console.error('‚ùå Token expir√© ou invalide');
                        googleCalendarList.value = [];
                        googleCalendarConnected.value = false;
                        googleAccessToken.value = '';
                        alert('‚ö†Ô∏è Votre session Google Calendar a expir√©. Veuillez vous reconnecter en cliquant sur "Se connecter avec Google".');
                    } else {
                        const errorData = await response.json().catch(() => ({}));
                        const errorMessage = errorData.error?.message || 'Erreur inconnue';
                        console.error('‚ùå Erreur lors de la r√©cup√©ration des agendas:', errorMessage);
                        alert('‚ùå Erreur lors de la r√©cup√©ration des calendriers : ' + errorMessage);
                        googleCalendarList.value = [];
                    }
                } catch (err) {
                    console.error('‚ùå Erreur lors de la r√©cup√©ration des agendas Google:', err);
                    alert('‚ùå Erreur lors de la r√©cup√©ration des calendriers. Veuillez r√©essayer ou vous reconnecter √† Google Calendar.');
                    googleCalendarList.value = [];
                } finally {
                    loadingCalendars.value = false;
                }
            };
            
// ============================================================
            // ‚úÖ SYST√àME API DIRECTE (Stable & Sans doublons)
            // ============================================================

            // 0. V√âRIFICATION DE LA VALIDIT√â DU TOKEN
            const checkGoogleCalendarTokenValid = async () => {
                const token = getActiveGoogleToken();
                if (!token) return false;
                
                try {
                    // Tester le token en faisant une requ√™te simple √† l'API Google Calendar
                    const response = await fetch('https://www.googleapis.com/calendar/v3/users/me/calendarList?maxResults=1', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    // Si 401 ou 403, le token est invalide ou expir√©
                    if (response.status === 401 || response.status === 403) {
                        return false;
                    }
                    
                    return response.ok;
                } catch (err) {
                    console.error('Erreur v√©rification token:', err);
                    return false;
                }
            };

            // 1. CR√âATION (Donne un vrai ID Google)
            const createGoogleCalendarEvent = async (rdv) => {
                // V√©rif s√©curit√© - utiliser le token actif (admin ou prospecteur)
                const token = getActiveGoogleToken();
                if (!token) throw new Error("Non connect√© √† Google.");

                const agence = agences.value.find(a => a.id === rdv.agenceId);
                // On utilise l'email de l'agence comme ID de calendrier, ou 'primary' par d√©faut
                const calendarId = (agence?.agendaEmail && agence.agendaEmail.trim()) ? agence.agendaEmail.trim() : 'primary';
                const agendaColor = agence?.agendaColor || '10'; 

               let prefixTitre = '';
                if (rdv.statut === 'annule') prefixTitre = '[ANNUL√â] ';
                const baseModeleTitre = getBaseModele(rdv.modele) || rdv.modele || '';
                const titre = `${prefixTitre}C&N - ${rdv.civilite || ''} ${rdv.nom || ''} - ${rdv.telephone || ''} - ${baseModeleTitre}`;
                
                let startDateTime, endDateTime;
                if (rdv.date && rdv.heure) {
                    const [year, month, day] = rdv.date.split('-').map(Number);
                    const [hours, minutes] = rdv.heure.split(':').map(Number);
                    const rdvDate = new Date(year, month - 1, day, hours, minutes, 0);
                    const endDate = new Date(rdvDate);
                    endDate.setHours(endDate.getHours() + 1); // Dur√©e 1h
                    
                    startDateTime = rdvDate.toISOString();
                    endDateTime = endDate.toISOString();
                }

                let description = '';
                
                // Ajouter le mod√®le de base du v√©hicule
                const baseModele = getBaseModele(rdv.modele);
                if (baseModele) {
                    description += `<b>V√©hicule :</b> ${baseModele}<br><br>`;
                }
                
                // Ajouter le prix si disponible
                if (rdv.prix && rdv.prix > 0) {
                    const prixFormate = Math.floor(rdv.prix).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
                    description += `<b>Prix :</b> ${prixFormate} ‚Ç¨<br><br>`;
                }
                
                if (rdv.lienAnnonce) description += `<b>Lien annonce :</b> ${rdv.lienAnnonce}<br><br>`;
                
                // Ajouter les caract√©ristiques (Facebook ou personnalis√©es)
                const caracteristiquesParsed = formatCaracteristiquesForDisplay(rdv.modele);
                if (caracteristiquesParsed.caracteristiques && caracteristiquesParsed.caracteristiques.length > 0) {
                    const caracteristiques = caracteristiquesParsed.caracteristiques
                        .map(c => `<b>${c.label} :</b> ${c.value}`)
                        .join('<br>');
                    description += caracteristiques + '<br><br>';
                } else if (rdv.source === 'Facebook' && rdv.facebookCaracteristiquesFormatees) {
                    // Fallback pour anciens formats Facebook
                    const caracteristiques = rdv.facebookCaracteristiquesFormatees.split('\n').map(line => {
                        if (line.includes(':')) {
                            const [label, value] = line.split(':').map(s => s.trim());
                            return `<b>${label} :</b> ${value}`;
                        }
                        return line;
                    }).join('<br>');
                    description += caracteristiques + '<br><br>';
                }
                
                // Ajouter "Rendez-vous initial" si le RDV a √©t√© report√©
                if (rdv.motifDeplacement && rdv.oldDate && rdv.oldHeure) {
                    const oldDate = new Date(rdv.oldDate);
                    const formattedOldDate = oldDate.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });
                    description += `<b>Rendez-vous initial :</b> ${formattedOldDate} √† ${rdv.oldHeure}<br><br>`;
                }
                
                // Modification pour afficher "Motif d'annulation" si annul√©
                const labelMotif = rdv.statut === 'annule' ? "Motif d'annulation" : "Motif";
                if (rdv.motif) description += `<b>${labelMotif} :</b> ${rdv.motif}<br><br>`;
                
                if (rdv.motifDeplacement) description += `<b>Motif report :</b> ${rdv.motifDeplacement}`;

                const eventPayload = {
                    summary: titre,
                    location: agence ? agence.nom : '',
                    description: description,
                    start: { dateTime: startDateTime },
                    end: { dateTime: endDateTime },
                    colorId: agendaColor
                };

                // Appel DIRECT √† Google
                const response = await fetch(`https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calendarId)}/events`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(eventPayload)
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error?.message || "Erreur Google API");
                }

                const data = await response.json();
                console.log("‚úÖ RDV cr√©√© via API Directe, ID:", data.id);
                
                // IMPORTANT : On retourne le VRAI ID Google pour pouvoir le supprimer plus tard
                return { id: data.id, eventId: data.id };
            };

            // 2. MISE √Ä JOUR (Utilise PATCH pour √©viter les doublons)
            const updateGoogleCalendarEvent = async (rdv) => {
                const token = getActiveGoogleToken();
                if (!token) return;
                
                // Si c'est un ancien RDV (robot), on le recr√©e car on ne peut pas le modifier proprement
                if (!rdv.googleCalendarEventId || rdv.googleCalendarEventId.startsWith('evt_robot_')) {
                    console.warn("Ancien format d√©tect√©, on recr√©e l'√©v√©nement...");
                    return await createGoogleCalendarEvent(rdv);
                }

                const agence = agences.value.find(a => a.id === rdv.agenceId);
                const calendarId = (agence?.agendaEmail && agence.agendaEmail.trim()) ? agence.agendaEmail.trim() : 'primary';

               // 1. DATES
                let startDateTime, endDateTime;
                if (rdv.date && rdv.heure) {
                    const [year, month, day] = rdv.date.split('-').map(Number);
                    const [hours, minutes] = rdv.heure.split(':').map(Number);
                    const rdvDate = new Date(year, month - 1, day, hours, minutes, 0);
                    const endDate = new Date(rdvDate);
                    endDate.setHours(endDate.getHours() + 1);
                    startDateTime = rdvDate.toISOString();
                    endDateTime = endDate.toISOString();
                }

                // 2. COULEUR (Rouge '11' si annul√©, sinon couleur agence)
                const agendaColor = rdv.statut === 'annule' ? '11' : (agence?.agendaColor || '10');

                // 3. TITRE
                let prefixTitre = '';
                if (rdv.statut === 'annule') prefixTitre = '[ANNUL√â] ';
                const baseModeleTitre = getBaseModele(rdv.modele) || rdv.modele || '';
                const titre = `${prefixTitre}C&N - ${rdv.civilite || ''} ${rdv.nom || ''} - ${rdv.telephone || ''} - ${baseModeleTitre}`;

                // 4. DESCRIPTION
                let description = '';
                
                // Ajouter le mod√®le de base du v√©hicule
                const baseModele = getBaseModele(rdv.modele);
                if (baseModele) {
                    description += `<b>V√©hicule :</b> ${baseModele}<br><br>`;
                }
                
                // Ajouter le prix si disponible
                if (rdv.prix && rdv.prix > 0) {
                    const prixFormate = Math.floor(rdv.prix).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
                    description += `<b>Prix :</b> ${prixFormate} ‚Ç¨<br><br>`;
                }
                
                if (rdv.lienAnnonce) description += `<b>Lien annonce :</b> ${rdv.lienAnnonce}<br><br>`;
                
                // Ajouter les caract√©ristiques (Facebook ou personnalis√©es)
                const caracteristiquesParsed = formatCaracteristiquesForDisplay(rdv.modele);
                if (caracteristiquesParsed.caracteristiques && caracteristiquesParsed.caracteristiques.length > 0) {
                    const caracteristiques = caracteristiquesParsed.caracteristiques
                        .map(c => `<b>${c.label} :</b> ${c.value}`)
                        .join('<br>');
                    description += caracteristiques + '<br><br>';
                } else if (rdv.source === 'Facebook' && rdv.facebookCaracteristiquesFormatees) {
                    // Fallback pour anciens formats Facebook
                    const caracteristiques = rdv.facebookCaracteristiquesFormatees.split('\n').map(line => {
                        if (line.includes(':')) {
                            const [label, value] = line.split(':').map(s => s.trim());
                            return `<b>${label} :</b> ${value}`;
                        }
                        return line;
                    }).join('<br>');
                    description += caracteristiques + '<br><br>';
                }
                
                // Ajouter "Rendez-vous initial" si le RDV a √©t√© report√©
                if (rdv.motifDeplacement && rdv.oldDate && rdv.oldHeure) {
                    const oldDate = new Date(rdv.oldDate);
                    const formattedOldDate = oldDate.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });
                    description += `<b>Rendez-vous initial :</b> ${formattedOldDate} √† ${rdv.oldHeure}<br><br>`;
                }
                
                // Si annul√©, on √©crit "Motif d'annulation", sinon "Motif"
                const labelMotif = rdv.statut === 'annule' ? "Motif d'annulation" : "Motif";
                if (rdv.motif) description += `<b>${labelMotif} :</b> ${rdv.motif}<br><br>`;
                
                if (rdv.motifDeplacement) description += `<b>Motif report :</b> ${rdv.motifDeplacement}`;

                // PATCH modifie seulement les champs n√©cessaires sans effacer le reste
                const response = await fetch(`https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calendarId)}/events/${rdv.googleCalendarEventId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        summary: titre,
                        description: description,
                        start: { dateTime: startDateTime },
                        end: { dateTime: endDateTime }
                    })
                });

                if (!response.ok) {
                    // Si l'√©v√©nement n'existe plus, on le recr√©e
                    if (response.status === 404 || response.status === 410) {
                        return await createGoogleCalendarEvent(rdv);
                    }
                    // Sinon on ignore l'erreur silencieusement ou on log
                    console.warn("Impossible de modifier l'√©v√©nement Google");
                    return; 
                }

                const data = await response.json();
                console.log("‚úÖ RDV modifi√© via API Directe !");
                return { id: data.id };
            };

            // 3. SUPPRESSION DIRECTE
            const deleteGoogleCalendarEvent = async (rdv) => {
                const token = getActiveGoogleToken();
                if (!token) return;
                
                // S√©curit√© pour les vieux RDV
                if (!rdv.googleCalendarEventId || rdv.googleCalendarEventId.startsWith('evt_robot_')) {
                    alert("‚ö†Ô∏è Cet √©v√©nement date de l'ancien syst√®me. Veuillez le supprimer manuellement de Google Agenda (une seule fois).");
                    return;
                }

                const agence = agences.value.find(a => a.id === rdv.agenceId);
                const calendarId = (agence?.agendaEmail && agence.agendaEmail.trim()) ? agence.agendaEmail.trim() : 'primary';

                const response = await fetch(`https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calendarId)}/events/${rdv.googleCalendarEventId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok || response.status === 404 || response.status === 410) {
                    console.log("‚úÖ RDV supprim√© de Google Agenda");
                } else {
                    console.error("Erreur suppression", await response.json());
                    alert("Erreur lors de la suppression sur Google Agenda.");
                }
            };
            // G√©rer le clic sur le bouton "Agenda" dans la liste des confirmations
            const handleAddToAgendaClick = async (rdv) => {
                // V√©rifier d'abord si le token est vraiment valide
                const isTokenValid = await checkGoogleCalendarTokenValid();
                const isConnected = isGoogleCalendarConnected.value && isTokenValid;
                
                if (!isConnected) {
                    // Afficher le modal de reconnexion
                    reconnectAgendaModal.rdv = rdv;
                    reconnectAgendaModal.open = true;
                    return;
                }
                
                // Si connect√©, ajouter directement √† l'agenda
                await addToAgenda(rdv);
            };
            
            // G√©rer la reconnexion et ajout automatique √† l'agenda
            const handleReconnectForAgenda = async (rdv) => {
                reconnectAgendaModal.open = false;
                
             // Se reconnecter
                if (user.role === 'admin') {
                    connectGoogleCalendar();
                } else {
                    // Pour les prospecteurs, utiliser la fonction existante qui g√®re d√©j√† le choix du compte
                    connectProspecteurGoogleCalendar();
                }
                
                // Attendre un peu que la connexion soit √©tablie
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                // V√©rifier si on est maintenant connect√©
                const isTokenValid = await checkGoogleCalendarTokenValid();
                const isConnected = isGoogleCalendarConnected.value && isTokenValid;
                
                if (isConnected && rdv) {
                    // Ajouter automatiquement √† l'agenda
                    try {
                        await addToAgenda(rdv);
                        showNotification('‚úÖ C\'est bon, c\'est plac√© dans l\'agenda !', 'success', 'fa-calendar-check');
                    } catch (err) {
                        console.error('Erreur ajout automatique:', err);
                    }
                }
            };
            
            // Ajouter un rendez-vous √† l'agenda Google
            const addToAgenda = async (rdv) => {
                try {
                    // V√©rifier d'abord si le token est vraiment valide
                    const isTokenValid = await checkGoogleCalendarTokenValid();
                    if (!isTokenValid || !isGoogleCalendarConnected.value) {
                        // Afficher le modal de reconnexion au lieu d'alert
                        reconnectAgendaModal.rdv = rdv;
                        reconnectAgendaModal.open = true;
                        return;
                    }
                    
                    const eventResult = await createGoogleCalendarEvent(rdv);
                    
                    // Mettre √† jour le RDV dans Firestore
                    await db.collection('rendezvous').doc(rdv.id).update({
                        dansAgenda: true,
                        googleCalendarEventId: eventResult.id || eventResult.eventId,
                        enAttenteAgenda: false
                    });
                    
                    // Mettre √† jour localement
                    rdv.dansAgenda = true;
                    rdv.googleCalendarEventId = eventResult.id || eventResult.eventId;
                    if (rdv.enAttenteAgenda !== undefined) rdv.enAttenteAgenda = false;
                    
                    if (clientModal.rdv && clientModal.rdv.id === rdv.id) {
                        clientModal.rdv.dansAgenda = true;
                        clientModal.rdv.googleCalendarEventId = eventResult.id || eventResult.eventId;
                        if (clientModal.rdv.enAttenteAgenda !== undefined) clientModal.rdv.enAttenteAgenda = false;
                    }
                    
                    showNotification('‚úÖ Rendez-vous ajout√© √† l\'agenda avec succ√®s !', 'success', 'fa-calendar-check');
                } catch (err) {
                    console.error('Erreur lors de l\'ajout √† l\'agenda:', err);
                    
                    // D√©tecter les erreurs de token (401, 403)
                    const errorMessage = err.message || '';
                    const isTokenError = errorMessage.includes('401') || 
                                       errorMessage.includes('403') || 
                                       errorMessage.includes('Invalid Credentials') ||
                                       errorMessage.includes('expired') ||
                                       errorMessage.includes('token');
                    
                    if (isTokenError) {
                        // Afficher le modal de reconnexion
                        reconnectAgendaModal.rdv = rdv;
                        reconnectAgendaModal.open = true;
                    } else {
                        alert('‚ùå Erreur lors de l\'ajout √† l\'agenda : ' + errorMessage);
                    }
                }
            };
            
            // G√©rer le clic sur "Retirer de l'agenda" avec v√©rification de connexion
            const handleRemoveFromAgendaClick = async (rdv) => {
                // V√©rifier d'abord si le token est vraiment valide
                const isTokenValid = await checkGoogleCalendarTokenValid();
                const isConnected = isGoogleCalendarConnected.value && isTokenValid;
                
                if (!isConnected) {
                    // Afficher le modal de reconnexion
                    reconnectAgendaModal.rdv = rdv;
                    reconnectAgendaModal.open = true;
                    return;
                }
                
                // Si connect√©, ouvrir le modal de confirmation
                removeAgendaConfirmModal.rdv = rdv;
                removeAgendaConfirmModal.open = true;
            };
            
            // Confirmer la suppression de l'agenda
            const confirmRemoveFromAgenda = async () => {
                if (!removeAgendaConfirmModal.rdv) return;
                await removeFromAgenda(removeAgendaConfirmModal.rdv);
            };
            
            // Charger les fermetures depuis Firestore
            const loadFermetures = async () => {
                try {
                    const fermeturesSnapshot = await db.collection('fermetures')
                        .where('dateFin', '>=', new Date().toISOString().split('T')[0])
                        .orderBy('dateFin', 'asc')
                        .get();
                    
                    fermeturesList.value = fermeturesSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                } catch (err) {
                    console.error('Erreur chargement fermetures:', err);
                }
            };
            
            // Cr√©er une fermeture et les √©v√©nements Google Calendar pour tous les professionnels
            const createFermeture = async () => {
                try {
                    if (!fermetureModal.dateDebut || !fermetureModal.dateFin) {
                        showNotification('Veuillez remplir les dates de d√©but et de fin', 'error', 'fa-exclamation-triangle');
                        return;
                    }
                    
                    // V√©rifier que la date de fin est apr√®s la date de d√©but
                    if (fermetureModal.dateFin < fermetureModal.dateDebut) {
                        showNotification('La date de fin doit √™tre apr√®s la date de d√©but', 'error', 'fa-exclamation-triangle');
                        return;
                    }
                    
                    // R√©cup√©rer tous les professionnels (agences avec agendaEmail)
                    const professionnelsAvecAgenda = agences.value.filter(ag => ag.agendaEmail && ag.agendaEmail.trim());
                    
                    if (professionnelsAvecAgenda.length === 0) {
                        showNotification('Aucun professionnel avec agenda configur√©', 'error', 'fa-exclamation-triangle');
                        return;
                    }
                    
                    // V√©rifier la connexion Google Calendar
                    const token = getActiveGoogleToken();
                    if (!token) {
                        showNotification('Vous devez √™tre connect√© √† Google Calendar pour cr√©er une fermeture', 'error', 'fa-exclamation-triangle');
                        // Proposer de se connecter via le modal de reconnexion
                        if (user.role === 'admin') {
                            setTimeout(() => {
                                reconnectAgendaModal.open = true;
                            }, 500);
                        }
                        return;
                    }
                    
                    // Cr√©er les √©v√©nements pour chaque professionnel
                    const eventIds = [];
                    const motif = fermetureModal.motif ? fermetureModal.motif.trim() : '';
                    const titre = 'C&N FERM√â'; // Titre sans motif
                    const description = motif ? `<b>Motif :</b> ${motif}` : ''; // Motif uniquement dans la description
                    
                    // Calculer toutes les dates entre dateDebut et dateFin (inclus)
                    const dates = [];
                    const startDate = new Date(fermetureModal.dateDebut);
                    const endDate = new Date(fermetureModal.dateFin);
                    
                    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                        dates.push(new Date(d).toISOString().split('T')[0]);
                    }
                    
                    // Pour chaque professionnel et chaque date, cr√©er un √©v√©nement toute la journ√©e
                    for (const agence of professionnelsAvecAgenda) {
                        const calendarId = agence.agendaEmail.trim();
                        
                        for (const date of dates) {
                            try {
                                const eventPayload = {
                                    summary: titre,
                                    description: description,
                                    start: { date: date }, // Toute la journ√©e
                                    end: { date: date }, // Toute la journ√©e
                                    colorId: '11' // Rouge pour fermeture
                                };
                                
                                const response = await fetch(`https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calendarId)}/events`, {
                                    method: 'POST',
                                    headers: {
                                        'Authorization': `Bearer ${token}`,
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify(eventPayload)
                                });
                                
                                if (!response.ok) {
                                    const err = await response.json();
                                    console.error(`Erreur cr√©ation √©v√©nement pour ${agence.nom} le ${date}:`, err);
                                    continue;
                                }
                                
                                const data = await response.json();
                                eventIds.push({
                                    calendarId: calendarId,
                                    eventId: data.id,
                                    date: date,
                                    agenceNom: agence.nom
                                });
                            } catch (err) {
                                console.error(`Erreur cr√©ation √©v√©nement pour ${agence.nom} le ${date}:`, err);
                            }
                        }
                    }
                    
                    // Sauvegarder la fermeture dans Firestore
                    const fermetureData = {
                        dateDebut: fermetureModal.dateDebut,
                        dateFin: fermetureModal.dateFin,
                        motif: motif,
                        tousProfessionnels: true,
                        eventIds: eventIds,
                        createdAt: new Date().toISOString()
                    };
                    
                    // Fermer le modal imm√©diatement pour am√©liorer l'UX
                    fermetureModal.open = false;
                    const dateDebutTemp = fermetureModal.dateDebut;
                    const dateFinTemp = fermetureModal.dateFin;
                    const motifTemp = fermetureModal.motif;
                    
                    // R√©initialiser le modal
                    fermetureModal.dateDebut = '';
                    fermetureModal.dateFin = '';
                    fermetureModal.motif = '';
                    fermetureModal.tousProfessionnels = false;
                    
                    // Cr√©er la fermeture en arri√®re-plan
                    await db.collection('fermetures').add(fermetureData);
                    
                    showNotification(`Fermeture cr√©√©e pour ${dates.length} jour(s) dans ${professionnelsAvecAgenda.length} agenda(s)`, 'success', 'fa-calendar-check');
                    
                    // Recharger la liste
                    await loadFermetures();
                } catch (err) {
                    console.error('Erreur cr√©ation fermeture:', err);
                    showNotification('Erreur lors de la cr√©ation de la fermeture', 'error', 'fa-exclamation-triangle');
                }
            };
            
            // Ouvrir le modal en mode √©dition
            const editFermeture = (ferm) => {
                fermetureModal.editingId = ferm.id;
                fermetureModal.dateDebut = ferm.dateDebut || '';
                fermetureModal.dateFin = ferm.dateFin || '';
                fermetureModal.motif = ferm.motif || '';
                fermetureModal.tousProfessionnels = ferm.tousProfessionnels !== undefined ? ferm.tousProfessionnels : true;
                fermetureModal.professionnels = ferm.professionnels || [];
                fermetureModal.open = true;
            };
            
            // Mettre √† jour une fermeture et ses √©v√©nements Google Calendar
            const updateFermeture = async () => {
                try {
                    if (!fermetureModal.dateDebut || !fermetureModal.dateFin) {
                        showNotification('Veuillez remplir les dates de d√©but et de fin', 'error', 'fa-exclamation-triangle');
                        return;
                    }
                    
                    if (!fermetureModal.editingId) {
                        showNotification('Erreur: ID de fermeture manquant', 'error', 'fa-exclamation-triangle');
                        return;
                    }
                    
                    // V√©rifier que la date de fin est apr√®s la date de d√©but
                    if (fermetureModal.dateFin < fermetureModal.dateDebut) {
                        showNotification('La date de fin doit √™tre apr√®s la date de d√©but', 'error', 'fa-exclamation-triangle');
                        return;
                    }
                    
                    // R√©cup√©rer l'ancienne fermeture
                    const oldFermetureDoc = await db.collection('fermetures').doc(fermetureModal.editingId).get();
                    if (!oldFermetureDoc.exists) {
                        showNotification('Fermeture introuvable', 'error', 'fa-exclamation-triangle');
                        return;
                    }
                    
                    const oldFermeture = oldFermetureDoc.data();
                    const oldEventIds = oldFermeture.eventIds || [];
                    
                    // V√©rifier la connexion Google Calendar
                    const token = getActiveGoogleToken();
                    if (!token) {
                        showNotification('Vous devez √™tre connect√© √† Google Calendar pour modifier une fermeture', 'error', 'fa-exclamation-triangle');
                        if (user.role === 'admin') {
                            setTimeout(() => {
                                reconnectAgendaModal.open = true;
                            }, 500);
                        }
                        return;
                    }
                    
                    // Supprimer les anciens √©v√©nements Google Calendar
                    if (oldEventIds.length > 0) {
                        for (const eventInfo of oldEventIds) {
                            try {
                                if (eventInfo.calendarId && eventInfo.eventId) {
                                    await fetch(`https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(eventInfo.calendarId)}/events/${eventInfo.eventId}`, {
                                        method: 'DELETE',
                                        headers: {
                                            'Authorization': `Bearer ${token}`
                                        }
                                    });
                                }
                            } catch (err) {
                                console.error(`Erreur suppression ancien √©v√©nement ${eventInfo.eventId}:`, err);
                            }
                        }
                    }
                    
                    // R√©cup√©rer tous les professionnels (agences avec agendaEmail)
                    const professionnelsAvecAgenda = agences.value.filter(ag => ag.agendaEmail && ag.agendaEmail.trim());
                    
                    if (professionnelsAvecAgenda.length === 0) {
                        showNotification('Aucun professionnel avec agenda configur√©', 'error', 'fa-exclamation-triangle');
                        return;
                    }
                    
                    // Cr√©er les nouveaux √©v√©nements
                    const eventIds = [];
                    const motif = fermetureModal.motif ? fermetureModal.motif.trim() : '';
                    const titre = 'C&N FERM√â';
                    const description = motif ? `<b>Motif :</b> ${motif}` : '';
                    
                    // Calculer toutes les dates entre dateDebut et dateFin (inclus)
                    const dates = [];
                    const startDate = new Date(fermetureModal.dateDebut);
                    const endDate = new Date(fermetureModal.dateFin);
                    
                    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                        dates.push(new Date(d).toISOString().split('T')[0]);
                    }
                    
                    // Pour chaque professionnel et chaque date, cr√©er un √©v√©nement toute la journ√©e
                    for (const agence of professionnelsAvecAgenda) {
                        const calendarId = agence.agendaEmail.trim();
                        
                        for (const date of dates) {
                            try {
                                const eventPayload = {
                                    summary: titre,
                                    description: description,
                                    start: { date: date },
                                    end: { date: date },
                                    colorId: '11' // Rouge pour fermeture
                                };
                                
                                const response = await fetch(`https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calendarId)}/events`, {
                                    method: 'POST',
                                    headers: {
                                        'Authorization': `Bearer ${token}`,
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify(eventPayload)
                                });
                                
                                if (!response.ok) {
                                    const err = await response.json();
                                    console.error(`Erreur cr√©ation √©v√©nement pour ${agence.nom} le ${date}:`, err);
                                    continue;
                                }
                                
                                const data = await response.json();
                                eventIds.push({
                                    calendarId: calendarId,
                                    eventId: data.id,
                                    date: date,
                                    agenceNom: agence.nom
                                });
                            } catch (err) {
                                console.error(`Erreur cr√©ation √©v√©nement pour ${agence.nom} le ${date}:`, err);
                            }
                        }
                    }
                    
                    // Mettre √† jour la fermeture dans Firestore
                    const fermetureData = {
                        dateDebut: fermetureModal.dateDebut,
                        dateFin: fermetureModal.dateFin,
                        motif: motif,
                        tousProfessionnels: true,
                        eventIds: eventIds,
                        updatedAt: new Date().toISOString()
                    };
                    
                    await db.collection('fermetures').doc(fermetureModal.editingId).update(fermetureData);
                    
                    showNotification(`Fermeture mise √† jour pour ${dates.length} jour(s) dans ${professionnelsAvecAgenda.length} agenda(s)`, 'success', 'fa-calendar-check');
                    
                    // Fermer et r√©initialiser le modal
                    fermetureModal.open = false;
                    fermetureModal.dateDebut = '';
                    fermetureModal.dateFin = '';
                    fermetureModal.motif = '';
                    fermetureModal.tousProfessionnels = false;
                    fermetureModal.editingId = null;
                    
                    // Recharger la liste
                    await loadFermetures();
                } catch (err) {
                    console.error('Erreur mise √† jour fermeture:', err);
                    showNotification('Erreur lors de la mise √† jour de la fermeture', 'error', 'fa-exclamation-triangle');
                }
            };
            
            // Ouvrir le modal de confirmation pour supprimer une fermeture
            const deleteFermeture = (id) => {
                fermetureDeleteConfirmModal.fermetureId = id;
                fermetureDeleteConfirmModal.open = true;
            };
            
            // Confirmer et supprimer une fermeture et ses √©v√©nements Google Calendar
            const confirmDeleteFermeture = async () => {
                try {
                    const id = fermetureDeleteConfirmModal.fermetureId;
                    if (!id) {
                        fermetureDeleteConfirmModal.open = false;
                        return;
                    }
                    
                    // Fermer le modal imm√©diatement
                    fermetureDeleteConfirmModal.open = false;
                    fermetureDeleteConfirmModal.fermetureId = null;
                    
                    // R√©cup√©rer la fermeture
                    const fermetureDoc = await db.collection('fermetures').doc(id).get();
                    if (!fermetureDoc.exists) {
                        showNotification('Fermeture introuvable', 'error', 'fa-exclamation-triangle');
                        return;
                    }
                    
                    const fermeture = fermetureDoc.data();
                    const eventIds = fermeture.eventIds || [];
                    
                    // V√©rifier la connexion Google Calendar pour supprimer les √©v√©nements
                    const token = getActiveGoogleToken();
                    if (!token && eventIds.length > 0) {
                        showNotification('Vous devez √™tre connect√© √† Google Calendar pour supprimer les √©v√©nements', 'error', 'fa-exclamation-triangle');
                        // Proposer de se connecter
                        if (user.role === 'admin') {
                            setTimeout(() => {
                                reconnectAgendaModal.open = true;
                            }, 500);
                        }
                        return;
                    }
                    
                    // Supprimer la fermeture de Firestore d'abord
                    await db.collection('fermetures').doc(id).delete();
                    
                    if (eventIds.length === 0) {
                        showNotification('Fermeture supprim√©e', 'success', 'fa-calendar-times');
                        await loadFermetures();
                        return;
                    }
                    
                    // Supprimer tous les √©v√©nements Google Calendar en arri√®re-plan
                    let deletedCount = 0;
                    for (const eventInfo of eventIds) {
                        try {
                            if (!eventInfo.calendarId || !eventInfo.eventId) {
                                console.warn('EventInfo incomplet:', eventInfo);
                                continue;
                            }
                            
                            const response = await fetch(`https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(eventInfo.calendarId)}/events/${eventInfo.eventId}`, {
                                method: 'DELETE',
                                headers: {
                                    'Authorization': `Bearer ${token}`
                                }
                            });
                            
                            if (response.ok || response.status === 404) {
                                deletedCount++;
                            } else {
                                const errorText = await response.text();
                                console.error(`Erreur suppression √©v√©nement ${eventInfo.eventId}:`, errorText);
                            }
                        } catch (err) {
                            console.error(`Erreur suppression √©v√©nement ${eventInfo.eventId}:`, err);
                        }
                    }
                    
                    showNotification(`Fermeture supprim√©e (${deletedCount}/${eventIds.length} √©v√©nements retir√©s)`, 'success', 'fa-calendar-times');
                    await loadFermetures();
                } catch (err) {
                    console.error('Erreur suppression fermeture:', err);
                    showNotification('Erreur lors de la suppression de la fermeture', 'error', 'fa-exclamation-triangle');
                }
            };
            
            // Retirer un rendez-vous de l'agenda Google
            const removeFromAgenda = async (rdv) => {
                try {
                    if (!googleCalendarConnected.value || !googleAccessToken.value) {
                        alert('‚ö†Ô∏è Vous n\'√™tes pas connect√© √† Google Calendar.');
                        return;
                    }
                    
                    // Activer l'indicateur de chargement
                    if (clientModal.rdv && clientModal.rdv.id === rdv.id) {
                        clientModal.removingFromAgenda = true;
                    }
                    
                    // Supprimer l'√©v√©nement Google Calendar si l'ID existe
                    if (rdv.googleCalendarEventId) {
                        try {
                            await deleteGoogleCalendarEvent(rdv);
                            console.log('‚úÖ √âv√©nement supprim√© de Google Calendar');
                        } catch (deleteErr) {
                            // Si l'√©v√©nement n'existe plus (404), c'est OK
                            if (deleteErr.message && !deleteErr.message.includes('404') && !deleteErr.message.includes('not found')) {
                                console.warn('‚ö†Ô∏è Erreur lors de la suppression de l\'√©v√©nement Google Calendar:', deleteErr);
                                // On continue quand m√™me pour mettre √† jour la base de donn√©es
                            } else {
                                console.log('‚ÑπÔ∏è √âv√©nement d√©j√† supprim√© ou introuvable');
                            }
                        }
                    }
                    
                    // Mettre √† jour le RDV dans Firestore
                    await db.collection('rendezvous').doc(rdv.id).update({
                        dansAgenda: false,
                        googleCalendarEventId: null
                    });
                    
                    // Mettre √† jour localement
                    rdv.dansAgenda = false;
                    rdv.googleCalendarEventId = null;
                    
                    if (clientModal.rdv && clientModal.rdv.id === rdv.id) {
                        clientModal.rdv.dansAgenda = false;
                        clientModal.rdv.googleCalendarEventId = null;
                    }
                    
                    showNotification('Rendez-vous retir√© de l\'agenda avec succ√®s', 'success', 'fa-calendar-times');
                    removeAgendaConfirmModal.open = false;
                } catch (err) {
                    console.error('Erreur lors de la suppression de l\'agenda:', err);
                    showNotification('Erreur lors de la suppression', 'error', 'fa-exclamation-triangle');
                    removeAgendaConfirmModal.open = false;
                } finally {
                    // D√©sactiver l'indicateur de chargement
                    if (clientModal.rdv && clientModal.rdv.id === rdv.id) {
                        clientModal.removingFromAgenda = false;
                    }
                }
            };
            
            const copyToAgenda = async (rdv, event) => {
                try {
                    // Si connect√© √† Google Calendar, cr√©er l'√©v√©nement via l'API
                    if (googleCalendarConnected.value && googleAccessToken.value) {
                        await createGoogleCalendarEvent(rdv);
                        
                        if (event) {
                            const btn = event.target.closest('button');
                            if (btn) {
                                const originalText = btn.innerHTML;
                                btn.innerHTML = '<i class="fa-solid fa-check text-[10px]"></i> <span>Cr√©√© !</span>';
                                btn.classList.add('bg-green-100', 'text-green-700', 'border-green-300');
                                setTimeout(() => {
                                    btn.innerHTML = originalText;
                                    btn.classList.remove('bg-green-100', 'text-green-700', 'border-green-300');
                                }, 2000);
                            }
                        }
                        return;
                    }
                    
                    // Sinon, utiliser l'ancienne m√©thode (ouvrir Google Calendar)
                    const civilite = rdv.civilite || '';
                    const nom = rdv.nom || '';
                    const telephone = rdv.telephone || '';
                    const modele = rdv.modele || '';
                    const agenceNom = getAgenceName(rdv.agenceId) || '';
                    
let prefixTitre = '';
                if (rdv.statut === 'annule') prefixTitre = '[ANNUL√â] ';
                const titre = `${prefixTitre}C&N - ${civilite} ${nom} - ${telephone} - ${modele}`;                    
                    const agence = agences.value.find(a => a.id === rdv.agenceId);
                    const agendaEmail = agence?.agendaEmail || '';
                    const agendaColor = agence?.agendaColor || '3';
                    
                    let dateStart = '';
                    let dateEnd = '';
                    
                    if (rdv.date && rdv.heure) {
                        const [year, month, day] = rdv.date.split('-').map(Number);
                        const [hours, minutes] = rdv.heure.split(':').map(Number);
                        const rdvDate = new Date(year, month - 1, day, hours, minutes, 0);
                        const startDate = new Date(rdvDate);
                        const startStr = startDate.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                        const endDate = new Date(rdvDate);
                        endDate.setHours(endDate.getHours() + 1);
                        const endStr = endDate.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                        dateStart = startStr;
                        dateEnd = endStr;
                    }
                    
                    const params = new URLSearchParams();
                    // Pour les agendas partag√©s, utiliser le param√®tre src avec l'email du calendrier
                    if (agendaEmail && agendaEmail.trim() !== '') {
                        // Nettoyer l'email et l'encoder correctement
                        const cleanEmail = agendaEmail.trim();
                        params.append('src', cleanEmail);
                    }
                    params.append('action', 'TEMPLATE');
                    params.append('text', titre);
                    if (dateStart && dateEnd) {
                        params.append('dates', `${dateStart}/${dateEnd}`);
                    }
                    if (agenceNom) {
                        params.append('location', agenceNom);
                    }
                    const colorIdNum = parseInt(agendaColor) || 3;
                    if (colorIdNum >= 1 && colorIdNum <= 11) {
                        params.append('colorId', colorIdNum.toString());
                    }
                    
                    // Construire l'URL avec le param√®tre src pour l'agenda partag√©
                    const googleCalendarUrl = `https://calendar.google.com/calendar/u/0/r/eventedit?${params.toString()}`;
                    window.open(googleCalendarUrl, '_blank');
                    
                    if (event) {
                        const btn = event.target.closest('button');
                        if (btn) {
                            const originalText = btn.innerHTML;
                            btn.innerHTML = '<i class="fa-solid fa-check text-[10px]"></i> <span>Ouvert !</span>';
                            btn.classList.add('bg-green-100', 'text-green-700', 'border-green-300');
                            setTimeout(() => {
                                btn.innerHTML = originalText;
                                btn.classList.remove('bg-green-100', 'text-green-700', 'border-green-300');
                            }, 2000);
                        }
                    }
                } catch (err) {
                    console.error('Erreur Google Calendar:', err);
                    const errorMessage = err.message || 'Erreur lors de la cr√©ation de l\'√©v√©nement';
                    
                    // Afficher un message d'erreur plus clair
                    if (event) {
                        const btn = event.target.closest('button');
                        if (btn) {
                            const originalText = btn.innerHTML;
                            btn.innerHTML = '<i class="fa-solid fa-exclamation-triangle text-[10px]"></i> <span>Erreur</span>';
                            btn.classList.add('bg-red-100', 'text-red-700', 'border-red-300');
                            setTimeout(() => {
                                btn.innerHTML = originalText;
                                btn.classList.remove('bg-red-100', 'text-red-700', 'border-red-300');
                            }, 3000);
                        }
                    }
                    
                    // Afficher une alerte avec le message d'erreur d√©taill√©
                    alert('‚ùå Erreur Google Calendar\n\n' + errorMessage + '\n\nüí° V√©rifiez que :\n- L\'email de l\'agenda partag√© est correct dans les param√®tres de l\'agence\n- Vous avez les permissions d\'√©criture sur cet agenda partag√©\n- Vous √™tes bien connect√© √† Google Calendar');
                }
            };

            // Variables pour le calendrier semaine
            const getWeekStart = (date) => {
                const d = new Date(date);
                d.setHours(0, 0, 0, 0);
                const day = d.getDay();
                // Convertir dimanche (0) en 7 pour faciliter le calcul
                const dayOfWeek = day === 0 ? 7 : day;
                // Calculer le lundi de la semaine (jour 1)
                const diff = d.getDate() - dayOfWeek + 1;
                const monday = new Date(d);
                monday.setDate(diff);
                return monday;
            };

            const currentWeekStart = ref(getWeekStart(new Date()));
            const calendarEvents = ref({}); // { '2024-01-15': [{type: 'google', ...}, {type: 'rdv', ...}] }
            const calendarLoading = ref(false);
            const calendarAgencyFilter = ref('');
            const calendarHours = Array.from({length: 16}, (_, i) => {
                const hour = 8 + i;
                return `${String(hour).padStart(2, '0')}:00`;
            });

            // Navigation du calendrier
            const previousWeek = () => {
                const newDate = new Date(currentWeekStart.value);
                newDate.setDate(newDate.getDate() - 7);
                currentWeekStart.value = newDate;
                loadCalendarEvents();
            };

            const nextWeek = () => {
                const newDate = new Date(currentWeekStart.value);
                newDate.setDate(newDate.getDate() + 7);
                currentWeekStart.value = newDate;
                loadCalendarEvents();
            };

            const goToToday = () => {
                currentWeekStart.value = getWeekStart(new Date());
                loadCalendarEvents();
            };

            // Calculer les jours de la semaine
            const calendarWeekDays = computed(() => {
                const days = [];
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayStr = today.toISOString().split('T')[0];

                const dayNames = ['DIM.', 'LUN.', 'MAR.', 'MER.', 'JEU.', 'VEN.', 'SAM.'];

                // S'assurer que currentWeekStart est bien un lundi
                const weekStart = new Date(currentWeekStart.value);
                weekStart.setHours(0, 0, 0, 0);

                for (let i = 0; i < 7; i++) {
                    const date = new Date(weekStart);
                    date.setDate(weekStart.getDate() + i);
                    date.setHours(0, 0, 0, 0);
                    
                    // Utiliser toLocaleDateString pour √©viter les probl√®mes de timezone
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const dateStr = `${year}-${month}-${day}`;
                    
                    const isToday = dateStr === todayStr;
                    const dayOfWeek = date.getDay(); // 0 = dimanche, 1 = lundi, etc.

                    days.push({
                        date: dateStr,
                        dayName: dayNames[dayOfWeek],
                        dayNumber: date.getDate(),
                        isToday,
                        dayOfWeek
                    });
                }

                return days;
            });

            // R√©cup√©rer les √©v√©nements Google Calendar
            const fetchGoogleCalendarEvents = async () => {
                if (!googleAccessToken.value) return;

                calendarLoading.value = true;
                try {
                    // R√©cup√©rer les agendas selon le filtre
                    const calendarIds = [];
                    
                    if (calendarAgencyFilter.value) {
                        // Si un filtre d'agence est s√©lectionn√©, utiliser UNIQUEMENT cet agenda
                        const agence = agences.value.find(a => a.id === calendarAgencyFilter.value);
                        if (agence && agence.agendaEmail && agence.agendaEmail.trim()) {
                            calendarIds.push(agence.agendaEmail.trim());
                        } else {
                            // Si l'agence n'a pas d'email sp√©cifique, utiliser primary
                            calendarIds.push('primary');
                        }
                    } else {
                        // Sinon, r√©cup√©rer tous les agendas partag√©s
                        calendarIds.push('primary');
                        agences.value.forEach(agence => {
                            if (agence.agendaEmail && agence.agendaEmail.trim()) {
                                calendarIds.push(agence.agendaEmail.trim());
                            }
                        });
                    }

                    // Calculer la plage de dates (semaine en cours)
                    const startDate = new Date(currentWeekStart.value);
                    startDate.setHours(0, 0, 0, 0);
                    const endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 7);
                    endDate.setHours(23, 59, 59, 999);
                    
                    const timeMin = startDate.toISOString();
                    const timeMax = endDate.toISOString();

                    const allEvents = [];
                    const allGoogleEvents = []; // Pour la synchronisation des statuts

                    // R√©cup√©rer les √©v√©nements de chaque calendrier
                    for (const calendarId of calendarIds) {
                        try {
                            const encodedId = encodeURIComponent(calendarId);
                            const url = `https://www.googleapis.com/calendar/v3/calendars/${encodedId}/events?timeMin=${timeMin}&timeMax=${timeMax}&singleEvents=true&orderBy=startTime`;
                            
                            const response = await fetch(url, {
                                headers: {
                                    'Authorization': `Bearer ${googleAccessToken.value}`
                                }
                            });

                            if (response.ok) {
                                const data = await response.json();
                                if (data.items) {
                                    // Ajouter tous les √©v√©nements pour la synchronisation
                                    allGoogleEvents.push(...data.items);
                                    
                                    data.items.forEach(event => {
                                        const start = event.start?.dateTime || event.start?.date;
                                        if (start) {
                                            const eventDate = new Date(start);
                                            // Utiliser toLocaleDateString pour √©viter les probl√®mes de timezone
                                            const year = eventDate.getFullYear();
                                            const month = String(eventDate.getMonth() + 1).padStart(2, '0');
                                            const day = String(eventDate.getDate()).padStart(2, '0');
                                            const dateStr = `${year}-${month}-${day}`;
                                            
                                            if (!allEvents[dateStr]) {
                                                allEvents[dateStr] = [];
                                            }
                                            
                                            // Filtrer par agence si un filtre est actif
                                            if (calendarAgencyFilter.value) {
                                                const agence = agences.value.find(a => a.id === calendarAgencyFilter.value);
                                                // Ne garder que les √©v√©nements de l'agence s√©lectionn√©e
                                                if (agence && agence.agendaEmail && agence.agendaEmail.trim() === calendarId) {
                                                    allEvents[dateStr].push({
                                                        type: 'google',
                                                        id: event.id,
                                                        summary: event.summary || 'Sans titre',
                                                        start: event.start,
                                                        end: event.end,
                                                        location: event.location || '',
                                                        color: getCalendarColor(parseInt(agence.agendaColor || '3'))
                                                    });
                                                }
                                            } else {
                                                // Si pas de filtre, afficher tous les √©v√©nements
                                                allEvents[dateStr].push({
                                                    type: 'google',
                                                    id: event.id,
                                                    summary: event.summary || 'Sans titre',
                                                    start: event.start,
                                                    end: event.end,
                                                    location: event.location || '',
                                                    color: getCalendarColor(parseInt(agences.value.find(a => a.agendaEmail === calendarId)?.agendaColor || '3'))
                                                });
                                            }
                                        }
                                    });
                                }
                            }
                        } catch (err) {
                            console.warn(`Erreur lors de la r√©cup√©ration du calendrier ${calendarId}:`, err);
                        }
                    }

                    // Mettre √† jour les √©v√©nements (remplacer les anciens √©v√©nements Google)
                    Object.keys(allEvents).forEach(dateStr => {
                        if (!calendarEvents.value[dateStr]) {
                            calendarEvents.value[dateStr] = [];
                        }
                        // Supprimer les anciens √©v√©nements Google et ajouter les nouveaux
                        calendarEvents.value[dateStr] = [
                            ...calendarEvents.value[dateStr].filter(e => e.type !== 'google'),
                            ...allEvents[dateStr]
                        ];
                    });

                } catch (err) {
                    console.error('Erreur lors de la r√©cup√©ration des √©v√©nements Google Calendar:', err);
                } finally {
                    calendarLoading.value = false;
                }
            };

            const saveSyncSettings = async () => {
                try {
                    await db.collection('settings').doc('calendar_sync').set({
                        syncAfterRdvTime: syncSettings.syncAfterRdvTime,
                        syncInterval: syncSettings.syncInterval,
                        updatedAt: new Date().toISOString()
                    }, { merge: true });
                } catch (err) {
                    console.error('Erreur lors de la sauvegarde des r√©glages de synchronisation:', err);
                }
            };

            // Fonction de synchronisation manuelle (pour forcer la synchronisation imm√©diatement)
            const manualSyncGoogleCalendar = async () => {
                if (!googleCalendarConnected.value || !googleAccessToken.value) {
                    alert('Google Calendar n\'est pas connect√©.');
                    return;
                }

                try {
                    // Afficher un indicateur de chargement
                    const loadingMsg = 'Synchronisation en cours...';
                    console.log(loadingMsg);

                    // R√©cup√©rer les √©v√©nements des 7 derniers jours et 7 prochains jours
                    const now = new Date();
                    const startDate = new Date(now);
                    startDate.setDate(startDate.getDate() - 7);
                    startDate.setHours(0, 0, 0, 0);
                    const endDate = new Date(now);
                    endDate.setDate(endDate.getDate() + 7);
                    endDate.setHours(23, 59, 59, 999);
                    
                    const timeMin = startDate.toISOString();
                    const timeMax = endDate.toISOString();
                    
                    // R√©cup√©rer tous les calendriers
                    const calendarIds = ['primary'];
                    agences.value.forEach(agence => {
                        if (agence.agendaEmail && agence.agendaEmail.trim()) {
                            calendarIds.push(agence.agendaEmail.trim());
                        }
                    });
                    
                    const allGoogleEvents = [];
                    for (const calendarId of calendarIds) {
                        try {
                            const encodedId = encodeURIComponent(calendarId);
                            const url = `https://www.googleapis.com/calendar/v3/calendars/${encodedId}/events?timeMin=${timeMin}&timeMax=${timeMax}&singleEvents=true&orderBy=startTime`;
                            
                            const response = await fetch(url, {
                                headers: {
                                    'Authorization': `Bearer ${googleAccessToken.value}`
                                }
                            });
                            
                            if (response.ok) {
                                const data = await response.json();
                                if (data.items) {
                                    allGoogleEvents.push(...data.items);
                                }
                            }
                        } catch (err) {
                            console.warn(`Erreur synchronisation calendrier ${calendarId}:`, err);
                        }
                    }
                    
                    alert('‚úÖ Synchronisation termin√©e !');
                    console.log('‚úÖ Synchronisation manuelle Google Calendar effectu√©e');
                } catch (err) {
                    console.error('Erreur synchronisation manuelle:', err);
                    alert('‚ùå Erreur lors de la synchronisation. V√©rifiez la console pour plus de d√©tails.');
                }
            };

            // Charger les √©v√©nements du calendrier (Google + RDV)
            const loadCalendarEvents = () => {
                // R√©initialiser les √©v√©nements pour la semaine en cours
                const startDate = new Date(currentWeekStart.value);
                startDate.setHours(0, 0, 0, 0);
                const endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 7);
                
                // Nettoyer les anciens √©v√©nements qui ne sont plus dans la plage
                Object.keys(calendarEvents.value).forEach(dateStr => {
                    const date = new Date(dateStr);
                    if (date < startDate || date >= endDate) {
                        delete calendarEvents.value[dateStr];
                    }
                });

                // Charger les RDV de l'application avec filtre d'agence
                rdvList.value.forEach(rdv => {
                    if (rdv.date && rdv.statut !== 'poubelle') {
                        // Filtrer par agence si un filtre est s√©lectionn√©
                        if (calendarAgencyFilter.value && rdv.agenceId !== calendarAgencyFilter.value) {
                            return;
                        }

                        // Utiliser directement la date string pour √©viter les probl√®mes de timezone
                        const dateStr = rdv.date;
                        const rdvDateOnly = new Date(dateStr + 'T00:00:00');
                        const startDateOnly = new Date(startDate.toISOString().split('T')[0] + 'T00:00:00');
                        const endDateOnly = new Date(endDate.toISOString().split('T')[0] + 'T00:00:00');
                        
                        if (rdvDateOnly >= startDateOnly && rdvDateOnly < endDateOnly) {
                            if (!calendarEvents.value[dateStr]) {
                                calendarEvents.value[dateStr] = [];
                            }
                            // V√©rifier si le RDV n'est pas d√©j√† dans la liste
                            const existingIndex = calendarEvents.value[dateStr].findIndex(e => e.type === 'rdv' && e.id === rdv.id);
                            if (existingIndex >= 0) {
                                // Mettre √† jour l'√©v√©nement existant
                                calendarEvents.value[dateStr][existingIndex] = {
                                    type: 'rdv',
                                    id: rdv.id,
                                    ...rdv
                                };
                            } else {
                                // Ajouter le nouvel √©v√©nement
                                calendarEvents.value[dateStr].push({
                                    type: 'rdv',
                                    id: rdv.id,
                                    ...rdv
                                });
                            }
                        }
                    }
                });

                // Charger les √©v√©nements Google Calendar si connect√©
                if (googleCalendarConnected.value) {
                    fetchGoogleCalendarEvents();
                }
            };

            const refreshCalendarEvents = () => {
                calendarEvents.value = {};
                loadCalendarEvents();
            };

            // Obtenir les horaires pour un jour sp√©cifique
            const getDayHours = (agence, dateStr) => {
                if (!agence) return null;
                
                const date = new Date(dateStr + 'T00:00:00');
                const dayIndex = date.getDay(); // 0 = dimanche, 1 = lundi, etc.
                // Convertir dimanche (0) en 6 pour correspondre √† notre index
                const adjustedDayIndex = dayIndex === 0 ? 6 : dayIndex - 1;
                
                // V√©rifier si des horaires sp√©cifiques existent pour ce jour
                const dayOpen = agence[`horaires_${adjustedDayIndex}_ouverture`];
                const dayClose = agence[`horaires_${adjustedDayIndex}_fermeture`];
                
                if (dayOpen && dayClose) {
                    return { open: dayOpen, close: dayClose };
                }
                
                // Sinon utiliser les horaires par d√©faut
                if (agence.heureOuverture && agence.heureFermeture) {
                    return { open: agence.heureOuverture, close: agence.heureFermeture };
                }
                
                return null;
            };

            // V√©rifier si un cr√©neau est dans une p√©riode de fermeture
            const isClosedSlot = (dateStr, hourStr) => {
                if (!calendarAgencyFilter.value) return false;
                
                const agence = agences.value.find(a => a.id === calendarAgencyFilter.value);
                if (!agence) return false;
                
                const dayHours = getDayHours(agence, dateStr);
                if (!dayHours) return false;
                
                const [hour, minute] = hourStr.split(':').map(Number);
                const [openHour, openMinute] = dayHours.open.split(':').map(Number);
                const [closeHour, closeMinute] = dayHours.close.split(':').map(Number);
                
                const currentTime = hour * 60 + minute;
                const openTime = openHour * 60 + openMinute;
                const closeTime = closeHour * 60 + closeMinute;
                
                // V√©rifier si c'est avant l'ouverture ou apr√®s la fermeture
                if (currentTime < openTime || currentTime >= closeTime) {
                    return true;
                }
                
                // V√©rifier si c'est pendant la pause d√©jeuner
                if (agence.heurePauseDebut && agence.heurePauseFin) {
                    const [pauseStartHour, pauseStartMin] = agence.heurePauseDebut.split(':').map(Number);
                    const [pauseEndHour, pauseEndMin] = agence.heurePauseFin.split(':').map(Number);
                    const pauseStart = pauseStartHour * 60 + pauseStartMin;
                    const pauseEnd = pauseEndHour * 60 + pauseEndMin;
                    if (currentTime >= pauseStart && currentTime < pauseEnd) {
                        return true;
                    }
                }
                
                return false;
            };

            // Obtenir le message de fermeture pour un cr√©neau
            const getClosedMessage = (dateStr, hourStr) => {
                if (!calendarAgencyFilter.value) return '';
                
                const agence = agences.value.find(a => a.id === calendarAgencyFilter.value);
                if (!agence) return '';
                
                const dayHours = getDayHours(agence, dateStr);
                if (!dayHours) return '';
                
                const [hour, minute] = hourStr.split(':').map(Number);
                const [openHour, openMinute] = dayHours.open.split(':').map(Number);
                const [closeHour, closeMinute] = dayHours.close.split(':').map(Number);
                
                const currentTime = hour * 60 + minute;
                const openTime = openHour * 60 + openMinute;
                const closeTime = closeHour * 60 + closeMinute;
                
                if (currentTime < openTime) {
                    return `Ferm√© - Ouverture √† ${dayHours.open}`;
                }
                
                if (currentTime >= closeTime) {
                    return `Ferm√© - Fermeture √† ${dayHours.close}`;
                }
                
                if (agence.heurePauseDebut && agence.heurePauseFin) {
                    const [pauseStartHour, pauseStartMin] = agence.heurePauseDebut.split(':').map(Number);
                    const [pauseEndHour, pauseEndMin] = agence.heurePauseFin.split(':').map(Number);
                    const pauseStart = pauseStartHour * 60 + pauseStartMin;
                    const pauseEnd = pauseEndHour * 60 + pauseEndMin;
                    if (currentTime >= pauseStart && currentTime < pauseEnd) {
                        return `Ferm√© - Pause de ${agence.heurePauseDebut} √† ${agence.heurePauseFin}`;
                    }
                }
                
                return '';
            };

            // Obtenir l'heure d'ouverture pour un jour sp√©cifique (pour la ligne visuelle)
            const getOpeningTime = (day) => {
                if (!calendarAgencyFilter.value) return null;
                
                const agence = agences.value.find(a => a.id === calendarAgencyFilter.value);
                if (!agence) return null;
                
                const dayHours = getDayHours(agence, day.date);
                if (!dayHours) return null;
                
                return dayHours.open;
            };

            // Obtenir les infos d'ouverture pour l'affichage dans l'en-t√™te
            const getDayHoursInfo = (day) => {
                if (!calendarAgencyFilter.value) return null;
                
                const agence = agences.value.find(a => a.id === calendarAgencyFilter.value);
                if (!agence) return null;
                
                const dayHours = getDayHours(agence, day.date);
                if (!dayHours) return null;
                
                const pause = agence.heurePauseDebut && agence.heurePauseFin 
                    ? `${agence.heurePauseDebut} - ${agence.heurePauseFin}` 
                    : null;
                
                return {
                    open: dayHours.open,
                    close: dayHours.close,
                    pause: pause
                };
            };

            // V√©rifier si un jour est compl√®tement ferm√©
            const isDayClosed = (day) => {
                if (!calendarAgencyFilter.value) return false;
                
                const agence = agences.value.find(a => a.id === calendarAgencyFilter.value);
                if (!agence) return false;
                
                const date = new Date(day.date + 'T00:00:00');
                const dayIndex = date.getDay();
                const adjustedDayIndex = dayIndex === 0 ? 6 : dayIndex - 1;
                
                // V√©rifier si le samedi est marqu√© comme ferm√©
                if (adjustedDayIndex === 5 && agence.samediFerme) {
                    return true;
                }
                
                // V√©rifier si le dimanche est marqu√© comme ferm√©
                if (adjustedDayIndex === 6 && agence.dimancheFerme) {
                    return true;
                }
                
                return false;
            };

            // Obtenir les √©v√©nements pour un cr√©neau horaire sp√©cifique
            const getEventsForSlot = (dateStr, hourStr) => {
                const events = calendarEvents.value[dateStr] || [];
                const [hour] = hourStr.split(':').map(Number);
                
                return events.filter(event => {
                    if (event.type === 'rdv') {
                        if (!event.heure) return false;
                        const [eventHour] = event.heure.split(':').map(Number);
                        return eventHour === hour;
                    } else if (event.type === 'google') {
                        const start = event.start?.dateTime || event.start?.date;
                        if (!start) return false;
                        const eventDate = new Date(start);
                        const eventHour = eventDate.getHours();
                        return eventHour === hour;
                    }
                    return false;
                });
            };

            // Obtenir le style d'un √©v√©nement (position et taille)
            const getEventStyle = (event, dateStr, hourStr) => {
                const [hour] = hourStr.split(':').map(Number);
                let top = 0;
                let height = 60; // Hauteur par d√©faut d'un cr√©neau (1 heure)

                if (event.type === 'google') {
                    const start = new Date(event.start?.dateTime || event.start?.date);
                    const end = new Date(event.end?.dateTime || event.end?.date);
                    const startHour = start.getHours();
                    const startMinute = start.getMinutes();
                    const duration = (end - start) / (1000 * 60); // Dur√©e en minutes
                    
                    if (startHour === hour) {
                        top = (startMinute / 60) * 60;
                        height = Math.max(20, (duration / 60) * 60);
                    } else {
                        return { display: 'none' };
                    }
                } else if (event.type === 'rdv') {
                    if (event.heure) {
                        const [eventHour, eventMinute] = event.heure.split(':').map(Number);
                        if (eventHour === hour) {
                            top = (eventMinute / 60) * 60;
                        } else {
                            return { display: 'none' };
                        }
                    }
                }

                // Couleur selon le type
                let backgroundColor = '#8b5cf6';
                if (event.type === 'google') {
                    backgroundColor = event.color || '#4285f4';
                } else if (event.type === 'rdv') {
                    // Si le rendez-vous est annul√©, utiliser la couleur rouge
                    if (event.statut === 'annule') {
                        backgroundColor = '#ef4444'; // Rouge
                    } else {
                    backgroundColor = getAgenceColor(event.agenceId);
                    }
                }

                return {
                    top: `${top}px`,
                    height: `${height}px`,
                    backgroundColor: backgroundColor
                };
            };

            // Obtenir le titre d'un √©v√©nement
            const getEventTitle = (event) => {
                if (event.type === 'rdv') {
                    let title = `${event.civilite || ''} ${event.nom || ''} ${event.modele ? '- ' + event.modele : ''}`.trim();
                    // Ajouter "(ANNULE)" devant le titre si le rendez-vous est annul√©
                    if (event.statut === 'annule') {
                        title = `(ANNULE) ${title}`;
                    }
                    return title;
                } else if (event.type === 'google') {
                    return event.summary || 'Sans titre';
                }
                return '';
            };

            // Obtenir l'heure d'un √©v√©nement
            const getEventTime = (event) => {
                if (event.type === 'rdv') {
                    return event.heure || '';
                } else if (event.type === 'google') {
                    const start = event.start?.dateTime || event.start?.date;
                    if (!start) return '';
                    const date = new Date(start);
                    return date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                }
                return '';
            };

            // V√©rifier si c'est le cr√©neau horaire actuel
            const isCurrentTimeSlot = (dateStr, hourStr) => {
                const now = new Date();
                const todayStr = now.toISOString().split('T')[0];
                const [hour] = hourStr.split(':').map(Number);
                return dateStr === todayStr && now.getHours() === hour;
            };

            // Obtenir le style pour la ligne d'ouverture
            const getOpeningLineStyle = (day) => {
                const openingTime = getOpeningTime(day);
                if (!openingTime) return { display: 'none' };
                
                const [hour, minute] = openingTime.split(':').map(Number);
                // Calculer la position exacte en pixels
                // Chaque cr√©neau horaire fait 60px de haut
                // Si l'ouverture est √† 9h30, c'est 1h30 apr√®s 8h00 = 1.5 cr√©neaux = 90px
                const hoursFromStart = hour - 8;
                const minutesInPixels = (minute / 60) * 60; // Convertir les minutes en pixels
                const topPosition = (hoursFromStart * 60) + minutesInPixels;
                
                return {
                    top: `${topPosition}px`
                };
            };

            // Cr√©er un RDV depuis un cr√©neau horaire
            const createRdvFromTimeSlot = (dateStr, hourStr) => {
                const [hour, minute = 0] = hourStr.split(':').map(Number);
                const timeStr = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
                
                // Ouvrir le wizard d'abord
                startWizard();
                
                // Pr√©-remplir le formulaire apr√®s l'initialisation
                setTimeout(() => {
                    form.date = dateStr;
                    form.heure = timeStr;
                    
                    // Pr√©-s√©lectionner l'agence si un filtre est actif
                    if (calendarAgencyFilter.value) {
                        const selectedAgence = agences.value.find(a => a.id === calendarAgencyFilter.value);
                        if (selectedAgence) {
                            form.agence = selectedAgence;
                            form.agenceId = calendarAgencyFilter.value;
                            // Passer directement √† l'√©tape 2 (Informations Client) car agence, date et heure sont d√©j√† d√©finis
                            wizard.step = 2;
                        }
                    }
                }, 100);
            };

            // Ouvrir les d√©tails d'un √©v√©nement
            const openEventDetails = (event) => {
                if (event.type === 'rdv') {
                    openRdvFiche(event);
                } else {
                    // Pour les √©v√©nements Google, on pourrait ouvrir une modal ou le lien
                    alert(`${event.summary}\n\n${getEventTime(event)}\n${event.location || ''}`);
                }
            };

            // Formater le titre de la semaine
            const formatCalendarWeekTitle = () => {
                const start = new Date(currentWeekStart.value);
                const end = new Date(start);
                end.setDate(start.getDate() + 6);
                
                const startStr = start.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long' });
                const endStr = end.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });
                
                if (start.getMonth() === end.getMonth()) {
                    return `${startStr} - ${end.getDate()} ${end.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' })}`;
                }
                return `${startStr} - ${endStr}`;
            };

            // Obtenir la couleur d'une agence
            const getAgenceColor = (agenceId) => {
                const agence = agences.value.find(a => a.id === agenceId);
                if (agence && agence.agendaColor) {
                    return getCalendarColor(parseInt(agence.agendaColor));
                }
                return '#8b5cf6';
            };

            // Auto-refresh toutes les 2 minutes
            let autoRefreshInterval = null;
            
            
            watch(() => view.value, (newView) => {
                // V√©rifier le token quand on arrive sur le dashboard
                if (newView === 'dashboard' && user.role === 'admin' && googleCalendarConnected.value) {
                    // V√©rifier le token apr√®s un court d√©lai pour laisser le temps √† la page de se charger
                    setTimeout(() => {
                        checkAndUpdateTokenStatus();
                    }, 500);
                }
                
                if (newView === 'agenda') {
                    loadCalendarEvents();
                    // D√©marrer l'auto-refresh
                    if (autoRefreshInterval) clearInterval(autoRefreshInterval);
                    autoRefreshInterval = setInterval(() => {
                        if (view.value === 'agenda' && googleCalendarConnected.value) {
                            refreshCalendarEvents();
                        }
                    }, 120000); // 2 minutes
                } else {
                    // Arr√™ter l'auto-refresh si on quitte la vue agenda
                    if (autoRefreshInterval) {
                        clearInterval(autoRefreshInterval);
                        autoRefreshInterval = null;
                    }
                }
            });

            // Charger les √©v√©nements quand on change de vue ou quand les donn√©es changent
            watch([() => currentWeekStart.value, () => calendarAgencyFilter.value, () => rdvList.value.length], () => {
                if (view.value === 'agenda') {
                    loadCalendarEvents();
                }
            });

            const filteredDaily = computed(() => { 
    if (!rdvList.value) return [];
    
    // 1. On prend l'horloge syst√®me (qui tourne toute seule)
    const d = new Date(now.value);
    
    // 2. Si le bouton "Demain" est activ√©, on ajoute 1 jour √† l'horloge
    if (isTimelineTomorrow.value) {
        d.setDate(d.getDate() + 1);
    }

    // 3. On formate la date cible
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    const targetDate = `${year}-${month}-${day}`;
    
    // 4. On filtre
    let list = rdvList.value.filter(r => r.date === targetDate && r.statut !== 'poubelle');
    
    // Filtres habituels
    if (dashboardFilters.agencyId) list = list.filter(r => r.agenceId === dashboardFilters.agencyId);
    if (dashboardFilters.userId) list = list.filter(r => r.createdBy === dashboardFilters.userId);
    if (dashboardFilters.onlyLive) list = list.filter(r => isEnCours(r));
    
    return list.sort((a,b) => a.heure.localeCompare(b.heure)).map(r => ({...r, agenceNom: agences.value.find(a=>a.id===r.agenceId)?.nom})); 
});
            const displayedDaily = computed(() => filteredDaily.value.slice(0, dashboardLimit.value));
            const sortedDaily = computed(() => displayedDaily.value);
            const rdvTodayCount = computed(() => filteredDaily.value.length);
            const timelineActiveCount = computed(() => {
                if (!rdvList.value) return 0;
                // Utiliser la m√™me logique que filteredDaily pour la date
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                const tomorrowStr = tomorrow.toISOString().split('T')[0];
                
                // Si on est en mode "demain", utiliser demain, sinon TOUJOURS utiliser aujourd'hui
                const targetDate = timelineShowTomorrow.value ? tomorrowStr : todayStr;
                
                let list = rdvList.value.filter(r => r.date === targetDate && r.statut !== 'poubelle');
                if (dashboardFilters.agencyId) list = list.filter(r => r.agenceId === dashboardFilters.agencyId);
                if (dashboardFilters.userId) list = list.filter(r => r.createdBy === dashboardFilters.userId);
                return list.filter(r => isEnCours(r)).length;
            });
            
            const isTimelineTomorrow = computed(() => timelineShowTomorrow.value);
            
            const showTimelineTomorrow = () => {
                // Basculer entre "aujourd'hui" et "demain"
                timelineShowTomorrow.value = !timelineShowTomorrow.value;
                // Mettre √† jour filters.date pour la coh√©rence (mais on ne l'utilise plus pour la logique)
                const today = new Date();
                if (timelineShowTomorrow.value) {
                    // Aller √† demain
                    const tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    filters.date = tomorrow.toISOString().split('T')[0];
                } else {
                    // Revenir √† aujourd'hui
                    filters.date = today.toISOString().split('T')[0];
                }
            };
            
            // Notifications visuelles
            const isNewRdvFromOther = (rdv) => {
                if (!rdv.created || !rdv.createdBy) return false;
                if (rdv.createdBy === user.name) return false; // Pas un RDV cr√©√© par moi
                try {
                    const createdDate = rdv.created && rdv.created.toDate ? rdv.created.toDate() : (rdv.created ? new Date(rdv.created) : null);
                    if (!createdDate) return false;
                    const now = new Date();
                    const diffMinutes = (now - createdDate) / (1000 * 60);
                    return diffMinutes > 0 && diffMinutes <= 30; // Nouveau si cr√©√© il y a moins de 30 minutes
                } catch (e) {
                    return false;
                }
            };
            
            const isRdvApproaching = (rdv) => {
                if (!rdv.date || !rdv.heure || rdv.statut === 'poubelle') return false;
                const today = new Date().toISOString().split('T')[0];
                if (rdv.date !== today) return false;
                
                const [hours, minutes] = rdv.heure.split(':').map(Number);
                const rdvTime = new Date();
                rdvTime.setHours(hours, minutes, 0, 0);
                
                const now = new Date();
                const diffMinutes = (rdvTime - now) / (1000 * 60);
                
                return diffMinutes > 0 && diffMinutes <= 15; // Entre maintenant et 15 minutes
            };
            
            const needsRappel = (rdv) => {
                if (!rdv.date || rdv.rappelFait) return false;
                if (!['confirme', 'a_confirmer'].includes(rdv.statut)) return false;
                // Exclure les rendez-vous qui ont √©t√© report√©s (un message de report a d√©j√† √©t√© envoy√©)
                if (rdv.motifDeplacement) return false;
                return isSoon(rdv.date) && !isCreatedToday(rdv.created);
            };
            
            const isSoon = (dStr) => {
                if (!dStr) return false;
                const nowDate = now.value ? new Date(now.value) : new Date();
                const today = new Date(nowDate); today.setHours(0, 0, 0, 0);
                const d = new Date(dStr); d.setHours(0, 0, 0, 0);
                const diffDays = Math.round((d - today) / 86400000);
                if (diffDays === 0) return true;
                if (diffDays === 1) { const hour = nowDate.getHours(); return hour >= 16; }
                return false;
            };

            const isCreatedToday = (d) => {
                if (!d) return false;
                const date = new Date(d);
                const today = new Date();
                return (date.getDate() === today.getDate() && date.getMonth() === today.getMonth() && date.getFullYear() === today.getFullYear());
            };

            const getDayDiff = (dStr) => {
                if (!dStr) return null;
                const base = now.value ? new Date(now.value) : new Date(); base.setHours(0, 0, 0, 0);
                const d = new Date(dStr); d.setHours(0, 0, 0, 0);
                return Math.round((d - base) / 86400000);
            };

            const rappelsList = computed(() => rdvList.value.filter((r) => ['confirme', 'a_confirmer'].includes(r.statut) && !r.rappelFait && !r.motifDeplacement && isSoon(r.date) && !isCreatedToday(r.created) && (getDayDiff(r.date) !== 0 || (r.heure && r.heure > new Date().toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'})))));
            const rappelFilters = reactive({ day: 'today', agenceId: '', userId: '' });
            const isRappelToday = (r) => getDayDiff(r.date) === 0;
            const isRappelTomorrow = (r) => getDayDiff(r.date) === 1;
            const rappelsDisplay = computed(() => {
                let list = rappelsList.value;
                if (rappelFilters.day === 'today') { list = list.filter((r) => isRappelToday(r)); } else if (rappelFilters.day === 'tomorrow') { list = list.filter((r) => isRappelTomorrow(r)); }
                if (rappelFilters.agenceId) { list = list.filter((r) => r.agenceId === rappelFilters.agenceId); }
                if (rappelFilters.userId) { list = list.filter((r) => r.createdBy === rappelFilters.userId); }
                return list;
            });
            const rappelsVeilleCount = computed(() => rappelsList.value.filter(r => isRappelTomorrow(r)).length);
            const rappelsJourCount = computed(() => rappelsList.value.filter(r => isRappelToday(r)).length);
            const confirmList = computed(() => rdvList.value.filter((r) => r.statut === 'a_confirmer'));
            const rappelCount = computed(() => rappelsList.value.length);
            const confirmCount = computed(() => confirmList.value.length);
            
            const detailedStats = computed(() => {
                // Utiliser les filtres de la modale, sinon ceux du dashboard, sinon le mois/ann√©e actuel
                const moisFilter = statsFilterMonth.value || dashboardFilters.mois;
                const anneeFilter = statsFilterYear.value || dashboardFilters.annee;
                const selectedMonth = moisFilter ? parseInt(moisFilter) - 1 : new Date().getMonth();
                const selectedYear = anneeFilter ? parseInt(anneeFilter) : new Date().getFullYear();
                const currentMonth = selectedMonth;
                const currentYear = selectedYear;
                
                let targetUser = statsFilterUser.value;
                if (user.role !== 'admin') {
                    targetUser = user.name;
                }

                let filteredList = rdvList.value.filter(r => { 
                    if (!r.date) return false; 
                    if (r.statut === 'poubelle') return false; 
                    const d = new Date(r.date); 
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear; 
                });
                if(statsFilterAgency.value) { filteredList = filteredList.filter(r => r.agenceId === statsFilterAgency.value); }
                if(targetUser) { filteredList = filteredList.filter(r => r.createdBy === targetUser); }
                
                const total = filteredList.length; 
                const honored = filteredList.filter(r => r.statut === 'honore').length; 
                const noshow = filteredList.filter(r => r.statut === 'pas_venu').length; 
                const finished = honored + noshow; 
                // Taux de conversion : 100% au d√©but du mois (quand finished = 0), sinon calcul normal
                const rate = finished > 0 ? Math.round((honored / finished) * 100) : (new Date().getDate() === 1 && new Date().getMonth() === currentMonth && new Date().getFullYear() === currentYear ? 100 : 0);
                return { total, honored, noshow, rate };
            });

            // Stats filtr√©es par commercial pour l'onglet Vue Commercial
            const commercialStatsFiltered = computed(() => {
                if (!stats.perfByCommercial || Object.keys(stats.perfByCommercial).length === 0) {
                    return {};
                }
                
                // Si l'utilisateur n'est pas admin, on montre seulement ses stats
                if (user.role !== 'admin') {
                    const userStats = stats.perfByCommercial[user.name];
                    return userStats ? { [user.name]: userStats } : {};
                }
                
                // Si c'est un admin et qu'un commercial est s√©lectionn√©, on montre seulement ce commercial
                if (statsFilterUser.value) {
                    const selectedStats = stats.perfByCommercial[statsFilterUser.value];
                    return selectedStats ? { [statsFilterUser.value]: selectedStats } : {};
                }
                
                // Sinon, on montre tous les commerciaux
                return stats.perfByCommercial;
            });
            
            // Statistiques mandats par agence
            const mandatsParAgence = computed(() => {
                // Utiliser les filtres de la modale, sinon ceux du dashboard, sinon le mois/ann√©e actuel
                const moisFilter = statsFilterMonth.value || dashboardFilters.mois;
                const anneeFilter = statsFilterYear.value || dashboardFilters.annee;
                const selectedMonth = moisFilter ? parseInt(moisFilter) - 1 : new Date().getMonth();
                const selectedYear = anneeFilter ? parseInt(anneeFilter) : new Date().getFullYear();
                const currentMonth = selectedMonth;
                const currentYear = selectedYear;
                
                let targetUser = statsFilterUser.value;
                if (user.role !== 'admin') {
                    targetUser = user.name;
                }
                
                // Filtrer UNIQUEMENT les RDV honor√©s du mois/ann√©e s√©lectionn√©
                let filteredList = rdvList.value.filter(r => {
                    if (!r.date) return false;
                    if (r.statut !== 'honore') return false; // SEULEMENT les RDV honor√©s
                    if (r.statut === 'poubelle') return false;
                    const d = new Date(r.date);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                });
                
                // Appliquer le filtre par agence si une agence est s√©lectionn√©e
                if(statsFilterAgency.value) {
                    // Convertir en string pour √©viter les probl√®mes de type
                    const selectedAgencyId = String(statsFilterAgency.value);
                    filteredList = filteredList.filter(r => {
                        // Si le RDV n'a pas d'agence, on l'exclut quand on filtre par agence
                        if (!r.agenceId) return false;
                        return String(r.agenceId) === selectedAgencyId;
                    });
                }
                
                if(targetUser) {
                    filteredList = filteredList.filter(r => r.createdBy === targetUser);
                }
                
                // Grouper par agence
                const statsByAgency = {};
                
                filteredList.forEach(rdv => {
                    const agenceId = rdv.agenceId || 'sans-agence';
                    if (!statsByAgency[agenceId]) {
                        statsByAgency[agenceId] = {
                            agenceId: agenceId,
                            nom: getAgenceName(agenceId),
                            total: 0,
                            mandatsSignes: 0
                        };
                    }
                    statsByAgency[agenceId].total++; // Total des RDV honor√©s
                    if (rdv.tag === 'OK M') {
                        statsByAgency[agenceId].mandatsSignes++;
                    }
                });
                
                // Convertir en tableau et trier par nombre de mandats sign√©s
                return Object.values(statsByAgency)
                    .sort((a, b) => b.mandatsSignes - a.mandatsSignes);
            });
            
            // Computed pour afficher le mois/ann√©e s√©lectionn√© dans la modale
            const statsModalSelectedPeriod = computed(() => {
                const moisFilter = statsFilterMonth.value || dashboardFilters.mois;
                const anneeFilter = statsFilterYear.value || dashboardFilters.annee;
                if (moisFilter && anneeFilter) {
                    const monthIndex = parseInt(moisFilter) - 1;
                    const MONTHS_FR = ["janvier","f√©vrier","mars","avril","mai","juin","juillet","ao√ªt","septembre","octobre","novembre","d√©cembre"];
                    return `${MONTHS_FR[monthIndex]} ${anneeFilter}`;
                }
                return new Date().toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
            });
            
            const openStatsModal = () => { 
                statsFilterAgency.value = ''; 
                statsFilterUser.value = ''; 
                // Initialiser avec les valeurs du dashboard ou le mois/ann√©e actuel
                const now = new Date();
                if (!statsFilterMonth.value) {
                    statsFilterMonth.value = dashboardFilters.mois || pad(now.getMonth() + 1);
                }
                if (!statsFilterYear.value) {
                    statsFilterYear.value = dashboardFilters.annee || now.getFullYear().toString();
                }
                statsModal.open = true; 
            };
            
            // Fonction pour r√©initialiser les filtres date du dashboard
            const resetDashboardDateFilters = () => {
                const now = new Date();
                dashboardFilters.mois = pad(now.getMonth() + 1);
                dashboardFilters.annee = now.getFullYear().toString();
            };
            
            // Fonction pour r√©initialiser les filtres date de la modale stats
            const resetStatsModalDateFilters = () => {
                const now = new Date();
                statsFilterMonth.value = pad(now.getMonth() + 1);
                statsFilterYear.value = now.getFullYear().toString();
            };
            
       // Fonction d'export des Statistiques (Version C&N Solutions + Filtres Agence/Commercial)
            const exportStatsPdf = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'portrait' });
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();

                // Palette de couleurs C&N
                const colorHeader = [30, 58, 138]; // Bleu nuit profond
                const colorBg = [248, 250, 252];   // Fond tr√®s clair
                const colorText = [51, 65, 85];    // Texte gris fonc√©
                const colorBlue = [37, 99, 235];   // Bleu vif
                const colorGreen = [22, 163, 74];  // Vert succ√®s
                const colorRed = [220, 38, 38];    // Rouge alerte
                
                // --- 1. DONN√âES & RECUPERATION DES FILTRES ---
                const statsData = detailedStats.value; 
                const rate = statsData.rate;

                const now = new Date();
                const monthNames = ['JANVIER', 'F√âVRIER', 'MARS', 'AVRIL', 'MAI', 'JUIN', 'JUILLET', 'AO√õT', 'SEPTEMBRE', 'OCTOBRE', 'NOVEMBRE', 'D√âCEMBRE'];
                const currentMonthLabel = monthNames[now.getMonth()];
                const currentYear = now.getFullYear();

                // R√©cup√©ration des noms pour l'affichage dans l'en-t√™te
                let agencyName = "Toutes les agences";
                if (statsFilterAgency.value) {
                    const ag = agences.value.find(a => a.id === statsFilterAgency.value);
                    if (ag) agencyName = ag.nom;
                }

                let commercialName = "Toute l'√©quipe";
                let targetUser = statsFilterUser.value;
                // Si ce n'est pas un admin, on force le nom de l'utilisateur connect√©
                if (user.role !== 'admin') {
                    targetUser = user.name;
                }
                if (targetUser) {
                    commercialName = targetUser;
                }

                // --- 2. EN-T√äTE MARQUE C&N SOLUTIONS ---
                
                // Fond de l'en-t√™te (Bandeau bleu haut)
                doc.setFillColor(...colorHeader);
                doc.rect(0, 0, pageWidth, 55, 'F'); // Agrandissement pour faire tenir les infos agence/comm

                // LOGO / NOM ENTREPRISE (Gauche)
                if (bilanConfig.logo) {
                    try {
                        doc.addImage(bilanConfig.logo, 'JPEG', 14, 10, 25, 25, undefined, 'FAST');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(20);
                        doc.setFont('helvetica', 'bold');
                        doc.text("C&N Solutions", 45, 22);
                    } catch (e) { 
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(22);
                        doc.setFont('helvetica', 'bold');
                        doc.text("C&N Solutions", 14, 25);
                    }
                } else {
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(22);
                    doc.setFont('helvetica', 'bold');
                    doc.text("C&N Solutions", 14, 25);
                }

                // TITRE & DATE (Haut Droite)
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text("RAPPORT DE PERFORMANCE", pageWidth - 14, 18, { align: 'right' });

                // Le Mois en Gros
                doc.setFontSize(24);
                doc.setFont('helvetica', 'bold');
                doc.text(currentMonthLabel, pageWidth - 14, 28, { align: 'right' });
                doc.setFontSize(14);
                doc.text(String(currentYear), pageWidth - 14, 35, { align: 'right' });

                // --- INFO FILTRES (Agence / Commercial) ---
                // Affichage en bas du bandeau bleu
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(203, 213, 225); // Gris clair
                
                let infoY = 48;
                doc.text(`AGENCE : ${agencyName.toUpperCase()}`, 14, infoY);
                
                // On affiche le commercial √† droite si un filtre est actif ou si c'est un prospecteur
                doc.text(`COMMERCIAL : ${commercialName.toUpperCase()}`, pageWidth - 14, infoY, { align: 'right' });

                let y = 75;

                // --- 3. JAUGE DE CONVERSION ---
                // Cadre
                doc.setDrawColor(226, 232, 240);
                doc.setFillColor(255, 255, 255);
                doc.roundedRect(14, y - 10, pageWidth - 28, 45, 3, 3, 'FD');

                doc.setTextColor(...colorText);
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text("Taux de Transformation Global", pageWidth / 2, y + 5, { align: 'center' });

                // Barre fond
                const barWidth = 150;
                const barHeight = 12;
                const barX = (pageWidth - barWidth) / 2;
                const barY = y + 12;

                doc.setFillColor(226, 232, 240);
                doc.roundedRect(barX, barY, barWidth, barHeight, 3, 3, 'F');

                // Barre remplissage
                let gaugeColor = rate < 50 ? colorRed : (rate < 80 ? [249, 115, 22] : colorGreen);
                if (rate > 0) {
                    doc.setFillColor(...gaugeColor);
                    doc.roundedRect(barX, barY, (rate / 100) * barWidth, barHeight, 3, 3, 'F');
                }
                
                // Score
                doc.setTextColor(...colorText);
                doc.text(`${rate}%`, pageWidth / 2, barY + 9, { align: 'center' });

                y += 50;

                // --- 4. CARTES KPI (Align√©es) ---
                const kpiY = y;
                const boxW = (pageWidth - 28 - 30) / 4; // 4 boites
                const boxH = 25;

                // Fonction petite boite
                const drawMiniBox = (offsetX, label, val, color) => {
                    doc.setFillColor(255, 255, 255);
                    doc.setDrawColor(226, 232, 240);
                    doc.roundedRect(offsetX, kpiY, boxW, boxH, 2, 2, 'FD');
                    
                    // Indicateur couleur
                    doc.setFillColor(...color);
                    doc.rect(offsetX, kpiY, 2, boxH, 'F'); // Ligne √† gauche

                    doc.setFontSize(8);
                    doc.setTextColor(100, 116, 139);
                    doc.text(label, offsetX + 6, kpiY + 8);

                    doc.setFontSize(14);
                    doc.setTextColor(...colorText);
                    doc.setFont('helvetica', 'bold');
                    doc.text(val.toString(), offsetX + 6, kpiY + 19);
                };

                drawMiniBox(14, "TOTAL PLAC√âS", statsData.total, colorBlue);
                drawMiniBox(14 + boxW + 10, "HONOR√âS", statsData.honored, colorGreen);
                drawMiniBox(14 + (boxW + 10)*2, "PAS VENUS", statsData.noshow, colorRed);
                drawMiniBox(14 + (boxW + 10)*3, "ANNUL√âS", (statsData.total - statsData.honored - statsData.noshow), [148, 163, 184]);

                y += 40;

                // --- 5. TABLEAU ---
                doc.setFontSize(14);
                doc.setTextColor(...colorHeader);
                doc.text("D√©tail par Agence", 14, y);
                y += 5;

                const tableData = mandatsParAgence.value.map(s => {
                    const taux = s.total > 0 ? Math.round((s.mandatsSignes / s.total) * 100) : 0;
                    return [
                        s.nom || 'Ind√©pendant',
                        s.total,
                        s.mandatsSignes, // "Honor√©s"
                        s.noshow || 0,
                        `${taux}%`
                    ];
                });

                doc.autoTable({
                    head: [['AGENCE', 'TOTAL', 'HONOR√âS', 'PAS VENUS', 'TAUX']],
                    body: tableData,
                    startY: y,
                    theme: 'striped',
                    headStyles: {
                        fillColor: colorHeader,
                        textColor: 255,
                        fontStyle: 'bold',
                        halign: 'center',
                        cellPadding: 4
                    },
                    bodyStyles: {
                        textColor: colorText,
                        fontSize: 10,
                        halign: 'center',
                        cellPadding: 4
                    },
                    columnStyles: {
                        0: { halign: 'left', fontStyle: 'bold' },
                        2: { textColor: colorGreen, fontStyle: 'bold' },
                        4: { fontStyle: 'bold' }
                    },
                    alternateRowStyles: {
                        fillColor: colorBg
                    },
                    margin: { left: 14, right: 14 }
                });

                // Pied de page
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text(`C&N Solutions - Document g√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')}`, pageWidth - 14, pageHeight - 10, { align: 'right' });

                doc.save(`Performance_${currentMonthLabel}_${currentYear}.pdf`);
            };
            
            // Calcul des commissions pour le commercial connect√© (AVEC LOGIQUE RECURRENTE)
            const userCommissionStats = computed(() => {
                if (user.role === 'admin') return null; 
                
                const basePrice = parseFloat(globalCommission.base) || 0;
                const bonusThreshold = parseInt(globalCommission.threshold) || 21;
                const bonusStep = parseInt(globalCommission.step) || 10;
                const bonusAmount = parseFloat(globalCommission.amount) || 100;

                const now = new Date(); const currentMonth = now.getMonth(); const currentYear = now.getFullYear();
                
                const honoredRdvs = rdvList.value.filter(r => {
                    if (r.statut !== 'honore' || r.createdBy !== user.name || !r.date) return false;
                    const d = new Date(r.date);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                });

                const count = honoredRdvs.length;
                let baseEarnings = count * basePrice;
                let bonusEarnings = 0;

                // Logique r√©currente: 
                // Si threshold=21, step=10, amount=100.
                // 21 -> 100
                // 31 -> 200
                if (count >= bonusThreshold) {
                    // (21-21)/10 + 1 = 1 * 100 = 100
                    // (31-21)/10 + 1 = 2 * 100 = 200
                    const multiplier = Math.floor((count - bonusThreshold) / bonusStep) + 1;
                    bonusEarnings = multiplier * bonusAmount;
                }

                // Add Tips
                const currentMonthKey = `${currentMonth}-${currentYear}`;
                // Get tip for this user from loaded tips object (reactive)
                const myUserEntry = teamList.value.find(u => u.name === user.name);
                let tipEarnings = 0;
                if(myUserEntry && tips[myUserEntry.id]) {
                    tipEarnings = tips[myUserEntry.id];
                }

                const totalEarnings = baseEarnings + bonusEarnings + tipEarnings;

                return { 
                    count, 
                    baseEarnings, 
                    bonusEarnings, 
                    tipEarnings, 
                    totalEarnings,
                    justReachedTier: (count >= bonusThreshold) && ((count - bonusThreshold) % bonusStep === 0) // Visual effect trigger
                };
            });

           // STATS ADMIN AVEC CALCUL MARGE (CORRIG√â : EXCLURE ADMINS DES COMMISSIONS) + FILTRES DASHBOARD
            const stats = computed(() => {
                const nowStr = new Date().toISOString().split('T')[0];
                // Utiliser les filtres du dashboard ou le mois/ann√©e actuel par d√©faut
                const selectedMonth = dashboardFilters.mois ? parseInt(dashboardFilters.mois) - 1 : new Date().getMonth();
                const selectedYear = dashboardFilters.annee ? parseInt(dashboardFilters.annee) : new Date().getFullYear();
                const currentMonth = selectedMonth;
                const currentYear = selectedYear;

                // Appliquer les filtres du dashboard
                let filteredRdvs = rdvList.value.filter(r => r.statut !== 'poubelle');
                if (dashboardFilters.agencyId) {
                    filteredRdvs = filteredRdvs.filter(r => r.agenceId === dashboardFilters.agencyId);
                }
                if (dashboardFilters.userId) {
                    filteredRdvs = filteredRdvs.filter(r => r.createdBy === dashboardFilters.userId);
                }
                if (dashboardFilters.commercialId && dashboardFilters.agencyId) {
                    filteredRdvs = filteredRdvs.filter(r => r.createdBy === dashboardFilters.commercialId);
                }

                const upcoming = filteredRdvs.filter(r => r.statut==='confirme' && r.date >= nowStr).length;
                
                // Filtrer les statistiques par mois en cours
                const honored = filteredRdvs.filter(r => {
                    if (r.statut !== 'honore' || !r.date) return false;
                    const d = new Date(r.date);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                }).length;
                
                const noshow = filteredRdvs.filter(r => {
                    if (r.statut !== 'pas_venu' || !r.date) return false;
                    const d = new Date(r.date);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                }).length;
                
                const cancelled = filteredRdvs.filter(r => {
                    if (r.statut !== 'annule' || !r.date) return false;
                    const d = new Date(r.date);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                }).length;

                // CA BRUT (Tout le monde compte pour le CA) - avec filtres - SEULEMENT CE MOIS
                const ca = filteredRdvs.filter(r => {
                    if (r.honorBilling !== 'facture' || !r.date) return false;
                    const d = new Date(r.date);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                }).reduce((acc,r) => { 
                    const price = getAgencePrice(r); 
                    const discount = parseFloat(r.geste_commercial) || 0; 
                    return acc + (price - discount); 
                }, 0);

                // CA Journalier - avec filtres
                const ca_daily = filteredRdvs.filter(r => r.honorBilling==='facture' && r.date === nowStr).reduce((acc,r) => { 
                    const price = getAgencePrice(r); 
                    const discount = parseFloat(r.geste_commercial) || 0; 
                    return acc + (price - discount); 
                }, 0);

                // Commissions Totales (Filtrage des Admins) - avec filtres
                const commissionMap = {}; 
                filteredRdvs.forEach(r => {
                    if (r.statut === 'honore' && r.date) {
                        const d = new Date(r.date);
                        if (d.getMonth() === currentMonth && d.getFullYear() === currentYear) {
                            const uName = r.createdBy || 'Syst√®me';
                            if (!commissionMap[uName]) commissionMap[uName] = 0;
                            commissionMap[uName]++;
                        }
                    }
                });

                let totalCommissions = 0;
                
                const basePrice = parseFloat(globalCommission.base) || 0;
                const bonusThreshold = parseInt(globalCommission.threshold) || 21;
                const bonusStep = parseInt(globalCommission.step) || 10;
                const bonusAmount = parseFloat(globalCommission.amount) || 100;

                for (const [userName, count] of Object.entries(commissionMap)) {
                    // --- NOUVELLE LOGIQUE : V√âRIFIER SI C'EST UN ADMIN ---
                    // 1. V√©rifier dans la liste des noms admins (hardcod√©/settings)
                    const isNameInAdminList = adminNamesList.value.includes(userName);
                    // 2. V√©rifier dans la liste des utilisateurs (r√¥le)
                    const userObj = teamList.value.find(u => u.name === userName);
                    const isRoleAdmin = userObj && userObj.role === 'admin';

                    // Si c'est un admin, on ne calcule PAS de commission (co√ªt = 0)
                    if (isNameInAdminList || isRoleAdmin) {
                        continue; 
                    }
                    // -----------------------------------------------------

                    let userTotal = count * basePrice;
                    if (count >= bonusThreshold) {
                        const multiplier = Math.floor((count - bonusThreshold) / bonusStep) + 1;
                        userTotal += (multiplier * bonusAmount);
                    }
                    
                    // Add Tips from teamList (seulement pour les non-admins)
                    if (userObj && tips[userObj.id]) {
                        userTotal += parseFloat(tips[userObj.id]);
                    }

                    totalCommissions += userTotal;
                }

                const net = ca - totalCommissions;

                // Statistiques avanc√©es - avec filtres - SEULEMENT CE MOIS
                const totalRdv = filteredRdvs.filter(r => {
                    if (!r.date) return false;
                    const d = new Date(r.date);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                }).length;
                // Taux de conversion : 100% au d√©but du mois (quand totalRdv = 0), sinon calcul normal
                const tauxConversion = totalRdv > 0 ? ((honored / totalRdv) * 100).toFixed(1) : '100.0';
                const tauxAnnulation = totalRdv > 0 ? ((cancelled / totalRdv) * 100).toFixed(1) : 0;
                const tauxNoShow = totalRdv > 0 ? ((noshow / totalRdv) * 100).toFixed(1) : 0;
                const caMoyenParRdv = honored > 0 ? (ca / honored).toFixed(2) : 0; // CA moyen par RDV honor√©
                
                // CA par jour (7 derniers jours) - avec filtres - SEULEMENT CE MOIS
                const caParJour = {};
                const honoredRdv = filteredRdvs.filter(r => {
                    if (r.honorBilling !== 'facture' || !r.date) return false;
                    const d = new Date(r.date);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                });
                honoredRdv.forEach(r => {
                    const price = getAgencePrice(r);
                    const discount = parseFloat(r.geste_commercial) || 0;
                    const netPrice = price - discount;
                    if (!caParJour[r.date]) caParJour[r.date] = 0;
                    caParJour[r.date] += netPrice;
                });
                
                // Top 5 clients (par nombre de RDV honor√©s)
                const clientStats = {};
                honoredRdv.forEach(r => {
                    const clientKey = `${r.civilite} ${r.nom}`.trim();
                    if (!clientStats[clientKey]) {
                        clientStats[clientKey] = { nom: clientKey, count: 0, ca: 0, telephone: r.telephone || '' };
                    }
                    clientStats[clientKey].count++;
                    const price = getAgencePrice(r);
                    const discount = parseFloat(r.geste_commercial) || 0;
                    clientStats[clientKey].ca += (price - discount);
                });
                const topClients = Object.values(clientStats)
                    .sort((a, b) => b.count - a.count)
                    .slice(0, 5);
                
                // Performance par commercial (ce mois) - avec filtres
                const perfByCommercial = {};
                filteredRdvs.forEach(r => {
                    if (r.statut === 'honore' && r.date && r.createdBy) {
                        const d = new Date(r.date);
                        if (d.getMonth() === currentMonth && d.getFullYear() === currentYear) {
                            const commercial = r.createdBy;
                            if (!perfByCommercial[commercial]) {
                                perfByCommercial[commercial] = { count: 0, ca: 0 };
                            }
                            perfByCommercial[commercial].count++;
                            const price = getAgencePrice(r);
                            const discount = parseFloat(r.geste_commercial) || 0;
                            perfByCommercial[commercial].ca += (price - discount);
                        }
                    }
                });
                
                // Statistiques par source
                const statsBySource = {};
                honoredRdv.forEach(r => {
                    if (r.source) {
                        if (!statsBySource[r.source]) {
                            statsBySource[r.source] = { count: 0, ca: 0 };
                        }
                        statsBySource[r.source].count++;
                        const price = getAgencePrice(r);
                        const discount = parseFloat(r.geste_commercial) || 0;
                        statsBySource[r.source].ca += (price - discount);
                    }
                });
                
                // Statistiques par agence - SEULEMENT CE MOIS
                const statsByAgency = {};
                // D'abord, compter tous les RDV par agence (total) - CE MOIS
                filteredRdvs.forEach(r => {
                    if (r.agenceId && r.date) {
                        const d = new Date(r.date);
                        if (d.getMonth() === currentMonth && d.getFullYear() === currentYear) {
                            const agenceName = getAgenceName(r.agenceId);
                            if (!statsByAgency[agenceName]) {
                                statsByAgency[agenceName] = { total: 0, count: 0, countWithMandat: 0, ca: 0 };
                            }
                            statsByAgency[agenceName].total++;
                        }
                    }
                });
                // Ensuite, compter les RDV honor√©s (avec mandat sign√© si possible)
                honoredRdv.forEach(r => {
                    if (r.agenceId) {
                        const agenceName = getAgenceName(r.agenceId);
                        if (!statsByAgency[agenceName]) {
                            statsByAgency[agenceName] = { total: 0, count: 0, countWithMandat: 0, ca: 0 };
                        }
                        statsByAgency[agenceName].count++;
                        // Compter ceux avec mandat sign√© (tag === 'OK M')
                        if (r.tag === 'OK M') {
                            statsByAgency[agenceName].countWithMandat++;
                        }
                        const price = getAgencePrice(r);
                        const discount = parseFloat(r.geste_commercial) || 0;
                        statsByAgency[agenceName].ca += (price - discount);
                    }
                });
                
                // CA par jour de la semaine (lundi=0, dimanche=6) - Ce mois
                const caParJourSemaine = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0 };
                honoredRdv.forEach(r => {
                    if (r.date) {
                        const d = new Date(r.date);
                        if (d.getMonth() === currentMonth && d.getFullYear() === currentYear) {
                            const jourSemaine = d.getDay();
                            const price = getAgencePrice(r);
                            const discount = parseFloat(r.geste_commercial) || 0;
                            caParJourSemaine[jourSemaine] += (price - discount);
                        }
                    }
                });
                
                // CA par jour de la semaine - Mois pr√©c√©dent
                const previousMonth = currentMonth === 0 ? 11 : currentMonth - 1;
                const previousYear = currentMonth === 0 ? currentYear - 1 : currentYear;
                const caParJourSemainePrevious = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0 };
                honoredRdv.forEach(r => {
                    if (r.date) {
                        const d = new Date(r.date);
                        if (d.getMonth() === previousMonth && d.getFullYear() === previousYear) {
                            const jourSemaine = d.getDay();
                            const price = getAgencePrice(r);
                            const discount = parseFloat(r.geste_commercial) || 0;
                            caParJourSemainePrevious[jourSemaine] += (price - discount);
                        }
                    }
                });
                
                // ANALYSE DE TENDANCES : Jours les plus rentables
                const joursRentables = Object.entries(caParJourSemaine)
                    .map(([jour, ca]) => ({ jour: parseInt(jour), jourNom: ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'][jour], ca }))
                    .sort((a, b) => b.ca - a.ca);
                const jourLePlusRentable = joursRentables[0];
                
                // ANALYSE DE TENDANCES : Heures optimales
                const caParHeure = {};
                honoredRdv.forEach(r => {
                    if (r.heure) {
                        const heure = r.heure.split(':')[0]; // Extraire l'heure (ex: "14" de "14:30")
                        const price = getAgencePrice(r);
                        const discount = parseFloat(r.geste_commercial) || 0;
                        if (!caParHeure[heure]) caParHeure[heure] = { ca: 0, count: 0 };
                        caParHeure[heure].ca += (price - discount);
                        caParHeure[heure].count++;
                    }
                });
                const heuresOptimales = Object.entries(caParHeure)
                    .map(([heure, data]) => ({ heure: parseInt(heure), ca: data.ca, count: data.count, caMoyen: data.ca / data.count }))
                    .sort((a, b) => b.ca - a.ca)
                    .slice(0, 5); // Top 5 heures
                
                return { 
                    upcoming, honored, noshow, cancelled, ca, ca_daily, commissions: totalCommissions, net,
                    totalRdv, tauxConversion, tauxAnnulation, tauxNoShow, caMoyenParRdv,
                    statsBySource, statsByAgency, caParJour, topClients, perfByCommercial, caParJourSemaine, caParJourSemainePrevious
                };
            });

            // STATS POUR LA MODALE AVEC FILTRES (Agence/Commercial/Mois/Ann√©e)
            const statsModalData = computed(() => {
                const nowStr = new Date().toISOString().split('T')[0];
                // Utiliser les filtres de la modale, sinon ceux du dashboard, sinon le mois/ann√©e actuel
                const moisFilter = statsFilterMonth.value || dashboardFilters.mois;
                const anneeFilter = statsFilterYear.value || dashboardFilters.annee;
                const selectedMonth = moisFilter ? parseInt(moisFilter) - 1 : new Date().getMonth();
                const selectedYear = anneeFilter ? parseInt(anneeFilter) : new Date().getFullYear();
                const currentMonth = selectedMonth;
                const currentYear = selectedYear;

                // Appliquer les filtres de la modale
                let filteredRdvs = rdvList.value.filter(r => r.statut !== 'poubelle');
                
                // Filtre par agence
                if (statsFilterAgency.value) {
                    filteredRdvs = filteredRdvs.filter(r => r.agenceId === statsFilterAgency.value);
                }
                
                // Filtre par commercial
                let targetUser = statsFilterUser.value;
                if (user.role !== 'admin') {
                    targetUser = user.name;
                }
                if (targetUser) {
                    filteredRdvs = filteredRdvs.filter(r => r.createdBy === targetUser);
                }

                const upcoming = filteredRdvs.filter(r => r.statut==='confirme' && r.date >= nowStr).length;
                
                // Filtrer les statistiques par mois/ann√©e s√©lectionn√©
                const honored = filteredRdvs.filter(r => {
                    if (r.statut !== 'honore' || !r.date) return false;
                    const d = new Date(r.date);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                }).length;
                
                const noshow = filteredRdvs.filter(r => {
                    if (r.statut !== 'pas_venu' || !r.date) return false;
                    const d = new Date(r.date);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                }).length;
                
                const cancelled = filteredRdvs.filter(r => {
                    if (r.statut !== 'annule' || !r.date) return false;
                    const d = new Date(r.date);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                }).length;

                // CA BRUT avec filtres - SEULEMENT LE MOIS/ANN√âE S√âLECTIONN√â
                const ca = filteredRdvs.filter(r => {
                    if (r.honorBilling !== 'facture' || !r.date) return false;
                    const d = new Date(r.date);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                }).reduce((acc,r) => { 
                    const price = getAgencePrice(r); 
                    const discount = parseFloat(r.geste_commercial) || 0; 
                    return acc + (price - discount); 
                }, 0);

                // Statistiques avanc√©es avec filtres - SEULEMENT LE MOIS/ANN√âE S√âLECTIONN√â
                const totalRdv = filteredRdvs.filter(r => {
                    if (!r.date) return false;
                    const d = new Date(r.date);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                }).length;
                // Taux de conversion : 100% au d√©but du mois (quand totalRdv = 0), sinon calcul normal
                const tauxConversion = totalRdv > 0 ? ((honored / totalRdv) * 100).toFixed(1) : '100.0';
                const tauxAnnulation = totalRdv > 0 ? ((cancelled / totalRdv) * 100).toFixed(1) : 0;
                const tauxNoShow = totalRdv > 0 ? ((noshow / totalRdv) * 100).toFixed(1) : 0;
                const caMoyenParRdv = honored > 0 ? (ca / honored).toFixed(2) : 0;

                // RDV honor√©s avec filtres - SEULEMENT LE MOIS/ANN√âE S√âLECTIONN√â
                const honoredRdv = filteredRdvs.filter(r => {
                    if (r.honorBilling !== 'facture' || !r.date) return false;
                    const d = new Date(r.date);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                });

                // Statistiques par source avec filtres
                const statsBySource = {};
                honoredRdv.forEach(r => {
                    if (r.source) {
                        if (!statsBySource[r.source]) {
                            statsBySource[r.source] = { count: 0, ca: 0 };
                        }
                        statsBySource[r.source].count++;
                        const price = getAgencePrice(r);
                        const discount = parseFloat(r.geste_commercial) || 0;
                        statsBySource[r.source].ca += (price - discount);
                    }
                });

                // Statistiques par agence avec filtres
                const statsByAgency = {};
                honoredRdv.forEach(r => {
                    if (r.agenceId) {
                        const agenceName = getAgenceName(r.agenceId);
                        if (!statsByAgency[agenceName]) {
                            statsByAgency[agenceName] = { count: 0, ca: 0 };
                        }
                        statsByAgency[agenceName].count++;
                        const price = getAgencePrice(r);
                        const discount = parseFloat(r.geste_commercial) || 0;
                        statsByAgency[agenceName].ca += (price - discount);
                    }
                });

                // Performance par commercial avec filtres
                const perfByCommercial = {};
                filteredRdvs.forEach(r => {
                    if (r.statut === 'honore' && r.date && r.createdBy) {
                        const d = new Date(r.date);
                        if (d.getMonth() === currentMonth && d.getFullYear() === currentYear) {
                            const commercial = r.createdBy;
                            if (!perfByCommercial[commercial]) {
                                perfByCommercial[commercial] = { count: 0, ca: 0 };
                            }
                            perfByCommercial[commercial].count++;
                            const price = getAgencePrice(r);
                            const discount = parseFloat(r.geste_commercial) || 0;
                            perfByCommercial[commercial].ca += (price - discount);
                        }
                    }
                });

                // CA par jour de la semaine - Ce mois avec filtres
                const caParJourSemaine = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0 };
                honoredRdv.forEach(r => {
                    if (r.date) {
                        const d = new Date(r.date);
                        if (d.getMonth() === currentMonth && d.getFullYear() === currentYear) {
                            const jourSemaine = d.getDay();
                            const price = getAgencePrice(r);
                            const discount = parseFloat(r.geste_commercial) || 0;
                            caParJourSemaine[jourSemaine] += (price - discount);
                        }
                    }
                });

                // CA par jour de la semaine - Mois pr√©c√©dent avec filtres
                const previousMonth = currentMonth === 0 ? 11 : currentMonth - 1;
                const previousYear = currentMonth === 0 ? currentYear - 1 : currentYear;
                const caParJourSemainePrevious = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0 };
                honoredRdv.forEach(r => {
                    if (r.date) {
                        const d = new Date(r.date);
                        if (d.getMonth() === previousMonth && d.getFullYear() === previousYear) {
                            const jourSemaine = d.getDay();
                            const price = getAgencePrice(r);
                            const discount = parseFloat(r.geste_commercial) || 0;
                            caParJourSemainePrevious[jourSemaine] += (price - discount);
                        }
                    }
                });

                return {
                    totalRdv, tauxConversion, tauxAnnulation, tauxNoShow, caMoyenParRdv,
                    statsBySource, statsByAgency, perfByCommercial, caParJourSemaine, caParJourSemainePrevious, honored
                };
            });

            const isLateAndNoStatus = (r) => { if(!r.date || !r.heure) return false; const start = new Date(r.date+'T'+r.heure); const end = new Date(start.getTime() + 60*60*1000); return now.value >= end && ['confirme','a_confirmer'].includes(r.statut); };
            const getProgressPercent = (r) => { if(!r.date || !r.heure) return 0; const start = new Date(r.date+'T'+r.heure).getTime(); const end = start + 3600000; const current = now.value.getTime(); if(current < start) return 0; if(current > end) return 100; return ((current - start) / (end - start)) * 100; };
            const getRdvTimeStatus = (r) => { if(!r.date || !r.heure) return 'futur'; const start = new Date(r.date+'T'+r.heure).getTime(); const current = now.value.getTime(); if(current >= start && current < start + 3600000) return 'en_cours'; if(current < start && (start - current) < 172800000) return 'bientot'; return 'futur'; };
            const getRelativeRdvLabel = (r) => { if (!r.date || !r.heure) return ''; const nowDate = now.value ? new Date(now.value) : new Date(); const start = new Date(r.date + 'T' + r.heure); const dureeRdvMs = 60 * 60 * 1000; const diffMs = start - nowDate; if (diffMs <= -dureeRdvMs) return ''; if (diffMs < 0 && diffMs > -dureeRdvMs) { return 'RDV en cours'; } const diffMin = Math.round(diffMs / 60000); if (diffMin < 1) { return "RDV dans moins d‚Äô1 minute"; } if (diffMin < 60) { return `RDV dans ${diffMin} min`; } const diffHours = Math.floor(diffMin / 60); const restMin = diffMin % 60; if (diffHours < 24) { if (restMin === 0) { return `RDV dans ${diffHours}h`; } return `RDV dans ${diffHours}h ${restMin}min`; } const diffDays = Math.round(diffMin / (24 * 60)); if (diffDays === 1) { return 'RDV dans 1 jour'; } return `RDV dans ${diffDays} jours`; };
            const nextRdvLabel = computed(() => { if (!rdvList.value || rdvList.value.length === 0) return ''; const todayStr = new Date().toISOString().split('T')[0]; const nowDate = now.value ? new Date(now.value) : new Date(); const candidates = rdvList.value.filter(r => r.date === todayStr && r.statut !== 'poubelle' && r.heure).map(r => ({ rdv: r, start: new Date(r.date + 'T' + r.heure) })).filter(o => o.start > nowDate); if (candidates.length === 0) return ''; candidates.sort((a, b) => a.start - b.start); return getRelativeRdvLabel(candidates[0].rdv); });
            const pendingStatusList = computed(() => { return rdvList.value.filter(r => { if(!['confirme', 'a_confirmer'].includes(r.statut)) return false; if(!r.date || !r.heure) return false; const end = new Date(r.date+'T'+r.heure).getTime() + 3600000; return now.value.getTime() > end; }); });
            const pendingStatusCount = computed(() => pendingStatusList.value.length);

            // Computed pour les stats du prospecteur
            const prospecteurStats = computed(() => {
                if (!selectedProspecteur.value) return { ca: 0, honoredCount: 0, commissions: 0, tips: 0, net: 0, tiers: [] };

                // Utiliser les filtres du dashboard ou le mois/ann√©e actuel par d√©faut
                const selectedMonth = dashboardFilters.mois ? parseInt(dashboardFilters.mois) - 1 : new Date().getMonth();
                const selectedYear = dashboardFilters.annee ? parseInt(dashboardFilters.annee) : new Date().getFullYear();
                const currentMonth = selectedMonth;
                const currentYear = selectedYear;
                
                // CA g√©n√©r√© (RDV honor√©s ce mois)
                const honoredRdv = rdvList.value.filter(r => {
                    if (r.statut !== 'honore' || r.createdBy !== selectedProspecteur.value) return false;
                    if (!r.date) return false;
                    const d = new Date(r.date);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                });

                const ca = honoredRdv.reduce((acc, r) => {
                    const price = getAgencePrice(r);
                    const discount = parseFloat(r.geste_commercial) || 0;
                    return acc + (price - discount);
                }, 0);

                const honoredCount = honoredRdv.length;

                // Calcul des commissions
                const basePrice = parseFloat(globalCommission.base) || 0;
                const bonusThreshold = parseInt(globalCommission.threshold) || 21;
                const bonusStep = parseInt(globalCommission.step) || 10;
                const bonusAmount = parseFloat(globalCommission.amount) || 100;

                let commissions = honoredCount * basePrice;
                if (honoredCount >= bonusThreshold) {
                    const multiplier = Math.floor((honoredCount - bonusThreshold) / bonusStep) + 1;
                    commissions += (multiplier * bonusAmount);
                }

                // Pourboires (calcul√©s depuis les transactions)
                const member = teamList.value.find(m => m.name === selectedProspecteur.value);
                const currentMonthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
                const tips = (member && member.tips && member.tips[currentMonthKey]) || 0;

                const net = ca - commissions - tips;

                // Paliers
                const tiers = [];
                for (let i = bonusThreshold; i <= honoredCount + bonusStep; i += bonusStep) {
                    tiers.push({
                        level: Math.floor((i - bonusThreshold) / bonusStep) + 1,
                        count: i,
                        reached: honoredCount >= i
                    });
                }

                return { ca, honoredCount, commissions, tips, net, tiers };
            });

            // Toutes les transactions (admin)
            const allTransactions = computed(() => {
                if (!selectedProspecteur.value) return [];
                return transactions.value;
            });

            // Transactions visibles (prospecteur) - Afficher TOUTES les transactions
            const visibleTransactions = computed(() => {
                // Afficher toutes les transactions, m√™me celles cach√©es (elles auront un indicateur visuel)
                return transactions.value.filter(t => t.userId === user.name);
            });

            // Portefeuille utilisateur (prospecteur) - Calcul bas√© sur les transactions non cach√©es
            const userPortefeuille = computed(() => {
                // Calculer le total uniquement avec les transactions non cach√©es
                const total = transactions.value
                    .filter(t => t.userId === user.name && !t.hidden)
                    .reduce((acc, t) => acc + (parseFloat(t.amount) || 0), 0);
                return { total };
            });

            // Stats de chaque prospecteur (pour les cartes)
            const prospectorsWithStats = computed(() => {
                // Utiliser les filtres du dashboard ou le mois/ann√©e actuel par d√©faut
                const selectedMonth = dashboardFilters.mois ? parseInt(dashboardFilters.mois) - 1 : new Date().getMonth();
                const selectedYear = dashboardFilters.annee ? parseInt(dashboardFilters.annee) : new Date().getFullYear();
                const currentMonth = selectedMonth;
                const currentYear = selectedYear;
                
                return onlyProspectors.value.map(prosp => {
                    const honoredRdv = rdvList.value.filter(r => {
                        if (r.statut !== 'honore' || r.createdBy !== prosp.name) return false;
                        if (!r.date) return false;
                        const d = new Date(r.date);
                        return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                    });

                    const ca = honoredRdv.reduce((acc, r) => {
                        const price = getAgencePrice(r);
                        const discount = parseFloat(r.geste_commercial) || 0;
                        return acc + (price - discount);
                    }, 0);

                    const honoredCount = honoredRdv.length;

                    // Calcul des commissions
                    const basePrice = parseFloat(globalCommission.base) || 0;
                    const bonusThreshold = parseInt(globalCommission.threshold) || 21;
                    const bonusStep = parseInt(globalCommission.step) || 10;
                    const bonusAmount = parseFloat(globalCommission.amount) || 100;

                    let commissions = honoredCount * basePrice;
                    if (honoredCount >= bonusThreshold) {
                        const multiplier = Math.floor((honoredCount - bonusThreshold) / bonusStep) + 1;
                        commissions += (multiplier * bonusAmount);
                    }

                    const currentMonthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
                    const tips = (prosp.tips && prosp.tips[currentMonthKey]) || 0;

                    const net = ca - commissions - tips;

                    return {
                        name: prosp.name,
                        ca,
                        honoredCount,
                        net
                    };
                });
            });

            // Prospecteurs filtr√©s par recherche
            const displayedProspectors = computed(() => {
                if (!portefeuilleSearch.value) return prospectorsWithStats.value;
                const search = portefeuilleSearch.value.toLowerCase();
                return prospectorsWithStats.value.filter(p => p.name.toLowerCase().includes(search));
            });

            // Stats admin (solde jour brut, solde mois brut, solde mois net)
            const adminStats = computed(() => {
                const today = new Date().toISOString().split('T')[0];
                // Utiliser les filtres du dashboard ou le mois/ann√©e actuel par d√©faut
                const selectedMonth = dashboardFilters.mois ? parseInt(dashboardFilters.mois) - 1 : new Date().getMonth();
                const selectedYear = dashboardFilters.annee ? parseInt(dashboardFilters.annee) : new Date().getFullYear();
                const currentMonth = selectedMonth;
                const currentYear = selectedYear;

                // CA du jour (brut) = prix des RDV honor√©s aujourd'hui
                const caDaily = rdvList.value
                    .filter(r => r.statut === 'honore' && r.date === today)
                    .reduce((acc, r) => {
                        const price = getAgencePrice(r);
                        const discount = parseFloat(r.geste_commercial) || 0;
                        return acc + (price - discount);
                    }, 0);

                // CA du mois (brut) = prix des RDV honor√©s ce mois
                const caMonthly = rdvList.value
                    .filter(r => {
                        if (r.statut !== 'honore' || !r.date) return false;
                        const d = new Date(r.date);
                        return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                    })
                    .reduce((acc, r) => {
                        const price = getAgencePrice(r);
                        const discount = parseFloat(r.geste_commercial) || 0;
                        return acc + (price - discount);
                    }, 0);

                // Calcul des commissions du mois (ce qu'on verse aux prospecteurs)
                const basePrice = parseFloat(globalCommission.base) || 10;
                const bonusThreshold = parseInt(globalCommission.threshold) || 21;
                const bonusStep = parseInt(globalCommission.step) || 10;
                const bonusAmount = parseFloat(globalCommission.amount) || 100;
                const currentMonthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
                
                let monthlyCommissions = 0;
                const monthlyCommissionMap = {};
                
                // Compter les RDV honor√©s par prospecteur ce mois
                rdvList.value.forEach(r => {
                    if (r.statut === 'honore' && r.createdBy && r.date) {
                        const d = new Date(r.date);
                        if (d.getMonth() === currentMonth && d.getFullYear() === currentYear) {
                            const uName = r.createdBy;
                            const userObj = teamList.value.find(u => u.name === uName);
                            const isRoleAdmin = userObj && userObj.role === 'admin';
                            const isNameInAdminList = adminNamesList.value.includes(uName);
                            
                            // Exclure les admins des commissions
                            if (!isNameInAdminList && !isRoleAdmin) {
                                if (!monthlyCommissionMap[uName]) monthlyCommissionMap[uName] = 0;
                                monthlyCommissionMap[uName]++;
                            }
                        }
                    }
                });

                // Calculer les commissions totales du mois (primes + bonus + pourboires)
                for (const [userName, count] of Object.entries(monthlyCommissionMap)) {
                    let userTotal = count * basePrice;
                    if (count >= bonusThreshold) {
                        const multiplier = Math.floor((count - bonusThreshold) / bonusStep) + 1;
                        userTotal += (multiplier * bonusAmount);
                    }
                    
                    // Ajouter les pourboires du mois
                    const userObj = teamList.value.find(u => u.name === userName);
                    if (userObj && userObj.tips && userObj.tips[currentMonthKey]) {
                        userTotal += parseFloat(userObj.tips[currentMonthKey]) || 0;
                    }

                    monthlyCommissions += userTotal;
                }

                // CA net du mois = CA brut du mois - commissions du mois
                const netMonthly = caMonthly - monthlyCommissions;

                return { 
                    caDaily,      // Solde du jour (brut)
                    caMonthly,    // Solde du mois (brut)
                    netMonthly    // Solde du mois (net = brut - commissions)
                };
            });
            const displayStatus = (r) => { if(r.statut === 'honore') return user.role==='admin' ? (r.honorBilling==='facture'?'Honor√© ‚Ä¢ Factur√©':'Honor√© ‚Ä¢ Non factur√©') : 'Honor√©'; if(r.statut === 'pas_venu') return 'Pas Venu'; if(r.statut === 'annule') return 'Annul√©'; if(r.statut === 'a_confirmer') return '√Ä Confirmer'; return 'Confirm√©'; };
            const statusClass = (s) => ({ 'honore': 'bg-green-100 text-green-700', 'pas_venu': 'bg-red-100 text-red-700', 'annule': 'bg-gray-200 text-gray-500', 'a_confirmer': 'bg-orange-100 text-orange-700', 'confirme': 'bg-blue-100 text-blue-700' }[s] || 'bg-gray-100');

            // ================= FONCTIONS BILAN =================
            const MONTHS_FR = ["janvier","f√©vrier","mars","avril","mai","juin","juillet","ao√ªt","septembre","octobre","novembre","d√©cembre"];
            const pad = (n) => String(n).padStart(2,'0');
            const formatBilanPrice = (n) => { let x = Number(n||0).toFixed(2); return x.replace('.',',').replace(/\B(?=(\d{3})+(?!\d))/g," "); };
            const formatBilanDate = (s) => { if(!s) return '-'; return new Date(s).toLocaleDateString('fr-FR'); };
            const monthKey = (d) => { if(typeof d==='string') d=new Date(d); return `${d.getFullYear()}-${pad(d.getMonth()+1)}`; };
            const getNextMonthKey = (s) => { const d = new Date(s); d.setDate(1); d.setMonth(d.getMonth()+1); return monthKey(d); };
            const labelMonth = (m) => { if(!m) return ''; const [y,mo] = m.split('-'); return `${MONTHS_FR[parseInt(mo)-1]} ${y}`; };
            const isBilanTvaApplicable = (rDate) => { if(!bilanConfig.tvaActive) return false; if(!bilanConfig.tvaStart) return false; return rDate >= bilanConfig.tvaStart; };
            const getBilanLineVals = (r) => { 
                const applicable = isBilanTvaApplicable(r.date); 
                // TOUJOURS utiliser le prix de l'agence actuel (comme dans le Tableau de bord)
                let prixUnitaire = 0;
                // Chercher par agenceId d'abord
                if (r.agenceId) {
                    const agence = agences.value.find(a => a.id === r.agenceId);
                    if (agence && agence.prix) {
                        prixUnitaire = parseFloat(agence.prix) || 0;
                    }
                }
                // Si pas trouv√©, chercher par clientId (qui contient l'ID de l'agence dans le bilan)
                if (prixUnitaire === 0 && r.clientId) {
                    const agence = agences.value.find(a => a.id === r.clientId);
                    if (agence && agence.prix) {
                        prixUnitaire = parseFloat(agence.prix) || 0;
                    }
                }
                // Si pas trouv√©, chercher par nom d'agence
                if (prixUnitaire === 0 && r.agence) {
                    const agence = agences.value.find(a => a.nom === r.agence);
                    if (agence && agence.prix) {
                        prixUnitaire = parseFloat(agence.prix) || 0;
                    }
                }
                // Fallback sur r.tarif seulement si vraiment pas d'agence trouv√©e
                if (prixUnitaire === 0 && r.tarif) {
                    prixUnitaire = parseFloat(r.tarif) || 0;
                }
                // Recalculer TOUJOURS avec le prix r√©el de l'agence (ignorer r.total et r.netTotal)
                const totalHT = r.rdv * prixUnitaire;
                // Si il y a un geste commercial, le soustraire
                const ht = totalHT - (r.geste ? (r.gesteMontant || 0) : 0);
                const tva = applicable ? (ht * bilanConfig.tvaRate / 100) : 0; 
                return { ht: Math.max(0, ht), tva, ttc: Math.max(0, ht) + tva, applicable }; 
            };

            const loadBilanConfig = async () => {
                try {
                    const d = await db.collection('bilan_config').doc('settings').get();
                    if(d.exists) Object.assign(bilanConfig, d.data());
                } catch(e) { console.error('Erreur chargement config bilan:', e); }
            };

            const loadBilanData = () => {
                db.collection('bilan_rdv').onSnapshot(s => {
                    bilanRows.value = [];
                    s.forEach(d => {
                        const r = d.data();
                        r.total = Number(r.total || (r.rdv * r.tarif));
                        r.netTotal = Math.max(0, r.total - (r.geste ? (r.gesteMontant || 0) : 0));
                        bilanRows.value.push({id: d.id, ...r});
                    });
                    buildBilanMonthOptions();
                    renderBilanTable();
                    
                    // Charger les objectifs et tarifs personnalis√©s
                    loadObjectifsData();
                    loadTarifsPersonnalises();
                    
                    // V√©rifier les rappels commerciaux apr√®s chargement des donn√©es
                    if (user.logged) {
                        setTimeout(() => {
                            checkCommercialReminders();
                        }, 1000);
                    }
                });
            };

            const buildBilanMonthOptions = () => {
                const now = new Date();
                const endY = now.getFullYear();
                const startY = 2024;
                
                // G√©n√©rer les options d'ann√©es (en strings pour la compatibilit√© avec v-model)
                const years = [];
                for(let y = startY; y <= endY; y++) {
                    years.push(y.toString());
                }
                bilanYearOptions.value = years;
                dashboardYearOptions.value = years;
                
                // G√©n√©rer les options de mois (pour compatibilit√© avec l'ancien code)
                const endM = now.getMonth() + 2;
                let y = startY, m = 1;
                const options = [];
                while(y < endY || (y === endY && m <= endM)) {
                    options.push({ value: `${y}-${pad(m)}`, label: labelMonth(`${y}-${pad(m)}`) });
                    m++;
                    if(m > 12) { m = 1; y++; }
                }
                bilanMonthOptions.value = options;
                
                // Initialiser mois et ann√©e si vides pour le bilan
                if(!bilanFilters.mois) {
                    bilanFilters.mois = pad(now.getMonth() + 1);
                }
                if(!bilanFilters.annee) {
                    bilanFilters.annee = now.getFullYear().toString();
                }
                
                // Initialiser mois et ann√©e si vides pour le dashboard
                if(!dashboardFilters.mois) {
                    dashboardFilters.mois = pad(now.getMonth() + 1);
                }
                if(!dashboardFilters.annee) {
                    dashboardFilters.annee = now.getFullYear().toString();
                }
            };
            
            // Initialiser les options d'ann√©e au d√©marrage pour le dashboard et le bilan
            const initDashboardYearOptions = () => {
                const now = new Date();
                const endY = now.getFullYear();
                const startY = 2024;
                const years = [];
                for(let y = startY; y <= endY; y++) {
                    years.push(y.toString());
                }
                // Initialiser les options pour le dashboard ET le bilan
                dashboardYearOptions.value = years;
                bilanYearOptions.value = years;
                
                // Initialiser les valeurs par d√©faut pour le dashboard
                if(!dashboardFilters.mois) {
                    dashboardFilters.mois = pad(now.getMonth() + 1);
                }
                if(!dashboardFilters.annee) {
                    dashboardFilters.annee = now.getFullYear().toString();
                }
                
                // Initialiser les valeurs par d√©faut pour le bilan
                if(!bilanFilters.mois) {
                    bilanFilters.mois = pad(now.getMonth() + 1);
                }
                if(!bilanFilters.annee) {
                    bilanFilters.annee = now.getFullYear().toString();
                }
            };

            const getBilanCommerciaux = (idx) => {
                const block = bilanForm.blocks[idx];
                if(!block || !block.agenceId) return [];
                const ag = agences.value.find(a => a.id === block.agenceId);
                if(!ag) return [];
                if(ag.commerciauxDetails) return ag.commerciauxDetails.map(c => c.name);
                if(ag.commerciaux) return ag.commerciaux;
                return [];
            };
            
            const hasBilanCommerciaux = (idx) => {
                return getBilanCommerciaux(idx).length > 0;
            };

            const onBilanAgenceChange = (idx) => {
                const block = bilanForm.blocks[idx];
                const ag = agences.value.find(a => a.id === block.agenceId);
                if(ag && ag.prix) block.tarif = parseFloat(ag.prix) || 0;
                block.commercial = '';
            };

            const addBilanBlock = () => {
                bilanForm.blocks.push({ agenceId: '', commercial: '', rdv: 1, tarif: 0 });
            };

            const removeBilanBlock = (idx) => {
                bilanForm.blocks.splice(idx, 1);
            };

            const toggleBilanReport = () => {
                bilanForm.reporte = !bilanForm.reporte;
            };

            // Fonction pour obtenir le tarif personnalis√© selon le nombre de RDV d√©j√† factur√©s
            const getTarifPersonnalise = (agenceId, commercial, mois) => {
                const tarifsPerso = tarifsPersonnalises.value[agenceId];
                if(!tarifsPerso || !tarifsPerso.tarifs || tarifsPerso.tarifs.length === 0) {
                    return null; // Pas de tarif personnalis√©
                }

                // Compter le nombre de RDV d√©j√† factur√©s pour cette agence/commercial ce mois
                const rdvDejaFactures = bilanRows.value
                    .filter(r => {
                        const rMois = r.periodMonth || monthKey(r.date);
                        const rAgence = agences.value.find(a => a.nom === r.agence);
                        if(!rAgence || rAgence.id !== agenceId) return false;
                        if(rMois !== mois) return false;
                        const rComm = r.commercial || '';
                        const comm = commercial || '';
                        return rComm === comm;
                    })
                    .reduce((sum, r) => sum + (r.rdv || 0), 0);

                // Trier les tarifs par rdvMin d√©croissant pour trouver le bon palier
                const tarifsTries = [...tarifsPerso.tarifs].sort((a, b) => b.rdvMin - a.rdvMin);
                
                // Trouver le tarif applicable selon le nombre de RDV d√©j√† factur√©s
                for(const tarif of tarifsTries) {
                    if(rdvDejaFactures >= tarif.rdvMin - 1) {
                        return tarif.montant;
                    }
                }

                // Si aucun palier n'est atteint, retourner le premier tarif (le plus bas)
                return tarifsTries[tarifsTries.length - 1]?.montant || null;
            };

            const saveBilanRdv = async () => {
                if(!bilanForm.date) return alert("Date requise");
                const isReport = bilanForm.reporte;
                const targetMonth = isReport ? getNextMonthKey(bilanForm.date) : monthKey(bilanForm.date);
                const batch = db.batch();
                
                bilanForm.blocks.forEach(block => {
                    if(!block.agenceId) return;
                    const ag = agences.value.find(a => a.id === block.agenceId);
                    if(!ag) return;
                    
                    // V√©rifier si un tarif personnalis√© doit √™tre appliqu√©
                    let tarif = Number(block.tarif);
                    const tarifPerso = getTarifPersonnalise(block.agenceId, block.commercial || '', targetMonth);
                    if(tarifPerso !== null) {
                        tarif = tarifPerso;
                        // Mettre √† jour le tarif dans le formulaire pour affichage
                        block.tarif = tarif;
                    }
                    
                    const rdv = Number(block.rdv);
                    if(rdv > 0) {
                        const ref = db.collection('bilan_rdv').doc();
                        batch.set(ref, {
                            clientId: block.agenceId,
                            agence: ag.nom,
                            commercial: block.commercial || '',
                            rdv,
                            tarif,
                            total: rdv * tarif,
                            date: bilanForm.date,
                            periodDate: bilanForm.date,
                            periodMonth: targetMonth,
                            reporte: isReport,
                            geste: false,
                            tarifPersonnalise: tarifPerso !== null,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                });
                
                await batch.commit();
                bilanForm.blocks = [{ agenceId: '', commercial: '', rdv: 1, tarif: 0 }];
                bilanForm.reporte = false;
                showNotification('‚úÖ RDV factur√©s enregistr√©s', 'success', 'fa-check-circle');
            };

            const getFilteredBilanData = () => {
                const jour = bilanFilters.jour;
                const mois = bilanFilters.mois;
                const annee = bilanFilters.annee;
                // Construire la cl√© de mois √† partir de mois et ann√©e
                const m = (mois && annee) ? `${annee}-${mois}` : '';
                const ag = bilanFilters.agence;
                const co = bilanFilters.commercial;
                const search = bilanFilters.search?.toLowerCase().trim();
                
                // Si on a une recherche par nom/commercial, on ne filtre pas par mois/ann√©e pour permettre la recherche sur toutes les ann√©es
                const hasSearch = search && search.trim() !== '';
                
                let data = bilanRows.value.filter(r => {
                    if(jour) return (r.date === jour || r.periodDate === jour);
                    // Si on a une recherche active, on ignore le filtre de mois/ann√©e pour permettre la recherche sur toutes les ann√©es
                    if(hasSearch) return true; // Afficher tous les r√©sultats de recherche
                    if(!m) return true; // Si pas de filtre mois/ann√©e, tout afficher
                    const billingM = r.periodMonth || monthKey(r.date);
                    const activityM = monthKey(r.periodDate || r.date);
                    return (billingM === m) || (activityM === m && r.reporte);
                });
                if(ag) data = data.filter(r => r.agence === ag);
                if(co) data = data.filter(r => r.commercial === co);
                if(search) {
                    // Recherche dans agence ET commercial, et si on trouve un commercial, on affiche aussi son agence
                    data = data.filter(r => {
                        const agenceMatch = r.agence?.toLowerCase().includes(search);
                        const commercialMatch = r.commercial?.toLowerCase().includes(search);
                        return agenceMatch || commercialMatch;
                    });
                }
                return data.sort((a,b) => (a.periodDate || a.date).localeCompare(b.periodDate || b.date));
            };

            const bilanStats = computed(() => {
                // Calculer directement depuis rdvList comme le tableau de bord pour garantir la coh√©rence
                const mois = bilanFilters.mois;
                const annee = bilanFilters.annee;
                const ag = bilanFilters.agence;
                const co = bilanFilters.commercial;
                
                // D√©terminer le mois et l'ann√©e √† utiliser
                const selectedMonth = mois ? parseInt(mois) - 1 : new Date().getMonth();
                const selectedYear = annee ? parseInt(annee) : new Date().getFullYear();
                
                // Filtrer les RDV honor√©s factur√©s du mois s√©lectionn√©
                let filteredRdvs = rdvList.value.filter(r => {
                    if (r.honorBilling !== 'facture' || !r.date || r.statut !== 'honore') return false;
                    const d = new Date(r.date);
                    if (d.getMonth() !== selectedMonth || d.getFullYear() !== selectedYear) return false;
                    // Filtrer par agence si s√©lectionn√©e
                    if (ag) {
                        const agenceName = getAgenceName(r.agenceId);
                        if (agenceName !== ag) return false;
                    }
                    // Filtrer par commercial si s√©lectionn√©
                    if (co) {
                        const commercialName = r.createdBy || '';
                        if (commercialName !== co) return false;
                    }
                    return true;
                });
                
                // Calculer HT, TVA, TTC comme le tableau de bord
                let rdv = 0, ht = 0, tva = 0, ttc = 0;
                filteredRdvs.forEach(r => {
                    rdv++;
                    const price = getAgencePrice(r);
                    const discount = parseFloat(r.geste_commercial) || 0;
                    const htLine = price - discount;
                    const applicable = isBilanTvaApplicable(r.date);
                    const tvaLine = applicable ? (htLine * bilanConfig.tvaRate / 100) : 0;
                    const ttcLine = htLine + tvaLine;
                    
                    ht += htLine;
                    tva += tvaLine;
                    ttc += ttcLine;
                });
                
                return { rdv, ht, tva, ttc };
            });
// --- LOGIQUE FACTURATION RAPIDE ---
            const billingSummaryModal = reactive({ open: false });
            const billingSummarySearch = ref('');

            const openBillingSummary = () => {
                billingSummarySearch.value = '';
                billingSummaryModal.open = true;
            };

            const billingStatsGrouped = computed(() => {
                // On r√©cup√®re les donn√©es filtr√©es actuelles (Mois/Ann√©e s√©lectionn√©)
                const data = getFilteredBilanData();
                const grouped = {};

                data.forEach(r => {
                    const agName = r.agence || 'Agence Inconnue';
                    const commName = r.commercial || '';
                    
                    if (!grouped[agName]) {
                        grouped[agName] = { totalHT: 0, totalTVA: 0, totalTTC: 0, commerciaux: {} };
                    }

                    const vals = getBilanLineVals(r); // R√©cup√®re HT, TVA, TTC calcul√©s

                    // Ajout aux totaux agence
                    grouped[agName].totalHT += vals.ht;
                    grouped[agName].totalTVA += vals.tva;
                    grouped[agName].totalTTC += vals.ttc;

                    // D√©tail par commercial
                    if (!grouped[agName].commerciaux[commName]) {
                        grouped[agName].commerciaux[commName] = { nom: commName, rdv: 0, ht: 0, tva: 0, ttc: 0 };
                    }
                    grouped[agName].commerciaux[commName].rdv += r.rdv;
                    grouped[agName].commerciaux[commName].ht += vals.ht;
                    grouped[agName].commerciaux[commName].tva += vals.tva;
                    grouped[agName].commerciaux[commName].ttc += vals.ttc;
                });

                // Convertir l'objet commerciaux en tableau pour l'affichage
                Object.keys(grouped).forEach(key => {
                    grouped[key].commerciaux = Object.values(grouped[key].commerciaux);
                });

                return grouped;
            });

            // Filtrage des statistiques par recherche
            const filteredBillingStatsGrouped = computed(() => {
                const search = billingSummarySearch.value?.toLowerCase().trim();
                if (!search) return billingStatsGrouped.value;
                
                const filtered = {};
                Object.keys(billingStatsGrouped.value).forEach(agName => {
                    if (agName.toLowerCase().includes(search)) {
                        filtered[agName] = billingStatsGrouped.value[agName];
                    }
                });
                return filtered;
            });

            const displayedBilanRows = computed(() => {
                const data = getFilteredBilanData();
                const totalPages = Math.ceil(data.length / ITEMS_PER_PAGE_BILAN);
                if(bilanCurrentPage.value < 1) bilanCurrentPage.value = 1;
                if(bilanCurrentPage.value > totalPages && totalPages > 0) bilanCurrentPage.value = totalPages;
                const start = (bilanCurrentPage.value - 1) * ITEMS_PER_PAGE_BILAN;
                return data.slice(start, start + ITEMS_PER_PAGE_BILAN);
            });

            const bilanTotalPages = computed(() => {
                return Math.ceil(getFilteredBilanData().length / ITEMS_PER_PAGE_BILAN) || 1;
            });

            const renderBilanTable = () => {
                bilanCurrentPage.value = 1;
            };

            const goToPreviousMonth = () => {
                const currentDate = new Date();
                if (bilanFilters.mois && bilanFilters.annee) {
                    // Si on a d√©j√† un mois/ann√©e s√©lectionn√©, aller au mois pr√©c√©dent
                    const year = parseInt(bilanFilters.annee);
                    const month = parseInt(bilanFilters.mois) - 1; // -1 car on veut l'index du mois (0-11)
                    const targetDate = new Date(year, month, 1);
                    targetDate.setMonth(targetDate.getMonth() - 1); // Aller au mois pr√©c√©dent
                    bilanFilters.annee = String(targetDate.getFullYear());
                    bilanFilters.mois = String(targetDate.getMonth() + 1).padStart(2, '0');
                } else {
                    // Sinon, aller au mois pr√©c√©dent depuis le mois actuel
                    currentDate.setMonth(currentDate.getMonth() - 1);
                    bilanFilters.annee = String(currentDate.getFullYear());
                    bilanFilters.mois = String(currentDate.getMonth() + 1).padStart(2, '0');
                }
                bilanFilters.jour = '';
                renderBilanTable();
            };

            const clearBilanFilters = () => {
                bilanFilters.jour = '';
                // Remettre le mois/ann√©e au mois actuel au lieu de vider
                const currentDate = new Date();
                bilanFilters.mois = String(currentDate.getMonth() + 1).padStart(2, '0');
                bilanFilters.annee = String(currentDate.getFullYear());
                bilanFilters.agence = '';
                bilanFilters.commercial = '';
                bilanFilters.search = '';
                renderBilanTable();
            };

            const deleteSelectedBilan = async () => {
                if(!confirm('Supprimer ?')) return;
                const batch = db.batch();
                selectedBilanIds.value.forEach(id => {
                    batch.delete(db.collection('bilan_rdv').doc(id));
                });
                await batch.commit();
                selectedBilanIds.value = [];
            };

            const isAllBilanSelected = computed(() => {
                return displayedBilanRows.value.length > 0 && 
                       displayedBilanRows.value.every(r => selectedBilanIds.value.includes(r.id));
            });

            const toggleAllBilan = (event) => {
                if(event.target.checked) {
                    selectedBilanIds.value = displayedBilanRows.value.map(r => r.id);
                } else {
                    selectedBilanIds.value = [];
                }
            };

            const changeBilanPage = (delta) => {
                bilanCurrentPage.value += delta;
            };

            const openBilanEdit = (r) => {
                bilanEditModal.rdv = r;
                bilanEditModal.form = { date: r.date, agence: r.agence, commercial: r.commercial || '', rdv: r.rdv, tarif: r.tarif, reporte: r.reporte || false };
                bilanEditModal.open = true;
            };

            const saveBilanEdit = async () => {
                if(!bilanEditModal.rdv) return;
                const r = bilanEditModal.rdv;
                const f = bilanEditModal.form;
                const isReport = f.reporte;
                const tm = isReport ? getNextMonthKey(f.date) : monthKey(f.date);
                await db.collection('bilan_rdv').doc(r.id).update({
                    date: f.date,
                    periodDate: f.date,
                    periodMonth: tm,
                    commercial: f.commercial,
                    rdv: Number(f.rdv),
                    tarif: Number(f.tarif),
                    total: Number(f.rdv) * Number(f.tarif),
                    reporte: isReport
                });
                bilanEditModal.open = false;
                showNotification('‚úÖ RDV modifi√©', 'success', 'fa-check-circle');
            };

            const showBilanCommercialModal = () => {
                const mm = (bilanFilters.mois && bilanFilters.annee) ? `${bilanFilters.annee}-${bilanFilters.mois}` : monthKey(new Date());
                const year = mm.split('-')[0];
                let data;
                if(bilanPeriod.value === 'year') {
                    data = bilanRows.value.filter(r => (r.periodMonth || monthKey(r.date)).startsWith(year));
                } else {
                    data = bilanRows.value.filter(r => (r.periodMonth || monthKey(r.date)) === mm);
                }
                
                // Statistiques globales
                let totalRdv = 0;
                let totalHT = 0;
                let totalTVA = 0;
                let totalTTC = 0;
                
                // Calculs par agence
                let map = {};
                data.forEach(r => {
                    let k = r.agence;
                    if(!map[k]) map[k] = { rdvTotal: 0, details: {} };
                    let c = r.commercial || "";
                    if(!map[k].details[c]) map[k].details[c] = {rdv: 0, total: 0};
                    map[k].details[c].rdv += r.rdv;
                    const lineTotal = r.netTotal || r.total || 0;
                    map[k].details[c].total += lineTotal;
                    map[k].rdvTotal += r.rdv;
                    
                    // Totaux globaux
                    totalRdv += r.rdv;
                    const vals = getBilanLineVals(r);
                    totalHT += vals.ht;
                    totalTVA += vals.tva;
                    totalTTC += vals.ttc;
                });

                // HTML avec statistiques en haut
                let html = `<div class="mb-6 grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-blue-50 rounded-xl p-4 border border-blue-200">
                        <div class="text-xs font-bold text-blue-600 uppercase mb-1">Total RDV</div>
                        <div class="text-2xl font-black text-blue-700">${totalRdv}</div>
                    </div>
                    <div class="bg-green-50 rounded-xl p-4 border border-green-200">
                        <div class="text-xs font-bold text-green-600 uppercase mb-1">Total HT</div>
                        <div class="text-2xl font-black text-green-700">${formatBilanPrice(totalHT)}‚Ç¨</div>
                    </div>`;
                
                if(bilanConfig.tvaActive) {
                    html += `<div class="bg-orange-50 rounded-xl p-4 border border-orange-200">
                        <div class="text-xs font-bold text-orange-600 uppercase mb-1">TVA</div>
                        <div class="text-2xl font-black text-orange-700">${formatBilanPrice(totalTVA)}‚Ç¨</div>
                    </div>
                    <div class="bg-purple-50 rounded-xl p-4 border border-purple-200">
                        <div class="text-xs font-bold text-purple-600 uppercase mb-1">Total TTC</div>
                        <div class="text-2xl font-black text-purple-700">${formatBilanPrice(totalTTC)}‚Ç¨</div>
                    </div>`;
                } else {
                    html += `<div class="bg-purple-50 rounded-xl p-4 border border-purple-200 col-span-2">
                        <div class="text-xs font-bold text-purple-600 uppercase mb-1">Total</div>
                        <div class="text-2xl font-black text-purple-700">${formatBilanPrice(totalHT)}‚Ç¨</div>
                    </div>`;
                }
                
                html += `</div><div class="overflow-x-auto"><table class="w-full"><thead><tr class="bg-slate-50"><th class="px-4 py-3 text-left text-xs font-bold">Agence</th><th class="px-4 py-3 text-left text-xs font-bold">Commercial</th><th class="px-4 py-3 text-right text-xs font-bold">RDV</th><th class="px-4 py-3 text-right text-xs font-bold">Total HT</th><th class="px-4 py-3 text-right text-xs font-bold">Action</th></tr></thead><tbody>`;
                
                Object.keys(map).sort().forEach(ag => {
                    let first = true;
                    // Trier les commerciaux : d'abord ceux avec nom, puis "Autre", puis ""
                    const commKeys = Object.keys(map[ag].details).sort((a, b) => {
                        if(a === "" && b !== "") return 1;
                        if(a !== "" && b === "") return -1;
                        if(a === "Autre" && b !== "Autre" && b !== "") return 1;
                        if(a !== "Autre" && b === "Autre" && a !== "") return -1;
                        return a.localeCompare(b);
                    });
                    
                    commKeys.forEach(comm => {
                        const d = map[ag].details[comm];
                        const commDisplay = comm || "Sans commercial";
                        html += `<tr class="border-t border-slate-100">
                            <td class="px-4 py-3 ${first ? 'font-bold text-blue-600' : ''}">${first ? ag : ''}</td>
                            <td class="px-4 py-3">${commDisplay}</td>
                            <td class="px-4 py-3 text-right font-bold">${d.rdv}</td>
                            <td class="px-4 py-3 text-right">${formatBilanPrice(d.total)}‚Ç¨</td>
                            <td class="px-4 py-3 text-right"><button data-scope="commercial" data-agence="${ag}" data-commercial="${comm}" class="bilan-export-pdf bg-blue-100 text-blue-600 px-3 py-1 rounded-lg text-xs font-bold hover:bg-blue-200"><i class="fa-solid fa-file-pdf"></i></button></td>
                        </tr>`;
                        first = false;
                    });
                });
                html += `</tbody></table></div>`;
                
                const contentDiv = document.getElementById('bilanContent');
                if(contentDiv) {
                    contentDiv.innerHTML = html;
                    // Attacher les √©v√©nements apr√®s l'insertion du HTML
                    setTimeout(() => {
                        contentDiv.querySelectorAll('.bilan-export-pdf').forEach(btn => {
                            btn.addEventListener('click', () => {
                                exportBilanPdf(btn.dataset.scope, btn.dataset.agence, btn.dataset.commercial);
                            });
                        });
                    }, 100);
                }
                bilanModal.open = true;
            };

            const exportComptaExcel = () => {
                const data = getFilteredBilanData();
                if(data.length === 0) return alert("Rien √† exporter");
                const rowsExcel = data.map(r => {
                    const v = getBilanLineVals(r);
                    return {
                        "Date": r.periodDate || r.date,
                        "Agence": r.agence,
                        "Commercial": r.commercial || "",
                        "Nb RDV": r.rdv,
                        "Tarif Unit": r.tarif,
                        "Total HT": v.ht,
                        "TVA": v.tva,
                        "Total TTC": bilanConfig.tvaActive ? v.ttc : v.ht,
                        "Report√©": r.reporte ? "OUI" : "NON"
                    };
                });
                const ws = XLSX.utils.json_to_sheet(rowsExcel);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Facturation");
                const m = (bilanFilters.mois && bilanFilters.annee) ? `${bilanFilters.annee}-${bilanFilters.mois}` : monthKey(new Date());
                XLSX.writeFile(wb, `Export_Compta_${m}.xlsx`);
            };

            const exportBilanPdf = (scope, agence, commercial) => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: (scope==='commercial')?'landscape':'portrait' });
                const m = bilanFilters.mois || monthKey(new Date());
                const jour = bilanFilters.jour;
                const year = m.split('-')[0];
                
                // En-t√™te avec logo et design moderne
                let headerY = 15;
                if(bilanConfig.logo) {
                    try {
                        // Logo √† gauche
                        doc.addImage(bilanConfig.logo, 'JPEG', 14, headerY, 40, 40);
                        headerY = 20;
                    } catch(e) {
                        console.error('Erreur logo:', e);
                    }
                }
                
                // Titre principal avec design
                doc.setFillColor(30, 58, 138);
                doc.rect(0, 0, doc.internal.pageSize.getWidth(), 25, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text("BILAN DE PRESTATION", doc.internal.pageSize.getWidth() / 2, 18, { align: 'center' });
                
                // Sous-titre
                let data, labelP;
                if(jour) {
                    data = bilanRows.value.filter(r => (r.date === jour || r.periodDate === jour));
                    labelP = "JOURN√âE DU " + formatBilanDate(jour).toUpperCase();
                } else {
                    if(bilanPeriod.value === 'year') {
                        data = bilanRows.value.filter(r => (r.periodMonth || monthKey(r.date)).startsWith(year));
                        labelP = "ANN√âE " + year;
                    } else {
                        data = bilanRows.value.filter(r => (r.periodMonth || monthKey(r.date)) === m);
                        labelP = labelMonth(m).toUpperCase();
                    }
                }
                if(scope==='agency') data = data.filter(r => r.agence === agence);
                if(scope==='commercial') data = data.filter(r => r.agence === agence && (r.commercial||'Autre') === commercial);

                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                doc.text(labelP, doc.internal.pageSize.getWidth() / 2, 25, { align: 'center' });
                
                // Informations en haut
                const totalRDV = data.reduce((acc, r) => acc + r.rdv, 0);
                doc.setFillColor(245, 247, 250);
                doc.rect(14, 32, doc.internal.pageSize.getWidth() - 28, 8, 'F');
                doc.setTextColor(50, 50, 50);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text(`Nombre de RDV : ${totalRDV}`, 20, 37);
                doc.text(`Date d'√©dition : ${new Date().toLocaleDateString('fr-FR')}`, doc.internal.pageSize.getWidth() - 20, 37, { align: 'right' });

                // Tableau avec style am√©lior√©
                let cols = ['Date', 'Agence', 'Comm.', 'RDV', 'Tarif'];
                if(bilanConfig.tvaActive) { cols.push('HT', 'TVA', 'TTC'); } else { cols.push('Total TTC'); }
                cols.push('Note');
                let body = data.map(r => {
                    const v = getBilanLineVals(r);
                    let row = [formatBilanDate(r.periodDate || r.date), r.agence, r.commercial||'', r.rdv, formatBilanPrice(r.tarif)];
                    if(bilanConfig.tvaActive) {
                        if(v.applicable) row.push(formatBilanPrice(v.ht), formatBilanPrice(v.tva), formatBilanPrice(v.ttc));
                        else row.push(formatBilanPrice(v.ht), "-", formatBilanPrice(v.ht));
                    } else {
                        row.push(formatBilanPrice(v.ht));
                    }
                    let note = "";
                    if(r.reporte) note = "REPORT√â";
                    if(r.geste) note += ` (Geste ${formatBilanPrice(r.gesteMontant)}‚Ç¨)`;
                    row.push(note);
                    return row;
                });
                
                doc.autoTable({
                    head: [cols],
                    body: body,
                    startY: 45,
                    margin: { left: 14, right: 14 },
                    theme: 'striped',
                    headStyles: {
                        fillColor: [30, 58, 138],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold',
                        fontSize: 10
                    },
                    bodyStyles: {
                        fontSize: 9,
                        textColor: [50, 50, 50]
                    },
                    alternateRowStyles: {
                        fillColor: [245, 247, 250]
                    },
                    styles: {
                        cellPadding: 4,
                        lineColor: [200, 200, 200],
                        lineWidth: 0.1
                    }
                });

                // Totaux avec style
                let totalHT = data.reduce((acc,r) => acc + (r.netTotal || r.total), 0);
                let y = doc.lastAutoTable.finalY + 15;
                
                // Ligne de s√©paration
                doc.setDrawColor(200, 200, 200);
                doc.setLineWidth(0.5);
                doc.line(14, y - 5, doc.internal.pageSize.getWidth() - 14, y - 5);
                
                doc.setFontSize(11);
                doc.setTextColor(50, 50, 50);
                doc.setFont('helvetica', 'normal');
                
                if(bilanConfig.tvaActive) {
                    let totTva = data.reduce((acc,r) => acc + getBilanLineVals(r).tva, 0);
                    let totTTC = totalHT + totTva;
                    
                    // Encadr√© pour les totaux
                    doc.setFillColor(240, 245, 250);
                    doc.roundedRect(14, y, doc.internal.pageSize.getWidth() - 28, 25, 3, 3, 'F');
                    
                    doc.text(`Total HT : ${formatBilanPrice(totalHT)} ‚Ç¨`, 20, y + 8);
                    doc.text(`TVA (${bilanConfig.tvaRate}%) : ${formatBilanPrice(totTva)} ‚Ç¨`, 20, y + 15);
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(13);
                    doc.setTextColor(30, 58, 138);
                    doc.text(`TOTAL TTC : ${formatBilanPrice(totTTC)} ‚Ç¨`, doc.internal.pageSize.getWidth() - 20, y + 12, { align: 'right' });
                } else {
                    // Encadr√© pour le total
                    doc.setFillColor(240, 245, 250);
                    doc.roundedRect(14, y, doc.internal.pageSize.getWidth() - 28, 15, 3, 3, 'F');
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(13);
                    doc.setTextColor(30, 58, 138);
                    doc.text(`TOTAL TTC : ${formatBilanPrice(totalHT)} ‚Ç¨`, doc.internal.pageSize.getWidth() - 20, y + 10, { align: 'right' });
                }

                // Signature en bas
                if(bilanConfig.signature) {
                    try {
                        let sigY = y + 30;
                        if(sigY > 250) { doc.addPage(); sigY = 20; }
                        doc.setFontSize(8);
                        doc.setFont('helvetica', 'normal');
                        doc.setTextColor(100, 100, 100);
                        doc.text("Cachet / Signature :", 14, sigY);
                        doc.addImage(bilanConfig.signature, 'PNG', 14, sigY + 2, 50, 25);
                    } catch(e) {
                        console.error('Erreur signature:', e);
                    }
                }
                
                // Pied de page
                const pageCount = doc.internal.getNumberOfPages();
                for(let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(150, 150, 150);
                    doc.text(`Page ${i} / ${pageCount}`, doc.internal.pageSize.getWidth() / 2, doc.internal.pageSize.getHeight() - 10, { align: 'center' });
                }
                
                doc.save(`Bilan_${scope}_${labelP.replace(/\s+/g, '_')}.pdf`);
            };

            const exportMonthPdfAll = () => {
                const prev = bilanPeriod.value;
                bilanPeriod.value = 'month';
                exportBilanPdf('global');
                bilanPeriod.value = prev;
            };

            // Export PDF complet pour une agence
            const exportBilanAgencePDF = (agenceNom, agData) => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'portrait' });
                const m = (bilanFilters.mois && bilanFilters.annee) ? `${bilanFilters.annee}-${bilanFilters.mois}` : monthKey(new Date());
                const labelP = labelMonth(m).toUpperCase();
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 15;
                let currentY = 15;

                // Logo √† gauche si pr√©sent
                if(bilanConfig.logo) {
                    try {
                        doc.addImage(bilanConfig.logo, 'JPEG', margin, currentY, 30, 30);
                    } catch(e) {
                        console.error('Erreur logo:', e);
                    }
                }

                // Titre principal - Bandeau avec couleurs du site
                doc.setFillColor(102, 126, 234);
                doc.rect(0, 0, pageWidth, 35, 'F');
                doc.setFillColor(118, 75, 162);
                doc.rect(0, 0, pageWidth, 5, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text("BILAN DE FACTURATION", pageWidth / 2, 18, { align: 'center' });
                
                doc.setFontSize(10);
                doc.text(agenceNom.toUpperCase(), pageWidth / 2, 28, { align: 'center' });

                currentY = 40;

                // Informations de p√©riode
                doc.setFillColor(239, 246, 255);
                doc.rect(margin, currentY, pageWidth - (margin * 2), 7, 'F');
                doc.setDrawColor(102, 126, 234);
                doc.setLineWidth(0.3);
                doc.rect(margin, currentY, pageWidth - (margin * 2), 7, 'S');
                
                doc.setTextColor(30, 41, 59);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.text(`P√©riode : ${labelP}`, margin + 3, currentY + 4.5);
                doc.text(`Date d'√©dition : ${new Date().toLocaleDateString('fr-FR')}`, pageWidth - margin - 3, currentY + 4.5, { align: 'right' });

                currentY += 12;

                // R√©cup√©rer les donn√©es d√©taill√©es
                const data = getFilteredBilanData().filter(r => r.agence === agenceNom);
                
                // Statistiques globales
                let totalRdv = 0, totalHT = 0, totalTVA = 0, totalTTC = 0;
                data.forEach(r => {
                    totalRdv += r.rdv;
                    const v = getBilanLineVals(r);
                    totalHT += v.ht;
                    totalTVA += v.tva;
                    totalTTC += v.ttc;
                });

                // R√âSUM√â - Structure en tableau pour alignement parfait
                const resumeY = currentY;
                const resumeWidth = pageWidth - (margin * 2);
                const resumeHeight = 12;
                
                doc.setFillColor(239, 246, 255);
                doc.roundedRect(margin, resumeY, resumeWidth, resumeHeight, 2, 2, 'F');
                doc.setDrawColor(102, 126, 234);
                doc.setLineWidth(0.4);
                doc.roundedRect(margin, resumeY, resumeWidth, resumeHeight, 2, 2, 'S');
                
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(102, 126, 234);
                doc.text("R√âSUM√â", margin + 3, resumeY + 5);
                
                doc.setDrawColor(102, 126, 234);
                doc.setLineWidth(0.3);
                doc.line(margin + 3, resumeY + 6.5, margin + 40, resumeY + 6.5);
                
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(30, 41, 59);
                
                // Colonne gauche
                doc.text(`Nombre total de RDV : ${totalRdv}`, margin + 3, resumeY + 9.5);
                doc.text(`Total HT : ${formatBilanPrice(totalHT)} ‚Ç¨`, margin + 3, resumeY + 13);
                
                // Colonne droite - ALIGN√âE VERTICALEMENT
                if(bilanConfig.tvaActive) {
                    doc.text(`TVA (${bilanConfig.tvaRate}%) : ${formatBilanPrice(totalTVA)} ‚Ç¨`, margin + resumeWidth / 2 + 3, resumeY + 9.5);
                    doc.text(`Total TTC : ${formatBilanPrice(totalTTC)} ‚Ç¨`, margin + resumeWidth / 2 + 3, resumeY + 13);
                } else {
                    doc.text(`Total TTC : ${formatBilanPrice(totalHT)} ‚Ç¨`, margin + resumeWidth / 2 + 3, resumeY + 9.5);
                }

                currentY = resumeY + resumeHeight + 8;

                // Tableau d√©taill√© par commercial
                let cols = ['Date', 'Commercial', 'Nb RDV', 'Tarif unit.'];
                if(bilanConfig.tvaActive) {
                    cols.push('HT', 'TVA', 'TTC');
                } else {
                    cols.push('Total');
                }
                
                let body = [];
                const groupedByComm = {};
                data.forEach(r => {
                    const comm = r.commercial || 'Agence (Direct)';
                    if(!groupedByComm[comm]) {
                        groupedByComm[comm] = { rdv: 0, ht: 0, tva: 0, ttc: 0, lignes: [] };
                    }
                    groupedByComm[comm].rdv += r.rdv;
                    const v = getBilanLineVals(r);
                    groupedByComm[comm].ht += v.ht;
                    groupedByComm[comm].tva += v.tva;
                    groupedByComm[comm].ttc += v.ttc;
                    groupedByComm[comm].lignes.push(r);
                });

                Object.keys(groupedByComm).sort().forEach(comm => {
                    const d = groupedByComm[comm];
                    d.lignes.forEach(r => {
                        const v = getBilanLineVals(r);
                        let row = [
                            formatBilanDate(r.periodDate || r.date),
                            comm.length > 18 ? comm.substring(0, 16) + '..' : comm,
                            String(r.rdv),
                            formatBilanPrice(r.tarif) + ' ‚Ç¨'
                        ];
                        if(bilanConfig.tvaActive) {
                            row.push(formatBilanPrice(v.ht) + ' ‚Ç¨', formatBilanPrice(v.tva) + ' ‚Ç¨', formatBilanPrice(v.ttc) + ' ‚Ç¨');
                        } else {
                            row.push(formatBilanPrice(v.ht) + ' ‚Ç¨');
                        }
                        body.push(row);
                    });
                });

                doc.autoTable({
                    head: [cols],
                    body: body,
                    startY: currentY,
                    margin: { left: margin, right: margin },
                    theme: 'striped',
                    headStyles: {
                        fillColor: [102, 126, 234],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold',
                        fontSize: 8,
                        halign: 'center',
                        cellPadding: 2.5
                    },
                    bodyStyles: {
                        fontSize: 7.5,
                        textColor: [30, 41, 59],
                        cellPadding: 1.5,
                        halign: 'left'
                    },
                    alternateRowStyles: {
                        fillColor: [248, 250, 252]
                    },
                    columnStyles: {
                        0: { cellWidth: 22, halign: 'left' },
                        1: { cellWidth: 30, halign: 'left' },
                        2: { cellWidth: 12, halign: 'center' },
                        3: { cellWidth: 18, halign: 'right' },
                        4: { cellWidth: 18, halign: 'right' },
                        5: { cellWidth: 18, halign: 'right' },
                        6: { cellWidth: 18, halign: 'right' }
                    },
                    styles: {
                        lineColor: [203, 213, 225],
                        lineWidth: 0.15,
                        cellPadding: 1.5,
                        fontSize: 7.5
                    },
                    didParseCell: function(data) {
                        if(data.cell.text && typeof data.cell.text === 'string' && data.column.index === 1 && data.cell.text.length > 18) {
                            data.cell.text = data.cell.text.substring(0, 16) + '..';
                        }
                    }
                });

                // Totaux en bas
                let y = doc.lastAutoTable.finalY + 10;
                
                // Ligne de s√©paration
                doc.setDrawColor(102, 126, 234);
                doc.setLineWidth(0.5);
                doc.line(margin, y, pageWidth - margin, y);
                
                y += 8;
                
                // Encadr√© totaux
                const totalBoxWidth = 75;
                const totalBoxHeight = bilanConfig.tvaActive ? 18 : 10;
                const totalBoxX = pageWidth - margin - totalBoxWidth;
                
                doc.setFillColor(239, 246, 255);
                doc.roundedRect(totalBoxX, y - 4, totalBoxWidth, totalBoxHeight, 2, 2, 'F');
                doc.setDrawColor(102, 126, 234);
                doc.setLineWidth(0.3);
                doc.roundedRect(totalBoxX, y - 4, totalBoxWidth, totalBoxHeight, 2, 2, 'S');
                
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(30, 41, 59);
                
                if(bilanConfig.tvaActive) {
                    doc.text(`TOTAL HT`, totalBoxX + 3, y);
                    doc.text(`${formatBilanPrice(totalHT)} ‚Ç¨`, totalBoxX + totalBoxWidth - 3, y, { align: 'right' });
                    doc.text(`TVA (${bilanConfig.tvaRate}%)`, totalBoxX + 3, y + 5.5);
                    doc.text(`${formatBilanPrice(totalTVA)} ‚Ç¨`, totalBoxX + totalBoxWidth - 3, y + 5.5, { align: 'right' });
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(102, 126, 234);
                    doc.text(`TOTAL TTC`, totalBoxX + 3, y + 12);
                    doc.text(`${formatBilanPrice(totalTTC)} ‚Ç¨`, totalBoxX + totalBoxWidth - 3, y + 12, { align: 'right' });
                } else {
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(102, 126, 234);
                    doc.text(`TOTAL TTC`, totalBoxX + 3, y);
                    doc.text(`${formatBilanPrice(totalHT)} ‚Ç¨`, totalBoxX + totalBoxWidth - 3, y, { align: 'right' });
                }

                // Signature
                if(bilanConfig.signature) {
                    try {
                        let sigY = y + totalBoxHeight + 8;
                        if(sigY > pageHeight - 30) { 
                            doc.addPage(); 
                            sigY = 20; 
                        }
                        doc.setFontSize(7.5);
                        doc.setFont('helvetica', 'normal');
                        doc.setTextColor(100, 100, 100);
                        doc.text("Cachet / Signature :", margin, sigY);
                        doc.addImage(bilanConfig.signature, 'PNG', margin, sigY + 2, 50, 25);
                    } catch(e) {
                        console.error('Erreur signature:', e);
                    }
                }

                const fileName = `Bilan_${agenceNom.replace(/\s+/g, '_')}_${labelP.replace(/\s+/g, '_')}.pdf`;
                doc.save(fileName);
            };

            // Export PDF complet pour un commercial
            const exportBilanCommercialPDF = (agenceNom, commercialNom, commData) => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'portrait' });
                const m = (bilanFilters.mois && bilanFilters.annee) ? `${bilanFilters.annee}-${bilanFilters.mois}` : monthKey(new Date());
                const labelP = labelMonth(m).toUpperCase();
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 15;
                let currentY = 15;

                // Logo √† gauche si pr√©sent
                if(bilanConfig.logo) {
                    try {
                        doc.addImage(bilanConfig.logo, 'JPEG', margin, currentY, 30, 30);
                    } catch(e) {
                        console.error('Erreur logo:', e);
                    }
                }

                // Titre principal - Bandeau avec couleurs du site
                doc.setFillColor(102, 126, 234);
                doc.rect(0, 0, pageWidth, 35, 'F');
                doc.setFillColor(118, 75, 162);
                doc.rect(0, 0, pageWidth, 5, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text("BILAN DE FACTURATION", pageWidth / 2, 18, { align: 'center' });
                
                doc.setFontSize(10);
                doc.text(`${agenceNom.toUpperCase()} - ${commercialNom.toUpperCase()}`, pageWidth / 2, 28, { align: 'center' });

                currentY = 40;

                // Informations de p√©riode
                doc.setFillColor(239, 246, 255);
                doc.rect(margin, currentY, pageWidth - (margin * 2), 7, 'F');
                doc.setDrawColor(102, 126, 234);
                doc.setLineWidth(0.3);
                doc.rect(margin, currentY, pageWidth - (margin * 2), 7, 'S');
                
                doc.setTextColor(30, 41, 59);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.text(`P√©riode : ${labelP}`, margin + 3, currentY + 4.5);
                doc.text(`Date d'√©dition : ${new Date().toLocaleDateString('fr-FR')}`, pageWidth - margin - 3, currentY + 4.5, { align: 'right' });

                currentY += 12;

                // R√©cup√©rer les donn√©es
                const data = getFilteredBilanData().filter(r => 
                    r.agence === agenceNom && (r.commercial || 'Agence (Direct)') === commercialNom
                );

                // Statistiques
                let totalRdv = commData.rdv || 0;
                let totalHT = commData.ht || 0;
                let totalTVA = commData.tva || 0;
                let totalTTC = commData.ttc || commData.ht || 0;

                // R√âSUM√â - Structure en tableau pour alignement parfait
                const resumeY = currentY;
                const resumeWidth = pageWidth - (margin * 2);
                const resumeHeight = 12;
                
                doc.setFillColor(239, 246, 255);
                doc.roundedRect(margin, resumeY, resumeWidth, resumeHeight, 2, 2, 'F');
                doc.setDrawColor(102, 126, 234);
                doc.setLineWidth(0.4);
                doc.roundedRect(margin, resumeY, resumeWidth, resumeHeight, 2, 2, 'S');
                
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(102, 126, 234);
                doc.text("R√âSUM√â", margin + 3, resumeY + 5);
                
                doc.setDrawColor(102, 126, 234);
                doc.setLineWidth(0.3);
                doc.line(margin + 3, resumeY + 6.5, margin + 40, resumeY + 6.5);
                
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(30, 41, 59);
                
                // Colonne gauche
                doc.text(`Nombre total de RDV : ${totalRdv}`, margin + 3, resumeY + 9.5);
                doc.text(`Total HT : ${formatBilanPrice(totalHT)} ‚Ç¨`, margin + 3, resumeY + 13);
                
                // Colonne droite - ALIGN√âE VERTICALEMENT
                if(bilanConfig.tvaActive) {
                    doc.text(`TVA (${bilanConfig.tvaRate}%) : ${formatBilanPrice(totalTVA)} ‚Ç¨`, margin + resumeWidth / 2 + 3, resumeY + 9.5);
                    doc.text(`Total TTC : ${formatBilanPrice(totalTTC)} ‚Ç¨`, margin + resumeWidth / 2 + 3, resumeY + 13);
                } else {
                    doc.text(`Total TTC : ${formatBilanPrice(totalHT)} ‚Ç¨`, margin + resumeWidth / 2 + 3, resumeY + 9.5);
                }

                currentY = resumeY + resumeHeight + 8;

                // Tableau d√©taill√©
                let cols = ['Date', 'Nb RDV', 'Tarif unit.'];
                if(bilanConfig.tvaActive) {
                    cols.push('HT', 'TVA', 'TTC');
                } else {
                    cols.push('Total');
                }
                
                let body = data.map(r => {
                    const v = getBilanLineVals(r);
                    let row = [
                        formatBilanDate(r.periodDate || r.date),
                        String(r.rdv),
                        formatBilanPrice(r.tarif) + ' ‚Ç¨'
                    ];
                    if(bilanConfig.tvaActive) {
                        row.push(formatBilanPrice(v.ht) + ' ‚Ç¨', formatBilanPrice(v.tva) + ' ‚Ç¨', formatBilanPrice(v.ttc) + ' ‚Ç¨');
                    } else {
                        row.push(formatBilanPrice(v.ht) + ' ‚Ç¨');
                    }
                    return row;
                });

                doc.autoTable({
                    head: [cols],
                    body: body,
                    startY: currentY,
                    margin: { left: margin, right: margin },
                    theme: 'striped',
                    headStyles: {
                        fillColor: [102, 126, 234],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold',
                        fontSize: 8,
                        halign: 'center',
                        cellPadding: 2.5
                    },
                    bodyStyles: {
                        fontSize: 7.5,
                        textColor: [30, 41, 59],
                        cellPadding: 1.5,
                        halign: 'left'
                    },
                    alternateRowStyles: {
                        fillColor: [248, 250, 252]
                    },
                    columnStyles: {
                        0: { cellWidth: 35, halign: 'left' },
                        1: { cellWidth: 20, halign: 'center' },
                        2: { cellWidth: 30, halign: 'right' },
                        3: { cellWidth: 30, halign: 'right' },
                        4: { cellWidth: 30, halign: 'right' },
                        5: { cellWidth: 30, halign: 'right' }
                    },
                    styles: {
                        lineColor: [203, 213, 225],
                        lineWidth: 0.15,
                        cellPadding: 1.5,
                        fontSize: 7.5
                    }
                });

                // Totaux en bas
                let y = doc.lastAutoTable.finalY + 10;
                
                // Ligne de s√©paration
                doc.setDrawColor(102, 126, 234);
                doc.setLineWidth(0.5);
                doc.line(margin, y, pageWidth - margin, y);
                
                y += 8;
                
                // Encadr√© totaux
                const totalBoxWidth = 75;
                const totalBoxHeight = bilanConfig.tvaActive ? 18 : 10;
                const totalBoxX = pageWidth - margin - totalBoxWidth;
                
                doc.setFillColor(239, 246, 255);
                doc.roundedRect(totalBoxX, y - 4, totalBoxWidth, totalBoxHeight, 2, 2, 'F');
                doc.setDrawColor(102, 126, 234);
                doc.setLineWidth(0.3);
                doc.roundedRect(totalBoxX, y - 4, totalBoxWidth, totalBoxHeight, 2, 2, 'S');
                
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(30, 41, 59);
                
                if(bilanConfig.tvaActive) {
                    doc.text(`TOTAL HT`, totalBoxX + 3, y);
                    doc.text(`${formatBilanPrice(totalHT)} ‚Ç¨`, totalBoxX + totalBoxWidth - 3, y, { align: 'right' });
                    doc.text(`TVA (${bilanConfig.tvaRate}%)`, totalBoxX + 3, y + 5.5);
                    doc.text(`${formatBilanPrice(totalTVA)} ‚Ç¨`, totalBoxX + totalBoxWidth - 3, y + 5.5, { align: 'right' });
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(102, 126, 234);
                    doc.text(`TOTAL TTC`, totalBoxX + 3, y + 12);
                    doc.text(`${formatBilanPrice(totalTTC)} ‚Ç¨`, totalBoxX + totalBoxWidth - 3, y + 12, { align: 'right' });
                } else {
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(102, 126, 234);
                    doc.text(`TOTAL TTC`, totalBoxX + 3, y);
                    doc.text(`${formatBilanPrice(totalHT)} ‚Ç¨`, totalBoxX + totalBoxWidth - 3, y, { align: 'right' });
                }

                // Signature
                if(bilanConfig.signature) {
                    try {
                        let sigY = y + totalBoxHeight + 8;
                        if(sigY > pageHeight - 30) { 
                            doc.addPage(); 
                            sigY = 20; 
                        }
                        doc.setFontSize(7.5);
                        doc.setFont('helvetica', 'normal');
                        doc.setTextColor(100, 100, 100);
                        doc.text("Cachet / Signature :", margin, sigY);
                        doc.addImage(bilanConfig.signature, 'PNG', margin, sigY + 2, 50, 25);
                    } catch(e) {
                        console.error('Erreur signature:', e);
                    }
                }

                const fileName = `Bilan_${agenceNom.replace(/\s+/g, '_')}_${commercialNom.replace(/\s+/g, '_')}_${labelP.replace(/\s+/g, '_')}.pdf`;
                doc.save(fileName);
            };

            const openBilanSettings = () => {
                bilanSettingsModal.open = true;
            };

            const setBilanPeriod = (p) => {
                bilanPeriod.value = p;
            };

            const handleBilanLogo = (e) => {
                if(e.target.files[0]) {
                    const r = new FileReader();
                    r.onload = (ev) => {
                        bilanConfig.logo = ev.target.result;
                    };
                    r.readAsDataURL(e.target.files[0]);
                }
            };

            const handleBilanSignature = (e) => {
                if(e.target.files[0]) {
                    const r = new FileReader();
                    r.onload = (ev) => {
                        bilanConfig.signature = ev.target.result;
                    };
                    r.readAsDataURL(e.target.files[0]);
                }
            };

            const saveBilanSettings = async () => {
                await db.collection('bilan_config').doc('settings').set(bilanConfig, {merge: true});
                bilanSettingsModal.open = false;
                showNotification('‚úÖ R√©glages sauvegard√©s', 'success', 'fa-check-circle');
            };

            // RDV urgents (sans commercial assign√©)
            const urgentBilanRows = computed(() => {
                return bilanRows.value.filter(r => 
                    r.commercial === '√Ä traiter' || 
                    r.commercial === 'Je ne sais pas' ||
                    r.needsCommercial === true
                );
            });

            const urgentBilanCount = computed(() => {
                return urgentBilanRows.value.length;
            });

            // RDV urgents pour les prospecteurs (cr√©√©s par eux)
            const prospecteurUrgentRows = computed(() => {
                if (user.role === 'admin') return [];
                return bilanRows.value.filter(r => {
                    const hasUrgentFlag = r.commercial === '√Ä traiter' || 
                                         r.commercial === 'Je ne sais pas' ||
                                         r.needsCommercial === true;
                    if (!hasUrgentFlag) return false;
                    
                    // V√©rifier si le RDV a √©t√© cr√©√© par le prospecteur actuel
                    const rdvId = r.rdvId || (r.rdvIds && r.rdvIds.length > 0 ? r.rdvIds[0] : null);
                    if (!rdvId) return false;
                    const rdv = rdvList.value.find(rdv => rdv.id === rdvId);
                    return rdv && rdv.createdBy === user.name;
                });
            });

            const prospecteurUrgentCount = computed(() => {
                return prospecteurUrgentRows.value.length;
            });

            // Watch pour d√©tecter imm√©diatement quand il y a des RDV √† traiter
            let lastUrgentCount = 0;
            watch([() => urgentBilanCount.value, () => prospecteurUrgentCount.value], ([adminCount, prospecteurCount]) => {
                if (!user.logged) return;
                
                const currentCount = user.role === 'admin' ? adminCount : prospecteurCount;
                
                // Si le nombre augmente (nouveau RDV √† traiter), afficher imm√©diatement
                if (currentCount > 0 && currentCount > lastUrgentCount) {
                    checkCommercialReminders(true);
                }
                
                lastUrgentCount = currentCount;
            });

            // R√©cup√©rer les infos du client depuis le RDV original
            const getUrgentRdvClient = (bilanRdv) => {
                // Essayer d'abord rdvId, puis rdvIds (pour les RDV regroup√©s)
                const rdvId = bilanRdv.rdvId || (bilanRdv.rdvIds && bilanRdv.rdvIds.length > 0 ? bilanRdv.rdvIds[0] : null);
                if(!rdvId) return '-';
                const rdv = rdvList.value.find(r => r.id === rdvId);
                if(rdv) return `${rdv.civilite || ''} ${rdv.nom || ''}`.trim() || '-';
                return '-';
            };

            const getUrgentRdvPhone = (bilanRdv) => {
                // Essayer d'abord rdvId, puis rdvIds (pour les RDV regroup√©s)
                const rdvId = bilanRdv.rdvId || (bilanRdv.rdvIds && bilanRdv.rdvIds.length > 0 ? bilanRdv.rdvIds[0] : null);
                if(!rdvId) return '-';
                const rdv = rdvList.value.find(r => r.id === rdvId);
                if(rdv) return rdv.telephone || '-';
                return '-';
            };

            const openUrgentCommercialModal = (bilanRdv) => {
                urgentCommercialModal.rdv = bilanRdv;
                urgentCommercialModal.commercial = '';
                urgentCommercialModal.open = true;
            };

            const getUrgentCommerciaux = () => {
                if(!urgentCommercialModal.rdv) return [];
                const ag = agences.value.find(a => a.nom === urgentCommercialModal.rdv.agence);
                if(!ag) return [];
                if(ag.commerciauxDetails) return ag.commerciauxDetails.map(c => c.name);
                if(ag.commerciaux) return ag.commerciaux;
                return [];
            };

            const saveUrgentCommercial = async () => {
                if(!urgentCommercialModal.rdv || !urgentCommercialModal.commercial) {
                    showNotification('‚ö†Ô∏è Veuillez s√©lectionner un commercial', 'warning', 'fa-exclamation-triangle');
                    return;
                }

                const bilanRdv = urgentCommercialModal.rdv;
                await db.collection('bilan_rdv').doc(bilanRdv.id).update({
                    commercial: urgentCommercialModal.commercial,
                    needsCommercial: false
                });

                showNotification('‚úÖ Commercial assign√© avec succ√®s', 'success', 'fa-check-circle');
                urgentCommercialModal.open = false;
            };

            // ================= FONCTIONS OBJECTIFS =================
            const loadObjectifsData = async () => {
                try {
                    const snap = await db.collection('objectifs').get();
                    objectifsData.value = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    updateObjectifsStats();
                } catch(e) {
                    console.error('Erreur chargement objectifs:', e);
                }
            };

            const loadTarifsPersonnalises = async () => {
                try {
                    const snap = await db.collection('tarifs_personnalises').get();
                    const tarifs = {};
                    snap.docs.forEach(d => {
                        tarifs[d.id] = d.data();
                    });
                    tarifsPersonnalises.value = tarifs;
                } catch(e) {
                    console.error('Erreur chargement tarifs personnalis√©s:', e);
                }
            };

            const updateObjectifsStats = () => {
                // Initialiser le mois si vide
                if(!objectifsFilters.mois) {
                    objectifsFilters.mois = monthKey(new Date());
                }
                const mois = objectifsFilters.mois;
                const agenceId = objectifsFilters.agence;
                
                // Filtrer les donn√©es du bilan selon les filtres
                let data = bilanRows.value.filter(r => {
                    const billingM = r.periodMonth || monthKey(r.date);
                    return billingM === mois;
                });
                
                if(agenceId) {
                    const ag = agences.value.find(a => a.id === agenceId);
                    if(ag) {
                        data = data.filter(r => r.agence === ag.nom);
                    }
                }

                // Grouper par agence
                const statsByAgence = {};
                
                data.forEach(r => {
                    const agName = r.agence || 'Agence Inconnue';
                    const ag = agences.value.find(a => a.nom === agName);
                    const agId = ag ? ag.id : null;
                    
                    if(!statsByAgence[agName]) {
                        statsByAgence[agName] = {
                            agenceId: agId,
                            agenceNom: agName,
                            totalRdv: 0,
                            objectifAgence: null,
                            commerciaux: {}
                        };
                    }
                    
                    statsByAgence[agName].totalRdv += r.rdv;
                    
                    // Normaliser le nom du commercial : toutes les valeurs vides/null/undefined deviennent une cl√© unique
                    let commName = r.commercial;
                    if(!commName || commName === '' || commName === null || commName === undefined) {
                        commName = ''; // Cl√© unique pour "Agence (Direct)"
                    }
                    
                    // V√©rifier si l'agence a des commerciaux
                    const hasCommerciaux = ag && ((ag.commerciaux && ag.commerciaux.length > 0) || (ag.commerciauxDetails && ag.commerciauxDetails.length > 0));
                    
                    // Si l'agence n'a pas de commerciaux, toutes les lignes sans commercial sont "Agence (Direct)"
                    // Si l'agence a des commerciaux mais que le commercial est vide ou "√Ä traiter", c'est aussi "Agence (Direct)"
                    if(!hasCommerciaux || commName === '' || commName === '√Ä traiter') {
                        commName = ''; // Normaliser √† une cl√© unique
                    }
                    
                    if(!statsByAgence[agName].commerciaux[commName]) {
                        statsByAgence[agName].commerciaux[commName] = {
                            nom: commName || 'Agence (Direct)',
                            rdv: 0,
                            objectif: null
                        };
                    }
                    statsByAgence[agName].commerciaux[commName].rdv += r.rdv;
                });

                // Charger les objectifs
                objectifsData.value.forEach(obj => {
                    const ag = agences.value.find(a => a.id === obj.agenceId);
                    if(!ag) return;
                    
                    const agName = ag.nom;
                    if(!statsByAgence[agName]) {
                        // Si l'agence n'a pas encore d'entr√©e, on en cr√©e une vide (mais normalement elle devrait d√©j√† exister)
                        statsByAgence[agName] = {
                            agenceId: obj.agenceId,
                            agenceNom: agName,
                            totalRdv: 0,
                            objectifAgence: null,
                            commerciaux: {}
                        };
                    }
                    
                    // V√©rifier si l'objectif correspond √† la p√©riode
                    const objMois = obj.periode === 'month' ? mois : mois.split('-')[0];
                    const currentMois = obj.periode === 'month' ? mois : mois.split('-')[0];
                    
                    if(objMois === currentMois || obj.periode === 'year') {
                        if(obj.commercial && obj.commercial.trim() !== '') {
                            // Objectif pour un commercial sp√©cifique
                            const commKey = obj.commercial;
                            if(!statsByAgence[agName].commerciaux[commKey]) {
                                statsByAgence[agName].commerciaux[commKey] = {
                                    nom: obj.commercial,
                                    rdv: 0,
                                    objectif: null
                                };
                            }
                            statsByAgence[agName].commerciaux[commKey].objectif = obj.objectif;
                        } else {
                            // Objectif pour toute l'agence (Agence Direct)
                            statsByAgence[agName].objectifAgence = obj.objectif;
                            
                            // IMPORTANT : On met l'objectif sur la ligne "Agence (Direct)" existante qui a d√©j√† les RDV
                            // On ne cr√©e PAS une nouvelle ligne si une ligne avec des RDV existe d√©j√†
                            if(!statsByAgence[agName].commerciaux['']) {
                                // Si aucune ligne "Agence (Direct)" n'existe, on en cr√©e une
                                statsByAgence[agName].commerciaux[''] = {
                                    nom: 'Agence (Direct)',
                                    rdv: 0,
                                    objectif: obj.objectif
                                };
                            } else {
                                // Si la ligne existe d√©j√†, on ajoute juste l'objectif (les RDV sont d√©j√† l√†)
                                statsByAgence[agName].commerciaux[''].objectif = obj.objectif;
                            }
                        }
                    }
                });

                // Convertir en tableau et filtrer les commerciaux vides (sans RDV et sans objectif)
                objectifsStats.value = Object.values(statsByAgence).map(ag => {
                    // Filtrer les commerciaux : garder seulement ceux qui ont des RDV OU un objectif d√©fini
                    // IMPORTANT : S'assurer qu'il n'y a qu'une seule ligne "Agence (Direct)" par agence
                    const commerciauxMap = {};
                    Object.values(ag.commerciaux).forEach(comm => {
                        // Normaliser le nom pour √©viter les doublons
                        const nomNormalise = comm.nom || 'Agence (Direct)';
                        if(nomNormalise === 'Agence (Direct)' || nomNormalise === '') {
                            // Si c'est "Agence (Direct)", on regroupe tout sous une seule cl√©
                            if(!commerciauxMap['_direct']) {
                                commerciauxMap['_direct'] = {
                                    nom: 'Agence (Direct)',
                                    rdv: 0,
                                    objectif: null
                                };
                            }
                            commerciauxMap['_direct'].rdv += comm.rdv;
                            // Si un objectif existe, on le prend (priorit√© au plus r√©cent)
                            if(comm.objectif !== null) {
                                commerciauxMap['_direct'].objectif = comm.objectif;
                            }
                        } else {
                            // Pour les commerciaux nomm√©s, on garde tel quel
                            commerciauxMap[comm.nom] = comm;
                        }
                    });
                    
                    const commerciauxFiltres = Object.values(commerciauxMap).filter(comm => {
                        return comm.rdv > 0 || comm.objectif !== null;
                    });
                    
                    return {
                        ...ag,
                        commerciaux: commerciauxFiltres
                    };
                }).filter(ag => !agenceId || ag.agenceId === agenceId);
            };

            const openObjectifModal = (agenceId, commercial) => {
                objectifModal.agenceId = agenceId || '';
                objectifModal.commercial = commercial || '';
                objectifModal.objectif = 0;
                objectifModal.periode = 'month';
                
                // Charger l'objectif existant si pr√©sent
                if(agenceId) {
                    const existing = objectifsData.value.find(obj => 
                        obj.agenceId === agenceId && 
                        (commercial ? obj.commercial === commercial : !obj.commercial)
                    );
                    if(existing) {
                        objectifModal.objectif = existing.objectif;
                        objectifModal.periode = existing.periode || 'month';
                    }
                }
                
                objectifModal.open = true;
            };

            const hasObjectifCommerciaux = () => {
                if(!objectifModal.agenceId) return false;
                const ag = agences.value.find(a => a.id === objectifModal.agenceId);
                if(!ag) return false;
                return (ag.commerciaux && ag.commerciaux.length > 0) || (ag.commerciauxDetails && ag.commerciauxDetails.length > 0);
            };

            const getObjectifCommerciaux = () => {
                if(!objectifModal.agenceId) return [];
                const ag = agences.value.find(a => a.id === objectifModal.agenceId);
                if(!ag) return [];
                if(ag.commerciauxDetails) return ag.commerciauxDetails.map(c => c.name);
                if(ag.commerciaux) return ag.commerciaux;
                return [];
            };

            const onObjectifAgenceChange = () => {
                objectifModal.commercial = '';
            };

            const saveObjectif = async () => {
                if(!objectifModal.agenceId || !objectifModal.objectif || objectifModal.objectif <= 0) {
                    showNotification('‚ö†Ô∏è Veuillez remplir tous les champs requis', 'warning', 'fa-exclamation-triangle');
                    return;
                }

                try {
                    const key = objectifModal.commercial ? `${objectifModal.agenceId}_${objectifModal.commercial}` : `${objectifModal.agenceId}_agence`;
                    const existing = objectifsData.value.find(obj => 
                        obj.agenceId === objectifModal.agenceId && 
                        (objectifModal.commercial ? obj.commercial === objectifModal.commercial : !obj.commercial)
                    );

                    const data = {
                        agenceId: objectifModal.agenceId,
                        commercial: objectifModal.commercial || '',
                        objectif: objectifModal.objectif,
                        periode: objectifModal.periode
                    };

                    if(existing) {
                        await db.collection('objectifs').doc(existing.id).update(data);
                    } else {
                        await db.collection('objectifs').add(data);
                    }

                    await loadObjectifsData();
                    objectifModal.open = false;
                    showNotification('‚úÖ Objectif enregistr√© avec succ√®s', 'success', 'fa-check-circle');
                } catch(e) {
                    console.error('Erreur sauvegarde objectif:', e);
                    showNotification('‚ùå Erreur lors de la sauvegarde', 'error', 'fa-exclamation-circle');
                }
            };

            const openTarifPersonnaliseModal = async (agenceId) => {
                tarifPersonnaliseModal.agenceId = agenceId || '';
                
                // Charger les tarifs existants
                const existing = tarifsPersonnalises.value[agenceId];
                if(existing && existing.tarifs && existing.tarifs.length > 0) {
                    tarifPersonnaliseModal.tarifs = JSON.parse(JSON.stringify(existing.tarifs));
                } else {
                    tarifPersonnaliseModal.tarifs = [{ rdvMin: 1, montant: 0 }];
                }
                
                tarifPersonnaliseModal.open = true;
            };

            const addTarifPersonnalise = () => {
                const lastTarif = tarifPersonnaliseModal.tarifs[tarifPersonnaliseModal.tarifs.length - 1];
                tarifPersonnaliseModal.tarifs.push({
                    rdvMin: (lastTarif.rdvMin || 1) + 1,
                    montant: 0
                });
            };

            const removeTarifPersonnalise = (idx) => {
                if(tarifPersonnaliseModal.tarifs.length > 1) {
                    tarifPersonnaliseModal.tarifs.splice(idx, 1);
                }
            };

            const saveTarifPersonnalise = async () => {
                if(!tarifPersonnaliseModal.agenceId) {
                    showNotification('‚ö†Ô∏è Veuillez s√©lectionner une agence', 'warning', 'fa-exclamation-triangle');
                    return;
                }

                // V√©rifier que tous les tarifs sont valides
                for(const tarif of tarifPersonnaliseModal.tarifs) {
                    if(!tarif.rdvMin || tarif.rdvMin < 1 || !tarif.montant || tarif.montant < 0) {
                        showNotification('‚ö†Ô∏è Veuillez remplir tous les champs des tarifs', 'warning', 'fa-exclamation-triangle');
                        return;
                    }
                }

                try {
                    await db.collection('tarifs_personnalises').doc(tarifPersonnaliseModal.agenceId).set({
                        agenceId: tarifPersonnaliseModal.agenceId,
                        tarifs: tarifPersonnaliseModal.tarifs
                    });

                    await loadTarifsPersonnalises();
                    tarifPersonnaliseModal.open = false;
                    showNotification('‚úÖ Tarifs personnalis√©s enregistr√©s avec succ√®s', 'success', 'fa-check-circle');
                } catch(e) {
                    console.error('Erreur sauvegarde tarifs personnalis√©s:', e);
                    showNotification('‚ùå Erreur lors de la sauvegarde', 'error', 'fa-exclamation-circle');
                }
            };

            const getObjectifProgressPercent = (rdv, objectif) => {
                if(!objectif || objectif <= 0) return 0;
                return Math.min(100, Math.round((rdv / objectif) * 100));
            };

            const getObjectifProgressClass = (rdv, objectif) => {
                if(!objectif || objectif <= 0) return 'bg-slate-300';
                const percent = (rdv / objectif) * 100;
                if(percent >= 100) return 'bg-green-500';
                if(percent >= 75) return 'bg-blue-500';
                if(percent >= 50) return 'bg-yellow-500';
                return 'bg-orange-500';
            };

            const getObjectifStatusClass = (rdv, objectif) => {
                if(!objectif || objectif <= 0) return 'text-slate-500';
                if(rdv >= objectif) return 'text-green-600';
                if(rdv >= objectif * 0.75) return 'text-blue-600';
                if(rdv >= objectif * 0.5) return 'text-yellow-600';
                return 'text-orange-600';
            };

            // Fonction pour synchroniser tous les RDV honor√©s du mois en cours
            const syncAllHonoredRdv = async () => {
                if(!confirm('Synchroniser tous les RDV honor√©s de ce mois dans le Bilan ?')) return;
                
                try {
                    showNotification('üîÑ Synchronisation en cours...', 'info', 'fa-sync-alt');
                    
                    const currentMonth = new Date().getMonth();
                    const currentYear = new Date().getFullYear();
                    
                    // R√©cup√©rer tous les RDV honor√©s du mois en cours avec agenceId
                    const honoredRdvs = rdvList.value.filter(r => {
                        if(r.statut !== 'honore' || !r.date || !r.agenceId) return false;
                        const d = new Date(r.date);
                        return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                    });
                    
                    if(honoredRdvs.length === 0) {
                        showNotification('‚ÑπÔ∏è Aucun RDV honor√© ce mois-ci avec agence', 'info', 'fa-info-circle');
                        return;
                    }
                    
                    // R√©cup√©rer tous les RDV d√©j√† synchronis√©s pour √©viter les doublons
                    const allBilanRdvs = await db.collection('bilan_rdv').get();
                    const syncedRdvIds = new Set();
                    allBilanRdvs.forEach(doc => {
                        const data = doc.data();
                        if(data.rdvId) syncedRdvIds.add(data.rdvId);
                        if(data.rdvIds && Array.isArray(data.rdvIds)) {
                            data.rdvIds.forEach(id => syncedRdvIds.add(id));
                        }
                    });
                    
                    let synced = 0;
                    let skipped = 0;
                    let errors = 0;
                    
                    // Synchroniser chaque RDV
                    for(const rdv of honoredRdvs) {
                        try {
                            // V√©rifier si d√©j√† synchronis√©
                            if(syncedRdvIds.has(rdv.id)) {
                                skipped++;
                                continue;
                            }
                            
                            // Synchroniser (la fonction g√®re le regroupement automatiquement)
                            await syncRdvToBilan(rdv, '');
                            syncedRdvIds.add(rdv.id); // Marquer comme synchronis√©
                            synced++;
                        } catch(e) {
                            console.error('Erreur sync RDV:', rdv.id, e);
                            errors++;
                        }
                    }
                    
                    const message = `‚úÖ Synchronisation termin√©e : ${synced} RDV ajout√©s, ${skipped} d√©j√† pr√©sents${errors > 0 ? `, ${errors} erreurs` : ''}`;
                    showNotification(message, synced > 0 ? 'success' : 'info', 'fa-check-circle');
                    
                    // Recharger les donn√©es
                    setTimeout(() => {
                        loadBilanData();
                        // V√©rifier imm√©diatement s'il y a des RDV √† traiter apr√®s synchronisation
                        setTimeout(() => {
                            checkCommercialReminders(true);
                        }, 1500);
                    }, 500);
                    
                } catch(e) {
                    console.error('Erreur synchronisation:', e);
                    showNotification('‚ùå Erreur lors de la synchronisation', 'warning', 'fa-exclamation-triangle');
                }
            };
            
            // Fonction pour nettoyer et regrouper les doublons existants
            const cleanAndRegroupBilan = async () => {
                if(!confirm('Nettoyer et regrouper les lignes du Bilan ? Cette op√©ration peut prendre quelques instants.')) return;
                
                try {
                    showNotification('üîÑ Nettoyage en cours...', 'info', 'fa-sync-alt');
                    
                    const allBilan = await db.collection('bilan_rdv').get();
                    const grouped = {};
                    const toDelete = [];
                    
                    // Grouper par agence + date + commercial
                    allBilan.forEach(doc => {
                        const data = doc.data();
                        const key = `${data.clientId || ''}_${data.periodDate || data.date}_${data.commercial || ''}_${data.reporte || false}`;
                        
                        if(!grouped[key]) {
                            grouped[key] = {
                                doc: doc,
                                data: data,
                                rdvIds: new Set(data.rdvIds || (data.rdvId ? [data.rdvId] : [])),
                                rdvCount: data.rdv || 1,
                                total: data.total || 0,
                                geste: data.gesteMontant || 0
                            };
                        } else {
                            // Doublon trouv√©, fusionner
                            const existing = grouped[key];
                            existing.rdvCount += (data.rdv || 1);
                            existing.total += (data.total || 0);
                            existing.geste += (data.gesteMontant || 0);
                            
                            // Fusionner les rdvIds
                            if(data.rdvIds) {
                                data.rdvIds.forEach(id => existing.rdvIds.add(id));
                            }
                            if(data.rdvId) {
                                existing.rdvIds.add(data.rdvId);
                            }
                            
                            toDelete.push(doc.id);
                        }
                    });
                    
                    // Mettre √† jour les lignes regroup√©es
                    const batch = db.batch();
                    let updated = 0;
                    
                    Object.values(grouped).forEach(group => {
                        if(toDelete.includes(group.doc.id)) return; // On garde la premi√®re ligne
                        
                        const rdvIdsArray = Array.from(group.rdvIds);
                        const newTotal = group.data.tarif * group.rdvCount;
                        const newNetTotal = newTotal - group.geste;
                        
                        batch.update(db.collection('bilan_rdv').doc(group.doc.id), {
                            rdv: group.rdvCount,
                            total: newTotal,
                            netTotal: newNetTotal,
                            geste: group.geste > 0,
                            gesteMontant: group.geste,
                            rdvIds: rdvIdsArray
                        });
                        updated++;
                    });
                    
                    // Supprimer les doublons
                    toDelete.forEach(id => {
                        batch.delete(db.collection('bilan_rdv').doc(id));
                    });
                    
                    await batch.commit();
                    
                    showNotification(`‚úÖ Nettoyage termin√© : ${updated} lignes mises √† jour, ${toDelete.length} doublons supprim√©s`, 'success', 'fa-check-circle');
                    
                    setTimeout(() => {
                        loadBilanData();
                    }, 500);
                    
                } catch(e) {
                    console.error('Erreur nettoyage:', e);
                    showNotification('‚ùå Erreur lors du nettoyage', 'warning', 'fa-exclamation-triangle');
                }
            };

            // Charger les donn√©es au montage si on est sur la vue bilan
            watch(() => view.value, (newView) => {
                if(newView === 'bilan') {
                    loadBilanConfig();
                    loadBilanData();
                    // Initialiser les filtres des objectifs avec le mois en cours
                    if(!objectifsFilters.mois) {
                        objectifsFilters.mois = monthKey(new Date());
                    }
                }
                if(newView === 'connexions' && user.role === 'admin') {
                    loadConnexionsHistory();
                    startConnexionsListener();
                    // Actualiser toutes les 10 secondes pour voir les changements en temps r√©el
                    connexionsInterval = setInterval(() => {
                        if(view.value === 'connexions' && user.role === 'admin' && !isDeletingLogs.value) {
                            loadConnexionsHistory();
                        } else if(view.value !== 'connexions') {
                            stopConnexionsListener();
                        }
                    }, 10000); // Toutes les 10 secondes
                } else {
                    stopConnexionsListener();
                }
            });
            
            // Initialiser la v√©rification mensuelle au d√©marrage
            if(user.role === 'admin') {
                checkAndGenerateMonthlySummary();
            }

            // Mettre √† jour les statistiques des objectifs quand on change d'onglet ou de donn√©es
            watch(() => bilanTab.value, () => {
                if(bilanTab.value === 'objectifs') {
                    updateObjectifsStats();
                }
            });

            watch(() => bilanRows.value, () => {
                if(bilanTab.value === 'objectifs') {
                    updateObjectifsStats();
                }
            }, { deep: true });
            
            const validateAction = async (r, type) => { 
                if(type==='rappels') {
                    // Si le rappel a d√©j√† √©t√© fait, ne pas r√©ouvrir le SMS - juste confirmer
                    if(r.rappelFait) {
                        showNotification('‚úÖ Ce rappel a d√©j√† √©t√© envoy√©', 'info', 'fa-bell');
                        return;
                    }
                    
                    // Marquer le rappel comme fait AVANT d'ouvrir le SMS
                    const now = new Date();
                    const note = { 
                        text: `üîî Rappel envoy√©`, 
                        author: user.name, 
                        date: now.toISOString(),
                        type: 'rappel'
                    };
                    let notes = r.notes || []; 
                    notes.push(note);
                    
                    // Mettre √† jour imm√©diatement dans l'interface
                    r.rappelFait = true;
                    r.rappelFaitDate = now.toISOString();
                    r.rappelFaitHeure = now.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});
                    r.notes = notes;
                    if(clientModal.rdv && clientModal.rdv.id === r.id) {
                        clientModal.rdv.rappelFait = true;
                        clientModal.rdv.rappelFaitDate = now.toISOString();
                        clientModal.rdv.rappelFaitHeure = now.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});
                        clientModal.rdv.notes = notes;
                    }
                    
                    // Sauvegarder dans Firebase
                    await db.collection('rendezvous').doc(r.id).update({ 
                        rappelFait: true,
                        rappelFaitDate: now.toISOString(),
                        rappelFaitHeure: now.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'}),
                        notes: notes
                    });
                    
                    // Ouvrir directement l'application SMS Android avec le message pr√©-rempli
                    const rappelType = getRappelType(r);
                    const smsLink = generateMsgLink(r, rappelType);
                    
                    // Pour Android, on ouvre directement l'app SMS avec le message
                    // L'utilisateur pourra ensuite programmer l'envoi dans l'app SMS Android
                    if(smsLink) {
                        window.open(smsLink, '_blank');
                    }
                    
                    showNotification('‚úÖ Rappel marqu√© comme envoy√© - Application SMS ouverte', 'success', 'fa-mobile-alt');
                }
                if(type==='confirmations') {
                    // V√©rifier si le RDV est dans l'agenda avant de valider
                    if (!r.dansAgenda) {
                        // Afficher un modal moderne au lieu d'un confirm()
                        return new Promise((resolve) => {
                            confirmAgendaModal.rdv = r;
                            confirmAgendaModal.onConfirm = async (confirmed) => {
                                if (confirmed) {
                                    // L'utilisateur confirme qu'il a ajout√© √† l'agenda, on valide
                                    await db.collection('rendezvous').doc(r.id).update({ statut:'confirme' });
                                    r.statut = 'confirme';
                                } else {
                                    // L'utilisateur veut d'abord ajouter √† l'agenda
                                    // Ne rien faire, il pourra cliquer sur le bouton Agenda
                                }
                                confirmAgendaModal.open = false;
                                confirmAgendaModal.rdv = null;
                                confirmAgendaModal.onConfirm = null;
                                resolve();
                            };
                            confirmAgendaModal.open = true;
                        });
                    } else {
                        await db.collection('rendezvous').doc(r.id).update({ statut:'confirme' }); 
                    }
                }
            };
            const generateLink = (r, type) => generateMsgLink(r, type);

            return {
                user, loginEmail, loginPass, view, login, logout, loginAdminSelection, finalizeAdminLogin,
                rdvList, agences, sourcesList, stats, sortedDaily, filteredList, displayedList, rappelsList, confirmList, rappelCount, confirmCount,
                wizard, form, clientModal, settingsModal, cancelModal,
                rescheduleModal, motifSelectionModal, messagePreviewModal, rescheduleSMSMessages, rescheduleSMSMessagesClient, rescheduleMotifsList, rescheduleMotifsListInterne, newRescheduleMotif, newRescheduleMotifInterne, editingRescheduleType, openMotifs, loadRescheduleSMSMessages, saveRescheduleSMSMessages, addRescheduleMotif, removeRescheduleMotif, addRescheduleMotifInterne, removeRescheduleMotifInterne, copyToClipboard, insertVariable, getReschedulePreview, updateReschedulePreview, selectMotif, getMotifLabel, openRescheduleModal, handleMotifTypeChange, confirmRescheduleStep1, sendRescheduleSMS, showMessagePreview, deleteRdv: softDeleteRdv, softDeleteRdv,
                changeView, showUpcoming, showLive, showHonored, showNoShow, showCancelled, goBackFromList, fromDashboard, // NEW EXPORTS
                currentFilter, listFilters, resetListFilters, displayLimit,
                startWizard, finalizeRdv, selectSource, validateAndSendSMS, finalizeRdvWithSMS, parseAndFormatFacebookCaracteristiques, handleFacebookPaste, updateModeleFromFacebook, getBaseModele, formatCaracteristiquesForDisplay, updateEditModalModele, addNewCaracteristique, removeCaracteristique, getFormatagePreview, saveFormatageSettings, formatageSettings, formatPrixInput, handlePrixPaste, formatModeleName, googleCalendarDisconnectedModal,
                openRdvFiche, updateRdv, toggleOkM, resendReminder, sendManualRappel, openCancelChoice, confirmCancel, quickCancel, updateStatus, rdvMenuOpen,
                openSettings, openAgencyEdit, saveEditingAgency, editingAgency, saveAgency, deleteAgency, addSource, removeSource, changeSourceLogo, getLogo,
                editingAgencyCommerciaux, addAgencyCommercial, removeAgencyCommercial,
                editingAgencyFermetures, addAgencyFermeture, removeAgencyFermeture, saveFermetureIndividuelle, isFermetureValide,
                newSource, motifsList, newMotif, addMotif, removeMotif, cancelMotifsList, newCancelMotif, addCancelMotif, removeCancelMotif, editingMsgAgence, editingMsgType, clientExists, insertTag, msgLabels, getMessagePreview,
                globalSearchModal, performGlobalSearch, selectFirstResult, actionHistory, logAction,
                detailedLogs, performanceStats, workloadPrediction, loadDetailedLogs, calculatePerformanceStats, calculateWorkloadPrediction,
                connectedUsers, connexionsHistory, connectedUsersCount, loadConnexionsHistory, calculateConnectedUsers, loadingConnexions,
                selectedConnexionLogs, connexionDeleteModal, toggleConnexionLogSelection, deleteConnexionLogs,
                userHistoryModal, openUserHistoryModal, monthlySummaries,
                generateMsgLink, generateLink, validateAction,
                dateOptions, timeSlots, commonCars, pastePhoneNumber, copyToAgenda, showCustomTime, updateGoogleCalendarEvent, deleteGoogleCalendarEvent, addToAgenda, removeFromAgenda, fetchGoogleCalendarList, googleCalendarList, loadingCalendars,
                syncSettings, saveSyncSettings, 
                filters, search, 
                formatDateFr, formatDateShort, formatDateLong, formatPrice, isEnCours, isLateAndNoStatus, displayStatus, statusClass, getAgenceName, getCreatedDate, getCreatedTime, isNewRdvFromOther, isRdvApproaching, needsRappel, getCalendarColor,
                normalizePhone, onWizardPhoneInput, onModalPhoneInput, formatName, formatNameRealTime, formatNameRealTimeEdit, onWizardNameBlur, onWizardNamePaste, onEditModalNameBlur, onEditModalNamePaste, getRdvClientLink,
                getRappelType, getRappelLabel,
                intelligentPaste, handleIntelligentPaste, showIntelligentModeHelp,
                openReschedule,
                currentFullDateLabel, checkAgenceAndProceed, pausedAgencyModal, pauseReasonSelect, updatePauseReason,
                getPauseMessage, isDateInFermeture, getFermetureMessage, isAgenceFermeeAujourdhui, getProgressPercent, getRdvTimeStatus,
                pendingStatusList, pendingStatusCount, getRelativeRdvLabel,
                selectedIds, selectAll, toggleSelection, isAllSelected, bulkModal, openBulkConfirm, executeBulkAction, 
                trashList, trashCount, restoreRdv, hardDeleteRdv,
                agencySearch, filteredAgences,
                calculateTTC, conversionRate, conversionRateColor, conversionEmoji, activeRdvCount,
                // NEW VARS
                teamList, newMember, addTeamMember, toggleBlockTeamMember, deleteTeamMember, mobileMenuOpen, welcomeModal, tutorialModal, tutorialVideoModal, forcedLogoutModal, blockedLoginMessage, loginErrorModal, quickRdvCommerciaux, quickRdvHasCommerciaux,
                adminNamesList, newAdminName, addAdminName, removeAdminName,
                newNoteText, addNote,showDiscountInput, allProspectors, dashboardFilters, dashboardLimit, filteredDaily,rdvTodayCount, nextRdvLabel, currentTheme, isTimelineTomorrow, showTimelineTomorrow,
                googleCalendarConnected, googleCalendarUserEmail, isGoogleCalendarConnected, googleCalendarTokenValid, checkingToken, checkAndUpdateTokenStatus, tokenTimeRemaining, connectGoogleCalendar, disconnectGoogleCalendar, manualSyncGoogleCalendar,
                prospecteurGoogleCalendarConnected, prospecteurGoogleCalendarTokenExpired, prospecteurTokenTimeRemaining, prospecteurDisplayTimeRemaining, prospecteurGoogleCalendarTokenValid, checkingProspecteurToken, checkAndUpdateProspecteurTokenStatus, handleProspecteurGoogleCalendar, reloadProspecteurToken,forceGlobalRefresh, getActiveGoogleToken, activeGoogleToken,
                confirmAgendaModal, reconnectAgendaModal, googleCalendarInfoModal, handleAddToAgendaClick, handleRemoveFromAgendaClick, confirmRemoveFromAgenda, removeAgendaConfirmModal, handleReconnectForAgenda, handleCloseDisconnectedModal, saveGoogleCalendarRequired, googleCalendarRequired,
                // CALENDRIER
                currentWeekStart, calendarWeekDays, calendarHours, calendarEvents, calendarLoading, calendarAgencyFilter,
                previousWeek, nextWeek, goToToday, refreshCalendarEvents, createRdvFromTimeSlot, openEventDetails,
                getEventsForSlot, getEventStyle, getEventTitle, getEventTime, isCurrentTimeSlot, formatCalendarWeekTitle, getAgenceColor,
                isClosedSlot, getClosedMessage, getOpeningTime, getOpeningLineStyle, getDayHoursInfo, isDayClosed,
                applyHorairesToAllDays,
                honorModal, openHonorCheck, finalizeHonor, syncRdvToBilan, removeRdvFromBilan, getHonorCommerciaux, getAgencyCommerciaux,
                editModal, openEdit, saveEdit, deleteNote, editMainNote, deleteMainNote, editNoteModal, saveNoteEdit,
                
                discountModal, openDiscountModal, saveDiscount, removeDiscount,
                reminderAlertModal, rappelsVeilleCount, rappelsJourCount,
                teamEditModal, openTeamEdit, saveTeamMemberEdit, passwordEditModal, openPasswordEdit, savePasswordEdit, 
                customConfirmModal, openCustomConfirm, rappelFilters, rappelsDisplay,
                globalSettings, saveGlobalSettings,
                pendingStatusModal,
                notificationToast, showNotification, 
                
                // NEW STATS & PRICING
                statsModal, openStatsModal, detailedStats, statsModalData, commercialStatsFiltered, mandatsParAgence, statsModalSelectedPeriod, statsFilterAgency, statsFilterUser, statsFilterMonth, statsFilterYear, resetDashboardDateFilters, resetStatsModalDateFilters, visibleAgencies, userCommissionStats, exportStatsPdf,
                globalCommission, tips, saveTip,
                
                // PORTAFEUILLE
                portefeuilleSearch, selectedProspecteur, filteredProspectors, transactions, prospecteurEdit,
                filterProspectors, selectProspecteur, loadProspecteurData, saveProspecteurSettings,
                hideTransaction, showTransaction, deleteTransaction, getTransactionIcon, loadUserTransactions,
                prospecteurStats, allTransactions, visibleTransactions, userPortefeuille,
                onlyProspectors, prospectorsWithStats, displayedProspectors, adminStats,
                createTransactionForRdv, checkAndCreateBonusTransactions, deleteTransactionsForRdv, createMissingTransactionsForUser, getRdvFromTransaction, tipModal, openTipModal, saveTipTransaction,
                
                // RAPPELS ET RDV RAPIDE
                rappelConfirmModal, confirmRappelSent, quickRdvModal, createQuickRdv, handleSendRappel,
                
                // BILAN
                bilanRows, bilanConfig, bilanForm, bilanFilters, selectedBilanIds, bilanCurrentPage, bilanPeriod, bilanModal, bilanEditModal, bilanSettingsModal,
                formatBilanPrice, formatBilanDate, getBilanLineVals, getBilanCommerciaux, onBilanAgenceChange, addBilanBlock, removeBilanBlock, saveBilanRdv,
                toggleBilanReport, renderBilanTable, clearBilanFilters, goToPreviousMonth, deleteSelectedBilan, toggleAllBilan, isAllBilanSelected, changeBilanPage, displayedBilanRows, bilanTotalPages, bilanStats,
                showBilanCommercialModal, exportMonthPdfAll, exportComptaExcel, openBilanSettings, openBilanEdit, saveBilanEdit, exportBilanPdf, setBilanPeriod,
                exportBilanAgencePDF, exportBilanCommercialPDF, getTarifPersonnalise,
                loadBilanConfig, loadBilanData, buildBilanMonthOptions, handleBilanLogo, handleBilanSignature, saveBilanSettings,
                bilanTab, urgentBilanRows, urgentBilanCount, prospecteurUrgentRows, prospecteurUrgentCount, openUrgentCommercialModal, saveUrgentCommercial, getUrgentRdvClient, getUrgentRdvPhone, urgentCommercialModal, getUrgentCommerciaux,
                bilanMonthOptions, bilanYearOptions, dashboardYearOptions, syncAllHonoredRdv, hasBilanCommerciaux, cleanAndRegroupBilan, billingSummaryModal, openBillingSummary, billingStatsGrouped, billingSummarySearch, filteredBillingStatsGrouped,
                
                // OBJECTIFS
                objectifsFilters, objectifsStats, objectifModal, tarifPersonnaliseModal,
                openObjectifModal, saveObjectif, hasObjectifCommerciaux, getObjectifCommerciaux, onObjectifAgenceChange,
                openTarifPersonnaliseModal, addTarifPersonnalise, removeTarifPersonnalise, saveTarifPersonnalise,
                getObjectifProgressPercent, getObjectifProgressClass, getObjectifStatusClass, updateObjectifsStats,
                fermetureModal, fermeturesList, deleteFermeture, createFermeture, loadFermetures, fermetureDeleteConfirmModal, confirmDeleteFermeture, editFermeture, updateFermeture,
                heureFermetureConfirmModal, confirmHeureFermeture, checkHeureFermetureAndConfirm, getHeureFermetureAgence, isHeureProcheFermeture, isHeureValide, handleTimeInput,
                heureLimiteExceptionnelleModal, isHeureApresLimiteExceptionnelle, heureApresFermetureModal, confirmHeureApresFermeture, isHeureApresFermeture
            };
        }
    }).mount('#app');
</script>
</body> 
</html>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
      /* 1. RESET DE BASE OBLIGATOIRE (MODIFI√â) */
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            -webkit-tap-highlight-color: transparent;
            overflow: hidden; /* Emp√™che le rebond √©lastique de Safari */
        }
        
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            min-height: 100dvh; /* Force la hauteur dynamique iOS */
            background-color: #667eea;
            position: fixed;
            inset: 0; /* Force l'ancrage aux 4 coins */
            overflow: hidden;
            overscroll-behavior: none;
        }

        /* 2. LE FOND MAGIQUE (FIX POUR MOBILE) */
        /* Au lieu de peindre le body, on cr√©e un calque virtuel derri√®re qui ne bouge jamais */
     body::before {
            content: "";
            position: fixed;
            top: -10vh; /* On remonte un peu pour centrer le d√©passement */
            left: 0;
            width: 100vw;
            height: 120vh; /* ASTUCE : Plus grand que l'√©cran pour √©viter la coupure en bas */
            z-index: -1;
            
            /* Ton d√©grad√© original */
            background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #4facfe 75%, #00f2fe 100%);
            background-size: 400% 400%;
            animation: gradient-shift 15s ease infinite;
            pointer-events: none; /* Important : permet de cliquer au travers */
        }

        /* 3. LE CONTENU (SCROLLABLE) */
        body {
            font-family: 'Segoe UI', sans-serif;
            overflow-x: hidden;
            /* Plus de background ici, c'est g√©r√© par ::before */
        }

        #app {
          position: absolute; /* Mieux que fixed pour le scroll interne */
            top: 0;
            left: 0;
            width: 100%;
            height: 100dvh; /* Hauteur exacte de la vue dynamique */
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            
            /* Gestion sp√©cifique de la barre du bas iPhone */
            padding-bottom: env(safe-area-inset-bottom, 20px); 
        }
        
        /* Fix pour iPhone - Prendre toute la hauteur de l'√©cran */
        @supports (-webkit-touch-callout: none) {
            html {
                height: -webkit-fill-available;
            }
            body {
                height: -webkit-fill-available;
                padding-bottom: env(safe-area-inset-bottom);
            }
            #app {
                height: -webkit-fill-available;
                padding-bottom: env(safe-area-inset-bottom);
            }
        }
        
        /* Masquer la barre d'adresse du navigateur sur mobile */
        @media screen and (display-mode: standalone) {
            body {
                padding-bottom: env(safe-area-inset-bottom) !important;
            }
        }
        
        /* Style pour mode plein √©cran - Prendre toute la hauteur */
        @media all and (display-mode: standalone) {
            html, body, #app {
                height: 100vh !important;
                height: 100dvh !important;
                height: -webkit-fill-available !important;
            }
        }
        
        /* Forcer la hauteur compl√®te sur mobile */
        @media (max-width: 768px) {
            html, body {
                min-height: 100vh;
                min-height: 100dvh;
                min-height: -webkit-fill-available;
            }
        }

        /* --- RESTE DE TON CSS (ANIMATIONS & COMPOSANTS) --- */

        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* Animations */
        @keyframes fadeIn { from {opacity:0; transform: translateY(10px);} to {opacity:1; transform: translateY(0);} }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        
        @keyframes popIn { 0%{transform: scale(0.9); opacity: 0;} 100%{transform: scale(1); opacity: 1;} }
        .pop-in { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        @keyframes slideUp { from {transform: translateY(20px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }
        .slide-up { animation: slideUp 0.4s ease-out forwards; }

        @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); } 20%, 40%, 60%, 80% { transform: translateX(5px); } }
        .animate-shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        
        /* Animations pour header moderne */
        @keyframes shimmer {
            0% { transform: translateX(-100%) skewX(-15deg); }
            100% { transform: translateX(200%) skewX(-15deg); }
        }
        .animate-shimmer { animation: shimmer 2s infinite; }
        
        @keyframes gradient-shift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        .animate-gradient-shift {
            background-size: 200% 200%;
            animation: gradient-shift 3s ease infinite;
        }
        
        @keyframes pulse-slow {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.1); }
        }
        .animate-pulse-slow { animation: pulse-slow 4s ease-in-out infinite; }
        
        @keyframes bounce-slow {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        .animate-bounce-slow { animation: bounce-slow 2s ease-in-out infinite; }
        
        /* Animation shine pour effet de brillance */
        @keyframes shine {
            0% { transform: translateX(-100%) skewX(-12deg); }
            100% { transform: translateX(200%) skewX(-12deg); }
        }
        .animate-shine { animation: shine 3s infinite; }
        
        /* Animation fadeIn pour modale */
        .animate-fadeIn { animation: fadeIn 0.3s ease-out forwards; }
        
        /* Confetti */
        .confetti { position: fixed; width: 10px; height: 10px; background-color: #f00; animation: fall linear forwards; z-index: 1; pointer-events: none !important; }
        @keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }
        
        /* Animation pour notification toast */
        @keyframes slide-in-right {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .animate-slide-in-right {
            animation: slide-in-right 0.3s ease-out forwards;
        }
        
        /* Transition Vue pour toast */
        .toast-enter-active {
            transition: all 0.3s ease-out;
        }
        .toast-leave-active {
            transition: all 0.3s ease-in;
        }
        .toast-enter-from {
            transform: translateX(100%);
            opacity: 0;
        }
        .toast-leave-to {
            transform: translateX(100%);
            opacity: 0;
        }

        /* Scrollbar Masqu√©e */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

        .logo-img { width: 20px; height: 20px; object-fit: contain; border-radius: 4px; }
        .badge-status { padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; }
        .custom-checkbox { width: 24px; height: 24px; cursor: pointer; accent-color: #2563EB; z-index: 50; position: relative; }

        /* Style sp√©cifique du Date Picker V22 */
        .date-card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        .date-card-selected {
            border-color: #2563EB; 
            background-color: #2563EB;
            color: white;
            box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.5), 0 4px 6px -2px rgba(37, 99, 235, 0.5);
        }

        /* Masquer la fl√®che du datalist */
        input::-webkit-calendar-picker-indicator {
            display: none !important;
        }

        /* --- NOUVEAUX STYLES POUR RENDRE-VOUS EN COURS --- */
        @keyframes status-pulse {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); } 
            70% { box-shadow: 0 0 0 8px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
        
        /* Animation BORDURE CARD (Demand√©e) */
        @keyframes border-pulse { 
            0% { border-color: rgba(34, 197, 94, 0.2); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); } 
            50% { border-color: rgba(34, 197, 94, 1); box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); } 
            100% { border-color: rgba(34, 197, 94, 0.2); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); } 
        }
        .live-animation { animation: border-pulse 2s infinite; border: 2px solid #22c55e !important; }

        .status-label-active {
            font-size: 10px; font-weight: 900; text-transform: uppercase; color: #22c55e;
            display: flex; align-items: center; padding: 4px 8px; border-radius: 6px;
            background-color: #f0fdf4; border: 1px solid #bbf7d0; letter-spacing: 0.5px;
            animation: fadeIn 0.4s ease-out forwards;
        }
        .status-label-active .live-dot {
            width: 8px; height: 8px; background-color: #22c55e; border-radius: 50%; margin-right: 6px;
            animation: status-pulse 1.5s infinite;
        }
       /* =========================================
           üéÖ TH√àME NO√ãL - ULTRA COMPLET üéÖ
           ========================================= */

        /* 1. CURSEUR SAPIN (Uniquement sur PC) */
        @media (min-width: 768px) {
            .theme-christmas, 
            .theme-christmas button, 
            .theme-christmas a, 
            .theme-christmas input {
                /* Remplace le curseur par un Sapin */
                cursor: url('https://img.icons8.com/color/32/christmas-tree.png'), auto !important;
            }
            /* Curseur "Main" devient un P√®re No√´l ou Cadeau */
            .theme-christmas .cursor-pointer {
                cursor: url('https://img.icons8.com/color/32/gift--v1.png'), pointer !important;
            }
        }

        /* 2. EFFET "GRELOT" (Les boutons tremblent au survol) */
        @keyframes jingle {
            0% { transform: rotate(0); }
            25% { transform: rotate(5deg); }
            50% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
            100% { transform: rotate(0); }
        }

        .theme-christmas button:hover,
        .theme-christmas .cursor-pointer:hover {
            animation: jingle 0.5s ease-in-out infinite; /* √áa grelotte ! */
            box-shadow: 0 0 15px rgba(220, 38, 38, 0.8) !important; /* Lueur rouge */
        }

        /* 3. NEIGE MAGIQUE (Tombe et ondule) */
        .snowflake {
            position: fixed; top: -5vh; color: #fff;
            text-shadow: 0 0 5px rgba(255,255,255,0.8);
            pointer-events: none !important; z-index: 1;
            animation: snowfall linear infinite;
        }
        @keyframes snowfall {
            0% { transform: translateY(0) translateX(0) rotate(0deg); opacity: 1; }
            25% { transform: translateY(25vh) translateX(15px) rotate(90deg); }
            50% { transform: translateY(50vh) translateX(-15px) rotate(180deg); }
            75% { transform: translateY(75vh) translateX(15px) rotate(270deg); }
            100% { transform: translateY(110vh) translateX(0) rotate(360deg); opacity: 0; }
        }

        /* 4. COULEURS & D√âGRAD√âS NO√ãL */
        .theme-christmas body { background-color: #fff1f2 !important; /* Fond ros√© hiver */ }

        /* Les boutons bleus deviennent ROUGE NO√ãL */
        .theme-christmas .bg-blue-600 { 
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%) !important; 
            border: 1px solid #fca5a5;
        }
        
        /* Les textes bleus deviennent VERT SAPIN */
        .theme-christmas .text-blue-600, 
        .theme-christmas .text-blue-500 { 
            color: #166534 !important; /* Vert fonc√© */
            font-weight: 800;
        }

        /* Fonds clairs (cartes) deviennent l√©g√®rement teint√©s */
        .theme-christmas .bg-blue-50 { background-color: #fef2f2 !important; border-color: #fecaca !important; }
        .theme-christmas .border-blue-200 { border-color: #fecaca !important; }

        /* 5. LOGO QUI RESPIRE (PULSE) */
        .theme-christmas .sidebar-logo {
            background: linear-gradient(135deg, #15803d 0%, #b91c1c 100%) !important;
            border: 2px solid #fbbf24; /* Bordure dor√©e */
            animation: christmas-pulse 3s infinite ease-in-out;
        }
        @keyframes christmas-pulse {
            0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); transform: scale(1); }
            50% { box-shadow: 0 0 20px 10px rgba(220, 38, 38, 0); transform: scale(1.1); }
            100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); transform: scale(1); }
        }

        /* 6. SUCRE D'ORGE (Barres de progression) */
        .theme-christmas .bg-blue-500, .theme-christmas .h-full.bg-black\/50 {
            background: repeating-linear-gradient(45deg, #dc2626, #dc2626 10px, #ffffff 10px, #ffffff 20px) !important;
            background-size: 28px 28px !important;
            animation: candy-stripe 1s linear infinite !important;
        }
        @keyframes candy-stripe { 0% { background-position: 0 0; } 100% { background-position: 28px 0; } }

        /* 7. ADAPTATION T√âL√âPHONE ("Typhons") */
        @media (max-width: 768px) {
            /* Sur mobile, le curseur redevient normal (pas de bug tactile) */
            .theme-christmas * { cursor: auto !important; }
            
            /* Les boutons importants respirent tout seuls (car pas de survol) */
            .theme-christmas button.bg-slate-900, /* Bouton Nouveau */
            .theme-christmas button.bg-blue-600 { /* Boutons actions */
                animation: heartbeat 2s infinite !important;
            }
            @keyframes heartbeat {
                0% { transform: scale(1); }
                10% { transform: scale(1.03); }
                20% { transform: scale(1); }
                100% { transform: scale(1); }
            }
        }

        /* --- AUTRES TH√àMES --- */
        .theme-summer .bg-blue-600 { background-color: #0ea5e9 !important; }
       /* =================================================================
           üéÉ HALLOWEEN : MODE "CYBER-WITCH" (Sombre & N√©on)
           ================================================================= */
        .theme-halloween body { 
            background: radial-gradient(circle at center, #2e1065 0%, #000000 100%) !important;
            color: #e4e4e7 !important;
        }
        
        /* Cartes "Verre Fum√©" */
        .theme-halloween .bg-white, .theme-halloween .bg-slate-50 { 
            background-color: rgba(20, 20, 20, 0.85) !important; 
            border: 1px solid rgba(139, 92, 246, 0.3); /* Bordure violette */
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            color: #fff !important;
        }

        /* Textes */
        .theme-halloween .text-slate-800, .theme-halloween .text-slate-700 { color: #fff !important; }
        .theme-halloween .text-slate-500 { color: #a1a1aa !important; }
        
        /* Boutons "Sortil√®ge" */
        .theme-halloween .bg-blue-600, .theme-halloween .bg-slate-900 { 
            background: linear-gradient(45deg, #f97316, #7c3aed) !important; 
            border: none;
            box-shadow: 0 0 15px #7c3aed;
            position: relative; overflow: hidden;
        }
        .theme-halloween .bg-blue-600:hover { box-shadow: 0 0 30px #f97316; transform: scale(1.02); }

        /* Cursors */
        @media (min-width: 768px) {
            .theme-halloween * { cursor: url('https://img.icons8.com/color/32/ghost.png'), auto !important; }
            .theme-halloween .cursor-pointer { cursor: url('https://img.icons8.com/color/32/halloween-pumpkin.png'), pointer !important; }
        }

        /* =================================================================
           ‚ù§Ô∏è TH√àME SAINT-VALENTIN : MODE "CALME & CHIC" (100% Fixe)
           ================================================================= */
        .theme-love body { 
            background: linear-gradient(to bottom, #fff1f2, #ffe4e6) !important; 
            color: #881337 !important;
        }

        /* Cartes fixes et propres */
        .theme-love .bg-white, .theme-love .bg-slate-50 { 
            background-color: #fff !important;
            border: 1px solid #fecdd3 !important;
            box-shadow: 0 4px 6px -1px rgba(225, 29, 72, 0.1); /* Ombre l√©g√®re rose */
            color: #4c0519 !important;
        }

        /* Textes */
        .theme-love .text-slate-800 { color: #881337 !important; }
        .theme-love .text-slate-500 { color: #9f1239 !important; }
        
        /* Boutons fixes (Pas de battement de coeur) */
        .theme-love .bg-blue-600, .theme-love .bg-slate-900 { 
            background: linear-gradient(135deg, #be123c 0%, #e11d48 100%) !important; 
            border: none;
            box-shadow: 0 4px 6px rgba(190, 18, 60, 0.2);
        }
        
        /* Survol simple (Juste un changement de couleur, pas de mouvement) */
        .theme-love .bg-blue-600:hover { 
            background: linear-gradient(135deg, #e11d48 0%, #be123c 100%) !important; 
        }

        /* Accents */
        .theme-love .text-blue-600 { color: #db2777 !important; }
        .theme-love .bg-blue-50 { background-color: #fff1f2 !important; border-color: #fda4af !important; }

        /* Logo fixe */
        .theme-love .sidebar-logo {
            background: linear-gradient(to bottom right, #fb7185, #be123c) !important;
            box-shadow: 0 0 0 2px rgba(251, 113, 133, 0.2);
        }

        /* Curseur standard (pour √©viter la fatigue visuelle) */
        @media (min-width: 768px) {
            .theme-love * { cursor: auto !important; }
            .theme-love .cursor-pointer { cursor: pointer !important; }
        }

        /* =================================================================
           üéÜ 14 JUILLET : MODE "R√âPUBLIQUE" (√âl√©gance Tricolore)
           ================================================================= */
        .theme-bastille body { background-color: #f1f5f9 !important; }

        /* Boutons Patriotiques (D√©grad√© Bleu Blanc Rouge subtil) */
        .theme-bastille .bg-blue-600, .theme-bastille .bg-slate-900 { 
            background: linear-gradient(90deg, #1e3a8a 0%, #1d4ed8 50%, #dc2626 100%) !important; 
            background-size: 200% auto;
            transition: 0.5s;
            border: 1px solid #fff;
            box-shadow: 0 4px 10px rgba(30, 58, 138, 0.3);
        }
        .theme-bastille .bg-blue-600:hover { background-position: right center !important; }

        /* Titres en Bleu Roi */
        .theme-bastille .text-slate-800 { color: #1e3a8a !important; }
        
        /* Logo qui √©tincelle */
        .theme-bastille .sidebar-logo {
            background: #dc2626 !important;
            animation: fireworks-flash 2s infinite;
        }
        @keyframes fireworks-flash {
            0%, 100% { box-shadow: 0 0 5px #1e3a8a; }
            50% { box-shadow: 0 0 20px #dc2626, 0 0 40px #fff; }
        }

        /* Cursors */
        @media (min-width: 768px) {
            .theme-bastille * { cursor: url('https://img.icons8.com/color/32/france.png'), auto !important; }
            .theme-bastille .cursor-pointer { cursor: url('https://img.icons8.com/color/32/firework.png'), pointer !important; }
        }

        /* =================================================================
           ‚òÄÔ∏è √âT√â / VACANCES : MODE "LAGON" (Fra√Æcheur & Soleil)
           ================================================================= */
        .theme-summer body { background-color: #ecfeff !important; } /* Cyan tr√®s p√¢le */

        /* Boutons "Mojito" (D√©grad√© Cyan/Jaune) */
        .theme-summer .bg-blue-600 { 
            background: linear-gradient(135deg, #06b6d4 0%, #f59e0b 100%) !important; 
            box-shadow: 0 4px 15px rgba(6, 182, 212, 0.4);
        }
        .theme-summer .bg-blue-600:hover { transform: rotate(-2deg) scale(1.05); }

        /* Cartes lumineuses */
        .theme-summer .bg-white { border-bottom: 4px solid #f59e0b !important; }

        /* Textes "Mer des Cara√Øbes" */
        .theme-summer .text-blue-600 { color: #0891b2 !important; }
        
        /* Logo Soleil qui tourne */
        .theme-summer .sidebar-logo {
            background: linear-gradient(to bottom, #f59e0b, #ea580c) !important;
            animation: spin-slow 20s linear infinite;
        }

        /* Cursors */
        @media (min-width: 768px) {
            .theme-summer * { cursor: url('https://img.icons8.com/color/32/sun--v1.png'), auto !important; }
            .theme-summer .cursor-pointer { cursor: url('https://img.icons8.com/color/32/melting-ice-cream.png'), pointer !important; }
        }

        /* =================================================================
           ‚ú® TH√àME MODERNE CHIC : MODE "LUXURY PREMIUM" (√âl√©gance & Sophistication)
           ================================================================= */
        
        /* Application du th√®me moderne par d√©faut */
        .theme-modern,
        body:not(.theme-christmas):not(.theme-halloween):not(.theme-love):not(.theme-bastille):not(.theme-summer):not(.theme-newyear) {
            /* Tous les styles modernes s'appliquent */
        }

        /* Effet Glassmorphism pour les cartes */
        .bg-white, .bg-slate-50 { 
            background: rgba(255, 255, 255, 0.95) !important;
            border: 1px solid rgba(255, 255, 255, 0.3) !important;
            box-shadow: 0 8px 32px 0 rgba(102, 126, 234, 0.15), 
                        0 4px 16px 0 rgba(118, 75, 162, 0.1) !important;
        }

        /* Header avec effet verre */
        header.bg-white\/80 {
            background: rgba(255, 255, 255, 0.9) !important;
            border-color: rgba(102, 126, 234, 0.2) !important;
        }

        /* Sidebar √©l√©gante */
        aside.bg-white {
            background: rgba(255, 255, 255, 0.95) !important;
            border-right: 1px solid rgba(102, 126, 234, 0.2) !important;
            box-shadow: 4px 0 24px rgba(102, 126, 234, 0.1) !important;
        }

        /* Boutons avec d√©grad√© premium */
        .bg-blue-600, .bg-slate-900 { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%) !important;
            border: none !important;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4),
                        0 4px 15px rgba(118, 75, 162, 0.3),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2) !important;
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }
        .bg-blue-600:hover, .bg-slate-900:hover {
            transform: translateY(-2px) scale(1.02) !important;
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.5),
                        0 6px 20px rgba(118, 75, 162, 0.4),
                        inset 0 1px 0 rgba(255, 255, 255, 0.3) !important;
        }
        .bg-blue-600:active, .bg-slate-900:active {
            transform: translateY(0) scale(0.98) !important;
        }

        /* Effet brillant sur les boutons */
        .bg-blue-600::before, .bg-slate-900::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }
        .bg-blue-600:hover::before, .bg-slate-900:hover::before {
            left: 100%;
        }

        /* Textes avec couleurs sophistiqu√©es */
        .text-slate-800, .text-slate-700 { 
            color: #1e1b4b !important; /* Indigo tr√®s fonc√© */
        }
        .text-slate-500 { 
            color: #6366f1 !important; /* Indigo moyen */
        }
        .text-blue-600, .text-blue-500 { 
            color: #667eea !important; /* Violet-bleu */
            font-weight: 600;
        }

        /* Zones actives avec fond d√©grad√© subtil */
        .bg-blue-50 { 
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%) !important;
            border-color: rgba(102, 126, 234, 0.3) !important;
        }
        .border-blue-200 { 
            border-color: rgba(102, 126, 234, 0.4) !important;
        }

        /* Logo avec effet premium */
        .sidebar-logo {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%) !important;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4),
                        inset 0 1px 0 rgba(255, 255, 255, 0.3) !important;
            animation: logo-glow 3s ease-in-out infinite !important;
        }
        @keyframes logo-glow {
            0%, 100% { 
                box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4),
                            inset 0 1px 0 rgba(255, 255, 255, 0.3);
            }
            50% { 
                box-shadow: 0 12px 32px rgba(118, 75, 162, 0.6),
                            inset 0 1px 0 rgba(255, 255, 255, 0.4);
            }
        }

        /* Cartes avec effet hover √©l√©gant */
        .rounded-2xl, .rounded-3xl, .rounded-xl {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }
        .rounded-2xl:hover, .rounded-3xl:hover {
            transform: translateY(-4px) !important;
            box-shadow: 0 12px 40px rgba(102, 126, 234, 0.2),
                        0 6px 20px rgba(118, 75, 162, 0.15) !important;
        }

        /* Scrollbar √©l√©gante */
        ::-webkit-scrollbar { 
            width: 8px; 
            height: 8px; 
        }
        ::-webkit-scrollbar-track { 
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            border: 2px solid transparent;
            background-clip: padding-box;
        }
        ::-webkit-scrollbar-thumb:hover { 
            background: linear-gradient(135deg, #764ba2 0%, #f093fb 100%);
        }

        /* Inputs avec style moderne */
        input, textarea, select {
            background: rgba(255, 255, 255, 0.9) !important;
            border-color: rgba(102, 126, 234, 0.3) !important;
            transition: all 0.3s !important;
        }
        input:focus, textarea:focus, select:focus {
            border-color: #667eea !important;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1) !important;
            background: rgba(255, 255, 255, 1) !important;
        }

        /* Badges avec d√©grad√© */
        .badge-status {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%) !important;
            border: 1px solid rgba(102, 126, 234, 0.3) !important;
        }

        /* Styles pour le calendrier semaine */
        .calendar-week-container {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: white;
        }
        .calendar-week-grid {
            display: grid;
            grid-template-columns: 60px repeat(7, 1fr);
            min-height: 600px;
        }
        .calendar-time-column {
            border-right: 2px solid #e2e8f0;
            background: #f8fafc;
        }
        .calendar-time-header {
            height: 60px;
            border-bottom: 2px solid #e2e8f0;
        }
        .calendar-time-cell {
            height: 60px;
            border-bottom: 1px solid #f1f5f9;
            padding: 4px 8px;
            font-size: 11px;
            color: #64748b;
            font-weight: 600;
            display: flex;
            align-items: flex-start;
            padding-top: 8px;
        }
        .calendar-day-column {
            border-right: 1px solid #e2e8f0;
            position: relative;
        }
        .calendar-day-column.today-column {
            background: #f0f9ff;
        }
        .calendar-day-header {
            min-height: 100px;
            border-bottom: 2px solid #e2e8f0;
            padding: 12px 8px;
            text-align: center;
            background: white;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .calendar-day-header.today-header {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }
        .calendar-day-header.today-header .text-xs {
            color: rgba(255, 255, 255, 0.9);
        }
        .calendar-day-column.closed-day {
            opacity: 0.5;
            background: #f8fafc;
        }
        .calendar-day-column.closed-day .calendar-time-slot {
            cursor: not-allowed;
        }
        .calendar-time-slots {
            position: relative;
        }
        .calendar-time-slot {
            height: 60px;
            border-bottom: 1px solid #f1f5f9;
            position: relative;
            cursor: pointer;
            transition: background 0.2s;
        }
        .calendar-time-slot:hover {
            background: #f8fafc;
        }
        .calendar-time-slot.current-time {
            background: #fef3c7;
        }
        .calendar-time-slot.closed-slot {
            background: #f8fafc;
            cursor: not-allowed;
            opacity: 0.4;
        }
        .calendar-time-slot.available-slot:hover {
            background: #f0f9ff;
            border-left: 3px solid #3b82f6;
        }
        .calendar-opening-line {
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background: #22c55e;
            z-index: 15;
            pointer-events: none;
        }
        .opening-line-label {
            position: absolute;
            left: 4px;
            top: -12px;
            background: #22c55e;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: bold;
            white-space: nowrap;
        }
        .calendar-event-block {
            position: absolute;
            left: 4px;
            right: 4px;
            padding: 6px 8px;
            border-radius: 6px;
            font-size: 11px;
            color: white;
            cursor: pointer;
            overflow: hidden;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
            transition: all 0.2s;
            border-left: 3px solid rgba(255, 255, 255, 0.5);
        }
        .calendar-event-block:hover {
            transform: translateX(2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.25);
            z-index: 20;
            border-left-width: 4px;
        }
        .event-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .event-time-badge {
            font-size: 9px;
            font-weight: 800;
            opacity: 0.95;
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 4px;
            border-radius: 3px;
            display: inline-block;
            width: fit-content;
        }
        .event-title-text {
            font-size: 11px;
            font-weight: 700;
            line-height: 1.3;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        /* Date picker avec style premium */
        .date-card-selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            border-color: #667eea !important;
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4) !important;
        }

        /* Statut actif avec animation √©l√©gante */
        .status-label-active {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.15) 0%, rgba(34, 197, 94, 0.1) 100%) !important;
            border-color: rgba(34, 197, 94, 0.4) !important;
        }

       

        /* Boutons de navigation avec style moderne */
        button.text-gray-500:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%) !important;
            color: #667eea !important;
        }

        /* Statistiques avec fond d√©grad√© subtil */
        .bg-white.border {
            background: rgba(255, 255, 255, 0.95) !important;
        }
    </style>
</head>
<body>

<div id="app" :class="currentTheme.classes" class="h-screen flex flex-col overflow-hidden text-slate-800 transition-colors duration-500">
   <div class="pointer-events-none fixed inset-0 z-[1] overflow-hidden">
        
        <div v-if="currentTheme.name === 'christmas'">
            <div v-for="n in 50" :key="n" class="snowflake pointer-events-none" :style="{ left: Math.random()*100 + 'vw', animationDuration: (Math.random()*5+5)+'s', animationDelay: '-'+Math.random()*5+'s', fontSize: (Math.random()*10+10)+'px' }">‚ùÑ</div>
            <div class="absolute bottom-[-20px] right-[-10px] opacity-20 text-9xl transform rotate-12 pointer-events-none">üéÑ</div>
        </div>

        <div v-if="currentTheme.name === 'halloween'">
            
            <div class="absolute top-[-20px] right-[-20px] opacity-20 text-[150px] pointer-events-none text-slate-500 rotate-12">üï∏Ô∏è</div>
            
            <div v-for="n in 6" :key="n" class="absolute text-3xl opacity-30 pointer-events-none" 
                 :style="{ 
                     left: Math.random()*100 + 'vw', 
                     top: Math.random()*60 + 'vh', 
                     animation: 'float-ghost ' + (Math.random()*5+5) + 's ease-in-out infinite',
                     fontSize: (Math.random()*20+20)+'px'
                 }">
                 ü¶á
            </div>
            <div v-if="currentTheme.name === 'bastille'">
            <div v-for="n in 5" :key="n" class="absolute w-2 h-2 rounded-full animate-ping pointer-events-none" 
                 :style="{ 
                    left: Math.random()*100 + 'vw', 
                    top: Math.random()*50 + 'vh', 
                    backgroundColor: ['#1e3a8a', '#dc2626', '#ffffff'][Math.floor(Math.random()*3)],
                    animationDuration: '1s', 
                    animationDelay: Math.random()+'s' 
                 }"></div>
             <div class="absolute bottom-4 right-4 opacity-20 text-8xl pointer-events-none">üá´üá∑</div>
        </div>
        

            <div class="absolute bottom-0 left-0 w-full h-32 bg-gradient-to-t from-purple-900/20 to-transparent pointer-events-none"></div>
        </div>

       <div v-if="currentTheme.name === 'love'">
            <div class="absolute bottom-[-30px] right-[-20px] opacity-10 text-[180px] pointer-events-none grayscale-[0.2] rotate-[-15deg]">üåπ</div>
        </div>

        <div v-if="currentTheme.name === 'summer'">
            <div class="sun-ray pointer-events-none"></div> <div class="absolute top-[-50px] right-[-50px] text-9xl text-yellow-400 opacity-20 animate-spin-slow pointer-events-none" style="animation-duration: 20s;">‚òÄÔ∏è</div>
            <div class="absolute bottom-10 left-10 text-6xl opacity-10 pointer-events-none">üç¶</div>
        </div>

        <div v-if="currentTheme.name === 'newyear'">
            <div v-for="n in 40" :key="n" class="confetti pointer-events-none" :style="{ left: Math.random()*100 + 'vw', top: '-10px', backgroundColor: ['#FFD700', '#C0C0C0', '#000'][Math.floor(Math.random()*3)], animationDuration: (Math.random()*3+2)+'s' }"></div>
        </div>

    </div>

    <!-- MODAL D√âCONNEXION FORC√âE -->
    <div v-if="forcedLogoutModal.open" class="fixed inset-0 bg-slate-900/90 z-[1000] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-md text-center pop-in border-4 border-red-100 relative">
            <div class="text-6xl mb-6" v-if="forcedLogoutModal.type === 'deleted'">üóëÔ∏è</div>
            <div class="text-6xl mb-6" v-if="forcedLogoutModal.type === 'blocked'">üö´</div>
            <h3 class="font-bold text-2xl mb-4 text-slate-800">{{ forcedLogoutModal.type === 'deleted' ? 'Votre profil a √©t√© supprim√©' : 'Votre compte a √©t√© bloqu√©' }}</h3>
            <p class="text-slate-600 text-lg mb-6 leading-relaxed">
                {{ forcedLogoutModal.type === 'deleted' ? 'Votre profil a √©t√© supprim√© par l\'administrateur. Vous allez √™tre redirig√© vers la page de connexion.' : 'Votre compte a √©t√© bloqu√©. Contactez l\'administrateur pour plus d\'informations.' }}
            </p>
            <button @click="forcedLogoutModal.open = false; logout()" class="w-full bg-gradient-to-r from-red-600 to-red-700 text-white py-4 rounded-xl font-bold text-lg hover:from-red-700 hover:to-red-800 transition-all shadow-lg transform hover:scale-105">
                Compris <i class="fa-solid fa-check ml-2"></i>
            </button>
        </div>
    </div>

    <!-- MESSAGE BLOCAGE SUR PAGE DE CONNEXION -->
    <div v-if="!user.logged && !isClientMode && blockedLoginMessage.show" class="fixed inset-0 bg-slate-900/90 z-[300] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-md text-center pop-in border-4 border-red-100 relative z-[301]">
            <div class="text-6xl mb-6">üö´</div>
            <h3 class="font-bold text-2xl mb-4 text-slate-800">Compte bloqu√©</h3>
            <p class="text-slate-600 text-lg mb-6 leading-relaxed">
                Votre compte a √©t√© bloqu√©. Contactez l'administrateur pour plus d'informations.
            </p>
            <button @click="blockedLoginMessage.show = false" class="w-full bg-gradient-to-r from-red-600 to-red-700 text-white py-4 rounded-xl font-bold text-lg hover:from-red-700 hover:to-red-800 transition-all shadow-lg transform hover:scale-105">
                Compris <i class="fa-solid fa-check ml-2"></i>
            </button>
        </div>
    </div>

    <!-- MESSAGE ERREUR CONNEXION (MAUVAIS MOT DE PASSE) -->
    <div v-if="!user.logged && !isClientMode && loginErrorModal.show" class="fixed inset-0 bg-slate-900/90 z-[300] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-md text-center pop-in border-4 border-orange-100 relative z-[301]">
            <div class="text-6xl mb-6">‚ö†Ô∏è</div>
            <h3 class="font-bold text-2xl mb-4 text-slate-800">Erreur de connexion</h3>
            <p class="text-slate-600 text-lg mb-6 leading-relaxed">
                {{ loginErrorModal.message }}
            </p>
            <button @click="loginErrorModal.show = false" class="w-full bg-gradient-to-r from-orange-600 to-orange-700 text-white py-4 rounded-xl font-bold text-lg hover:from-orange-700 hover:to-orange-800 transition-all shadow-lg transform hover:scale-105">
                R√©essayer <i class="fa-solid fa-redo ml-2"></i>
            </button>
        </div>
    </div>

    <div v-if="!user.logged && !isClientMode" class="fixed inset-0 bg-slate-900 z-[200] flex items-center justify-center p-4">
        
        <div v-if="!loginAdminSelection" class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center fade-in relative overflow-hidden">
            
            <div class="w-16 h-16 bg-blue-600 rounded-lg flex items-center justify-center text-white mx-auto mb-6 shadow-lg shadow-blue-500/30 relative z-10 overflow-hidden">
                <img v-if="globalSettings.appLogoUrl" :src="globalSettings.appLogoUrl" class="w-full h-full object-cover">
                <i v-else class="fa-solid fa-address-book text-3xl"></i>
            </div>
            
            <h1 class="text-2xl font-bold mb-2 relative z-10">ARIA</h1>
            <p class="text-sm text-slate-500 mb-6 relative z-10">Connexion</p>
            
            <div class="space-y-4 relative z-10">
                <input type="text" v-model="loginEmail" @keyup.enter="login" placeholder="Identifiant / Email" autocomplete="username" class="w-full p-4 border-2 border-gray-200 rounded-xl text-center text-lg mb-2 outline-none focus:border-blue-600 transition">
                <input type="password" v-model="loginPass" @keyup.enter="login" placeholder="Mot de passe" autocomplete="current-password" class="w-full p-4 border-2 border-gray-200 rounded-xl text-center text-lg tracking-widest outline-none focus:border-blue-600 transition">
            </div>

            <button @click="login" class="relative z-10 w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition transform active:scale-95 mt-6 mb-2">Se connecter</button>
            <div class="mt-4 text-xs text-gray-400 relative z-10">Acc√®s s√©curis√©</div>
        </div>

        <div v-else class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center pop-in">
            <h2 class="text-xl font-bold mb-6 text-slate-700">Qui se connecte ?</h2>
            <div class="grid grid-cols-2 gap-3 mb-4">
                <button v-for="name in adminNamesList" :key="name" @click="finalizeAdminLogin(name)" class="p-4 bg-slate-100 hover:bg-blue-100 border-2 border-transparent hover:border-blue-500 rounded-xl font-bold text-slate-700 hover:text-blue-700 transition flex flex-col items-center gap-2">
                    <i class="fa-solid fa-user-tie text-2xl"></i>
                    {{ name }}
                </button>
            </div>
            <button @click="loginAdminSelection=false" class="text-gray-400 hover:text-gray-600 underline text-sm">Retour</button>
        </div>
    </div>

    <div v-else class="flex flex-1 h-full relative">
        <div v-if="isClientMode && clientRdv" class="fixed inset-0 z-[100] flex flex-col items-center justify-center p-4 overflow-y-auto">
        
        <div class="bg-white/90 backdrop-blur-md w-full max-w-md rounded-3xl shadow-2xl overflow-hidden border border-white/50 relative animate-fadeIn">
            
            <div class="h-32 bg-gradient-to-br from-blue-600 to-purple-600 relative p-6 flex flex-col justify-between">
                <div class="flex justify-between items-start">
                    <span class="bg-white/20 text-white px-3 py-1 rounded-full text-xs font-bold backdrop-blur-sm">
                        C&N Solutions
                    </span>
                    <span v-if="clientRdv.statut === 'annule'" class="bg-red-500 text-white px-3 py-1 rounded-full text-xs font-bold shadow-lg">ANNUL√â</span>
                    <span v-else class="bg-green-500 text-white px-3 py-1 rounded-full text-xs font-bold shadow-lg flex items-center gap-1"><i class="fa-solid fa-check"></i> CONFIRM√â</span>
                </div>
                <h1 class="text-white text-2xl font-black mt-2">Bonjour {{ clientRdv.civilite }} {{ clientRdv.nom }}</h1>
            </div>

            <div class="p-6 -mt-6">
                <div class="bg-white rounded-2xl shadow-lg p-6 border border-slate-100">
                    <div class="flex items-center gap-4 mb-6">
                        <div class="w-16 h-16 bg-blue-50 text-blue-600 rounded-2xl flex flex-col items-center justify-center font-bold border-2 border-blue-100">
                            <span class="text-xl">{{ new Date(clientRdv.date).getDate() }}</span>
                            <span class="text-[10px] uppercase">{{ new Date(clientRdv.date).toLocaleDateString('fr-FR', {month:'short'}) }}</span>
                        </div>
                        <div>
                            <div class="text-slate-400 text-xs font-bold uppercase tracking-wider">Votre Rendez-vous</div>
                            <div class="text-2xl font-black text-slate-800">{{ clientRdv.heure }}</div>
                            <div class="text-sm text-slate-500 font-medium">{{ getBaseModele(clientRdv.modele) || clientRdv.modele }}</div>
                        </div>
                    </div>

                    <div v-if="clientRdv.statut !== 'annule' && !clientRdv.demandeClient" class="space-y-3">
                        <p class="text-center text-sm text-slate-400 mb-4">Un emp√™chement ?</p>
                        
                        <button @click="clientRequest.type='report'; clientRequest.showModal=true" class="w-full py-3.5 rounded-xl font-bold bg-blue-50 text-blue-600 hover:bg-blue-100 transition flex items-center justify-center gap-2">
                            <i class="fa-solid fa-calendar-days"></i> Demander un report
                        </button>
                        
                        <button @click="clientRequest.type='annulation'; clientRequest.showModal=true" class="w-full py-3.5 rounded-xl font-bold text-red-500 hover:bg-red-50 border-2 border-transparent hover:border-red-100 transition flex items-center justify-center gap-2">
                            <i class="fa-solid fa-ban"></i> Annuler le rendez-vous
                        </button>
                    </div>

                    <div v-if="clientRdv.demandeClient" class="bg-orange-50 border border-orange-200 rounded-xl p-4 text-center">
                        <div class="w-12 h-12 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center mx-auto mb-2">
                            <i class="fa-solid fa-hourglass-half"></i>
                        </div>
                        <h3 class="font-bold text-orange-800">Demande envoy√©e</h3>
                        <p class="text-xs text-orange-700 mt-1">
                            Votre demande de {{ clientRdv.demandeClient.type }} est en cours de traitement par notre √©quipe.
                        </p>
                    </div>
                </div>

                <div class="text-center mt-6">
                    <a :href="'tel:+33600000000'" class="inline-flex items-center gap-2 text-slate-400 hover:text-blue-600 transition font-bold text-sm">
                        <i class="fa-solid fa-phone"></i> Nous contacter
                    </a>
                </div>
            </div>
        </div>

        <div v-if="clientRequest.showModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[110] flex items-center justify-center p-4 animate-fadeIn">
            <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl">
                <h3 class="font-bold text-xl mb-4 text-slate-800">
                    {{ clientRequest.type === 'report' ? 'Reporter le RDV' : 'Annuler le RDV' }}
                </h3>
                
                <p class="text-sm text-slate-500 mb-4">Merci de nous indiquer la raison afin que nous puissions traiter votre demande rapidement.</p>
                
                <textarea v-model="clientRequest.motif" placeholder="Votre message (ex: Je suis malade, v√©hicule en panne...)" class="w-full p-4 border-2 border-slate-200 rounded-xl outline-none focus:border-blue-500 min-h-[100px] mb-4 bg-slate-50"></textarea>

                <div class="flex gap-3">
                    <button @click="clientRequest.showModal=false" class="flex-1 py-3 rounded-xl font-bold bg-slate-100 text-slate-500">Retour</button>
                    <button @click="submitClientRequest" class="flex-1 py-3 rounded-xl font-bold bg-blue-600 text-white shadow-lg">Envoyer</button>
                </div>
            </div>
        </div>

    </div>
        
        <div v-if="mobileMenuOpen" @click="mobileMenuOpen=false" class="fixed inset-0 bg-black/50 z-30 md:hidden"></div>

        <aside :class="mobileMenuOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0'" class="fixed md:relative w-64 bg-white shadow-xl flex flex-col z-40 h-full transition-transform duration-300 ease-in-out">
            <div class="p-6 border-b flex items-center gap-3">
            <div class="sidebar-logo w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold flex-shrink-0 transition-all duration-500 overflow-hidden relative">
    <img v-if="globalSettings.appLogoUrl" :src="globalSettings.appLogoUrl" class="w-full h-full object-cover">
    
    <div v-else class="flex items-center justify-center w-full h-full">
        <i v-if="currentTheme.name === 'modern'" class="fa-solid fa-sparkles text-lg"></i>
        <i v-else-if="currentTheme.name === 'christmas'" class="fa-solid fa-tree text-lg"></i>
        <i v-else-if="currentTheme.name === 'love'" class="fa-solid fa-heart text-xl text-white"></i>
        <i v-else-if="currentTheme.name === 'halloween'" class="fa-solid fa-hat-wizard text-lg"></i>
        <i v-else-if="currentTheme.name === 'bastille'" class="fa-solid fa-flag-usa text-lg"></i>
        <i v-else-if="currentTheme.name === 'newyear'" class="fa-solid fa-champagne-glasses text-lg"></i>
        <i v-else-if="currentTheme.name === 'summer'" class="fa-solid fa-sun text-lg"></i>
        <i v-else class="fa-solid fa-calendar-check"></i>
    </div>
</div>
                <div class="min-w-0">
                    <h1 class="font-bold text-lg leading-tight truncate">ARIA</h1>
                    <span class="text-[10px] bg-slate-100 px-2 py-0.5 rounded text-slate-500 uppercase font-bold truncate block">{{ user.name }}</span>
                </div>
                <button @click="mobileMenuOpen=false" class="ml-auto md:hidden text-gray-400"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>

            <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                <button @click="changeView('dashboard'); mobileMenuOpen=false" :class="view==='dashboard'?'bg-blue-50 text-blue-600 font-bold border-blue-200':'text-gray-500 hover:bg-gray-50 border-transparent'" class="w-full text-left p-3 rounded-xl flex items-center gap-3 border transition"><i class="fa-solid fa-chart-line w-5 text-center"></i> Tableau de bord</button>
                <button @click="changeView('list'); mobileMenuOpen=false" :class="view==='list'?'bg-blue-50 text-blue-600 font-bold border-blue-200':'text-gray-500 hover:bg-gray-50 border-transparent'" class="w-full text-left p-3 rounded-xl flex items-center gap-3 border transition"><i class="fa-solid fa-address-book w-5 text-center"></i> Tous les RDV</button>
                <button @click="changeView('portefeuille'); mobileMenuOpen=false" :class="view==='portefeuille'?'bg-blue-50 text-blue-600 font-bold border-blue-200':'text-gray-500 hover:bg-gray-50 border-transparent'" class="w-full text-left p-3 rounded-xl flex items-center gap-3 border transition"><i class="fa-solid fa-wallet w-5 text-center"></i> Portefeuille</button>
                <button v-if="user.role !== 'admin'" @click="changeView('a_traiter'); mobileMenuOpen=false" :class="view==='a_traiter'?'bg-orange-50 text-orange-600 font-bold border-orange-200':'text-gray-500 hover:bg-gray-50 border-transparent'" class="w-full text-left p-3 rounded-xl flex items-center gap-3 border transition relative"><i class="fa-solid fa-exclamation-triangle w-5 text-center"></i> √Ä traiter <span v-if="prospecteurUrgentCount > 0" class="ml-auto bg-red-600 text-white text-xs px-2 py-1 rounded-full font-bold">{{ prospecteurUrgentCount }}</span></button>
                <button v-if="user.role==='admin'" @click="changeView('bilan'); mobileMenuOpen=false" :class="view==='bilan'?'bg-blue-50 text-blue-600 font-bold border-blue-200':'text-gray-500 hover:bg-gray-50 border-transparent'" class="w-full text-left p-3 rounded-xl flex items-center gap-3 border transition relative"><i class="fa-solid fa-chart-pie w-5 text-center"></i> Bilan <span v-if="urgentBilanCount > 0" class="ml-auto bg-red-600 text-white text-xs px-2 py-1 rounded-full font-bold">{{ urgentBilanCount }}</span></button>
                <button @click="changeView('rappels'); mobileMenuOpen=false" :class="{'border-red-300 bg-red-50 text-red-600': rappelCount > 0}" class="w-full text-left p-3 rounded-xl flex items-center gap-3 border border-transparent hover:bg-gray-50 transition mt-4"><i class="fa-solid fa-bell w-5 text-center"></i> Rappels <span v-if="rappelCount>0" class="ml-auto bg-red-600 text-white text-xs px-2 py-1 rounded-full font-bold">{{ rappelCount }}</span></button>
                <button v-if="user.role==='admin'" @click="changeView('connexions'); mobileMenuOpen=false" :class="view==='connexions'?'bg-blue-50 text-blue-600 font-bold border-blue-200':'text-gray-500 hover:bg-gray-50 border-transparent'" class="w-full text-left p-3 rounded-xl flex items-center gap-3 border transition mt-4"><i class="fa-solid fa-users w-5 text-center"></i> Connexions <span v-if="connectedUsersCount > 0" class="ml-auto bg-green-600 text-white text-xs px-2 py-1 rounded-full font-bold">{{ connectedUsersCount }}</span></button>
                <button v-if="pendingStatusCount > 0" @click="changeView('pending_status'); mobileMenuOpen=false" class="w-full text-left p-3 rounded-2xl flex items-center gap-3 bg-purple-100 border border-purple-300 text-purple-700 mt-2 font-bold animate-pulse"><i class="fa-solid fa-clipboard-question w-5 text-center"></i> Statuts √† d√©finir <span class="ml-auto bg-purple-600 text-white text-xs px-2 py-1 rounded-full">{{ pendingStatusCount }}</span></button>
                <button v-if="confirmCount > 0" @click="changeView('confirmations'); mobileMenuOpen=false" class="w-full text-left p-3 rounded-2xl flex items-center gap-3 bg-orange-100 border border-orange-300 text-orange-700 mt-2 font-bold animate-pulse"><i class="fa-solid fa-circle-exclamation w-5 text-center"></i> √Ä Confirmer <span class="ml-auto bg-orange-600 text-white text-xs px-2 py-1 rounded-full">{{ confirmCount }}</span></button>
            </nav>

            <div class="p-4 border-t space-y-2">
                <button @click="changeView('trash'); mobileMenuOpen=false" :class="view==='trash'?'bg-gray-100 text-gray-800 font-bold':'text-gray-400 hover:text-gray-600 hover:bg-gray-50'" class="w-full text-left p-3 rounded-xl flex items-center gap-3 transition"><i class="fa-solid fa-trash-can w-5 text-center"></i> Corbeille <span v-if="trashCount > 0" class="ml-auto bg-gray-200 text-gray-600 text-xs px-2 py-1 rounded-full font-bold">{{ trashCount }}</span></button>
            </div>

            <div class="p-4 border-t space-y-2">
                <button v-if="user.role==='admin'" @click="openSettings(); mobileMenuOpen=false" class="w-full text-left p-3 rounded-xl flex items-center gap-3 text-slate-600 hover:bg-slate-100 transition font-bold"><i class="fa-solid fa-gear w-5 text-center"></i> R√©glages</button>
                <button @click="logout" class="w-full text-left p-3 rounded-xl flex items-center gap-3 text-red-400 hover:text-red-600 hover:bg-red-50 transition font-bold"><i class="fa-solid fa-power-off w-5 text-center"></i> D√©connexion</button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col bg-[#f8fafc] relative overflow-hidden h-full w-full fixed inset-0">
          <header class="p-4 md:p-6 z-10 flex items-center gap-3 relative">
            
            <button @click="mobileMenuOpen = !mobileMenuOpen" class="md:hidden w-12 h-12 bg-white border border-slate-200 rounded-2xl text-slate-700 shadow-sm flex items-center justify-center hover:bg-slate-50 transition active:scale-95">
                <i class="fa-solid fa-bars text-xl"></i>
            </button>


            <button @click="startWizard" class="bg-slate-900 hover:bg-slate-800 text-white px-6 py-3.5 rounded-2xl font-bold shadow-xl shadow-slate-300/50 flex items-center gap-3 transform active:scale-95 transition text-sm md:text-base">
                <div class="bg-white/20 w-6 h-6 rounded-full flex items-center justify-center">
                    <i class="fa-solid fa-plus text-xs"></i>
                </div>
                <span>Nouveau RDV</span>
            </button>

        </header>

            <div class="flex-1 overflow-y-auto p-4 md:p-6 pb-20 md:pb-6">
                <div v-if="view==='dashboard'" class="space-y-6 fade-in">
                    <div class="flex flex-col md:flex-row gap-6 mb-6 items-stretch">
                        <div class="flex-1 flex flex-col md:flex-row md:items-center gap-3">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl flex items-center justify-center shadow-lg shadow-purple-300">
                                    <i class="fa-solid fa-chart-line text-white text-xl"></i>
                                </div>
                                <h2 class="text-2xl md:text-3xl font-bold text-slate-800 uppercase tracking-tight">{{ currentFullDateLabel }}</h2>
                            </div>
                            
                            <!-- Indicateur de statut Google Calendar Admin -->
                           <button v-if="user.role === 'admin'" 
                                    @click="googleCalendarConnected && googleCalendarTokenValid ? googleCalendarInfoModal.open = true : (googleCalendarConnected && !googleCalendarTokenValid ? connectGoogleCalendar() : connectGoogleCalendar())"
                                    :class="[
                                        googleCalendarConnected && googleCalendarTokenValid ? 'bg-green-50 border-green-300 text-green-700 cursor-pointer hover:bg-green-100' : 
                                        googleCalendarConnected && !googleCalendarTokenValid ? 'bg-orange-50 border-orange-300 text-orange-700 hover:bg-orange-100 cursor-pointer' : 
                                        'bg-red-50 border-red-300 text-red-700 cursor-pointer hover:bg-red-100'
                                    ]"
                                    class="flex items-center gap-2 px-4 py-2 rounded-xl border-2 transition-all">
                                <i :class="[
                                    googleCalendarConnected && googleCalendarTokenValid ? 'fa-brands fa-google text-green-600' : 
                                    googleCalendarConnected && !googleCalendarTokenValid ? 'fa-solid fa-exclamation-triangle text-orange-600' : 
                                    'fa-solid fa-exclamation-triangle text-red-600'
                                ]" class="text-lg"></i>
                                <span class="text-xs font-bold">
                                    <span v-if="googleCalendarConnected && googleCalendarTokenValid">
                                        Google Calendar connect√©
                                        <span v-if="tokenTimeRemaining" class="ml-2 text-[10px] opacity-75">
                                            ({{ tokenTimeRemaining.minutes }}min {{ tokenTimeRemaining.seconds }}s)
                                        </span>
                                    </span>
                                    <span v-else-if="googleCalendarConnected && !googleCalendarTokenValid">Se reconnecter</span>
                                    <span v-else>Cliquez ici pour connecter Google Calendar</span>
                                </span>
                            </button>

                            <button v-if="user.role === 'admin' && googleCalendarConnected"
                                    @click="forceGlobalRefresh" 
                                    class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-4 py-2 rounded-xl border-2 border-blue-600 shadow-lg transition-all hover:scale-105 font-bold flex items-center gap-2">
                                <i class="fa-solid fa-rotate-right text-base"></i>
                                <span class="text-xs font-bold hidden md:inline">Forcer Update Global</span>
                            </button>

                            <!-- Indicateur de statut Google Calendar Prospecteur - M√äME QUE ADMIN -->
                            <button v-if="user.role !== 'admin'"
                                    @click="handleProspecteurGoogleCalendar"
                                    :class="[
                                        // Utiliser isGoogleCalendarConnected pour d√©tecter si vraiment connect√©
                                        isGoogleCalendarConnected 
                                            ? 'bg-green-50 border-green-300 text-green-700 cursor-pointer hover:bg-green-100' : 
                                        // Token expir√©
                                        (prospecteurGoogleCalendarConnected && prospecteurGoogleCalendarToken && prospecteurGoogleCalendarTokenExpired)
                                            ? 'bg-orange-50 border-orange-300 text-orange-700 hover:bg-orange-100 cursor-pointer' : 
                                        // Pas connect√© du tout
                                        'bg-red-50 border-red-300 text-red-700 cursor-pointer hover:bg-red-100'
                                    ]"
                                    class="flex items-center gap-2 px-4 py-2 rounded-xl border-2 transition-all">
                                <i :class="[
                                    // Utiliser isGoogleCalendarConnected
                                    isGoogleCalendarConnected
                                        ? 'fa-brands fa-google text-green-600' : 
                                    // Token expir√©
                                    (prospecteurGoogleCalendarConnected && prospecteurGoogleCalendarToken && prospecteurGoogleCalendarTokenExpired)
                                        ? 'fa-solid fa-exclamation-triangle text-orange-600' : 
                                    // Pas connect√©
                                    'fa-solid fa-exclamation-triangle text-red-600'
                                ]" class="text-lg"></i>
                                <span class="text-xs font-bold">
                                    <span v-if="isGoogleCalendarConnected">
                                        Google Calendar connect√©
                                        <span v-if="prospecteurDisplayTimeRemaining" class="ml-2 text-[10px] opacity-75">
                                            ({{ prospecteurDisplayTimeRemaining.minutes }}min {{ prospecteurDisplayTimeRemaining.seconds }}s)
                                        </span>
                                    </span>
                                    <span v-else-if="prospecteurGoogleCalendarConnected && prospecteurGoogleCalendarToken && prospecteurGoogleCalendarTokenExpired">Se reconnecter</span>
                                    <span v-else>Cliquez ici pour connecter Google Calendar</span>
                                </span>
                            </button>

                            <button v-if="user.role !== 'admin' && isGoogleCalendarConnected"
                                    @click="reloadProspecteurToken" 
                                    class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-4 py-2 rounded-xl border-2 border-blue-600 shadow-lg transition-all hover:scale-105 font-bold flex items-center gap-2">
                                <i class="fa-solid fa-rotate-right text-base"></i>
                                <span class="text-xs font-bold hidden md:inline">Recharger le token</span>
                            </button>
                           
                        </div>
                        <div class="flex flex-col md:flex-row gap-4">
                            <div @click="openStatsModal" class="cursor-pointer hover:scale-[1.02] transition-all duration-200 bg-gradient-to-br from-white via-purple-50/30 to-white rounded-2xl shadow-lg shadow-purple-200 border-2 border-purple-300 p-5 flex items-center gap-4 min-w-[300px] relative overflow-hidden hover:shadow-xl hover:shadow-purple-300 hover:border-purple-500" :class="conversionRateColor">
                                <div class="absolute inset-0 bg-white opacity-80 z-0"></div>
                                <div class="z-10 text-5xl emoji-bounce filter drop-shadow-lg">{{ conversionEmoji }}</div>
                                <div class="z-10 flex-1">
                                    <p class="text-xs font-bold uppercase tracking-widest text-purple-600 mb-1">Taux de conversion</p>
                                    <div class="flex items-baseline gap-2 mb-2">
                                        <span class="text-4xl font-black text-slate-800">{{ conversionRate }}%</span>
                                        <span class="text-xs font-medium text-slate-500">Honor√©s / Total</span>
                                    </div>
                                    <div class="w-full bg-slate-200 h-2 rounded-full overflow-hidden shadow-inner">
                                        <div class="h-full bg-gradient-to-r from-purple-500 to-purple-600 transition-all duration-1000 rounded-full shadow-sm" :style="{width: conversionRate + '%'}"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- CARTE CA TOTAL - MINIMALISTE MOBILE / COMPL√àTE DESKTOP -->
                    <div class="relative overflow-hidden bg-gradient-to-br from-purple-400 via-purple-500 to-purple-600 rounded-2xl md:rounded-3xl shadow-xl md:shadow-2xl shadow-purple-300/50 p-4 md:p-8 mb-6 border-2 border-purple-300/50">
                        <!-- VERSION MOBILE MINIMALISTE -->
                        <div class="md:hidden relative z-10">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center gap-2">
                                    <i class="fa-solid fa-euro-sign text-white text-lg"></i>
                                    <span class="text-white/90 text-xs font-bold uppercase tracking-wide">CA Total</span>
                                </div>
                                <span class="text-xs text-white/70">Sur RDV honor√©s</span>
                            </div>
                            <div class="text-3xl font-black text-white drop-shadow-lg mb-2">{{ formatPrice(stats.ca || 0) }}</div>
                            <div class="flex items-center gap-3 text-xs text-white/80">
                                <span><i class="fa-solid fa-calendar-check mr-1"></i>{{ stats.honored || 0 }} honor√©s</span>
                                <span>‚Ä¢</span>
                                <span>{{ (stats.honored && stats.honored > 0) ? formatPrice((stats.ca || 0) / stats.honored) : '0‚Ç¨' }} moyen</span>
                            </div>
                        </div>
                        <!-- VERSION DESKTOP COMPL√àTE -->
                        <div class="hidden md:flex relative z-10 flex-row items-center justify-between gap-6">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="w-16 h-16 bg-white/20 backdrop-blur-sm rounded-2xl flex items-center justify-center shadow-lg border border-white/30">
                                        <i class="fa-solid fa-euro-sign text-white text-3xl"></i>
                                    </div>
                                    <div>
                                        <h3 class="text-white/90 text-sm font-bold uppercase tracking-widest mb-1">Chiffre d'Affaires Total</h3>
                                        <p class="text-white/70 text-xs">Sur les RDV honor√©s uniquement</p>
                                    </div>
                                </div>
                                <div class="flex items-baseline gap-3">
                                    <span class="text-6xl md:text-7xl font-black text-white drop-shadow-lg">{{ formatPrice(stats.ca || 0) }}</span>
                                    <div class="px-3 py-1 bg-white/20 backdrop-blur-sm rounded-full border border-white/30">
                                        <span class="text-xs font-bold text-white">CA Total</span>
                                    </div>
                                </div>
                                <div class="mt-4 flex items-center gap-4">
                                    <div class="px-4 py-2 bg-white/20 backdrop-blur-sm rounded-xl border border-white/30">
                                        <p class="text-[10px] text-white/80 font-bold uppercase mb-1">RDV Honor√©s</p>
                                        <p class="text-2xl font-black text-white">{{ stats.honored || 0 }}</p>
                                    </div>
                                    <div class="px-4 py-2 bg-white/20 backdrop-blur-sm rounded-xl border border-white/30">
                                        <p class="text-[10px] text-white/80 font-bold uppercase mb-1">CA Moyen</p>
                                        <p class="text-2xl font-black text-white">{{ (stats.honored && stats.honored > 0) ? formatPrice((stats.ca || 0) / stats.honored) : '0‚Ç¨' }}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center justify-center">
                                <div class="w-32 h-32 bg-white/10 backdrop-blur-sm rounded-full border-4 border-white/30 flex items-center justify-center shadow-2xl">
                                    <div class="text-center">
                                        <i class="fa-solid fa-chart-line text-white text-5xl mb-2"></i>
                                        <p class="text-white/80 text-xs font-bold">Performance</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-white/30 to-transparent"></div>
                    </div>
                    
                   <!-- 4 COLONNES MODERNIS√âES -->
                   <div class="grid grid-cols-1 md:grid-cols-4 gap-4 md:gap-6">
                        <div @click="showUpcoming" class="relative overflow-hidden bg-gradient-to-br from-purple-400 via-purple-500 to-purple-600 rounded-2xl md:rounded-3xl shadow-xl shadow-purple-300/50 border-2 border-purple-300/50 hover:shadow-2xl hover:scale-[1.02] cursor-pointer transition-all duration-200 group p-5 md:p-6">
                            <div class="relative z-10 flex justify-between items-start">
                                <div class="flex-1">
                                    <p class="text-white/90 text-xs font-bold uppercase tracking-wider mb-2">√Ä venir</p>
                                    <p class="text-4xl md:text-5xl font-black text-white mb-1 drop-shadow-lg">{{ stats.upcoming }}</p>
                                    <p class="text-[10px] text-white/80 font-medium">RDV programm√©s</p>
                                </div>
                                <div class="w-14 h-14 md:w-16 md:h-16 bg-white/20 backdrop-blur-sm rounded-xl md:rounded-2xl flex items-center justify-center text-white text-xl md:text-2xl shadow-lg border-2 border-white/30 group-hover:scale-110 transition-transform">
                                    <i class="fa-solid fa-calendar-days"></i>
                                </div>
                            </div>
                            <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-white/30 to-transparent"></div>
                        </div>
                        <div @click="showHonored" class="relative overflow-hidden bg-gradient-to-br from-green-400 via-green-500 to-green-600 rounded-2xl md:rounded-3xl shadow-xl shadow-green-300/50 border-2 border-green-300/50 hover:shadow-2xl hover:scale-[1.02] cursor-pointer transition-all duration-200 group p-5 md:p-6">
                            <div class="relative z-10 flex justify-between items-start">
                                <div class="flex-1">
                                    <p class="text-white/90 text-xs font-bold uppercase tracking-wider mb-2">Honor√©s</p>
                                    <p class="text-4xl md:text-5xl font-black text-white mb-1 drop-shadow-lg">{{ stats.honored }}</p>
                                    <p class="text-[10px] text-white/80 font-medium">RDV honor√©s</p>
                                </div>
                                <div class="w-14 h-14 md:w-16 md:h-16 bg-white/20 backdrop-blur-sm rounded-xl md:rounded-2xl flex items-center justify-center text-white text-xl md:text-2xl shadow-lg border-2 border-white/30 group-hover:scale-110 transition-transform">
                                    <i class="fa-solid fa-check"></i>
                                </div>
                            </div>
                            <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-white/30 to-transparent"></div>
                        </div>
                        <div @click="showNoShow" class="relative overflow-hidden bg-gradient-to-br from-red-400 via-red-500 to-red-600 rounded-2xl md:rounded-3xl shadow-xl shadow-red-300/50 border-2 border-red-300/50 hover:shadow-2xl hover:scale-[1.02] cursor-pointer transition-all duration-200 group p-5 md:p-6">
                            <div class="relative z-10 flex justify-between items-start">
                                <div class="flex-1">
                                    <p class="text-white/90 text-xs font-bold uppercase tracking-wider mb-2">Pas Venus</p>
                                    <p class="text-4xl md:text-5xl font-black text-white mb-1 drop-shadow-lg">{{ stats.noshow }}</p>
                                    <p class="text-[10px] text-white/80 font-medium">Absents</p>
                                </div>
                                <div class="w-14 h-14 md:w-16 md:h-16 bg-white/20 backdrop-blur-sm rounded-xl md:rounded-2xl flex items-center justify-center text-white text-xl md:text-2xl shadow-lg border-2 border-white/30 group-hover:scale-110 transition-transform">
                                    <i class="fa-solid fa-user-xmark"></i>
                                </div>
                            </div>
                            <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-white/30 to-transparent"></div>
                        </div>
                        <div @click="showCancelled" class="relative overflow-hidden bg-gradient-to-br from-slate-400 via-slate-500 to-slate-600 rounded-2xl md:rounded-3xl shadow-xl shadow-slate-300/50 border-2 border-slate-300/50 hover:shadow-2xl hover:scale-[1.02] cursor-pointer transition-all duration-200 group p-5 md:p-6">
                            <div class="relative z-10 flex justify-between items-start">
                                <div class="flex-1">
                                    <p class="text-white/90 text-xs font-bold uppercase tracking-wider mb-2">Annul√©s</p>
                                    <p class="text-4xl md:text-5xl font-black text-white mb-1 drop-shadow-lg">{{ stats.cancelled }}</p>
                                    <p class="text-[10px] text-white/80 font-medium">RDV annul√©s</p>
                                </div>
                                <div class="w-14 h-14 md:w-16 md:h-16 bg-white/20 backdrop-blur-sm rounded-xl md:rounded-2xl flex items-center justify-center text-white text-xl md:text-2xl shadow-lg border-2 border-white/30 group-hover:scale-110 transition-transform">
                                    <i class="fa-solid fa-ban"></i>
                                </div>
                            </div>
                            <div class="absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-white/30 to-transparent"></div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-white via-purple-50/20 to-white rounded-3xl shadow-2xl border-2 border-purple-200 p-6 md:p-8 backdrop-blur-sm">
<div class="flex flex-col xl:flex-row justify-between items-start xl:items-center mb-6 gap-4">
                          <div class="flex items-center gap-3 flex-wrap">
                            <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl flex items-center justify-center shadow-lg shadow-purple-300">
                                <i class="fa-regular fa-clock text-white text-xl"></i>
                            </div>
                            <h2 class="text-2xl font-black text-slate-800">
                                <span>{{ isTimelineTomorrow ? 'Rendez-vous Demain' : 'Rendez-vous Aujourd\'hui' }}</span>
                            </h2>

                            <button @click="showTimelineTomorrow" 
                                    :class="isTimelineTomorrow ? 'bg-gradient-to-r from-purple-600 to-purple-700 text-white shadow-xl shadow-purple-300 border-purple-600' : 'bg-white text-slate-600 border-slate-300 hover:bg-gradient-to-r hover:from-purple-50 hover:to-purple-100 hover:border-purple-400'"
                                    class="px-5 py-2.5 rounded-xl text-xs font-bold transition-all duration-200 flex items-center gap-2 border-2 hover:scale-105 shadow-md">
                                <i class="fa-solid fa-calendar-day"></i>
                                <span>Demain</span>
                            </button>

                            <span class="text-xs md:text-sm font-black text-white bg-gradient-to-r from-purple-500 to-purple-600 px-4 py-2 rounded-full border-2 border-purple-400 flex items-center gap-2 shadow-lg">
                                <i class="fa-solid fa-calendar-day"></i>
                                {{ rdvTodayCount }} RDV
                            </span>
                        </div>
                            
                            <div class="flex flex-wrap gap-3 w-full xl:w-auto">
                                <select v-model="dashboardFilters.agencyId" @change="dashboardFilters.commercialId = ''" class="bg-white border-2 border-slate-300 text-slate-700 text-xs font-bold rounded-xl px-4 py-2.5 outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-200 shadow-md hover:border-purple-400 hover:shadow-lg transition-all">
                                    <option value="">Toutes les agences</option>
                                    <option v-for="ag in visibleAgencies" :key="ag.id" :value="ag.id">{{ ag.nom }}</option>
                                </select>

                                <select v-if="user.role === 'admin'" v-model="dashboardFilters.userId" class="bg-white border-2 border-slate-300 text-slate-700 text-xs font-bold rounded-xl px-4 py-2.5 outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-200 shadow-md hover:border-purple-400 hover:shadow-lg transition-all">
                                    <option value="">Toute l'√©quipe</option>
                                    <option v-for="u in allProspectors" :key="u" :value="u">{{ u }}</option>
                                </select>

                                <select v-if="dashboardFilters.agencyId && getAgencyCommerciaux(dashboardFilters.agencyId).length > 0" v-model="dashboardFilters.commercialId" class="bg-white border-2 border-slate-300 text-slate-700 text-xs font-bold rounded-xl px-4 py-2.5 outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-200 shadow-md hover:border-purple-400 hover:shadow-lg transition-all">
                                    <option value="">Tous les commerciaux</option>
                                    <option v-for="comm in getAgencyCommerciaux(dashboardFilters.agencyId)" :key="comm" :value="comm">{{ comm }}</option>
                                </select>

                                <select v-model="dashboardFilters.mois" class="bg-white border-2 border-slate-300 text-slate-700 text-xs font-bold rounded-xl px-4 py-2.5 outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-200 shadow-md hover:border-purple-400 hover:shadow-lg transition-all">
                                    <option value="">Mois</option>
                                    <option value="01">Janvier</option>
                                    <option value="02">F√©vrier</option>
                                    <option value="03">Mars</option>
                                    <option value="04">Avril</option>
                                    <option value="05">Mai</option>
                                    <option value="06">Juin</option>
                                    <option value="07">Juillet</option>
                                    <option value="08">Ao√ªt</option>
                                    <option value="09">Septembre</option>
                                    <option value="10">Octobre</option>
                                    <option value="11">Novembre</option>
                                    <option value="12">D√©cembre</option>
                                </select>

                                <select v-model="dashboardFilters.annee" class="bg-white border-2 border-slate-300 text-slate-700 text-xs font-bold rounded-xl px-4 py-2.5 outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-200 shadow-md hover:border-purple-400 hover:shadow-lg transition-all">
                                    <option value="">Ann√©e</option>
                                    <option v-for="y in dashboardYearOptions" :key="y" :value="y">{{ y }}</option>
                                </select>

                                <button @click="resetDashboardDateFilters" v-if="dashboardFilters.mois || dashboardFilters.annee" class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2.5 rounded-xl text-xs font-bold border border-slate-300 transition-all shadow-md hover:shadow-lg flex items-center gap-2" title="R√©initialiser au mois en cours">
                                    <i class="fa-solid fa-rotate-left"></i>
                                    Effacer
                                </button>

                              <button @click="dashboardFilters.onlyLive = !dashboardFilters.onlyLive" 
                                        :class="dashboardFilters.onlyLive ? 'bg-gradient-to-r from-green-500 to-green-600 text-white shadow-xl shadow-green-300 border-green-600' : (activeRdvCount > 0 ? 'bg-gradient-to-r from-green-50 to-green-100 text-green-700 border-green-300' : 'bg-white text-slate-500 border-slate-300')"
                                        class="px-5 py-2.5 rounded-xl text-xs font-bold transition-all duration-200 flex items-center gap-2 border-2 hover:scale-105 shadow-md">
                                    <span :class="activeRdvCount > 0 ? 'bg-green-500 animate-pulse shadow-lg w-3 h-3' : 'bg-slate-300 w-2.5 h-2.5'" class="rounded-full block"></span>
                                    {{ activeRdvCount }} En cours
                                </button>
                            </div>
                        </div>
                        <div class="space-y-3 relative">
                          <div v-for="rdv in sortedDaily" :key="rdv.id" @click="openRdvFiche(rdv)" 
     :class="[rdvMenuOpen === rdv.id ? 'z-[500] !transform-none !transition-none' : (isEnCours(rdv) ? 'live-animation border-green-400 shadow-green-200' : 'z-10 overflow-hidden')]" 
     class="relative flex flex-col md:flex-row md:items-center p-4 md:p-5 bg-gradient-to-br from-white via-purple-50/20 to-white rounded-xl md:rounded-2xl border-2 border-purple-200/80 hover:border-purple-400 hover:shadow-xl md:hover:shadow-2xl hover:scale-[1.01] cursor-pointer transition-all duration-200 group gap-3 md:gap-4 shadow-md md:shadow-lg backdrop-blur-sm">    
                                <div class="flex items-center w-full md:w-auto relative z-10">
                                    <div class="w-16 md:w-24 font-black text-lg md:text-xl text-white group-hover:text-purple-50 transition-all text-center bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl md:rounded-2xl py-2.5 md:py-3 mr-3 md:mr-4 shadow-lg md:shadow-xl shadow-purple-300/50 border-2 border-purple-400/80 flex-shrink-0" :class="isEnCours(rdv) ? 'from-green-500 to-green-600 border-green-400 animate-pulse' : ''">
                                        {{ rdv.heure }}
                                    </div>
                                    <div class="font-bold text-slate-800 text-lg flex items-center gap-2 md:hidden">
                                        {{ rdv.civilite }} {{ rdv.nom }} 
                                        <i v-if="isEnCours(rdv)" class="fa-solid fa-circle text-[10px] text-green-500 animate-pulse"></i>
                                        <span v-if="rdv.tag === 'OK M'" class="ml-2 bg-gradient-to-r from-purple-600 to-purple-700 text-white text-[10px] px-2 py-1 rounded-lg font-bold uppercase shadow-md shadow-purple-300">OK M</span>
                                        <span v-if="isNewRdvFromOther(rdv)" class="ml-1 bg-gradient-to-r from-purple-500 to-purple-600 text-white text-[9px] px-2 py-0.5 rounded-full font-bold animate-pulse shadow-md">
                                            <i class="fa-solid fa-user-plus text-[8px]"></i> Nouveau
                                        </span>
                                        <span v-if="isRdvApproaching(rdv)" class="ml-1 bg-gradient-to-r from-orange-500 to-orange-600 text-white text-[9px] px-2 py-0.5 rounded-full font-bold animate-pulse shadow-md">
                                            <i class="fa-solid fa-clock text-[8px]"></i> Bient√¥t
                                        </span>
                                        <span v-if="needsRappel(rdv)" class="ml-1 bg-gradient-to-r from-red-500 to-red-600 text-white text-[9px] px-2 py-0.5 rounded-full font-bold animate-pulse shadow-md">
                                            <i class="fa-solid fa-bell text-[8px]"></i> Rappel
                                        </span>
                                    </div>
                                </div>
                                <div class="flex-1 min-w-0 md:ml-4 relative z-10">
                                    <div class="font-bold text-slate-800 text-xl hidden md:flex items-center gap-2 flex-wrap">
                                        <span class="text-lg">{{ rdv.civilite }} {{ rdv.nom }}</span>
                                        <i v-if="isEnCours(rdv)" class="fa-solid fa-circle text-xs text-green-500 animate-pulse"></i>
                                        <span v-if="rdv.tag === 'OK M'" class="bg-gradient-to-r from-purple-600 to-purple-700 text-white text-xs px-3 py-1 rounded-lg font-bold uppercase shadow-lg shadow-purple-300">OK M</span>
                                        <span v-if="isNewRdvFromOther(rdv)" class="bg-gradient-to-r from-purple-500 to-purple-600 text-white text-xs px-2 py-1 rounded-full font-bold animate-pulse shadow-md" title="Nouveau RDV cr√©√© par un autre utilisateur">
                                            <i class="fa-solid fa-user-plus text-[9px]"></i> Nouveau
                                        </span>
                                        <span v-if="isRdvApproaching(rdv)" class="bg-gradient-to-r from-orange-500 to-orange-600 text-white text-xs px-2 py-1 rounded-full font-bold animate-pulse shadow-md" title="RDV dans moins de 15 minutes">
                                            <i class="fa-solid fa-clock text-[9px]"></i> Bient√¥t
                                        </span>
                                        <span v-if="needsRappel(rdv)" class="bg-gradient-to-r from-red-500 to-red-600 text-white text-xs px-2 py-1 rounded-full font-bold animate-pulse shadow-md" title="Rappel √† faire">
                                            <i class="fa-solid fa-bell text-[9px]"></i> Rappel
                                        </span>
                                        <span v-if="rdv.rappelFait" class="text-green-600" title="Rappel envoy√©">
                                            <i class="fa-solid fa-bell text-base"></i>
                                        </span>
                                        <span v-if="rdv.geste_commercial && user.role === 'admin'" class="text-red-500 text-2xl animate-bounce-slow" title="Geste Commercial appliqu√©">üéÅ</span>
                                        <span v-if="rdv.geste_commercial" class="bg-gradient-to-r from-red-100 to-red-200 text-red-700 text-xs px-3 py-1 rounded-full border-2 border-red-300 font-bold shadow-md">
                                            -{{ rdv.geste_commercial }}‚Ç¨
                                        </span>
                                    </div>
                                    <div v-if="isEnCours(rdv)" class="w-full max-w-xs h-2 bg-gradient-to-r from-slate-200 to-slate-300 rounded-full mt-3 overflow-hidden shadow-inner">
                                        <div class="h-full bg-gradient-to-r from-green-500 via-green-400 to-green-500 transition-all duration-1000 ease-linear shadow-lg shadow-green-300" :style="{width: getProgressPercent(rdv) + '%'}"></div>
                                    </div>
                                    <div class="text-sm text-slate-600 flex flex-wrap items-center gap-2 md:gap-3 mt-2 font-medium">
                                       <span class="bg-gradient-to-r from-slate-50 to-white px-3 py-1.5 rounded-xl border-2 border-slate-300 text-slate-700 shadow-sm font-bold">
                                           <i class="fa-solid fa-car text-purple-500 mr-1"></i> {{ getBaseModele(rdv.modele) || rdv.modele }}
                                       </span>
                                       <span class="flex items-center gap-2 bg-gradient-to-r from-white to-slate-50 px-3 py-1.5 rounded-xl border-2 border-slate-300 shadow-sm">
                                           <img :src="getLogo(rdv.source)" class="w-5 h-5 rounded-md">
                                           <span class="font-bold text-slate-700">{{ rdv.source }}</span>
                                       </span>
                                       <span v-if="getRelativeRdvLabel(rdv)" class="bg-gradient-to-r from-orange-500 to-orange-600 text-white px-3 py-1.5 rounded-xl text-xs font-black uppercase shadow-lg">
                                           {{ getRelativeRdvLabel(rdv) }}
                                       </span>
                                       <div class="w-full mt-2 flex flex-wrap gap-2">
                                           <span class="bg-gradient-to-r from-purple-500 to-purple-600 text-white text-xs font-bold uppercase px-3 py-1.5 rounded-xl border-2 border-purple-400 shadow-md shadow-purple-300">
                                               <i class="fa-solid fa-building mr-1"></i> {{ getAgenceName(rdv.agenceId) }}
                                           </span>
                                           <span class="bg-gradient-to-r from-slate-500 to-slate-600 text-white text-xs font-bold uppercase px-3 py-1.5 rounded-xl border-2 border-slate-400 shadow-md">
                                               <i class="fa-solid fa-user-tag mr-1"></i> {{ rdv.createdBy || 'Syst√®me' }}
                                           </span>
                                       </div>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between md:justify-end mt-2 md:mt-0 relative z-10 gap-2">
                                    <div v-if="rdv.dansAgenda" class="px-3 py-1.5 rounded-xl text-xs font-bold bg-gradient-to-r from-green-500 to-green-600 text-white border-2 border-green-400 flex items-center gap-2 shadow-lg" title="Plac√© dans l'agenda">
                                        <i class="fa-solid fa-calendar-check"></i> <span>Dans l'agenda</span>
                                    </div>
                                    <button 
                                        v-if="['confirme', 'a_confirmer'].includes(rdv.statut) && rdv.date && (() => { const today = new Date(); today.setHours(0,0,0,0); const rdvDate = new Date(rdv.date); rdvDate.setHours(0,0,0,0); return rdvDate >= today && Math.round((rdvDate - today) / 86400000) <= 5; })()"
                                        @click.stop="sendManualRappel(rdv, $event)"
                                        class="px-3 py-1.5 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-xl text-xs font-bold hover:from-red-600 hover:to-red-700 shadow-md flex items-center gap-1.5 transition transform active:scale-95"
                                        title="Envoyer un rappel"
                                    >
                                        <i class="fa-solid fa-bell text-[10px]"></i>
                                        <span class="hidden md:inline">Rappels</span>
                                    </button>
                                    <div v-if="isEnCours(rdv)" class="status-label-active mr-4 bg-gradient-to-r from-green-500 to-green-600 text-white px-4 py-2 rounded-xl font-bold shadow-lg border-2 border-green-400">
                                        <span class="live-dot"></span>En cours
                                    </div>
                                    <div v-else-if="isLateAndNoStatus(rdv)" class="mr-4 bg-gradient-to-r from-purple-500 to-purple-600 text-white px-4 py-2 rounded-xl font-bold text-xs animate-pulse border-2 border-purple-400 shadow-lg">
                                        <i class="fa-solid fa-clipboard-question mr-1"></i> STATUT ?
                                    </div>
                                    <span v-else :class="statusClass(rdv.statut)" class="badge-status shadow-lg px-4 py-2 rounded-xl font-bold border-2">{{ displayStatus(rdv) }}</span>
                                    <div class="ml-4 text-slate-400 group-hover:text-purple-600 transition-transform group-hover:translate-x-1">
                                        <i class="fa-solid fa-chevron-right text-xl"></i>
                                    </div>
                                </div>
                            </div>
                           <div v-if="filteredDaily.length > dashboardLimit" class="text-center pt-6 mt-4">
                            <button @click="dashboardLimit += 15" class="bg-gradient-to-r from-purple-500 to-purple-600 text-white px-8 py-3 rounded-xl text-sm font-bold hover:from-purple-600 hover:to-purple-700 hover:scale-105 transition-all shadow-xl shadow-purple-300 border-2 border-purple-400">
                                üëá Voir la suite ({{ filteredDaily.length - dashboardLimit }} de plus)
                            </button>
                        </div>
                        </div>
                    </div>
                </div>

               <div v-if="view==='list'" class="bg-gradient-to-br from-slate-50 via-purple-50/20 to-slate-50 rounded-[32px] shadow-xl border-2 border-purple-200/50 h-full flex flex-col overflow-hidden fade-in relative transition-all duration-500 font-sans backdrop-blur-sm">
    
    <div class="bg-gradient-to-br from-white via-purple-50/30 to-white border-b-2 border-purple-200/50 z-20 px-6 py-4 flex flex-col md:flex-row items-center justify-between gap-4 shadow-lg backdrop-blur-sm">
        
        <div class="flex-1 w-full md:w-auto flex items-center gap-4">
            <!-- BOUTON RETOUR INTELLIGENT -->
            <button v-if="currentFilter !== 'all' || listFilters.agenceId || listFilters.date || listFilters.prospecteur || fromDashboard" @click="goBackFromList" class="bg-gradient-to-br from-purple-100 to-purple-200 text-purple-700 hover:from-purple-200 hover:to-purple-300 w-10 h-10 rounded-xl flex items-center justify-center transition-all group shadow-md" title="Retour">
                <i class="fa-solid fa-arrow-left group-hover:-translate-x-1 transition"></i>
            </button>
            
            <div class="relative flex-1 max-w-md group">
                <i class="fa-solid fa-search absolute left-4 top-1/2 -translate-y-1/2 text-purple-400 text-lg group-focus-within:text-purple-600 transition"></i>
                <input 
                    v-model="search" 
                    placeholder="Rechercher client, v√©hicule, t√©l..." 
                    class="w-full pl-12 pr-10 py-3 bg-white border-2 border-purple-200 rounded-2xl font-bold text-slate-700 outline-none focus:border-purple-500 focus:bg-purple-50/50 focus:shadow-lg transition-all shadow-sm"
                >
                <button v-if="search" @click="search=''" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-300 hover:text-red-500 transition">
                    <i class="fa-solid fa-circle-xmark text-xl"></i>
                </button>
            </div>
        </div>

        <div class="flex flex-wrap items-center gap-2 w-full md:w-auto justify-center md:justify-end">
            
            <button @click="currentFilter = (currentFilter==='upcoming'?'all':'upcoming')" :class="currentFilter==='upcoming' ? 'bg-gradient-to-r from-purple-500 to-purple-600 text-white shadow-lg shadow-purple-300' : 'bg-white text-purple-600 border-2 border-purple-200 hover:bg-purple-50 hover:border-purple-400'" class="px-4 py-2 rounded-xl text-sm font-bold transition flex items-center gap-2 active:scale-95 shadow-md">
                <i class="fa-solid fa-clock"></i> √Ä venir
            </button>

            <button @click="currentFilter = (currentFilter==='live'?'all':'live')" :class="currentFilter==='live' ? 'bg-gradient-to-r from-green-500 to-green-600 text-white shadow-lg shadow-green-300' : 'bg-white text-green-600 border-2 border-green-200 hover:bg-green-50 hover:border-green-400'" class="px-4 py-2 rounded-xl text-sm font-bold transition flex items-center gap-2 active:scale-95 shadow-md group">
                <i class="fa-solid fa-clock fa-spin" style="animation-duration: 3s;"></i> 
                En cours ({{ activeRdvCount }})
            </button>

            <div class="relative">
                <select v-model="listFilters.agenceId" class="appearance-none bg-white border-2 border-purple-200 hover:border-purple-400 text-slate-700 font-bold text-sm rounded-xl pl-4 pr-8 py-2 outline-none cursor-pointer transition focus:border-purple-500 shadow-md">
                    <option value="">üè¢ Toutes agences</option>
                    <option v-for="ag in visibleAgencies" :key="ag.id" :value="ag.id">{{ ag.nom }}</option>
                </select>
                <i class="fa-solid fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-xs text-purple-400 pointer-events-none"></i>
            </div>

             <input type="date" v-model="listFilters.date" class="appearance-none bg-white border-2 border-purple-200 hover:border-purple-400 text-slate-700 font-bold text-sm rounded-xl px-4 py-2 outline-none cursor-pointer transition focus:border-purple-500 shadow-md" title="Filtrer par date">

             <button v-if="listFilters.agenceId || listFilters.date || listFilters.prospecteur || currentFilter !== 'all'" @click="resetListFilters" class="w-10 h-10 flex items-center justify-center bg-gradient-to-br from-red-100 to-red-200 text-red-600 rounded-xl hover:from-red-200 hover:to-red-300 transition shadow-md" title="Effacer tous les filtres">
                <i class="fa-solid fa-xmark"></i>
             </button>
             
             <button @click="quickRdvModal.open = true; quickRdvModal.agenceId = listFilters.agenceId || ''; quickRdvModal.date = listFilters.date || ''; quickRdvModal.source = ''; quickRdvModal.honore = false" class="px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl text-sm font-bold transition flex items-center gap-2 active:scale-95 shadow-md hover:shadow-lg">
                <i class="fa-solid fa-plus"></i>
                <span class="hidden sm:inline">Ajouter RDV rapide</span>
                <span class="sm:hidden">RDV rapide</span>
             </button>
        </div>
    </div>

    <div class="flex-1 overflow-y-auto p-6 bg-gradient-to-br from-slate-50 via-purple-50/10 to-slate-50 relative">
        
        <div v-if="filteredList.length === 0" class="flex flex-col items-center justify-center h-full fade-in pb-20">
            <div v-if="!search && currentFilter === 'all' && !listFilters.agenceId && !listFilters.date" class="text-center max-w-md">
                <div class="mb-6 p-8 bg-white rounded-[3rem] shadow-xl shadow-blue-50 inline-block animate-bounce-slow relative">
                    <div class="absolute inset-0 bg-blue-500 opacity-10  rounded-full"></div>
                    <i class="fa-solid fa-magnifying-glass-location text-6xl text-blue-500 relative z-10"></i>
                </div>
                <h2 class="text-3xl font-black text-slate-800 mb-3">Explorez vos RDV</h2>
                <p class="text-slate-500 font-medium text-lg leading-relaxed mb-8">Utilisez la recherche ou les filtres rapides ci-dessus.</p>
                <button @click="showUpcoming" class="bg-blue-600 text-white px-8 py-4 rounded-2xl font-bold shadow-lg shadow-blue-200 hover:bg-blue-700 hover:scale-105 transition-all transform flex items-center gap-3 mx-auto">
                    <i class="fa-regular fa-calendar-check text-xl"></i>
                    Voir les prochains RDV
                </button>
            </div>
            <div v-else class="text-center text-slate-400 opacity-70">
                 <i class="fa-regular fa-face-frown-open text-6xl mb-4"></i>
                 <p class="font-bold text-xl">Aucun rendez-vous trouv√©.</p>
            </div>
        </div>

        <div v-else>
            <div class="flex justify-between items-center mb-4 px-2">
                 <h3 class="font-bold text-slate-700 text-lg">R√©sultats</h3>
                 <span class="text-xs font-black text-slate-400 uppercase tracking-widest bg-white px-3 py-1 rounded-full shadow-sm border border-slate-100">{{ filteredList.length }} RDV trouv√©(s)</span>
            </div>

            <!-- MODIFICATION DESIGN : AFFICHAGE EN LIGNE COMME LE DASHBOARD -->
            <div class="space-y-4 pb-24 md:pb-0">
                <div v-for="rdv in displayedList" :key="rdv.id" @click="openRdvFiche(rdv)" :class="isEnCours(rdv) ? 'live-animation' : ''" class="relative z-10 flex flex-col md:flex-row md:items-center p-4 md:p-5 bg-gradient-to-br from-white via-purple-50/20 to-white rounded-xl md:rounded-2xl border-2 border-purple-200/80 hover:border-purple-400 hover:shadow-xl cursor-pointer transition-all duration-200 group gap-2 md:gap-0 overflow-hidden backdrop-blur-sm shadow-md">
                    
                    <!-- Selection Checkbox -->
                    <div v-if="user.role==='admin'" class="absolute top-2 right-2 md:top-auto md:bottom-auto md:left-2 md:right-auto md:relative md:mr-4 z-50" @click.stop>
                         <input type="checkbox" class="custom-checkbox w-5 h-5 shadow-sm border-2 border-slate-300 rounded" :checked="selectedIds.includes(rdv.id)" @change="toggleSelection(rdv.id)">
                    </div>

                    <div class="flex items-center w-full md:w-auto relative z-10">
                        <!-- Affichage Date & Heure Group√© -->
                        <div class="flex flex-col items-center bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl py-2.5 px-3 mr-4 shadow-lg border-2 border-purple-400/50 flex-shrink-0 min-w-[80px]">
                            <span class="text-[10px] font-bold text-white/80 uppercase">{{ formatDateShort(rdv.date) }}</span>
                            <span class="font-black text-lg text-white group-hover:text-purple-50 transition">{{ rdv.heure }}</span>
                        </div>
                        
                        <div class="font-bold text-slate-800 text-lg flex items-center gap-2 md:hidden">{{ rdv.civilite }} {{ rdv.nom }} <i v-if="isEnCours(rdv)" class="fa-solid fa-circle text-[10px] text-green-500 animate-pulse"></i><span v-if="rdv.tag === 'OK M'" class="ml-2 bg-blue-600 text-white text-[10px] px-2 py-0.5 rounded font-bold uppercase shadow-sm">OK M</span><span v-if="isNewRdvFromOther(rdv)" class="ml-1 bg-purple-500 text-white text-[8px] px-1.5 py-0.5 rounded-full font-bold animate-pulse">Nouveau</span><span v-if="isRdvApproaching(rdv)" class="ml-1 bg-orange-500 text-white text-[8px] px-1.5 py-0.5 rounded-full font-bold animate-pulse">Bient√¥t</span><span v-if="needsRappel(rdv)" class="ml-1 bg-red-500 text-white text-[8px] px-1.5 py-0.5 rounded-full font-bold animate-pulse">Rappel</span></div>
                    </div>

                    <div class="flex-1 min-w-0 md:ml-4 relative z-10">
                        <div class="font-bold text-slate-800 text-lg hidden md:flex items-center gap-2">
                            {{ rdv.civilite }} {{ rdv.nom }} 
                            <i v-if="isEnCours(rdv)" class="fa-solid fa-circle text-[10px] text-green-500 animate-pulse"></i>
                                        <span v-if="rdv.tag === 'OK M'" class="ml-2 bg-gradient-to-r from-purple-600 to-purple-700 text-white text-[10px] px-2 py-1 rounded-lg font-bold uppercase shadow-md">OK M</span>
                            <span v-if="isNewRdvFromOther(rdv)" class="ml-2 bg-purple-500 text-white text-[10px] px-2 py-0.5 rounded-full font-bold animate-pulse" title="Nouveau RDV cr√©√© par un autre utilisateur">
                                <i class="fa-solid fa-user-plus text-[8px]"></i> Nouveau
                            </span>
                            <span v-if="isRdvApproaching(rdv)" class="ml-2 bg-orange-500 text-white text-[10px] px-2 py-0.5 rounded-full font-bold animate-pulse" title="RDV dans moins de 15 minutes">
                                <i class="fa-solid fa-clock text-[8px]"></i> Bient√¥t
                            </span>
                            <span v-if="needsRappel(rdv)" class="ml-2 bg-red-500 text-white text-[10px] px-2 py-0.5 rounded-full font-bold animate-pulse" title="Rappel √† faire">
                                <i class="fa-solid fa-bell text-[8px]"></i> Rappel
                            </span>
                            <span v-if="rdv.rappelFait" class="ml-2 text-green-600" title="Rappel envoy√©">
                                <i class="fa-solid fa-bell text-sm"></i>
                            </span>
                            <span v-if="rdv.geste_commercial && user.role === 'admin'" class="ml-2 text-red-500 text-xl animate-bounce-slow" title="Geste Commercial appliqu√©">üéÅ</span>
                            <span v-if="rdv.geste_commercial" class="ml-2 bg-red-100 text-red-600 text-xs px-2 py-0.5 rounded-full border border-red-200 font-bold animate-fadeIn">
                                -{{ rdv.geste_commercial }}‚Ç¨
                            </span>
                        </div>
                        
                        <div v-if="isEnCours(rdv)" class="w-full max-w-xs h-1.5 bg-gray-200 rounded-full mt-2 overflow-hidden shadow-inner">
                            <div class="h-full bg-green-500 transition-all duration-1000 ease-linear shadow-[0_0_10px_rgba(34,197,94,0.6)]" :style="{width: getProgressPercent(rdv) + '%'}"></div>
                        </div>

                        <div class="text-sm text-slate-600 flex flex-wrap items-center gap-2 md:gap-3 mt-2 font-medium">
                           <span class="bg-gradient-to-r from-slate-50 to-white px-3 py-1.5 rounded-xl border-2 border-purple-200 text-slate-700 shadow-sm font-bold">
                                <i class="fa-solid fa-car text-purple-500 mr-1"></i> {{ getBaseModele(rdv.modele) || rdv.modele }}
                            </span>
                            <span class="flex items-center gap-1.5 bg-white px-3 py-1.5 rounded-xl border-2 border-purple-200 text-xs font-bold text-slate-700 shadow-sm">
                                <i class="fa-solid fa-phone text-purple-500"></i> {{ rdv.telephone }}
                            </span>
                            <span class="flex items-center gap-2 bg-white px-3 py-1.5 rounded-xl border-2 border-purple-200 text-xs font-bold text-slate-700 shadow-sm">
                                <img :src="getLogo(rdv.source)" class="w-5 h-5 rounded-md"> {{ rdv.source }}
                            </span>
                            <span v-if="getRelativeRdvLabel(rdv)" class="bg-gradient-to-r from-orange-500 to-orange-600 text-white px-3 py-1.5 rounded-xl text-xs font-black uppercase shadow-lg">
                                {{ getRelativeRdvLabel(rdv) }}
                            </span>
                            
                            <div class="w-full mt-2 flex flex-wrap gap-2">
                                <span class="bg-gradient-to-r from-purple-500 to-purple-600 text-white text-xs font-bold uppercase px-3 py-1.5 rounded-xl border-2 border-purple-400 shadow-md shadow-purple-300">
                                    <i class="fa-solid fa-building mr-1"></i> {{ getAgenceName(rdv.agenceId) }}
                                </span>
                                <span class="bg-gradient-to-r from-slate-500 to-slate-600 text-white text-xs font-bold uppercase px-3 py-1.5 rounded-xl border-2 border-slate-400 shadow-md">
                                    <i class="fa-solid fa-user-tag mr-1"></i> {{ rdv.createdBy || 'Syst√®me' }}
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center justify-between md:justify-end mt-2 md:mt-0 relative z-10 gap-2">
                        <div v-if="rdv.dansAgenda" class="px-2 py-1 rounded-lg text-[10px] font-bold bg-green-100 text-green-700 border border-green-300 flex items-center gap-1" title="Plac√© dans l'agenda">
                            <i class="fa-solid fa-calendar-check text-[10px]"></i> <span>Dans l'agenda</span>
                        </div>
                        <button 
                            v-if="['confirme', 'a_confirmer'].includes(rdv.statut) && rdv.date && (() => { const today = new Date(); today.setHours(0,0,0,0); const rdvDate = new Date(rdv.date); rdvDate.setHours(0,0,0,0); return rdvDate >= today && Math.round((rdvDate - today) / 86400000) <= 5; })()"
                            @click.stop="sendManualRappel(rdv, $event)"
                            class="px-3 py-1.5 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-xl text-xs font-bold hover:from-red-600 hover:to-red-700 shadow-md flex items-center gap-1.5 transition transform active:scale-95"
                            title="Envoyer un rappel"
                        >
                            <i class="fa-solid fa-bell text-[10px]"></i>
                            <span class="hidden md:inline">Rappels</span>
                        </button>
                        <div v-if="isEnCours(rdv)" class="status-label-active mr-4"><span class="live-dot"></span>Rendez-vous en cours</div>
                        <div v-else-if="isLateAndNoStatus(rdv)" class="mr-4 bg-purple-100 text-purple-600 px-3 py-1 rounded-full font-bold text-xs animate-pulse border border-purple-200 shadow-sm"><i class="fa-solid fa-clipboard-question"></i> STATUT ?</div>
                        <span v-else :class="statusClass(rdv.statut)" class="badge-status shadow-sm">{{ displayStatus(rdv) }}</span>
                        <div class="ml-4 text-slate-300 group-hover:text-blue-500 transition"><i class="fa-solid fa-chevron-right"></i></div>
                    </div>
                </div>
            </div>

            <div v-if="displayedList.length < filteredList.length" class="p-8 text-center">
                 <button @click="displayLimit += 20" class="bg-white border-2 border-slate-200 text-slate-500 px-8 py-3 rounded-full font-bold hover:bg-slate-50 hover:border-blue-300 hover:text-blue-600 transition shadow-sm active:scale-95">üëá Charger les suivants</button>
            </div>
        </div>
    </div>

    <div v-if="selectedIds.length > 0" class="absolute bottom-6 left-4 right-4 md:left-auto md:right-6 md:w-auto bg-slate-900 text-white p-4 rounded-full shadow-2xl flex items-center justify-between gap-6 slide-up z-[60] border border-slate-800">
        <div class="font-bold pl-2 flex items-center gap-2"><span class="bg-blue-500 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs">{{ selectedIds.length }}</span> <span class="hidden md:inline">s√©lectionn√©s</span></div>
        <div class="flex gap-2">
            <button @click="openBulkConfirm('soft_delete', 'Mettre √† la corbeille ?')" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-full font-bold text-sm transition flex items-center gap-2 shadow-lg shadow-red-500/30 active:scale-95">
                <i class="fa-solid fa-trash-can"></i> <span class="hidden md:inline">Corbeille</span>
            </button>
            <button @click="selectedIds=[]" class="text-slate-400 hover:text-white w-10 h-10 flex items-center justify-center rounded-full hover:bg-slate-800 transition" title="Annuler la s√©lection">‚úï</button>
        </div>
    </div>
</div>

    <!-- üîª le reste de la liste (table + mobile) NE BOUGE PAS -->


 <div v-if="view==='trash'" class="bg-white rounded-3xl shadow-sm border border-slate-100 h-full flex flex-col overflow-hidden fade-in relative">
                    
                    <div class="p-6 border-b bg-slate-50 flex justify-between items-center">
                        <h2 class="text-xl md:text-2xl font-bold text-gray-700"><i class="fa-solid fa-trash-can"></i> Corbeille</h2>
                        <div class="flex items-center gap-3">
                            <span class="text-sm text-gray-500">{{ trashList.length }} √©l√©ments</span>
                            <button v-if="trashList.length > 0 && user.role==='admin'" @click="openBulkConfirm('empty_trash', 'Vider TOUTE la corbeille ?')" class="bg-red-100 text-red-600 px-4 py-2 rounded-xl text-xs font-bold hover:bg-red-200 transition">Tout Vider</button>
                        </div>
                    </div>

                    <div class="overflow-auto flex-1 p-0 pb-20 hidden md:block">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-gradient-to-r from-slate-100 to-slate-50 text-slate-600 text-xs uppercase sticky top-0 z-10 shadow-md font-bold border-b-2 border-slate-200">
                                <tr>
                                    <th class="p-4 w-10"><input type="checkbox" class="custom-checkbox" @change="selectAll($event)" :checked="isAllSelected && trashList.length > 0"></th>
                                    <th class="p-4">Date</th>
                                    <th class="p-4">Client</th>
                                    <th class="p-4 hidden md:table-cell">Supprim√© par</th>
                                    <th class="p-4 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="text-sm bg-white">
                                <tr v-for="rdv in trashList" :key="rdv.id" class="border-b border-slate-100 hover:bg-gradient-to-r hover:from-red-50/50 hover:to-transparent transition-all duration-200" :class="{'bg-red-50/30': selectedIds.includes(rdv.id)}">
                                    <td class="p-4 text-center"><input type="checkbox" class="custom-checkbox" :checked="selectedIds.includes(rdv.id)" @change="toggleSelection(rdv.id)"></td>
                                    <td class="p-4 text-gray-500"><div class="font-bold line-through">{{ formatDateShort(rdv.date) }}</div></td>
                                    <td class="p-4 opacity-60"><div class="font-bold text-slate-700">{{ rdv.nom }}</div><div class="text-slate-500 text-xs">{{ getBaseModele(rdv.modele) || rdv.modele }}</div></td>
                                    <td class="p-4 text-xs font-bold text-gray-400 uppercase hidden md:table-cell">Utilisateur</td>
                                    <td class="p-4 text-right flex justify-end gap-2">
                                        <button @click="restoreRdv(rdv)" class="bg-gradient-to-r from-green-500 to-green-600 text-white px-3 py-1.5 rounded-lg font-bold text-xs hover:from-green-600 hover:to-green-700 transition shadow-md shadow-green-200" title="Restaurer"><i class="fa-solid fa-rotate-left"></i></button>
                                        <button v-if="user.role==='admin'" @click="hardDeleteRdv(rdv)" class="bg-gradient-to-r from-red-500 to-red-600 text-white px-3 py-1.5 rounded-lg font-bold text-xs hover:from-red-600 hover:to-red-700 transition shadow-md shadow-red-200" title="Supprimer d√©finitivement"><i class="fa-solid fa-ban"></i></button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="md:hidden flex-1 overflow-y-auto p-4 space-y-3 pb-24 bg-slate-100">
                        <div v-for="rdv in trashList" :key="rdv.id" 
                             class="p-4 rounded-2xl shadow-sm border relative transition-all duration-200"
                             :class="selectedIds.includes(rdv.id) ? 'bg-red-50 border-red-300 ring-1 ring-red-200' : 'bg-white border-red-100'">
                            
                            <div class="absolute top-4 right-4 z-10">
                                <input type="checkbox" class="custom-checkbox w-6 h-6" :checked="selectedIds.includes(rdv.id)" @change="toggleSelection(rdv.id)">
                            </div>

                            <div class="flex justify-between items-start mb-2 pr-8 opacity-60">
                                <div>
                                    <div class="text-xs font-bold text-slate-400 uppercase flex items-center gap-1 line-through"><i class="fa-regular fa-calendar"></i> {{ formatDateShort(rdv.date) }}</div>
                                    <div class="text-lg font-bold text-slate-800">{{ rdv.nom }}</div>
                                </div>
                            </div>
                            <div class="flex items-center gap-2 mb-3 text-sm text-slate-600 font-medium opacity-60"><i class="fa-solid fa-car"></i> {{ getBaseModele(rdv.modele) || rdv.modele }}</div>
                            
                            <div class="flex gap-2 justify-end mt-2 pt-2 border-t border-slate-100">
                                <button @click="restoreRdv(rdv)" class="bg-green-100 text-green-700 px-3 py-1.5 rounded-lg font-bold text-xs hover:bg-green-200 transition">Restaurer</button>
                                <button v-if="user.role==='admin'" @click="hardDeleteRdv(rdv)" class="bg-red-100 text-red-700 px-3 py-1.5 rounded-lg font-bold text-xs hover:bg-red-200 transition">Supprimer</button>
                            </div>
                        </div>
                        
                        <div v-if="trashList.length === 0" class="text-center text-gray-400 py-10 italic">La corbeille est vide.</div>
                    </div>

                    <div v-if="selectedIds.length > 0" class="absolute bottom-6 left-4 right-4 md:left-6 md:right-6 bg-slate-900 text-white p-4 rounded-2xl shadow-2xl flex flex-col md:flex-row items-center justify-between slide-up z-50 gap-3">
                        <div class="font-bold pl-2"><span class="text-blue-400 text-xl">{{ selectedIds.length }}</span> s√©lectionn√©s</div>
                        <div class="flex gap-2 w-full md:w-auto justify-end">
                            <button @click="openBulkConfirm('restore_trash', 'Restaurer la s√©lection ?')" class="bg-green-600 hover:bg-green-500 px-3 md:px-4 py-2 rounded-lg font-bold text-xs md:text-sm transition flex-1 md:flex-none">Restaurer</button>
                            <button v-if="user.role==='admin'" @click="openBulkConfirm('delete_trash', 'Supprimer D√âFINITIVEMENT ?')" class="bg-red-600 hover:bg-red-500 px-3 md:px-4 py-2 rounded-lg font-bold text-xs md:text-sm transition flex-1 md:flex-none">Supprimer</button>
                            <button @click="selectedIds=[]" class="ml-2 text-gray-400 hover:text-white px-2">‚úï</button>
                        </div>
                    </div>
                </div>
                
                <div v-if="view==='pending_status'" class="max-w-3xl mx-auto space-y-4 fade-in"><h2 class="text-xl md:text-2xl font-bold mb-6 text-purple-700"><i class="fa-solid fa-clipboard-question"></i> Statuts √† d√©finir</h2><div v-if="pendingStatusList.length===0" class="bg-white p-10 rounded-2xl text-center text-gray-400 border border-slate-100 shadow-sm"><i class="fa-solid fa-check-circle text-4xl mb-2 text-green-500"></i><br>Tous les statuts sont √† jour !</div><div v-for="r in pendingStatusList" :key="r.id" class="bg-white p-4 md:p-6 rounded-2xl shadow-sm border-l-4 border-purple-500 flex flex-col md:flex-row justify-between items-start md:items-center hover:shadow-md transition group" @click="openRdvFiche(r)"><div class="cursor-pointer flex-1"><div class="font-bold text-lg flex items-center gap-2">{{ r.civilite }} {{ r.nom }} <span class="text-xs bg-gray-100 text-gray-500 px-2 rounded">Termin√©</span></div><div class="text-slate-500">{{ formatDateFr(r.date) }} √† {{ r.heure }} ‚Ä¢ {{ r.modele }}</div><div class="text-sm font-bold text-blue-600 mt-1">{{ getAgenceName(r.agenceId) }}</div></div><div class="flex gap-2 w-full md:w-auto"><button @click.stop="updateStatus(r, 'honor_fact')" class="flex-1 md:flex-none bg-green-100 text-green-700 px-4 py-2 rounded-xl font-bold hover:bg-green-200 border border-green-200 text-sm"><i class="fa-solid fa-check"></i> Honor√©</button><button @click.stop="updateStatus(r, 'noshow')" class="flex-1 md:flex-none bg-red-100 text-red-700 px-4 py-2 rounded-xl font-bold hover:bg-red-200 border border-red-200 text-sm"><i class="fa-solid fa-user-xmark"></i> Lapin</button></div></div></div>
                <div v-if="view==='portefeuille'" class="max-w-7xl mx-auto space-y-6 fade-in">
                    <!-- VUE ADMIN -->
                    <div v-if="user.role==='admin'" class="space-y-6">
                        <!-- STATS ADMIN ULTRA MODERNES -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <!-- Solde du Jour -->
                            <div class="group relative transform transition-all duration-300 hover:scale-105">
                                <div class="absolute -inset-1 bg-gradient-to-r from-blue-400 via-cyan-400 to-blue-500 rounded-3xl opacity-60 group-hover:opacity-100 transition duration-300"></div>
                                <div class="relative bg-white rounded-3xl shadow-2xl p-8 overflow-hidden border border-blue-200">
                                    <!-- Grille de fond anim√©e -->
                                    <div class="absolute inset-0 opacity-5">
                                        <div class="absolute inset-0" style="background-image: linear-gradient(rgba(102,126,234,0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(102,126,234,0.1) 1px, transparent 1px); background-size: 20px 20px;"></div>
                                    </div>
                                    <!-- Particules flottantes -->
                                    <div class="absolute top-4 right-4 w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>
                                    <div class="absolute bottom-8 left-8 w-1 h-1 bg-cyan-500 rounded-full animate-pulse" style="animation-delay: 0.5s;"></div>
                                <div class="relative z-10">
                                        <div class="flex items-center justify-between mb-6">
                                            <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-2xl flex items-center justify-center shadow-lg shadow-blue-500/50">
                                                <i class="fa-solid fa-calendar-day text-3xl text-white"></i>
                                </div>
                                            <div class="px-3 py-1 bg-blue-100 rounded-full border border-blue-300">
                                                <span class="text-blue-700 text-xs font-bold uppercase tracking-wider">Aujourd'hui</span>
                            </div>
                                        </div>
                                        <p class="text-blue-600 text-xs font-bold uppercase mb-3 tracking-widest">Solde du Jour</p>
                                        <p class="text-5xl font-black mb-2 text-blue-600">{{ formatPrice(adminStats.caDaily) }}</p>
                                        <div class="flex items-center gap-2 mt-4">
                                            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                            <p class="text-slate-600 text-sm font-medium">CA brut en temps r√©el</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Solde du Mois Brut -->
                            <div class="group relative transform transition-all duration-300 hover:scale-105">
                                <div class="absolute -inset-1 bg-gradient-to-r from-emerald-400 via-green-400 to-emerald-500 rounded-3xl opacity-60 group-hover:opacity-100 transition duration-300"></div>
                                <div class="relative bg-white rounded-3xl shadow-2xl p-8 overflow-hidden border border-emerald-200">
                                    <!-- Grille de fond anim√©e -->
                                    <div class="absolute inset-0 opacity-5">
                                        <div class="absolute inset-0" style="background-image: linear-gradient(rgba(16,185,129,0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(16,185,129,0.1) 1px, transparent 1px); background-size: 20px 20px;"></div>
                                    </div>
                                    <!-- Particules flottantes -->
                                    <div class="absolute top-4 right-4 w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div>
                                    <div class="absolute bottom-8 left-8 w-1 h-1 bg-green-500 rounded-full animate-pulse" style="animation-delay: 0.5s;"></div>
                                <div class="relative z-10">
                                        <div class="flex items-center justify-between mb-6">
                                            <div class="w-16 h-16 bg-gradient-to-br from-emerald-500 to-green-500 rounded-2xl flex items-center justify-center shadow-lg shadow-emerald-500/50">
                                                <i class="fa-solid fa-chart-line text-3xl text-white"></i>
                                </div>
                                            <div class="px-3 py-1 bg-emerald-100 rounded-full border border-emerald-300">
                                                <span class="text-emerald-700 text-xs font-bold uppercase tracking-wider">Ce mois</span>
                            </div>
                                        </div>
                                        <p class="text-emerald-600 text-xs font-bold uppercase mb-3 tracking-widest">Solde Brut</p>
                                        <p class="text-5xl font-black mb-2 text-emerald-600">{{ formatPrice(adminStats.caMonthly) }}</p>
                                        <div class="flex items-center gap-2 mt-4">
                                            <div class="w-2 h-2 bg-yellow-500 rounded-full animate-pulse"></div>
                                            <p class="text-slate-600 text-sm font-medium">Avant commissions</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Solde du Mois Net -->
                            <div class="group relative transform transition-all duration-300 hover:scale-105">
                                <div class="absolute -inset-1 bg-gradient-to-r from-purple-400 via-pink-400 to-purple-500 rounded-3xl opacity-60 group-hover:opacity-100 transition duration-300"></div>
                                <div class="relative bg-white rounded-3xl shadow-2xl p-8 overflow-hidden border border-purple-200">
                                    <!-- Grille de fond anim√©e -->
                                    <div class="absolute inset-0 opacity-5">
                                        <div class="absolute inset-0" style="background-image: linear-gradient(rgba(168,85,247,0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(168,85,247,0.1) 1px, transparent 1px); background-size: 20px 20px;"></div>
                                    </div>
                                    <!-- Particules flottantes -->
                                    <div class="absolute top-4 right-4 w-2 h-2 bg-purple-500 rounded-full animate-pulse"></div>
                                    <div class="absolute bottom-8 left-8 w-1 h-1 bg-pink-500 rounded-full animate-pulse" style="animation-delay: 0.5s;"></div>
                                <div class="relative z-10">
                                        <div class="flex items-center justify-between mb-6">
                                            <div class="w-16 h-16 bg-gradient-to-br from-purple-500 to-pink-500 rounded-2xl flex items-center justify-center shadow-lg shadow-purple-500/50">
                                                <i class="fa-solid fa-wallet text-3xl text-white"></i>
                                            </div>
                                            <div class="px-3 py-1 bg-purple-100 rounded-full border border-purple-300">
                                                <span class="text-purple-700 text-xs font-bold uppercase tracking-wider">Net</span>
                                            </div>
                                        </div>
                                        <p class="text-purple-600 text-xs font-bold uppercase mb-3 tracking-widest">Solde Net</p>
                                        <p class="text-5xl font-black mb-2 text-purple-600">{{ formatPrice(adminStats.netMonthly) }}</p>
                                        <div class="flex items-center gap-2 mt-4">
                                            <div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>
                                            <p class="text-slate-600 text-sm font-medium">Apr√®s commissions</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- BARRE DE RECHERCHE -->
                        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-4">
                            <div class="relative">
                                <i class="fa-solid fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                <input 
                                    v-model="portefeuilleSearch" 
                                    @input="filterProspectors"
                                    type="text" 
                                    placeholder="Rechercher un prospecteur..." 
                                    class="w-full pl-12 pr-4 py-3 border-2 border-slate-200 rounded-xl font-medium text-slate-800 outline-none focus:border-blue-500 transition"
                                />
                            </div>
                        </div>

                        <!-- LISTE DES PROSPECTEURS EN CARTES -->
                        <div v-if="!selectedProspecteur">
                            <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                                <i class="fa-solid fa-users text-blue-500"></i>
                                Tous les prospecteurs ({{ onlyProspectors.length }})
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div 
                                    v-for="prosp in displayedProspectors" 
                                    :key="prosp.name"
                                    @click="selectProspecteur(prosp.name)"
                                    class="bg-white rounded-2xl shadow-sm border border-slate-200 hover:border-blue-400 hover:shadow-lg p-6 cursor-pointer transition-all group"
                                >
                                    <div class="flex items-start justify-between mb-4">
                                        <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center text-white text-xl font-black group-hover:scale-110 transition-transform">
                                            {{ prosp.name.charAt(0).toUpperCase() }}
                                        </div>
                                        <i class="fa-solid fa-chevron-right text-slate-300 group-hover:text-blue-500 transition"></i>
                                    </div>
                                    <h4 class="font-bold text-lg text-slate-800 mb-2">{{ prosp.name }}</h4>
                                    <div class="space-y-2">
                                        <div class="flex justify-between items-center">
                                            <span class="text-xs text-slate-500">CA ce mois</span>
                                            <span class="text-sm font-bold text-green-600">{{ formatPrice(prosp.ca) }}</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-xs text-slate-500">RDV Honor√©s</span>
                                            <span class="text-sm font-bold text-blue-600">{{ prosp.honoredCount }}</span>
                                        </div>
                                        <div class="pt-2 border-t border-slate-100">
                                            <div class="flex justify-between items-center">
                                                <span class="text-xs text-slate-500">Reste net</span>
                                                <span class="text-sm font-black" :class="prosp.net >= 0 ? 'text-green-600' : 'text-red-600'">
                                                    {{ formatPrice(prosp.net) }}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div v-if="displayedProspectors.length === 0" class="text-center py-12 bg-white rounded-2xl border border-slate-100">
                                <i class="fa-solid fa-search text-4xl text-slate-300 mb-3"></i>
                                <p class="text-slate-400 font-medium">Aucun prospecteur trouv√©</p>
                            </div>
                        </div>

                        <!-- Vue Transactions du prospecteur s√©lectionn√© -->
                        <div v-if="selectedProspecteur" class="space-y-6">
                            <!-- En-t√™te avec bouton retour -->
                            <div class="flex items-center justify-between mb-4">
                                <button @click="selectedProspecteur = null; portefeuilleSearch = ''" class="flex items-center gap-2 text-slate-600 hover:text-blue-600 font-medium transition">
                                    <i class="fa-solid fa-arrow-left"></i>
                                    <span>Retour √† la liste</span>
                                </button>
                            </div>
                            
                            <!-- Carte d'identit√© du prospecteur -->
                            <div class="bg-white rounded-3xl shadow-2xl p-6 border border-blue-200 relative overflow-hidden">
                                <div class="absolute top-0 right-0 w-64 h-64 bg-blue-100/30 rounded-full -mr-32 -mt-32"></div>
                                <div class="absolute bottom-0 left-0 w-48 h-48 bg-blue-100/30 rounded-full -ml-24 -mb-24"></div>
                                <div class="relative z-10 flex items-center justify-between">
                                    <div>
                                        <p class="text-blue-600 text-sm font-bold uppercase mb-1">Prospecteur</p>
                                        <h2 class="text-3xl font-black text-slate-800">{{ selectedProspecteur ? selectedProspecteur.split(' ')[0] : '' }}</h2>
                                    </div>
                                    <button @click="selectedProspecteur = null; portefeuilleSearch = ''" class="bg-blue-100 hover:bg-blue-200 text-blue-700 p-3 rounded-xl transition">
                                        <i class="fa-solid fa-arrow-left"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Transactions en premier -->
                            <div class="bg-white rounded-2xl shadow-lg border border-slate-200 p-6">
                                <div class="flex items-center justify-between mb-6">
                                    <h3 class="text-xl font-bold text-slate-800 flex items-center gap-3">
                                        <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center">
                                            <i class="fa-solid fa-list text-white"></i>
                                        </div>
                                        Transactions
                                    </h3>
                                    <span class="text-sm text-slate-500 font-medium bg-slate-100 px-3 py-1 rounded-full">{{ allTransactions.length }} transaction(s)</span>
                                </div>
                                <div class="space-y-3 max-h-[600px] overflow-y-auto pr-2">
                                    <div 
                                        v-for="trans in allTransactions" 
                                        :key="trans.id"
                                        @click="trans.rdvId && openRdvFiche(getRdvFromTransaction(trans))"
                                        class="p-5 bg-gradient-to-br from-white to-slate-50 hover:from-blue-50 hover:to-blue-100 rounded-2xl border-2 border-slate-200 hover:border-blue-400 hover:shadow-lg transition-all group cursor-pointer"
                                        :class="trans.hidden ? 'opacity-50' : ''"
                                    >
                                        <div class="flex items-start gap-4">
                                            <div class="w-14 h-14 rounded-2xl flex items-center justify-center flex-shrink-0 shadow-md" 
                                                 :class="trans.type === 'bonus' ? 'bg-gradient-to-br from-yellow-400 to-orange-500' : (trans.amount >= 0 ? 'bg-gradient-to-br from-green-400 to-emerald-500' : 'bg-gradient-to-br from-red-400 to-rose-500')">
                                                <i :class="getTransactionIcon(trans.type)" class="text-white text-xl"></i>
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <div class="flex items-center gap-2 mb-2">
                                                    <span class="font-bold text-lg text-slate-800">{{ trans.label }}</span>
                                                    <span v-if="trans.hidden" class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded-full font-bold">Masqu√©e</span>
                                                    <span v-if="trans.type === 'bonus'" class="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full font-bold animate-pulse">
                                                        <i class="fa-solid fa-star mr-1"></i>Bonus
                                                    </span>
                                                </div>
                                                <div class="text-sm text-slate-500 mb-3 font-medium">
                                                    <i class="fa-solid fa-clock mr-1"></i>{{ formatDateFr(trans.date) }}
                                                </div>
                                                <!-- D√©tails du RDV si disponible -->
                                                <div v-if="getRdvFromTransaction(trans)" class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3 p-3 bg-white/60 rounded-xl border border-slate-200">
                                                    <div v-if="getRdvFromTransaction(trans).agenceId" class="flex items-center gap-2 text-blue-700 font-medium">
                                                        <i class="fa-solid fa-building text-blue-500"></i>
                                                        <span>{{ getAgenceName(getRdvFromTransaction(trans).agenceId) }}</span>
                                                    </div>
                                                    <div v-if="getRdvFromTransaction(trans).civilite && getRdvFromTransaction(trans).nom" class="flex items-center gap-2 text-slate-700 font-medium">
                                                        <i class="fa-solid fa-user text-slate-500"></i>
                                                        <span>{{ getRdvFromTransaction(trans).civilite }} {{ getRdvFromTransaction(trans).nom }}</span>
                                                    </div>
                                                    <div v-if="getRdvFromTransaction(trans).date && getRdvFromTransaction(trans).heure" class="flex items-center gap-2 text-slate-600">
                                                        <i class="fa-solid fa-calendar text-slate-400"></i>
                                                        <span>{{ formatDateShort(getRdvFromTransaction(trans).date) }} √† {{ getRdvFromTransaction(trans).heure }}</span>
                                                    </div>
                                                    <div v-if="getRdvFromTransaction(trans).modele" class="flex items-center gap-2 text-slate-600">
                                                        <i class="fa-solid fa-car text-slate-400"></i>
                                                        <span>{{ getRdvFromTransaction(trans).modele }}</span>
                                                    </div>
                                                    <div v-if="getRdvFromTransaction(trans).telephone" class="flex items-center gap-2 text-slate-600">
                                                        <i class="fa-solid fa-phone text-slate-400"></i>
                                                        <span>{{ getRdvFromTransaction(trans).telephone }}</span>
                                                    </div>
                                                    <div v-if="trans.rdvId" class="flex items-center gap-2 text-blue-600 font-medium">
                                                        <i class="fa-solid fa-eye text-blue-500"></i>
                                                        <span>Cliquer pour voir le r√©capitulatif</span>
                                                    </div>
                                                </div>
                                                <!-- D√©tails bonus si c'est un bonus -->
                                                <div v-if="trans.type === 'bonus' && trans.bonusCount" class="mt-3 p-3 bg-yellow-50 rounded-xl border border-yellow-200">
                                                    <div class="text-sm text-yellow-800 font-medium">
                                                        <i class="fa-solid fa-trophy mr-2"></i>
                                                        Palier atteint : {{ trans.bonusCount }} RDV honor√©s
                                                    </div>
                                                </div>
                                                <!-- Note si disponible -->
                                                <div v-if="trans.note" class="mt-3 text-sm text-slate-600 italic bg-slate-100 p-3 rounded-xl border border-slate-200">
                                                    <i class="fa-solid fa-sticky-note mr-2 text-slate-400"></i>{{ trans.note }}
                                                </div>
                                            </div>
                                            <div class="flex flex-col items-end gap-2 flex-shrink-0">
                                                <span class="text-2xl font-black whitespace-nowrap" :class="trans.amount >= 0 ? 'text-green-600' : 'text-red-600'">
                                                    {{ trans.amount >= 0 ? '+' : '' }}{{ formatPrice(trans.amount) }}
                                                </span>
                                                <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition">
                                                    <button 
                                                        v-if="!trans.hidden"
                                                        @click.stop="hideTransaction(trans.id)" 
                                                        class="bg-red-100 text-red-600 p-2 rounded-lg hover:bg-red-200 transition shadow-sm"
                                                        title="Masquer cette transaction"
                                                    >
                                                        <i class="fa-solid fa-eye-slash text-xs"></i>
                                                    </button>
                                                    <button 
                                                        v-else
                                                        @click.stop="showTransaction(trans.id)" 
                                                        class="bg-green-100 text-green-600 p-2 rounded-lg hover:bg-green-200 transition shadow-sm"
                                                        title="Afficher cette transaction"
                                                    >
                                                        <i class="fa-solid fa-eye text-xs"></i>
                                                    </button>
                                                    <button 
                                                        @click.stop="deleteTransaction(trans.id)" 
                                                        class="bg-red-500 text-white p-2 rounded-lg hover:bg-red-600 transition shadow-sm"
                                                        title="Supprimer cette transaction"
                                                    >
                                                        <i class="fa-solid fa-trash text-xs"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div v-if="allTransactions.length === 0" class="text-center text-slate-400 py-12">
                                        <i class="fa-solid fa-inbox text-5xl mb-3"></i>
                                        <p class="text-lg font-medium">Aucune transaction</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Performance & Finances -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="bg-gradient-to-br from-green-50 to-white rounded-2xl shadow-lg border-2 border-green-100 p-6 relative overflow-hidden">
                                    <div class="absolute top-0 right-0 w-24 h-24 bg-green-200/30 rounded-full -mr-12 -mt-12"></div>
                                    <div class="relative z-10">
                                        <h3 class="text-lg font-bold mb-6 text-slate-800 flex items-center gap-2">
                                            <div class="w-10 h-10 bg-green-500 rounded-xl flex items-center justify-center">
                                                <i class="fa-solid fa-chart-line text-white"></i>
                                            </div>
                                            Performance
                                        </h3>
                                        <div class="space-y-4">
                                            <div class="bg-white/80 rounded-xl p-4 border border-green-100">
                                                <div class="flex justify-between items-center">
                                                    <span class="text-slate-600 font-medium">Chiffre d'affaires</span>
                                                    <span class="text-2xl font-black text-green-600">{{ formatPrice(prospecteurStats.ca) }}</span>
                                                </div>
                                            </div>
                                            <div class="bg-white/80 rounded-xl p-4 border border-blue-100">
                                                <div class="flex justify-between items-center">
                                                    <span class="text-slate-600 font-medium">RDV Honor√©s</span>
                                                    <span class="text-xl font-bold text-blue-600">{{ prospecteurStats.honoredCount }}</span>
                                                </div>
                                            </div>
                                            <div class="pt-3 border-t border-slate-200">
                                                <span class="text-xs font-bold text-slate-500 uppercase mb-3 block">Paliers atteints</span>
                                                <div class="space-y-2">
                                                    <div v-for="tier in prospecteurStats.tiers" :key="tier.level" class="flex items-center gap-3 p-2 rounded-lg" :class="tier.reached ? 'bg-green-50' : 'bg-slate-50'">
                                                        <i :class="tier.reached ? 'fa-solid fa-check-circle text-green-500 text-lg' : 'fa-regular fa-circle text-gray-300'"></i>
                                                        <span class="text-sm font-medium" :class="tier.reached ? 'font-bold text-green-700' : 'text-gray-400'">
                                                            Palier {{ tier.level }}: {{ tier.count }} RDV
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Finances -->
                                <div class="bg-gradient-to-br from-purple-50 to-white rounded-2xl shadow-lg border-2 border-purple-100 p-6 relative overflow-hidden">
                                    <div class="absolute top-0 right-0 w-24 h-24 bg-purple-200/30 rounded-full -mr-12 -mt-12"></div>
                                    <div class="relative z-10">
                                        <h3 class="text-lg font-bold mb-6 text-slate-800 flex items-center gap-2">
                                            <div class="w-10 h-10 bg-purple-500 rounded-xl flex items-center justify-center">
                                                <i class="fa-solid fa-calculator text-white"></i>
                                            </div>
                                            Finances
                                        </h3>
                                        <div class="space-y-3">
                                            <div class="bg-white/80 rounded-xl p-3 border border-green-100">
                                                <div class="flex justify-between items-center">
                                                    <span class="text-slate-600 text-sm font-medium">CA g√©n√©r√©</span>
                                                    <span class="text-lg font-bold text-green-600">+{{ formatPrice(prospecteurStats.ca) }}</span>
                                                </div>
                                            </div>
                                            <div class="bg-white/80 rounded-xl p-3 border border-red-100">
                                                <div class="flex justify-between items-center">
                                                    <span class="text-slate-600 text-sm font-medium">Primes</span>
                                                    <span class="text-lg font-bold text-red-600">-{{ formatPrice(prospecteurStats.commissions) }}</span>
                                                </div>
                                            </div>
                                            <div class="bg-white/80 rounded-xl p-3 border border-red-100">
                                                <div class="flex justify-between items-center">
                                                    <span class="text-slate-600 text-sm font-medium">Pourboires</span>
                                                    <span class="text-lg font-bold text-red-600">-{{ formatPrice(prospecteurStats.tips) }}</span>
                                                </div>
                                            </div>
                                            <div class="pt-4 mt-4 border-t-2 border-slate-300 bg-gradient-to-r from-slate-50 to-white rounded-xl p-4">
                                                <div class="flex justify-between items-center">
                                                    <span class="text-lg font-bold text-slate-800">Reste net</span>
                                                    <span class="text-3xl font-black" :class="prospecteurStats.net >= 0 ? 'text-green-600' : 'text-red-600'">
                                                        {{ formatPrice(prospecteurStats.net) }}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Gestion Pourboires -->
                            <div class="bg-gradient-to-br from-orange-50 to-white rounded-2xl shadow-lg border-2 border-orange-100 p-6">
                                <h3 class="text-lg font-bold mb-6 text-slate-800 flex items-center gap-2">
                                    <div class="w-10 h-10 bg-orange-500 rounded-xl flex items-center justify-center">
                                        <i class="fa-solid fa-hand-holding-dollar text-white"></i>
                                    </div>
                                    Gestion Pourboires
                                </h3>
                                <div class="flex justify-center">
                                    <button @click="openTipModal" class="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-8 py-4 rounded-2xl font-bold hover:from-purple-700 hover:to-pink-700 transition shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center gap-3 text-lg">
                                        <i class="fa-solid fa-hand-holding-dollar text-2xl"></i>
                                        G√©rer les Pourboires
                                            </button>
                                        </div>
                                    </div>
                                        </div>
                                    </div>

                    <!-- VUE PROSPECTEUR -->
                    <div v-else class="space-y-6">
                        <!-- Carte Bancaire R√©aliste -->
                        <div class="flex justify-center">
                            <div class="w-full max-w-md">
                                <div class="bg-white rounded-2xl shadow-2xl p-6 border-2 border-blue-200 relative overflow-hidden transform hover:scale-[1.01] transition-all duration-300" style="aspect-ratio: 1.586;">
                                    <!-- Effets de lumi√®re subtils -->
                                    <div class="absolute top-0 right-0 w-64 h-64 bg-blue-100/30 rounded-full -mr-32 -mt-32"></div>
                                    <div class="absolute bottom-0 left-0 w-48 h-48 bg-blue-100/30 rounded-full -ml-24 -mb-24"></div>
                                    
                                    <!-- Motif de fond discret -->
                                    <div class="absolute inset-0 opacity-5">
                                        <div class="absolute inset-0" style="background-image: radial-gradient(circle at 20% 50%, #667eea 1px, transparent 1px); background-size: 20px 20px;"></div>
                            </div>

                                    <!-- Contenu de la carte -->
                                    <div class="relative z-10 h-full flex flex-col justify-between">
                                        <!-- En-t√™te avec logo -->
                                <div class="flex items-center justify-between mb-4">
                                            <div class="text-slate-800 font-bold text-lg tracking-wide">C&N Solutions</div>
                                            <div class="flex items-center gap-2">
                                                <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                                                    <i class="fa-solid fa-credit-card text-sm text-blue-600"></i>
                                </div>
                                            </div>
                                                </div>
                                        
                                        <!-- Chip de carte -->
                                        <div class="absolute top-12 right-6 w-12 h-9 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-md shadow-lg flex items-center justify-center">
                                            <div class="w-full h-full bg-gradient-to-br from-transparent via-white/30 to-transparent rounded-md relative">
                                                <div class="absolute inset-0 flex items-center justify-center">
                                                    <div class="w-3 h-3 bg-white/40 rounded-sm"></div>
                                            </div>
                                        </div>
                                        </div>
                                        
                                        <!-- Num√©ro de carte masqu√© -->
                                        <div class="flex-1 flex items-center">
                                            <div class="w-full">
                                                <p class="text-blue-600 text-xs font-medium uppercase mb-3 tracking-widest">Num√©ro de compte</p>
                                                <div class="flex items-center gap-2 mb-6">
                                                    <span class="text-2xl font-mono font-bold tracking-widest text-slate-400">**** **** ****</span>
                                                    <span class="text-2xl font-mono font-bold tracking-widest text-slate-800">{{ String(Math.abs(userPortefeuille.total)).slice(-4).padStart(4, '0') }}</span>
                                    </div>
                                                
                                                <!-- Solde disponible -->
                                                <div class="mb-4">
                                                    <p class="text-blue-600 text-xs font-medium uppercase mb-1 tracking-widest">Solde disponible</p>
                                                    <p class="text-3xl font-black text-slate-800">{{ formatPrice(userPortefeuille.total) }}</p>
                                    </div>
                                </div>
                            </div>
                                        
                                        <!-- Bas de carte avec nom -->
                                        <div class="flex items-end justify-between pt-4 border-t border-slate-200">
                                            <div class="flex-1">
                                                <p class="text-blue-600 text-xs font-medium uppercase mb-1 tracking-widest">Titulaire</p>
                                                <p class="text-slate-800 text-lg font-bold uppercase tracking-wide truncate">{{ user.name }}</p>
                        </div>
                                            <div class="text-right">
                                                <div class="w-12 h-8 bg-blue-100 rounded flex items-center justify-center mb-1">
                                                    <div class="w-8 h-5 bg-gradient-to-br from-blue-400 to-blue-600 rounded-sm"></div>
                    </div>
                                                <p class="text-blue-600 text-[8px] font-medium uppercase">VISA</p>
                                    </div>
                                    </div>
                                </div>
                                </div>
                            </div>
                        </div>

                        <!-- Historique des Transactions -->
                        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                                <i class="fa-solid fa-history text-blue-500"></i>
                                Historique des transactions
                            </h3>
                                <button @click="loadUserTransactions()" class="bg-blue-100 text-blue-600 p-2 rounded-lg hover:bg-blue-200 transition" title="Actualiser">
                                    <i class="fa-solid fa-sync-alt"></i>
                                </button>
                            </div>
                            <div class="space-y-3">
                                <div 
                                    v-for="trans in visibleTransactions" 
                                    :key="trans.id"
                                    @click="trans.rdvId && openRdvFiche(getRdvFromTransaction(trans))"
                                    class="p-5 bg-gradient-to-br from-white to-slate-50 hover:from-blue-50 hover:to-blue-100 rounded-2xl border-2 transition-all cursor-pointer shadow-sm hover:shadow-md"
                                    :class="trans.hidden ? 'opacity-60 border-slate-300' : (trans.amount >= 0 ? 'border-green-200 hover:border-green-400' : 'border-red-200 hover:border-red-400')"
                                >
                                    <div class="flex items-start gap-4">
                                        <div class="w-14 h-14 rounded-2xl flex items-center justify-center flex-shrink-0 shadow-md" 
                                             :class="trans.type === 'bonus' ? 'bg-gradient-to-br from-yellow-400 to-orange-500' : (trans.amount >= 0 ? 'bg-gradient-to-br from-green-400 to-emerald-500' : 'bg-gradient-to-br from-red-400 to-rose-500')">
                                            <i :class="getTransactionIcon(trans.type)" class="text-white text-xl"></i>
                                            </div>
                                        <div class="flex-1 min-w-0">
                                            <div class="flex items-center gap-2 mb-2">
                                                <span class="font-bold text-lg text-slate-800">{{ trans.label }}</span>
                                                <span v-if="trans.type === 'bonus'" class="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full font-bold animate-pulse">
                                                    <i class="fa-solid fa-star mr-1"></i>Bonus
                                                </span>
                                            </div>
                                            <div class="text-sm text-slate-500 mb-3 font-medium">
                                                <i class="fa-solid fa-clock mr-1"></i>{{ formatDateFr(trans.date) }}
                                        </div>
                                            <!-- D√©tails du RDV si disponible -->
                                            <div v-if="getRdvFromTransaction(trans)" class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3 p-3 bg-white/60 rounded-xl border border-slate-200">
                                                <div v-if="getRdvFromTransaction(trans).agenceId" class="flex items-center gap-2 text-blue-700 font-medium">
                                                    <i class="fa-solid fa-building text-blue-500"></i>
                                                    <span>{{ getAgenceName(getRdvFromTransaction(trans).agenceId) }}</span>
                                                </div>
                                                <div v-if="getRdvFromTransaction(trans).civilite && getRdvFromTransaction(trans).nom" class="flex items-center gap-2 text-slate-700 font-medium">
                                                    <i class="fa-solid fa-user text-slate-500"></i>
                                                    <span>{{ getRdvFromTransaction(trans).civilite }} {{ getRdvFromTransaction(trans).nom }}</span>
                                                </div>
                                                <div v-if="getRdvFromTransaction(trans).date && getRdvFromTransaction(trans).heure" class="flex items-center gap-2 text-slate-600">
                                                    <i class="fa-solid fa-calendar text-slate-400"></i>
                                                    <span>{{ formatDateShort(getRdvFromTransaction(trans).date) }} √† {{ getRdvFromTransaction(trans).heure }}</span>
                                                </div>
                                                <div v-if="getRdvFromTransaction(trans).modele" class="flex items-center gap-2 text-slate-600">
                                                    <i class="fa-solid fa-car text-slate-400"></i>
                                                    <span>{{ getRdvFromTransaction(trans).modele }}</span>
                                                </div>
                                                <div v-if="trans.rdvId" class="flex items-center gap-2 text-blue-600 font-medium">
                                                    <i class="fa-solid fa-eye text-blue-500"></i>
                                                    <span>Cliquer pour voir le r√©capitulatif</span>
                                                </div>
                                            </div>
                                            <!-- D√©tails bonus si c'est un bonus -->
                                            <div v-if="trans.type === 'bonus' && trans.bonusCount" class="mt-3 p-3 bg-yellow-50 rounded-xl border border-yellow-200">
                                                <div class="text-sm text-yellow-800 font-medium">
                                                    <i class="fa-solid fa-trophy mr-2"></i>
                                                    Palier atteint : {{ trans.bonusCount }} RDV honor√©s
                                                </div>
                                            </div>
                                            <!-- Note si disponible -->
                                            <div v-if="trans.note" class="mt-3 text-sm text-slate-600 italic bg-slate-100 p-3 rounded-xl border border-slate-200">
                                                <i class="fa-solid fa-sticky-note mr-2 text-slate-400"></i>{{ trans.note }}
                                            </div>
                                        </div>
                                        <div class="flex flex-col items-end gap-2 flex-shrink-0">
                                            <span class="text-2xl font-black whitespace-nowrap" :class="trans.amount >= 0 ? 'text-green-600' : 'text-red-600'">
                                                {{ trans.amount >= 0 ? '+' : '' }}{{ formatPrice(trans.amount) }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div v-if="visibleTransactions.length === 0" class="text-center text-slate-400 py-8">
                                    <i class="fa-solid fa-inbox text-4xl mb-2"></i>
                                    <p>Aucune transaction visible</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VUE BILAN -->
                <div v-if="view==='bilan'" class="max-w-7xl mx-auto space-y-6 fade-in">
                    <!-- Onglets Bilan -->
                    <div class="bg-slate-100 p-2 rounded-xl flex gap-2 mb-6">
                        <button @click="bilanTab = 'main'" :class="bilanTab==='main' ? 'bg-white text-blue-600 shadow-md' : 'text-slate-600'" class="flex-1 px-4 py-3 rounded-lg font-bold transition">
                            <i class="fa-solid fa-chart-pie mr-2"></i> Bilan
                        </button>
                        <button @click="bilanTab = 'urgent'" :class="bilanTab==='urgent' ? 'bg-white text-orange-600 shadow-md' : 'text-slate-600'" class="flex-1 px-4 py-3 rounded-lg font-bold transition relative">
                            <i class="fa-solid fa-exclamation-triangle mr-2"></i> √Ä traiter urgent
                            <span v-if="urgentBilanCount > 0" class="absolute -top-1 -right-1 bg-red-600 text-white text-xs px-2 py-1 rounded-full font-bold">{{ urgentBilanCount }}</span>
                        </button>
                        <button @click="bilanTab = 'objectifs'" :class="bilanTab==='objectifs' ? 'bg-white text-green-600 shadow-md' : 'text-slate-600'" class="flex-1 px-4 py-3 rounded-lg font-bold transition">
                            <i class="fa-solid fa-bullseye mr-2"></i> Objectifs
                        </button>
                    </div>

                    <!-- Contenu principal du Bilan -->
                    <div v-if="bilanTab==='main'">
                    <h2 class="text-2xl md:text-3xl font-bold text-slate-800 mb-6 flex items-center gap-3">
                        <i class="fa-solid fa-chart-pie text-blue-500"></i>
                        Bilan & Facturation
                    </h2>

                    <!-- Dashboard Bilan -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 md:gap-6 mb-6">
                        <div class="bg-white rounded-2xl shadow-lg border border-slate-200 p-4 md:p-6">
                            <div class="text-xs font-bold text-slate-500 uppercase mb-2">CA {{ bilanConfig.tvaActive ? 'HT' : '' }}</div>
                            <div class="text-2xl md:text-3xl font-black text-blue-600">{{ formatBilanPrice(bilanStats.ht) }}‚Ç¨</div>
                            <div class="text-xs md:text-sm text-slate-500 mt-2">{{ bilanStats.rdv }} RDV</div>
                        </div>
                        <div v-if="bilanConfig.tvaActive" class="bg-white rounded-2xl shadow-lg border border-slate-200 p-4 md:p-6">
                            <div class="text-xs font-bold text-slate-500 uppercase mb-2">TVA Collect√©e</div>
                            <div class="text-2xl md:text-3xl font-black text-orange-600">{{ formatBilanPrice(bilanStats.tva) }}‚Ç¨</div>
                        </div>
                        <div v-if="bilanConfig.tvaActive" class="bg-white rounded-2xl shadow-lg border border-slate-200 p-4 md:p-6 sm:col-span-2 md:col-span-1">
                            <div class="text-xs font-bold text-slate-500 uppercase mb-2">Total TTC</div>
                            <div class="text-2xl md:text-3xl font-black text-green-600">{{ formatBilanPrice(bilanStats.ttc) }}‚Ç¨</div>
                        </div>
                    </div>

                    <!-- Boutons d'action -->
                    <div class="flex flex-wrap gap-2 md:gap-3 mb-6">
                        <button @click="syncAllHonoredRdv" class="bg-purple-600 hover:bg-purple-700 text-white px-4 md:px-6 py-2 md:py-3 rounded-xl font-bold shadow-lg flex items-center gap-2 text-sm md:text-base">
                            <i class="fa-solid fa-sync-alt"></i> <span class="hidden sm:inline">Synchroniser RDV honor√©s</span><span class="sm:hidden">Sync</span>
                        </button>
                       <button @click="openBillingSummary" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 md:px-6 py-2 md:py-3 rounded-xl font-bold shadow-lg flex items-center gap-2 text-sm md:text-base">
    <i class="fa-solid fa-file-invoice-dollar"></i> <span class="hidden sm:inline">√âtat Facturation</span>
</button>
                       
                        <button @click="exportMonthPdfAll" class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 md:px-6 py-2 md:py-3 rounded-xl font-bold border border-slate-300 flex items-center gap-2 text-sm md:text-base">
                            <i class="fa-solid fa-file-pdf"></i> <span class="hidden sm:inline">PDF</span>
                        </button>
                        <button @click="exportComptaExcel" class="bg-green-100 hover:bg-green-200 text-green-700 px-4 md:px-6 py-2 md:py-3 rounded-xl font-bold border border-green-300 flex items-center gap-2 text-sm md:text-base">
                            <i class="fa-solid fa-file-excel"></i> <span class="hidden sm:inline">Excel</span>
                        </button>
                        <button v-if="user.role==='admin'" @click="openBilanSettings" class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 md:px-6 py-2 md:py-3 rounded-xl font-bold border border-slate-300 flex items-center gap-2 text-sm md:text-base">
                            <i class="fa-solid fa-gear"></i> <span class="hidden sm:inline">R√©glages</span>
                        </button>
                    </div>

                    <!-- Formulaire de saisie -->
                    <div class="bg-white rounded-2xl shadow-lg border border-slate-200 p-6 mb-6">
                        <h3 class="text-lg font-bold text-slate-800 mb-4">Ajouter des RDV factur√©s</h3>
                        <form @submit.prevent="saveBilanRdv" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Date</label>
                                    <input type="date" v-model="bilanForm.date" required class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-blue-500 outline-none">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Report facturation</label>
                                    <button type="button" @click="toggleBilanReport" :class="bilanForm.reporte ? 'bg-orange-100 text-orange-700 border-orange-300' : 'bg-slate-100 text-slate-700 border-slate-300'" class="w-full px-4 py-3 rounded-xl font-bold border-2">
                                        {{ bilanForm.reporte ? 'OUI (Report M+1)' : 'NON (Mois en cours)' }}
                                    </button>
                                </div>
                            </div>
                            <div id="bilanRdvBlocks" class="space-y-3">
                                <div v-for="(block, idx) in bilanForm.blocks" :key="idx" class="flex flex-wrap gap-2 md:gap-3 items-center p-3 md:p-4 bg-slate-50 rounded-xl border border-slate-200">
                                    <select v-model="block.agenceId" @change="onBilanAgenceChange(idx)" required class="flex-1 min-w-[140px] px-3 md:px-4 py-2 md:py-3 border-2 border-slate-200 rounded-xl focus:border-blue-500 outline-none text-sm md:text-base">
                                        <option value="">Agence...</option>
                                        <option v-for="ag in agences" :key="ag.id" :value="ag.id">{{ ag.nom }}</option>
                                    </select>
                                    <select v-if="hasBilanCommerciaux(idx)" v-model="block.commercial" required class="flex-1 min-w-[140px] px-3 md:px-4 py-2 md:py-3 border-2 border-slate-200 rounded-xl focus:border-blue-500 outline-none text-sm md:text-base">
                                        <option value="">Commercial...</option>
                                        <option v-for="comm in getBilanCommerciaux(idx)" :key="comm" :value="comm">{{ comm }}</option>
                                    </select>
                                    <input type="number" v-model.number="block.rdv" placeholder="Nb" required min="1" class="w-16 md:w-24 px-2 md:px-4 py-2 md:py-3 border-2 border-slate-200 rounded-xl focus:border-blue-500 outline-none text-center font-bold text-sm md:text-base">
                                    <input type="number" v-model.number="block.tarif" placeholder="‚Ç¨" required min="0" step="0.01" class="w-20 md:w-32 px-2 md:px-4 py-2 md:py-3 border-2 border-slate-200 rounded-xl focus:border-blue-500 outline-none text-center text-sm md:text-base">
                                    <button type="button" @click="removeBilanBlock(idx)" class="text-red-600 hover:text-red-800 font-bold text-lg md:text-xl px-2">√ó</button>
                                </div>
                            </div>
                            <div class="flex gap-3">
                                <button type="button" @click="addBilanBlock" class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-6 py-3 rounded-xl font-bold border border-slate-300 flex items-center gap-2">
                                    <i class="fa-solid fa-plus"></i> Ajouter ligne
                                </button>
                                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl font-bold shadow-lg flex items-center gap-2">
                                    <i class="fa-solid fa-save"></i> Enregistrer
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Filtres -->
                    <div class="bg-white rounded-2xl shadow-lg border border-slate-200 p-3 md:p-4 mb-6">
                        <div class="grid grid-cols-2 md:flex md:flex-wrap gap-2 md:gap-3 items-center">
                            <input type="text" v-model="bilanFilters.search" @input="renderBilanTable" placeholder="üîç Rechercher par agence ou commercial..." class="col-span-2 md:col-span-1 px-3 md:px-4 py-2 border-2 border-slate-200 rounded-xl focus:border-blue-500 outline-none text-sm md:text-base">
                            <input type="date" v-model="bilanFilters.jour" @change="renderBilanTable" class="col-span-2 md:col-span-1 px-3 md:px-4 py-2 border-2 border-slate-200 rounded-xl focus:border-blue-500 outline-none text-sm md:text-base">
                            <select v-model="bilanFilters.mois" @change="renderBilanTable" class="col-span-1 px-3 md:px-4 py-2 border-2 border-slate-200 rounded-xl focus:border-blue-500 outline-none text-sm md:text-base">
                                <option value="">Mois</option>
                                <option value="01">Janvier</option>
                                <option value="02">F√©vrier</option>
                                <option value="03">Mars</option>
                                <option value="04">Avril</option>
                                <option value="05">Mai</option>
                                <option value="06">Juin</option>
                                <option value="07">Juillet</option>
                                <option value="08">Ao√ªt</option>
                                <option value="09">Septembre</option>
                                <option value="10">Octobre</option>
                                <option value="11">Novembre</option>
                                <option value="12">D√©cembre</option>
                            </select>
                            <select v-model="bilanFilters.annee" @change="renderBilanTable" class="col-span-1 px-3 md:px-4 py-2 border-2 border-slate-200 rounded-xl focus:border-blue-500 outline-none text-sm md:text-base">
                                <option value="">Ann√©e</option>
                                <option v-for="y in bilanYearOptions" :key="y" :value="y">{{ y }}</option>
                            </select>
                            <select v-model="bilanFilters.agence" @change="renderBilanTable" class="col-span-2 md:col-span-1 px-3 md:px-4 py-2 border-2 border-slate-200 rounded-xl focus:border-blue-500 outline-none text-sm md:text-base">
                                <option value="">Toutes les agences</option>
                                <option v-for="ag in agences" :key="ag.id" :value="ag.nom">{{ ag.nom }}</option>
                            </select>
                            <select v-model="bilanFilters.commercial" @change="renderBilanTable" class="col-span-2 md:col-span-1 px-3 md:px-4 py-2 border-2 border-slate-200 rounded-xl focus:border-blue-500 outline-none text-sm md:text-base">
                                <option value="">Tous les commerciaux</option>
                            </select>
                            <button @click="goToPreviousMonth" class="col-span-1 bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 md:px-4 py-2 rounded-xl font-bold border border-blue-300 text-sm md:text-base flex items-center justify-center gap-2">
                                <i class="fa-solid fa-chevron-left"></i> Mois pr√©c√©dent
                            </button>
                            <button @click="clearBilanFilters" class="col-span-1 bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 md:px-4 py-2 rounded-xl font-bold border border-slate-300 text-sm md:text-base">
                                Effacer
                            </button>
                            <button @click="deleteSelectedBilan" class="col-span-1 bg-red-100 hover:bg-red-200 text-red-700 px-3 md:px-4 py-2 rounded-xl font-bold border border-red-300 text-sm md:text-base">
                                Suppr.
                            </button>
                        </div>
                    </div>

                    <!-- Tableau Desktop -->
                    <div class="bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden hidden md:block">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-slate-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase"><input type="checkbox" @change="toggleAllBilan($event)" :checked="isAllBilanSelected" class="custom-checkbox"></th>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase">Date</th>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase">Agence</th>
                                        <th class="px-4 py-3 text-right text-xs font-bold text-slate-600 uppercase">RDV</th>
                                        <th class="px-4 py-3 text-right text-xs font-bold text-slate-600 uppercase">Tarif</th>
                                        <th v-if="bilanConfig.tvaActive" class="px-4 py-3 text-right text-xs font-bold text-slate-600 uppercase">HT</th>
                                        <th v-if="bilanConfig.tvaActive" class="px-4 py-3 text-right text-xs font-bold text-slate-600 uppercase">TVA</th>
                                        <th class="px-4 py-3 text-right text-xs font-bold text-slate-600 uppercase">Total</th>
                                        <th class="px-4 py-3 text-right text-xs font-bold text-slate-600 uppercase">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="r in displayedBilanRows" :key="r.id" class="border-t border-slate-100 hover:bg-slate-50">
                                        <td class="px-4 py-3"><input type="checkbox" :value="r.id" v-model="selectedBilanIds" class="custom-checkbox"></td>
                                        <td class="px-4 py-3 font-medium">{{ formatBilanDate(r.periodDate || r.date) }}</td>
                                        <td class="px-4 py-3">
                                            <div class="font-bold">{{ r.agence }}</div>
                                            <div v-if="r.commercial" class="text-xs text-slate-500">{{ r.commercial }}</div>
                                        </td>
                                        <td class="px-4 py-3 text-right font-bold">{{ r.rdv }}</td>
                                        <td class="px-4 py-3 text-right">{{ formatBilanPrice(r.tarif) }}‚Ç¨</td>
                                        <td v-if="bilanConfig.tvaActive" class="px-4 py-3 text-right">{{ formatBilanPrice(getBilanLineVals(r).ht) }}‚Ç¨</td>
                                        <td v-if="bilanConfig.tvaActive" class="px-4 py-3 text-right text-slate-500">{{ formatBilanPrice(getBilanLineVals(r).tva) }}‚Ç¨</td>
                                        <td class="px-4 py-3 text-right font-bold">
                                            <div>{{ formatBilanPrice(bilanConfig.tvaActive ? getBilanLineVals(r).ttc : getBilanLineVals(r).ht) }}‚Ç¨</div>
                                            <div v-if="r.reporte" class="text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded mt-1 inline-block">REPORT√â</div>
                                        </td>
                                        <td class="px-4 py-3 text-right">
                                            <button @click="openBilanEdit(r)" class="text-blue-600 hover:text-blue-800 font-bold">
                                                <i class="fa-solid fa-pen"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div v-if="displayedBilanRows.length === 0" class="text-center py-12 text-slate-400">
                            <i class="fa-solid fa-inbox text-4xl mb-3"></i>
                            <p>Aucun RDV factur√©</p>
                        </div>
                    </div>

                    <!-- Version Mobile Minimaliste -->
                    <div class="md:hidden space-y-3">
                        <!-- Checkbox pour s√©lectionner tout -->
                        <div class="bg-white rounded-xl p-3 border border-slate-200 flex items-center gap-3">
                            <input type="checkbox" @change="toggleAllBilan($event)" :checked="isAllBilanSelected" class="custom-checkbox">
                            <span class="text-sm font-bold text-slate-700">S√©lectionner tout</span>
                        </div>
                        
                        <!-- Cartes pour chaque RDV -->
                        <div v-for="r in displayedBilanRows" :key="r.id" class="bg-white rounded-xl p-4 border border-slate-200 shadow-sm">
                            <div class="flex items-start justify-between mb-3">
                                <div class="flex items-center gap-3 flex-1">
                                    <input type="checkbox" :value="r.id" v-model="selectedBilanIds" class="custom-checkbox flex-shrink-0">
                                    <div class="flex-1 min-w-0">
                                        <div class="font-bold text-slate-800 truncate">{{ r.agence }}</div>
                                        <div class="text-xs text-slate-500 mt-1">{{ formatBilanDate(r.periodDate || r.date) }}</div>
                                        <div v-if="r.commercial" class="text-xs text-blue-600 mt-1">{{ r.commercial }}</div>
                                    </div>
                                </div>
                                <button @click="openBilanEdit(r)" class="text-blue-600 hover:text-blue-800 font-bold p-2 flex-shrink-0">
                                    <i class="fa-solid fa-pen text-lg"></i>
                                </button>
                            </div>
                            <div class="flex items-center justify-between pt-3 border-t border-slate-100">
                                <div class="text-sm text-slate-600">
                                    <span class="font-bold">{{ r.rdv }}</span> RDV
                                </div>
                                <div class="text-right">
                                    <div class="font-bold text-lg text-blue-600">{{ formatBilanPrice(bilanConfig.tvaActive ? getBilanLineVals(r).ttc : getBilanLineVals(r).ht) }}‚Ç¨</div>
                                    <div v-if="r.reporte" class="text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded mt-1 inline-block">REPORT√â</div>
                                </div>
                            </div>
                        </div>
                        
                        <div v-if="displayedBilanRows.length === 0" class="text-center py-12 text-slate-400 bg-white rounded-xl border border-slate-200">
                            <i class="fa-solid fa-inbox text-4xl mb-3"></i>
                            <p>Aucun RDV factur√©</p>
                        </div>
                    </div>

                    <!-- Pagination -->
                    <div class="flex justify-end gap-3 items-center">
                        <button @click="changeBilanPage(-1)" :disabled="bilanCurrentPage === 1" class="px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-xl font-bold disabled:opacity-50">Pr√©c.</button>
                        <span class="text-sm font-bold">Page {{ bilanCurrentPage }} / {{ bilanTotalPages }}</span>
                        <button @click="changeBilanPage(1)" :disabled="bilanCurrentPage >= bilanTotalPages" class="px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-xl font-bold disabled:opacity-50">Suiv.</button>
                    </div>
                    </div>

                    <!-- Onglet √Ä traiter urgent -->
                    <div v-if="bilanTab==='urgent'" class="space-y-6">
                        <h2 class="text-2xl md:text-3xl font-bold text-orange-600 mb-6 flex items-center gap-3">
                            <i class="fa-solid fa-exclamation-triangle text-orange-500"></i>
                            √Ä traiter urgent
                        </h2>
                        <p class="text-slate-600 mb-4">RDV honor√©s n√©cessitant l'assignation d'un commercial. V√©rifiez l'agenda Google Calendar du professionnel pour identifier le commercial.</p>
                        
                        <div class="bg-white rounded-2xl shadow-lg border border-orange-200 overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-orange-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase">Date</th>
                                            <th class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase">Agence</th>
                                            <th class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase">Client</th>
                                            <th class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase">T√©l√©phone</th>
                                            <th class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase">Voir Agenda</th>
                                            <th class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="r in urgentBilanRows" :key="r.id" class="border-t border-slate-100 hover:bg-orange-50">
                                            <td class="px-4 py-3 font-medium">{{ formatBilanDate(r.date) }}</td>
                                            <td class="px-4 py-3 font-bold">{{ r.agence }}</td>
                                            <td class="px-4 py-3">{{ getUrgentRdvClient(r) }}</td>
                                            <td class="px-4 py-3">{{ getUrgentRdvPhone(r) }}</td>
                                            <td class="px-4 py-3">
                                                <a v-if="r.googleCalendarEventId" :href="`https://calendar.google.com/calendar/r/eventedit/${r.googleCalendarEventId}`" target="_blank" class="text-blue-600 hover:text-blue-800 font-bold text-sm flex items-center gap-1">
                                                    <i class="fa-solid fa-external-link"></i> Voir Agenda
                                                </a>
                                                <span v-else class="text-slate-400 text-sm">N/A</span>
                                            </td>
                                            <td class="px-4 py-3">
                                                <button @click="openUrgentCommercialModal(r)" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-xl font-bold text-sm flex items-center gap-2">
                                                    <i class="fa-solid fa-check"></i> J'ai le commercial
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div v-if="urgentBilanRows.length === 0" class="text-center py-12 text-slate-400">
                                <i class="fa-solid fa-check-circle text-4xl mb-3 text-green-500"></i>
                                <p class="font-bold">Aucun RDV urgent √† traiter</p>
                            </div>
                        </div>
                    </div>

                    <!-- Onglet Objectifs -->
                    <div v-if="bilanTab==='objectifs'" class="space-y-6">
                        <h2 class="text-2xl md:text-3xl font-bold text-green-600 mb-6 flex items-center gap-3">
                            <i class="fa-solid fa-bullseye text-green-500"></i>
                            Objectifs par Agence / Commercial
                        </h2>

                        <!-- Filtres et s√©lection -->
                        <div class="bg-white rounded-2xl shadow-lg border border-slate-200 p-4 md:p-6 mb-6">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">P√©riode</label>
                                    <select v-model="objectifsFilters.mois" @change="updateObjectifsStats" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-green-500 outline-none text-sm md:text-base">
                                        <option value="">Tous les mois</option>
                                        <option v-for="opt in bilanMonthOptions" :key="opt.value" :value="opt.value">{{ opt.label }}</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Agence</label>
                                    <select v-model="objectifsFilters.agence" @change="updateObjectifsStats" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-green-500 outline-none text-sm md:text-base">
                                        <option value="">Toutes les agences</option>
                                        <option v-for="ag in agences" :key="ag.id" :value="ag.id">{{ ag.nom }}</option>
                                    </select>
                                </div>
                                <div class="flex items-end">
                                    <button @click="openObjectifModal(null)" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2">
                                        <i class="fa-solid fa-plus"></i> D√©finir un objectif
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Statistiques par agence -->
                        <div class="space-y-6">
                            <div v-for="agStat in objectifsStats" :key="agStat.agenceId" class="bg-white rounded-3xl shadow-xl border-2 border-slate-200 overflow-hidden hover:shadow-2xl transition-all duration-300">
                                <div class="p-6 bg-gradient-to-br from-green-500 via-blue-500 to-purple-600 border-b-4 border-blue-400">
                                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                                        <div class="flex items-center gap-4">
                                            <div class="w-16 h-16 rounded-2xl bg-white/20 backdrop-blur-sm flex items-center justify-center shadow-xl">
                                                <i class="fa-solid fa-building text-white text-2xl"></i>
                                            </div>
                                            <div>
                                                <h3 class="text-2xl md:text-3xl font-black text-white mb-2 drop-shadow-lg">{{ agStat.agenceNom }}</h3>
                                                <div class="flex flex-wrap gap-4 text-sm">
                                                    <div class="bg-white/20 backdrop-blur-sm px-3 py-1.5 rounded-lg">
                                                        <span class="text-white/90">Total RDV:</span>
                                                        <span class="font-black text-white ml-2 text-lg">{{ agStat.totalRdv }}</span>
                                                    </div>
                                                    <div v-if="agStat.objectifAgence" class="bg-white/20 backdrop-blur-sm px-3 py-1.5 rounded-lg">
                                                        <span class="text-white/90">Objectif:</span>
                                                        <span class="font-black text-white ml-2 text-lg">{{ agStat.objectifAgence }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="flex gap-3 flex-shrink-0">
                                            <button @click="openObjectifModal(agStat.agenceId, null)" class="bg-white hover:bg-blue-50 text-blue-600 px-5 py-3 rounded-xl font-bold text-sm flex items-center gap-2 shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
                                                <i class="fa-solid fa-bullseye"></i> <span class="hidden sm:inline">Objectif</span>
                                            </button>
                                            <button @click="openTarifPersonnaliseModal(agStat.agenceId)" class="bg-white hover:bg-purple-50 text-purple-600 px-5 py-3 rounded-xl font-bold text-sm flex items-center gap-2 shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
                                                <i class="fa-solid fa-euro-sign"></i> <span class="hidden sm:inline">Tarifs</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- D√©tail par commercial -->
                                <div class="p-4 md:p-6">
                                    <div v-if="agStat.commerciaux && agStat.commerciaux.length > 0" class="space-y-3">
                                        <div v-for="comm in agStat.commerciaux" :key="comm.nom" class="group relative bg-gradient-to-r from-white to-slate-50 rounded-2xl border-2 border-slate-200 hover:border-blue-300 transition-all duration-300 shadow-sm hover:shadow-md p-5">
                                            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                                                <div class="flex-1 min-w-0">
                                                    <div class="flex items-center gap-3 mb-2">
                                                        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center shadow-lg">
                                                            <i class="fa-solid fa-user text-white text-sm"></i>
                                                        </div>
                                                        <div>
                                                            <div class="font-black text-lg text-slate-800">{{ comm.nom || 'Agence (Direct)' }}</div>
                                                            <div class="flex flex-wrap gap-3 text-sm mt-1">
                                                                <div class="flex items-center gap-1.5">
                                                                    <span class="text-slate-500">RDV:</span>
                                                                    <span class="font-bold text-slate-800 bg-blue-50 px-2 py-0.5 rounded-lg">{{ comm.rdv }}</span>
                                                                </div>
                                                                <div v-if="comm.objectif" class="flex items-center gap-1.5">
                                                                    <span class="text-slate-500">Objectif:</span>
                                                                    <span class="font-bold text-slate-800 bg-purple-50 px-2 py-0.5 rounded-lg">{{ comm.objectif }}</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="flex items-center gap-4 flex-shrink-0">
                                                    <div class="text-center min-w-[140px]">
                                                        <div v-if="comm.objectif" class="text-xs font-bold text-slate-500 uppercase mb-2 tracking-wide">Progression</div>
                                                        <div class="flex items-center gap-3">
                                                            <div class="w-32 bg-slate-200 rounded-full h-4 overflow-hidden shadow-inner">
                                                                <div :class="getObjectifProgressClass(comm.rdv, comm.objectif)" 
                                                                     :style="{ width: getObjectifProgressPercent(comm.rdv, comm.objectif) + '%' }" 
                                                                     class="h-full transition-all duration-500 rounded-full shadow-sm"></div>
                                                            </div>
                                                            <span :class="getObjectifStatusClass(comm.rdv, comm.objectif)" class="text-base font-black min-w-[45px]">
                                                                {{ getObjectifProgressPercent(comm.rdv, comm.objectif) }}%
                                                            </span>
                                                        </div>
                                                        <div v-if="comm.objectif" class="mt-2">
                                                            <span :class="comm.rdv >= comm.objectif ? 'bg-green-100 text-green-700 border-green-300' : 'bg-orange-100 text-orange-700 border-orange-300'" 
                                                                  class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-bold border-2">
                                                                <i :class="comm.rdv >= comm.objectif ? 'fa-solid fa-check-circle' : 'fa-solid fa-clock'"></i>
                                                                {{ comm.rdv >= comm.objectif ? 'Objectif atteint' : 'En cours' }}
                                                            </span>
                                                        </div>
                                                    </div>
                                                    <button @click="openObjectifModal(agStat.agenceId, comm.nom)" class="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white px-5 py-2.5 rounded-xl font-bold text-sm flex items-center gap-2 shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
                                                        <i class="fa-solid fa-edit"></i> <span class="hidden sm:inline">Modifier</span>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div v-else class="text-center py-12 text-slate-400 bg-gradient-to-br from-slate-50 to-white rounded-xl border-2 border-dashed border-slate-200">
                                        <i class="fa-solid fa-users text-5xl mb-3 text-slate-300"></i>
                                        <p class="font-bold text-slate-500">Aucun commercial dans cette agence</p>
                                    </div>
                                </div>
                            </div>

                            <div v-if="objectifsStats.length === 0" class="text-center py-12 text-slate-400 bg-white rounded-2xl border border-slate-200">
                                <i class="fa-solid fa-bullseye text-4xl mb-3"></i>
                                <p class="font-bold">Aucune donn√©e disponible</p>
                                <p class="text-sm mt-2">D√©finissez des objectifs pour commencer</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VUE √Ä TRAITER POUR PROSPECTEURS -->
                <div v-if="view==='a_traiter' && user.role !== 'admin'" class="max-w-7xl mx-auto space-y-6 fade-in">
                    <h2 class="text-2xl md:text-3xl font-bold text-orange-600 mb-6 flex items-center gap-3">
                        <i class="fa-solid fa-exclamation-triangle text-orange-500"></i>
                        √Ä traiter urgent
                    </h2>
                    <p class="text-slate-600 mb-4">RDV honor√©s n√©cessitant l'assignation d'un commercial. V√©rifiez l'agenda Google Calendar du professionnel pour identifier le commercial.</p>
                    
                    <div class="bg-white rounded-2xl shadow-lg border border-orange-200 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-orange-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase">Date</th>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase">Agence</th>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase">Client</th>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase">T√©l√©phone</th>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase">Voir Agenda</th>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="r in prospecteurUrgentRows" :key="r.id" class="border-t border-slate-100 hover:bg-orange-50">
                                        <td class="px-4 py-3 font-medium">{{ formatBilanDate(r.date) }}</td>
                                        <td class="px-4 py-3 font-bold">{{ r.agence }}</td>
                                        <td class="px-4 py-3">{{ getUrgentRdvClient(r) }}</td>
                                        <td class="px-4 py-3">{{ getUrgentRdvPhone(r) }}</td>
                                        <td class="px-4 py-3">
                                            <a v-if="r.googleCalendarEventId" :href="`https://calendar.google.com/calendar/r/eventedit/${r.googleCalendarEventId}`" target="_blank" class="text-blue-600 hover:text-blue-800 font-bold text-sm flex items-center gap-1">
                                                <i class="fa-solid fa-external-link"></i> Voir Agenda
                                            </a>
                                            <span v-else class="text-slate-400 text-sm">N/A</span>
                                        </td>
                                        <td class="px-4 py-3">
                                            <button @click="openUrgentCommercialModal(r)" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-xl font-bold text-sm flex items-center gap-2">
                                                <i class="fa-solid fa-check"></i> J'ai le commercial
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div v-if="prospecteurUrgentRows.length === 0" class="text-center py-12 text-slate-400">
                            <i class="fa-solid fa-check-circle text-4xl mb-3 text-green-500"></i>
                            <p class="font-bold">Aucun RDV urgent √† traiter</p>
                        </div>
                    </div>
                </div>

                <!-- VUE CONNEXIONS -->
                <div v-if="view==='connexions' && user.role==='admin'" class="max-w-5xl mx-auto space-y-6 fade-in">
                    <div class="bg-gradient-to-br from-blue-50 to-purple-50 rounded-2xl p-6 border-2 border-blue-200 mb-6">
                        <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-3 mb-2">
                            <i class="fa-solid fa-users text-blue-600"></i>
                            Suivi des connexions
                        </h2>
                        <p class="text-sm text-slate-600">Cliquez sur un utilisateur connect√© pour voir son historique</p>
                    </div>
                    
                    <!-- Utilisateurs actuellement connect√©s -->
                    <div class="bg-white rounded-2xl shadow-lg border-2 border-green-200 p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-bold text-lg text-green-700 flex items-center gap-2">
                                <i class="fa-solid fa-circle text-green-500 text-xs"></i>
                                Actuellement connect√©s ({{ connectedUsers.length }})
                            </h3>
                            <button @click="loadConnexionsHistory" :disabled="loadingConnexions" :class="loadingConnexions ? 'opacity-50 cursor-not-allowed' : ''" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl font-bold text-sm transition flex items-center gap-2">
                                <i :class="loadingConnexions ? 'fa-solid fa-spinner fa-spin' : 'fa-solid fa-sync-alt'"></i>
                                {{ loadingConnexions ? 'Chargement...' : 'Actualiser' }}
                            </button>
                        </div>
                        <div v-if="connectedUsers.length === 0" class="text-center py-8 text-slate-400">
                            <i class="fa-solid fa-user-slash text-4xl mb-2 block opacity-50"></i>
                            <p>Aucun utilisateur connect√©</p>
                        </div>
                        <div v-else class="space-y-3">
                            <div v-for="user in connectedUsers" :key="user.name" @click="openUserHistoryModal(user)" class="bg-green-50 rounded-xl p-4 border border-green-200 flex items-center justify-between cursor-pointer hover:bg-green-100 hover:border-green-300 transition transform hover:scale-[1.02]">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center text-white font-bold">
                                        {{ user.name.charAt(0).toUpperCase() }}
                                    </div>
                                    <div>
                                        <div class="font-bold text-slate-800">{{ user.name }}</div>
                                        <div class="text-xs text-slate-500">Connect√© depuis {{ user.connecteDepuis }}</div>
                                    </div>
                                </div>
                                <div class="text-right flex items-center gap-3">
                                    <div>
                                        <div class="text-xs text-green-600 font-bold">En ligne</div>
                                        <div class="text-xs text-slate-500">{{ user.heureConnexion }}</div>
                                    </div>
                                    <i class="fa-solid fa-chevron-right text-green-500"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div v-if="view==='rappels' || view==='confirmations'" class="max-w-3xl mx-auto space-y-4 fade-in">
    <div class="flex items-center gap-3 mb-6">
        <div class="w-12 h-12 bg-gradient-to-br rounded-xl flex items-center justify-center shadow-lg" :class="view==='rappels' ? 'from-red-500 to-red-600' : 'from-orange-500 to-orange-600'">
            <i :class="view==='rappels' ? 'fa-solid fa-bell' : 'fa-solid fa-calendar-check'" class="text-white text-xl"></i>
        </div>
        <h2
            class="text-xl md:text-2xl font-bold"
            :class="view==='rappels' ? 'text-red-600' : 'text-orange-600'"
        >
            {{ view==='rappels' ? 'Rappels √† effectuer' : 'Rendez-vous √† confirmer' }}
        </h2>
    </div>

    <!-- üî¥ Filtres internes uniquement pour l'onglet Rappels -->
    <div v-if="view==='rappels'" class="bg-gradient-to-br from-white via-red-50/30 to-white rounded-2xl border-2 border-red-200/80 p-4 md:p-5 mb-4 shadow-lg space-y-3 backdrop-blur-sm relative z-10">
        <!-- Onglets Aujourd'hui / Demain (Veille) -->
        <div class="flex gap-2">
            <button
                @click.stop.prevent="rappelFilters.day = 'today'"
                type="button"
                class="flex-1 px-4 py-2.5 rounded-xl text-xs font-bold uppercase tracking-wide border-2 transition-all duration-200 shadow-sm relative z-10"
                :class="rappelFilters.day === 'today'
                    ? 'bg-gradient-to-r from-red-600 to-red-700 text-white border-red-600 shadow-lg shadow-red-200 scale-105'
                    : 'bg-white text-red-600 border-red-200 hover:bg-red-50 hover:border-red-300 hover:shadow-md'"
            >
                <i class="fa-solid fa-calendar-day mr-1"></i> Aujourd'hui <span class="ml-1 px-2 py-0.5 rounded-full text-[10px] font-bold" :class="rappelFilters.day === 'today' ? 'bg-white/20 text-white' : 'bg-red-100 text-red-600'">{{ rappelsJourCount }}</span>
            </button>
            <button
                @click.stop.prevent="rappelFilters.day = 'tomorrow'"
                type="button"
                class="flex-1 px-4 py-2.5 rounded-xl text-xs font-bold uppercase tracking-wide border-2 transition-all duration-200 shadow-sm relative z-10"
                :class="rappelFilters.day === 'tomorrow'
                    ? 'bg-gradient-to-r from-red-600 to-red-700 text-white border-red-600 shadow-lg shadow-red-200 scale-105'
                    : 'bg-white text-red-600 border-red-200 hover:bg-red-50 hover:border-red-300 hover:shadow-md'"
            >
                <i class="fa-solid fa-calendar-plus mr-1"></i> Demain <span class="ml-1 px-2 py-0.5 rounded-full text-[10px] font-bold" :class="rappelFilters.day === 'tomorrow' ? 'bg-white/20 text-white' : 'bg-red-100 text-red-600'">{{ rappelsVeilleCount }}</span>
            </button>
        </div>

        <!-- Filtres Agence / Cr√©√© par -->
        <div class="flex flex-wrap gap-2 items-center">
            <div class="relative flex-1 min-w-[150px]">
                <select
                    v-model="rappelFilters.agenceId"
                    class="appearance-none bg-white border-2 border-red-200 px-3 py-2 pr-8 rounded-xl text-xs font-bold text-slate-700 outline-none focus:border-red-500 focus:ring-2 focus:ring-red-200 shadow-sm transition-all"
                >
                    <option value="">Toutes les agences</option>
                    <option v-for="ag in visibleAgencies" :key="ag.id" :value="ag.id">
                        {{ ag.nom }}
                    </option>
                </select>
                <i class="fa-solid fa-chevron-down absolute right-3 top-2.5 text-[10px] text-red-400 pointer-events-none"></i>
            </div>

            <div class="relative flex-1 min-w-[150px]">
                <select v-if="user.role === 'admin'"
                    v-model="rappelFilters.userId"
                    class="appearance-none bg-white border-2 border-red-200 px-3 py-2 pr-8 rounded-xl text-xs font-bold text-slate-700 outline-none focus:border-red-500 focus:ring-2 focus:ring-red-200 shadow-sm transition-all"
                >
                    <option value="">Tous les utilisateurs</option>
                    <option v-for="u in allProspectors" :key="u" :value="u">
                        {{ u }}
                    </option>
                </select>
                <i v-if="user.role === 'admin'" class="fa-solid fa-chevron-down absolute right-3 top-2.5 text-[10px] text-red-400 pointer-events-none"></i>
            </div>

            <button
                v-if="rappelFilters.day !== 'today' || rappelFilters.agenceId || rappelFilters.userId"
                @click="rappelFilters.day = 'today'; rappelFilters.agenceId=''; rappelFilters.userId='';"
                class="px-4 py-2 rounded-xl text-xs font-bold text-red-600 border-2 border-red-300 bg-white hover:bg-red-50 hover:border-red-400 transition-all shadow-sm"
            >
                <i class="fa-solid fa-rotate-left mr-1"></i> R√©initialiser
            </button>
        </div>
    </div>

    <!-- Message "Tout est √† jour" -->
    <div
        v-if="(view==='rappels' && rappelsDisplay.length === 0) ||
               (view==='confirmations' && confirmList.length === 0)"
        class="bg-white p-10 rounded-2xl text-center text-gray-400 border border-slate-100 shadow-sm"
    >
        <i class="fa-solid fa-check-circle text-4xl mb-2 text-green-500"></i><br>
        Tout est √† jour !
    </div>

    <!-- Liste des rappels / confirmations -->
    <!-- AJOUT CLICK SUR LIGNE ET CLICK STOP SUR BOUTONS -->
    <div
        v-for="r in (view==='rappels' ? rappelsDisplay : confirmList)"
        :key="r.id"
        @click="openRdvFiche(r)"
        class="bg-gradient-to-br from-white via-purple-50/20 to-white p-4 md:p-6 rounded-xl md:rounded-2xl shadow-md border-l-4 flex flex-col md:flex-row justify-between items-start md:items-center hover:shadow-xl hover:scale-[1.01] transition-all duration-200 gap-4 cursor-pointer backdrop-blur-sm"
        :class="view==='rappels' ? 'border-red-500 hover:border-red-600' : 'border-orange-500 hover:border-orange-600'"
    >
        <div class="flex-1">
            <div class="flex items-center gap-2 mb-2">
                <div class="font-bold text-lg text-slate-800">
                    {{ r.civilite }} {{ r.nom }}
                </div>
                <div class="w-2 h-2 rounded-full animate-pulse" :class="view==='rappels' ? 'bg-red-500' : 'bg-orange-500'"></div>
            </div>
            <div class="flex flex-wrap items-center gap-2 text-sm text-slate-600 mb-2">
                <span class="flex items-center gap-1">
                    <i class="fa-solid fa-calendar text-purple-500"></i>
                    {{ formatDateFr(r.date) }}
                </span>
                <span class="text-slate-400">‚Ä¢</span>
                <span class="flex items-center gap-1">
                    <i class="fa-solid fa-clock text-purple-500"></i>
                    {{ r.heure }}
                </span>
                <span class="text-slate-400">‚Ä¢</span>
                <span class="flex items-center gap-1">
                    <i class="fa-solid fa-car text-purple-500"></i>
                    {{ r.modele }}
                </span>
            </div>
            <div class="inline-flex items-center gap-1 px-3 py-1 bg-gradient-to-r from-purple-100 to-purple-50 rounded-lg border border-purple-200">
                <i class="fa-solid fa-building text-purple-600 text-xs"></i>
                <span class="text-xs font-bold text-purple-700">{{ getAgenceName(r.agenceId) }}</span>
            </div>
        </div>

        <div class="flex flex-wrap gap-2 w-full md:w-auto" @click.stop>
            <a
                :href="generateMsgLink(r, view==='rappels' ? getRappelType(r) : 'confirm')"
                target="_blank"
                class="flex-1 md:flex-none justify-center bg-gradient-to-r from-slate-700 to-slate-800 text-white px-4 py-2.5 rounded-xl font-bold hover:from-slate-800 hover:to-slate-900 flex items-center gap-2 shadow-lg shadow-slate-200 transition-all"
            >
                <i class="fa-solid fa-comment-sms"></i>
                <span class="hidden md:inline">{{ view==='rappels' ? getRappelLabel(r) : 'Envoyer la confirmation' }}</span>
                <span class="md:hidden">{{ view==='rappels' ? 'Rappel' : 'Confirmer' }}</span>
            </a>

            <button
                v-if="view==='confirmations' && !r.dansAgenda"
                @click.stop="handleAddToAgendaClick(r)"
                class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-4 py-2.5 rounded-xl font-bold hover:from-blue-600 hover:to-blue-700 shadow-lg shadow-blue-200 flex items-center gap-2 transition transform active:scale-95"
                title="Ajouter √† l'agenda"
            >
                <i class="fa-solid fa-calendar-plus"></i>
                <span class="hidden md:inline">Agenda</span>
            </button>

            <button
                @click.stop="validateAction(r, view)"
                class="bg-gradient-to-r from-green-500 to-green-600 text-white px-4 py-2.5 rounded-xl font-bold hover:from-green-600 hover:to-green-700 shadow-lg shadow-green-200 transition transform active:scale-95"
            >
                <i class="fa-solid fa-check"></i>
            </button>

            <button
                v-if="view==='confirmations'"
                @click.stop="quickCancel(r)"
                class="bg-white text-red-500 border-2 border-red-300 px-4 py-2.5 rounded-xl font-bold hover:bg-red-50 hover:border-red-400 transition shadow-sm"
            >
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
    </div>
</div>

    <!-- MODALE APER√áU MESSAGE -->
    <div v-if="messagePreviewModal.open" class="fixed inset-0 bg-slate-900/80 z-[500] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden flex flex-col">
            <div class="bg-gradient-to-r from-purple-500 to-purple-600 px-6 py-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <i class="fa-solid fa-eye text-white text-xl"></i>
                    <h3 class="text-white font-bold text-lg">{{ messagePreviewModal.title }}</h3>
                </div>
                <button @click="messagePreviewModal.open=false" class="w-8 h-8 rounded-full hover:bg-white/20 flex items-center justify-center transition text-white">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto flex-1">
                <div class="bg-gradient-to-br from-slate-50 to-purple-50/30 border-2 border-purple-200 rounded-xl p-6">
                    <div class="bg-white p-4 rounded-lg border-2 border-purple-300 shadow-inner">
                        <div class="text-slate-800 whitespace-pre-line font-medium leading-relaxed">{{ messagePreviewModal.message }}</div>
                    </div>
                </div>
            </div>
            <div class="px-6 py-4 bg-slate-50 border-t border-slate-200 flex gap-3">
                <button @click="messagePreviewModal.open=false" class="flex-1 bg-slate-200 text-slate-700 py-3 rounded-xl font-bold hover:bg-slate-300 transition">
                    Fermer
                </button>
            </div>
        </div>
    </div>
    
    <!-- FIX Z-INDEX MODALE CLIENT -->
    <!-- FICHE RENDEZ-VOUS SIMPLIFI√âE -->
    <div v-if="clientModal.open" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[300] flex items-center justify-center p-0 md:p-4 animate-fadeIn">
        <div class="bg-white w-full h-full md:w-full md:max-w-2xl md:h-[90vh] md:rounded-3xl shadow-2xl overflow-hidden flex flex-col relative">
            
            <!-- BANDEAU STATUT -->
            <div v-if="getRdvTimeStatus(clientModal.rdv) === 'en_cours'" class="absolute top-3 left-3 z-20 bg-gradient-to-r from-emerald-500 to-green-600 text-white px-2 py-1 rounded-lg font-bold text-xs flex items-center gap-1">
                <i class="fa-solid fa-circle-dot animate-pulse"></i>
            </div>
            <div v-else-if="getRdvTimeStatus(clientModal.rdv) === 'bientot'" class="absolute top-3 left-3 z-20 bg-gradient-to-r from-amber-500 to-orange-500 text-white px-2 py-1 rounded-lg font-bold text-xs flex items-center gap-1">
                <i class="fa-solid fa-clock"></i>
            </div>
            <!-- HEADER MODERNE -->
            <div class="relative bg-gradient-to-br from-purple-500 via-purple-600 to-purple-700 text-white shadow-2xl">
                <div class="absolute top-3 right-3 flex gap-2 z-20">
                    <button @click="openEdit(clientModal.rdv)" class="w-9 h-9 bg-white/20 hover:bg-white/30 backdrop-blur-md rounded-xl flex items-center justify-center transition-all shadow-lg" title="Modifier">
                        <i class="fa-solid fa-pencil text-xs"></i>
                    </button>
                    <button @click="softDeleteRdv(clientModal.rdv)" class="w-9 h-9 bg-red-500/90 hover:bg-red-600 backdrop-blur-md rounded-xl flex items-center justify-center transition-all shadow-lg" title="Supprimer">
                        <i class="fa-solid fa-trash-can text-xs"></i>
                    </button>
                    <button @click="clientModal.open=false" class="w-9 h-9 bg-white/20 hover:bg-white/30 backdrop-blur-md rounded-xl flex items-center justify-center transition-all shadow-lg">
                        <i class="fa-solid fa-times text-sm"></i>
                    </button>
                </div>

                <div class="relative z-10 p-5 md:p-6">
                    <div class="flex items-center gap-4">
                        <div class="relative flex-shrink-0">
                            <div :class="{'ring-4 ring-emerald-400 animate-pulse shadow-2xl shadow-emerald-300': getRdvTimeStatus(clientModal.rdv)==='en_cours'}" class="w-20 h-20 md:w-24 md:h-24 bg-white/20 backdrop-blur-xl border-4 border-white/50 rounded-2xl flex items-center justify-center text-3xl md:text-4xl font-black shadow-2xl">
                                {{ clientModal.rdv.civilite === 'M.' ? 'M' : 'F' }}
                            </div>
                            <div v-if="clientModal.rdv.rappelFait" class="absolute -top-1 -right-1 w-6 h-6 bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-full flex items-center justify-center border-3 border-white shadow-lg">
                                <i class="fa-solid fa-bell text-white text-[9px]"></i>
                            </div>
                        </div>
                        
                        <div class="flex-1 min-w-0">
                            <h1 class="text-2xl md:text-3xl font-black text-white mb-2 drop-shadow-lg">
                                {{ clientModal.rdv.nom }}
                            </h1>
                            
                            <div class="flex items-center gap-2 mb-3 flex-wrap">
                                <span :class="statusClass(clientModal.rdv.statut)" class="px-3 py-1 rounded-full text-xs font-bold uppercase shadow-md">
                                    {{ displayStatus(clientModal.rdv) }}
                                </span>
                                <span v-if="clientModal.rdv.tag === 'OK M'" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-3 py-1 rounded-full text-xs font-bold shadow-md">
                                    OK M
                                </span>
                                <span v-if="clientModal.rdv.rappelFait" class="bg-gradient-to-r from-emerald-500 to-emerald-600 text-white px-3 py-1 rounded-full text-xs font-bold shadow-md flex items-center gap-1">
                                    <i class="fa-solid fa-bell text-[9px]"></i>
                                    Rappel
                                </span>
                            </div>

                            <div class="flex items-center gap-2 flex-wrap">
                                <a :href="'tel:' + normalizePhone(clientModal.rdv.telephone)" class="bg-white/20 hover:bg-white/30 backdrop-blur-md text-white px-4 py-2 rounded-xl font-bold text-xs transition-all flex items-center gap-2 shadow-lg">
                                    <i class="fa-solid fa-phone"></i>
                                    <span class="font-mono">{{ clientModal.rdv.telephone }}</span>
                                </a>
                                <a :href="generateMsgLink(clientModal.rdv, 'confirm')" target="_blank" class="bg-white/15 hover:bg-white/25 backdrop-blur-md text-white px-3 py-1.5 rounded-xl font-bold text-[10px] transition-all flex items-center gap-1.5 shadow-md" title="Renvoyer la confirmation au client">
                                    <i class="fa-solid fa-message"></i>
                                    <span class="hidden sm:inline">Renvoyer confirmation</span>
                                    <span class="sm:hidden">Renvoyer</span>
                                </a>
                                <button @click="handleSendRappel(clientModal.rdv)" class="bg-white/15 hover:bg-white/25 backdrop-blur-md text-white px-3 py-1.5 rounded-xl font-bold text-[10px] transition-all flex items-center gap-1.5 shadow-md" title="Envoyer un rappel au client">
                                    <i class="fa-solid fa-bell"></i>
                                    <span class="hidden sm:inline">Envoyer rappel</span>
                                    <span class="sm:hidden">Rappel</span>
                                </button>
                                <div v-if="clientModal.rdv?.dansAgenda" class="bg-gradient-to-r from-green-500 to-green-600 text-white px-3 py-1.5 rounded-xl font-bold text-xs flex items-center gap-1.5 shadow-lg">
                                    <i class="fa-solid fa-calendar-check"></i>
                                    <span>Agenda</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CONTENU PRINCIPAL -->
            <div v-if="clientModal.view === 'main'" class="flex-1 overflow-y-auto p-3 md:p-5 bg-gradient-to-br from-slate-50 via-purple-50/20 to-slate-50">
                <!-- INFORMATIONS PRINCIPALES - VERSION SIMPLIFI√âE -->
                <div class="bg-white rounded-xl shadow-md border border-purple-100 p-3 md:p-4 mb-3">
                    <div class="space-y-3">
                        <!-- V√©hicule -->
                        <div>
                            <div class="text-[10px] font-bold text-purple-600 uppercase mb-1 flex items-center gap-1">
                                <i class="fa-solid fa-car text-purple-500"></i>
                                V√©hicule
                            </div>
                            <div v-if="getBaseModele(clientModal.rdv.modele)" class="text-sm font-black text-slate-800 mb-2">{{ getBaseModele(clientModal.rdv.modele) }}</div>
                            <div v-if="formatCaracteristiquesForDisplay(clientModal.rdv.modele).caracteristiques.length > 0" class="text-xs text-slate-700 space-y-1 pt-2 border-t border-purple-100">
                                <div v-for="(carac, idx) in formatCaracteristiquesForDisplay(clientModal.rdv.modele).caracteristiques" :key="idx" class="flex items-start">
                                    <span class="font-bold text-slate-800 w-32 md:w-36 flex-shrink-0 text-right pr-2">{{ carac.label }}</span>
                                    <span class="text-slate-600 flex-shrink-0">:</span>
                                    <span class="text-slate-600 ml-2">{{ carac.value }}</span>
                        </div>
                            </div>
                            <div v-else-if="!getBaseModele(clientModal.rdv.modele)" class="text-sm font-black text-slate-800">{{ clientModal.rdv.modele || 'Non sp√©cifi√©' }}</div>
                            </div>
                        
                        <!-- Informations en ligne compacte -->
                        <div class="grid grid-cols-2 gap-2 pt-2 border-t border-purple-100">
                            <div>
                                <div class="text-[9px] font-bold text-slate-500 uppercase mb-0.5">Source</div>
                                <div class="flex items-center gap-1.5">
                                    <img v-if="clientModal.rdv.source && clientModal.rdv.source.trim() && getLogo(clientModal.rdv.source)" :src="getLogo(clientModal.rdv.source)" class="w-3 h-3 rounded" @error="$event.target.style.display='none'" @load="$event.target.style.display='block'">
                                    <span class="text-xs font-bold text-slate-800">{{ clientModal.rdv.source || 'N/A' }}</span>
                                    <button v-if="clientModal.rdv.rappelSent" @click.stop class="ml-1 text-green-600 hover:text-green-700 transition cursor-default" :title="'Rappel envoy√© le ' + formatDateFr(clientModal.rdv.rappelSent.date) + ' √† ' + clientModal.rdv.rappelSent.heure + ' par ' + (clientModal.rdv.rappelSent.par || 'N/A')">
                                        <i class="fa-solid fa-bell text-xs"></i>
                                    </button>
                        </div>
                            </div>
                            <div>
                                <div class="text-[9px] font-bold text-slate-500 uppercase mb-0.5">Agence</div>
                                <div class="text-xs font-bold text-slate-800">{{ getAgenceName(clientModal.rdv.agenceId) || 'N/A' }}</div>
                        </div>
                            <div class="col-span-2">
                                <div class="text-[9px] font-bold text-slate-500 uppercase mb-0.5">Date & Heure</div>
                                <div class="text-xs font-bold text-slate-800">{{ formatDateFr(clientModal.rdv.date) }} √† {{ clientModal.rdv.heure }}</div>
                            </div>
                        </div>
                            </div>
                    
                    <div class="flex gap-2 mt-3 pt-3 border-t border-purple-100">
                        <button @click="openRescheduleModal(clientModal.rdv)" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg font-bold text-xs transition-all flex items-center justify-center gap-1.5">
                            <i class="fa-solid fa-calendar-days text-[10px]"></i>
                        Reporter
                    </button>
                    </div>
                </div>

                <!-- BOUTON HISTORIQUE -->
                <button @click="clientModal.view='history'" class="w-full bg-gradient-to-br from-white via-purple-50/30 to-white rounded-2xl shadow-lg border-2 border-purple-200/80 p-4 mb-4 hover:shadow-xl hover:scale-[1.01] transition-all flex items-center justify-between group backdrop-blur-sm">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center shadow-md group-hover:shadow-lg transition">
                            <i class="fa-solid fa-clock-rotate-left text-white"></i>
                        </div>
                        <div class="text-left">
                            <div class="text-sm font-bold text-slate-800">Historique & Notes</div>
                            <div class="text-xs text-slate-500 font-medium">
                                {{ ((clientModal.rdv.notes || []).length + (clientModal.rdv.note && clientModal.rdv.note.trim() ? 1 : 0)) }} note{{ ((clientModal.rdv.notes || []).length + (clientModal.rdv.note && clientModal.rdv.note.trim() ? 1 : 0)) > 1 ? 's' : '' }}
                            </div>
                        </div>
                    </div>
                    <i class="fa-solid fa-chevron-right text-purple-400 group-hover:text-purple-600 group-hover:translate-x-1 transition"></i>
                </button>

                <!-- ACTIONS RAPIDES COMPACTES -->
                <div class="bg-gradient-to-br from-white via-purple-50/30 to-white rounded-2xl shadow-lg border-2 border-purple-200/80 p-4 md:p-5 backdrop-blur-sm">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-xl flex items-center justify-center shadow-md">
                            <i class="fa-solid fa-bolt text-white"></i>
                        </div>
                        <h3 class="text-sm font-bold text-slate-800 uppercase">Actions</h3>
                    </div>
                    <div class="flex items-center gap-2 flex-wrap">
                        <button @click="openHonorCheck(clientModal.rdv)" class="bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white px-4 py-2.5 rounded-xl transition-all flex items-center justify-center gap-2 shadow-md shadow-emerald-200 font-bold text-xs">
                            <i class="fa-solid fa-check-circle"></i>
                            <span>Honorer</span>
                        </button>
                        <button @click="updateStatus(clientModal.rdv, 'noshow')" class="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white px-4 py-2.5 rounded-xl transition-all flex items-center justify-center gap-2 shadow-md shadow-red-200 font-bold text-xs">
                            <i class="fa-solid fa-user-xmark"></i>
                            <span>Pas venu</span>
                        </button>
                        <button v-if="['honore','pas_venu','annule'].includes(clientModal.rdv.statut)" @click="updateStatus(clientModal.rdv, 'reset')" class="bg-gradient-to-r from-slate-400 to-slate-500 hover:from-slate-500 hover:to-slate-600 text-white px-4 py-2.5 rounded-xl font-bold text-xs transition-all flex items-center justify-center gap-2 shadow-md">
                            <i class="fa-solid fa-rotate-left"></i>
                            <span>Reset</span>
                        </button>
                        <button @click="openCancelChoice(clientModal.rdv)" class="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white px-4 py-2.5 rounded-xl transition-all flex items-center justify-center gap-2 shadow-md shadow-red-200 font-bold text-xs">
                            <i class="fa-solid fa-ban"></i>
                            <span>Annuler</span>
                        </button>
                    </div>
                    
                    <!-- BOUTONS AGENDA GOOGLE (toujours visibles) -->
                    <div class="mt-4 pt-4 border-t-2 border-purple-200/50">
                        <div class="flex items-center gap-2 mb-3">
                            <i class="fa-brands fa-google text-purple-600"></i>
                            <div class="text-xs font-bold text-slate-700 uppercase">Google Calendar</div>
                        </div>
                        <div class="flex gap-2">
                            <button 
                                v-if="!clientModal.rdv.dansAgenda" 
                                @click="handleAddToAgendaClick(clientModal.rdv)" 
                                class="flex-1 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white py-2.5 rounded-xl font-bold text-xs transition-all flex items-center justify-center gap-2 shadow-lg shadow-green-200">
                                <i class="fa-solid fa-plus"></i>
                                Ajouter √† l'agenda
                            </button>
                            <button 
                                v-else 
                                @click="handleRemoveFromAgendaClick(clientModal.rdv)" 
                                :disabled="clientModal.removingFromAgenda"
                                :class="clientModal.removingFromAgenda ? 'opacity-50 cursor-not-allowed' : 'hover:from-red-600 hover:to-red-700'"
                                class="flex-1 bg-gradient-to-r from-red-500 to-red-600 text-white py-2.5 rounded-xl font-bold text-xs transition-all flex items-center justify-center gap-2 shadow-lg shadow-red-200">
                                <i v-if="clientModal.removingFromAgenda" class="fa-solid fa-spinner fa-spin"></i>
                                <i v-else class="fa-solid fa-minus"></i>
                                {{ clientModal.removingFromAgenda ? 'Suppression...' : 'Retirer de l\'agenda' }}
                            </button>
                        </div>
                    </div>
                    <div v-if="clientModal.rdv.geste_commercial && user.role==='admin'" class="mt-4 bg-gradient-to-r from-red-50 to-red-100 border-2 border-red-300 p-3 rounded-xl text-center shadow-sm">
                        <div class="text-sm font-black text-red-700">
                            -{{ clientModal.rdv.geste_commercial }}‚Ç¨ ({{ clientModal.rdv.motif_geste }})
                        </div>
                        <button @click="removeDiscount" class="mt-2 text-xs text-red-500 hover:text-red-700 font-bold underline">Supprimer</button>
                    </div>
                </div>
            </div>

            <!-- VUE HISTORIQUE -->
            <div v-if="clientModal.view === 'history'" class="flex-1 overflow-y-auto p-5 bg-slate-50 flex flex-col">
                <div class="mb-4 flex items-center gap-3">
                    <button @click="clientModal.view='main'" class="w-8 h-8 bg-white rounded-lg flex items-center justify-center hover:bg-slate-100 transition border border-slate-200">
                        <i class="fa-solid fa-arrow-left text-slate-600 text-xs"></i>
                    </button>
                    <h3 class="text-sm font-bold text-slate-800 flex items-center gap-2">
                        <i class="fa-solid fa-clock-rotate-left text-blue-500"></i>
                        Historique & Notes
                    </h3>
                </div>

                <div class="flex-1 space-y-3 mb-4 overflow-y-auto">
                    <div v-if="clientModal.rdv.note && clientModal.rdv.note.trim()" class="bg-amber-50 border-l-4 border-amber-400 p-3 rounded-lg">
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <i class="fa-solid fa-note-sticky text-amber-600 text-xs"></i>
                                <span class="text-amber-800 font-bold text-xs">{{ clientModal.rdv.createdBy || 'Syst√®me' }}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-[10px] text-slate-500">{{ getCreatedDate(clientModal.rdv.created) }} {{ getCreatedTime(clientModal.rdv.created) }}</span>
                                <button v-if="user.role === 'admin'" @click="editMainNote(clientModal.rdv)" class="text-blue-400 hover:text-blue-600 transition" title="Modifier">
                                    <i class="fa-solid fa-pencil text-xs"></i>
                                </button>
                                <button v-if="user.role === 'admin'" @click="deleteMainNote(clientModal.rdv)" class="text-red-400 hover:text-red-600 transition" title="Supprimer">
                                    <i class="fa-solid fa-trash-can text-xs"></i>
                                </button>
                            </div>
                        </div>
                        <div class="text-sm text-amber-900">{{ clientModal.rdv.note }}</div>
                    </div>
                    <div v-if="(!clientModal.rdv.notes || clientModal.rdv.notes.length === 0) && (!clientModal.rdv.note || !clientModal.rdv.note.trim())" class="text-center text-slate-400 py-8">
                        <i class="fa-solid fa-inbox text-3xl mb-2 block"></i>
                        <p class="text-sm font-medium">Aucun historique</p>
                    </div>
                    <div v-for="(n, idx) in (clientModal.rdv.notes || [])" :key="idx" :class="n.type === 'rappel' ? 'bg-emerald-50 border-l-4 border-emerald-500' : 'bg-blue-50 border-l-4 border-blue-500'" class="p-3 rounded-lg">
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <i v-if="n.type === 'rappel'" class="fa-solid fa-bell text-emerald-600 text-xs"></i>
                                <i v-else class="fa-solid fa-note-sticky text-blue-600 text-xs"></i>
                                <span :class="n.type === 'rappel' ? 'text-emerald-800' : 'text-blue-800'" class="font-bold text-xs">{{ n.author || 'Syst√®me' }}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-[10px] text-slate-500">{{ n.date ? (new Date(n.date).toLocaleDateString('fr-FR', {day:'2-digit', month:'short'}) + ' ' + new Date(n.date).toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'})) : '' }}</span>
                                <button @click="deleteNote(clientModal.rdv, idx)" class="text-red-400 hover:text-red-600 transition" title="Supprimer">
                                    <i class="fa-solid fa-trash-can text-xs"></i>
                                </button>
                            </div>
                        </div>
                        <div :class="n.type === 'rappel' ? 'text-emerald-700' : 'text-slate-700'" class="text-sm font-medium">{{ n.text }}</div>
                    </div>
                </div>

                <div class="flex gap-2 pt-4 border-t border-slate-200">
                    <input v-model="newNoteText" @keyup.enter="addNote" placeholder="Ajouter une note..." class="flex-1 bg-white border border-slate-300 focus:border-blue-500 p-2.5 rounded-lg text-sm outline-none transition-all">
                    <button @click="addNote" class="bg-blue-500 hover:bg-blue-600 text-white w-10 h-10 rounded-lg flex items-center justify-center transition-all">
                        <i class="fa-solid fa-paper-plane text-xs"></i>
                    </button>
                </div>
                <button v-if="clientModal.rdv.rappelFait" @click="resendReminder(clientModal.rdv)" class="mt-2 w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg font-bold text-xs transition-all flex items-center justify-center gap-1.5">
                    <i class="fa-solid fa-bell text-xs"></i>
                    Renvoyer rappel
                </button>
            </div>

            <!-- FOOTER -->
            <div class="bg-slate-50 border-t border-slate-200 p-3 safe-area-bottom">
                <div class="text-[10px] text-slate-500 space-y-0.5 mb-2">
                    <div v-if="clientModal.rdv && getCreatedDate(clientModal.rdv)" class="flex items-center gap-1.5">
                        <i class="fa-solid fa-calendar-plus text-slate-400 text-[9px]"></i>
                        <span>Cr√©√© le {{ formatDateFr(getCreatedDate(clientModal.rdv)) }} √† {{ getCreatedTime(clientModal.rdv) }}</span>
                    </div>
                    <div v-if="clientModal.rdv && clientModal.rdv.createdBy" class="flex items-center gap-1.5">
                        <i class="fa-solid fa-user text-slate-400 text-[9px]"></i>
                        <span>Par {{ clientModal.rdv.createdBy }}</span>
                    </div>
                </div>
                <button @click="updateRdv(clientModal.rdv)" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2.5 rounded-lg font-bold text-sm transition-all flex items-center justify-center gap-2">
                    <i class="fa-solid fa-floppy-disk text-xs"></i>
                    Enregistrer
                </button>
            </div>

        </div>
    </div>

    <!-- MODALE GESTE COMMERCIAL Z-INDEX FIX -->
    <div v-if="discountModal.open" class="fixed inset-0 bg-slate-900/80 z-[350] flex items-center justify-center p-4 ">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-sm pop-in border border-slate-200 relative">
             <div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl shadow-lg">
                <i class="fa-solid fa-gift"></i>
            </div>
            <h3 class="font-bold text-2xl mb-6 text-slate-800 text-center">Geste Commercial</h3>
            
            <div class="space-y-4">
                <div>
                     <label class="text-xs font-bold text-gray-400 uppercase mb-1 block">Montant (‚Ç¨)</label>
                     <input type="number" v-model.number="discountModal.amount" class="w-full p-4 border-2 border-red-100 rounded-xl font-black text-red-600 text-center text-2xl outline-none focus:border-red-400" placeholder="0">
                </div>
                <div>
                     <label class="text-xs font-bold text-gray-400 uppercase mb-1 block">Motif</label>
                     <div class="grid grid-cols-1 gap-2 mb-2">
                         <button v-for="r in ['V√©hicule KO', 'Client pensait voir l\'acheteur', 'Autre']" 
                                 @click="discountModal.reason = r"
                                 :class="discountModal.reason === r ? 'bg-red-500 text-white shadow-md' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'"
                                 class="py-2 px-3 rounded-lg text-xs font-bold transition">
                             {{ r }}
                         </button>
                     </div>
                     <input v-if="discountModal.reason === 'Autre'" v-model="discountModal.customReason" placeholder="Pr√©cisez..." class="w-full p-3 border-2 border-slate-200 rounded-xl text-sm font-bold text-slate-700 outline-none focus:border-red-400">
                </div>
                <!-- Message d'erreur int√©gr√© -->
                <p v-if="discountModal.error" class="text-red-500 text-xs font-bold text-center animate-shake">{{ discountModal.error }}</p>
            </div>

            <div class="flex gap-3 mt-8">
                 <button @click="discountModal.open=false" class="flex-1 bg-gray-100 text-gray-500 py-3 rounded-xl font-bold hover:bg-gray-200">Annuler</button>
                 <button @click="saveDiscount" class="flex-1 bg-red-500 text-white py-3 rounded-xl font-bold hover:bg-red-600 shadow-lg transform active:scale-95">Valider</button>
            </div>
        </div>
    </div>

    <!-- MODAL POURBOIRE MODERNE -->
    <div v-if="tipModal.open" class="fixed inset-0 bg-slate-900/80 z-[400] flex items-center justify-center p-4 ">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden fade-in">
            <div class="bg-gradient-to-r from-purple-600 to-pink-600 p-6 text-white">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-white/20  rounded-xl flex items-center justify-center">
                            <i class="fa-solid fa-hand-holding-dollar text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-xl">Gestion Pourboire</h3>
                            <p class="text-purple-100 text-sm">{{ selectedProspecteur || user.name }}</p>
                        </div>
                    </div>
                    <button @click="tipModal.open=false" class="w-8 h-8 rounded-full hover:bg-white/20 flex items-center justify-center transition">
                        <i class="fa-solid fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6 space-y-6">
                <!-- Type d'op√©ration -->
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase mb-3 block">Type d'op√©ration</label>
                    <div class="grid grid-cols-2 gap-3">
                        <button 
                            @click="tipModal.operation = 'add'"
                            :class="tipModal.operation === 'add' ? 'bg-green-500 text-white shadow-lg' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'"
                            class="p-4 rounded-xl font-bold transition transform active:scale-95 flex items-center justify-center gap-2"
                        >
                            <i class="fa-solid fa-plus-circle"></i>
                            Ajouter
                        </button>
                        <button 
                            @click="tipModal.operation = 'remove'"
                            :class="tipModal.operation === 'remove' ? 'bg-red-500 text-white shadow-lg' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'"
                            class="p-4 rounded-xl font-bold transition transform active:scale-95 flex items-center justify-center gap-2"
                        >
                            <i class="fa-solid fa-minus-circle"></i>
                            Retirer
                        </button>
                    </div>
                </div>

                <!-- Montant -->
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Montant (‚Ç¨)</label>
                    <input 
                        type="number" 
                        v-model.number="tipModal.amount" 
                        placeholder="0.00"
                        step="0.01"
                        min="0"
                        class="w-full p-4 border-2 border-slate-200 rounded-xl font-bold text-slate-800 text-lg outline-none focus:border-purple-500 transition"
                    />
                </div>

                <!-- Motif -->
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Motif</label>
                    <select 
                        v-model="tipModal.reason" 
                        class="w-full p-4 border-2 border-slate-200 rounded-xl font-bold text-slate-800 outline-none focus:border-purple-500 bg-white"
                    >
                        <option value="">S√©lectionner un motif</option>
                        <option value="Client satisfait">Client satisfait</option>
                        <option value="Performance exceptionnelle">Performance exceptionnelle</option>
                        <option value="Bonus mensuel">Bonus mensuel</option>
                        <option value="Remboursement">Remboursement</option>
                        <option value="Ajustement">Ajustement</option>
                        <option value="Autre">Autre</option>
                    </select>
                    <input 
                        v-if="tipModal.reason === 'Autre'"
                        v-model="tipModal.customReason"
                        placeholder="Pr√©cisez le motif..."
                        class="w-full mt-3 p-3 border-2 border-slate-200 rounded-xl font-medium text-slate-700 outline-none focus:border-purple-500"
                    />
                </div>

                <!-- Note -->
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Note (optionnel)</label>
                    <textarea 
                        v-model="tipModal.note"
                        placeholder="Ajoutez une note ou un commentaire..."
                        rows="3"
                        class="w-full p-3 border-2 border-slate-200 rounded-xl font-medium text-slate-700 outline-none focus:border-purple-500 resize-none"
                    ></textarea>
                </div>

                <!-- Message d'erreur -->
                <p v-if="tipModal.error" class="text-red-500 text-sm font-bold text-center animate-shake bg-red-50 p-3 rounded-xl">
                    {{ tipModal.error }}
                </p>
            </div>

            <div class="bg-slate-50 p-6 flex gap-3 border-t border-slate-200">
                <button 
                    @click="tipModal.open=false" 
                    class="flex-1 bg-white text-slate-600 border-2 border-slate-200 py-3 rounded-xl font-bold hover:bg-slate-50 transition"
                >
                    Annuler
                </button>
                <button 
                    @click="saveTipTransaction" 
                    :class="tipModal.operation === 'add' ? 'bg-green-500 hover:bg-green-600' : 'bg-red-500 hover:bg-red-600'"
                    class="flex-1 text-white py-3 rounded-xl font-bold shadow-lg transform active:scale-95 transition"
                >
                    <i :class="tipModal.operation === 'add' ? 'fa-solid fa-plus' : 'fa-solid fa-minus'" class="mr-2"></i>
                    {{ tipModal.operation === 'add' ? 'Ajouter' : 'Retirer' }}
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL CONFIRMATION RAPPEL -->
    <div v-if="rappelConfirmModal.open" class="fixed inset-0 bg-slate-900/90 z-[500] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden fade-in">
            <div class="bg-gradient-to-r from-green-500 to-green-600 p-6 text-white">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                            <i class="fa-solid fa-bell text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-xl">Rappel envoy√©</h3>
                            <p class="text-green-100 text-sm">Le message a-t-il bien √©t√© envoy√© ?</p>
                        </div>
                    </div>
                    <button @click="rappelConfirmModal.open=false" class="w-8 h-8 rounded-full hover:bg-white/20 flex items-center justify-center transition">
                        <i class="fa-solid fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6 space-y-4">
                <div class="bg-blue-50 border-2 border-blue-200 rounded-xl p-4">
                    <p class="text-sm text-blue-800 font-bold text-center">
                        <i class="fa-solid fa-info-circle mr-2"></i>
                        Confirmez que le rappel a bien √©t√© envoy√© au client
                    </p>
                </div>
            </div>

            <div class="bg-slate-50 p-6 flex gap-3 border-t border-slate-200">
                <button 
                    @click="rappelConfirmModal.open=false" 
                    class="flex-1 bg-white text-slate-600 border-2 border-slate-200 py-3 rounded-xl font-bold hover:bg-slate-50 transition"
                >
                    Non
                </button>
                <a 
                    :href="rappelConfirmModal.smsLink" 
                    target="_blank"
                    @click="confirmRappelSent(rappelConfirmModal.rdv)"
                    class="flex-1 bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl font-bold shadow-lg transform active:scale-95 transition text-center flex items-center justify-center gap-2"
                >
                    <i class="fa-solid fa-check"></i>
                    Oui, envoy√©
                </a>
            </div>
        </div>
    </div>

    <!-- MODAL RDV RAPIDE -->
    <div v-if="quickRdvModal.open" class="fixed inset-0 bg-slate-900/90 z-[500] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden fade-in max-h-[90vh] overflow-y-auto">
            <div class="bg-gradient-to-r from-blue-500 to-blue-600 p-6 text-white">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                            <i class="fa-solid fa-plus-circle text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-xl">Ajouter RDV rapide</h3>
                            <p class="text-blue-100 text-sm">Cr√©er un rendez-vous rapidement</p>
                        </div>
                    </div>
                    <button @click="quickRdvModal.open=false" class="w-8 h-8 rounded-full hover:bg-white/20 flex items-center justify-center transition">
                        <i class="fa-solid fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6 space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Nom du client (facultatif)</label>
                    <input v-model="quickRdvModal.nom" type="text" placeholder="Nom du client" class="w-full px-4 py-3 bg-slate-50 border-2 border-slate-200 rounded-xl font-bold text-slate-700 outline-none focus:border-blue-500 focus:bg-white transition">
                </div>
                
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Mod√®le du v√©hicule (facultatif)</label>
                    <input v-model="quickRdvModal.modele" type="text" placeholder="Mod√®le du v√©hicule" class="w-full px-4 py-3 bg-slate-50 border-2 border-slate-200 rounded-xl font-bold text-slate-700 outline-none focus:border-blue-500 focus:bg-white transition">
                </div>
                
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Source *</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button 
                            v-for="src in sourcesList" 
                            @click="quickRdvModal.source = src" 
                            :class="quickRdvModal.source === src ? 'border-blue-500 bg-blue-50 ring-2 ring-blue-200 shadow-md' : 'border-slate-200 bg-white hover:border-blue-300 hover:bg-slate-50'" 
                            class="p-3 rounded-xl border-2 flex flex-col items-center gap-2 transition transform active:scale-95"
                        >
                            <img :src="getLogo(src)" class="w-6 h-6 rounded bg-gray-50 object-contain">
                            <span class="text-xs font-bold text-slate-700">{{ src }}</span>
                        </button>
                    </div>
                </div>
                
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Note (pourquoi ce RDV)</label>
                    <textarea v-model="quickRdvModal.note" placeholder="Note explicative..." rows="3" class="w-full px-4 py-3 bg-slate-50 border-2 border-slate-200 rounded-xl font-bold text-slate-700 outline-none focus:border-blue-500 focus:bg-white transition resize-none"></textarea>
                </div>
                
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Agence *</label>
                    <select v-model="quickRdvModal.agenceId" @change="quickRdvModal.commercialId = ''; if (!quickRdvHasCommerciaux) quickRdvModal.commercialId = ''" class="w-full px-4 py-3 bg-slate-50 border-2 border-slate-200 rounded-xl font-bold text-slate-700 outline-none focus:border-blue-500 focus:bg-white transition appearance-none">
                        <option value="">S√©lectionner une agence</option>
                        <option v-for="ag in visibleAgencies" :key="ag.id" :value="ag.id">{{ ag.nom }}</option>
                    </select>
                </div>
                
                <div v-if="quickRdvModal.agenceId && quickRdvHasCommerciaux">
                    <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Commercial *</label>
                    <select v-model="quickRdvModal.commercialId" class="w-full px-4 py-3 bg-slate-50 border-2 border-slate-200 rounded-xl font-bold text-slate-700 outline-none focus:border-blue-500 focus:bg-white transition appearance-none">
                        <option value="">Je ne sais pas</option>
                        <option v-for="u in quickRdvCommerciaux" :key="u.id" :value="u.id">{{ u.name }}</option>
                    </select>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Date (facultatif)</label>
                        <input v-model="quickRdvModal.date" type="date" class="w-full px-4 py-3 bg-slate-50 border-2 border-slate-200 rounded-xl font-bold text-slate-700 outline-none focus:border-blue-500 focus:bg-white transition">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Heure (facultatif)</label>
                        <input v-model="quickRdvModal.heure" type="time" class="w-full px-4 py-3 bg-slate-50 border-2 border-slate-200 rounded-xl font-bold text-slate-700 outline-none focus:border-blue-500 focus:bg-white transition">
                    </div>
                </div>
                
                <div class="flex items-center gap-3 p-4 bg-green-50 border-2 border-green-200 rounded-xl">
                    <input 
                        type="checkbox" 
                        v-model="quickRdvModal.honore" 
                        id="honore-checkbox"
                        class="w-5 h-5 rounded border-2 border-green-500 text-green-600 focus:ring-green-500 focus:ring-2 cursor-pointer"
                    >
                    <label for="honore-checkbox" class="text-sm font-bold text-green-700 cursor-pointer flex items-center gap-2">
                        <i class="fa-solid fa-check-circle"></i>
                        Rendez-vous honor√© (comptabilis√© dans le CA)
                    </label>
                </div>
            </div>

            <div class="bg-slate-50 p-6 flex gap-3 border-t border-slate-200">
                <button 
                    @click="quickRdvModal.open=false" 
                    class="flex-1 bg-white text-slate-600 border-2 border-slate-200 py-3 rounded-xl font-bold hover:bg-slate-50 transition"
                >
                    Annuler
                </button>
                <button 
                    @click="createQuickRdv" 
                    :disabled="!quickRdvModal.agenceId || !quickRdvModal.source"
                    :class="(!quickRdvModal.agenceId || !quickRdvModal.source) ? 'opacity-50 cursor-not-allowed' : 'hover:bg-blue-600'"
                    class="flex-1 bg-blue-500 text-white py-3 rounded-xl font-bold shadow-lg transform active:scale-95 transition"
                >
                    <i class="fa-solid fa-check mr-2"></i>
                    Valider
                </button>
            </div>
        </div>
    </div>

    <!-- MODALE STATUTS MANQUANTS (NOUVELLE) -->
    <div v-if="pendingStatusModal.open" class="fixed inset-0 bg-slate-900/90 z-[450] flex items-center justify-center p-4 ">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-sm text-center pop-in border-4 border-purple-100">
            <div class="w-16 h-16 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl shadow-lg animate-pulse">
                <i class="fa-solid fa-clipboard-question"></i>
            </div>
            <h3 class="font-bold text-2xl mb-2 text-slate-800">Statuts manquants</h3>
            <p class="text-slate-500 font-medium mb-6">
                Vous avez <strong class="text-purple-600">{{ pendingStatusCount }} rendez-vous</strong> pass√©s dont le statut n'est pas √† jour.
            </p>
            
            <div class="space-y-3">
                <button @click="pendingStatusModal.open=false; changeView('pending_status')" class="w-full bg-purple-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-purple-200 hover:bg-purple-700 transition transform active:scale-95">
                    Voir les statuts
                </button>
                <button @click="pendingStatusModal.open=false" class="w-full bg-white text-slate-400 border-2 border-slate-100 py-3 rounded-xl font-bold hover:bg-slate-50 hover:text-slate-600 transition">
                   Ignorer
                </button>
            </div>
        </div>
    </div>

    <!-- NOUVELLE MODALE ALERTE RAPPELS CONNEXION (LOGIQUE CORRIG√âE) Z-INDEX FIX -->
    <div v-if="reminderAlertModal.open" class="fixed inset-0 bg-slate-900/90 z-[400] flex items-center justify-center p-4 ">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-sm text-center pop-in border-4 border-red-100">
             <div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl shadow-lg animate-pulse">
                <i class="fa-solid fa-bell"></i>
            </div>
            <h3 class="font-bold text-2xl mb-2 text-slate-800">Rappels en attente</h3>
            <p class="text-slate-500 font-medium mb-6">
                Vous avez <strong class="text-red-500" v-if="rappelsVeilleCount>0">{{ rappelsVeilleCount }} pour Demain</strong>
                <span v-if="rappelsVeilleCount>0 && rappelsJourCount>0"> et </span>
                <strong class="text-red-500" v-if="rappelsJourCount>0">{{ rappelsJourCount }} pour Aujourd'hui</strong>.
            </p>
            
            <div class="space-y-3">
                <button @click="reminderAlertModal.open=false; changeView('rappels')" class="w-full bg-red-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-red-200 hover:bg-red-700 transition transform active:scale-95">
                    Voir les rappels
                </button>
                <button @click="reminderAlertModal.open=false" class="w-full bg-white text-slate-400 border-2 border-slate-100 py-3 rounded-xl font-bold hover:bg-slate-50 hover:text-slate-600 transition">
                   Ignorer
                </button>
            </div>
        </div>
    </div>
    
    <!-- MODALE STATS DETAILL√âES Z-INDEX FIX -->
    <div v-if="statsModal.open" class="fixed inset-0 bg-slate-900/80 z-[350] flex items-center justify-center p-4 ">
        <div class="bg-white rounded-3xl shadow-2xl overflow-hidden w-full max-w-4xl max-h-[90vh] flex flex-col pop-in">
             <div class="bg-slate-100 p-6 flex justify-between items-center border-b">
                 <h3 class="font-bold text-xl text-slate-800">üìä Statistiques D√©taill√©es</h3>
                 <div class="flex items-center gap-3">
                     <button @click="exportStatsPdf" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl font-bold flex items-center gap-2 text-sm transition shadow-md">
                         <i class="fa-solid fa-file-pdf"></i> T√©l√©charger PDF
                     </button>
                     <button @click="statsModal.open=false" class="w-8 h-8 rounded-full bg-white hover:bg-red-50 hover:text-red-500 flex items-center justify-center transition">‚úï</button>
                 </div>
             </div>
             
             <!-- FILTRES STATS -->
             <div class="p-6 bg-white border-b border-slate-100 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                 <div>
                    <label class="text-xs font-bold text-gray-400 uppercase mb-1 block">Filtrer par Agence</label>
                    <select v-model="statsFilterAgency" class="w-full p-2 border border-slate-200 rounded-xl font-bold text-slate-700">
                        <option value="">Toutes les agences</option>
                        <option v-for="ag in visibleAgencies" :key="ag.id" :value="ag.id">{{ ag.nom }}</option>
                    </select>
                 </div>
                 <!-- RESTRICTION UTILISATEUR ICI -->
                 <div v-if="user.role === 'admin'">
                    <label class="text-xs font-bold text-gray-400 uppercase mb-1 block">Filtrer par Commercial</label>
                    <select v-model="statsFilterUser" class="w-full p-2 border border-slate-200 rounded-xl font-bold text-slate-700">
                        <option value="">Toute l'√©quipe</option>
                        <option v-for="u in allProspectors" :key="u" :value="u">{{ u }}</option>
                    </select>
                 </div>
                 <div>
                    <label class="text-xs font-bold text-gray-400 uppercase mb-1 block">Mois</label>
                    <select v-model="statsFilterMonth" class="w-full p-2 border border-slate-200 rounded-xl font-bold text-slate-700">
                        <option value="">Mois</option>
                        <option value="01">Janvier</option>
                        <option value="02">F√©vrier</option>
                        <option value="03">Mars</option>
                        <option value="04">Avril</option>
                        <option value="05">Mai</option>
                        <option value="06">Juin</option>
                        <option value="07">Juillet</option>
                        <option value="08">Ao√ªt</option>
                        <option value="09">Septembre</option>
                        <option value="10">Octobre</option>
                        <option value="11">Novembre</option>
                        <option value="12">D√©cembre</option>
                    </select>
                 </div>
                 <div>
                    <label class="text-xs font-bold text-gray-400 uppercase mb-1 block">Ann√©e</label>
                    <select v-model="statsFilterYear" class="w-full p-2 border border-slate-200 rounded-xl font-bold text-slate-700">
                        <option value="">Ann√©e</option>
                        <option v-for="y in dashboardYearOptions" :key="y" :value="y">{{ y }}</option>
                    </select>
                 </div>
                 <div class="flex items-end">
                    <button @click="resetStatsModalDateFilters" v-if="statsFilterMonth || statsFilterYear" class="w-full bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-xl text-xs font-bold border border-slate-300 transition-all shadow-md hover:shadow-lg flex items-center justify-center gap-2" title="R√©initialiser au mois en cours">
                        <i class="fa-solid fa-rotate-left"></i>
                        Effacer
                    </button>
                 </div>
             </div>

             <div class="flex-1 overflow-y-auto p-6 bg-slate-50">
                 
                 <!-- CHIFFRES CLES FILTR√âS -->
                 <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                     <div class="bg-gradient-to-br from-white to-slate-50 p-5 rounded-2xl shadow-md border border-slate-200 text-center hover:shadow-lg transition-shadow">
                         <p class="text-xs font-bold text-slate-500 uppercase mb-2">Total Plac√©</p>
                         <p class="text-3xl font-black text-slate-800">{{ detailedStats.total }}</p>
                         <p class="text-[10px] text-slate-400 mt-1">RDV ce mois</p>
                     </div>
                     <div class="bg-gradient-to-br from-green-50 to-green-100 p-5 rounded-2xl shadow-md border border-green-200 text-center hover:shadow-lg transition-shadow">
                         <p class="text-xs font-bold text-green-600 uppercase mb-2">Honor√©s</p>
                         <p class="text-3xl font-black text-green-700">{{ detailedStats.honored }}</p>
                         <p class="text-[10px] text-green-500 mt-1">RDV honor√©s</p>
                     </div>
                     <div class="bg-gradient-to-br from-red-50 to-red-100 p-5 rounded-2xl shadow-md border border-red-200 text-center hover:shadow-lg transition-shadow">
                         <p class="text-xs font-bold text-red-600 uppercase mb-2">Pas Venu</p>
                         <p class="text-3xl font-black text-red-700">{{ detailedStats.noshow }}</p>
                         <p class="text-[10px] text-red-500 mt-1">No-show</p>
                     </div>
                     <div class="bg-gradient-to-br from-blue-600 to-blue-700 text-white p-5 rounded-2xl shadow-lg shadow-blue-300 text-center flex flex-col justify-center hover:shadow-xl transition-shadow">
                         <p class="text-xs font-bold opacity-90 uppercase mb-2">Taux Transfo.</p>
                         <p class="text-3xl font-black">{{ detailedStats.rate }}%</p>
                         <p class="text-[10px] opacity-75 mt-1">Taux de transformation</p>
                     </div>
                 </div>


                <!-- ONGLETS MODERNIS√âS -->
                <div class="mb-6">
                    <div class="flex gap-3 bg-slate-100 p-1.5 rounded-2xl">
                        <button 
                            @click="statsModal.activeTab = 'overview'"
                            :class="statsModal.activeTab === 'overview' ? 'bg-white text-blue-600 shadow-md font-bold' : 'text-slate-600 hover:text-slate-800'"
                            class="flex-1 px-6 py-3 rounded-xl transition-all duration-200 flex items-center justify-center gap-2">
                            <i class="fa-solid fa-building"></i>
                            <span>Vue d'ensemble</span>
                        </button>
                        <button 
                            @click="statsModal.activeTab = 'performance'"
                            :class="statsModal.activeTab === 'performance' ? 'bg-white text-blue-600 shadow-md font-bold' : 'text-slate-600 hover:text-slate-800'"
                            class="flex-1 px-6 py-3 rounded-xl transition-all duration-200 flex items-center justify-center gap-2">
                            <i class="fa-solid fa-chart-bar"></i>
                            <span>Performances</span>
                        </button>
                    </div>
                </div>

                <!-- ONGLET 1: VUE D'ENSEMBLE -->
                <div v-if="statsModal.activeTab === 'overview'">
                    <!-- STATISTIQUES MANDATS PAR AGENCE -->
                    <div class="bg-white rounded-2xl shadow-md border border-slate-200 p-6 mb-6">
                        <div class="flex items-center gap-3 mb-5">
                            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center shadow-md">
                                <i class="fa-solid fa-building text-white"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-lg text-slate-800">Mandats sign√©s par Agence</h4>
                                <p class="text-xs text-slate-500">Bas√© sur les RDV honor√©s uniquement - {{ statsModalSelectedPeriod }}</p>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <div v-for="stat in mandatsParAgence" :key="stat.agenceId" class="bg-gradient-to-br from-white via-blue-50/20 to-white rounded-xl p-6 border-2 border-blue-200 shadow-lg hover:shadow-xl hover:scale-[1.01] transition-all duration-200">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="font-bold text-slate-800 text-lg flex items-center gap-2">
                                        <i class="fa-solid fa-building text-blue-500"></i>
                                        {{ stat.nom || 'Sans agence' }}
                                    </div>
                                    <div class="px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full shadow-md">
                                        <span class="text-xs font-bold text-white">
                                            {{ stat.total > 0 ? Math.round((stat.mandatsSignes / stat.total) * 100) : 0 }}% de mandats
                                        </span>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <div class="bg-gradient-to-br from-slate-50 to-white rounded-xl p-4 border-2 border-slate-300 shadow-md">
                                        <div class="text-xs font-bold text-slate-600 uppercase mb-2">Total RDV Honor√©s</div>
                                        <div class="text-3xl font-black text-slate-800">{{ stat.total }}</div>
                                        <div class="text-[10px] text-slate-500 mt-1">RDV honor√©s ce mois</div>
                                    </div>
                                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-4 border-2 border-blue-400 shadow-lg">
                                        <div class="text-xs font-bold text-white/90 uppercase mb-2">Mandats sign√©s</div>
                                        <div class="text-3xl font-black text-white">{{ stat.mandatsSignes }}</div>
                                        <div class="text-[10px] text-white/80 mt-1">Avec mandat OK M</div>
                                    </div>
                                </div>
                                <div v-if="stat.total > 0" class="mt-4 w-full bg-slate-200 h-4 rounded-full overflow-hidden shadow-inner">
                                    <div class="h-full bg-gradient-to-r from-blue-500 via-blue-600 to-blue-700 transition-all duration-700 rounded-full shadow-lg" :style="{width: (stat.mandatsSignes / stat.total * 100) + '%'}"></div>
                                </div>
                            </div>
                            <div v-if="mandatsParAgence.length === 0" class="text-center text-slate-400 py-12 bg-slate-50 rounded-xl border-2 border-dashed border-slate-300">
                                <i class="fa-solid fa-inbox text-4xl mb-3 block opacity-50"></i>
                                <p class="text-sm font-medium">Aucune donn√©e pour ce mois</p>
                            </div>
                        </div>
                    </div>

                    <!-- HISTORIQUE DES ACTIONS -->
                    <div v-if="user.role === 'admin' && actionHistory.length > 0" class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6">
                        <h4 class="font-bold text-lg text-slate-800 mb-4 flex items-center gap-2">
                            <i class="fa-solid fa-history text-slate-600"></i>
                            Historique des Actions (100 derni√®res)
                        </h4>
                        <div class="space-y-2 max-h-60 overflow-y-auto">
                            <div v-for="log in actionHistory.slice(0, 20)" :key="log.id" class="bg-slate-50 rounded-lg p-3 border border-slate-200 text-xs">
                                <div class="flex items-center justify-between mb-1">
                                    <span class="font-bold text-slate-700">{{ log.user }}</span>
                                    <span class="text-slate-500">{{ new Date(log.timestamp).toLocaleString('fr-FR') }}</span>
                                </div>
                                <div class="text-slate-600">
                                    <span class="font-bold">{{ log.action }}</span>
                                    <span v-if="log.details.client"> - {{ log.details.client }}</span>
                                    <span v-if="log.details.motif"> ({{ log.details.motif }})</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ONGLET 2: PERFORMANCES -->
                <div v-if="statsModal.activeTab === 'performance'">
                    <!-- STATISTIQUES AVANC√âES D√âTAILL√âES -->
                    <div class="bg-gradient-to-br from-white via-purple-50/30 to-white rounded-3xl shadow-lg border-2 border-purple-100 p-6 mb-6">
                        <div class="flex items-center justify-between mb-5">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl flex items-center justify-center shadow-md">
                                    <i class="fa-solid fa-chart-line text-white text-xl"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-xl text-slate-800">Statistiques Avanc√©es</h4>
                                    <p class="text-xs text-slate-500 font-medium">P√©riode : {{ new Date().toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' }) }}</p>
                                </div>
                            </div>
                            <div class="px-3 py-1 bg-purple-100 rounded-full">
                                <span class="text-xs font-bold text-purple-700">Mois en cours</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="bg-white/80 backdrop-blur-sm rounded-xl p-4 border border-purple-200 shadow-sm hover:shadow-md transition-all hover:scale-105">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="text-xs font-bold text-purple-600 uppercase">Taux Conversion</div>
                                    <i class="fa-solid fa-arrow-trend-up text-purple-400 text-sm"></i>
                                </div>
                                <div class="text-2xl font-black text-purple-700 mb-1">{{ statsModalData.tauxConversion }}%</div>
                                <div class="text-[10px] text-slate-500">RDV honor√©s / Total RDV</div>
                                <div class="text-[9px] text-purple-500 mt-1">Bas√© sur {{ statsModalData.totalRdv }} RDV</div>
                            </div>
                            <div class="bg-white/80 backdrop-blur-sm rounded-xl p-4 border border-red-200 shadow-sm hover:shadow-md transition-all hover:scale-105">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="text-xs font-bold text-red-600 uppercase">Taux Annulation</div>
                                    <i class="fa-solid fa-ban text-red-400 text-sm"></i>
                                </div>
                                <div class="text-2xl font-black text-red-700 mb-1">{{ statsModalData.tauxAnnulation }}%</div>
                                <div class="text-[10px] text-slate-500">RDV annul√©s / Total RDV</div>
                                <div class="text-[9px] text-red-500 mt-1">Sur {{ statsModalData.totalRdv }} RDV total</div>
                            </div>
                            <div class="bg-white/80 backdrop-blur-sm rounded-xl p-4 border border-orange-200 shadow-sm hover:shadow-md transition-all hover:scale-105">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="text-xs font-bold text-orange-600 uppercase">Taux No-Show</div>
                                    <i class="fa-solid fa-user-xmark text-orange-400 text-sm"></i>
                                </div>
                                <div class="text-2xl font-black text-orange-700 mb-1">{{ statsModalData.tauxNoShow }}%</div>
                                <div class="text-[10px] text-slate-500">Client absent / Total RDV</div>
                                <div class="text-[9px] text-orange-500 mt-1">Sur {{ statsModalData.totalRdv }} RDV total</div>
                            </div>
                            <div class="bg-white/80 backdrop-blur-sm rounded-xl p-4 border border-green-200 shadow-sm hover:shadow-md transition-all hover:scale-105">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="text-xs font-bold text-green-600 uppercase">CA Moyen / RDV</div>
                                    <i class="fa-solid fa-euro-sign text-green-400 text-sm"></i>
                                </div>
                                <div class="text-2xl font-black text-green-700 mb-1">{{ statsModalData.caMoyenParRdv }}‚Ç¨</div>
                                <div class="text-[10px] text-slate-500">Par RDV honor√©</div>
                                <div class="text-[9px] text-green-500 mt-1">Sur {{ statsModalData.honored }} RDV honor√©s</div>
                            </div>
                        </div>
                    </div>

                    <!-- CA PAR JOUR DE LA SEMAINE -->
                    <div class="bg-gradient-to-br from-white via-purple-50/30 to-white rounded-2xl shadow-lg border-2 border-purple-200/80 p-4 md:p-6 mb-6 backdrop-blur-sm">
                        <div class="flex flex-col md:flex-row md:items-center justify-between mb-5 gap-3">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl flex items-center justify-center shadow-md shadow-purple-300">
                                    <i class="fa-solid fa-calendar-week text-white"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-base md:text-lg text-slate-800">CA par Jour de la Semaine</h4>
                                    <p class="text-xs text-slate-500">R√©partition du CA selon les jours</p>
                                </div>
                            </div>
                            <select v-model="statsModal.selectedMonth" class="px-4 py-2 border-2 border-purple-300 rounded-xl text-sm font-bold text-slate-700 bg-white hover:border-purple-400 focus:border-purple-500 focus:outline-none transition-colors shadow-md">
                                <option value="current">Ce mois</option>
                                <option value="previous">Mois pr√©c√©dent</option>
                            </select>
                        </div>
                        <!-- VERSION DESKTOP: Grille 7 colonnes -->
                        <div class="hidden md:grid grid-cols-7 gap-3">
                            <div v-for="(ca, jour) in (statsModal.selectedMonth === 'current' ? statsModalData.caParJourSemaine : statsModalData.caParJourSemainePrevious)" :key="jour" class="bg-gradient-to-br from-slate-50 to-white rounded-xl p-4 border-2 border-slate-200 text-center hover:shadow-lg transition-all hover:scale-105" :class="ca > 0 ? 'border-purple-300 bg-purple-50/40 shadow-md' : ''">
                                <div class="text-xs font-bold text-slate-500 uppercase mb-2">{{ ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'][jour] }}</div>
                                <div class="text-xl font-black" :class="ca > 0 ? 'text-purple-600' : 'text-slate-300'">{{ formatPrice(ca) }}</div>
                                <div v-if="ca > 0" class="text-[9px] text-purple-500 mt-1 font-medium">CA g√©n√©r√©</div>
                            </div>
                        </div>
                        <!-- VERSION MOBILE: Liste verticale -->
                        <div class="md:hidden space-y-2">
                            <div v-for="(ca, jour) in (statsModal.selectedMonth === 'current' ? statsModalData.caParJourSemaine : statsModalData.caParJourSemainePrevious)" :key="jour" class="bg-gradient-to-br from-white to-slate-50 rounded-xl p-3 border-2 flex items-center justify-between shadow-sm" :class="ca > 0 ? 'border-purple-300 bg-purple-50/40' : 'border-slate-200'">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 rounded-lg flex items-center justify-center font-bold text-white shadow-md" :class="ca > 0 ? 'bg-gradient-to-br from-purple-500 to-purple-600' : 'bg-slate-300'">
                                        {{ ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'][jour] }}
                                    </div>
                                    <div>
                                        <div class="text-xs font-bold text-slate-500 uppercase">{{ ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'][jour] }}</div>
                                        <div v-if="ca > 0" class="text-[10px] text-purple-500 font-medium">CA g√©n√©r√©</div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-lg font-black" :class="ca > 0 ? 'text-purple-600' : 'text-slate-300'">{{ formatPrice(ca) }}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- STATISTIQUES PAR SOURCE -->
                    <div v-if="Object.keys(statsModalData.statsBySource).length > 0" class="bg-white rounded-2xl shadow-md border border-slate-200 p-6 mb-6">
                        <div class="flex items-center gap-3 mb-5">
                            <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl flex items-center justify-center shadow-md shadow-purple-300">
                                <i class="fa-solid fa-chart-pie text-white"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-lg text-slate-800">Performance par Source</h4>
                                <p class="text-xs text-slate-500">CA g√©n√©r√© par source de prospection</p>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <div v-for="(stat, source) in statsModalData.statsBySource" :key="source" class="bg-gradient-to-r from-purple-50/50 to-white rounded-xl p-4 border border-purple-200 shadow-sm hover:shadow-md transition-all">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="font-bold text-slate-800 flex items-center gap-2">
                                        <i class="fa-solid fa-circle text-purple-400 text-xs"></i>
                                        {{ source || 'Non renseign√©' }}
                                    </div>
                                    <div class="text-lg font-bold text-purple-600">{{ formatPrice(stat.ca) }}</div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <div class="text-xs text-slate-500">
                                        <i class="fa-solid fa-calendar-check text-purple-400 mr-1"></i>
                                        {{ stat.count }} RDV honor√©s
                                    </div>
                                    <div class="text-xs font-bold text-purple-500">
                                        CA moyen: {{ formatPrice(stat.count > 0 ? (stat.ca / stat.count) : 0) }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- STATISTIQUES PAR AGENCE -->
                    <div v-if="Object.keys(statsModalData.statsByAgency).length > 0" class="bg-white rounded-2xl shadow-md border border-slate-200 p-6 mb-6">
                        <div class="flex items-center gap-3 mb-5">
                            <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl flex items-center justify-center shadow-md shadow-purple-300">
                                <i class="fa-solid fa-building text-white"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-lg text-slate-800">Performance par Agence</h4>
                                <p class="text-xs text-slate-500">Bas√© sur les RDV honor√©s avec mandat sign√©</p>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <div v-for="(stat, agence) in statsModalData.statsByAgency" :key="agence" class="bg-gradient-to-r from-purple-50/50 to-white rounded-xl p-4 border border-purple-200 shadow-sm hover:shadow-md transition-all">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="font-bold text-slate-800 flex items-center gap-2">
                                        <i class="fa-solid fa-building text-purple-400"></i>
                                        {{ agence || 'Sans agence' }}
                                    </div>
                                    <div class="text-lg font-bold text-purple-600">{{ formatPrice(stat.ca) }}</div>
                                </div>
                                <div class="text-xs text-slate-500">
                                    <i class="fa-solid fa-calendar-check text-purple-400 mr-1"></i>
                                    {{ stat.count }} RDV honor√©s
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- PERFORMANCE PAR COMMERCIAL -->
                    <div v-if="user.role === 'admin' && Object.keys(statsModalData.perfByCommercial).length > 0" class="bg-white rounded-2xl shadow-md border border-slate-200 p-6 mb-6">
                        <div class="flex items-center gap-3 mb-5">
                            <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl flex items-center justify-center shadow-md shadow-purple-300">
                                <i class="fa-solid fa-users text-white"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-lg text-slate-800">Performance par Commercial</h4>
                                <p class="text-xs text-slate-500">P√©riode : {{ new Date().toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' }) }}</p>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <div v-for="(perf, commercial) in statsModalData.perfByCommercial" :key="commercial" class="bg-gradient-to-r from-purple-50/50 to-white rounded-xl p-4 border border-purple-200 shadow-sm hover:shadow-md transition-all">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="font-bold text-slate-800 flex items-center gap-2">
                                        <i class="fa-solid fa-user text-purple-400"></i>
                                        {{ commercial }}
                                    </div>
                                    <div class="text-lg font-bold text-purple-600">{{ formatPrice(perf.ca) }}</div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <div class="text-xs text-slate-500">
                                        <i class="fa-solid fa-calendar-check text-purple-400 mr-1"></i>
                                        {{ perf.count }} RDV honor√©s
                                    </div>
                                    <div class="text-xs font-bold text-purple-500">
                                        CA moyen: {{ formatPrice(perf.count > 0 ? (perf.ca / perf.count) : 0) }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                
            </div>
        </div>
    </div>
    
    <!-- MODALE EDITION EQUIPE Z-INDEX FIX -->
    <div v-if="teamEditModal.open" class="fixed inset-0 bg-slate-900/80 z-[350] flex items-center justify-center p-4 ">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm pop-in max-h-[90vh] overflow-y-auto">
            <h3 class="font-bold text-lg mb-4">Modifier Membre</h3>
            <div class="space-y-3">
                <input v-model="teamEditModal.name" placeholder="Nom" class="w-full p-3 border rounded-xl outline-none focus:border-blue-500">
                <input v-model="teamEditModal.email" placeholder="Email / Identifiant" class="w-full p-3 border rounded-xl outline-none focus:border-blue-500">
                <input v-model="teamEditModal.password" placeholder="Nouveau mot de passe (optionnel)" class="w-full p-3 border rounded-xl outline-none focus:border-blue-500" autocomplete="new-password">
            </div>
            
            <div class="mt-4 border-t pt-4">
                <h4 class="font-bold text-xs uppercase text-gray-500 mb-2">Agences Attribu√©es</h4>
                <div class="max-h-40 overflow-y-auto space-y-2 border rounded-xl p-2 bg-slate-50">
                    <div v-for="ag in agences" :key="ag.id" class="flex items-center gap-2">
                        <input type="checkbox" :id="'edit-ag-'+ag.id" :value="ag.id" v-model="teamEditModal.assignedAgencies" class="custom-checkbox w-4 h-4">
                        <label :for="'edit-ag-'+ag.id" class="text-sm font-medium text-slate-700 cursor-pointer select-none">{{ ag.nom }}</label>
                    </div>
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button @click="teamEditModal.open=false" class="flex-1 bg-gray-100 text-gray-500 py-2 rounded-xl font-bold">Annuler</button>
                <button @click="saveTeamMemberEdit" class="flex-1 bg-blue-600 text-white py-2 rounded-xl font-bold">Sauvegarder</button>
            </div>
        </div>
    </div>

    <!-- MODALE MODIFICATION MOT DE PASSE -->
    <div v-if="passwordEditModal.open" class="fixed inset-0 bg-slate-900/80 z-[350] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm pop-in">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fa-solid fa-key text-2xl"></i>
                </div>
                <h3 class="font-bold text-xl mb-2 text-slate-800">Modifier le mot de passe</h3>
                <p class="text-slate-600 text-sm">{{ passwordEditModal.member?.name }}</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Nouveau mot de passe</label>
                    <input 
                        v-model="passwordEditModal.password" 
                        type="password" 
                        placeholder="Entrez le nouveau mot de passe" 
                        class="w-full p-4 border-2 border-slate-200 rounded-xl outline-none focus:border-blue-500 transition"
                        @keyup.enter="savePasswordEdit"
                        autocomplete="new-password"
                    >
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button @click="passwordEditModal.open = false; passwordEditModal.password = ''" class="flex-1 bg-gray-100 text-gray-600 py-3 rounded-xl font-bold hover:bg-gray-200 transition">Annuler</button>
                <button @click="savePasswordEdit" :disabled="!passwordEditModal.password || passwordEditModal.password.trim() === ''" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition">Enregistrer</button>
            </div>
        </div>
    </div>
    
    <!-- MODALE CONFIRMATION UNIVERSELLE Z-INDEX FIX -->
    <div v-if="customConfirmModal.open" class="fixed inset-0 bg-slate-900/80 z-[400] flex items-center justify-center p-4 ">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm text-center pop-in border border-slate-200">
             <div class="w-16 h-16 bg-slate-100 text-slate-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                <i class="fa-solid fa-circle-question"></i>
            </div>
            <h3 class="font-bold text-xl mb-2 text-slate-800">{{ customConfirmModal.title }}</h3>
            <p class="text-slate-500 mb-6">{{ customConfirmModal.message }}</p>
            <div class="grid grid-cols-2 gap-4">
                <button @click="customConfirmModal.open=false" class="bg-slate-100 text-slate-600 py-3 rounded-xl font-bold hover:bg-slate-200 transition text-sm">Non</button>
                <button @click="customConfirmModal.onConfirm" class="bg-slate-800 text-white py-3 rounded-xl font-bold hover:bg-slate-900 transition shadow-lg text-sm">Oui</button>
            </div>
        </div>
    </div>

    <!-- MODAL MODIFIER NOTE -->
    <div v-if="editNoteModal.open" class="fixed inset-0 bg-slate-900/80 z-[400] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md pop-in border border-slate-200">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-12 h-12 bg-amber-100 text-amber-600 rounded-xl flex items-center justify-center">
                    <i class="fa-solid fa-pencil text-xl"></i>
                </div>
                <h3 class="font-bold text-xl text-slate-800">Modifier la note</h3>
            </div>
            <textarea v-model="editNoteModal.note" rows="4" class="w-full px-4 py-3 bg-slate-50 border-2 border-slate-200 rounded-xl font-medium text-slate-700 outline-none focus:border-amber-500 focus:bg-white transition resize-none" placeholder="Saisissez votre note..."></textarea>
            <div class="flex gap-3 mt-6">
                <button @click="editNoteModal.open = false; editNoteModal.rdv = null; editNoteModal.note = ''" class="flex-1 bg-slate-100 text-slate-600 py-3 rounded-xl font-bold hover:bg-slate-200 transition text-sm">
                    Annuler
                </button>
                <button @click="saveNoteEdit" class="flex-1 bg-amber-500 text-white py-3 rounded-xl font-bold hover:bg-amber-600 transition shadow-lg text-sm">
                    <i class="fa-solid fa-check mr-2"></i>
                    Enregistrer
                </button>
            </div>
        </div>
    </div>

    <!-- SETTINGS Z-INDEX FIX -->
    <div v-if="settingsModal.open" class="fixed inset-0 bg-slate-900/80 z-[300] flex md:items-center md:justify-center p-0 md:p-4">
        <div class="bg-white w-full h-full md:w-full md:max-w-4xl md:h-[90vh] md:rounded-3xl shadow-2xl overflow-hidden flex flex-col fade-in">
            <!-- Header avec titre et bouton fermer -->
            <div class="bg-gradient-to-r from-slate-800 to-slate-900 p-4 md:p-6 text-white flex items-center justify-between border-b border-slate-700 sticky top-0 z-10">
                <div class="flex items-center gap-3">
                    <button v-if="settingsModal.view === 'page'" @click="settingsModal.view='menu'" class="w-10 h-10 flex items-center justify-center text-white hover:bg-white/20 rounded-full transition active:scale-95">
                        <i class="fa-solid fa-arrow-left text-lg"></i>
                    </button>
                <h2 class="text-lg md:text-2xl font-bold flex items-center gap-2">
                    <i class="fa-solid fa-gear text-lg md:text-xl"></i> 
                    <span class="hidden sm:inline">R√©glages</span>
                    <span class="sm:hidden">Param√®tres</span>
                </h2>
                </div>
                <button @click="settingsModal.open=false; settingsModal.view='menu'" class="w-10 h-10 flex items-center justify-center text-white hover:bg-white/20 rounded-full transition active:scale-95">
                    <i class="fa-solid fa-times text-lg md:text-xl"></i>
                </button>
            </div>
            
            <!-- Menu de s√©lection des onglets -->
            <div v-if="settingsModal.view === 'menu'" class="flex-1 overflow-y-auto p-6 md:p-8 bg-gradient-to-br from-slate-50 to-blue-50">
                <div class="max-w-4xl mx-auto">
                    <h3 class="text-xl font-bold text-slate-800 mb-6 text-center">Choisissez une section</h3>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        <button @click="settingsModal.tab='Tarification'; settingsModal.view='page'" class="bg-white p-6 rounded-2xl border-2 border-slate-200 hover:border-blue-400 hover:shadow-lg transition flex flex-col items-center gap-3 group">
                            <span class="text-4xl">üí∂</span>
                            <span class="font-bold text-slate-700 text-sm">Tarification</span>
                    </button>
                        <button @click="settingsModal.tab='Agences'; settingsModal.view='page'" class="bg-white p-6 rounded-2xl border-2 border-slate-200 hover:border-blue-400 hover:shadow-lg transition flex flex-col items-center gap-3 group">
                            <span class="text-4xl">üè¢</span>
                            <span class="font-bold text-slate-700 text-sm">Agences</span>
                    </button>
                        <button @click="settingsModal.tab='Equipe'; settingsModal.view='page'" class="bg-white p-6 rounded-2xl border-2 border-slate-200 hover:border-blue-400 hover:shadow-lg transition flex flex-col items-center gap-3 group">
                            <span class="text-4xl">üë•</span>
                            <span class="font-bold text-slate-700 text-sm">√âquipe</span>
                    </button>
                        <button @click="settingsModal.tab='Admins'; settingsModal.view='page'" class="bg-white p-6 rounded-2xl border-2 border-slate-200 hover:border-blue-400 hover:shadow-lg transition flex flex-col items-center gap-3 group">
                            <span class="text-4xl">üëë</span>
                            <span class="font-bold text-slate-700 text-sm">Admins</span>
                    </button>
                        <button @click="settingsModal.tab='Messages'; settingsModal.view='page'" class="bg-white p-6 rounded-2xl border-2 border-slate-200 hover:border-blue-400 hover:shadow-lg transition flex flex-col items-center gap-3 group">
                            <span class="text-4xl">üí¨</span>
                            <span class="font-bold text-slate-700 text-sm">SMS</span>
                    </button>
                        <button @click="settingsModal.tab='Sources'; settingsModal.view='page'" class="bg-white p-6 rounded-2xl border-2 border-slate-200 hover:border-blue-400 hover:shadow-lg transition flex flex-col items-center gap-3 group">
                            <span class="text-4xl">üîó</span>
                            <span class="font-bold text-slate-700 text-sm">Sources</span>
                    </button>
                        <button @click="settingsModal.tab='Motifs'; settingsModal.view='page'" class="bg-white p-6 rounded-2xl border-2 border-slate-200 hover:border-blue-400 hover:shadow-lg transition flex flex-col items-center gap-3 group">
                            <span class="text-4xl">üè∑Ô∏è</span>
                            <span class="font-bold text-slate-700 text-sm">Motifs</span>
                    </button>
                        <button @click="settingsModal.tab='Formatage'; settingsModal.view='page'" class="bg-white p-6 rounded-2xl border-2 border-slate-200 hover:border-blue-400 hover:shadow-lg transition flex flex-col items-center gap-3 group">
                            <i class="fa-solid fa-palette text-4xl text-blue-600"></i>
                            <span class="font-bold text-slate-700 text-sm">Formatage</span>
                    </button>
                        <button v-if="user.role==='admin'" @click="settingsModal.tab='GoogleCalendar'; settingsModal.view='page'" class="bg-white p-6 rounded-2xl border-2 border-slate-200 hover:border-blue-400 hover:shadow-lg transition flex flex-col items-center gap-3 group">
                            <i class="fa-brands fa-google text-4xl text-blue-600"></i>
                            <span class="font-bold text-slate-700 text-sm">Google</span>
                    </button>
                        <button v-if="user.role==='admin'" @click="settingsModal.tab='Logs'; settingsModal.view='page'" class="bg-white p-6 rounded-2xl border-2 border-slate-200 hover:border-blue-400 hover:shadow-lg transition flex flex-col items-center gap-3 group">
                            <i class="fa-solid fa-list text-4xl text-blue-600"></i>
                            <span class="font-bold text-slate-700 text-sm">Journaux</span>
                        </button>
                        <button v-if="user.role==='admin'" @click="settingsModal.tab='Fermetures'; settingsModal.view='page'" class="bg-white p-6 rounded-2xl border-2 border-slate-200 hover:border-red-400 hover:shadow-lg transition flex flex-col items-center gap-3 group">
                            <i class="fa-solid fa-calendar-xmark text-4xl text-red-600"></i>
                            <span class="font-bold text-slate-700 text-sm">Fermetures</span>
                    </button>
                        <button v-if="user.role==='admin'" @click="settingsModal.tab='Dashboard'; settingsModal.view='page'" class="bg-white p-6 rounded-2xl border-2 border-slate-200 hover:border-blue-400 hover:shadow-lg transition flex flex-col items-center gap-3 group">
                            <i class="fa-solid fa-chart-line text-4xl text-blue-600"></i>
                            <span class="font-bold text-slate-700 text-sm">Stats</span>
                    </button>
                    </div>
                </div>
            </div>
            
            <!-- Contenu de la page s√©lectionn√©e -->
            <div v-if="settingsModal.view === 'page'" class="flex-1 overflow-y-auto p-4 md:p-6 bg-white pb-24 md:pb-6">
                
                <!-- ONGLET TARIFICATION (GLOBAL) -->
                <div v-if="settingsModal.tab==='Tarification'" class="space-y-4 md:space-y-6">
                    <div class="bg-gradient-to-br from-slate-50 to-blue-50 p-4 md:p-6 rounded-xl md:rounded-2xl border-2 border-slate-200 shadow-sm">
                        <h3 class="font-bold text-base md:text-lg mb-4 text-slate-700 flex items-center gap-2">
                            <i class="fa-solid fa-sack-dollar text-blue-600"></i> 
                            <span class="text-sm md:text-base">Salaire & Bonus</span>
                        </h3>
                        
                        <div class="space-y-4 mb-4">
                            <div>
                                <label class="text-xs font-bold text-slate-600 block mb-2">Salaire de Base par RDV (‚Ç¨)</label>
                                <input type="number" v-model.number="globalCommission.base" class="w-full p-3 border-2 border-slate-300 rounded-lg font-bold text-blue-600 text-base md:text-lg focus:border-blue-500 outline-none">
                            </div>
                        </div>

                        <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                            <h4 class="font-bold text-xs uppercase text-yellow-700 mb-3">Logique Palier R√©current</h4>
                            <div class="space-y-3">
                                <div class="flex flex-col md:flex-row md:flex-wrap md:items-center gap-2 text-sm font-bold text-slate-700">
                                    <span class="text-xs md:text-sm">√Ä partir de</span>
                                    <input type="number" v-model.number="globalCommission.threshold" class="w-full md:w-20 p-2 rounded-lg border-2 border-slate-300 text-center focus:border-blue-500 outline-none">
                                    <span class="text-xs md:text-sm">RDV, ajouter</span>
                                    <input type="number" v-model.number="globalCommission.amount" class="w-full md:w-24 p-2 rounded-lg border-2 border-slate-300 text-center text-green-600 font-bold focus:border-green-500 outline-none">
                                    <span class="text-xs md:text-sm">‚Ç¨ tous les</span>
                                    <input type="number" v-model.number="globalCommission.step" class="w-full md:w-20 p-2 rounded-lg border-2 border-slate-300 text-center focus:border-blue-500 outline-none">
                                    <span class="text-xs md:text-sm">RDV suivants.</span>
                            </div>
                            </div>
                            <p class="text-[10px] text-slate-500 mt-3 leading-relaxed">Exemple: √Ä partir de 21 RDV, tous les 10 RDV = 100‚Ç¨. 21 RDV = +100‚Ç¨, 31 RDV = +200‚Ç¨, 41 RDV = +300‚Ç¨...</p>
                        </div>
                        
                        <button @click="saveGlobalSettings" class="w-full md:w-auto mt-4 bg-slate-800 text-white px-6 py-3 rounded-lg font-bold hover:bg-slate-900 transition shadow-md">
                            Sauvegarder
                        </button>
                    </div>

                </div>

                <div v-if="settingsModal.tab==='Equipe'" class="space-y-4 md:space-y-6">
                    <div class="bg-gradient-to-br from-slate-50 to-blue-50 p-4 md:p-6 rounded-xl md:rounded-2xl border-2 border-slate-200 shadow-sm">
                        <h3 class="font-bold text-base md:text-lg mb-4 text-slate-700 flex items-center gap-2">
                            <i class="fa-solid fa-user-plus text-blue-600"></i>
                            <span>Ajouter un Prospecteur</span>
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3 md:gap-4 mb-4">
                            <input v-model="newMember.name" placeholder="Nom / Pr√©nom" class="p-3 border rounded-xl outline-none focus:border-blue-500 bg-slate-50">
                            <input v-model="newMember.email" placeholder="Identifiant / Email" class="p-3 border rounded-xl outline-none focus:border-blue-500 bg-slate-50">
                            <input v-model="newMember.password" placeholder="Mot de passe" class="p-3 border rounded-xl outline-none focus:border-blue-500 bg-slate-50">
                            <button @click="addTeamMember" :disabled="!newMember.name || !newMember.email || !newMember.password" class="bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 disabled:opacity-50 transition">Ajouter</button>
                        </div>
                        
                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                            <h4 class="font-bold text-xs uppercase text-gray-500 mb-2">Agences Attribu√©es (pour le nouveau membre)</h4>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-2 max-h-32 overflow-y-auto">
                                <div v-for="ag in agences" :key="ag.id" class="flex items-center gap-2">
                                    <input type="checkbox" :id="'new-ag-'+ag.id" :value="ag.id" v-model="newMember.assignedAgencies" class="custom-checkbox w-4 h-4">
                                    <label :for="'new-ag-'+ag.id" class="text-sm font-medium text-slate-700 cursor-pointer select-none">{{ ag.nom }}</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-100 text-slate-500 text-xs uppercase font-bold"><tr><th class="p-4">Nom</th><th class="p-4">Identifiant</th><th class="p-4">Agences</th><th class="p-4 hidden md:table-cell">Statut</th><th class="p-4 text-right">Actions</th></tr></thead>
                            <tbody class="divide-y"><tr v-for="member in teamList" :key="member.id" class="hover:bg-slate-50 transition"><td class="p-4 font-bold flex items-center gap-2">{{ member.name }} <button @click="openTeamEdit(member)" class="text-slate-300 hover:text-blue-500 transition"><i class="fa-solid fa-pencil text-xs"></i></button></td><td class="p-4 text-blue-600 font-medium text-xs md:text-sm">{{ member.email }}</td><td class="p-4 text-xs text-gray-500 font-bold">{{ (member.assignedAgencies || []).length }} acc√®s</td><td class="p-4 hidden md:table-cell"><span v-if="member.blocked" class="bg-red-100 text-red-600 px-3 py-1 rounded-full text-xs font-bold uppercase">Bloqu√©</span><span v-else class="bg-green-100 text-green-600 px-3 py-1 rounded-full text-xs font-bold uppercase">Actif</span></td><td class="p-4 text-right space-x-2"><button @click="openPasswordEdit(member)" class="bg-blue-100 text-blue-600 hover:bg-blue-200 px-3 py-1.5 rounded-lg font-bold text-xs transition"><i class="fa-solid fa-key"></i> Mot de passe</button><button @click="toggleBlockTeamMember(member)" :class="member.blocked ? 'bg-green-100 text-green-600 hover:bg-green-200' : 'bg-orange-100 text-orange-600 hover:bg-orange-200'" class="px-3 py-1.5 rounded-lg font-bold text-xs transition">{{ member.blocked ? 'D√©bloquer' : 'Bloquer' }}</button><button @click="deleteTeamMember(member)" class="bg-red-100 text-red-600 hover:bg-red-200 px-3 py-1.5 rounded-lg font-bold text-xs transition"><i class="fa-solid fa-trash"></i></button></td></tr></tbody>
                        </table>
                    </div>
                </div>

                <div v-if="settingsModal.tab==='Agences'" class="space-y-4 md:space-y-6">
                    <div class="bg-gradient-to-br from-blue-50 to-purple-50 p-4 rounded-xl border-2 border-blue-200 mb-4 shadow-sm">
                        <h3 class="font-bold text-base md:text-lg text-slate-700 flex items-center gap-2 mb-2">
                            <i class="fa-solid fa-building text-blue-600"></i>
                            <span>Gestion des Agences</span>
                        </h3>
                        <p class="text-xs text-slate-600">Ajoutez, modifiez ou supprimez vos agences</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-4">
                        <div @click="openAgencyEdit(null)" class="border-2 border-dashed border-gray-300 rounded-2xl flex flex-col items-center justify-center p-6 text-gray-400 hover:border-blue-500 hover:text-blue-500 hover:bg-blue-50 cursor-pointer transition min-h-[150px]"><i class="fa-solid fa-plus text-4xl mb-2"></i><span class="font-bold">Ajouter Agence</span></div>
                        <div v-for="ag in agences" :key="ag.id" class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 hover:border-blue-400 transition relative group">
                            <div class="flex justify-between items-start mb-2"><h3 class="font-bold text-xl">{{ ag.nom }}</h3><div class="flex gap-2 opacity-100 md:opacity-0 group-hover:opacity-100 transition"><button @click.stop="openAgencyEdit(ag)" class="w-8 h-8 rounded-lg bg-blue-100 text-blue-600 hover:bg-blue-200"><i class="fa-solid fa-pen"></i></button><button @click.stop="deleteAgency(ag.id)" class="w-8 h-8 rounded-lg bg-red-100 text-red-600 hover:bg-red-200"><i class="fa-solid fa-trash"></i></button></div></div>
                            <p class="text-sm text-gray-500 mb-4 h-10 overflow-hidden">{{ ag.adresse }}</p>
                            <div class="flex justify-between items-center mt-auto pt-4 border-t"><span class="font-bold text-lg text-slate-700">{{ formatPrice(ag.prix) }} <span class="text-[10px] text-gray-400 uppercase">{{ ag.tva ? 'TTC' : 'HT' }}</span></span><span :class="ag.statut_activite==='pause'?'bg-red-100 text-red-600':'bg-green-100 text-green-600'" class="px-2 py-1 rounded text-xs font-bold uppercase">{{ ag.statut_activite === 'pause' ? 'Pause' : 'Actif' }}</span></div>
                        </div>
                    </div>
                </div>

                <div v-if="settingsModal.tab==='Admins'" class="space-y-4 md:space-y-6">
                    <div class="bg-gradient-to-br from-slate-50 to-purple-50 p-4 md:p-6 rounded-xl md:rounded-2xl border-2 border-slate-200 shadow-sm">
                        <h3 class="font-bold text-base md:text-lg mb-4 text-slate-700 flex items-center gap-2">
                            <i class="fa-solid fa-crown text-purple-600"></i>
                            <span>Configuration Globale</span>
                        </h3>
                       <div class="mb-6 border p-4 rounded-xl bg-slate-50 flex items-center gap-4">
    <div class="w-16 h-16 bg-white border-2 border-slate-200 rounded-xl flex items-center justify-center overflow-hidden flex-shrink-0 shadow-sm">
        <img v-if="globalSettings.appLogoUrl" :src="globalSettings.appLogoUrl" class="w-full h-full object-cover">
        <i v-else class="fa-solid fa-image text-slate-300 text-2xl"></i>
    </div>
    
    <div class="flex-1">
        <label class="text-xs font-bold text-gray-500 uppercase block mb-1">Lien du Logo (URL)</label>
        <div class="flex gap-2">
            <input v-model="globalSettings.appLogoUrl" placeholder="https://..." class="flex-1 p-2 border rounded-lg font-bold text-slate-700 outline-none focus:border-blue-500 bg-white transition">
            <button @click="saveGlobalSettings" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold text-xs hover:bg-blue-700 transition shadow-md flex items-center gap-2 flex-shrink-0 active:scale-95">
                <i class="fa-solid fa-floppy-disk"></i> Sauvegarder
            </button>
        </div>
        <p class="text-[10px] text-gray-400 mt-1">Collez l'adresse de votre image (clic droit > copier l'adresse de l'image) et validez.</p>
    </div>
</div>
                        <!-- CONFIG NOTIF HEURE -->
                        <div class="mb-6 flex flex-col gap-4 border p-4 rounded-xl bg-slate-50">
                            <!-- RAPPEL JOUR J -->
                            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                                <div>
                                    <label class="text-xs font-bold text-gray-500 uppercase block mb-1">Heure d√©but notifications Rappels (Jour J)</label>
                                    <p class="text-xs text-gray-400">Avant cette heure, pas d'alerte pour les RDV d'aujourd'hui.</p>
                                </div>
                                <input type="time" v-model="globalSettings.reminderStartTime" class="p-2 border rounded-lg font-bold text-slate-700 bg-white shadow-sm w-32">
                            </div>
                            
                            <!-- RAPPEL VEILLE (NOUVEAU) -->
                            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 border-t border-slate-200 pt-4">
                                <div>
                                    <label class="text-xs font-bold text-gray-500 uppercase block mb-1">Heure d√©but notifications Rappels (Veille)</label>
                                    <p class="text-xs text-gray-400">Avant cette heure, pas d'alerte pour les RDV de demain.</p>
                                </div>
                                <input type="time" v-model="globalSettings.reminderEveTime" class="p-2 border rounded-lg font-bold text-slate-700 bg-white shadow-sm w-32">
                            </div>

                            <button @click="saveGlobalSettings" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold text-xs hover:bg-blue-700 transition self-end mt-2">Sauvegarder</button>
                        </div>

                        <!-- CONFIG URL BASE LIEN RDV -->
                        <div class="mb-6 flex flex-col gap-4 border p-4 rounded-xl bg-slate-50">
                            <div class="flex flex-col gap-2">
                                <label class="text-xs font-bold text-gray-500 uppercase block">URL de base pour les liens rendez-vous</label>
                                <p class="text-xs text-gray-400">URL de base pour g√©n√©rer les liens clients (ex: https://votresite.com). Si vide, utilise l'URL actuelle.</p>
                                <input v-model="globalSettings.rdvLinkBaseUrl" placeholder="https://votresite.com" class="p-3 border rounded-lg font-bold text-slate-700 bg-white shadow-sm outline-none focus:border-blue-500">
                            </div>
                            <button @click="saveGlobalSettings" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold text-xs hover:bg-blue-700 transition self-end">Sauvegarder</button>
                        </div>

                        <h3 class="font-bold text-lg mb-4 text-slate-700">G√©rer les Noms d'Administrateurs</h3>
                        <div class="flex gap-2 mb-6">
                            <input v-model="newAdminName" placeholder="Nouveau pr√©nom (ex: Charl√®ne)" class="flex-1 p-3 border rounded-xl outline-none focus:border-blue-500 bg-slate-50">
                            <button @click="addAdminName" class="bg-blue-600 text-white px-6 rounded-xl font-bold hover:bg-blue-700">Ajouter</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <div v-for="name in adminNamesList" :key="name" class="flex items-center justify-between p-3 border rounded-xl bg-white hover:border-blue-300 transition group">
                                <span class="font-bold text-slate-700 ml-2">{{ name }}</span>
                                <button @click="removeAdminName(name)" class="text-gray-300 hover:text-red-500 transition"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div v-if="settingsModal.tab==='Messages'" class="flex flex-col lg:grid lg:grid-cols-3 gap-4 md:gap-6">
                    <div class="lg:col-span-1 border-r lg:pr-6 space-y-4 overflow-y-auto max-h-[200px] lg:max-h-full">
                        <h3 class="font-bold text-gray-500 uppercase text-xs tracking-wider mb-2">1. Choisir l'Agence</h3>
                        <div class="space-y-2"><button v-for="ag in agences" @click="editingMsgAgence = ag" :class="editingMsgAgence?.id === ag.id ? 'bg-blue-600 text-white shadow-md' : 'bg-white hover:bg-slate-100 text-slate-700'" class="w-full text-left px-4 py-3 rounded-xl font-bold transition text-sm flex items-center justify-between"><span>{{ ag.nom }}</span><i v-if="editingMsgAgence?.id === ag.id" class="fa-solid fa-chevron-right"></i></button></div>
                        <h3 class="font-bold text-gray-500 uppercase text-xs tracking-wider mt-6 mb-2">2. Type de Message</h3>
                        <div class="space-y-2"><button v-for="(label, key) in msgLabels" :key="key" @click="editingMsgType = key" :class="editingMsgType === key ? 'bg-slate-800 text-white shadow-md' : 'bg-white border hover:bg-slate-50 text-slate-600'" class="w-full text-left px-4 py-2 rounded-lg font-bold transition text-xs flex justify-between"><span>{{ label }}</span></button></div>
                    </div>
                    <div class="lg:col-span-2 flex flex-col h-full overflow-y-auto">
                        <div v-if="editingMsgAgence" class="flex-1 flex flex-col">
                            <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-lg text-blue-900 leading-tight">√âditer : {{ msgLabels[editingMsgType] }} <span class="text-gray-400 text-sm font-normal block md:inline">({{ editingMsgAgence.nom }})</span></h3><button @click="saveAgency(editingMsgAgence)" class="bg-green-500 hover:bg-green-600 text-white px-4 md:px-6 py-2 rounded-lg font-bold transition shadow-md text-sm">Enregistrer</button></div>
                            <div class="flex flex-wrap gap-2 mb-2 p-3 bg-slate-100 rounded-xl border border-slate-200"><button v-for="tag in ['{{NOM}}','{{DATE_LONG}}','{{HEURE}}','{{AGENCE}}','{{ADRESSE}}','{{PRIX}}','{{PLAN}}']" @click="insertTag(tag)" class="bg-white border border-slate-300 text-slate-600 px-2 py-1 rounded text-[10px] font-bold hover:bg-blue-50 hover:border-blue-300 transition">{{ tag }}</button></div>
                            <textarea :value="editingMsgAgence.templates?.[editingMsgType] || getDefaultTemplate(editingMsgType)" @input="e => { if(!editingMsgAgence.templates) editingMsgAgence.templates={}; editingMsgAgence.templates[editingMsgType] = e.target.value }" class="w-full flex-1 p-4 border-2 border-slate-200 rounded-2xl outline-none focus:border-blue-500 font-medium text-slate-700 leading-relaxed resize-none bg-slate-50 focus:bg-white transition min-h-[200px]"></textarea>
                            
                            <!-- Aper√ßu du message avec variables remplac√©es -->
                            <div v-if="editingMsgType === 'confirm'" class="mt-4 p-4 bg-gradient-to-br from-blue-50 to-purple-50 rounded-xl border-2 border-blue-200">
                                <div class="flex items-center gap-2 mb-2">
                                    <i class="fa-solid fa-eye text-blue-600"></i>
                                    <h4 class="font-bold text-sm text-blue-900">Aper√ßu du message (avec message de f√™te si applicable)</h4>
                                </div>
                                <div class="bg-white p-4 rounded-lg border border-blue-100 text-sm font-medium text-slate-700 whitespace-pre-wrap">{{ getMessagePreview(editingMsgAgence, editingMsgType) }}</div>
                                <p class="text-xs text-blue-600 mt-2 flex items-center gap-1">
                                    <i class="fa-solid fa-info-circle"></i>
                                    <span>Le message de f√™te sera automatiquement ajout√© selon la p√©riode de l'ann√©e</span>
                                </p>
                            </div>
                        </div>
                        <div v-else class="flex-1 flex items-center justify-center text-center text-gray-400 border-2 border-dashed border-gray-200 rounded-2xl p-8">S√©lectionnez une agence.</div>
                    </div>
                </div>

                <div v-if="settingsModal.tab==='Sources'" class="space-y-4 md:space-y-6">
                    <div class="bg-slate-50 p-4 md:p-6 rounded-xl md:rounded-2xl border border-slate-200">
                        <h3 class="font-bold text-base md:text-lg mb-4 text-slate-700">G√©rer les Sources</h3>
                        <div class="flex gap-2 mb-6"><input v-model="newSource" placeholder="Nouvelle source..." class="flex-1 p-3 border rounded-xl outline-none focus:border-blue-500 bg-slate-50"><button @click="addSource" class="bg-blue-600 text-white px-6 rounded-xl font-bold hover:bg-blue-700">Ajouter</button></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div v-for="src in sourcesList" :key="src" class="flex items-center justify-between p-3 border rounded-xl bg-white hover:border-blue-300 transition group"><div class="flex items-center gap-3"><img :src="getLogo(src)" class="w-6 h-6 rounded bg-gray-50 object-contain cursor-pointer hover:opacity-80" @click="changeSourceLogo(src)" title="Changer le logo"><span class="font-bold text-slate-700">{{ src }}</span></div><button @click="removeSource(src)" class="text-gray-300 hover:text-red-500 transition"><i class="fa-solid fa-trash"></i></button></div>
                        </div>
                    </div>
                </div>

                <div v-if="settingsModal.tab==='Motifs'" class="space-y-4 md:space-y-6">
                    <!-- Motifs de Rendez-vous -->
                    <div class="bg-slate-50 p-4 md:p-6 rounded-xl md:rounded-2xl border border-slate-200">
                        <h3 class="font-bold text-base md:text-lg mb-4 text-slate-700 flex items-center gap-2">
                            <i class="fa-solid fa-tag text-blue-600"></i>
                            G√©rer les Motifs de Rendez-vous
                        </h3>
                        <p class="text-xs text-slate-500 mb-4">Ces motifs appara√Ætront dans la liste d√©roulante lors de la cr√©ation d'un rendez-vous. Les utilisateurs peuvent √©galement saisir un motif personnalis√©.</p>
                        <div class="flex gap-2 mb-6">
                            <input v-model="newMotif" placeholder="Nouveau motif (ex: Essai, Achat, R√©vision...)" class="flex-1 p-3 border rounded-xl outline-none focus:border-blue-500 bg-slate-50">
                            <button @click="addMotif" class="bg-blue-600 text-white px-6 rounded-xl font-bold hover:bg-blue-700">Ajouter</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div v-for="motif in motifsList" :key="motif" class="flex items-center justify-between p-3 border rounded-xl bg-white hover:border-blue-300 transition group">
                                <div class="flex items-center gap-3">
                                    <i class="fa-solid fa-tag text-blue-500"></i>
                                    <span class="font-bold text-slate-700">{{ motif }}</span>
                                </div>
                                <button @click="removeMotif(motif)" class="text-gray-300 hover:text-red-500 transition">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Motifs d'Annulation -->
                    <div class="bg-red-50 p-4 md:p-6 rounded-xl md:rounded-2xl border border-red-200">
                        <h3 class="font-bold text-base md:text-lg mb-4 text-slate-700 flex items-center gap-2">
                            <i class="fa-solid fa-ban text-red-600"></i>
                            G√©rer les Motifs d'Annulation
                        </h3>
                        <p class="text-xs text-slate-500 mb-4">Ces motifs appara√Ætront dans la liste d√©roulante lors de l'annulation d'un rendez-vous. Les utilisateurs peuvent √©galement choisir "Autre" pour saisir un motif personnalis√©.</p>
                        <div class="flex gap-2 mb-6">
                            <input v-model="newCancelMotif" placeholder="Nouveau motif d'annulation (ex: Client indisponible...)" class="flex-1 p-3 border rounded-xl outline-none focus:border-red-500 bg-white">
                            <button @click="addCancelMotif" class="bg-red-600 text-white px-6 rounded-xl font-bold hover:bg-red-700">Ajouter</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div v-for="motif in cancelMotifsList" :key="motif" class="flex items-center justify-between p-3 border rounded-xl bg-white hover:border-red-300 transition group">
                                <div class="flex items-center gap-3">
                                    <i class="fa-solid fa-ban text-red-500"></i>
                                    <span class="font-bold text-slate-700">{{ motif }}</span>
                                </div>
                                <button @click="removeCancelMotif(motif)" class="text-gray-300 hover:text-red-500 transition">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Motifs de Report -->
                    <div class="bg-slate-50 p-4 md:p-6 rounded-xl border border-slate-200">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-bold text-base md:text-lg text-slate-700">√âditer : Messages de Report</h3>
                            <button @click="saveRescheduleSMSMessages" class="px-4 py-1.5 bg-green-600 text-white rounded-lg text-xs font-bold hover:bg-green-700 transition flex items-center gap-1.5">
                                <i class="fa-solid fa-save"></i> Enregistrer
                            </button>
                        </div>
                        <p class="text-xs text-slate-500 mb-4">Les messages configur√©s ici s'appliqueront √† toutes les agences.</p>
                        
                        <div class="space-y-4">
                            <!-- S√©lecteur de type de message -->
                            <div class="bg-white p-3 rounded-lg border-2 border-slate-200">
                                <label class="text-xs font-bold text-slate-700 mb-2 block">Type de message :</label>
                                <div class="flex gap-2">
                                    <button @click="editingRescheduleType='interne'" :class="editingRescheduleType === 'interne' ? 'bg-purple-600 text-white' : 'bg-slate-100 text-slate-700'" class="px-4 py-2 rounded-lg text-xs font-bold transition flex-1">
                                        üè¢ Demande Interne (SMS)
                                    </button>
                                    <button @click="editingRescheduleType='client'" :class="editingRescheduleType === 'client' ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-700'" class="px-4 py-2 rounded-lg text-xs font-bold transition flex-1">
                                        üë§ √Ä la demande du client (Agenda)
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Info selon le type -->
                            <div v-if="editingRescheduleType === 'interne'" class="bg-purple-50 p-3 rounded-lg border-2 border-purple-200">
                                <p class="text-xs text-slate-700">
                                    <i class="fa-solid fa-comment-sms text-purple-600 mr-1"></i>
                                    <strong>Messages SMS :</strong> Ces messages seront envoy√©s automatiquement par SMS lors d'un report √† l'initiative de l'agence.
                                </p>
                            </div>
                            <div v-else class="bg-blue-50 p-3 rounded-lg border-2 border-blue-200">
                                <p class="text-xs text-slate-700">
                                    <i class="fa-solid fa-calendar text-blue-600 mr-1"></i>
                                    <strong>Messages Agenda :</strong> Ces messages appara√Ætront dans Google Agenda et la fiche du rendez-vous. Aucun SMS ne sera envoy√©.
                                </p>
                            </div>
                            
                            <!-- Liste des motifs (accord√©on) -->
                            <div v-for="(label, motifType) in rescheduleMotifsList" :key="motifType" class="bg-white rounded-xl border-2 border-slate-200 overflow-hidden transition-all">
                                <!-- Header cliquable -->
                                <button @click="openMotifs[motifType] = !openMotifs[motifType]" class="w-full flex items-center justify-between p-4 hover:bg-slate-50 transition text-left">
                                    <div class="flex items-center gap-3">
                                        <i :class="openMotifs[motifType] ? 'fa-solid fa-chevron-down' : 'fa-solid fa-chevron-right'" class="text-slate-400 transition-transform"></i>
                                        <h4 class="font-bold text-sm text-slate-800">{{ label }}</h4>
                                    </div>
                                    <button @click.stop="removeRescheduleMotif(motifType)" class="text-red-400 hover:text-red-600 transition text-xs px-2 py-1 rounded hover:bg-red-50">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </button>
                                
                                <!-- Contenu d√©pliable -->
                                <div v-show="openMotifs[motifType]" class="px-4 pb-4 border-t border-slate-100 animate-fadeIn">
                                    <!-- Zone d'√©dition -->
                                    <div class="mb-3 mt-3">
                                        <label class="text-xs font-bold text-slate-600 mb-1.5 block">
                                            Message {{ editingRescheduleType === 'interne' ? 'SMS (Demande Interne)' : 'Agenda (√Ä la demande du client)' }} :
                                        </label>
                                        <textarea 
                                            v-if="editingRescheduleType === 'interne'"
                                            :id="'textarea-interne-' + motifType"
                                            v-model="rescheduleSMSMessages[motifType]" 
                                            placeholder="Message SMS pour demande interne..." 
                                            class="w-full p-3 text-sm border-2 border-slate-200 rounded-lg text-slate-700 outline-none focus:border-purple-500 resize-none font-medium" 
                                            rows="4"
                                        ></textarea>
                                        <textarea 
                                            v-else
                                            :id="'textarea-client-' + motifType"
                                            v-model="rescheduleSMSMessagesClient[motifType]" 
                                            placeholder="Message pour Google Agenda (ex: Le rendez-vous a √©t√© report√© en raison des conditions m√©t√©orologiques...)" 
                                            class="w-full p-3 text-sm border-2 border-slate-200 rounded-lg text-slate-700 outline-none focus:border-blue-500 resize-none font-medium" 
                                            rows="4"
                                        ></textarea>
                                    </div>
                                    
                                    <!-- Aper√ßu -->
                                    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 border-2 border-blue-300 rounded-xl p-4">
                                        <div class="flex items-center gap-2 mb-2">
                                            <i class="fa-solid fa-eye text-blue-600"></i>
                                            <span class="text-xs font-bold text-blue-700">Aper√ßu du message :</span>
                                        </div>
                                        <div class="text-sm text-slate-800 bg-white p-3 rounded-lg border border-blue-200 whitespace-pre-line font-medium leading-relaxed min-h-[60px]">
                                            {{ getReschedulePreview(motifType) }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Ajouter un nouveau motif -->
                            <div class="bg-white p-4 rounded-xl border-2 border-slate-200 border-dashed">
                                <h4 class="font-bold text-sm text-slate-700 mb-3">‚ûï Ajouter un nouveau motif</h4>
                                <div class="grid grid-cols-3 gap-2 mb-3">
                                    <input v-model="newRescheduleMotif.label" placeholder="Label" class="p-2 text-xs border-2 border-slate-200 rounded-lg outline-none focus:border-blue-500">
                                    <input v-model="newRescheduleMotif.key" placeholder="Cl√© technique" class="p-2 text-xs border-2 border-slate-200 rounded-lg outline-none focus:border-blue-500">
                                    <button @click="addRescheduleMotif" class="px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-bold hover:bg-blue-700 transition">
                                        <i class="fa-solid fa-plus mr-1"></i> Ajouter
                                    </button>
                                </div>
                                <div class="flex flex-wrap gap-1.5 mb-3">
                                    <button @click="copyToClipboard('{{DATE_LONG}}')" class="px-2.5 py-1.5 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg text-[10px] font-medium transition">üìÖ {{DATE_LONG}}</button>
                                    <button @click="copyToClipboard('{{HEURE}}')" class="px-2.5 py-1.5 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg text-[10px] font-medium transition">üïê {{HEURE}}</button>
                                    <button @click="copyToClipboard('{{MODELE}}')" class="px-2.5 py-1.5 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg text-[10px] font-medium transition">üöó {{MODELE}}</button>
                                    <button @click="copyToClipboard('{{AGENCE}}')" class="px-2.5 py-1.5 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg text-[10px] font-medium transition">üè¢ {{AGENCE}}</button>
                                </div>
                                <textarea v-model="newRescheduleMotif.message" placeholder="Message SMS..." class="w-full p-3 text-sm border-2 border-slate-200 rounded-lg text-slate-700 outline-none focus:border-blue-500 resize-none" rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Motifs de Report - Demande Interne -->
                    <div class="bg-purple-50 p-4 md:p-6 rounded-xl border border-purple-200 mt-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-bold text-base md:text-lg text-slate-700">√âditer : Motifs de Report - Demande Interne</h3>
                            <button @click="saveRescheduleSMSMessages" class="px-4 py-1.5 bg-green-600 text-white rounded-lg text-xs font-bold hover:bg-green-700 transition flex items-center gap-1.5">
                                <i class="fa-solid fa-save"></i> Enregistrer
                            </button>
                        </div>
                        <p class="text-xs text-slate-500 mb-4">Les motifs configur√©s ici seront utilis√©s uniquement pour les reports √† la demande interne (SMS envoy√© par l'agence).</p>
                        
                        <div class="space-y-4">
                            <!-- Liste des motifs internes (accord√©on) -->
                            <div v-for="(label, motifType) in rescheduleMotifsListInterne" :key="motifType" class="bg-white rounded-xl border-2 border-purple-200 overflow-hidden transition-all">
                                <!-- Header cliquable -->
                                <button @click="openMotifs['interne_' + motifType] = !openMotifs['interne_' + motifType]" class="w-full flex items-center justify-between p-4 hover:bg-purple-50 transition text-left">
                                    <div class="flex items-center gap-3">
                                        <i :class="openMotifs['interne_' + motifType] ? 'fa-solid fa-chevron-down' : 'fa-solid fa-chevron-right'" class="text-purple-400 transition-transform"></i>
                                        <h4 class="font-bold text-sm text-slate-800">{{ label }}</h4>
                                    </div>
                                    <button @click.stop="removeRescheduleMotifInterne(motifType)" class="text-red-400 hover:text-red-600 transition text-xs px-2 py-1 rounded hover:bg-red-50">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </button>
                                
                                <!-- Contenu d√©pliable -->
                                <div v-show="openMotifs['interne_' + motifType]" class="px-4 pb-4 border-t border-purple-100 animate-fadeIn">
                                    <!-- Zone d'√©dition -->
                                    <div class="mb-3 mt-3">
                                        <label class="text-xs font-bold text-slate-600 mb-1.5 block">
                                            Message SMS (Demande Interne) :
                                        </label>
                                        <textarea 
                                            :id="'textarea-interne-motif-' + motifType"
                                            v-model="rescheduleSMSMessages[motifType]" 
                                            placeholder="Message SMS pour demande interne..." 
                                            class="w-full p-3 text-sm border-2 border-purple-200 rounded-lg text-slate-700 outline-none focus:border-purple-500 resize-none font-medium" 
                                            rows="4"
                                        ></textarea>
                                    </div>
                                    
                                    <!-- Aper√ßu -->
                                    <div class="bg-gradient-to-br from-purple-50 to-indigo-50 border-2 border-purple-300 rounded-xl p-4">
                                        <div class="flex items-center gap-2 mb-2">
                                            <i class="fa-solid fa-eye text-purple-600"></i>
                                            <span class="text-xs font-bold text-purple-700">Aper√ßu du message :</span>
                                        </div>
                                        <div class="text-sm text-slate-800 bg-white p-3 rounded-lg border border-purple-200 whitespace-pre-line font-medium leading-relaxed min-h-[60px]">
                                            {{ getReschedulePreview(motifType) }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Ajouter un nouveau motif interne -->
                            <div class="bg-white p-4 rounded-xl border-2 border-purple-200 border-dashed">
                                <h4 class="font-bold text-sm text-slate-700 mb-3">‚ûï Ajouter un nouveau motif interne</h4>
                                <div class="grid grid-cols-3 gap-2 mb-3">
                                    <input v-model="newRescheduleMotifInterne.label" placeholder="Label" class="p-2 text-xs border-2 border-purple-200 rounded-lg outline-none focus:border-purple-500">
                                    <input v-model="newRescheduleMotifInterne.key" placeholder="Cl√© technique" class="p-2 text-xs border-2 border-purple-200 rounded-lg outline-none focus:border-purple-500">
                                    <button @click="addRescheduleMotifInterne" class="px-3 py-2 bg-purple-600 text-white rounded-lg text-xs font-bold hover:bg-purple-700 transition">
                                        <i class="fa-solid fa-plus mr-1"></i> Ajouter
                                    </button>
                                </div>
                                <div class="flex flex-wrap gap-1.5 mb-3">
                                    <button @click="copyToClipboard('{{DATE_LONG}}')" class="px-2.5 py-1.5 bg-purple-100 hover:bg-purple-200 text-purple-700 rounded-lg text-[10px] font-medium transition">üìÖ {{DATE_LONG}}</button>
                                    <button @click="copyToClipboard('{{HEURE}}')" class="px-2.5 py-1.5 bg-purple-100 hover:bg-purple-200 text-purple-700 rounded-lg text-[10px] font-medium transition">üïê {{HEURE}}</button>
                                    <button @click="copyToClipboard('{{MODELE}}')" class="px-2.5 py-1.5 bg-purple-100 hover:bg-purple-200 text-purple-700 rounded-lg text-[10px] font-medium transition">üöó {{MODELE}}</button>
                                    <button @click="copyToClipboard('{{AGENCE}}')" class="px-2.5 py-1.5 bg-purple-100 hover:bg-purple-200 text-purple-700 rounded-lg text-[10px] font-medium transition">üè¢ {{AGENCE}}</button>
                                </div>
                                <textarea v-model="newRescheduleMotifInterne.message" placeholder="Message SMS..." class="w-full p-3 text-sm border-2 border-purple-200 rounded-lg text-slate-700 outline-none focus:border-purple-500 resize-none" rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="settingsModal.tab==='Formatage'" class="space-y-4 md:space-y-6">
                    <div class="bg-slate-50 p-4 md:p-6 rounded-xl md:rounded-2xl border border-slate-200">
                        <h3 class="font-bold text-base md:text-lg mb-4 text-slate-700 flex items-center gap-2">
                            <i class="fa-solid fa-palette text-blue-600"></i>
                            Formatage des Caract√©ristiques Facebook
                        </h3>
                        <p class="text-xs text-slate-500 mb-4">Configurez comment les caract√©ristiques Facebook sont format√©es et traduites dans l'agenda Google.</p>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="text-xs font-bold text-slate-600 uppercase mb-2 block">Traduction automatique</label>
                                <div class="flex items-center gap-3">
                                    <input type="checkbox" v-model="formatageSettings.autoTranslate" class="w-5 h-5 text-blue-600 border-slate-300 rounded focus:ring-blue-500">
                                    <span class="text-sm text-slate-700">Traduire automatiquement les termes anglais (Black ‚Üí Noir, Manual ‚Üí Manuelle, etc.)</span>
                                </div>
                            </div>
                            
                            <div>
                                <label class="text-xs font-bold text-slate-600 uppercase mb-2 block">Format dans Google Agenda</label>
                                <div class="space-y-2">
                                    <div class="flex items-center gap-3">
                                        <input type="checkbox" v-model="formatageSettings.boldLabels" class="w-5 h-5 text-blue-600 border-slate-300 rounded focus:ring-blue-500">
                                        <span class="text-sm text-slate-700">Mettre les labels en gras</span>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <input type="checkbox" v-model="formatageSettings.alignValues" class="w-5 h-5 text-blue-600 border-slate-300 rounded focus:ring-blue-500">
                                        <span class="text-sm text-slate-700">Aligner les valeurs</span>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <input type="checkbox" v-model="formatageSettings.spaceBetween" class="w-5 h-5 text-blue-600 border-slate-300 rounded focus:ring-blue-500">
                                        <span class="text-sm text-slate-700">Espacer les √©l√©ments (saut de ligne entre chaque)</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white p-4 rounded-lg border border-blue-200">
                                <label class="text-xs font-bold text-slate-600 uppercase mb-2 block">Aper√ßu</label>
                                <div class="text-xs text-slate-600 whitespace-pre-line" v-html="getFormatagePreview()"></div>
                            </div>
                            
                            <button @click="saveFormatageSettings" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 shadow-lg">Sauvegarder les param√®tres</button>
                        </div>
                    </div>
                </div>

                <!-- ONGLET FERMETURES -->
                <div v-if="settingsModal.tab==='Fermetures' && user.role==='admin'" class="space-y-4 md:space-y-6">
                    <div class="bg-slate-50 p-4 md:p-6 rounded-xl md:rounded-2xl border border-slate-200">
                        <h3 class="font-bold text-base md:text-lg mb-4 text-slate-700 flex items-center gap-2">
                            <i class="fa-solid fa-calendar-xmark text-red-600"></i>
                            Gestion des Fermetures d'Entreprise
                        </h3>
                        <p class="text-xs text-slate-500 mb-4">Planifiez les fermetures qui seront automatiquement ajout√©es dans les agendas Google Calendar des professionnels.</p>
                        
                        <button @click="fermetureModal.open=true" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 shadow-lg mb-4 flex items-center justify-center gap-2">
                            <i class="fa-solid fa-plus"></i>
                            Ajouter une fermeture
                        </button>
                        
                        <div class="space-y-3">
                            <div v-if="fermeturesList && fermeturesList.length > 0">
                                <div v-for="(ferm, idx) in fermeturesList" :key="idx" class="bg-white p-4 rounded-xl border-2 border-slate-200 mb-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <div>
                                            <div class="font-bold text-slate-800">{{ formatDateFr(ferm.dateDebut) }} - {{ formatDateFr(ferm.dateFin) }}</div>
                                            <div v-if="ferm.motif" class="text-sm text-slate-600 mt-1">{{ ferm.motif }}</div>
                                        </div>
                                        <div class="flex gap-2">
                                            <button @click="editFermeture(ferm)" class="w-8 h-8 bg-blue-100 hover:bg-blue-200 text-blue-600 rounded-lg flex items-center justify-center transition">
                                                <i class="fa-solid fa-pencil text-xs"></i>
                                            </button>
                                            <button @click="deleteFermeture(ferm.id)" class="w-8 h-8 bg-red-100 hover:bg-red-200 text-red-600 rounded-lg flex items-center justify-center transition">
                                                <i class="fa-solid fa-trash text-xs"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="text-xs text-slate-500">
                                        <span v-if="ferm.tousProfessionnels">Tous les professionnels</span>
                                        <span v-else>{{ ferm.professionnels ? ferm.professionnels.length : 0 }} professionnel(s)</span>
                                    </div>
                                </div>
                            </div>
                            <div v-else class="text-center text-slate-500 text-sm py-4">Aucune fermeture planifi√©e</div>
                        </div>
                    </div>
                </div>

                <!-- ONGLET GOOGLE CALENDAR (ADMIN UNIQUEMENT) -->
                <div v-if="settingsModal.tab==='GoogleCalendar' && user.role==='admin'" class="space-y-4 md:space-y-6">
                    <div class="bg-gradient-to-br from-purple-50 to-blue-50 rounded-2xl p-6 md:p-8 border-2 border-purple-200">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center gap-4">
                                <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center shadow-lg">
                                    <i class="fa-brands fa-google text-4xl text-purple-600"></i>
                                </div>
                                <div>
                                    <h3 class="text-xl font-bold text-slate-800">Connexion Google Calendar</h3>
                                    <p class="text-sm text-slate-600">Connectez-vous pour synchroniser automatiquement les rendez-vous</p>
                                </div>
                            </div>
                        </div>

                        <!-- Param√®tre de connexion obligatoire (toujours affich√©) -->
                        <div class="bg-white rounded-xl p-6 border-2 border-blue-200 mb-4">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <h4 class="font-bold text-slate-800 mb-1 flex items-center gap-2">
                                        <i class="fa-solid fa-lock text-blue-500"></i>
                                        Connexion obligatoire pour cr√©er un rendez-vous
                                    </h4>
                                    <p class="text-sm text-slate-600">
                                        Si activ√©, les utilisateurs devront se connecter √† Google Calendar avant de pouvoir cr√©er un rendez-vous.
                                    </p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer ml-4">
                                    <input type="checkbox" v-model="googleCalendarRequired" @change="saveGoogleCalendarRequired" class="sr-only peer">
                                    <div class="w-14 h-7 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                        </div>

                        <!-- V√©rification en cours -->
                        <div v-if="googleCalendarConnected && checkingToken" class="bg-white rounded-xl p-6 border-2 border-blue-300">
                            <div class="flex items-center justify-center gap-3 py-4">
                                <i class="fa-solid fa-spinner fa-spin text-blue-500 text-xl"></i>
                                <p class="text-sm text-slate-600 font-medium">V√©rification du token en cours...</p>
                            </div>
                        </div>

                        <!-- √âtat connect√© avec token valide -->
                        <div v-else-if="googleCalendarConnected && googleCalendarTokenValid" class="bg-white rounded-xl p-6 border-2 border-green-300">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center shadow-lg flex-shrink-0">
                                        <i class="fa-solid fa-check text-xl text-white"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-slate-800 text-base flex items-center gap-2">
                                            Connect√© √† Google Calendar
                                            <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full font-bold">Token valide</span>
                                        </h4>
                                        <p class="text-sm text-slate-600">{{ googleCalendarUserEmail }}</p>
                                    </div>
                                </div>
                                <button @click="disconnectGoogleCalendar" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-xl font-bold transition shadow-lg flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-sign-out-alt"></i>
                                    <span>Se d√©connecter</span>
                                </button>
                            </div>
                            <div class="bg-green-50 rounded-lg p-4 border border-green-200 mt-4">
                                <p class="text-sm text-green-700 font-medium mb-2">
                                    <i class="fa-solid fa-check-circle mr-2"></i>
                                    Les rendez-vous sont automatiquement ajout√©s √† Google Calendar lors de leur validation.
                                </p>
                                <p v-if="tokenTimeRemaining" class="text-xs text-green-600 font-bold flex items-center gap-2">
                                    <i class="fa-solid fa-clock"></i>
                                    Token valide encore : {{ tokenTimeRemaining.minutes }}min {{ tokenTimeRemaining.seconds }}s
                                </p>
                            </div>
                        </div>

                        <!-- √âtat connect√© mais token invalide/expir√© -->
                        <div v-else-if="googleCalendarConnected && !googleCalendarTokenValid" class="bg-white rounded-xl p-6 border-2 border-orange-300">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 bg-orange-500 rounded-full flex items-center justify-center shadow-lg flex-shrink-0">
                                        <i class="fa-solid fa-exclamation-triangle text-xl text-white"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-slate-800 text-base flex items-center gap-2">
                                            Connect√© mais token invalide
                                            <span class="text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded-full font-bold animate-pulse">Expir√©</span>
                                        </h4>
                                        <p class="text-sm text-slate-600">{{ googleCalendarUserEmail }}</p>
                                    </div>
                                </div>
                                <button @click="disconnectGoogleCalendar" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-xl font-bold transition shadow-lg flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-sign-out-alt"></i>
                                    <span>Se d√©connecter</span>
                                </button>
                            </div>
                            <div class="bg-orange-50 rounded-lg p-4 border border-orange-200 mb-4">
                                <p class="text-sm text-orange-800 font-bold mb-2 flex items-center gap-2">
                                    <i class="fa-solid fa-exclamation-triangle"></i>
                                    Attention : Votre session a expir√©
                                </p>
                                <p class="text-sm text-orange-700">
                                    Le token d'authentification n'est plus valide. Vous devez vous reconnecter pour que les rendez-vous soient ajout√©s √† l'agenda.
                                </p>
                            </div>
                            <button @click="connectGoogleCalendar" class="w-full bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-xl font-bold transition shadow-lg flex items-center justify-center gap-2">
                                <i class="fa-brands fa-google"></i>
                                <span>Se reconnecter √† Google Calendar</span>
                            </button>
                            <p v-if="tokenTimeRemaining" class="text-xs text-orange-600 font-bold text-center mt-2 flex items-center justify-center gap-2">
                                <i class="fa-solid fa-clock"></i>
                                Expiration dans : {{ tokenTimeRemaining.minutes }}min {{ tokenTimeRemaining.seconds }}s
                            </p>
                        </div>
                        
                        <!-- √âtat non connect√© -->
                        <div v-else-if="!googleCalendarConnected" class="bg-white rounded-xl p-6 border border-slate-200">
                            <div class="text-center py-4">
                                <div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i class="fa-brands fa-google text-3xl text-slate-400"></i>
                                </div>
                                <h4 class="text-lg font-bold text-slate-800 mb-2">Non connect√©</h4>
                                <p class="text-sm text-slate-600 mb-6">Connectez-vous pour synchroniser automatiquement les rendez-vous avec Google Calendar</p>
                                <button @click="connectGoogleCalendar" class="bg-blue-500 hover:bg-blue-600 text-white px-8 py-3 rounded-xl font-bold transition shadow-lg flex items-center justify-center gap-2 mx-auto">
                                    <i class="fa-brands fa-google"></i>
                                    <span>Se connecter</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- SECTION LOGS D√âTAILL√âS -->
                <div v-if="settingsModal.tab==='Logs' && user.role==='admin'" class="space-y-4 md:space-y-6">
                    <div class="bg-gradient-to-br from-slate-50 to-blue-50 rounded-2xl p-6 md:p-8 border-2 border-slate-200">
                        <h3 class="font-bold text-xl mb-4 text-slate-800 flex items-center gap-2">
                            <i class="fa-solid fa-list text-blue-600"></i>
                            Journaux d√©taill√©s des actions
                        </h3>
                        <p class="text-sm text-slate-600 mb-6">Historique complet de toutes les actions effectu√©es dans l'application (connexions, d√©connexions, cr√©ations, modifications, etc.)</p>
                        
                        <div class="bg-white rounded-xl p-4 border border-slate-200 max-h-[60vh] overflow-y-auto">
                            <div v-if="detailedLogs.length === 0" class="text-center py-8 text-slate-400">
                                <i class="fa-solid fa-inbox text-4xl mb-2 block opacity-50"></i>
                                <p>Aucun journal disponible</p>
                            </div>
                            <div v-else class="space-y-2">
                                <div v-for="log in detailedLogs" :key="log.id" class="bg-slate-50 rounded-lg p-3 border border-slate-200 text-xs hover:bg-slate-100 transition">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="font-bold text-slate-700">{{ log.user || log.details?.utilisateur || 'Syst√®me' }}</span>
                                        <span class="text-slate-500">{{ new Date(log.timestamp).toLocaleString('fr-FR', {day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit'}) }}</span>
                                    </div>
                                    <div class="text-slate-600">
                                        <span class="font-bold">{{ log.action }}</span>
                                        <span v-if="log.details?.client"> - {{ log.details.client }}</span>
                                        <span v-if="log.details?.motif"> ({{ log.details.motif }})</span>
                                        <span v-if="log.details?.heure"> - {{ log.details.heure }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <button @click="loadDetailedLogs" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-xl font-bold transition">
                            <i class="fa-solid fa-sync-alt mr-2"></i>
                            Actualiser les journaux
                        </button>
                    </div>
                </div>
                
                <!-- SECTION TABLEAU DE BORD -->
                <div v-if="settingsModal.tab==='Dashboard' && user.role==='admin'" class="space-y-4 md:space-y-6">
                    <div class="bg-gradient-to-br from-purple-50 to-blue-50 rounded-2xl p-6 md:p-8 border-2 border-purple-200">
                        <h3 class="font-bold text-xl mb-4 text-slate-800 flex items-center gap-2">
                            <i class="fa-solid fa-chart-line text-purple-600"></i>
                            Tableau de bord de performance
                        </h3>
                        <p class="text-sm text-slate-600 mb-6">Statistiques d√©taill√©es sur les 30 derniers jours</p>
                        
                        <!-- Statistiques principales -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                            <div class="bg-white rounded-xl p-4 border border-blue-200 shadow-sm">
                                <div class="text-xs text-slate-500 uppercase font-bold mb-1">Taux de confirmation</div>
                                <div class="text-2xl font-black text-blue-600 mb-1">{{ performanceStats.tauxConfirmation }}%</div>
                                <div class="text-xs text-slate-400">{{ performanceStats.totalConfirmes || 0 }} RDV confirm√©s</div>
                            </div>
                            <div class="bg-white rounded-xl p-4 border border-red-200 shadow-sm">
                                <div class="text-xs text-slate-500 uppercase font-bold mb-1">Taux d'annulation</div>
                                <div class="text-2xl font-black text-red-600 mb-1">{{ performanceStats.tauxAnnulation }}%</div>
                                <div class="text-xs text-slate-400">{{ performanceStats.totalAnnules || 0 }} RDV annul√©s</div>
                            </div>
                            <div class="bg-white rounded-xl p-4 border border-green-200 shadow-sm">
                                <div class="text-xs text-slate-500 uppercase font-bold mb-1">Taux d'honorisation</div>
                                <div class="text-2xl font-black text-green-600 mb-1">{{ performanceStats.tauxHonorisation }}%</div>
                                <div class="text-xs text-slate-400">{{ performanceStats.totalHonores || 0 }} RDV honor√©s</div>
                            </div>
                            <div class="bg-white rounded-xl p-4 border border-orange-200 shadow-sm">
                                <div class="text-xs text-slate-500 uppercase font-bold mb-1">Taux de pr√©sence</div>
                                <div class="text-2xl font-black text-orange-600 mb-1">{{ performanceStats.tauxPresence }}%</div>
                                <div class="text-xs text-slate-400">{{ performanceStats.totalPresents || 0 }} pr√©sents</div>
                            </div>
                        </div>
                        
                        <!-- Statistiques d√©taill√©es -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div class="bg-white rounded-xl p-4 border border-slate-200">
                                <h4 class="font-bold text-sm mb-3 text-slate-800 flex items-center gap-2">
                                    <i class="fa-solid fa-calendar-check text-blue-600"></i>
                                    R√©partition des statuts
                                </h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-slate-600">Total RDV (30j)</span>
                                        <span class="font-bold text-slate-800">{{ performanceStats.totalRdvs || 0 }}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-slate-600">En attente</span>
                                        <span class="font-bold text-orange-600">{{ performanceStats.totalEnAttente || 0 }}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-slate-600">Pas venus</span>
                                        <span class="font-bold text-red-600">{{ performanceStats.totalPasVenus || 0 }}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-xl p-4 border border-slate-200">
                                <h4 class="font-bold text-sm mb-3 text-slate-800 flex items-center gap-2">
                                    <i class="fa-solid fa-clock text-purple-600"></i>
                                    Activit√© r√©cente
                                </h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-slate-600">RDV cr√©√©s aujourd'hui</span>
                                        <span class="font-bold text-blue-600">{{ performanceStats.rdvAujourdhui || 0 }}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-slate-600">RDV cette semaine</span>
                                        <span class="font-bold text-purple-600">{{ performanceStats.rdvCetteSemaine || 0 }}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-slate-600">RDV ce mois</span>
                                        <span class="font-bold text-indigo-600">{{ performanceStats.rdvCeMois || 0 }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pr√©diction de charge -->
                        <div class="bg-white rounded-xl p-4 border border-slate-200">
                            <h4 class="font-bold text-lg mb-4 text-slate-800 flex items-center gap-2">
                                <i class="fa-solid fa-calendar-days text-green-600"></i>
                                Pr√©diction de charge de travail (7 prochains jours)
                            </h4>
                            <div class="space-y-2">
                                <div v-for="day in workloadPrediction" :key="day.date" class="flex items-center justify-between p-3 bg-gradient-to-r from-slate-50 to-white rounded-lg border" :class="day.count > 10 ? 'border-red-200' : day.count > 5 ? 'border-orange-200' : 'border-green-200'">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-lg flex items-center justify-center font-bold text-sm" :class="day.count > 10 ? 'bg-red-100 text-red-600' : day.count > 5 ? 'bg-orange-100 text-orange-600' : 'bg-green-100 text-green-600'">
                                            {{ day.count }}
                                        </div>
                                        <span class="font-medium text-slate-700">{{ day.label }}</span>
                                    </div>
                                    <span class="text-xs text-slate-500">{{ day.date }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            
        </div>
    </div>
    
    <!-- BULK MODAL Z-INDEX FIX -->
    <div v-if="bulkModal.open" class="fixed inset-0 bg-slate-900/60 z-[400] flex items-center justify-center p-4 ">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-sm text-center pop-in border border-slate-200">
            <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 shadow-xl" 
                 :class="bulkModal.action.includes('delete') || bulkModal.action.includes('trash') ? 'bg-red-100 text-red-500' : 'bg-blue-100 text-blue-600'">
                <i class="fa-solid text-3xl" :class="bulkModal.action.includes('delete') || bulkModal.action.includes('trash') ? 'fa-trash-can' : 'fa-circle-question'"></i>
            </div>
            <h3 class="font-bold text-2xl mb-3 text-slate-800">√ätes-vous s√ªr ?</h3>
            <p class="text-slate-600 mb-8 font-medium text-lg leading-relaxed">{{ bulkModal.label }}</p>
            <div class="grid grid-cols-2 gap-4">
                <button @click="bulkModal.open=false" class="bg-slate-100 text-slate-600 py-3 rounded-xl font-bold hover:bg-slate-200 transition text-sm">Non, annuler</button>
                <button @click="executeBulkAction" 
                        :class="bulkModal.action.includes('delete') || bulkModal.action.includes('trash') ? 'bg-red-600 hover:bg-red-700 shadow-red-200' : 'bg-blue-600 hover:bg-blue-700 shadow-blue-200'"
                        class="text-white py-3 rounded-xl font-bold transition shadow-lg transform active:scale-95 text-sm">
                    Oui, confirmer
                </button>
            </div>
        </div>
    </div>
    
    <!-- MODAL HISTORIQUE UTILISATEUR -->
    <div v-if="userHistoryModal.open" class="fixed inset-0 bg-slate-900/60 z-[400] flex items-center justify-center p-4" @click.self="userHistoryModal.open = false">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col pop-in border border-slate-200">
            <div class="p-6 border-b border-slate-200 bg-gradient-to-r from-blue-50 to-purple-50 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold text-lg">
                        {{ userHistoryModal.user?.name?.charAt(0).toUpperCase() || 'U' }}
                    </div>
                    <div>
                        <h3 class="font-bold text-xl text-slate-800">{{ userHistoryModal.user?.name || 'Utilisateur' }}</h3>
                        <p class="text-sm text-slate-600">Historique des connexions</p>
                    </div>
                </div>
                <button @click="userHistoryModal.open = false" class="bg-slate-100 hover:bg-slate-200 text-slate-600 w-10 h-10 rounded-full flex items-center justify-center transition">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-6">
                <div v-if="userHistoryModal.loading" class="text-center py-12">
                    <i class="fa-solid fa-spinner fa-spin text-4xl text-blue-500 mb-4"></i>
                    <p class="text-slate-600">Chargement de l'historique...</p>
                </div>
                <div v-else-if="userHistoryModal.history.length === 0" class="text-center py-12 text-slate-400">
                    <i class="fa-solid fa-inbox text-4xl mb-4 block opacity-50"></i>
                    <p>Aucun historique disponible</p>
                </div>
                <div v-else class="space-y-3">
                    <!-- R√©sum√© mensuel -->
                    <div v-if="monthlySummaries[userHistoryModal.user?.name]" class="bg-gradient-to-r from-purple-50 to-blue-50 rounded-xl p-4 border-2 border-purple-200 mb-4">
                        <h4 class="font-bold text-purple-700 mb-2 flex items-center gap-2">
                            <i class="fa-solid fa-chart-line"></i>
                            R√©sum√© mensuel
                        </h4>
                        <div class="grid grid-cols-3 gap-4 text-sm">
                            <div>
                                <div class="text-slate-600">Connexions</div>
                                <div class="font-bold text-lg text-purple-700">{{ monthlySummaries[userHistoryModal.user?.name]?.connexions || 0 }}</div>
                            </div>
                            <div>
                                <div class="text-slate-600">Temps total</div>
                                <div class="font-bold text-lg text-purple-700">{{ monthlySummaries[userHistoryModal.user?.name]?.tempsTotal || '0h' }}</div>
                            </div>
                            <div>
                                <div class="text-slate-600">Derni√®re connexion</div>
                                <div class="font-bold text-lg text-purple-700">{{ monthlySummaries[userHistoryModal.user?.name]?.derniereConnexion || '-' }}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Liste des connexions -->
                    <div v-for="log in userHistoryModal.history" :key="log.id" class="bg-slate-50 rounded-lg p-4 border-2 border-slate-200 hover:bg-slate-100 transition">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-sm" :class="log.action === 'connexion' ? 'bg-green-500' : 'bg-red-500'">
                                    <i :class="log.action === 'connexion' ? 'fa-solid fa-sign-in-alt' : 'fa-solid fa-sign-out-alt'" class="text-xs"></i>
                                </div>
                                <div>
                                    <div class="font-bold text-slate-800">
                                        {{ log.action === 'connexion' ? 'Connexion' : 'D√©connexion' }}
                                    </div>
                                    <div class="text-xs text-slate-500">{{ new Date(log.timestamp).toLocaleString('fr-FR', {day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit', second:'2-digit'}) }}</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs font-bold" :class="log.action === 'connexion' ? 'text-green-600' : 'text-red-600'">
                                    {{ log.action === 'connexion' ? '‚úì' : '‚úó' }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- EDITING AGENCY Z-INDEX FIX -->
    <div v-if="editingAgency" class="fixed inset-0 bg-slate-900/80 z-[350] flex items-center justify-center p-4 "><div class="bg-white w-full max-w-lg rounded-3xl shadow-2xl p-6 fade-in max-h-[90vh] overflow-y-auto"><h3 class="font-bold text-xl mb-6 text-slate-800">{{ editingAgency.id ? 'Modifier' : 'Nouvelle' }} Agence</h3><div class="space-y-4"><div><label class="text-xs font-bold text-gray-500 uppercase">Nom</label><input v-model="editingAgency.nom" class="w-full p-3 border rounded-xl outline-none focus:border-blue-500 bg-slate-50 font-bold"></div><div><label class="text-xs font-bold text-gray-500 uppercase">Adresse Postale</label><input v-model="editingAgency.adresse" class="w-full p-3 border rounded-xl outline-none focus:border-blue-500 bg-slate-50"></div><div><label class="text-xs font-bold text-gray-500 uppercase">Lien Google Maps (Short)</label><input v-model="editingAgency.maps" class="w-full p-3 border rounded-xl outline-none focus:border-blue-500 bg-slate-50 text-blue-600"></div><div><label class="text-xs font-bold text-gray-500 uppercase">Phrase d'accroche (SMS)</label><input v-model="editingAgency.tagline" placeholder="Ex: votre expert rachat" class="w-full p-3 border rounded-xl outline-none focus:border-blue-500 bg-slate-50"></div><div><label class="text-xs font-bold text-gray-500 uppercase">Agenda Google (Email)</label><input v-model="editingAgency.agendaEmail" type="email" placeholder="exemple@gmail.com" class="w-full p-3 border rounded-xl outline-none focus:border-purple-500 bg-slate-50 font-mono text-sm"><p class="text-[10px] text-gray-400 mt-1">Entrez l'adresse email de la personne qui partage son agenda Google avec vous. Si vide, l'agenda principal sera utilis√© par d√©faut.</p></div><div><label class="text-xs font-bold text-gray-500 uppercase mb-2 block">Couleur de l'√©v√©nement</label><div class="grid grid-cols-6 gap-2"><div v-for="(color, id) in {1:'Lavande',2:'Sauge',3:'Raisin',4:'Flamant',5:'Banane',6:'Mandarine',7:'Paon',8:'Graphite',9:'Myrtille',10:'Basilic',11:'Tomate'}" :key="id" @click="editingAgency.agendaColor = String(id)" :class="String(editingAgency.agendaColor) === String(id) ? 'ring-2 ring-purple-500 ring-offset-2' : ''" class="cursor-pointer rounded-lg p-2 border-2 transition hover:scale-110" :style="{backgroundColor: getCalendarColor(Number(id))}"><div class="w-full h-8 rounded" :style="{backgroundColor: getCalendarColor(Number(id))}"></div><p class="text-[8px] text-center mt-1 font-bold text-slate-600">{{ color }}</p></div></div><p class="text-[10px] text-gray-400 mt-2">Choisissez la couleur des √©v√©nements dans Google Calendar</p></div><div v-if="user.role==='admin'" class="pt-4 border-t"><div class="mb-4"><label class="flex items-center gap-2 font-bold text-slate-700 cursor-pointer"><input type="checkbox" v-model="editingAgency.horairesIdentiques" class="custom-checkbox" @change="applyHorairesToAllDays"> <span>M√™me horaire pour tous les jours</span></label></div><div class="mb-4"><label class="flex items-center gap-2 font-bold text-slate-700 cursor-pointer"><input type="checkbox" v-model="editingAgency.dimancheFerme" class="custom-checkbox"> <span>Dimanche ferm√©</span></label></div><div class="mb-4"><label class="flex items-center gap-2 font-bold text-slate-700 cursor-pointer"><input type="checkbox" v-model="editingAgency.samediFerme" class="custom-checkbox"> <span>Samedi ferm√©</span></label></div><label class="text-xs font-bold text-gray-500 uppercase mb-3 block">Horaires par jour</label><p class="text-[10px] text-gray-400 mb-3">D√©finissez les horaires d'ouverture et de fermeture pour chaque jour de la semaine</p><div class="space-y-2"><div v-for="(dayName, dayIndex) in ['Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi','Dimanche']" :key="dayIndex" :class="{'opacity-50': (dayIndex === 5 && editingAgency.samediFerme) || (dayIndex === 6 && editingAgency.dimancheFerme)}" class="grid grid-cols-4 gap-2 items-center p-2 rounded-lg" :style="(dayIndex === 5 && editingAgency.samediFerme) || (dayIndex === 6 && editingAgency.dimancheFerme) ? 'background: #fee2e2;' : ''"><div class="text-xs font-bold text-slate-600 col-span-1">{{ dayName }}</div><div class="col-span-3 grid grid-cols-2 gap-2"><input type="time" :v-model="`editingAgency.horaires_${dayIndex}_ouverture`" @input="editingAgency[`horaires_${dayIndex}_ouverture`] = $event.target.value" :value="editingAgency[`horaires_${dayIndex}_ouverture`] || ''" :disabled="(dayIndex === 5 && editingAgency.samediFerme) || (dayIndex === 6 && editingAgency.dimancheFerme)" placeholder="Ouverture" class="w-full p-2 border border-slate-200 rounded-lg bg-white text-xs font-bold"><input type="time" :v-model="`editingAgency.horaires_${dayIndex}_fermeture`" @input="editingAgency[`horaires_${dayIndex}_fermeture`] = $event.target.value" :value="editingAgency[`horaires_${dayIndex}_fermeture`] || ''" :disabled="(dayIndex === 5 && editingAgency.samediFerme) || (dayIndex === 6 && editingAgency.dimancheFerme)" placeholder="Fermeture" class="w-full p-2 border border-slate-200 rounded-lg bg-white text-xs font-bold"></div></div></div></div><div class="pt-2"><label class="text-xs font-bold text-gray-500 uppercase mb-2 block">Pause d√©jeuner (optionnel)</label><div class="grid grid-cols-2 gap-3"><div><label class="text-[10px] font-bold text-gray-400 uppercase mb-1 block">D√©but pause</label><input type="time" v-model="editingAgency.heurePauseDebut" class="w-full p-2 border border-slate-200 rounded-lg bg-white text-sm font-bold"></div><div><label class="text-[10px] font-bold text-gray-400 uppercase mb-1 block">Fin pause</label><input type="time" v-model="editingAgency.heurePauseFin" class="w-full p-2 border border-slate-200 rounded-lg bg-white text-sm font-bold"></div></div></div><div class="pt-4 border-t"><label class="text-xs font-bold text-gray-500 uppercase mb-2 block">Heure limite exceptionnelle (optionnel)</label><p class="text-[10px] text-gray-400 mb-3">D√©finissez une heure √† partir de laquelle l'agence ne prend plus de rendez-vous exceptionnellement (ex: 17h en hiver car il fait nuit t√¥t)</p><div class="space-y-3"><div class="flex gap-2 items-end"><div class="flex-1"><label class="text-[10px] font-bold text-gray-400 uppercase mb-1 block">Heure limite</label><input type="time" v-model="editingAgency.heureLimiteExceptionnelle" class="w-full p-2 border border-slate-200 rounded-lg bg-white text-sm font-bold"></div><button v-if="editingAgency.heureLimiteExceptionnelle" @click="editingAgency.heureLimiteExceptionnelle=''; editingAgency.motifHeureLimite=''" class="text-red-600 hover:text-red-800 font-bold px-3 py-2 border border-red-200 rounded-lg hover:bg-red-50 transition" title="Supprimer l'heure limite"><i class="fa-solid fa-trash"></i></button></div><div v-if="editingAgency.heureLimiteExceptionnelle"><label class="text-[10px] font-bold text-gray-400 uppercase mb-1 block">Motif</label><input type="text" v-model="editingAgency.motifHeureLimite" placeholder="Ex: Il fait nuit t√¥t en hiver, on ne voit pas le v√©hicule" class="w-full p-2 border border-slate-200 rounded-lg bg-white text-sm"></div></div></div><div class="grid grid-cols-2 gap-4"><div><label class="text-xs font-bold text-gray-500 uppercase">Prix HT (‚Ç¨)</label><input type="number" v-model="editingAgency.prix_ht" @input="calculateTTC" class="w-full p-3 border rounded-xl outline-none focus:border-blue-500 bg-slate-50"></div><div><label class="text-xs font-bold text-gray-500 uppercase">TVA (%)</label><input type="number" v-model="editingAgency.tva_taux" @input="calculateTTC" placeholder="20" class="w-full p-3 border rounded-xl outline-none focus:border-blue-500 bg-slate-50"></div></div><div class="flex items-center justify-between p-3 bg-slate-100 rounded-xl"><span class="font-bold text-slate-700">Prix Affich√© (TTC)</span><span class="text-xl font-black text-blue-600">{{ formatPrice(editingAgency.prix) }}</span></div><div><label class="flex items-center gap-2 font-bold text-slate-700 cursor-pointer"><input type="checkbox" v-model="editingAgency.tva" class="custom-checkbox"> <span>Afficher "TTC" dans les SMS</span></label></div><div class="pt-4 border-t"><label class="text-xs font-bold text-gray-500 uppercase mb-2 block">√âtat de l'agence</label><div class="flex gap-2"><button @click="editingAgency.statut_activite='actif'" :class="editingAgency.statut_activite==='actif' ? 'bg-green-500 text-white shadow-md' : 'bg-slate-100 text-slate-500'" class="flex-1 py-2 rounded-xl font-bold transition">Actif</button><button @click="editingAgency.statut_activite='pause'" :class="editingAgency.statut_activite==='pause' ? 'bg-red-500 text-white shadow-md' : 'bg-slate-100 text-slate-500'" class="flex-1 py-2 rounded-xl font-bold transition">En Pause</button></div></div><div v-if="editingAgency.statut_activite==='pause'" class="space-y-3 bg-red-50 p-4 rounded-xl border border-red-100 animate-fadeIn"><div><label class="text-xs font-bold text-red-500 uppercase">Motif de la pause</label><select v-model="pauseReasonSelect" @change="updatePauseReason" class="w-full p-2 border border-red-200 rounded-lg outline-none bg-white font-bold text-slate-700 mt-1"><option value="Vacances">Vacances</option><option value="Complet">Complet / Surcharg√©</option><option value="Travaux">Travaux</option><option value="Autre">Autre (personnalis√©)</option></select><input v-if="pauseReasonSelect==='Autre'" v-model="editingAgency.motif_pause" placeholder="Pr√©cisez le motif..." class="w-full mt-2 p-2 border border-red-200 rounded-lg outline-none bg-white"></div><div v-if="pauseReasonSelect==='Vacances'" class="grid grid-cols-2 gap-2"><div><label class="text-[10px] font-bold text-red-400 uppercase">D√©but</label><input type="date" v-model="editingAgency.date_pause_debut" class="w-full p-2 border border-red-200 rounded-lg bg-white text-sm"></div><div><label class="text-[10px] font-bold text-red-400 uppercase">Fin (inclus)</label><input type="date" v-model="editingAgency.date_pause_fin" class="w-full p-2 border border-red-200 rounded-lg bg-white text-sm"></div></div></div><div class="pt-4 border-t"><label class="text-xs font-bold text-gray-500 uppercase mb-3 block">Cong√©s / Fermetures exceptionnelles</label><p class="text-[10px] text-gray-400 mb-3">D√©finissez des dates pr√©cises o√π l'agence sera ferm√©e. Aucun rendez-vous ne pourra √™tre pris ces jours-l√†.</p><div class="space-y-2 max-h-60 overflow-y-auto bg-orange-50 p-3 rounded-xl border border-orange-200"><div v-for="(fermeture, idx) in editingAgencyFermetures" :key="idx" class="flex flex-col gap-2 bg-white p-3 rounded-lg border border-orange-200"><div class="flex gap-2 items-end"><div class="flex-1 grid grid-cols-2 gap-2"><div><label class="text-[10px] font-bold text-orange-600 uppercase mb-1 block">Date d√©but</label><input type="date" v-model="fermeture.date_debut" class="w-full px-2 py-2 border border-orange-200 rounded-lg text-xs font-bold outline-none focus:border-orange-500"></div><div><label class="text-[10px] font-bold text-orange-600 uppercase mb-1 block">Date fin (inclus)</label><input type="date" v-model="fermeture.date_fin" class="w-full px-2 py-2 border border-orange-200 rounded-lg text-xs font-bold outline-none focus:border-orange-500"></div></div><button @click="saveFermetureIndividuelle(idx)" :disabled="!fermeture.date_debut || !fermeture.date_fin" :class="fermeture.date_debut && fermeture.date_fin ? 'bg-green-500 hover:bg-green-600 text-white' : 'bg-gray-300 text-gray-500 cursor-not-allowed'" class="px-3 py-2 rounded-lg font-bold text-xs transition flex items-center gap-1 self-end" title="Enregistrer cette fermeture"><i class="fa-solid fa-check"></i> <span class="hidden sm:inline">OK</span></button><button @click="removeAgencyFermeture(idx)" class="text-red-600 hover:text-red-800 font-bold px-2 py-2 self-end"><i class="fa-solid fa-trash"></i></button></div><div v-if="fermeture.date_debut && fermeture.date_fin && isFermetureValide(fermeture)" class="text-xs text-green-600 font-bold flex items-center gap-1"><i class="fa-solid fa-check-circle"></i> Fermeture enregistr√©e</div></div><button @click="addAgencyFermeture" class="w-full bg-orange-100 text-orange-600 px-4 py-2 rounded-lg font-bold text-sm hover:bg-orange-200 transition flex items-center justify-center gap-2"><i class="fa-solid fa-plus"></i> Ajouter une fermeture exceptionnelle</button></div></div><div class="pt-4 border-t"><label class="text-xs font-bold text-gray-500 uppercase mb-3 block">Commerciaux (pour le Bilan)</label><p class="text-[10px] text-gray-400 mb-3">Si l'agence a des commerciaux, ils seront demand√©s lors de l'honorisation des RDV. Si vide, les RDV seront automatiquement ajout√©s au Bilan.</p><div class="space-y-2 max-h-60 overflow-y-auto bg-slate-50 p-3 rounded-xl border border-slate-200"><div v-for="(comm, idx) in editingAgencyCommerciaux" :key="idx" class="flex gap-2 items-center bg-white p-2 rounded-lg border border-slate-200"><input type="text" v-model="comm.name" placeholder="Nom du commercial" class="flex-1 px-3 py-2 border border-slate-200 rounded-lg text-sm font-medium outline-none focus:border-blue-500"><input type="number" v-model.number="comm.obj" placeholder="Obj." class="w-20 px-2 py-2 border border-slate-200 rounded-lg text-sm font-bold text-center outline-none focus:border-blue-500"><button @click="removeAgencyCommercial(idx)" class="text-red-600 hover:text-red-800 font-bold px-2"><i class="fa-solid fa-trash"></i></button></div><button @click="addAgencyCommercial" class="w-full bg-blue-100 text-blue-600 px-4 py-2 rounded-lg font-bold text-sm hover:bg-blue-200 transition flex items-center justify-center gap-2"><i class="fa-solid fa-plus"></i> Ajouter un commercial</button></div></div></div><div class="flex gap-4 mt-6"><button @click="editingAgency=null" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-bold hover:bg-gray-300">Annuler</button><button @click="saveEditingAgency" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700">Enregistrer</button></div></div></div>
    <!-- WIZARD Z-INDEX FIX -->
    <div v-if="wizard.open" class="fixed inset-0 bg-slate-100 z-[500] flex flex-col h-screen overflow-hidden">
        
        <div class="bg-white p-2 shadow-sm border-b border-slate-200 sticky top-0 z-[510] flex justify-between items-center flex-shrink-0">
            <h3 class="font-bold text-lg text-slate-800 flex items-center gap-2">
                <span class="bg-blue-600 text-white w-7 h-7 rounded-lg flex items-center justify-center text-xs font-black">{{ wizard.step }}/6</span>
                <span>Nouveau RDV</span>
            </h3>
            <button @click="wizard.open=false" class="bg-red-500 hover:bg-red-600 text-white font-bold px-4 py-2 rounded-xl transition flex items-center gap-2 shadow-md">
                <i class="fa-solid fa-xmark"></i> Fermer
            </button>
        </div>

        <div class="flex-1 overflow-y-auto p-2 md:p-4 flex items-start justify-center">
            <div class="w-full max-w-lg bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden fade-in my-auto">
                
                <div class="p-4 md:p-6 space-y-4">

                    <div v-if="wizard.step===1">
                        <h4 class="text-center font-black text-2xl mb-2 text-slate-800">Choisir l'Agence</h4>
                        <p class="text-center text-slate-400 text-sm mb-6">O√π aura lieu le rendez-vous ?</p>
                        
                        <div class="relative mb-4">
                            <i class="fa-solid fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            <input v-model="agencySearch" placeholder="Rechercher..." class="w-full pl-12 p-4 border-2 border-slate-200 rounded-2xl font-bold outline-none focus:border-blue-500 transition">
                        </div>

                        <div class="space-y-3 max-h-[50vh] overflow-y-auto pr-1">
                            <button v-for="ag in filteredAgences" :key="ag.id" @click="checkAgenceAndProceed(ag)" :class="[
                                ag.statut_activite==='pause' ? 'border-red-200 bg-red-50 opacity-80' : 'border-slate-200 hover:border-blue-500 hover:bg-blue-50',
                                ag.statut_activite !== 'pause' && isAgenceFermeeAujourdhui(ag) ? 'border-orange-300 bg-orange-50 opacity-80' : ''
                            ]" class="w-full p-5 border-2 rounded-2xl text-left transition group relative flex flex-col justify-center">
                                <div class="font-bold text-lg text-slate-800 group-hover:text-blue-600 mb-1">{{ ag.nom }}</div>
                                <div class="text-xs text-gray-500 truncate">{{ ag.adresse }}</div>
                                <div v-if="ag.statut_activite==='pause'" class="absolute top-1/2 -translate-y-1/2 right-4 text-red-500 font-black text-xs border border-red-200 bg-white px-2 py-1 rounded">PAUSE</div>
                                <div v-else-if="isAgenceFermeeAujourdhui(ag)" class="absolute top-1/2 -translate-y-1/2 right-4 text-orange-600 font-black text-xs border border-orange-200 bg-white px-2 py-1 rounded">FERM√â</div>
                                <i v-else class="fa-solid fa-chevron-right absolute top-1/2 -translate-y-1/2 right-4 text-slate-300 group-hover:text-blue-500"></i>
                            </button>
                            <div v-if="filteredAgences.length === 0" class="text-center text-gray-400 py-4 italic">Aucune agence trouv√©e.</div>
                        </div>
                    </div>

                    <div v-if="wizard.step===2">
                        <h4 class="text-center font-black text-2xl mb-8 text-slate-800">Informations Client</h4>
                        
                        <div class="flex gap-4 mb-6">
                            <button @click="form.civilite='M.'" :class="form.civilite==='M.'?'bg-blue-600 text-white shadow-lg scale-105':'bg-slate-100 text-slate-500 hover:bg-slate-200'" class="flex-1 py-3 rounded-xl font-bold transition transform">Monsieur</button>
                            <button @click="form.civilite='Mme'" :class="form.civilite==='Mme'?'bg-pink-500 text-white shadow-lg scale-105':'bg-slate-100 text-slate-500 hover:bg-slate-200'" class="flex-1 py-3 rounded-xl font-bold transition transform">Madame</button>
                        </div>

                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-1 ml-1">Nom Complet</label>
                                <input v-model="form.nom" @input="formatNameRealTime" @blur="onWizardNameBlur" @paste="onWizardNamePaste" placeholder="Ex: Dupont Jean" class="w-full text-lg font-bold border-2 border-slate-200 rounded-2xl p-4 outline-none focus:border-blue-500 bg-slate-50 focus:bg-white transition">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-1 ml-1">T√©l√©phone</label>
                                <div class="relative">
                                    <input type="tel" :value="form.telephone" @input="onWizardPhoneInput" :disabled="form.pasDeNumero" placeholder="06 12 34 56 78" class="w-full text-lg font-mono font-bold border-2 border-slate-200 rounded-2xl p-4 outline-none focus:border-blue-500 tracking-widest bg-slate-50 focus:bg-white transition text-center disabled:opacity-50 disabled:cursor-not-allowed">
                                    <button @click="pastePhoneNumber" :disabled="form.pasDeNumero" class="absolute right-3 top-1/2 -translate-y-1/2 text-blue-600 hover:text-blue-800 bg-blue-100 p-2 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed" title="Coller"><i class="fa-solid fa-paste"></i></button>
                                </div>
                                <label class="flex items-center gap-2 mt-3 cursor-pointer">
                                    <input type="checkbox" v-model="form.pasDeNumero" class="w-4 h-4 text-blue-600 border-slate-300 rounded focus:ring-blue-500">
                                    <span class="text-sm text-slate-600 font-medium">Cette personne n'a pas de num√©ro de t√©l√©phone</span>
                                </label>
                            </div>
                        </div>

                        <p v-if="clientExists" class="text-green-600 text-sm text-center mt-4 font-bold animate-pulse bg-green-50 p-2 rounded-xl border border-green-100">‚ú® Client existant d√©tect√© !</p>

                        <div class="flex gap-3 mt-8 pt-4 border-t border-slate-100">
                            <button @click="wizard.step--" class="px-6 bg-slate-100 text-slate-500 rounded-xl font-bold hover:bg-slate-200">Retour</button>
                            <button @click="wizard.step++" :disabled="!form.nom || (!form.pasDeNumero && normalizePhone(form.telephone).length<10)" class="flex-1 bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-blue-700 disabled:opacity-50 disabled:shadow-none transition transform active:scale-95">Suivant</button>
                        </div>
                    </div>

                    <div v-if="wizard.step===3">
                        <h4 class="text-center font-black text-2xl mb-8 text-slate-800">Date & Heure</h4>
                        
                        <div class="mb-8">
                            <div class="flex items-center justify-between mb-4">
                                <label class="text-xs font-bold text-slate-400 uppercase tracking-widest ml-1">Le Jour</label>
                                <input type="date" v-model="form.date" @change="form.heure=null" class="bg-slate-50 border-none rounded-lg text-sm font-bold text-slate-600 outline-none focus:text-blue-600 cursor-pointer">
                            </div>
                            
                            <div class="flex overflow-x-auto gap-3 pb-2 snap-x hide-scrollbar">
                                <button v-for="d in dateOptions" :key="d.val" @click="form.date=d.val; form.heure=null" 
                                    :class="[
                                        form.date===d.val ? 'bg-slate-800 text-white shadow-lg scale-105' : 'bg-white border text-slate-500 hover:border-slate-400',
                                        form.agence && isDateInFermeture(d.val, form.agence) ? 'border-red-300 bg-red-50 opacity-75' : 'border-slate-200'
                                    ]" 
                                    class="flex-shrink-0 w-16 h-20 rounded-2xl flex flex-col items-center justify-center transition-all duration-300 snap-center group relative">
                                    <span class="text-[10px] font-bold uppercase mb-1 opacity-70">{{ d.dayName }}</span>
                                    <span class="text-2xl font-black leading-none">{{ d.dayNum }}</span>
                                    <span v-if="d.isToday" class="mt-1 w-1 h-1 rounded-full bg-blue-500"></span>
                                    <span v-if="form.agence && isDateInFermeture(d.val, form.agence)" class="absolute top-1 right-1 text-red-500 text-xs"><i class="fa-solid fa-ban"></i></span>
                                </button>
                            </div>
                        </div>

                        <div v-if="form.date" class="animate-fadeIn">
                            <!-- Message d'alerte si la date est en fermeture -->
                            <div v-if="form.agence && isDateInFermeture(form.date, form.agence)" class="mb-4 p-4 bg-red-50 border-2 border-red-200 rounded-xl animate-fadeIn">
                                <div class="flex items-start gap-3">
                                    <i class="fa-solid fa-ban text-red-500 text-xl mt-0.5"></i>
                                    <div class="flex-1">
                                        <p class="font-bold text-red-700 mb-1">‚ö†Ô∏è Agence ferm√©e</p>
                                        <p class="text-sm text-red-600">{{ getFermetureMessage(form.date, form.agence) }}</p>
                                        <p class="text-xs text-red-500 mt-2">Aucun rendez-vous ne peut √™tre pris cette journ√©e.</p>
                                    </div>
                                </div>
                            </div>
                            
                            <label class="text-xs font-bold text-slate-400 uppercase tracking-widest ml-1 mb-3 block">L'Heure</label>
                            
                            <div v-if="!form.agence || !isDateInFermeture(form.date, form.agence)" class="flex flex-wrap gap-2 justify-center">
                                <button v-for="h in timeSlots" :key="h" 
                                    @click="checkHeureFermetureAndConfirm(() => { form.heure=h; wizard.step++; })" 
                                    class="px-4 py-2 rounded-full border border-slate-200 text-slate-600 font-bold text-sm hover:bg-slate-800 hover:text-white hover:border-slate-800 hover:shadow-lg transition transform active:scale-95">
                                    {{ h }}
                                </button>
                            </div>
                            
                            <div v-else class="text-center p-6 bg-red-50 border-2 border-red-200 rounded-xl">
                                <p class="text-red-600 font-bold">Les cr√©neaux horaires ne sont pas disponibles</p>
                            </div>

                            <div v-if="!form.agence || !isDateInFermeture(form.date, form.agence)" class="mt-8 flex justify-center border-t border-slate-100 pt-6">
                                <div class="relative group">
                                    <input type="time" v-model="form.heure" @input="handleTimeInput" @change="handleTimeInput" class="pl-10 pr-4 py-2 bg-slate-50 rounded-xl text-sm font-bold text-slate-500 border border-transparent hover:bg-white hover:border-slate-200 focus:bg-white focus:border-blue-500 focus:text-blue-600 outline-none transition text-center shadow-inner">
                                    <i class="fa-regular fa-clock absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div v-else class="text-center p-8 text-slate-300 text-sm italic font-medium bg-slate-50 rounded-2xl border border-dashed border-slate-200">
                            üëÜ S√©lectionnez une date ci-dessus
                        </div>

                        <div class="flex gap-3 mt-8 pt-6 border-t border-slate-100">
                            <button @click="wizard.step--" class="px-6 bg-white border border-slate-200 text-slate-500 rounded-xl font-bold hover:bg-slate-50 transition text-sm">Retour</button>
                            <button v-if="form.heure && (!form.agence || !isDateInFermeture(form.date, form.agence))" @click="checkHeureFermetureAndConfirm(() => wizard.step++)" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition text-sm">Suivant <i class="fa-solid fa-arrow-right ml-2"></i></button>
                        </div>
                    </div>

                    <div v-if="wizard.step===4">
                        <h4 class="text-center font-black text-2xl mb-8 text-slate-800">Source du RDV</h4>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <button v-for="src in sourcesList" @click="selectSource(src)" :class="form.source === src ? 'border-blue-500 bg-blue-50 ring-2 ring-blue-200 shadow-md' : 'border-slate-200 bg-white hover:border-blue-300 hover:bg-slate-50'" class="p-6 rounded-2xl border-2 flex flex-col items-center gap-3 transition transform active:scale-95">
                                <img :src="getLogo(src)" class="w-10 h-10 rounded-lg object-contain">
                                <span class="font-bold text-slate-700 text-sm">{{ src }}</span>
                            </button>
                        </div>

                        <div class="flex gap-3 mt-8 pt-4 border-t border-slate-100">
                            <button @click="wizard.step--" class="w-full bg-slate-100 text-slate-500 py-3 rounded-xl font-bold hover:bg-slate-200">Retour</button>
                        </div>
                    </div>

                    <div v-if="wizard.step===5">
                        <h4 class="text-center font-black text-2xl mb-8 text-slate-800">V√©hicule</h4>
                        
                        <!-- CHAMP INTELLIGENT POUR COLLER DEPUIS LE BON COIN OU FACEBOOK -->
                        <div v-if="form.source === 'Facebook' || form.source === 'Leboncoin'" class="mb-6 p-4 bg-gradient-to-br from-blue-50 to-purple-50 border-2 border-blue-200 rounded-2xl">
                            <label class="text-xs font-bold text-blue-700 uppercase mb-2 block flex items-center gap-2">
                                <i class="fa-solid fa-magic"></i>
                                <span v-if="form.source === 'Facebook'">Caract√©ristiques Facebook Intelligent</span>
                                <span v-else>Mode Intelligent (Collez depuis Le Bon Coin)</span>
                            </label>
                            <textarea 
                                v-model="intelligentPaste" 
                                @paste="handleIntelligentPaste" 
                                @input="handleIntelligentPaste"
                                :placeholder="form.source === 'Facebook' ? 'Collez ici le texte copi√© depuis Facebook (titre, prix, caract√©ristiques)...&#10;Exemple:&#10;2007 Citro√´n c3&#10;2 300 ‚Ç¨&#10;245 000 km au compteur&#10;Bo√Æte de vitesse manuelle&#10;Couleur ext√©rieure : Beige' : 'Collez ici le texte copi√© depuis Le Bon Coin (titre, infos, prix)...&#10;Exemple:&#10;AUDI Q2 1.5 35 TFSI - 150 - BV S-tronic Design&#10;Ganges ¬∑ 2023 ¬∑ 32950 km ¬∑ Essence&#10;26 990 ‚Ç¨'"
                                class="w-full p-4 text-sm border-2 border-blue-300 rounded-xl outline-none focus:border-blue-500 transition bg-white text-slate-700 font-medium min-h-[120px] resize-none"
                            ></textarea>
                            <p class="text-xs text-blue-600 mt-2 flex items-center gap-1">
                                <i class="fa-solid fa-lightbulb"></i>
                                <span v-if="form.source === 'Facebook'">Le syst√®me d√©tecte automatiquement le mod√®le, le prix et formate les caract√©ristiques</span>
                                <span v-else>Le syst√®me d√©tecte automatiquement le mod√®le (premi√®re ligne) et le prix</span>
                            </p>
                            <div v-if="form.source === 'Facebook' && form.facebookCaracteristiquesFormatees" class="mt-3 p-3 bg-white border border-blue-300 rounded-lg">
                                <p class="text-xs font-bold text-slate-600 mb-2">Aper√ßu format√© :</p>
                                <div class="text-xs text-slate-700 whitespace-pre-line font-mono">{{ form.facebookCaracteristiquesFormatees }}</div>
                            </div>
                        </div>
                        
                        <div class="w-full relative group mb-4">
                            <i class="fa-solid fa-car absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-xl group-focus-within:text-blue-500 transition"></i>
                            <input v-model="form.modele" @input="form.modele = form.modele.toUpperCase()" @blur="form.modele = formatModeleName(form.modele)" @paste="setTimeout(() => { form.modele = formatModeleName(form.modele); }, 0)" placeholder="Marque, Mod√®le, Finition..." class="w-full pl-12 p-5 text-lg border-2 border-slate-200 rounded-2xl outline-none focus:border-blue-600 transition bg-slate-50 focus:bg-white font-bold text-slate-700 shadow-sm uppercase">
                        </div>
                        <p class="text-center text-xs text-slate-400 mb-6">Saisissez le v√©hicule manuellement ou utilisez le mode intelligent ci-dessus.</p>

                        <div class="w-full relative group mb-6">
                            <i class="fa-solid fa-euro-sign absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-xl group-focus-within:text-blue-500 transition"></i>
                            <input v-model.number="form.prix" type="text" @input="formatPrixInput" @paste="handlePrixPaste" @keypress="(e) => { if (!/[0-9.,]/.test(e.key) && !['Backspace', 'Delete', 'Tab', 'Enter'].includes(e.key)) e.preventDefault(); }" placeholder="Prix du v√©hicule (‚Ç¨)" class="w-full pl-12 p-5 text-lg border-2 border-slate-200 rounded-2xl outline-none focus:border-blue-600 transition bg-slate-50 focus:bg-white font-bold text-slate-700 shadow-sm">
                        </div>


                        <div v-if="form.source !== 'Facebook'" class="w-full relative group mb-4">
                            <i class="fa-solid fa-link absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-lg group-focus-within:text-blue-500 transition"></i>
                            <input v-model="form.lienAnnonce" type="url" @blur="handleLienAnnonceBlur" @paste="handleLienAnnoncePaste" placeholder="Collez le lien de l'annonce (Le Bon Coin d√©tect√© automatiquement)" class="w-full pl-12 pr-20 p-4 text-sm border-2 border-slate-200 rounded-2xl outline-none focus:border-blue-600 transition bg-slate-50 focus:bg-white font-medium text-slate-700 shadow-sm">
                            <i v-if="loadingLienAnnonce" class="fa-solid fa-spinner fa-spin absolute right-12 top-1/2 -translate-y-1/2 text-blue-500"></i>
                            <button 
                                v-if="form.lienAnnonce && form.lienAnnonce.includes('leboncoin')" 
                                @click="openLeboncoinInNewTab"
                                class="absolute right-4 top-1/2 -translate-y-1/2 text-blue-600 hover:text-blue-800 text-xs font-bold flex items-center gap-1"
                                title="Ouvrir dans un nouvel onglet pour copier les infos"
                            >
                                <i class="fa-solid fa-external-link"></i>
                            </button>
                        </div>
                        <p v-if="loadingLienAnnonce" class="text-center text-xs text-blue-600 mb-4 font-bold animate-pulse">üîÑ R√©cup√©ration des informations depuis Le Bon Coin...</p>

                        <div class="w-full relative group mb-2">
                            <i class="fa-solid fa-tag absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-lg group-focus-within:text-blue-500 transition z-10"></i>
                            <select v-model="form.motif" class="w-full pl-12 pr-10 p-4 text-sm border-2 border-slate-200 rounded-2xl outline-none focus:border-blue-600 transition bg-slate-50 focus:bg-white font-medium text-slate-700 shadow-sm appearance-none">
                                <option value="">S√©lectionner un motif (facultatif)</option>
                                <option v-for="motif in motifsList" :key="motif" :value="motif">{{ motif }}</option>
                                <option value="__CUSTOM__">Autre (saisie libre)</option>
                            </select>
                            <i class="fa-solid fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                        </div>
                        <div v-if="form.motif === '__CUSTOM__'" class="w-full relative group mb-2">
                            <i class="fa-solid fa-pen absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-lg group-focus-within:text-blue-500 transition"></i>
                            <input v-model="form.motifCustom" placeholder="Pr√©cisez le motif..." class="w-full pl-12 p-4 text-sm border-2 border-slate-200 rounded-2xl outline-none focus:border-blue-600 transition bg-slate-50 focus:bg-white font-medium text-slate-700 shadow-sm">
                        </div>

                        <div class="flex gap-3 mt-12 pt-4 border-t border-slate-100">
                            <button @click="wizard.step--" class="px-6 bg-slate-100 text-slate-500 rounded-xl font-bold hover:bg-slate-200">Retour</button>
                            <button @click="wizard.step++" :disabled="!form.modele" class="flex-1 bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-blue-700 disabled:opacity-50 disabled:shadow-none transition transform active:scale-95">Suivant</button>
                        </div>
                    </div>

                    <div v-if="wizard.step===6">
                        <h4 class="text-center font-black text-2xl mb-6 text-blue-900">R√©capitulatif</h4>
                        
                        <div class="bg-slate-50 p-6 rounded-2xl space-y-3 text-sm border border-slate-200">
                            <div class="flex justify-between border-b border-slate-200 pb-2">
                                <span class="text-slate-500">Agence</span>
                                <b class="text-slate-800">{{ form.agence.nom }}</b>
                            </div>
                            <div class="flex justify-between border-b border-slate-200 pb-2">
                                <span class="text-slate-500">Client</span>
                                <b class="text-slate-800">{{ form.civilite }} {{ form.nom }}</b>
                            </div>
                            <div class="flex justify-between border-b border-slate-200 pb-2">
                                <span class="text-slate-500">T√©l√©phone</span>
                                <b class="font-mono text-slate-800">{{ form.telephone }}</b>
                            </div>
                            <div class="border-b border-slate-200 pb-2">
                                <div class="flex justify-between mb-2">
                                <span class="text-slate-500">V√©hicule</span>
                                    <b class="text-slate-800">{{ getBaseModele(form.modele) || form.modele }}</b>
                                </div>
                                <div v-if="formatCaracteristiquesForDisplay(form.modele).caracteristiques.length > 0" class="mt-2 pt-2 border-t border-slate-100">
                                    <div class="text-xs text-slate-600 space-y-1">
                                        <div v-for="(carac, idx) in formatCaracteristiquesForDisplay(form.modele).caracteristiques" :key="idx" class="flex">
                                            <span class="font-bold text-slate-700 w-32 flex-shrink-0">{{ carac.label }} :</span>
                                            <span class="text-slate-600">{{ carac.value }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div v-if="form.prix" class="flex justify-between border-b border-slate-200 pb-2">
                                <span class="text-slate-500">Prix</span>
                                <b class="text-slate-800">{{ formatPrice(form.prix) }}</b>
                            </div>
                            <div class="flex justify-between border-b border-slate-200 pb-2">
                                <span class="text-slate-500">Date</span>
                                <b class="text-blue-600">{{ formatDateFr(form.date) }} √† {{ form.heure }}</b>
                            </div>
                            <div class="flex justify-between border-b border-slate-200 pb-2">
                                <span class="text-slate-500">Source</span>
                                <div class="flex items-center gap-2">
                                    <img :src="getLogo(form.source)" class="w-4 h-4 rounded">
                                    <b>{{ form.source }}</b>
                                </div>
                            </div>
                            <div v-if="form.lienAnnonce" class="flex justify-between border-b border-slate-200 pb-2">
                                <span class="text-slate-500">Lien de l'annonce</span>
                                <a :href="form.lienAnnonce" target="_blank" class="text-blue-600 hover:text-blue-800 font-medium flex items-center gap-2 underline">
                                    <i class="fa-solid fa-external-link text-xs"></i>
                                    Voir l'annonce
                                </a>
                            </div>
                            <div v-if="form.motif || form.motifCustom" class="flex justify-between">
                                <span class="text-slate-500">Motif</span>
                                <b class="text-slate-800">{{ form.motif === '__CUSTOM__' ? form.motifCustom : form.motif }}</b>
                            </div>
                        </div>

                        <div class="mt-8 space-y-3">
                            <button v-if="!wizard.loading" @click="validateAndSendSMS" class="block w-full bg-green-500 text-white py-4 rounded-2xl font-bold text-center shadow-xl hover:bg-green-600 hover:shadow-2xl flex items-center justify-center gap-3 transform active:scale-95 transition text-lg">
                                <i class="fa-solid fa-paper-plane"></i> 
                                Valider & SMS
                            </button>
                            <button v-else disabled class="w-full bg-green-500 text-white py-4 rounded-2xl font-bold text-center shadow-xl opacity-50 cursor-not-allowed flex items-center justify-center gap-3">
                                <i class="fa-solid fa-spinner fa-spin"></i>
                                Cr√©ation en cours...
                            </button>
                            
                            <button @click="finalizeRdv('confirme')" :disabled="wizard.loading" :class="wizard.loading ? 'opacity-50 cursor-not-allowed' : 'hover:bg-blue-600'" class="w-full bg-blue-500 text-white py-3 rounded-xl font-bold transition flex items-center justify-center gap-2">
                                <i v-if="wizard.loading" class="fa-solid fa-spinner fa-spin"></i>
                                <i v-else class="fa-solid fa-check"></i> 
                                {{ wizard.loading ? 'Cr√©ation en cours...' : 'Confirmer sans SMS' }}
                            </button>
                            
                            <div class="grid grid-cols-2 gap-3 mt-6">
                                <button @click="wizard.step--" :disabled="wizard.loading" :class="wizard.loading ? 'opacity-50 cursor-not-allowed' : 'hover:bg-slate-200'" class="bg-slate-100 text-slate-500 py-3 rounded-xl font-bold transition">Retour</button>
                                <button @click="finalizeRdv('a_confirmer')" :disabled="wizard.loading" :class="wizard.loading ? 'opacity-50 cursor-not-allowed' : 'hover:bg-orange-500 hover:text-white hover:shadow-lg'" class="bg-orange-50 text-orange-600 border-2 border-orange-300 py-3 rounded-xl font-bold transition transform active:scale-95 flex items-center justify-center gap-2 shadow-sm">
                                    <i v-if="wizard.loading" class="fa-solid fa-spinner fa-spin"></i>
                                    <i v-else class="fa-solid fa-clock"></i>
                                    {{ wizard.loading ? 'Cr√©ation...' : 'Confirmer + Tard' }}
                                </button>
                            </div>
                    </div>
                </div>
                
                
            </div>
        </div>
    </div>
    </div>
    
    <!-- MODAL INFO GOOGLE CALENDAR -->
    <div v-if="googleCalendarInfoModal.open" class="fixed inset-0 bg-slate-900/80 z-[600] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-md text-center animate-fadeIn border-2 border-blue-100 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-32 h-32 bg-blue-50 rounded-full -mr-16 -mt-16 opacity-50"></div>
            <div class="relative z-10">
                <div class="w-20 h-20 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-xl">
                    <i class="fa-brands fa-google text-4xl"></i>
                </div>
                <h3 class="font-black text-2xl mb-3 text-slate-800">Google Calendar connect√©</h3>
                <p class="text-slate-600 mb-6 font-medium leading-relaxed">
                    Si vous n'√™tes plus connect√© √† Google, il faudra appuyer sur ce bouton pour vous reconnecter afin que vos rendez-vous se placent bien dans l'agenda.
                </p>
                <button @click="googleCalendarInfoModal.open=false" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg transition transform active:scale-95 flex items-center justify-center gap-2">
                    <i class="fa-solid fa-check"></i>
                    Compris
                </button>
            </div>
        </div>
    </div>
    
    <!-- MODAL AIDE MODE INTELLIGENT -->
    <div v-if="showIntelligentModeHelp" class="fixed inset-0 bg-slate-900/80 z-[600] flex items-center justify-center p-4" @click.self="showIntelligentModeHelp = false">
        <div class="bg-white rounded-xl shadow-2xl p-4 w-full max-w-md text-left animate-fadeIn border-2 border-blue-100 relative">
            <div class="relative z-10">
                <div class="flex items-center gap-2 mb-3">
                    <i class="fa-solid fa-magic text-blue-600 text-lg"></i>
                    <h3 class="font-bold text-lg text-slate-800">Mode Intelligent</h3>
                </div>
                <div class="space-y-2 text-slate-700 text-xs">
                    <div>
                        <h4 class="font-bold text-sm mb-1 flex items-center gap-1">
                            <i class="fa-solid fa-wand-magic-sparkles text-blue-600 text-xs"></i>
                            √Ä quoi √ßa sert ?
                        </h4>
                        <p class="text-xs leading-tight mb-1.5">
                            Collez directement depuis <strong>Le Bon Coin</strong>, <strong>La Centrale</strong> ou <strong>Facebook</strong>. Le syst√®me d√©tecte automatiquement :
                        </p>
                        <ul class="list-disc list-inside text-xs space-y-0.5 ml-3 mb-2">
                            <li>Le <strong>nom du v√©hicule</strong> (obligatoire)</li>
                            <li>Le <strong>prix</strong> (recommand√©)</li>
                            <li>Les <strong>caract√©ristiques</strong> (Facebook)</li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="font-bold text-sm mb-1 flex items-center gap-1">
                            <i class="fa-brands fa-leboncoin text-orange-600 text-xs"></i>
                            Le Bon Coin / La Centrale
                        </h4>
                        <p class="text-xs leading-tight mb-1">
                            Collez au minimum le <strong>nom</strong> et le <strong>prix</strong>.
                        </p>
                        <div class="bg-slate-50 p-2 rounded text-[10px] font-mono text-slate-600 mb-1.5">
                            Exemple : AUDI Q2 1.5 35 TFSI ‚Ä¢ Ganges 2023 ‚Ä¢ 26 990 ‚Ç¨
                        </div>
                    </div>
                    <div>
                        <h4 class="font-bold text-sm mb-1 flex items-center gap-1">
                            <i class="fa-brands fa-facebook text-blue-600 text-xs"></i>
                            Facebook
                        </h4>
                        <p class="text-xs leading-tight mb-1">
                            Collez le <strong>nom</strong>, le <strong>prix</strong> et les <strong>caract√©ristiques</strong>.
                        </p>
                        <div class="bg-slate-50 p-2 rounded text-[10px] font-mono text-slate-600 mb-2">
                            Exemple : 2007 Citro√´n C3 ‚Ä¢ 2 300 ‚Ç¨ ‚Ä¢ 132 500 km ‚Ä¢ Manuel
                        </div>
                    </div>
                </div>
                <button @click="showIntelligentModeHelp = false" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg font-bold shadow-md transition transform active:scale-95 flex items-center justify-center gap-2 mt-3 text-sm">
                    <i class="fa-solid fa-check"></i>
                    Compris
                </button>
            </div>
        </div>
    </div>
    
    <!-- MODAL CONFIRMATION AGENDA -->
    <div v-if="confirmAgendaModal.open" class="fixed inset-0 bg-slate-900/80 z-[600] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-md text-center animate-fadeIn border-2 border-blue-100 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-32 h-32 bg-blue-50 rounded-full -mr-16 -mt-16 opacity-50"></div>
            <div class="relative z-10">
                <div class="w-20 h-20 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-xl">
                    <i class="fa-solid fa-calendar-check text-4xl"></i>
                </div>
                <h3 class="font-black text-2xl mb-3 text-slate-800">V√©rification Agenda</h3>
                <p class="text-slate-600 mb-6 font-medium leading-relaxed">
                    Ce rendez-vous n'est pas encore dans l'agenda.
                </p>
                <p class="text-slate-700 mb-8 font-bold text-lg">
                    Avez-vous bien plac√© ce rendez-vous dans l'agenda avant de valider ?
                </p>
                <div class="flex gap-3">
                    <button @click="confirmAgendaModal.open=false; if(confirmAgendaModal.onConfirm) confirmAgendaModal.onConfirm(false)" class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-700 py-4 rounded-xl font-bold shadow-md transition transform active:scale-95 flex items-center justify-center gap-2">
                        <i class="fa-solid fa-times"></i>
                        Non
                    </button>
                    <button @click="confirmAgendaModal.open=false; if(confirmAgendaModal.onConfirm) confirmAgendaModal.onConfirm(true)" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-4 rounded-xl font-bold shadow-lg transition transform active:scale-95 flex items-center justify-center gap-2">
                        <i class="fa-solid fa-check"></i>
                        Oui
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODAL RECONNEXION POUR AGENDA -->
    <div v-if="reconnectAgendaModal.open" class="fixed inset-0 bg-slate-900/80 z-[600] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-md text-center animate-fadeIn border-2 border-orange-100 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-32 h-32 bg-orange-50 rounded-full -mr-16 -mt-16 opacity-50"></div>
            <div class="relative z-10">
                <div class="w-20 h-20 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-xl animate-pulse">
                    <i class="fa-brands fa-google text-4xl"></i>
                </div>
                <h3 class="font-black text-2xl mb-3 text-slate-800">Connexion requise</h3>
                <p class="text-slate-600 mb-6 font-medium leading-relaxed">
                    Appuyez sur ce bouton pour vous reconnecter et pouvoir ajouter ce rendez-vous dans l'agenda.
                </p>
                <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
                    <p class="text-sm font-bold text-blue-800">
                        <i class="fa-solid fa-info-circle mr-2"></i>
                        D√®s que vous serez reconnect√©, le rendez-vous sera automatiquement ajout√© √† l'agenda.
                    </p>
                </div>
                <div class="flex gap-3">
                    <button @click="reconnectAgendaModal.open=false" class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-700 py-4 rounded-xl font-bold shadow-md transition transform active:scale-95 flex items-center justify-center gap-2">
                        <i class="fa-solid fa-times"></i>
                        Annuler
                    </button>
                    <button @click="handleReconnectForAgenda(reconnectAgendaModal.rdv)" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg transition transform active:scale-95 flex items-center justify-center gap-2">
                        <i class="fa-brands fa-google"></i>
                        Se reconnecter
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- GOOGLE CALENDAR DISCONNECTED MODAL -->
    <div v-if="googleCalendarDisconnectedModal.open" class="fixed inset-0 bg-slate-900/80 z-[600] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-md text-center animate-fadeIn border-2 border-orange-100 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-32 h-32 bg-orange-50 rounded-full -mr-16 -mt-16 opacity-50"></div>
            <div class="relative z-10">
                <div class="w-20 h-20 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-xl animate-pulse">
                    <i class="fa-brands fa-google text-4xl"></i>
                </div>
                <h3 class="font-black text-2xl mb-3 text-slate-800">Connexion Google Agenda requise</h3>
                <p class="text-slate-600 mb-6 font-medium leading-relaxed">
                    Votre session a expir√© ou le token a expir√©.
                </p>
                <div class="bg-slate-50 rounded-2xl p-5 mb-6 border border-slate-200 text-left">
                    <p class="text-sm font-bold text-slate-700 mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-list-check text-orange-500"></i>
                        Pour ajouter ce rendez-vous √† l'agenda :
                    </p>
                    <ol class="space-y-2 text-sm text-slate-600">
                        <li class="flex items-start gap-2">
                            <span class="font-bold text-orange-500">1.</span>
                            <span>Cliquez sur "Se connecter" ci-dessous</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="font-bold text-orange-500">2.</span>
                            <span>Autorisez l'acc√®s √† Google Calendar</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="font-bold text-orange-500">3.</span>
                            <span>Revenez sur ce rendez-vous pour le valider</span>
                        </li>
                    </ol>
                </div>
                <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
                    <p class="text-sm font-bold text-blue-800">
                        <i class="fa-solid fa-info-circle mr-2"></i>
                        Le rendez-vous a √©t√© cr√©√© avec le statut "Confirmer + Tard" et sera ajout√© √† l'agenda une fois reconnect√©.
                    </p>
                </div>
                <div class="flex gap-3">
                    <button @click="handleCloseDisconnectedModal()" class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-700 py-4 rounded-xl font-bold shadow-md transition transform active:scale-95 flex items-center justify-center gap-2">
                        <i class="fa-solid fa-times"></i>
                        {{ googleCalendarDisconnectedModal.fromWizard && googleCalendarRequired ? 'Ignorer' : 'Fermer' }}
                    </button>
                    <button @click="user.role === 'admin' ? connectGoogleCalendar() : connectProspecteurGoogleCalendar()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg transition transform active:scale-95 flex items-center justify-center gap-2">
                        <i class="fa-brands fa-google"></i>
                        Se connecter
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- WELCOME MODAL Z-INDEX FIX -->
    <!-- GLOBAL SEARCH MODAL -->
    <div v-if="globalSearchModal.open" class="fixed inset-0 bg-slate-900/80 z-[500] flex items-center justify-center p-4" @click.self="globalSearchModal.open=false; globalSearchModal.query=''">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[80vh] flex flex-col">
            <div class="p-6 border-b">
                <div class="relative">
                    <i class="fa-solid fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                    <input 
                        id="globalSearchInput"
                        v-model="globalSearchModal.query" 
                        @input="performGlobalSearch"
                        @keyup.enter="selectFirstResult"
                        placeholder="Rechercher par nom, pr√©nom, v√©hicule, t√©l√©phone, date..." 
                        class="w-full pl-12 pr-4 py-4 border-2 border-slate-200 rounded-xl text-lg font-medium outline-none focus:border-blue-500"
                        autofocus
                    >
                    <button @click="globalSearchModal.open=false; globalSearchModal.query=''" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 hover:text-red-500">
                        <i class="fa-solid fa-times text-xl"></i>
                    </button>
                </div>
                <p class="text-xs text-slate-500 mt-2">Appuyez sur Entr√©e pour s√©lectionner, ESC pour fermer</p>
            </div>
            <div class="flex-1 overflow-y-auto p-4">
                <div v-if="globalSearchModal.query && globalSearchModal.results.length === 0" class="text-center py-8 text-slate-400">
                    <i class="fa-solid fa-search text-4xl mb-2"></i>
                    <p>Aucun r√©sultat trouv√©</p>
                </div>
                <div v-else-if="globalSearchModal.results.length > 0" class="space-y-2">
                    <div 
                        v-for="(result, idx) in globalSearchModal.results" 
                        :key="result.id"
                        @click="openRdvFiche(result); globalSearchModal.open=false; globalSearchModal.query=''"
                        class="p-4 border border-slate-200 rounded-xl hover:border-blue-500 hover:bg-blue-50 cursor-pointer transition"
                        :class="idx === 0 ? 'bg-blue-50 border-blue-300' : ''"
                    >
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <div class="font-bold text-lg text-slate-800">{{ result.civilite }} {{ result.nom }}</div>
                                <div class="text-sm text-slate-600 mt-1">
                                    <span v-if="result.modele">{{ result.modele }} ‚Ä¢ </span>
                                    <span v-if="result.telephone">{{ result.telephone }} ‚Ä¢ </span>
                                    <span>{{ formatDateFr(result.date) }} √† {{ result.heure }}</span>
                                </div>
                                <div class="mt-2">
                                    <span :class="statusClass(result.statut)" class="text-xs px-2 py-1 rounded-full font-bold">{{ displayStatus(result) }}</span>
                                </div>
                            </div>
                            <i class="fa-solid fa-chevron-right text-slate-400"></i>
                        </div>
                    </div>
                </div>
                <div v-else class="text-center py-8 text-slate-400">
                    <i class="fa-solid fa-keyboard text-4xl mb-2"></i>
                    <p class="font-bold mb-1">Raccourcis disponibles</p>
                    <div class="text-xs space-y-1 mt-3">
                        <p><kbd class="bg-slate-100 px-2 py-1 rounded">Ctrl/Cmd + K</kbd> Recherche globale</p>
                        <p><kbd class="bg-slate-100 px-2 py-1 rounded">Ctrl/Cmd + N</kbd> Nouveau RDV</p>
                        <p><kbd class="bg-slate-100 px-2 py-1 rounded">ESC</kbd> Fermer</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div v-if="welcomeModal.open" class="fixed inset-0 bg-slate-900/80 z-[400] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-sm text-center pop-in border-4 border-blue-100">
            <div class="text-6xl mb-4 animate-bounce" style="animation: wave 1s ease-in-out infinite;">
                üëã
            </div>
            <h3 class="font-bold text-2xl mb-2 text-slate-800 animate-slide-in" style="animation: slideIn 0.5s ease-out;">
                {{ welcomeModal.title }}
            </h3>
            <p class="text-slate-600 font-medium mb-6">{{ welcomeModal.message }}</p>
        </div>
    </div>

    <!-- MODAL TUTORIEL PREMI√àRE CONNEXION (DUPLICATE) -->

    <div v-if="tutorialModal.open" class="fixed inset-0 bg-slate-900/80 z-[450] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-lg text-center pop-in border-4 border-blue-100 relative z-[460]">
            <!-- √âTAPE 1 : Bienvenue -->
            <div v-if="tutorialModal.step === 1">
                <div class="text-6xl mb-6 animate-bounce">üëã</div>
                <h3 class="font-bold text-3xl mb-2 text-slate-800 bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                    Bonjour {{ tutorialModal.userName }} !
                </h3>
                <h4 class="font-bold text-2xl mb-6 text-blue-600">Bienvenue sur ARIA</h4>
                <p class="text-slate-700 text-lg mb-6 leading-relaxed">
                    Le service de prise de rendez-vous qui vous simplifie la vie !
                </p>
                <div class="bg-gradient-to-br from-blue-50 to-purple-50 rounded-2xl p-6 mb-6 text-left space-y-4 border-2 border-blue-200">
                    <div>
                        <p class="text-slate-800 font-bold text-lg mb-2 flex items-center gap-2">
                            <span>‚ú®</span> √Ä quoi √ßa sert ?
                        </p>
                        <p class="text-slate-700 font-medium leading-relaxed">
                            Vous allez pouvoir <strong class="text-blue-600">placer des rendez-vous</strong>, <strong class="text-blue-600">suivre vos rendez-vous</strong> et <strong class="text-blue-600">g√©rer vos rendez-vous</strong> facilement.
                    </p>
                </div>
                    <div class="pt-4 border-t-2 border-blue-200">
                        <p class="text-slate-700 font-semibold mb-3 flex items-center gap-2">
                            <span class="text-2xl">üí¨</span> Besoin d'aide ?
                        </p>
                        <p class="text-slate-600 text-sm mb-4 leading-relaxed">
                            Contactez directement <strong class="text-blue-600">C&N Solutions</strong> sur WhatsApp ou au <strong class="text-blue-600">07 56 96 95 02</strong>
                        </p>
                        <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-4 border-2 border-green-200 mb-3">
                            <p class="text-slate-700 text-sm flex items-start gap-2">
                                <span class="text-2xl mt-0.5">üé•</span>
                                <span>Une <strong>vid√©o tutoriel</strong> vous sera envoy√©e sur WhatsApp ou par email via WeTransfer pour comprendre le fonctionnement de l'application.</span>
                            </p>
                        </div>
                    </div>
                </div>
                <div class="flex gap-3 mt-6">
                    <a href="https://wa.me/33756969502?text=Bonjour%20j%27aimerais%20avoir%20la%20vid√©o%20de%20tuto%20pour%20ARIA" target="_blank" class="flex-1 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white py-4 rounded-xl font-bold text-base transition-all shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center justify-center gap-2">
                        <i class="fa-brands fa-whatsapp text-xl"></i>
                        WhatsApp
                    </a>
                    <button @click="tutorialModal.step = 2" class="flex-1 bg-gradient-to-r from-blue-600 to-purple-600 text-white py-4 rounded-xl font-bold text-lg hover:from-blue-700 hover:to-purple-700 transition-all shadow-lg hover:shadow-xl transform hover:scale-105">
                        Compris
                </button>
            </div>
            </div>

            <!-- √âTAPE 2 : Fin du tutoriel -->
            <div v-if="tutorialModal.step === 2">
                <div class="text-6xl mb-6 animate-bounce">üéâ</div>
                <h3 class="font-bold text-3xl mb-4 text-green-600">C'est bon, vous √™tes pr√™ts !</h3>
                <p class="text-slate-700 text-lg mb-6">
                    Vous pouvez maintenant commencer √† utiliser ARIA. 
                </p>
                <button @click="tutorialModal.open = false" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 text-white py-4 rounded-xl font-bold text-lg hover:from-green-700 hover:to-emerald-700 transition-all shadow-lg transform hover:scale-105">
                        Commencer <i class="fa-solid fa-check ml-2"></i>
                    </button>
            </div>
        </div>
    </div>

    <!-- MODAL VID√âO TUTORIEL -->
    <div v-if="tutorialVideoModal.open && globalSettings.tutorialVideoUrl" class="fixed inset-0 bg-slate-900/80 z-[500] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="bg-gradient-to-r from-blue-600 to-purple-600 p-4 text-white flex items-center justify-between">
                <h3 class="font-bold text-xl">üìπ Vid√©o Tutoriel - ARIA</h3>
                <button @click="tutorialVideoModal.open = false" class="text-white hover:text-slate-200 transition">
                    <i class="fa-solid fa-times text-2xl"></i>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-6">
                <div class="aspect-video w-full bg-black rounded-lg overflow-hidden">
                    <iframe 
                        :src="globalSettings.tutorialVideoUrl" 
                        class="w-full h-full" 
                        frameborder="0" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen>
                    </iframe>
                </div>
            </div>
        </div>
    </div>

    <style>
        @keyframes wave {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(20deg); }
            75% { transform: rotate(-20deg); }
        }
        @keyframes slideIn {
            0% { 
                transform: translateY(-20px);
                opacity: 0;
            }
            100% { 
                transform: translateY(0);
                opacity: 1;
            }
        }
        .animate-slide-in {
            animation: slideIn 0.5s ease-out;
        }
    </style>
    
    <!-- CANCEL MODAL Z-INDEX FIX -->
    <div v-if="cancelModal.open" class="fixed inset-0 bg-slate-900/60 z-[350] flex items-center justify-center p-4" @click.self="cancelModal.open=false; cancelModal.motif=''; cancelModal.motifCustom=''; cancelModal.selectedMotif=''; cancelModal.sendSMS=false; cancelModal.who=''">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md text-center relative">
            <button @click="cancelModal.open=false; cancelModal.motif=''; cancelModal.motifCustom=''; cancelModal.selectedMotif=''; cancelModal.sendSMS=false; cancelModal.who=''" class="absolute top-4 right-4 w-8 h-8 rounded-full hover:bg-slate-100 flex items-center justify-center text-slate-400 hover:text-slate-600 transition">
                <i class="fa-solid fa-times"></i>
            </button>
            <h3 class="font-bold text-lg mb-4">Annuler le rendez-vous</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2 text-left">Qui a annul√© ?</label>
                    <div class="flex gap-3">
                        <button @click="cancelModal.who='client'" :class="cancelModal.who==='client'?'bg-blue-600 text-white shadow-lg':'bg-slate-100 text-slate-700 hover:bg-slate-200'" class="flex-1 py-3 rounded-xl font-bold transition">Le Client</button>
                        <button @click="cancelModal.who='agence'" :class="cancelModal.who==='agence'?'bg-blue-600 text-white shadow-lg':'bg-slate-100 text-slate-700 hover:bg-slate-200'" class="flex-1 py-3 rounded-xl font-bold transition">L'Agence</button>
                    </div>
                </div>
                <!-- Motif obligatoire seulement si c'est le client qui annule -->
                <div v-if="cancelModal.who === 'client'">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2 text-left">Motif d'annulation *</label>
                    <select v-model="cancelModal.selectedMotif" @change="cancelModal.motifCustom=''" class="w-full p-3 border-2 border-slate-200 rounded-xl text-sm font-medium text-slate-700 outline-none focus:border-blue-500 bg-white">
                        <option value="">S√©lectionner un motif...</option>
                        <option v-for="motif in cancelMotifsList" :key="motif" :value="motif">{{ motif }}</option>
                        <option value="autre">Autre (saisir manuellement)</option>
                    </select>
                    <input v-if="cancelModal.selectedMotif === 'autre'" v-model="cancelModal.motifCustom" placeholder="Saisir le motif d'annulation..." class="w-full mt-3 p-3 border-2 border-slate-200 rounded-xl text-sm font-medium text-slate-700 outline-none focus:border-blue-500 bg-white">
                </div>
                <!-- Pour l'agence, pas de motif requis -->
                <div v-if="cancelModal.who === 'agence'" class="p-3 bg-blue-50 rounded-xl border border-blue-200">
                    <p class="text-sm text-blue-700 font-medium">L'annulation par l'agence ne n√©cessite pas de motif. Vous pouvez directement valider et envoyer le SMS.</p>
                </div>
                <!-- Option SMS -->
                <div v-if="cancelModal.who" class="flex items-center gap-2 p-3 bg-slate-50 rounded-xl">
                    <input type="checkbox" v-model="cancelModal.sendSMS" id="sendSMS" class="w-5 h-5 rounded border-slate-300 text-blue-600 focus:ring-blue-500">
                    <label for="sendSMS" class="text-sm font-medium text-slate-700 cursor-pointer">Envoyer un SMS au client</label>
                </div>
                <!-- Boutons de validation -->
                <div v-if="cancelModal.who" class="flex gap-3 mt-4">
                    <button @click="cancelModal.open=false; cancelModal.motif=''; cancelModal.motifCustom=''; cancelModal.selectedMotif=''; cancelModal.sendSMS=false; cancelModal.who=''" class="flex-1 bg-gray-100 text-gray-500 py-3 rounded-xl font-bold hover:bg-gray-200">Retour</button>
                    <button v-if="cancelModal.who === 'agence'" @click="confirmCancel(cancelModal.rdv, cancelModal.who, '', cancelModal.sendSMS)" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-3 rounded-xl font-bold shadow-md transition">Valider & SMS</button>
                    <button v-else @click="confirmCancel(cancelModal.rdv, cancelModal.who, cancelModal.selectedMotif === 'autre' ? cancelModal.motifCustom : cancelModal.selectedMotif, cancelModal.sendSMS)" :disabled="!cancelModal.selectedMotif || (cancelModal.selectedMotif === 'autre' && !cancelModal.motifCustom)" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-3 rounded-xl font-bold shadow-md disabled:opacity-50 disabled:cursor-not-allowed transition">Confirmer l'annulation</button>
                </div>
                <button v-if="!cancelModal.who" @click="cancelModal.open=false; cancelModal.motif=''; cancelModal.motifCustom=''; cancelModal.selectedMotif=''; cancelModal.sendSMS=false; cancelModal.who=''" class="block w-full mt-4 text-gray-400 hover:text-gray-600 text-sm font-bold">Retour</button>
            </div>
        </div>
    </div>
    
    <!-- PAUSED AGENCY Z-INDEX FIX (Z-INDEX 500 pour √™tre devant Wizard) -->
    <div v-if="pausedAgencyModal.open" class="fixed inset-0 bg-slate-900/60 z-[500] flex items-center justify-center p-4 "><div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-sm text-center animate-shake border-4 border-red-100"><div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl"><i class="fa-solid fa-ban"></i></div><h3 class="font-bold text-xl mb-2 text-slate-800">Agence Indisponible</h3><p class="text-slate-600 mb-6 font-medium">{{ getPauseMessage(pausedAgencyModal.agency) }}</p><button @click="pausedAgencyModal.open=false" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold hover:bg-slate-900 transition">Compris</button></div></div>
    
    <!-- RESCHEDULE Z-INDEX FIX -->
    <!-- MODAL CONFIRMATION RETRAIT AGENDA -->
    <div v-if="removeAgendaConfirmModal.open" class="fixed inset-0 bg-slate-900/80 z-[400] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden pop-in">
            <div class="p-6">
                <div class="flex items-center justify-center w-16 h-16 bg-red-100 rounded-full mx-auto mb-4">
                    <i class="fa-solid fa-calendar-times text-red-600 text-2xl"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-800 text-center mb-2">Retirer de l'agenda ?</h3>
                <p class="text-sm text-slate-600 text-center mb-6">√ätes-vous s√ªr de vouloir retirer ce rendez-vous de l'agenda Google Calendar ?</p>
                <div class="flex gap-3">
                    <button @click="removeAgendaConfirmModal.open=false" class="flex-1 bg-slate-100 text-slate-700 py-3 rounded-xl font-bold hover:bg-slate-200 transition">Annuler</button>
                    <button @click="confirmRemoveFromAgenda" class="flex-1 bg-red-600 text-white py-3 rounded-xl font-bold hover:bg-red-700 transition shadow-lg">Confirmer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL AJOUTER/√âDITER FERMETURE -->
    <div v-if="fermetureModal.open" class="fixed inset-0 bg-slate-900/80 z-[400] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full overflow-hidden pop-in">
            <div class="bg-gradient-to-r from-red-600 to-red-700 p-5 text-white flex justify-between items-center">
                <h3 class="font-bold text-lg flex items-center gap-2">
                    <i class="fa-solid fa-calendar-xmark"></i>
                    {{ fermetureModal.editingId ? 'Modifier la Fermeture' : 'Ajouter une Fermeture' }}
                </h3>
                <button @click="fermetureModal.open=false; fermetureModal.dateDebut=''; fermetureModal.dateFin=''; fermetureModal.motif=''; fermetureModal.tousProfessionnels=false; fermetureModal.editingId=null" class="w-8 h-8 rounded-full hover:bg-white/20 flex items-center justify-center transition">‚úï</button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-700 mb-2 block">Date de d√©but *</label>
                    <input type="date" v-model="fermetureModal.dateDebut" class="w-full p-3 border-2 border-slate-200 rounded-xl text-sm font-medium text-slate-700 outline-none focus:border-red-500">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-700 mb-2 block">Date de fin *</label>
                    <input type="date" v-model="fermetureModal.dateFin" :min="fermetureModal.dateDebut" class="w-full p-3 border-2 border-slate-200 rounded-xl text-sm font-medium text-slate-700 outline-none focus:border-red-500">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-700 mb-2 block">Motif (optionnel)</label>
                    <input type="text" v-model="fermetureModal.motif" placeholder="Ex: Cong√©s annuels, Jour f√©ri√©..." class="w-full p-3 border-2 border-slate-200 rounded-xl text-sm font-medium text-slate-700 outline-none focus:border-red-500">
                </div>
                <div class="bg-red-50 border-2 border-red-200 rounded-xl p-4">
                    <p class="text-xs text-slate-600 mb-3">
                        <i class="fa-solid fa-info-circle text-red-600 mr-2"></i>
                        <span v-if="fermetureModal.editingId">Cette fermeture sera mise √† jour dans l'agenda Google Calendar.</span>
                        <span v-else>Cette fermeture sera automatiquement ajout√©e dans l'agenda Google Calendar de <strong>tous les professionnels</strong> pour toute la journ√©e.</span>
                    </p>
                </div>
                <div class="flex gap-3">
                    <button @click="fermetureModal.open=false; fermetureModal.dateDebut=''; fermetureModal.dateFin=''; fermetureModal.motif=''; fermetureModal.tousProfessionnels=false; fermetureModal.editingId=null" class="flex-1 bg-slate-100 text-slate-700 py-3 rounded-xl font-bold hover:bg-slate-200 transition">Annuler</button>
                    <button @click="fermetureModal.editingId ? updateFermeture() : createFermeture()" :disabled="!fermetureModal.dateDebut || !fermetureModal.dateFin" class="flex-1 bg-red-600 text-white py-3 rounded-xl font-bold hover:bg-red-700 transition shadow-lg disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                        <i :class="fermetureModal.editingId ? 'fa-solid fa-save' : 'fa-solid fa-calendar-plus'"></i>
                        {{ fermetureModal.editingId ? 'Sauvegarder' : 'Cr√©er la fermeture' }}
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODAL CONFIRMATION SUPPRESSION FERMETURE -->
    <div v-if="fermetureDeleteConfirmModal.open" class="fixed inset-0 bg-slate-900/80 z-[400] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden pop-in">
            <div class="p-6">
                <div class="flex items-center justify-center w-16 h-16 bg-red-100 rounded-full mx-auto mb-4">
                    <i class="fa-solid fa-trash text-red-600 text-2xl"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-800 text-center mb-2">Supprimer la fermeture ?</h3>
                <p class="text-sm text-slate-600 text-center mb-6">√ätes-vous s√ªr de vouloir supprimer cette fermeture ? Les √©v√©nements seront retir√©s des agendas Google Calendar.</p>
                <div class="flex gap-3">
                    <button @click="fermetureDeleteConfirmModal.open=false; fermetureDeleteConfirmModal.fermetureId=null" class="flex-1 bg-slate-100 text-slate-700 py-3 rounded-xl font-bold hover:bg-slate-200 transition">Annuler</button>
                    <button @click="confirmDeleteFermeture" class="flex-1 bg-red-600 text-white py-3 rounded-xl font-bold hover:bg-red-700 transition shadow-lg">Confirmer</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODAL CONFIRMATION HEURE PROCHE FERMETURE -->
    <div v-if="heureFermetureConfirmModal.open" class="fixed inset-0 bg-slate-900/80 z-[400] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden pop-in">
            <div class="p-6">
                <div class="flex items-center justify-center w-16 h-16 bg-orange-100 rounded-full mx-auto mb-4">
                    <i class="fa-solid fa-clock text-orange-600 text-2xl"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-800 text-center mb-2">Heure proche de la fermeture</h3>
                <p class="text-sm text-slate-600 text-center mb-4">
                    L'heure s√©lectionn√©e (<strong>{{ heureFermetureConfirmModal.heure }}</strong>) est proche de l'heure de fermeture de l'agence (<strong>{{ heureFermetureConfirmModal.heureFermeture }}</strong>).
                </p>
                <p class="text-sm text-slate-500 text-center mb-6">√ätes-vous s√ªr de vouloir placer ce rendez-vous √† cette heure ?</p>
                <div class="flex gap-3">
                    <button @click="heureFermetureConfirmModal.open=false; heureFermetureConfirmModal.onConfirm=null" class="flex-1 bg-slate-100 text-slate-700 py-3 rounded-xl font-bold hover:bg-slate-200 transition">Annuler</button>
                    <button @click="confirmHeureFermeture" class="flex-1 bg-orange-600 text-white py-3 rounded-xl font-bold hover:bg-orange-700 transition shadow-lg">Oui, confirmer</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODAL HEURE LIMITE EXCEPTIONNELLE -->
    <div v-if="heureLimiteExceptionnelleModal.open" class="fixed inset-0 bg-slate-900/80 z-[500] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden pop-in">
            <div class="p-6">
                <div class="flex items-center justify-center w-16 h-16 bg-red-100 rounded-full mx-auto mb-4">
                    <i class="fa-solid fa-ban text-red-600 text-2xl"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-800 text-center mb-2">Heure limite d√©pass√©e</h3>
                <p class="text-sm text-slate-600 text-center mb-4">
                    Cette agence ne prend plus de rendez-vous √† partir de <strong>{{ heureLimiteExceptionnelleModal.heureLimite }}</strong>.
                </p>
                <p v-if="heureLimiteExceptionnelleModal.motif" class="text-sm text-slate-500 text-center mb-2 bg-slate-50 p-3 rounded-lg border border-slate-200">
                    <strong>Motif :</strong> {{ heureLimiteExceptionnelleModal.motif }}
                </p>
                <p class="text-sm text-slate-500 text-center mb-6">L'heure s√©lectionn√©e (<strong>{{ heureLimiteExceptionnelleModal.heure }}</strong>) est apr√®s cette limite.</p>
                <div class="flex gap-3">
                    <button @click="heureLimiteExceptionnelleModal.open=false" class="flex-1 bg-slate-100 text-slate-700 py-3 rounded-xl font-bold hover:bg-slate-200 transition">Fermer</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODAL CONFIRMATION HEURE APR√àS FERMETURE -->
    <div v-if="heureApresFermetureModal.open" class="fixed inset-0 bg-slate-900/80 z-[500] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden pop-in">
            <div class="p-6">
                <div class="flex items-center justify-center w-16 h-16 bg-red-100 rounded-full mx-auto mb-4">
                    <i class="fa-solid fa-clock text-red-600 text-2xl"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-800 text-center mb-2">Agence ferm√©e √† cette heure</h3>
                <p class="text-sm text-slate-600 text-center mb-4">
                    L'heure s√©lectionn√©e (<strong>{{ heureApresFermetureModal.heure }}</strong>) est apr√®s l'heure de fermeture de l'agence (<strong>{{ heureApresFermetureModal.heureFermeture }}</strong>).
                </p>
                <p class="text-sm text-slate-500 text-center mb-6">L'agence est ferm√©e √† cette heure. Souhaitez-vous vraiment placer ce rendez-vous ?</p>
                <div class="flex gap-3">
                    <button @click="heureApresFermetureModal.open=false; heureApresFermetureModal.onConfirm=null" class="flex-1 bg-slate-100 text-slate-700 py-3 rounded-xl font-bold hover:bg-slate-200 transition">Annuler</button>
                    <button @click="confirmHeureApresFermeture" class="flex-1 bg-red-600 text-white py-3 rounded-xl font-bold hover:bg-red-700 transition shadow-lg">Oui, continuer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL REPORTER RENDEZ-VOUS -->
    <div v-if="rescheduleModal.open" class="fixed inset-0 bg-slate-900/80 z-[350] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh] fade-in">
            <div class="bg-gradient-to-r from-blue-600 to-blue-700 p-5 text-white flex justify-between items-center">
                <h3 class="font-bold text-lg flex items-center gap-2">
                    <i class="fa-solid fa-calendar-xmark"></i>
                    Reporter Rendez-Vous
                </h3>
                <button @click="rescheduleModal.open=false; rescheduleModal.demandePar=''" class="w-8 h-8 rounded-full hover:bg-white/20 flex items-center justify-center transition">‚úï</button>
            </div>
            
            <div v-if="rescheduleModal.step===1" class="p-6 overflow-y-auto space-y-4 bg-white">
                <div class="bg-blue-50 border-2 border-blue-200 rounded-xl p-4 mb-4">
                    <p class="text-sm font-bold text-blue-700 text-center">RDV Actuel: {{ formatDateFr(rescheduleModal.rdv.date) }} √† {{ rescheduleModal.rdv.heure }}</p>
                </div>
                
                <!-- S√©lection type de demande -->
                <div v-if="!rescheduleModal.demandePar" class="mb-4">
                    <label class="text-xs font-bold text-slate-700 mb-3 block uppercase tracking-wide">Type de demande *</label>
                    <div class="grid grid-cols-2 gap-3">
                        <button @click="rescheduleModal.demandePar='client'" class="p-5 bg-gradient-to-br from-blue-50 to-indigo-50 border-2 border-blue-300 rounded-xl hover:border-blue-500 hover:shadow-lg transition-all text-left group">
                            <div class="text-3xl mb-2">üë§</div>
                            <div class="font-bold text-slate-800 mb-1 text-sm">√Ä la demande du client</div>
                            <div class="text-xs text-slate-600">Le client souhaite reporter</div>
                        </button>
                        <button @click="rescheduleModal.demandePar='interne'" class="p-5 bg-gradient-to-br from-purple-50 to-pink-50 border-2 border-purple-300 rounded-xl hover:border-purple-500 hover:shadow-lg transition-all text-left group">
                            <div class="text-3xl mb-2">üè¢</div>
                            <div class="font-bold text-slate-800 mb-1 text-sm">Demande interne</div>
                            <div class="text-xs text-slate-600">Report √† l'initiative de l'agence</div>
                        </button>
                    </div>
                </div>
                
                <!-- Date (pour demande client ou interne) -->
                <div v-if="rescheduleModal.demandePar === 'client' || rescheduleModal.demandePar === 'interne'">
                    <div class="mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <h5 class="text-xs font-black uppercase text-slate-500 tracking-wider">
                            <i class="fa-solid fa-calendar-alt text-blue-500"></i> Choisir le Nouveau Jour :
                        </h5>
                        <input type="date" v-model="rescheduleModal.date" @change="rescheduleModal.heure=null" class="p-1 border border-slate-200 rounded-lg text-xs font-bold text-slate-700 outline-none focus:border-blue-500 shadow-sm cursor-pointer hover:bg-blue-50">
                    </div>
                    <div class="overflow-x-auto pb-2 hide-scrollbar snap-x flex space-x-2">
                        <button v-for="d in dateOptions" :key="d.val" @click="rescheduleModal.date=d.val; rescheduleModal.heure=null;" :class="[rescheduleModal.date===d.val ? 'bg-blue-600 text-white shadow-lg transform scale-[1.05] date-card-selected' : 'bg-white border-gray-200 text-gray-600 hover:border-blue-400', d.isToday ? 'border-2 border-green-500 shadow-md' : '']" class="flex-shrink-0 w-16 h-20 rounded-lg flex flex-col items-center justify-center text-sm transition-all duration-300 snap-center date-card p-1">
                            <span :class="rescheduleModal.date===d.val ? 'text-blue-200' : 'text-slate-400'" class="text-[9px] font-bold uppercase mb-0 transition-colors">{{ d.dayName }}</span>
                            <span class="text-2xl font-black leading-none">{{ d.dayNum }}</span>
                            <span class="text-[9px] font-medium opacity-80 mt-1">{{ d.month }}</span>
                        </button>
                    </div>
                </div>
                
                <!-- Heure -->
                <div v-if="rescheduleModal.date" class="overflow-y-auto hide-scrollbar p-2 border border-slate-100 rounded-lg bg-white shadow-inner animate-fadeIn max-h-[300px]">
                    <h5 class="text-xs font-black uppercase text-slate-500 tracking-wider mb-2">
                        <i class="fa-solid fa-clock text-green-500"></i> Choisir la Nouvelle Heure (09:00 - 19:00) :
                    </h5>
                    <div class="space-y-3">
                        <div class="grid grid-cols-4 gap-2">
                            <button v-for="h in timeSlots" :key="h" @click="rescheduleModal.heure=h" :class="rescheduleModal.heure===h ? 'bg-green-500 text-white shadow-md' : 'bg-slate-50 text-slate-600 hover:bg-green-50'" class="py-1.5 rounded-md text-xs font-bold transition-all duration-200">{{ h }}</button>
                        </div>
                        <div class="pt-2 flex justify-center border-t border-slate-100">
                            <input type="time" v-model="rescheduleModal.heure" class="border-2 border-blue-100 rounded-lg p-2 font-bold text-blue-900 text-center text-sm outline-none focus:border-blue-500 bg-blue-50 w-32">
                        </div>
                    </div>
                </div>
                    <div v-else class="flex-1 flex items-center justify-center text-center text-gray-400 border border-dashed border-gray-200 rounded-2xl">
                        <p class="text-sm font-medium p-8">üìÖ Veuillez d'abord s√©lectionner une date ci-dessus.</p>
                    </div>
                </div>
                
                <!-- Motif (apr√®s date/heure pour demande client ou interne) -->
                <div v-if="(rescheduleModal.demandePar === 'client' || rescheduleModal.demandePar === 'interne') && rescheduleModal.date && rescheduleModal.heure" class="mt-4 space-y-3">
                    <label class="text-xs font-bold text-slate-700 uppercase mb-3 block tracking-wide flex items-center gap-2">
                        <i class="fa-solid fa-note-sticky text-blue-600"></i> 
                        <span>Motif du d√©placement *</span>
                    </label>
                    <div class="space-y-2">
                        <button @click="motifSelectionModal.open=true" class="w-full p-4 border-2 border-slate-200 rounded-xl text-sm font-medium text-slate-700 outline-none focus:border-blue-500 bg-white shadow-sm transition-all text-left flex items-center justify-between hover:bg-blue-50 hover:border-blue-400 hover:shadow-md group">
                            <span class="font-semibold">{{ rescheduleModal.motifType ? getMotifLabel(rescheduleModal.motifType) : 'üìã S√©lectionner un motif...' }}</span>
                            <i class="fa-solid fa-chevron-right text-slate-400 group-hover:text-blue-500 transition"></i>
                        </button>
                        <div class="relative">
                            <input v-model="rescheduleModal.motif" :placeholder="rescheduleModal.motifType === 'autre' ? 'Saisissez votre motif personnalis√©...' : 'Le motif sera automatiquement rempli selon votre s√©lection'" :readonly="rescheduleModal.motifType !== 'autre' && rescheduleModal.motifType !== ''" :class="!rescheduleModal.motif ? 'border-red-300 focus:border-red-400' : 'border-slate-200 focus:border-blue-500'" class="w-full p-3.5 border-2 rounded-xl text-sm font-medium text-slate-700 outline-none transition-all bg-white" :style="rescheduleModal.motifType !== 'autre' && rescheduleModal.motifType !== '' ? 'background-color: #f8fafc; cursor: not-allowed;' : ''" required>
                        </div>
                        
                        <!-- Aper√ßu SMS automatique complet (pour demande interne) - D√©roulable -->
                        <div v-if="rescheduleModal.demandePar === 'interne' && rescheduleModal.motifType && rescheduleModal.smsMessage" class="bg-gradient-to-br from-blue-50 to-indigo-50 border-2 border-blue-300 rounded-xl mt-3 shadow-sm overflow-hidden">
                            <button @click="openMotifs['sms_preview_reschedule'] = !openMotifs['sms_preview_reschedule']" class="w-full flex items-center justify-between p-4 hover:bg-blue-100/50 transition">
                                <div class="flex items-center gap-2">
                                    <i class="fa-solid fa-comment-sms text-blue-600 text-lg"></i>
                                    <span class="text-sm font-bold text-blue-700">Aper√ßu du message SMS</span>
                                </div>
                                <i :class="openMotifs['sms_preview_reschedule'] ? 'fa-solid fa-chevron-up' : 'fa-solid fa-chevron-down'" class="text-blue-600 transition-transform"></i>
                            </button>
                            <div v-show="openMotifs['sms_preview_reschedule']" class="px-4 pb-4 border-t border-blue-200 animate-fadeIn">
                                <div class="text-sm text-slate-800 bg-white p-4 rounded-lg border-2 border-blue-200 whitespace-pre-line font-medium leading-relaxed shadow-inner mt-3">{{ rescheduleModal.smsMessage }}</div>
                            </div>
                        </div>
                        <div v-else-if="rescheduleModal.demandePar === 'interne' && rescheduleModal.motifType && !rescheduleModal.smsMessage" class="bg-slate-50 border-2 border-slate-200 rounded-xl p-3 mt-3">
                            <p class="text-xs text-slate-500 italic">Aucun message SMS automatique configur√© pour ce motif.</p>
                        </div>
                        <!-- Aper√ßu d√©roulable pour demande client (motif pour Google Agenda) -->
                        <div v-else-if="rescheduleModal.demandePar === 'client' && rescheduleModal.motifType && rescheduleModal.motif" class="bg-gradient-to-br from-purple-50 to-indigo-50 border-2 border-purple-300 rounded-xl mt-3 shadow-sm overflow-hidden">
                            <button @click="openMotifs['motif_preview_client'] = !openMotifs['motif_preview_client']" class="w-full flex items-center justify-between p-4 hover:bg-purple-100/50 transition">
                                <div class="flex items-center gap-2">
                                    <i class="fa-solid fa-file-lines text-purple-600 text-lg"></i>
                                    <span class="text-sm font-bold text-purple-700">Aper√ßu du motif (Google Agenda)</span>
                                </div>
                                <i :class="openMotifs['motif_preview_client'] ? 'fa-solid fa-chevron-up' : 'fa-solid fa-chevron-down'" class="text-purple-600 transition-transform"></i>
                            </button>
                            <div v-show="openMotifs['motif_preview_client']" class="px-4 pb-4 border-t border-purple-200 animate-fadeIn">
                                <div class="text-sm text-slate-800 bg-white p-4 rounded-lg border-2 border-purple-200 whitespace-pre-line font-medium leading-relaxed shadow-inner mt-3">{{ rescheduleModal.motif }}</div>
                            </div>
                        </div>
                        <div v-else-if="rescheduleModal.demandePar === 'client' && rescheduleModal.motifType && !rescheduleModal.motif" class="bg-slate-50 border-2 border-slate-200 rounded-xl p-3 mt-3">
                            <p class="text-xs text-slate-500 italic">Le motif sera enregistr√© dans Google Agenda et la fiche du rendez-vous. Aucun SMS ne sera envoy√© pour un report √† la demande du client.</p>
                        </div>
                    </div>
                </div>
                
                <div class="flex gap-2 mt-4">
                    <button @click="rescheduleModal.open=false; rescheduleModal.demandePar=''" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-bold hover:bg-gray-300">Annuler</button>
                    <button @click="confirmRescheduleStep1" :disabled="!rescheduleModal.demandePar || ((rescheduleModal.demandePar === 'client' || rescheduleModal.demandePar === 'interne') && (!rescheduleModal.date || !rescheduleModal.heure || (rescheduleModal.date === rescheduleModal.rdv.date && rescheduleModal.heure === rescheduleModal.rdv.heure))) || !rescheduleModal.motif || rescheduleModal.motif.trim() === ''" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold shadow-md flex items-center justify-center gap-2 transition transform active:scale-95 disabled:opacity-50">Confirmer Report <i class="fa-solid fa-arrow-right"></i></button>
                </div>
            </div>
            
            <div v-if="rescheduleModal.step===2" class="p-8 text-center animate-fadeIn flex flex-col items-center justify-center h-full">
                <div class="w-20 h-20 bg-green-100 text-green-500 text-4xl rounded-full flex items-center justify-center mb-6 shadow-lg shadow-green-200/50 animate-bounce">
                    <i class="fa-solid fa-check"></i>
                </div>
                <h4 class="text-2xl font-black text-slate-800 mb-2">Report valid√© !</h4>
                <p class="text-slate-600 font-medium mb-8 max-w-xs mx-auto">Le rendez-vous a bien √©t√© d√©plac√© au <br><strong class="text-blue-600">{{ formatDateLong(rescheduleModal.rdv.date) }} √† {{ rescheduleModal.rdv.heure }}</strong>.</p>
                <div class="bg-slate-50 p-6 rounded-2xl border border-slate-100 w-full">
                    <p class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-4">Voulez-vous pr√©venir le client ?</p>
                    <div class="grid grid-cols-1 gap-3">
                        <button @click="sendRescheduleSMS" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold hover:bg-blue-700 shadow-lg shadow-blue-200 transition transform active:scale-95 flex items-center justify-center gap-3">
                            <i class="fa-solid fa-comment-sms text-xl"></i> OUI, envoyer le SMS
                        </button>
                        <button @click="rescheduleModal.open=false; clientModal.open=false; rescheduleModal.step=1" class="w-full bg-white text-slate-400 border-2 border-slate-100 py-3 rounded-xl font-bold hover:bg-slate-50 hover:text-slate-600 transition">Non, revenir au RDV</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL SELECTION MOTIF MODERNE -->
    <div v-if="motifSelectionModal.open" class="fixed inset-0 bg-slate-900/80 z-[400] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl max-w-lg w-full max-h-[85vh] overflow-hidden flex flex-col">
            <div class="bg-gradient-to-r from-blue-600 to-blue-700 p-5 text-white flex justify-between items-center">
                <h3 class="font-bold text-lg flex items-center gap-2">
                    <i class="fa-solid fa-list-check"></i>
                    S√©lectionner un Motif
                </h3>
                <button @click="motifSelectionModal.open=false" class="w-8 h-8 rounded-full hover:bg-white/20 flex items-center justify-center transition">‚úï</button>
            </div>
            <div class="flex-1 overflow-y-auto p-5 bg-gradient-to-b from-slate-50 to-white">
                <div class="space-y-2">
                    <button v-for="(label, motifType) in (rescheduleModal.demandePar === 'interne' ? rescheduleMotifsListInterne : rescheduleMotifsList)" :key="motifType" @click="selectMotif(motifType)" class="w-full p-4 bg-white border-2 border-slate-200 rounded-xl hover:border-blue-500 hover:bg-blue-50 hover:shadow-md transition-all text-left group">
                        <div class="font-bold text-slate-800 text-sm">{{ label }}</div>
                        <i class="fa-solid fa-chevron-right text-slate-300 group-hover:text-blue-500 float-right mt-[-20px] transition"></i>
                    </button>
                    <button @click="selectMotif('autre')" class="w-full p-4 bg-white border-2 border-slate-200 rounded-xl hover:border-blue-500 hover:bg-blue-50 hover:shadow-md transition-all text-left group">
                        <div class="font-bold text-slate-800 text-sm">‚úèÔ∏è Autre</div>
                        <i class="fa-solid fa-chevron-right text-slate-300 group-hover:text-blue-500 float-right mt-[-20px] transition"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL SELECTION MOTIF MODERNE (SUPPRIM√â - REMPLAC√â PAR VERSION MINIMALISTE) -->
    <div v-if="false && motifSelectionModal.open" class="fixed inset-0 bg-slate-900/80 z-[400] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden flex flex-col">
            <div class="bg-gradient-to-r from-blue-500 to-blue-600 p-5 text-white flex justify-between items-center">
                <h3 class="font-bold text-lg flex items-center gap-2">
                    <i class="fa-solid fa-list-check"></i>
                    S√©lectionner un Motif
                </h3>
                <button @click="motifSelectionModal.open=false" class="w-8 h-8 rounded-full hover:bg-white/20 flex items-center justify-center transition">‚úï</button>
            </div>
            <div class="flex-1 overflow-y-auto p-6">
                <div class="space-y-4">
                    <!-- M√©t√©o -->
                    <div>
                        <h4 class="text-xs font-bold text-slate-500 uppercase mb-3 flex items-center gap-2">
                            <span class="text-lg">üå¶Ô∏è</span> M√©t√©o
                        </h4>
                        <button @click="selectMotif('meteo_route_dangereuse')" class="w-full p-4 bg-white border-2 border-slate-200 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition text-left flex items-center justify-between group">
                            <div>
                                <div class="font-bold text-slate-800">‚ö†Ô∏è Conditions de la route dangereuse</div>
                                <div class="text-xs text-slate-500 mt-1">Neige, verglas ou forte inondations</div>
                            </div>
                            <i class="fa-solid fa-chevron-right text-slate-400 group-hover:text-blue-500"></i>
                        </button>
                    </div>
                    
                    <!-- V√©hicule -->
                    <div>
                        <h4 class="text-xs font-bold text-slate-500 uppercase mb-3 flex items-center gap-2">
                            <span class="text-lg">üöó</span> V√©hicule
                        </h4>
                        <button @click="selectMotif('vehicule_immobilise')" class="w-full p-4 bg-white border-2 border-slate-200 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition text-left flex items-center justify-between group">
                            <div>
                                <div class="font-bold text-slate-800">üîß V√©hicule immobilis√©</div>
                                <div class="text-xs text-slate-500 mt-1">Le v√©hicule ne peut pas bouger</div>
                            </div>
                            <i class="fa-solid fa-chevron-right text-slate-400 group-hover:text-blue-500"></i>
                        </button>
                    </div>
                    
                    <!-- Contrainte professionnelle -->
                    <div>
                        <h4 class="text-xs font-bold text-slate-500 uppercase mb-3 flex items-center gap-2">
                            <span class="text-lg">üíº</span> Contrainte professionnelle
                        </h4>
                        <button @click="selectMotif('contrainte_pro')" class="w-full p-4 bg-white border-2 border-slate-200 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition text-left flex items-center justify-between group">
                            <div>
                                <div class="font-bold text-slate-800">üìû Urgence personnel</div>
                                <div class="text-xs text-slate-500 mt-1">R√©union de derni√®re minute, ne peut pas quitter son poste</div>
                            </div>
                            <i class="fa-solid fa-chevron-right text-slate-400 group-hover:text-blue-500"></i>
                        </button>
                    </div>
                    
                    <!-- Contrainte personnelle -->
                    <div>
                        <h4 class="text-xs font-bold text-slate-500 uppercase mb-3 flex items-center gap-2">
                            <span class="text-lg">üë§</span> Contrainte personnelle
                        </h4>
                        <button @click="selectMotif('contrainte_personnelle')" class="w-full p-4 bg-white border-2 border-slate-200 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition text-left flex items-center justify-between group">
                            <div>
                                <div class="font-bold text-slate-800">üè† Contrainte personnelle</div>
                                <div class="text-xs text-slate-500 mt-1">Ne peut pas se d√©placer pour des raisons personnelles</div>
                            </div>
                            <i class="fa-solid fa-chevron-right text-slate-400 group-hover:text-blue-500"></i>
                        </button>
                    </div>
                    
                    <!-- Probl√®me d'organisation -->
                    <div>
                        <h4 class="text-xs font-bold text-slate-500 uppercase mb-3 flex items-center gap-2">
                            <span class="text-lg">üìÑ</span> Probl√®me d'organisation
                        </h4>
                        <button @click="selectMotif('documents_manquants')" class="w-full p-4 bg-white border-2 border-slate-200 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition text-left flex items-center justify-between group">
                            <div>
                                <div class="font-bold text-slate-800">üìã Oubli des documents</div>
                                <div class="text-xs text-slate-500 mt-1">Le client n'a pas tous les documents</div>
                            </div>
                            <i class="fa-solid fa-chevron-right text-slate-400 group-hover:text-blue-500"></i>
                        </button>
                    </div>
                    
                    <!-- Emp√™chement m√©dical -->
                    <div>
                        <h4 class="text-xs font-bold text-slate-500 uppercase mb-3 flex items-center gap-2">
                            <span class="text-lg">üè•</span> Emp√™chement m√©dical
                        </h4>
                        <button @click="selectMotif('empechement_medical')" class="w-full p-4 bg-white border-2 border-slate-200 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition text-left flex items-center justify-between group">
                            <div>
                                <div class="font-bold text-slate-800">üíä Motif de sant√©</div>
                                <div class="text-xs text-slate-500 mt-1">Incapacit√© de conduire, maladie, blessure</div>
                            </div>
                            <i class="fa-solid fa-chevron-right text-slate-400 group-hover:text-blue-500"></i>
                        </button>
                    </div>
                    
                    <!-- Autre -->
                    <div>
                        <button @click="selectMotif('autre')" class="w-full p-4 bg-white border-2 border-slate-200 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition text-left flex items-center justify-between group">
                            <div>
                                <div class="font-bold text-slate-800">‚úèÔ∏è Autre</div>
                                <div class="text-xs text-slate-500 mt-1">Motif personnalis√©</div>
                            </div>
                            <i class="fa-solid fa-chevron-right text-slate-400 group-hover:text-blue-500"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- BILAN MODALES -->
    <div v-if="bilanEditModal.open" class="fixed inset-0 bg-slate-900/80 z-[350] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg">Modifier RDV</h3>
                <button @click="bilanEditModal.open=false" class="text-slate-400 hover:text-slate-600">√ó</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">Date</label>
                    <input type="date" v-model="bilanEditModal.form.date" class="w-full px-4 py-2 border-2 border-slate-200 rounded-xl">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">Agence</label>
                    <input type="text" v-model="bilanEditModal.form.agence" readonly class="w-full px-4 py-2 border-2 border-slate-200 rounded-xl bg-slate-50">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Commercial</label>
                        <input type="text" v-model="bilanEditModal.form.commercial" class="w-full px-4 py-2 border-2 border-slate-200 rounded-xl">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Tarif</label>
                        <input type="number" v-model.number="bilanEditModal.form.tarif" class="w-full px-4 py-2 border-2 border-slate-200 rounded-xl">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">Nombre RDV</label>
                    <input type="number" v-model.number="bilanEditModal.form.rdv" class="w-full px-4 py-2 border-2 border-slate-200 rounded-xl text-center font-bold text-lg">
                </div>
                <div class="bg-orange-50 p-3 rounded-xl border border-orange-200">
                    <label class="block text-xs font-bold text-orange-700 mb-2">FACTURATION</label>
                    <button type="button" @click="bilanEditModal.form.reporte = !bilanEditModal.form.reporte" :class="bilanEditModal.form.reporte ? 'bg-orange-100 text-orange-700 border-orange-300' : 'bg-slate-100 text-slate-700 border-slate-300'" class="w-full px-4 py-2 rounded-xl font-bold border-2">
                        {{ bilanEditModal.form.reporte ? 'OUI (Report M+1)' : 'NON (Mois en cours)' }}
                    </button>
                </div>
                <button @click="saveBilanEdit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold">Valider</button>
            </div>
        </div>
    </div>

    <div v-if="bilanSettingsModal.open" class="fixed inset-0 bg-slate-900/80 z-[350] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg">R√©glages Bilan & TVA</h3>
                <button @click="bilanSettingsModal.open=false" class="text-slate-400 hover:text-slate-600">√ó</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-2">Logo (Haut PDF)</label>
                    <input type="file" accept="image/*" @change="handleBilanLogo" class="w-full">
                    <img v-if="bilanConfig.logo" :src="bilanConfig.logo" class="mt-2 w-20 h-20 object-contain border border-slate-200 rounded">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-2">Cachet / Signature (Bas PDF)</label>
                    <input type="file" accept="image/*" @change="handleBilanSignature" class="w-full">
                    <img v-if="bilanConfig.signature" :src="bilanConfig.signature" class="mt-2 w-32 h-16 object-contain border border-slate-200 rounded">
                </div>
                <div class="flex items-center gap-3 p-4 border-2 border-slate-200 rounded-xl cursor-pointer" @click="bilanConfig.tvaActive = !bilanConfig.tvaActive">
                    <i :class="bilanConfig.tvaActive ? 'fa-solid fa-check-circle text-green-600' : 'fa-regular fa-circle text-slate-400'" class="text-xl"></i>
                    <div class="flex-1">
                        <div class="font-bold">Assujetti √† la TVA</div>
                        <div class="text-xs text-slate-500">Activer le calcul automatique</div>
                    </div>
                </div>
                <div v-if="bilanConfig.tvaActive" class="space-y-3 bg-slate-50 p-4 rounded-xl">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Taux de TVA (%)</label>
                        <input type="number" v-model.number="bilanConfig.tvaRate" class="w-full px-4 py-2 border-2 border-slate-200 rounded-xl">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">Date d√©but TVA</label>
                        <input type="date" v-model="bilanConfig.tvaStart" class="w-full px-4 py-2 border-2 border-slate-200 rounded-xl">
                        <div class="text-xs text-slate-500 mt-1">(La TVA s'appliquera aux RDV apr√®s cette date)</div>
                    </div>
                </div>
                <button @click="saveBilanSettings" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold">Enregistrer</button>
            </div>
        </div>
    </div>

    <div v-if="bilanModal.open" class="fixed inset-0 bg-slate-900/80 z-[350] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg">Bilans & Objectifs</h3>
                <button @click="bilanModal.open=false" class="text-slate-400 hover:text-slate-600">√ó</button>
            </div>
            <div class="flex gap-3 mb-4">
                <button @click="setBilanPeriod('month')" :class="bilanPeriod==='month' ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-700'" class="flex-1 px-4 py-2 rounded-xl font-bold">Mois</button>
                <button @click="setBilanPeriod('year')" :class="bilanPeriod==='year' ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-700'" class="flex-1 px-4 py-2 rounded-xl font-bold">Ann√©e</button>
            </div>
            <div id="bilanContent" class="space-y-4"></div>
        </div>
    </div>

    <!-- Modal Assigner Commercial Urgent -->
    <div v-if="urgentCommercialModal.open" class="fixed inset-0 bg-slate-900/80 z-[350] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg text-orange-600">Assigner un commercial</h3>
                <button @click="urgentCommercialModal.open=false" class="text-slate-400 hover:text-slate-600">√ó</button>
            </div>
            <div class="space-y-4">
                <div>
                    <p class="text-sm text-slate-600 mb-2"><strong>Agence:</strong> {{ urgentCommercialModal.rdv?.agence }}</p>
                    <p class="text-sm text-slate-600 mb-4"><strong>Date:</strong> {{ formatBilanDate(urgentCommercialModal.rdv?.date) }}</p>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-700 mb-2">Quel commercial a sign√© ?</label>
                    <select v-model="urgentCommercialModal.commercial" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl text-sm font-medium focus:border-blue-500 outline-none">
                        <option value="">-- S√©lectionner --</option>
                        <option v-for="comm in getUrgentCommerciaux()" :key="comm" :value="comm">{{ comm }}</option>
                    </select>
                </div>
                <div class="flex gap-3">
                    <button @click="urgentCommercialModal.open=false" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-700 py-3 rounded-xl font-bold">Annuler</button>
                    <button @click="saveUrgentCommercial" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-bold">Valider</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Objectif -->
    <div v-if="objectifModal.open" class="fixed inset-0 bg-slate-900/80 z-[350] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg text-green-600">D√©finir un objectif</h3>
                <button @click="objectifModal.open=false" class="text-slate-400 hover:text-slate-600">√ó</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-700 mb-2">Agence *</label>
                    <select v-model="objectifModal.agenceId" @change="onObjectifAgenceChange" required class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl text-sm font-medium focus:border-green-500 outline-none">
                        <option value="">-- S√©lectionner une agence --</option>
                        <option v-for="ag in agences" :key="ag.id" :value="ag.id">{{ ag.nom }}</option>
                    </select>
                </div>
                <div v-if="objectifModal.agenceId && hasObjectifCommerciaux()">
                    <label class="block text-xs font-bold text-slate-700 mb-2">Commercial</label>
                    <select v-model="objectifModal.commercial" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl text-sm font-medium focus:border-green-500 outline-none">
                        <option value="">Objectif pour toute l'agence</option>
                        <option v-for="comm in getObjectifCommerciaux()" :key="comm" :value="comm">{{ comm }}</option>
                    </select>
                    <p class="text-xs text-slate-500 mt-1">Laissez vide pour d√©finir un objectif global √† l'agence</p>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-700 mb-2">Objectif (nombre de RDV) *</label>
                    <input type="number" v-model.number="objectifModal.objectif" min="1" required class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl text-sm font-medium focus:border-green-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-700 mb-2">P√©riode</label>
                    <select v-model="objectifModal.periode" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl text-sm font-medium focus:border-green-500 outline-none">
                        <option value="month">Mensuel</option>
                        <option value="year">Annuel</option>
                    </select>
                </div>
                <div class="flex gap-3">
                    <button @click="objectifModal.open=false" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-700 py-3 rounded-xl font-bold">Annuler</button>
                    <button @click="saveObjectif" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-bold">Enregistrer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Tarifs Personnalis√©s -->
    <div v-if="tarifPersonnaliseModal.open" class="fixed inset-0 bg-slate-900/80 z-[350] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg text-purple-600">Tarifs personnalis√©s par agence</h3>
                <button @click="tarifPersonnaliseModal.open=false" class="text-slate-400 hover:text-slate-600">√ó</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-700 mb-2">Agence *</label>
                    <select v-model="tarifPersonnaliseModal.agenceId" required class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl text-sm font-medium focus:border-purple-500 outline-none">
                        <option value="">-- S√©lectionner une agence --</option>
                        <option v-for="ag in agences" :key="ag.id" :value="ag.id">{{ ag.nom }}</option>
                    </select>
                </div>
                <div class="bg-purple-50 p-4 rounded-xl border border-purple-200">
                    <p class="text-sm text-slate-700 mb-4">
                        <i class="fa-solid fa-info-circle text-purple-600 mr-2"></i>
                        D√©finissez des tarifs progressifs. Exemple : 50‚Ç¨ pour les premiers RDV, puis 60‚Ç¨ √† partir du 21e RDV.
                    </p>
                    <div class="space-y-3">
                        <div v-for="(tarif, idx) in tarifPersonnaliseModal.tarifs" :key="idx" class="flex gap-3 items-center bg-white p-3 rounded-xl border border-purple-200">
                            <div class="flex-1">
                                <label class="block text-xs font-bold text-slate-600 mb-1">√Ä partir du RDV n¬∞</label>
                                <input type="number" v-model.number="tarif.rdvMin" min="1" class="w-full px-3 py-2 border-2 border-slate-200 rounded-lg text-sm focus:border-purple-500 outline-none">
                            </div>
                            <div class="flex-1">
                                <label class="block text-xs font-bold text-slate-600 mb-1">Tarif (‚Ç¨)</label>
                                <input type="number" v-model.number="tarif.montant" min="0" step="0.01" class="w-full px-3 py-2 border-2 border-slate-200 rounded-lg text-sm focus:border-purple-500 outline-none">
                            </div>
                            <button @click="removeTarifPersonnalise(idx)" v-if="tarifPersonnaliseModal.tarifs.length > 1" class="text-red-600 hover:text-red-800 font-bold text-xl px-2">√ó</button>
                        </div>
                        <button @click="addTarifPersonnalise" class="w-full bg-purple-100 hover:bg-purple-200 text-purple-700 py-2 rounded-xl font-bold text-sm flex items-center justify-center gap-2">
                            <i class="fa-solid fa-plus"></i> Ajouter un palier
                        </button>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button @click="tarifPersonnaliseModal.open=false" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-700 py-3 rounded-xl font-bold">Annuler</button>
                    <button @click="saveTarifPersonnalise" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-xl font-bold">Enregistrer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- HONOR MODAL Z-INDEX FIX -->
    <div v-if="honorModal.open" class="fixed inset-0 bg-slate-900/80 z-[350] flex items-center justify-center p-4 ">
        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-sm text-center pop-in border border-slate-200 relative overflow-hidden">
            <div class="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-xl animate-pulse">
                <i class="fa-solid fa-file-signature text-3xl"></i>
            </div>
            <h3 class="font-bold text-2xl mb-2 text-slate-800">Rendez-vous honor√© ?</h3>
            <p class="text-slate-500 font-medium mb-4">Le client a-t-il sign√© un Mandat (OK M) ?</p>
            
            <!-- S√©lection du commercial si n√©cessaire -->
            <div v-if="honorModal.needsCommercial" class="mb-6 text-left">
                <label class="block text-xs font-bold text-slate-700 mb-2">Quel commercial a sign√© ? <span class="text-red-600">*</span></label>
                <select v-model="honorModal.commercial" @change="honorModal.error = ''" required :class="honorModal.error ? 'border-red-500' : 'border-slate-200'" class="w-full px-4 py-2 border-2 rounded-xl text-sm font-medium focus:border-blue-500 outline-none">
                    <option value="">-- S√©lectionner --</option>
                    <option value="Je ne sais pas">Je ne sais pas</option>
                    <option v-for="comm in getHonorCommerciaux()" :key="comm" :value="comm">{{ comm }}</option>
                </select>
                <p v-if="honorModal.error" class="text-xs text-red-600 mt-2 font-bold flex items-center gap-1">
                    <i class="fa-solid fa-exclamation-circle"></i>
                    {{ honorModal.error }}
                </p>
                <p v-else-if="user.role === 'admin'" class="text-xs text-orange-600 mt-2 font-medium flex items-center gap-1">
                    <i class="fa-solid fa-exclamation-triangle"></i>
                    Si vous choisissez "Je ne sais pas", le RDV sera dans "√Ä traiter urgent" du Bilan jusqu'√† ce qu'un commercial soit assign√©.
                </p>
                <p v-else class="text-xs text-orange-600 mt-2 font-medium flex items-center gap-1">
                    <i class="fa-solid fa-exclamation-triangle"></i>
                    De temps en temps, v√©rifiez si le commercial a mis son nom et allez dans "√Ä traiter" pour mettre son nom et valider. Sinon, les g√©rants C&N Solutions prendront le relais √† la fin du mois si vous ne l'avez pas fait.
                </p>
            </div>
            
            <div class="space-y-3">
                <button @click="finalizeHonor(true)" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-blue-200 hover:bg-blue-700 transition transform active:scale-95 flex items-center justify-center gap-3">
                    <i class="fa-solid fa-check-double text-xl"></i> ‚úÖ Oui, avec Mandat (OK M)
                </button>
                <button @click="finalizeHonor(false)" class="w-full bg-green-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-green-200 hover:bg-green-700 transition transform active:scale-95 flex items-center justify-center gap-3">
                    <i class="fa-solid fa-check-circle text-xl"></i> Oui, honor√© (sans mandat)
                </button>
                <button @click="honorModal.open=false" class="w-full bg-white text-slate-600 border-2 border-slate-200 py-3 rounded-xl font-bold hover:bg-slate-50 hover:text-slate-800 transition">
                   Annuler
                </button>
            </div>
        </div>
    </div>

    <!-- NOTIFICATION TOAST MODERNE -->
    <transition name="toast">
        <div v-if="notificationToast.open" class="fixed top-4 right-4 z-[400] max-w-md">
            <div class="bg-white rounded-2xl shadow-2xl border-2 overflow-hidden animate-slide-in-right cursor-pointer" 
                 :class="notificationToast.type === 'success' ? 'border-green-300' : notificationToast.type === 'warning' ? 'border-orange-300' : 'border-blue-300'"
                 @click="notificationToast.actionUrl ? (changeView(notificationToast.actionUrl), notificationToast.open = false) : null">
                <div class="flex items-center gap-4 p-4">
                    <div class="flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center text-xl"
                         :class="notificationToast.type === 'success' ? 'bg-green-100 text-green-600' : notificationToast.type === 'warning' ? 'bg-orange-100 text-orange-600' : 'bg-blue-100 text-blue-600'">
                        <i :class="'fa-solid ' + notificationToast.icon"></i>
                    </div>
                    <div class="flex-1">
                        <p class="font-bold text-slate-800 text-sm leading-tight">{{ notificationToast.message }}</p>
                        <button v-if="notificationToast.actionUrl" @click.stop="changeView(notificationToast.actionUrl); notificationToast.open = false" class="mt-2 bg-blue-600 hover:bg-blue-700 text-white text-xs px-3 py-1.5 rounded-lg font-bold transition">
                            <i class="fa-solid fa-eye mr-1"></i> Voir
                        </button>
                    </div>
                    <button @click.stop="notificationToast.open = false" class="flex-shrink-0 text-slate-400 hover:text-slate-600 transition">
                        <i class="fa-solid fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
    </transition>

    <!-- MODALE √âDITION CLIENT - VERSION OPTIMIS√âE ORDINATEUR -->
    <div v-if="editModal.open" class="fixed inset-0 bg-slate-900/80 z-[350] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-3xl rounded-2xl shadow-2xl overflow-hidden flex flex-col pop-in max-h-[90vh]">
            <div class="bg-gradient-to-r from-slate-800 to-slate-700 p-4 md:p-5 text-white flex justify-between items-center flex-shrink-0">
                <h3 class="font-bold text-lg md:text-xl flex items-center gap-2">
                    <i class="fa-solid fa-pencil"></i>
                    Modifier les informations du client
                </h3>
                <button @click="editModal.open=false" class="w-8 h-8 rounded-full hover:bg-white/20 flex items-center justify-center transition text-lg">‚úï</button>
            </div>
            <div class="flex-1 overflow-y-auto p-5 md:p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                    <!-- Colonne gauche -->
                    <div class="space-y-4">
                <div>
                            <label class="text-xs font-bold text-gray-600 uppercase mb-2 block">Civilit√©</label>
                    <div class="flex gap-3">
                                <button @click="editModal.form.civilite='M.'" :class="editModal.form.civilite==='M.'?'bg-blue-600 text-white shadow-lg':'bg-slate-100 text-slate-600 hover:bg-slate-200'" class="flex-1 py-3 rounded-xl font-bold transition">Monsieur</button>
                                <button @click="editModal.form.civilite='Mme'" :class="editModal.form.civilite==='Mme'?'bg-pink-500 text-white shadow-lg':'bg-slate-100 text-slate-600 hover:bg-slate-200'" class="flex-1 py-3 rounded-xl font-bold transition">Madame</button>
                    </div>
                </div>
                <div>
                            <label class="text-xs font-bold text-gray-600 uppercase mb-2 block">Nom complet</label>
                    <input v-model="editModal.form.nom" @input="formatNameRealTimeEdit" @blur="onEditModalNameBlur" @paste="onEditModalNamePaste" class="w-full p-3 border-2 border-slate-200 rounded-xl font-bold text-slate-800 outline-none focus:border-blue-500">
                </div>
                <div>
                            <label class="text-xs font-bold text-gray-600 uppercase mb-2 block">T√©l√©phone</label>
                            <input v-model="editModal.form.telephone" type="tel" class="w-full p-3 border-2 border-slate-200 rounded-xl font-bold text-slate-800 outline-none focus:border-blue-500">
                </div>
                <div>
                            <label class="text-xs font-bold text-gray-600 uppercase mb-2 block">Agence</label>
                    <select v-model="editModal.form.agenceId" class="w-full p-3 border-2 border-slate-200 rounded-xl font-bold text-slate-800 outline-none focus:border-blue-500 bg-white">
                        <option v-for="ag in visibleAgencies" :key="ag.id" :value="ag.id">{{ ag.nom }}</option>
                    </select>
                </div>
                <div>
                            <label class="text-xs font-bold text-gray-600 uppercase mb-2 block">Source</label>
                    <div class="flex flex-wrap gap-2">
                                <button v-for="src in sourcesList" :key="src" @click="editModal.form.source=src" :class="editModal.form.source===src ? 'bg-blue-600 text-white shadow-md' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'" class="px-4 py-2 rounded-lg text-xs font-bold transition">
                            {{ src }}
                        </button>
                    </div>
                </div>
            </div>
                    
                    <!-- Colonne droite -->
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs font-bold text-gray-600 uppercase mb-2 block">Mod√®le du v√©hicule</label>
                            <input v-model="editModal.form.baseModele" @input="updateEditModalModele" placeholder="Marque, Mod√®le, Finition..." class="w-full p-3 border-2 border-slate-200 rounded-xl font-bold text-slate-800 outline-none focus:border-blue-500">
                        </div>
                        <div class="bg-slate-50 p-3 rounded-xl border-2 border-slate-200">
                            <div class="flex items-center justify-between mb-2.5">
                                <label class="text-xs font-bold text-gray-600 uppercase">Caract√©ristiques</label>
                                <button @click="addNewCaracteristique" class="px-2.5 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-[10px] font-bold transition flex items-center gap-1">
                                    <i class="fa-solid fa-plus text-[9px]"></i>
                                    Ajouter
                                </button>
                            </div>
                            <div v-if="editModal.form.caracteristiques && editModal.form.caracteristiques.length > 0" class="space-y-2">
                                <div v-for="(carac, idx) in editModal.form.caracteristiques" :key="idx" class="flex items-center gap-1.5">
                                    <input v-model="carac.label" @input="updateEditModalModele" placeholder="Label" maxlength="20" class="w-28 flex-shrink-0 p-1.5 border-2 border-slate-200 rounded-lg text-xs font-bold text-slate-800 outline-none focus:border-blue-500">
                                    <span class="text-slate-600 flex-shrink-0 text-xs">:</span>
                                    <input v-model="carac.value" @input="updateEditModalModele" placeholder="Valeur" class="flex-1 min-w-0 p-1.5 border-2 border-slate-200 rounded-lg text-xs text-slate-800 outline-none focus:border-blue-500">
                                    <button @click="removeCaracteristique(idx)" class="w-6 h-6 flex-shrink-0 bg-red-100 hover:bg-red-200 text-red-600 rounded flex items-center justify-center transition">
                                        <i class="fa-solid fa-times text-[9px]"></i>
                                    </button>
                                </div>
                            </div>
                            <div v-else class="text-[10px] text-slate-500 italic text-center py-1.5">Aucune caract√©ristique</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-5 md:p-6 border-t border-slate-200 flex-shrink-0 bg-slate-50 flex gap-3">
                <button @click="editModal.open=false" class="px-6 py-3 bg-white border-2 border-slate-300 text-slate-700 rounded-xl font-bold hover:bg-slate-50 transition">Annuler</button>
                <button @click="saveEdit" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 shadow-lg transform active:scale-95 transition">Sauvegarder les modifications</button>
            </div>
        </div>
    </div>
<div v-if="billingSummaryModal.open" class="fixed inset-0 bg-slate-900/80 z-[400] flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col pop-in">
        <div class="bg-slate-100 p-6 flex justify-between items-center border-b">
            <div class="flex-1">
                <h3 class="font-bold text-xl text-slate-800 mb-2">
                    <i class="fa-solid fa-file-invoice-dollar text-indigo-600 mr-2"></i>Synth√®se Facturation
                </h3>
                
                <div class="flex items-center gap-2 flex-wrap">
                    <input type="text" v-model="billingSummarySearch" placeholder="üîç Rechercher par agence..." class="bg-white border-2 border-indigo-100 text-indigo-900 text-sm font-bold rounded-xl px-4 py-2 outline-none focus:border-indigo-500 shadow-sm transition hover:border-indigo-300 flex-1 min-w-[200px]">
                    <select v-model="bilanFilters.mois" class="bg-white border-2 border-indigo-100 text-indigo-900 text-sm font-bold rounded-xl px-4 py-2 outline-none focus:border-indigo-500 shadow-sm cursor-pointer transition hover:border-indigo-300">
                        <option value="">Mois</option>
                        <option value="01">Janvier</option>
                        <option value="02">F√©vrier</option>
                        <option value="03">Mars</option>
                        <option value="04">Avril</option>
                        <option value="05">Mai</option>
                        <option value="06">Juin</option>
                        <option value="07">Juillet</option>
                        <option value="08">Ao√ªt</option>
                        <option value="09">Septembre</option>
                        <option value="10">Octobre</option>
                        <option value="11">Novembre</option>
                        <option value="12">D√©cembre</option>
                    </select>
                    <select v-model="bilanFilters.annee" class="bg-white border-2 border-indigo-100 text-indigo-900 text-sm font-bold rounded-xl px-4 py-2 outline-none focus:border-indigo-500 shadow-sm cursor-pointer transition hover:border-indigo-300">
                        <option value="">Ann√©e</option>
                        <option v-for="y in bilanYearOptions" :key="y" :value="y">{{ y }}</option>
                    </select>
                </div>
            </div>
            <button @click="billingSummaryModal.open=false" class="w-8 h-8 rounded-full bg-white hover:bg-red-50 hover:text-red-500 flex items-center justify-center transition shadow-sm ml-4">‚úï</button>
        </div>
        
        <div class="flex-1 overflow-y-auto p-6 bg-slate-50">
            <div class="space-y-4">
                <div v-for="(agData, agName) in filteredBillingStatsGrouped" :key="agName" class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-4 bg-gradient-to-r from-indigo-50 to-blue-50 border-b border-slate-200 flex justify-between items-center">
                        <div class="flex-1">
                            <div class="font-black text-lg text-slate-800 mb-1">{{ agName }}</div>
                            <div class="flex items-center gap-4 text-sm">
                                <div class="text-indigo-600 font-black text-xl">{{ formatBilanPrice(agData.totalTTC) }} ‚Ç¨ <span class="text-xs text-slate-400 font-normal">TTC</span></div>
                                <div v-if="bilanConfig.tvaActive" class="text-slate-600">
                                    <span class="text-xs">HT:</span> <span class="font-bold">{{ formatBilanPrice(agData.totalHT) }} ‚Ç¨</span>
                                </div>
                            </div>
                        </div>
                        <button @click="exportBilanAgencePDF(agName, agData)" class="bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white px-4 py-2 rounded-xl font-bold text-sm flex items-center gap-2 shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
                            <i class="fa-solid fa-file-pdf"></i> <span class="hidden sm:inline">T√©l√©charger Bilan</span>
                        </button>
                    </div>
                    <div class="p-4">
                        <table class="w-full text-sm table-fixed">
                            <thead class="bg-gradient-to-r from-indigo-50 to-blue-50 border-b-2 border-indigo-200">
                                <tr>
                                    <th class="px-3 py-3 text-left text-xs text-indigo-700 uppercase font-bold w-2/5">Commercial / D√©tail</th>
                                    <th class="px-3 py-3 text-center text-xs text-indigo-700 uppercase font-bold w-16">Nb RDV</th>
                                    <th class="px-3 py-3 text-right text-xs text-indigo-700 uppercase font-bold w-24">Total HT</th>
                                    <th v-if="bilanConfig.tvaActive" class="px-3 py-3 text-right text-xs text-indigo-700 uppercase font-bold w-24">TVA</th>
                                    <th class="px-3 py-3 text-right text-xs text-indigo-700 uppercase font-bold w-28">Total TTC</th>
                                    <th class="px-3 py-3 text-center text-xs text-indigo-700 uppercase font-bold w-20">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-200">
                                <tr v-for="comm in agData.commerciaux" :key="comm.nom" class="hover:bg-indigo-50/50 transition-colors">
                                    <td class="px-3 py-3 font-medium text-slate-800 truncate">{{ comm.nom || 'Agence (Direct)' }}</td>
                                    <td class="px-3 py-3 text-center font-bold text-slate-700">{{ comm.rdv }}</td>
                                    <td class="px-3 py-3 text-right font-bold text-slate-800 whitespace-nowrap">{{ formatBilanPrice(comm.ht) }} ‚Ç¨</td>
                                    <td v-if="bilanConfig.tvaActive" class="px-3 py-3 text-right text-slate-600 whitespace-nowrap">{{ formatBilanPrice(comm.tva || 0) }} ‚Ç¨</td>
                                    <td class="px-3 py-3 text-right font-bold text-indigo-600 whitespace-nowrap">{{ formatBilanPrice(comm.ttc || comm.ht) }} ‚Ç¨</td>
                                    <td class="px-3 py-3 text-center">
                                        <button @click="exportBilanCommercialPDF(agName, comm.nom || 'Agence (Direct)', comm)" class="bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white px-3 py-1.5 rounded-lg font-bold text-xs flex items-center justify-center gap-1.5 shadow-md hover:shadow-lg transition-all transform hover:scale-105">
                                            <i class="fa-solid fa-file-pdf"></i> PDF
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                 <div v-if="Object.keys(filteredBillingStatsGrouped).length === 0" class="text-center py-10 text-slate-400">
                    <i class="fa-solid fa-inbox text-4xl mb-2"></i>
                    <p v-if="billingSummarySearch">Aucune agence ne correspond √† votre recherche.</p>
                    <p v-else>Aucune donn√©e de facturation pour cette s√©lection.</p>
                </div>
            </div>
        </div>

        <div class="p-4 bg-white border-t border-slate-200 flex justify-end">
            <button @click="billingSummaryModal.open=false" class="bg-slate-800 text-white px-6 py-3 rounded-xl font-bold hover:bg-slate-900 transition">Fermer</button>
        </div>
    </div>
</div>
  
<script>
    // Masquer la barre d'adresse du navigateur sur mobile (iPhone)
    (function() {
        // Fonction pour masquer la barre d'adresse
        function hideAddressBar() {
            if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
                // Forcer le redimensionnement pour masquer la barre
                window.scrollTo(0, 1);
                setTimeout(function() {
                    window.scrollTo(0, 0);
                }, 0);
                
                // Masquer la barre apr√®s le chargement
                setTimeout(function() {
                    window.scrollTo(0, 1);
                }, 100);
            }
        }
        
        // Masquer au chargement
        if (document.readyState === 'complete') {
            hideAddressBar();
        } else {
            window.addEventListener('load', hideAddressBar);
            window.addEventListener('orientationchange', function() {
                setTimeout(hideAddressBar, 500);
            });
        }
        
        // Masquer lors du scroll
        let lastScrollTop = 0;
        window.addEventListener('scroll', function() {
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            if (scrollTop > lastScrollTop && scrollTop > 10) {
                // Scroll vers le bas - masquer la barre
                setTimeout(hideAddressBar, 100);
            }
            lastScrollTop = scrollTop;
        }, false);
        
        // Pr√©venir le zoom sur double-tap
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    })();
    
    const firebaseConfig = {
        apiKey: "AIzaSyDi3NFvmg_acIxicfShqhEd4uQEDMDcizM",
        authDomain: "bon-de-commande-b05f6.firebaseapp.com",
        projectId: "bon-de-commande-b05f6",
        storageBucket: "bon-de-commande-b05f6.firebasestorage.app",
        messagingSenderId: "884603881750",
        appId: "1:884603881750:web:816da99e2502225779a837"
    };
    firebase.initializeApp(firebaseConfig);
    // --- PERSISTANCE INSTANTAN√âE ---
    firebase.firestore().enablePersistence()
        .catch((err) => {
            if (err.code == 'failed-precondition') {
                console.warn("Persistance non active (onglet multiple).");
            } else if (err.code == 'unimplemented') {
                console.warn("Persistance non support√©e par le navigateur.");
            }
        });
    const db = firebase.firestore();

    const { createApp, ref, reactive, computed, onMounted, watch } = Vue;

    createApp({
        setup() {
            
            const user = reactive({ logged:false, role:'', name:'', email:'', id:'' });
            const forcedLogoutModal = reactive({ open: false, type: '' }); // 'deleted' ou 'blocked'
            const blockedLoginMessage = reactive({ show: false });
            const loginErrorModal = reactive({ show: false, message: '' });
            let userStatusListener = null;
            // --- MODE CLIENT (DOCTOLIB) ---
const isClientMode = ref(false); // Est-ce qu'on est en vue client ?
const clientRdv = ref(null); // Le RDV charg√© pour le client
const clientRequest = reactive({ type: '', motif: '', showModal: false }); // Pour g√©rer la demande
const appUrl = window.location.origin + window.location.pathname; // L'URL de base de ton site
            const loginEmail = ref('');
            const loginPass = ref('');
            const loginAdminSelection = ref(false); 
            
            const view = ref('dashboard');
            const currentFilter = ref('all'); 
            const listFilters = reactive({ agenceId: '', date: '', prospecteur: '' }); 
            const fromDashboard = ref(false);
            const rdvMenuOpen = ref(null);

            // Initialiser avec le mois et l'ann√©e actuels
            const currentDate = new Date();
            const currentMonth = String(currentDate.getMonth() + 1).padStart(2, '0');
            const currentYear = String(currentDate.getFullYear());
            const dashboardFilters = reactive({ agencyId: '', userId: '', commercialId: '', onlyLive: false, mois: currentMonth, annee: currentYear });
            const dashboardLimit = ref(15);
            const displayLimit = ref(20); 

            const now = ref(new Date()); 
            const rdvList = ref([]);
            let rdvListener = null;
            
            // Google Calendar API
            const googleCalendarConnected = ref(false);
            const googleCalendarUserEmail = ref('');
            const googleAccessToken = ref('');
            let googleTokenClient = null;
            
            // Google Calendar API pour les prospecteurs (M√äME STRUCTURE QUE ADMIN)
            const prospecteurGoogleCalendarConnected = ref(false);
            const prospecteurGoogleCalendarUserEmail = ref('');
            const prospecteurGoogleCalendarToken = ref('');
            const prospecteurGoogleCalendarTokenExpired = ref(false);
            const prospecteurTokenExpirationTime = ref(null); // Timestamp d'expiration du token prospecteur
            const prospecteurTokenTimerTick = ref(Date.now()); // Pour le compteur en temps r√©el
            let prospecteurGoogleTokenClient = null;
            let prospecteurTokenRefreshInterval = null;
            
            // Mettre √† jour le temps toutes les secondes pour les prospecteurs
            setInterval(() => {
                if (prospecteurTokenExpirationTime.value && prospecteurGoogleCalendarConnected.value && !prospecteurGoogleCalendarTokenExpired.value) {
                    prospecteurTokenTimerTick.value = Date.now();
                }
            }, 1000);
            
            // Calcul du temps restant avant expiration pour les prospecteurs
            const prospecteurTokenTimeRemaining = computed(() => {
                if (!prospecteurTokenExpirationTime.value || !prospecteurGoogleCalendarConnected.value || prospecteurGoogleCalendarTokenExpired.value) {
                    return null;
                }
                const remaining = prospecteurTokenExpirationTime.value - prospecteurTokenTimerTick.value;
                if (remaining <= 0) return null;
                
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);
                return { minutes, seconds };
            });
            
            // Computed pour le d√©compte des prospecteurs (token propre OU token admin)
            const prospecteurDisplayTimeRemaining = computed(() => {
                // Si le prospecteur a son propre token valide, utiliser celui-ci
                if (prospecteurTokenTimeRemaining.value) {
                    return prospecteurTokenTimeRemaining.value;
                }
                // Sinon, si connect√© via admin, utiliser le token admin
                if (tokenTimeRemaining.value && googleCalendarConnected.value && googleAccessToken.value) {
                    return tokenTimeRemaining.value;
                }
                return null;
            });

            const agences = ref([]);
            const sourcesList = ref(['Leboncoin', 'La Centrale', 'Facebook', 'Google', 'Instagram']);
            const sourceLogos = ref({}); 
            const adminNamesList = ref(['Nathana√´l', 'Charl√®ne', 'Admin']);
            const motifsList = ref(['Essai', 'Achat', 'R√©vision', 'R√©paration', 'Vente']);
            // Cherchez cette ligne et remplacez-la par :
            const globalSettings = ref({ reminderStartTime: '08:00', reminderEveTime: '16:00', appLogoUrl: '', rdvLinkBaseUrl: '', tutorialVideoUrl: '' });
            
            // GLOBAL COMMISSION SETTINGS
            const globalCommission = reactive({ base: 10, threshold: 21, step: 10, amount: 100 });
            const tips = reactive({}); // { memberId: currentMonthTipAmount }
            
            // R√©glages de synchronisation
            const syncSettings = reactive({
                syncAfterRdvTime: false, // Synchroniser seulement apr√®s l'heure du rendez-vous
                syncInterval: 30 // Intervalle de synchronisation en secondes
            });

            const selectedIds = ref([]);
            const bulkModal = reactive({ open: false, action: '', label: '' });
            const agencySearch = ref('');

            const wizard = reactive({ open:false, step:1, loading:false });
            const form = reactive({});
            const clientModal = reactive({ open:false, rdv:null, removingFromAgenda: false });
            const historyModal = reactive({ open:false, rdv:null });
            const settingsModal = reactive({ open:false, tab:'Agences', view:'menu' });
            const rappelConfirmModal = reactive({ open:false, rdv:null, smsLink:'' });
            const quickRdvModal = reactive({ open:false, nom:'', modele:'', note:'', agenceId:'', commercialId:'', date:'', heure:'', source:'', honore:false });
            const formatageSettings = reactive({ 
                autoTranslate: true, 
                boldLabels: true, 
                alignValues: true, 
                spaceBetween: true 
            });
            const cancelModal = reactive({ open:false, rdv:null, motif:'', motifCustom:'', selectedMotif:'', sendSMS:false, who:'' });
            const rescheduleModal = reactive({ open:false, step:1, date:'', heure:'', rdv:null, oldDate:null, oldHeure:null, motif:'', motifType:'', demandePar:'', autoSMS:false, smsMessage:'' });
            const motifSelectionModal = reactive({ open: false });
            const messagePreviewModal = reactive({ open: false, message: '', title: 'Aper√ßu du message' });
            const rescheduleSMSMessages = reactive({ meteo_route_dangereuse: '', vehicule_immobilise: '', contrainte_pro: '', contrainte_personnelle: '', documents_manquants: '', empechement_medical: '', agence_fermee: '', commercial_retard: '', agence_retard: '', intemperie: '', absence_imprevue: '' });
            const rescheduleSMSMessagesClient = reactive({ meteo_route_dangereuse: '', vehicule_immobilise: '', contrainte_pro: '', contrainte_personnelle: '', documents_manquants: '', empechement_medical: '' });
            const editingRescheduleType = ref('interne'); // 'interne' ou 'client'
            const openMotifs = reactive({}); // Pour suivre quels motifs sont ouverts
            const rescheduleMotifsList = reactive({ meteo_route_dangereuse: '‚ö†Ô∏è Conditions de la route dangereuse', vehicule_immobilise: 'üîß V√©hicule immobilis√©', contrainte_pro: 'üíº R√©union de derni√®re minute', contrainte_personnelle: 'üè† Contrainte personnelle', documents_manquants: 'üìã Oubli des documents', empechement_medical: 'üíä Motif de sant√©' });
            // Motifs sp√©cifiques pour demande interne
            const rescheduleMotifsListInterne = reactive({ 
                agence_fermee: 'üè¢ L\'agence sera ferm√©e', 
                commercial_retard: '‚è∞ Le commercial aura un peu de retard', 
                agence_retard: '‚è∞ L\'agence aura un peu de retard', 
                intemperie: 'üåßÔ∏è Intemp√©rie', 
                absence_imprevue: 'üö´ Absence impr√©vue'
            });
            const newRescheduleMotif = reactive({ label: '', key: '', message: '' });
            const newRescheduleMotifInterne = reactive({ label: '', key: '', message: '' });
            const fermetureModal = reactive({ open:false, dateDebut:'', dateFin:'', motif:'', professionnels:[], tousProfessionnels:false, editingId:null });
            const fermetureDeleteConfirmModal = reactive({ open:false, fermetureId:null });
            const fermeturesList = ref([]);
            const heureFermetureConfirmModal = reactive({ open:false, heure:'', heureFermeture:'', onConfirm:null });
            const heureLimiteExceptionnelleModal = reactive({ open:false, heure:'', heureLimite:'', motif:'' });
            const heureApresFermetureModal = reactive({ open:false, heure:'', heureFermeture:'', onConfirm:null });
            const removeAgendaConfirmModal = reactive({ open:false, rdv:null });
            const pausedAgencyModal = reactive({ open:false, agency:null });
            
            const honorModal = reactive({ open: false, rdv: null, commercial: '', needsCommercial: false, error: '' });
            const editModal = reactive({ open: false, rdv: null, form: {} });
            const discountModal = reactive({ open: false, amount: null, reason: '', customReason: '', error: '' });
            const reminderAlertModal = reactive({ open: false });
            const pendingStatusModal = reactive({ open: false });
            const teamEditModal = reactive({ open: false, member: null, name: '', email: '', password: '', assignedAgencies: [] });
            const passwordEditModal = reactive({ open: false, member: null, password: '' });
            const globalSearchModal = reactive({ open: false, query: '', results: [] });
            const actionHistory = ref([]); // Historique des actions
            const detailedLogs = ref([]); // Logs d√©taill√©s depuis Firestore
            const performanceStats = reactive({
                tauxConfirmation: 0,
                tauxAnnulation: 0,
                tauxHonorisation: 0,
                tauxPresence: 0,
                totalRdvs: 0,
                totalConfirmes: 0,
                totalAnnules: 0,
                totalHonores: 0,
                totalPresents: 0,
                totalEnAttente: 0,
                totalPasVenus: 0,
                rdvAujourdhui: 0,
                rdvCetteSemaine: 0,
                rdvCeMois: 0
            });
            const workloadPrediction = ref([]); // Pr√©diction de charge
            const connectedUsers = ref([]); // Utilisateurs actuellement connect√©s
            const connexionsHistory = ref([]); // Historique des connexions/d√©connexions
            const connectedUsersCount = computed(() => connectedUsers.value.length);
            const loadingConnexions = ref(false); // √âtat de chargement
            const selectedConnexionLogs = ref([]); // Logs s√©lectionn√©s pour suppression
            const connexionDeleteModal = ref({ open: false, mode: 'selected' }); // Modal de confirmation suppression
            const isDeletingLogs = ref(false); // Flag pour emp√™cher le rechargement automatique pendant la suppression
            const userHistoryModal = ref({ open: false, user: null, history: [], loading: false }); // Modal historique utilisateur
            const monthlySummaries = ref({}); // R√©sum√©s mensuels par utilisateur
            const dashboardModal = reactive({ open: false, widgets: [] });
            const reportSettings = reactive({ 
                open: false, 
                weekly: false, 
                monthly: false, 
                email: '',
                dayOfWeek: 1, // Lundi par d√©faut
                dayOfMonth: 1 // 1er du mois par d√©faut
            });
            const customConfirmModal = reactive({ open: false, title: '', message: '', onConfirm: null });
            const editNoteModal = reactive({ open: false, rdv: null, note: '' });
            const statsModal = reactive({ open: false, activeTab: 'overview', selectedMonth: 'current' });
            const tipModal = reactive({ open: false, operation: 'add', amount: null, reason: '', customReason: '', note: '', error: '' });
            const googleCalendarDisconnectedModal = reactive({ open: false, fromWizard: false });
            const googleCalendarRequired = ref(false); // Param√®tre pour rendre la connexion obligatoire
            const connectingFromSelectSource = ref(false); // Flag pour savoir si la connexion vient de la s√©lection de Google comme source
            const googleCalendarInfoModal = reactive({ open: false });
            const confirmAgendaModal = reactive({ open: false, rdv: null, onConfirm: null });
            const reconnectAgendaModal = reactive({ open: false, rdv: null });
            const notificationToast = reactive({ open: false, message: '', type: 'success', icon: '', persistent: false, actionUrl: null });
            const showIntelligentModeHelp = ref(false); // Modal d'aide pour le mode intelligent

            // Fonction pour afficher une notification moderne
            const showNotification = (message, type = 'success', icon = '', persistent = false, actionUrl = null, duration = null) => {
                notificationToast.message = message;
                notificationToast.type = type;
                notificationToast.icon = icon || (type === 'success' ? 'fa-check-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle');
                notificationToast.persistent = persistent;
                notificationToast.actionUrl = actionUrl;
                notificationToast.open = true;
                if (!persistent) {
                    const timeoutDuration = duration !== null ? duration : 4000;
                    setTimeout(() => {
                        notificationToast.open = false;
                    }, timeoutDuration);
                }
            };

            // PORTAFEUILLE
            const portefeuilleSearch = ref('');
            const selectedProspecteur = ref(null);
            const filteredProspectors = ref([]);
            const transactions = ref([]);
            const prospecteurEdit = reactive({ tips: 0 });
            let transactionListener = null;
            let adminTransactionListener = null;

            // BILAN & FACTURATION
            const bilanRows = ref([]);
            const bilanConfig = reactive({ tvaActive: false, tvaRate: 20, logo: "", signature: "", tvaStart: "" });
            const bilanForm = reactive({ date: new Date().toISOString().split('T')[0], reporte: false, blocks: [{ agenceId: '', commercial: '', rdv: 1, tarif: 0 }] });
            // Initialiser avec le mois et l'ann√©e actuels
            const bilanFilters = reactive({ jour: '', mois: currentMonth, annee: currentYear, agence: '', commercial: '', search: '' });
            const selectedBilanIds = ref([]);
            const bilanCurrentPage = ref(1);
            const bilanPeriod = ref('month');
            const bilanTab = ref('main');
            const bilanModal = reactive({ open: false });
            const bilanEditModal = reactive({ open: false, rdv: null, form: {} });
            const bilanSettingsModal = reactive({ open: false });
            const urgentCommercialModal = reactive({ open: false, rdv: null, commercial: '' });
            const bilanMonthOptions = ref([]);
            const bilanYearOptions = ref([]);
            const dashboardYearOptions = ref([]);
            const ITEMS_PER_PAGE_BILAN = 15;

            // OBJECTIFS
            const objectifsFilters = reactive({ mois: '', agence: '' });
            const objectifsStats = ref([]);
            const objectifsData = ref([]);
            const objectifModal = reactive({ open: false, agenceId: '', commercial: '', objectif: 0, periode: 'month' });
            const tarifPersonnaliseModal = reactive({ open: false, agenceId: '', tarifs: [{ rdvMin: 1, montant: 0 }] });
            const tarifsPersonnalises = ref({});

            // Flag de session pour les v√©rifications au d√©marrage
            const checksDone = ref(false);
            const startupTimer = ref(null);

            const statsFilterAgency = ref('');
            const statsFilterUser = ref('');
            const statsFilterMonth = ref('');
            const statsFilterYear = ref('');

            const newSource = ref('');
            const newMotif = ref('');
            const cancelMotifsList = ref(['Client indisponible', 'V√©hicule en r√©paration', 'Client a annul√©', 'Agence indisponible']);
            const newCancelMotif = ref('');
            const newAdminName = ref('');
            const showDiscountInput = ref(false);
            const newNoteText = ref('');

            const editingAgency = ref(null);
            const editingAgencyCommerciaux = ref([]);
            const editingAgencyFermetures = ref([]);
            const editingMsgAgence = ref(null);
            const editingMsgType = ref('confirm');
            const clientExists = ref(false);
            const pauseReasonSelect = ref('Vacances');
            const showCustomTime = ref(false);
            const mobileMenuOpen = ref(false);
            
            // Variable pour suivre si l'admin a un token actif (partag√© avec tous les prospecteurs)
            const currentTheme = computed(() => {
                // Th√®me moderne chic toujours actif
                return { name: 'modern', label: 'Mode Premium', icon: '‚ú®', classes: 'theme-modern' };
                
                // Th√®mes saisonniers d√©sactiv√©s - d√©commenter pour les r√©activer
                // const d = new Date();
                // const month = d.getMonth() + 1; 
                // const day = d.getDate();
                // if (month === 12) return { name: 'christmas', label: 'Joyeuses F√™tes', icon: 'üéÖ', classes: 'theme-christmas' };
                // if (month === 1 && day <= 15) return { name: 'newyear', label: 'Bonne Ann√©e', icon: 'ü•Ç', classes: 'theme-newyear' };
                // if (month === 2 && day >= 10 && day <= 15) return { name: 'love', label: 'Love is in the air', icon: '‚ù§Ô∏è', classes: 'theme-love' };
                // if (month === 10 && day >= 15) return { name: 'halloween', label: 'Bouuh !', icon: 'üéÉ', classes: 'theme-halloween' };
                // if (month >= 6 && month <= 8) return { name: 'summer', label: 'Mode √ât√©', icon: 'üòé', classes: 'theme-summer' };
                // if (month === 7 && day >= 13 && day <= 15) return { name: 'bastille', label: 'F√™te Nationale', icon: 'üéÜ', classes: 'theme-bastille' };
                // return { name: 'default', label: '', icon: '', classes: '' };
            });

            const welcomeModal = reactive({ open: false, title: '', message: '', icon: '' });
            const tutorialModal = reactive({ open: false, step: 1, userName: '' });
            const tutorialVideoModal = reactive({ open: false });
            const teamList = ref([]);
            const newMember = reactive({ name:'', email:'', password:'', assignedAgencies: [] });

            const msgLabels = { 'confirm': 'Confirmation', 'rappel': 'Rappel Veille', 'rappel_today': 'Rappel Jour J', 'reschedule': 'Report', 'cancel_ag': 'Annulation Agence', 'cancel_clt': 'Annulation Client', 'noshow': 'Lapin', 'noshow_today': 'Lapin (Jour J)' };
            const filters = reactive({ date: new Date().toISOString().split('T')[0] });
            const timelineShowTomorrow = ref(false); // √âtat pour savoir si on affiche "demain" ou "aujourd'hui"
            const search = ref('');
            const normalizePhone = (value) => (value || '').replace(/\D/g, '');
            const formatPhone = (digits) => digits.replace(/(\d{2})(?=\d)/g, '$1 ').trim();

onMounted(async () => { // Note le 'async' ajout√© ici
    
    // --- D√âTECTION MODE CLIENT ---
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');

    if (token) {
        isClientMode.value = true;
        try {
            // On charge le RDV sp√©cifique
            const doc = await db.collection('rendezvous').doc(token).get();
            if (doc.exists) {
                clientRdv.value = { id: doc.id, ...doc.data() };
            } else {
                alert("Ce rendez-vous n'existe plus ou le lien est expir√©.");
                isClientMode.value = false;
            }
        } catch (e) {
            console.error("Erreur chargement client", e);
        }
    }
    // -----------------------------

    // 1. Initialisation de l'outil Google (reste de ton code...)

                // 2. Initialiser les options d'ann√©e pour le dashboard
                initDashboardYearOptions();
                
                // 2.5. D√©marrer la v√©rification p√©riodique des SMS programm√©s
                startScheduledSMSChecker();
                
                // 3. Restauration de la session utilisateur
                const savedUser = localStorage.getItem('crm_user');

                if (savedUser) {
                    const parsed = JSON.parse(savedUser);
                    user.logged = true;
                    user.role = parsed.role;
                    user.name = parsed.name;
                    user.email = parsed.email || '';
                    user.id = parsed.id || '';
                    loadRdvData();
                    
                    // Charger les fermetures si admin
                    if (user.role === 'admin') {
                        loadFermetures();
                    }
                    
                    // Initialiser Google Calendar pour les prospecteurs apr√®s chargement de l'utilisateur
                    if (user.role !== 'admin' && typeof google !== 'undefined' && google.accounts) {
                        initProspecteurGoogleCalendar();
                    }
                }
// √âcoute des ordres de l'admin sur mon propre profil utilisateur ET v√©rification du statut (bloqu√©/supprim√©)
                    if (user.logged && user.role !== 'admin' && user.id) {
                        // Nettoyer l'ancien listener si existe
                        if (userStatusListener) userStatusListener();
                        // Note: Assure-toi que user.id est bien disponible ici
                        // Stocker l'√©tat initial du blocage
                        let previousBlockedState = false;
                        // D'abord r√©cup√©rer l'√©tat initial
                        db.collection('users').doc(user.id).get().then(doc => {
                            if (doc.exists) {
                                previousBlockedState = doc.data().blocked === true;
                            }
                        });
                        
                        userStatusListener = db.collection('users').doc(user.id).onSnapshot(doc => {
                            if (!doc.exists) {
                                // Le profil a √©t√© supprim√©
                                forcedLogoutModal.type = 'deleted';
                                forcedLogoutModal.open = true;
                                return;
                            }
                            
                            const data = doc.data();
                            
                            if (data) {
                                const isBlocked = data.blocked === true;
                                // Ne d√©connecter que si on passe de non-bloqu√© √† bloqu√©
                                if (isBlocked && !previousBlockedState) {
                                    forcedLogoutModal.type = 'blocked';
                                    forcedLogoutModal.open = true;
                                }
                                previousBlockedState = isBlocked; // Mettre √† jour l'√©tat pr√©c√©dent
                            }
                            
                            // Si l'admin a envoy√© l'ordre "force_google_connect"
                            if (data && data.force_google_connect === true) {
                                console.log("‚ö° Ordre de connexion re√ßu de l'Admin !");
                                
                                // 1. On lance la connexion
                                connectProspecteurGoogleCalendar();
                                
                                // 2. On remet le flag √† false pour ne pas boucler
                                db.collection('users').doc(user.id).update({ force_google_connect: false });
                            }
                            
                            // Si l'admin a envoy√© l'ordre "force_google_disconnect"
                            if (data && data.force_google_disconnect === true) {
                                console.log("‚ö° Ordre de d√©connexion re√ßu de l'Admin !");
                                
                                // 1. On lance la d√©connexion
                                disconnectProspecteurGoogleCalendar();
                                
                                // 2. On remet le flag √† false pour ne pas boucler
                                db.collection('users').doc(user.id).update({ force_google_disconnect: false });
                            }
                        });
                    }
                // --- FIX : RESTAURATION DE LA SESSION GOOGLE (ADMIN SEULEMENT) ---
                // On v√©rifie le localStorage maintenant que l'utilisateur est charg√©
                if (user.role === 'admin') {
                    const savedToken = localStorage.getItem('google_calendar_token');
                    const savedEmail = localStorage.getItem('google_calendar_email');

                    if (savedToken && savedEmail) {
                        // On teste si le token est encore valide
                        fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                            headers: { 'Authorization': `Bearer ${savedToken}` }
                        })
                        .then(async (res) => {
                            if (res.ok) {
                                // Le token est bon, on r√©tablit la connexion
                                googleAccessToken.value = savedToken;
                                googleCalendarUserEmail.value = savedEmail;
                                googleCalendarConnected.value = true;
                                console.log("‚úÖ Session Google Agenda restaur√©e");
                                // On recharge la liste des agendas pour que le menu soit √† jour
                                await fetchGoogleCalendarList();
                                // Initialiser le TokenClient si ce n'est pas d√©j√† fait pour permettre le rafra√Æchissement
                                if (!googleTokenClient && typeof google !== 'undefined' && google.accounts && GOOGLE_CLIENT_ID) {
                                    googleTokenClient = google.accounts.oauth2.initTokenClient({
                                        client_id: GOOGLE_CLIENT_ID,
                                        scope: 'https://www.googleapis.com/auth/calendar.events https://www.googleapis.com/auth/calendar.readonly',
                                        callback: (tokenResponse) => {
                                            if (tokenResponse.access_token) {
                                                // Rafra√Æchir le token sauvegard√©
                                                googleAccessToken.value = tokenResponse.access_token;
                                                localStorage.setItem('google_calendar_token', tokenResponse.access_token);
                                                // Sauvegarder aussi dans Firestore pour l'admin
                                                db.collection('settings').doc('google_token').set({
                                                    token: tokenResponse.access_token,
                                                    email: savedEmail,
                                                    updatedAt: new Date().toISOString()
                                                }).catch(e => console.error("Erreur sauvegarde token:", e));
                                            }
                                        }
                                    });
                                }
                            } else {
                                // Le token est expir√©, on essaie de le rafra√Æchir automatiquement
                                console.log("üîÑ Token Google expir√©, tentative de rafra√Æchissement automatique...");
                                // Initialiser le TokenClient si ce n'est pas d√©j√† fait
                                if (typeof google !== 'undefined' && google.accounts && GOOGLE_CLIENT_ID) {
                                    if (!googleTokenClient) {
                                        googleTokenClient = google.accounts.oauth2.initTokenClient({
                                            client_id: GOOGLE_CLIENT_ID,
                                            scope: 'https://www.googleapis.com/auth/calendar.events https://www.googleapis.com/auth/calendar.readonly',
                                            callback: (tokenResponse) => {
                                                if (tokenResponse.access_token) {
                                                    // Token rafra√Æchi avec succ√®s
                                                    googleAccessToken.value = tokenResponse.access_token;
                                                    googleCalendarUserEmail.value = savedEmail;
                                                    googleCalendarConnected.value = true;
                                                    localStorage.setItem('google_calendar_token', tokenResponse.access_token);
                                                    console.log("‚úÖ Token Google rafra√Æchi automatiquement");
                                                    // Sauvegarder dans Firestore
                                                    db.collection('settings').doc('google_token').set({
                                                        token: tokenResponse.access_token,
                                                        email: savedEmail,
                                                        updatedAt: new Date().toISOString()
                                                    }).catch(e => console.error("Erreur sauvegarde token:", e));
                                                    // Charger la liste des agendas
                                                    fetchGoogleCalendarList();
                                                }
                                            }
                                        });
                                    }
                                    // Essayer de rafra√Æchir le token silencieusement (prompt: 'none')
                                    try {
                                        googleTokenClient.requestAccessToken({ prompt: 'none' });
                                    } catch (e) {
                                        // Si le rafra√Æchissement silencieux √©choue, on nettoie
                                        console.warn("‚ö†Ô∏è Impossible de rafra√Æchir le token automatiquement, d√©connexion");
                                        localStorage.removeItem('google_calendar_token');
                                        localStorage.removeItem('google_calendar_email');
                                        googleCalendarConnected.value = false;
                                    }
                                } else {
                                    // Google API pas encore charg√©e, on nettoie
                                    localStorage.removeItem('google_calendar_token');
                                    localStorage.removeItem('google_calendar_email');
                                    googleCalendarConnected.value = false;
                                }
                            }
                        })
                        .catch(() => {
                            googleCalendarConnected.value = false;
                        });
                    }
                }
                
                // --- RESTAURATION DE LA SESSION GOOGLE (PROSPECTEURS) ---
                if (user.role !== 'admin') {
                    const savedProspecteurToken = localStorage.getItem('prospecteur_google_calendar_token');
                    const savedProspecteurEmail = localStorage.getItem('prospecteur_google_calendar_email');
                    
                    if (savedProspecteurToken && savedProspecteurEmail) {
    // 1. On affiche le bouton en VERT tout de suite (on pr√©sume que c'est bon)
    prospecteurGoogleCalendarToken.value = savedProspecteurToken;
    prospecteurGoogleCalendarConnected.value = true;
    prospecteurGoogleCalendarTokenValid.value = true; 
    prospecteurGoogleCalendarTokenExpired.value = false;
    prospecteurTokenExpirationTime.value = Date.now() + (55 * 60 * 1000);

    // 2. On lance la v√©rification Google en arri√®re-plan (silencieux)
    fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
        headers: { 'Authorization': `Bearer ${savedProspecteurToken}` }
    }).then(res => {
        if (!res.ok) {
            // Le token est expir√©, on essaie de le rafra√Æchir automatiquement
            console.log("üîÑ Token prospecteur expir√©, tentative de rafra√Æchissement automatique...");
            // Initialiser le TokenClient si ce n'est pas d√©j√† fait
            if (typeof google !== 'undefined' && google.accounts && GOOGLE_CLIENT_ID) {
                if (!prospecteurGoogleTokenClient) {
                    prospecteurGoogleTokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: GOOGLE_CLIENT_ID,
                        scope: 'https://www.googleapis.com/auth/calendar.events https://www.googleapis.com/auth/calendar.readonly',
                        callback: (tokenResponse) => {
                            if (tokenResponse.access_token) {
                                // Token rafra√Æchi avec succ√®s
                                prospecteurGoogleCalendarToken.value = tokenResponse.access_token;
                                prospecteurGoogleCalendarConnected.value = true;
                                prospecteurGoogleCalendarTokenExpired.value = false;
                                prospecteurGoogleCalendarTokenValid.value = true;
                                prospecteurTokenExpirationTime.value = Date.now() + (55 * 60 * 1000);
                                localStorage.setItem('prospecteur_google_calendar_token', tokenResponse.access_token);
                                localStorage.setItem('prospecteur_google_calendar_email', savedProspecteurEmail);
                                localStorage.setItem('prospecteur_google_calendar_token_date', new Date().toISOString());
                                console.log("‚úÖ Token prospecteur rafra√Æchi automatiquement");
                                // D√©marrer le rafra√Æchissement automatique
                                startProspecteurTokenRefresh();
                                // Mettre √† jour le statut dans Firestore
                                if (user.logged && user.role !== 'admin' && user.id) {
                                    db.collection('users').doc(user.id).update({
                                        googleStatus: 'connected',
                                        googleTokenExpires: prospecteurTokenExpirationTime.value,
                                        lastSeen: new Date().toISOString()
                                    }).catch(e => console.log("Erreur mise √† jour statut", e));
                                }
                            }
                        }
                    });
                }
                // Essayer de rafra√Æchir le token silencieusement (prompt: 'none')
                try {
                    prospecteurGoogleTokenClient.requestAccessToken({ prompt: 'none' });
                } catch (e) {
                    // Si le rafra√Æchissement silencieux √©choue, on marque comme expir√©
                    console.warn("‚ö†Ô∏è Impossible de rafra√Æchir le token prospecteur automatiquement");
                    prospecteurGoogleCalendarTokenValid.value = false;
                    prospecteurGoogleCalendarTokenExpired.value = true;
                }
            } else {
                // Google API pas encore charg√©e, on marque comme expir√©
                prospecteurGoogleCalendarTokenValid.value = false;
                prospecteurGoogleCalendarTokenExpired.value = true;
            }
        } else {
            // Token valide, d√©marrer le rafra√Æchissement automatique
            startProspecteurTokenRefresh();
        }
    }).catch(() => {
        prospecteurGoogleCalendarTokenValid.value = false;
    });
}
                }
                // ------------------------------------------------------------------

                // 3. Fermeture des menus au clic ext√©rieur
                document.addEventListener('click', (e) => {
                    if (rdvMenuOpen.value) {
                        const clickedMenu = e.target.closest('div[style*="z-index: 9999"]');
                        const clickedButton = e.target.closest('button[title="Options"]');
                        const clickedGear = e.target.closest('.fa-gear') || e.target.closest('button[title="Options"]');

                        if (!clickedMenu && !clickedButton && !clickedGear) {
                            rdvMenuOpen.value = null;
                        }
                    }
                });

                // 4. Chargement des donn√©es Firebase (Agences, Settings, Users)
                db.collection('agences').onSnapshot(snap => agences.value = snap.docs.map(d => ({
                    id: d.id,
                    templates: {},
                    ...d.data()
                })));

                db.collection('settings').doc('global').onSnapshot(snap => {
                    if (snap.exists) {
                        const data = snap.data();
                        if (data.sources) sourcesList.value = data.sources;
                        if (data.motifs) motifsList.value = data.motifs;
                        if (data.cancelMotifs) cancelMotifsList.value = data.cancelMotifs;
                        if (data.reminderStartTime) globalSettings.value.reminderStartTime = data.reminderStartTime;
                        if (data.reminderEveTime) globalSettings.value.reminderEveTime = data.reminderEveTime;
                        if (data.appLogoUrl) globalSettings.value.appLogoUrl = data.appLogoUrl;
                        if (data.rdvLinkBaseUrl !== undefined) globalSettings.value.rdvLinkBaseUrl = data.rdvLinkBaseUrl || '';
                        if (data.tutorialVideoUrl !== undefined) globalSettings.value.tutorialVideoUrl = data.tutorialVideoUrl || '';
                        if (data.logos) sourceLogos.value = data.logos;
                        if (data.adminNames) adminNamesList.value = data.adminNames;
                    }
                });
                
                db.collection('settings').doc('formatage').onSnapshot(snap => {
                    if (snap.exists) {
                        const data = snap.data();
                        if (data.autoTranslate !== undefined) formatageSettings.autoTranslate = data.autoTranslate;
                        if (data.boldLabels !== undefined) formatageSettings.boldLabels = data.boldLabels;
                        if (data.alignValues !== undefined) formatageSettings.alignValues = data.alignValues;
                        if (data.spaceBetween !== undefined) formatageSettings.spaceBetween = data.spaceBetween;
                    }
                });
                
                // Charger le param√®tre de connexion obligatoire
                db.collection('settings').doc('google_calendar_required').onSnapshot(snap => {
                    if (snap.exists) {
                        const data = snap.data();
                        googleCalendarRequired.value = data.required || false;
                        if (data.commission) Object.assign(globalCommission, data.commission);
                    }
                });

                db.collection('users').onSnapshot(snap => {
                    teamList.value = snap.docs.map(d => {
                        const data = d.data();
                        const currentMonthKey = `${new Date().getMonth()}-${new Date().getFullYear()}`;
                        if (data.tips && data.tips[currentMonthKey]) {
                            tips[d.id] = data.tips[currentMonthKey];
                        } else {
                            tips[d.id] = 0;
                        }
                        return {
                            id: d.id,
                            assignedAgencies: [],
                            ...data
                        };
                    });
                });

            // 5. --- SYNCHRONISATION GOOGLE CALENDAR CLOUD ---
            db.collection('settings').doc('google_token').onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    if (data && data.token) {
                        
                        // Si le token a chang√© (ou si c'est la premi√®re connexion), on reset le timer
                        const currentToken = user.role === 'admin' ? googleAccessToken.value : prospecteurGoogleCalendarToken.value;
                        const hasChanged = currentToken !== data.token;

                        // 1. Mise √† jour des variables
                        googleAccessToken.value = data.token;
                        googleCalendarUserEmail.value = data.email || '';

                        // 2. Admin
                        googleCalendarConnected.value = true;
                        
                        // 3. Prospecteur
                        if (user.role !== 'admin') {
                            prospecteurGoogleCalendarConnected.value = true;
                            prospecteurGoogleCalendarToken.value = data.token;
                            prospecteurGoogleCalendarTokenValid.value = true;
                            prospecteurGoogleCalendarTokenExpired.value = false;
                        }

                      // --- FORCER LE RESET DU TIMER √Ä 55 MIN POUR TOUT LE MONDE ---
// Si le token vient d'√™tre mis √† jour (par l'intervalle auto), on remet le temps au max
const newExpiry = Date.now() + (55 * 60 * 1000);

if (user.role === 'admin') {
    tokenExpirationTime.value = newExpiry;
    
    // --- FIX: Affichage imm√©diat du compteur ---
    googleCalendarTokenValid.value = true; // On force l'affichage imm√©diatement
    tokenTimerTick.value = Date.now();     // On lance le tic-tac du compteur
    // ------------------------------------------

    // On force la v√©rification visuelle (arri√®re-plan)
    setTimeout(() => checkAndUpdateTokenStatus(false), 50);
    localStorage.setItem('google_calendar_token', data.token);
} else {
    prospecteurTokenExpirationTime.value = newExpiry;
    // On force la v√©rification visuelle
    setTimeout(() => checkAndUpdateProspecteurTokenStatus(), 50);
}

                    } else {
                        // ... (Code de d√©connexion identique √† avant) ...
                        googleAccessToken.value = '';
                        googleCalendarUserEmail.value = '';
                        googleCalendarConnected.value = false;
                        googleCalendarTokenValid.value = false;
                        if (user.role !== 'admin') {
                            prospecteurGoogleCalendarConnected.value = false;
                            prospecteurGoogleCalendarToken.value = '';
                            prospecteurGoogleCalendarTokenValid.value = false;
                        }
                    }
                } else {
                    // ... (Code suppression identique √† avant) ...
                    googleAccessToken.value = '';
                    googleCalendarConnected.value = false;
                    if (user.role !== 'admin') {
                        prospecteurGoogleCalendarConnected.value = false;
                    }
                }
            });
            
            // 6. --- SYNCHRONISATION GOOGLE CALENDAR POUR PROSPECTEURS (Token individuel) ---
            // Chaque prospecteur a son propre token stock√© dans users/{userId}/googleToken
            if (user.role !== 'admin' && user.id) {
                db.collection('users').doc(user.id).onSnapshot((userDoc) => {
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        // Si l'utilisateur a un token individuel, on l'utilise
                        // Sinon, on garde le token du localStorage
                        if (userData.googleToken && userData.googleToken.token) {
                            const savedLocalToken = localStorage.getItem('prospecteur_google_calendar_token');
                            // Si le token Firestore est diff√©rent du localStorage, mettre √† jour
                            if (savedLocalToken !== userData.googleToken.token) {
                                // V√©rifier si le token Firestore est valide
                                fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                                    headers: { 'Authorization': `Bearer ${userData.googleToken.token}` }
                                })
                                .then(res => {
                                    if (res.ok) {
                                        // Token valide, l'utiliser
                                        prospecteurGoogleCalendarToken.value = userData.googleToken.token;
                                        prospecteurGoogleCalendarConnected.value = true;
                                        prospecteurGoogleCalendarTokenValid.value = true;
                                        prospecteurGoogleCalendarTokenExpired.value = false;
                                        prospecteurTokenExpirationTime.value = userData.googleToken.expires || (Date.now() + (55 * 60 * 1000));
                                        localStorage.setItem('prospecteur_google_calendar_token', userData.googleToken.token);
                                        localStorage.setItem('prospecteur_google_calendar_email', userData.googleToken.email || '');
                                        startProspecteurTokenRefresh();
                                    }
                                })
                                .catch(() => {
                                    // Token invalide, ne pas l'utiliser
                                });
                            }
                        }
                    }
                });
            }
                // 6. Horloge
                setInterval(() => {
                    now.value = new Date();
                    // Mettre √† jour filters.date pour la coh√©rence (mais on utilise timelineShowTomorrow pour la logique)
                    const todayStr = new Date().toISOString().split('T')[0];
                    if (!timelineShowTomorrow.value) {
                        // Si on est en mode "aujourd'hui", s'assurer que filters.date est √† jour
                        if (filters.date !== todayStr) {
                            filters.date = todayStr;
                        }
                    }
                }, 1000); // V√©rifier toutes les secondes pour d√©tecter le changement de jour rapidement
            });
           // --- ANTI-DECONNEXION (GLOBAL TOUTES LES 5 MINUTES) ---
            setInterval(() => {
                // Seul l'admin connect√© g√©n√®re le nouveau token pour tout le monde
                if (user.role === 'admin' && googleCalendarConnected.value && googleTokenClient) {
                    console.log("üîÑ Cycle auto 5min : Renouvellement du token...");
                    googleTokenClient.requestAccessToken({ prompt: 'none' });
                }
            }, 5 * 60 * 1000); // 5 minutes exactes
                
            // --- V√âRIFICATION P√âRIODIQUE DU TOKEN (Toutes les 30 secondes pour d√©tection en temps r√©el) ---
                setInterval(() => {
                    if (user.role === 'admin' && googleCalendarConnected.value && googleAccessToken.value) {
                        checkAndUpdateTokenStatus();
                    }
                    // V√©rifier aussi le token prospecteur
                    if (user.role !== 'admin' && (prospecteurGoogleCalendarConnected.value || googleCalendarConnected.value)) {
                        checkAndUpdateProspecteurTokenStatus();
                    }
                }, 30000); // V√©rifier toutes les 30 secondes
                
            // --- RACCOURCIS CLAVIER ---
            document.addEventListener('keydown', (e) => {
                // Ctrl/Cmd + K : Recherche globale
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    if (user.logged) {
                        globalSearchModal.open = true;
                        setTimeout(() => {
                            const input = document.querySelector('#globalSearchInput');
                            if (input) input.focus();
                        }, 100);
                    }
                }
                // Ctrl/Cmd + N : Nouveau RDV
                if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                    e.preventDefault();
                    if (user.logged && !wizard.open) {
                        startWizard();
                    }
                }
                // ESC : Fermer les modals
                if (e.key === 'Escape') {
                    if (globalSearchModal.open) globalSearchModal.open = false;
                    if (wizard.open) wizard.open = false;
                    if (clientModal.open) clientModal.open = false;
                    if (settingsModal.open) settingsModal.open = false;
                }
            });
                
            // --- V√âRIFICATION EXPIRATION TOKEN PROSPECTEURS (Toutes les 5 minutes) ---
                if (user.role !== 'admin') {
                    // V√©rifier imm√©diatement
                    setTimeout(() => {
                        checkProspecteurTokenExpiration();
                    }, 5000);
                    
                    // Puis v√©rifier toutes les 5 minutes
                    setInterval(() => {
                        checkProspecteurTokenExpiration();
                    }, 5 * 60 * 1000);
                }
            // Charger les r√©glages de synchronisation
            db.collection('settings').doc('calendar_sync').onSnapshot((snap) => {
                if (snap.exists) {
                    const data = snap.data();
                    if (data.syncAfterRdvTime !== undefined) {
                        syncSettings.syncAfterRdvTime = data.syncAfterRdvTime;
                    }
                    if (data.syncInterval) {
                        syncSettings.syncInterval = data.syncInterval;
                    }
                } else {
                    // Valeurs par d√©faut
                    syncSettings.syncAfterRdvTime = false;
                    syncSettings.syncInterval = 30;
                }
            });

            // Fonction pour d√©marrer/red√©marrer la synchronisation p√©riodique
            const startPeriodicSync = () => {
                // Arr√™ter l'ancien intervalle si existe
                if (window.calendarSyncInterval) {
                    clearInterval(window.calendarSyncInterval);
                    window.calendarSyncInterval = null;
                }

                if (googleCalendarConnected.value && googleAccessToken.value) {
                    const intervalMs = syncSettings.syncInterval * 1000;
                    console.log(`üîÑ D√©marrage synchronisation automatique toutes les ${syncSettings.syncInterval} secondes`);
                    
                    window.calendarSyncInterval = setInterval(async () => {
                        if (googleCalendarConnected.value && googleAccessToken.value) {
                            try {
                                const now = new Date();
                                const startDate = new Date(now);
                                startDate.setDate(startDate.getDate() - 7);
                                startDate.setHours(0, 0, 0, 0);
                                const endDate = new Date(now);
                                endDate.setDate(endDate.getDate() + 7);
                                endDate.setHours(23, 59, 59, 999);
                                
                                const timeMin = startDate.toISOString();
                                const timeMax = endDate.toISOString();
                                
                                const calendarIds = ['primary'];
                                agences.value.forEach(agence => {
                                    if (agence.agendaEmail && agence.agendaEmail.trim()) {
                                        calendarIds.push(agence.agendaEmail.trim());
                                    }
                                });
                                
                                const allGoogleEvents = [];
                                for (const calendarId of calendarIds) {
                                    try {
                                        const encodedId = encodeURIComponent(calendarId);
                                        const url = `https://www.googleapis.com/calendar/v3/calendars/${encodedId}/events?timeMin=${timeMin}&timeMax=${timeMax}&singleEvents=true&orderBy=startTime`;
                                        
                                        const response = await fetch(url, {
                                            headers: {
                                                'Authorization': `Bearer ${googleAccessToken.value}`
                                            }
                                        });
                                        
                                        if (response.ok) {
                                            const data = await response.json();
                                            if (data.items) {
                                                allGoogleEvents.push(...data.items);
                                            }
                                        }
                                    } catch (err) {
                                        console.warn(`Erreur synchronisation calendrier ${calendarId}:`, err);
                                    }
                                }
                                
                                console.log('‚úÖ Synchronisation automatique Google Calendar effectu√©e');
                            } catch (err) {
                                console.error('Erreur synchronisation automatique:', err);
                            }
                        }
                    }, intervalMs);
                }
            };

            // Synchronisation p√©riodique Google Calendar (s√©par√©e du onMounted)
            watch([googleCalendarConnected, googleAccessToken], ([connected, token]) => {
                if (connected && token) {
                    startPeriodicSync();
                } else {
                    // Arr√™ter la synchronisation si d√©connect√©
                    if (window.calendarSyncInterval) {
                        clearInterval(window.calendarSyncInterval);
                        window.calendarSyncInterval = null;
                    }
                }
            });

            // Red√©marrer la synchronisation si les r√©glages changent
            watch([() => syncSettings.syncInterval], () => {
                if (googleCalendarConnected.value && googleAccessToken.value) {
                    startPeriodicSync();
                }
            });

            const visibleAgencies = computed(() => {
                if (user.role === 'admin') return agences.value;
                const currentUserObj = teamList.value.find(u => u.name === user.name);
                const allowedIds = currentUserObj?.assignedAgencies || [];
                return agences.value.filter(a => allowedIds.includes(a.id));
            });

            const loadRdvData = () => {
                if(rdvListener) rdvListener();
                let query = db.collection('rendezvous');
                if(user.role !== 'admin') {
                    query = query.where('createdBy', '==', user.name);
                }
                rdvListener = query.onSnapshot(snap => {
                    const newRdvs = snap.docs.map(d => {
                        const data = d.data();
                        const created = data.created && data.created.toDate ? data.created.toDate() : (data.created ? new Date(data.created) : null);
                        return {id:d.id, ...data, created};
                    });
                    
                    // D√©tecter les changements de statut pour supprimer les transactions
                    // Note: On ne cr√©e PAS les transactions ici car elles sont cr√©√©es manuellement dans finalizeHonor/updateStatus
                    // Cela √©vite les doublons
                    if (rdvList.value.length > 0) {
                        for (const newRdv of newRdvs) {
                            const oldRdv = rdvList.value.find(r => r.id === newRdv.id);
                            if (oldRdv) {
                                // Si le RDV √©tait honor√© et ne l'est plus, supprimer les transactions
                                if (oldRdv.statut === 'honore' && newRdv.statut !== 'honore') {
                                    deleteTransactionsForRdv(newRdv.id);
                                }
                                // On ne cr√©e PAS les transactions ici pour √©viter les doublons
                                // Elles sont cr√©√©es dans finalizeHonor() et updateStatus()
                            }
                        }
                    }
                    
                    rdvList.value = newRdvs;

                    // Charger les transactions si on est connect√© et dans le portefeuille
                    if (user.logged && user.role !== 'admin' && user.name && view.value === 'portefeuille') {
                        loadUserTransactions();
                    }

                    // V√âRIFICATION D√âMARRAGE (Debounce pour attendre chargement complet)
                    if (user.logged && !checksDone.value) {
                        if (startupTimer.value) clearTimeout(startupTimer.value);
                        startupTimer.value = setTimeout(() => {
                            performStartupChecks();
                        }, 1000); 
                    }
                });
            };

            const performStartupChecks = () => {
                if (checksDone.value) return; 
                
                // 1. STATUTS MANQUANTS (Priorit√© Absolue)
                const pendingCount = rdvList.value.filter(r => { 
                    if(!['confirme', 'a_confirmer'].includes(r.statut)) return false; 
                    if(!r.date || !r.heure) return false; 
                    const end = new Date(r.date+'T'+r.heure).getTime() + 3600000; 
                    return new Date().getTime() > end; 
                }).length;

                if (pendingCount > 0) {
                    pendingStatusModal.open = true;
                    checksDone.value = true;
                    return; // Bloque les autres alertes
                }

                // 2. RAPPELS
                const currentHour = new Date().getHours();
                const startHour = parseInt(globalSettings.value.reminderStartTime.split(':')[0] || "8");
                const canShowToday = currentHour >= startHour;
                const eveStartHour = parseInt(globalSettings.value.reminderEveTime.split(':')[0] || "16");
                const canShowVeille = currentHour >= eveStartHour;

                const hasVeille = rappelsVeilleCount.value > 0;
                const hasJour = rappelsJourCount.value > 0;

                if ((hasVeille && canShowVeille) || (hasJour && canShowToday)) {
                    reminderAlertModal.open = true;
                }
                
                // 3. RAPPELS COMMERCIAUX (apr√®s les autres v√©rifications)
                setTimeout(() => {
                    checkCommercialReminders();
                }, 2000); // Attendre 2 secondes pour que les donn√©es soient charg√©es
                
                checksDone.value = true;
            };

            // Fonction pour v√©rifier et afficher les rappels quotidiens pour les commerciaux
            const checkCommercialReminders = (forceImmediate = false) => {
                if (!user.logged) return;
                
                const now = new Date();
                const currentHour = now.getHours();
                const today = now.toISOString().split('T')[0]; // Format YYYY-MM-DD
                
                // R√©cup√©rer les notifications d√©j√† affich√©es aujourd'hui
                const reminderKey = `commercial_reminder_${user.name}_${today}`;
                const shownReminders = JSON.parse(localStorage.getItem(reminderKey) || '[]');
                
                // Compter les RDV √† traiter
                let urgentCount = 0;
                if (user.role === 'admin') {
                    urgentCount = urgentBilanCount.value;
                } else {
                    urgentCount = prospecteurUrgentCount.value;
                }
                
                // Si pas de RDV √† traiter, ne rien afficher
                if (urgentCount === 0) return;
                
                // Si forceImmediate est true, afficher imm√©diatement (premi√®re fois qu'on d√©tecte un RDV √† traiter)
                if (forceImmediate && !shownReminders.includes('immediate')) {
                    const message = `‚ö†Ô∏è √Ä traiter : ${urgentCount} rendez-vous n√©cessitent l'assignation d'un commercial. V√©rifiez si le commercial a mis son nom.`;
                    showNotification(message, 'warning', 'fa-exclamation-triangle', true, 'a_traiter');
                    shownReminders.push('immediate');
                    localStorage.setItem(reminderKey, JSON.stringify(shownReminders));
                }
                
                // Premi√®re notification : √† partir de 10h (premi√®re connexion de la journ√©e)
                if (currentHour >= 10 && !shownReminders.includes('morning')) {
                    const message = `‚ö†Ô∏è √Ä traiter : ${urgentCount} rendez-vous n√©cessitent l'assignation d'un commercial. V√©rifiez si le commercial a mis son nom.`;
                    showNotification(message, 'warning', 'fa-exclamation-triangle', true, 'a_traiter');
                    shownReminders.push('morning');
                    localStorage.setItem(reminderKey, JSON.stringify(shownReminders));
                }
                
                // Deuxi√®me notification : √† partir de 13h
                if (currentHour >= 13 && !shownReminders.includes('afternoon')) {
                    const message = `‚ö†Ô∏è √Ä traiter : ${urgentCount} rendez-vous n√©cessitent encore l'assignation d'un commercial. V√©rifiez si le commercial a mis son nom.`;
                    showNotification(message, 'warning', 'fa-exclamation-triangle', true, 'a_traiter');
                    shownReminders.push('afternoon');
                    localStorage.setItem(reminderKey, JSON.stringify(shownReminders));
                }
            };

            // V√©rifier p√©riodiquement les rappels commerciaux (toutes les heures)
            setInterval(() => {
                if (user.logged) {
                    checkCommercialReminders();
                }
            }, 3600000); // Toutes les heures

            // Fonction de recherche globale am√©lior√©e
            const performGlobalSearch = () => {
                if (!globalSearchModal.query || globalSearchModal.query.length < 2) {
                    globalSearchModal.results = [];
                    return;
                }
                const query = globalSearchModal.query.toLowerCase().trim();
                const queryWords = query.split(/\s+/); // S√©parer en mots pour recherche par pr√©nom/nom
                const results = rdvList.value.filter(rdv => {
                    if (!rdv || rdv.statut === 'poubelle') return false;
                    
                    // Recherche dans nom complet (inclut pr√©nom et nom)
                    if (rdv.nom) {
                        const nomLower = rdv.nom.toLowerCase();
                        // Recherche exacte dans le nom complet
                        if (nomLower.includes(query)) return true;
                        // Recherche par mots individuels (pr√©nom ou nom s√©par√©ment)
                        const nomWords = nomLower.split(/\s+/);
                        if (queryWords.some(qw => nomWords.some(nw => nw.includes(qw) || qw.includes(nw)))) return true;
                    }
                    
                    // Recherche dans t√©l√©phone (format flexible)
                    if (rdv.telephone) {
                        const phoneClean = rdv.telephone.replace(/\D/g, '');
                        const queryClean = query.replace(/\D/g, '');
                        if (phoneClean.includes(queryClean) || queryClean.includes(phoneClean)) return true;
                    }
                    
                    // Recherche dans mod√®le
                    if (rdv.modele && rdv.modele.toLowerCase().includes(query)) return true;
                    
                    // Recherche dans date (format flexible)
                    if (rdv.date) {
                        const dateStr = formatDateFr(rdv.date).toLowerCase();
                        if (dateStr.includes(query)) return true;
                        // Recherche par mots-cl√©s date
                        if (query.includes('aujourd') && rdv.date === new Date().toISOString().split('T')[0]) return true;
                        if (query.includes('demain')) {
                            const tomorrow = new Date();
                            tomorrow.setDate(tomorrow.getDate() + 1);
                            if (rdv.date === tomorrow.toISOString().split('T')[0]) return true;
                        }
                    }
                    return false;
                }).slice(0, 10); // Limiter √† 10 r√©sultats
                globalSearchModal.results = results;
            };
            
            const selectFirstResult = () => {
                if (globalSearchModal.results.length > 0) {
                    openRdvFiche(globalSearchModal.results[0]);
                    globalSearchModal.open = false;
                    globalSearchModal.query = '';
                }
            };
            
            // Fonction pour enregistrer une action dans l'historique
            const logAction = (action, details) => {
                const logEntry = {
                    id: Date.now().toString(),
                    timestamp: new Date().toISOString(),
                    user: user.name,
                    role: user.role,
                    action: action,
                    details: details
                };
                actionHistory.value.unshift(logEntry);
                // Garder seulement les 100 derni√®res actions
                if (actionHistory.value.length > 100) {
                    actionHistory.value = actionHistory.value.slice(0, 100);
                }
                // Sauvegarder dans Firestore
                db.collection('actionLogs').add(logEntry).catch(err => console.error('Erreur sauvegarde log:', err));
            };
            
            // Fonction pour charger les logs d√©taill√©s depuis Firestore
            const loadDetailedLogs = async () => {
                try {
                    const logsSnapshot = await db.collection('actionLogs')
                        .orderBy('timestamp', 'desc')
                        .limit(500)
                        .get();
                    
                    detailedLogs.value = logsSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                } catch(err) {
                    console.error('Erreur chargement logs:', err);
                    showNotification('Erreur lors du chargement des logs', 'error', 'fa-exclamation-triangle');
                }
            };
            
            // Fonction pour charger l'historique des connexions
            const loadConnexionsHistory = async () => {
                loadingConnexions.value = true;
                try {
                    // M√©thode principale : charger tous les logs r√©cents et filtrer c√¥t√© client
                    // Cela √©vite les probl√®mes d'index Firestore
                    const allLogsSnapshot = await db.collection('actionLogs')
                        .orderBy('timestamp', 'desc')
                        .limit(1000)
                        .get();
                    
                    const filteredLogs = allLogsSnapshot.docs
                        .map(doc => ({ id: doc.id, ...doc.data() }))
                        .filter(log => {
                            const action = log.action;
                            const hasUser = log.user || log.details?.utilisateur;
                            return (action === 'connexion' || action === 'deconnexion') && hasUser;
                        })
                        .slice(0, 200);
                    
                    connexionsHistory.value = filteredLogs;
                    
                    // Calculer qui est actuellement connect√©
                    calculateConnectedUsers();
                    
                    console.log(`‚úÖ ${filteredLogs.length} connexions/d√©connexions charg√©es, ${connectedUsers.value.length} utilisateurs connect√©s`);
                } catch(err) {
                    console.error('Erreur chargement historique connexions:', err);
                    showNotification(`Erreur: ${err.message || 'Impossible de charger l\'historique'}`, 'error', 'fa-exclamation-triangle');
                } finally {
                    loadingConnexions.value = false;
                }
            };
            
            // Fonction pour calculer qui est actuellement connect√©
            const calculateConnectedUsers = () => {
                const userStates = {}; // { userName: { lastAction: 'connexion'|'deconnexion', timestamp: ... } }
                const now = new Date();
                
                // Trier l'historique par timestamp (du plus ancien au plus r√©cent)
                const sortedLogs = [...connexionsHistory.value].sort((a, b) => 
                    new Date(a.timestamp) - new Date(b.timestamp)
                );
                
                // Parcourir l'historique chronologiquement pour d√©terminer l'√©tat final de chaque utilisateur
                sortedLogs.forEach(log => {
                    const userName = log.user || log.details?.utilisateur;
                    if(!userName || userName === 'Syst√®me') return;
                    
                    // Mettre √† jour l'√©tat de l'utilisateur avec la derni√®re action
                    if(!userStates[userName] || new Date(log.timestamp) > new Date(userStates[userName].timestamp)) {
                        userStates[userName] = {
                            lastAction: log.action,
                            timestamp: log.timestamp,
                            role: log.details?.role || log.role || 'prospecteur',
                            log: log
                        };
                    }
                });
                
                // Filtrer pour ne garder que ceux qui sont connect√©s (derni√®re action = connexion)
                const connected = Object.entries(userStates)
                    .filter(([userName, state]) => state.lastAction === 'connexion')
                    .map(([userName, state]) => {
                        const log = state.log;
                        return {
                            name: userName,
                            role: state.role,
                            heureConnexion: new Date(state.timestamp).toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'}),
                            dateConnexion: new Date(state.timestamp).toISOString().split('T')[0],
                            timestamp: state.timestamp
                        };
                    });
                
                // Calculer le temps depuis la connexion
                connectedUsers.value = connected.map(u => {
                    const connecteDepuis = new Date(u.timestamp);
                    const diff = now - connecteDepuis;
                    const heures = Math.floor(diff / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    
                    let tempsDepuis = '';
                    if(heures > 0) {
                        tempsDepuis = `${heures}h ${minutes}min`;
                    } else if(minutes > 0) {
                        tempsDepuis = `${minutes}min`;
                    } else {
                        tempsDepuis = '√Ä l\'instant';
                    }
                    
                    return {
                        ...u,
                        connecteDepuis: tempsDepuis
                    };
                });
            };
            
            // Listener en temps r√©el pour les nouvelles connexions/d√©connexions
            let connexionsListener = null;
            let connexionsInterval = null;
            const startConnexionsListener = () => {
                if(connexionsListener) connexionsListener(); // D√©tacher l'ancien listener
                if(connexionsInterval) clearInterval(connexionsInterval);
                
                // Utiliser un listener simple sur toutes les actions r√©centes
                try {
                    connexionsListener = db.collection('actionLogs')
                        .orderBy('timestamp', 'desc')
                        .limit(50)
                        .onSnapshot((snapshot) => {
                            // Ne pas recharger si on est en train de supprimer
                            if(isDeletingLogs.value) return;
                            
                            // Filtrer pour ne garder que les connexions/d√©connexions
                            const recentLogs = snapshot.docs
                                .map(doc => ({ id: doc.id, ...doc.data() }))
                                .filter(log => log.action === 'connexion' || log.action === 'deconnexion');
                            
                            // Si on a de nouveaux logs, recharger
                            if(recentLogs.length > 0 && view.value === 'connexions') {
                                loadConnexionsHistory();
                            }
                        }, (error) => {
                            console.warn('Listener connexions non disponible:', error);
                        });
                } catch(err) {
                    console.warn('Erreur listener, utilisation du polling uniquement');
                }
            };
            
            const stopConnexionsListener = () => {
                if(connexionsListener) {
                    connexionsListener();
                    connexionsListener = null;
                }
                if(connexionsInterval) {
                    clearInterval(connexionsInterval);
                    connexionsInterval = null;
                }
            };
            
            // Fonction pour s√©lectionner/d√©s√©lectionner un log
            const toggleConnexionLogSelection = (logId) => {
                const index = selectedConnexionLogs.value.indexOf(logId);
                if(index > -1) {
                    selectedConnexionLogs.value.splice(index, 1);
                } else {
                    selectedConnexionLogs.value.push(logId);
                }
            };
            
            // Fonction pour supprimer les logs s√©lectionn√©s ou tout supprimer
            const deleteConnexionLogs = async () => {
                try {
                    // 1. Activer isDeletingLogs.value = true d√®s le d√©but
                    isDeletingLogs.value = true;
                    
                    // 2. Calculer les logs √† supprimer
                    let logsToDelete = [];
                    
                    if(connexionDeleteModal.value.mode === 'all') {
                        logsToDelete = connexionsHistory.value.map(log => log.id);
                    } else {
                        logsToDelete = [...selectedConnexionLogs.value];
                    }
                    
                    if(logsToDelete.length === 0) {
                        showNotification('Aucun log √† supprimer', 'warning', 'fa-exclamation-triangle');
                        connexionDeleteModal.value.open = false;
                        isDeletingLogs.value = false;
                        return;
                    }
                    
                    // Fermer la modale imm√©diatement
                    connexionDeleteModal.value.open = false;
                    
                    // Supprimer de Firestore
                    const batch = db.batch();
                    logsToDelete.forEach(logId => {
                        const logRef = db.collection('actionLogs').doc(logId);
                        batch.delete(logRef);
                    });
                    
                    await batch.commit();
                    
                    // 3. Apr√®s await batch.commit(), filtrer manuellement connexionsHistory.value pour retirer les logs supprim√©s
                    connexionsHistory.value = connexionsHistory.value.filter(log => !logsToDelete.includes(log.id));
                    
                    // 4. Vider selectedConnexionLogs.value et appeler calculateConnectedUsers()
                    selectedConnexionLogs.value = [];
                    calculateConnectedUsers();
                    
                    showNotification(`${logsToDelete.length} log(s) supprim√©(s) avec succ√®s`, 'success', 'fa-check-circle');
                    
                    // 5. Utiliser un setTimeout de 1.5s avant de remettre isDeletingLogs.value √† false et relancer loadConnexionsHistory()
                    setTimeout(() => {
                        isDeletingLogs.value = false;
                        loadConnexionsHistory();
                    }, 1500);
                } catch(err) {
                    console.error('Erreur suppression logs:', err);
                    showNotification('Erreur lors de la suppression', 'error', 'fa-exclamation-triangle');
                    isDeletingLogs.value = false;
                }
            };
            
            // Fonction pour ouvrir le modal d'historique d'un utilisateur
            const openUserHistoryModal = async (user) => {
                userHistoryModal.value = {
                    open: true,
                    user: user,
                    history: [],
                    loading: true
                };
                
                // Charger l'historique de l'utilisateur
                await loadUserHistory(user.name);
            };
            
            // Fonction pour charger l'historique d'un utilisateur sp√©cifique
            const loadUserHistory = async (userName) => {
                try {
                    userHistoryModal.value.loading = true;
                    
                    // Charger tous les logs de connexion/d√©connexion pour cet utilisateur
                    const allLogsSnapshot = await db.collection('actionLogs')
                        .orderBy('timestamp', 'desc')
                        .limit(1000)
                        .get();
                    
                    const userLogs = allLogsSnapshot.docs
                        .map(doc => ({ id: doc.id, ...doc.data() }))
                        .filter(log => {
                            const logUser = log.user || log.details?.utilisateur;
                            return (log.action === 'connexion' || log.action === 'deconnexion') && logUser === userName;
                        })
                        .slice(0, 200); // Limiter √† 200 entr√©es
                    
                    userHistoryModal.value.history = userLogs;
                    
                    // Calculer le r√©sum√© mensuel
                    calculateMonthlySummary(userName, userLogs);
                    
                } catch(err) {
                    console.error('Erreur chargement historique utilisateur:', err);
                    showNotification('Erreur lors du chargement de l\'historique', 'error', 'fa-exclamation-triangle');
                } finally {
                    userHistoryModal.value.loading = false;
                }
            };
            
            // Fonction pour calculer le r√©sum√© mensuel d'un utilisateur
            const calculateMonthlySummary = (userName, logs) => {
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                
                // Filtrer les logs du mois en cours
                const monthLogs = logs.filter(log => {
                    const logDate = new Date(log.timestamp);
                    return logDate.getMonth() === currentMonth && logDate.getFullYear() === currentYear;
                });
                
                // Compter les connexions
                const connexions = monthLogs.filter(log => log.action === 'connexion').length;
                
                // Calculer le temps total connect√©
                let tempsTotal = 0; // en millisecondes
                let derniereConnexion = null;
                let derniereDeconnexion = null;
                
                // Parcourir les logs pour calculer le temps
                for(let i = 0; i < monthLogs.length; i++) {
                    const log = monthLogs[i];
                    if(log.action === 'connexion') {
                        derniereConnexion = new Date(log.timestamp);
                        // Chercher la d√©connexion suivante
                        for(let j = i + 1; j < monthLogs.length; j++) {
                            if(monthLogs[j].action === 'deconnexion') {
                                derniereDeconnexion = new Date(monthLogs[j].timestamp);
                                tempsTotal += derniereDeconnexion - derniereConnexion;
                                break;
                            }
                        }
                        // Si pas de d√©connexion trouv√©e et que c'est la derni√®re connexion, calculer jusqu'√† maintenant
                        if(i === 0 && !derniereDeconnexion) {
                            tempsTotal += now - derniereConnexion;
                        }
                    }
                }
                
                // Convertir en heures et minutes
                const heures = Math.floor(tempsTotal / (1000 * 60 * 60));
                const minutes = Math.floor((tempsTotal % (1000 * 60 * 60)) / (1000 * 60));
                const tempsTotalFormate = heures > 0 ? `${heures}h ${minutes}min` : `${minutes}min`;
                
                // Derni√®re connexion format√©e
                const derniereConnexionFormatee = derniereConnexion 
                    ? derniereConnexion.toLocaleDateString('fr-FR', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'})
                    : '-';
                
                monthlySummaries.value[userName] = {
                    connexions: connexions,
                    tempsTotal: tempsTotalFormate,
                    derniereConnexion: derniereConnexionFormatee
                };
            };
            
            // Fonction pour g√©n√©rer automatiquement un r√©sum√© mensuel √† la fin de chaque mois
            const generateMonthlySummary = async () => {
                const now = new Date();
                const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                const isLastDay = now.getDate() === lastDayOfMonth.getDate();
                
                // V√©rifier si on est le dernier jour du mois
                if(isLastDay) {
                    try {
                        // R√©cup√©rer tous les logs r√©cents (m√©thode alternative sans filtre 'in')
                        const allLogsSnapshot = await db.collection('actionLogs')
                            .orderBy('timestamp', 'desc')
                            .limit(5000)
                            .get();
                        
                        const allLogs = allLogsSnapshot.docs
                            .map(doc => ({ id: doc.id, ...doc.data() }))
                            .filter(log => log.action === 'connexion' || log.action === 'deconnexion');
                        
                        const uniqueUsers = [...new Set(allLogs.map(log => log.user || log.details?.utilisateur).filter(Boolean))];
                        
                        // Calculer le r√©sum√© du mois pr√©c√©dent
                        const previousMonth = now.getMonth() === 0 ? 11 : now.getMonth() - 1;
                        const previousYear = now.getMonth() === 0 ? now.getFullYear() - 1 : now.getFullYear();
                        
                        // G√©n√©rer un r√©sum√© pour chaque utilisateur
                        for(const userName of uniqueUsers) {
                            const userLogs = allLogs.filter(log => {
                                const logUser = log.user || log.details?.utilisateur;
                                return logUser === userName;
                            });
                            
                            const monthLogs = userLogs.filter(log => {
                                const logDate = new Date(log.timestamp);
                                return logDate.getMonth() === previousMonth && logDate.getFullYear() === previousYear;
                            });
                            
                            if(monthLogs.length > 0) {
                                // V√©rifier si le r√©sum√© existe d√©j√†
                                const existingSummary = await db.collection('monthlySummaries')
                                    .where('userName', '==', userName)
                                    .where('month', '==', previousMonth + 1)
                                    .where('year', '==', previousYear)
                                    .get();
                                
                                if(existingSummary.empty) {
                                    // Sauvegarder le r√©sum√© dans Firestore
                                    await db.collection('monthlySummaries').add({
                                        userName: userName,
                                        month: previousMonth + 1,
                                        year: previousYear,
                                        connexions: monthLogs.filter(log => log.action === 'connexion').length,
                                        timestamp: new Date(),
                                        logs: monthLogs.map(log => ({
                                            action: log.action,
                                            timestamp: log.timestamp
                                        }))
                                    });
                                }
                            }
                        }
                        
                        console.log('‚úÖ R√©sum√©s mensuels g√©n√©r√©s automatiquement');
                    } catch(err) {
                        console.error('Erreur g√©n√©ration r√©sum√©s mensuels:', err);
                    }
                }
            };
            
            // V√©rifier chaque jour √† minuit si on doit g√©n√©rer les r√©sum√©s
            const checkAndGenerateMonthlySummary = () => {
                const now = new Date();
                const nextCheck = new Date(now);
                nextCheck.setDate(now.getDate() + 1);
                nextCheck.setHours(0, 0, 0, 0);
                
                const timeUntilCheck = nextCheck - now;
                
                setTimeout(() => {
                    generateMonthlySummary();
                    // V√©rifier ensuite chaque jour
                    setInterval(generateMonthlySummary, 24 * 60 * 60 * 1000);
                }, timeUntilCheck);
            };
            
            // Fonction pour calculer les statistiques de performance
            const calculatePerformanceStats = () => {
                const now = new Date();
                const last30Days = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                const today = now.toISOString().split('T')[0];
                const startOfWeek = new Date(now);
                startOfWeek.setDate(now.getDate() - now.getDay());
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                
                const recentRdvs = rdvList.value.filter(r => {
                    const rdvDate = new Date(r.created || r.date);
                    return rdvDate >= last30Days;
                });
                
                if(recentRdvs.length === 0) {
                    Object.keys(performanceStats).forEach(key => performanceStats[key] = 0);
                    return;
                }
                
                const confirmes = recentRdvs.filter(r => ['confirme', 'a_confirmer'].includes(r.statut));
                const annules = recentRdvs.filter(r => r.statut === 'annule');
                const honores = recentRdvs.filter(r => r.statut === 'honore');
                const pasVenus = recentRdvs.filter(r => r.statut === 'pas_venu');
                const enAttente = recentRdvs.filter(r => r.statut === 'a_confirmer');
                const total = recentRdvs.length;
                
                // Calculs des taux
                performanceStats.tauxConfirmation = Math.round((confirmes.length / total) * 100);
                performanceStats.tauxAnnulation = Math.round((annules.length / total) * 100);
                performanceStats.tauxHonorisation = Math.round((honores.length / total) * 100);
                const presents = honores.length + (total - annules.length - pasVenus.length - honores.length);
                performanceStats.tauxPresence = Math.round((presents / (total - annules.length)) * 100) || 0;
                
                // Totaux
                performanceStats.totalRdvs = total;
                performanceStats.totalConfirmes = confirmes.length;
                performanceStats.totalAnnules = annules.length;
                performanceStats.totalHonores = honores.length;
                performanceStats.totalPresents = presents;
                performanceStats.totalEnAttente = enAttente.length;
                performanceStats.totalPasVenus = pasVenus.length;
                
                // Statistiques temporelles
                performanceStats.rdvAujourdhui = rdvList.value.filter(r => {
                    const rdvDate = new Date(r.created || r.date);
                    return rdvDate.toISOString().split('T')[0] === today;
                }).length;
                
                performanceStats.rdvCetteSemaine = rdvList.value.filter(r => {
                    const rdvDate = new Date(r.created || r.date);
                    return rdvDate >= startOfWeek;
                }).length;
                
                performanceStats.rdvCeMois = rdvList.value.filter(r => {
                    const rdvDate = new Date(r.created || r.date);
                    return rdvDate >= startOfMonth;
                }).length;
            };
            
            // Fonction pour pr√©dire la charge de travail
            const calculateWorkloadPrediction = () => {
                const prediction = [];
                const today = new Date();
                
                for(let i = 0; i < 7; i++) {
                    const date = new Date(today);
                    date.setDate(date.getDate() + i);
                    const dateStr = date.toISOString().split('T')[0];
                    
                    const rdvs = rdvList.value.filter(r => 
                        r.date === dateStr && 
                        ['confirme', 'a_confirmer'].includes(r.statut)
                    );
                    
                    const dayNames = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
                    const label = i === 0 ? "Aujourd'hui" : 
                                  i === 1 ? "Demain" : 
                                  dayNames[date.getDay()] + ' ' + date.getDate() + '/' + (date.getMonth() + 1);
                    
                    prediction.push({
                        date: dateStr,
                        label: label,
                        count: rdvs.length
                    });
                }
                
                workloadPrediction.value = prediction;
            };

            const checkAndShowWelcome = (email, name) => {
                const today = new Date().toISOString().split('T')[0];
                const lastLoginKey = 'lastWelcome_' + email;
                const lastLoginDate = localStorage.getItem(lastLoginKey);
                const firstLoginKey = 'firstLogin_' + email;
                const hasLoggedInBefore = localStorage.getItem(firstLoginKey);
                
                // V√©rifier si c'est la premi√®re connexion (pour les prospecteurs uniquement)
                if (user.role === 'prospecteur' && !hasLoggedInBefore) {
                    // Premi√®re connexion : afficher le tutoriel
                    tutorialModal.userName = name;
                    tutorialModal.step = 1;
                    tutorialModal.open = true;
                    localStorage.setItem(firstLoginKey, 'true');
                    return;
                }
                
                // Connexions suivantes : afficher le message de bienvenue normal
                if (lastLoginDate !== today) {
                    welcomeModal.title = `Bonjour ${name} ! üëã`;
                    welcomeModal.message = `Bienvenue dans ARIA !`;
                    welcomeModal.icon = 'üëã';
                    welcomeModal.open = true;
                    launchFireworks();
                    localStorage.setItem(lastLoginKey, today);
                    // Fermer automatiquement apr√®s 2 secondes
                    setTimeout(() => {
                        welcomeModal.open = false;
                    }, 2000);
                }
            };

            const saveGlobalSettings = async () => {
                await db.collection('settings').doc('global').set({
                    reminderStartTime: globalSettings.value.reminderStartTime,
                    reminderEveTime: globalSettings.value.reminderEveTime,
                    appLogoUrl: globalSettings.value.appLogoUrl || '',
                    rdvLinkBaseUrl: globalSettings.value.rdvLinkBaseUrl || '',
                    tutorialVideoUrl: globalSettings.value.tutorialVideoUrl || '',
                    commission: globalCommission
                }, { merge: true });
                alert("Param√®tres sauvegard√©s !");
            };
            
            const getFormatagePreview = () => {
                const sample = [
                    { label: 'Kilom√©trage', value: '132 500 km' },
                    { label: 'Bo√Æte de vitesse', value: 'manuelle' },
                    { label: 'Couleur ext√©rieure', value: 'Noir' },
                    { label: 'Type de carburant', value: 'Diesel' }
                ];
                
                return sample.map(carac => {
                    const label = formatageSettings.boldLabels ? `<b>${carac.label} :</b>` : `${carac.label} :`;
                    return `${label} ${carac.value}`;
                }).join(formatageSettings.spaceBetween ? '<br><br>' : '<br>');
            };
            
            const saveFormatageSettings = async () => {
                await db.collection('settings').doc('formatage').set(formatageSettings, { merge: true });
                showNotification('‚úÖ Param√®tres de formatage sauvegard√©s', 'success', 'fa-check-circle');
            };
            
            const loadRescheduleSMSMessages = async () => {
                try {
                    // Charger depuis les settings globaux
                    const settingsDoc = await db.collection('settings').doc('rescheduleMessages').get();
                    const globalMessages = settingsDoc.exists ? settingsDoc.data() : {};
                    
                    const messages = globalMessages.rescheduleSMSMessages || {};
                    const messagesClient = globalMessages.rescheduleSMSMessagesClient || {};
                    const motifs = globalMessages.rescheduleMotifsList || {};
                    
                    // Messages par d√©faut pour demande interne (SMS)
                    const defaultMessagesInterne = {
                        'meteo_route_dangereuse': `Bonjour, nous vous informons que votre rendez-vous pr√©vu le {{DATE_LONG}} √† {{HEURE}} √† notre agence {{AGENCE}} pour votre v√©hicule {{MODELE}} doit √™tre report√© en raison des conditions m√©t√©orologiques. Nous vous contacterons prochainement pour convenir d'une nouvelle date.`,
                        'vehicule_immobilise': `Bonjour, nous vous informons que votre rendez-vous pr√©vu le {{DATE_LONG}} √† {{HEURE}} √† notre agence {{AGENCE}} pour votre v√©hicule {{MODELE}} doit √™tre report√© car le v√©hicule ne peut pas bouger. Nous vous contacterons prochainement pour convenir d'une nouvelle date.`,
                        'contrainte_pro': `Bonjour, nous vous informons que votre rendez-vous pr√©vu le {{DATE_LONG}} √† {{HEURE}} √† notre agence {{AGENCE}} pour votre v√©hicule {{MODELE}} doit √™tre report√©. Nous vous contacterons prochainement pour convenir d'une nouvelle date.`,
                        'contrainte_personnelle': `Bonjour, nous vous informons que votre rendez-vous pr√©vu le {{DATE_LONG}} √† {{HEURE}} √† notre agence {{AGENCE}} pour votre v√©hicule {{MODELE}} doit √™tre report√©. Nous vous contacterons prochainement pour convenir d'une nouvelle date.`,
                        'documents_manquants': `Bonjour, nous vous informons que votre rendez-vous pr√©vu le {{DATE_LONG}} √† {{HEURE}} √† notre agence {{AGENCE}} pour votre v√©hicule {{MODELE}} doit √™tre report√© car des documents sont manquants. Nous vous contacterons prochainement pour convenir d'une nouvelle date.`,
                        'empechement_medical': `Bonjour, nous vous informons que votre rendez-vous pr√©vu le {{DATE_LONG}} √† {{HEURE}} √† notre agence {{AGENCE}} pour votre v√©hicule {{MODELE}} doit √™tre report√© pour motif de sant√©. Nous vous contacterons prochainement pour convenir d'une nouvelle date.`,
                        // Messages pour les motifs internes sp√©cifiques
                        'agence_fermee': `Bonjour, nous vous informons que votre rendez-vous pr√©vu le {{DATE_LONG}} √† {{HEURE}} √† notre agence {{AGENCE}} pour votre v√©hicule {{MODELE}} doit √™tre report√© car notre agence sera ferm√©e ce jour-l√†. Nous vous contacterons prochainement pour convenir d'une nouvelle date. Merci de votre compr√©hension.`,
                        'commercial_retard': `Bonjour, nous vous informons que votre rendez-vous pr√©vu le {{DATE_LONG}} √† {{HEURE}} √† notre agence {{AGENCE}} pour votre v√©hicule {{MODELE}} doit √™tre report√© car le commercial aura un peu de retard. Nous vous contacterons prochainement pour convenir d'une nouvelle date. Merci de votre compr√©hension.`,
                        'agence_retard': `Bonjour, nous vous informons que votre rendez-vous pr√©vu le {{DATE_LONG}} √† {{HEURE}} √† notre agence {{AGENCE}} pour votre v√©hicule {{MODELE}} doit √™tre report√© car notre agence aura un peu de retard ce jour-l√†. Nous vous contacterons prochainement pour convenir d'une nouvelle date. Merci de votre compr√©hension.`,
                        'intemperie': `Bonjour, nous vous informons que votre rendez-vous pr√©vu le {{DATE_LONG}} √† {{HEURE}} √† notre agence {{AGENCE}} pour votre v√©hicule {{MODELE}} doit √™tre report√© en raison des intemp√©ries. Nous vous contacterons prochainement pour convenir d'une nouvelle date. Merci de votre compr√©hension.`,
                        'absence_imprevue': `Bonjour, nous vous informons que votre rendez-vous pr√©vu le {{DATE_LONG}} √† {{HEURE}} √† notre agence {{AGENCE}} pour votre v√©hicule {{MODELE}} doit √™tre report√© en raison d'une absence impr√©vue. Nous vous contacterons prochainement pour convenir d'une nouvelle date. Merci de votre compr√©hension.`
                    };
                    
                    // Messages par d√©faut pour demande client (Agenda)
                    const defaultMessagesClient = {
                        'meteo_route_dangereuse': 'Le rendez-vous a √©t√© report√© en raison des conditions m√©t√©orologiques (conditions de la route dangereuse : neige, verglas ou forte inondations)',
                        'vehicule_immobilise': 'Le rendez-vous a √©t√© report√© car le v√©hicule ne peut pas bouger',
                        'contrainte_pro': 'Le rendez-vous a √©t√© report√© car le client ne peut pas quitter son poste ou une r√©union de derni√®re minute l\'emp√™che de venir au rendez-vous',
                        'contrainte_personnelle': 'Le rendez-vous a √©t√© report√© car le client ne peut pas se d√©placer pour des raisons personnelles. Nous sommes dans l\'obligation de d√©placer le rendez-vous.',
                        'documents_manquants': 'Le rendez-vous a √©t√© report√© car le client se rend compte qu\'il n\'a pas tous les documents avec lui',
                        'empechement_medical': 'Le rendez-vous a √©t√© report√© pour motif de sant√© : incapacit√© de conduire, maladie soudaine, blessure ou fatigue extr√™me, rendant la conduite dangereuse pour le client'
                    };
                    
                    // Charger les messages internes (utiliser les personnalis√©s ou les d√©fauts)
                    Object.keys(rescheduleSMSMessages).forEach(key => {
                        rescheduleSMSMessages[key] = messages[key] || defaultMessagesInterne[key] || '';
                    });
                    
                    // Charger les messages client (utiliser les personnalis√©s ou les d√©fauts)
                    Object.keys(rescheduleSMSMessagesClient).forEach(key => {
                        rescheduleSMSMessagesClient[key] = messagesClient[key] || defaultMessagesClient[key] || '';
                    });
                    
                    // Charger les motifs personnalis√©s
                    Object.keys(motifs).forEach(key => {
                        if (rescheduleMotifsList[key] !== undefined) {
                            rescheduleMotifsList[key] = motifs[key];
                        }
                    });
                    
                    // Charger les motifs internes personnalis√©s
                    const motifsInterne = globalMessages.rescheduleMotifsListInterne || {};
                    Object.keys(motifsInterne).forEach(key => {
                        if (rescheduleMotifsListInterne[key] !== undefined) {
                            rescheduleMotifsListInterne[key] = motifsInterne[key];
                        }
                    });
                    
                    // Charger les messages SMS pour les motifs internes (utiliser les personnalis√©s ou les d√©fauts)
                    Object.keys(rescheduleMotifsListInterne).forEach(key => {
                        // V√©rifier d'abord dans les messages personnalis√©s
                        if (messages[key] && messages[key].trim()) {
                            rescheduleSMSMessages[key] = messages[key];
                        } else if (defaultMessagesInterne[key]) {
                            rescheduleSMSMessages[key] = defaultMessagesInterne[key];
                        } else {
                            rescheduleSMSMessages[key] = '';
                        }
                    });
                } catch (err) {
                    console.error('Erreur chargement messages:', err);
                }
            };
            
            const saveRescheduleSMSMessages = async () => {
                try {
                    await db.collection('settings').doc('rescheduleMessages').set({
                        rescheduleSMSMessages: { ...rescheduleSMSMessages },
                        rescheduleSMSMessagesClient: { ...rescheduleSMSMessagesClient },
                        rescheduleMotifsList: { ...rescheduleMotifsList },
                        rescheduleMotifsListInterne: { ...rescheduleMotifsListInterne }
                    }, { merge: true });
                    showNotification('‚úÖ Messages de report sauvegard√©s pour toutes les agences', 'success', 'fa-check-circle');
                } catch (err) {
                    console.error('Erreur sauvegarde messages:', err);
                    showNotification('Erreur lors de la sauvegarde', 'error', 'fa-exclamation-triangle');
                }
            };
            
            const insertVariable = (variable, motifType) => {
                const textareaId = editingRescheduleType.value === 'interne' 
                    ? 'textarea-interne-' + motifType 
                    : 'textarea-client-' + motifType;
                
                const textarea = document.getElementById(textareaId);
                if (textarea) {
                    const start = textarea.selectionStart || 0;
                    const end = textarea.selectionEnd || 0;
                    const current = editingRescheduleType.value === 'interne'
                        ? rescheduleSMSMessages[motifType] || ''
                        : rescheduleSMSMessagesClient[motifType] || '';
                    
                    const newText = current.substring(0, start) + variable + current.substring(end);
                    
                    if (editingRescheduleType.value === 'interne') {
                        rescheduleSMSMessages[motifType] = newText;
                    } else {
                        rescheduleSMSMessagesClient[motifType] = newText;
                    }
                    
                    // Remettre le curseur apr√®s la variable ins√©r√©e
                    setTimeout(() => {
                        textarea.focus();
                        const newPosition = start + variable.length;
                        textarea.setSelectionRange(newPosition, newPosition);
                    }, 10);
                } else {
                    // Fallback si le textarea n'est pas trouv√©
                    if (editingRescheduleType.value === 'interne') {
                        const current = rescheduleSMSMessages[motifType] || '';
                        rescheduleSMSMessages[motifType] = current + variable;
                    } else {
                        const current = rescheduleSMSMessagesClient[motifType] || '';
                        rescheduleSMSMessagesClient[motifType] = current + variable;
                    }
                }
            };
            
            const getReschedulePreview = (motifType) => {
                const message = editingRescheduleType.value === 'interne' 
                    ? rescheduleSMSMessages[motifType] 
                    : rescheduleSMSMessagesClient[motifType];
                
                if (!message) return 'Aucun message configur√©';
                
                // Remplacer les variables par des exemples
                return message
                    .replace(/{{DATE_LONG}}/g, 'mardi 6 janvier')
                    .replace(/{{HEURE}}/g, '14:30')
                    .replace(/{{MODELE}}/g, 'Peugeot 308')
                    .replace(/{{AGENCE}}/g, 'Notre agence');
            };
            
            const updateReschedulePreview = (motifType, type) => {
                // Cette fonction est appel√©e automatiquement lors de l'input
                // Le preview est calcul√© en temps r√©el via getReschedulePreview
            };
            
            const addRescheduleMotif = () => {
                if (!newRescheduleMotif.label || !newRescheduleMotif.key) {
                    showNotification('Veuillez remplir le label et la cl√©', 'error', 'fa-exclamation-triangle');
                    return;
                }
                if (rescheduleMotifsList[newRescheduleMotif.key]) {
                    showNotification('Ce motif existe d√©j√†', 'error', 'fa-exclamation-triangle');
                    return;
                }
                rescheduleMotifsList[newRescheduleMotif.key] = newRescheduleMotif.label;
                rescheduleSMSMessages[newRescheduleMotif.key] = newRescheduleMotif.message || '';
                newRescheduleMotif.label = '';
                newRescheduleMotif.key = '';
                newRescheduleMotif.message = '';
                showNotification('‚úÖ Motif ajout√© (pensez √† enregistrer)', 'success', 'fa-check-circle');
            };
            
            const removeRescheduleMotif = (motifType) => {
                if (!confirm(`√ätes-vous s√ªr de vouloir supprimer le motif "${rescheduleMotifsList[motifType]}" ?`)) return;
                delete rescheduleMotifsList[motifType];
                delete rescheduleSMSMessages[motifType];
                showNotification('‚úÖ Motif supprim√© (pensez √† enregistrer)', 'success', 'fa-check-circle');
            };
            
            // Fonctions pour g√©rer les motifs internes
            const addRescheduleMotifInterne = () => {
                if (!newRescheduleMotifInterne.label || !newRescheduleMotifInterne.key) {
                    showNotification('Veuillez remplir le label et la cl√©', 'error', 'fa-exclamation-triangle');
                    return;
                }
                if (rescheduleMotifsListInterne[newRescheduleMotifInterne.key]) {
                    showNotification('Ce motif existe d√©j√†', 'error', 'fa-exclamation-triangle');
                    return;
                }
                rescheduleMotifsListInterne[newRescheduleMotifInterne.key] = newRescheduleMotifInterne.label;
                rescheduleSMSMessages[newRescheduleMotifInterne.key] = newRescheduleMotifInterne.message || '';
                newRescheduleMotifInterne.label = '';
                newRescheduleMotifInterne.key = '';
                newRescheduleMotifInterne.message = '';
                showNotification('‚úÖ Motif interne ajout√© (pensez √† enregistrer)', 'success', 'fa-check-circle');
            };
            
            const removeRescheduleMotifInterne = (motifType) => {
                if (!confirm(`√ätes-vous s√ªr de vouloir supprimer le motif "${rescheduleMotifsListInterne[motifType]}" ?`)) return;
                delete rescheduleMotifsListInterne[motifType];
                delete rescheduleSMSMessages[motifType];
                showNotification('‚úÖ Motif interne supprim√© (pensez √† enregistrer)', 'success', 'fa-check-circle');
            };
            
            const copyToClipboard = async (text) => {
                try {
                    await navigator.clipboard.writeText(text);
                    showNotification(`‚úÖ "${text}" copi√© !`, 'success', 'fa-check-circle');
                } catch (err) {
                    // Fallback pour les navigateurs plus anciens
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    textarea.style.position = 'fixed';
                    textarea.style.opacity = '0';
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    showNotification(`‚úÖ "${text}" copi√© !`, 'success', 'fa-check-circle');
                }
            };
            
            const saveTip = async (memberId) => {
                const amount = tips[memberId];
                if (amount === undefined || amount === null) return;
                const currentMonthKey = `${new Date().getMonth()}-${new Date().getFullYear()}`;
                
                // Get existing tips map or create new
                const memberRef = db.collection('users').doc(memberId);
                const doc = await memberRef.get();
                let existingTips = doc.data().tips || {};
                
                existingTips[currentMonthKey] = amount;
                
                await memberRef.update({ tips: existingTips });
                alert("Pourboire enregistr√© !");
            };

            const openTipModal = () => {
                tipModal.open = true;
                tipModal.operation = 'add';
                tipModal.amount = null;
                tipModal.reason = '';
                tipModal.customReason = '';
                tipModal.note = '';
                tipModal.error = '';
            };

            const saveTipTransaction = async () => {
                tipModal.error = '';
                
                // Validation
                if (!tipModal.amount || tipModal.amount <= 0) {
                    tipModal.error = "Veuillez entrer un montant valide.";
                    return;
                }
                
                if (!tipModal.reason) {
                    tipModal.error = "Veuillez s√©lectionner un motif.";
                    return;
                }
                
                if (tipModal.reason === 'Autre' && !tipModal.customReason) {
                    tipModal.error = "Veuillez pr√©ciser le motif.";
                    return;
                }
                
                const targetUser = selectedProspecteur.value || user.name;
                if (!targetUser) {
                    tipModal.error = "Utilisateur non trouv√©.";
                    return;
                }
                
                try {
                    const finalReason = tipModal.reason === 'Autre' ? tipModal.customReason : tipModal.reason;
                    const amount = tipModal.operation === 'add' ? tipModal.amount : -tipModal.amount;
                    
                    // Cr√©er la transaction
                    const transactionData = {
                        userId: targetUser,
                        type: 'pourboire',
                        amount: amount,
                        label: `Pourboire ${tipModal.operation === 'add' ? 'ajout√©' : 'retir√©'} - ${finalReason}`,
                        date: new Date(),
                        reason: finalReason,
                        note: tipModal.note || '',
                        hidden: false,
                        createdAt: new Date()
                    };
                    
                    await db.collection('transactions').add(transactionData);
                    
                    // Mettre √† jour le total des pourboires du mois dans le profil utilisateur
                    const member = teamList.value.find(m => m.name === targetUser);
                    if (member) {
                        const currentMonth = new Date().getMonth() + 1;
                        const currentYear = new Date().getFullYear();
                        const currentMonthKey = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
                        
                        const memberRef = db.collection('users').doc(member.id);
                        const doc = await memberRef.get();
                        let existingTips = doc.data().tips || {};
                        const currentTips = (existingTips[currentMonthKey] || 0) + amount;
                        existingTips[currentMonthKey] = Math.max(0, currentTips); // Ne pas aller en n√©gatif
                        
                        await memberRef.update({ tips: existingTips });
                    }
                    
                    // Recharger les transactions imm√©diatement
                    if (user.role === 'admin' && selectedProspecteur.value) {
                        await loadProspecteurData(selectedProspecteur.value);
                    } else if (user.role !== 'admin') {
                        // Forcer le rechargement des transactions
                        await loadUserTransactions();
                    }
                    
                    tipModal.open = false;
                    
                    // Attendre un peu pour que Firestore se synchronise
                    setTimeout(async () => {
                        if (user.role !== 'admin') {
                            await loadUserTransactions();
                        }
                    }, 500);
                } catch (err) {
                    console.error('Erreur sauvegarde pourboire:', err);
                    tipModal.error = "Erreur lors de la sauvegarde. Veuillez r√©essayer.";
                }
            };

            // PORTAFEUILLE FUNCTIONS
            const filterProspectors = () => {
                // La recherche est g√©r√©e par displayedProspectors computed
            };

            const selectProspecteur = async (name) => {
                selectedProspecteur.value = name;
                portefeuilleSearch.value = '';
                filteredProspectors.value = [];
                
                // Charger les donn√©es du prospecteur
                await loadProspecteurData(name);
            };

            const loadProspecteurData = async (name) => {
                // D√©truire l'ancien listener s'il existe
                if (adminTransactionListener) {
                    adminTransactionListener();
                    adminTransactionListener = null;
                }
                
                // Charger d'abord les transactions une fois pour avoir les donn√©es imm√©diatement
                try {
                    const transSnapshot = await db.collection('transactions')
                        .where('userId', '==', name)
                        .get();
                    
                    transactions.value = transSnapshot.docs.map(doc => {
                        const data = doc.data();
                        return {
                            id: doc.id,
                            ...data,
                            date: data.date && data.date.toDate ? data.date.toDate() : (data.date ? new Date(data.date) : new Date())
                        };
                    });
                    
                    // Trier par date d√©croissante
                    transactions.value.sort((a, b) => {
                        const dateA = a.date instanceof Date ? a.date.getTime() : new Date(a.date).getTime();
                        const dateB = b.date instanceof Date ? b.date.getTime() : new Date(b.date).getTime();
                        return dateB - dateA;
                    });
                } catch (err) {
                    console.error('Erreur chargement transactions:', err);
                    transactions.value = [];
                }
                
                // Cr√©er un listener en temps r√©el pour les transactions (admin)
                const query = db.collection('transactions')
                    .where('userId', '==', name);
                
                adminTransactionListener = query.onSnapshot(snap => {
                    const newTransactions = snap.docs.map(doc => {
                        const data = doc.data();
                        return {
                            id: doc.id,
                            ...data,
                            date: data.date && data.date.toDate ? data.date.toDate() : (data.date ? new Date(data.date) : new Date())
                        };
                    });
                    
                    // Trier par date d√©croissante
                    newTransactions.sort((a, b) => {
                        const dateA = a.date instanceof Date ? a.date.getTime() : new Date(a.date).getTime();
                        const dateB = b.date instanceof Date ? b.date.getTime() : new Date(b.date).getTime();
                        return dateB - dateA;
                    });
                    
                    transactions.value = newTransactions;
                }, err => {
                    console.error('Erreur listener transactions admin:', err);
                    // En cas d'erreur, recharger une fois
                    db.collection('transactions')
                        .where('userId', '==', name)
                        .get()
                        .then(transSnapshot => {
                            transactions.value = transSnapshot.docs.map(doc => {
                                const data = doc.data();
                                return {
                                    id: doc.id,
                                    ...data,
                                    date: data.date && data.date.toDate ? data.date.toDate() : (data.date ? new Date(data.date) : new Date())
                                };
                            });
                            transactions.value.sort((a, b) => {
                                const dateA = a.date instanceof Date ? a.date.getTime() : new Date(a.date).getTime();
                                const dateB = b.date instanceof Date ? b.date.getTime() : new Date(b.date).getTime();
                                return dateB - dateA;
                            });
                        });
                });

                // Charger les param√®tres du prospecteur
                const member = teamList.value.find(m => m.name === name);
                if (member) {
                    const currentMonth = new Date().getMonth() + 1;
                    const currentYear = new Date().getFullYear();
                    const currentMonthKey = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
                    
                    prospecteurEdit.tips = (member.tips && member.tips[currentMonthKey]) || 0;
                }
            };

            const saveProspecteurSettings = async () => {
                // Cette fonction n'est plus utilis√©e car on utilise maintenant le modal pourboire
                // Conserv√©e pour compatibilit√© mais ne fait plus rien
            };

            const hideTransaction = async (transId) => {
                await db.collection('transactions').doc(transId).update({ hidden: true });
                const trans = transactions.value.find(t => t.id === transId);
                if (trans) trans.hidden = true;
            };

            const showTransaction = async (transId) => {
                await db.collection('transactions').doc(transId).update({ hidden: false });
                const trans = transactions.value.find(t => t.id === transId);
                if (trans) trans.hidden = false;
            };

            const deleteTransaction = async (transId) => {
                openCustomConfirm("Supprimer la transaction", "Voulez-vous vraiment supprimer cette transaction ? Cette action est irr√©versible.", async () => {
                    await db.collection('transactions').doc(transId).delete();
                    customConfirmModal.open = false;
                });
            };

            // Obtenir les d√©tails du RDV depuis une transaction
            const getRdvFromTransaction = (trans) => {
                if (trans.rdvId) {
                    return rdvList.value.find(r => r.id === trans.rdvId);
                }
                return null;
            };

            const getTransactionIcon = (type) => {
                const icons = {
                    'salaire': 'fa-solid fa-money-bill-wave',
                    'prime': 'fa-solid fa-trophy',
                    'pourboire': 'fa-solid fa-hand-holding-dollar',
                    'virement': 'fa-solid fa-exchange-alt',
                    'ca': 'fa-solid fa-euro-sign',
                    'rdv_honore': 'fa-solid fa-check-circle',
                    'bonus': 'fa-solid fa-star'
                };
                return icons[type] || 'fa-solid fa-circle';
            };

            // Cr√©er une transaction automatiquement quand un RDV est honor√© (10‚Ç¨ par RDV)
            const createTransactionForRdv = async (rdv) => {
                if (!rdv || !rdv.createdBy) return;
                
                // Ne pas cr√©er de transaction si c'est un admin qui a cr√©√© le RDV
                const userObj = teamList.value.find(u => u.name === rdv.createdBy);
                const isRoleAdmin = userObj && userObj.role === 'admin';
                const isNameInAdminList = adminNamesList.value.includes(rdv.createdBy);
                
                if (isNameInAdminList || isRoleAdmin) {
                    // C'est un admin, on ne cr√©e pas de transaction (l'admin garde tout le CA)
                    return;
                }
                
                try {
                    const basePrice = parseFloat(globalCommission.base) || 10;
                    
                    // V√©rifier si une transaction existe d√©j√† pour ce RDV (v√©rification renforc√©e)
                    const existingTrans = await db.collection('transactions')
                        .where('rdvId', '==', rdv.id)
                        .where('type', '==', 'rdv_honore')
                        .get();
                    
                    if (!existingTrans.empty) {
                        // Transaction d√©j√† cr√©√©e, ne pas en cr√©er une nouvelle
                        console.log('Transaction d√©j√† existante pour RDV:', rdv.id);
                        return;
                    }
                    
                    // Double v√©rification : v√©rifier aussi dans les transactions locales
                    const localExisting = transactions.value.find(t => t.rdvId === rdv.id && t.type === 'rdv_honore');
                    if (localExisting) {
                        console.log('Transaction d√©j√† existante localement pour RDV:', rdv.id);
                        return;
                    }
                    
                    const transactionData = {
                        userId: rdv.createdBy,
                        type: 'rdv_honore',
                        amount: basePrice,
                        label: `RDV honor√© - ${rdv.civilite} ${rdv.nom}${rdv.tag === 'OK M' ? ' (OK M)' : ''}`,
                        date: rdv.date ? new Date(rdv.date) : new Date(),
                        rdvId: rdv.id,
                        agenceId: rdv.agenceId || null,
                        hidden: false,
                        createdAt: new Date()
                    };
                    
                    await db.collection('transactions').add(transactionData);
                    console.log('Transaction cr√©√©e pour RDV:', rdv.id, 'Montant:', basePrice, '‚Ç¨ (m√™me avec ou sans mandat)');
                    
                    // V√©rifier et cr√©er les transactions de bonus si n√©cessaire
                    await checkAndCreateBonusTransactions(rdv.createdBy);
                } catch (err) {
                    console.error('Erreur cr√©ation transaction RDV:', err);
                }
            };

            // Supprimer les transactions associ√©es √† un RDV quand le statut "honor√©" est retir√©
            const deleteTransactionsForRdv = async (rdvId) => {
                try {
                    // R√©cup√©rer toutes les transactions associ√©es √† ce RDV
                    const transactions = await db.collection('transactions')
                        .where('rdvId', '==', rdvId)
                        .get();
                    
                    // Supprimer toutes les transactions trouv√©es
                    const batch = db.batch();
                    transactions.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    
                    if (transactions.docs.length > 0) {
                        await batch.commit();
                        
                        // V√©rifier et recalculer les bonus apr√®s suppression
                        const rdv = rdvList.value.find(r => r.id === rdvId);
                        if (rdv && rdv.createdBy) {
                            await checkAndCreateBonusTransactions(rdv.createdBy);
                        }
                    }
                } catch (err) {
                    console.error('Erreur suppression transactions RDV:', err);
                }
            };

            // V√©rifier et cr√©er les transactions de bonus quand les paliers sont atteints
            const checkAndCreateBonusTransactions = async (userId) => {
                try {
                    const basePrice = parseFloat(globalCommission.base) || 10;
                    const bonusThreshold = parseInt(globalCommission.threshold) || 21;
                    const bonusStep = parseInt(globalCommission.step) || 10;
                    const bonusAmount = parseFloat(globalCommission.amount) || 100;

                    const now = new Date();
                    const currentMonth = now.getMonth();
                    const currentYear = now.getFullYear();

                   // R√©cup√©rer tous les RDV honor√©s du mois en cours (AVEC OU SANS AGENCE)
const honoredRdvs = rdvList.value.filter(r => {
    // MODIFICATION : On a retir√© "!r.agenceId" pour inclure tout le monde
    if(r.statut !== 'honore' || !r.date) return false;
    const d = new Date(r.date);
    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
});

                    const count = honoredRdvs.length;

                    if (count < bonusThreshold) return; // Pas encore de bonus

                    // Calculer le nombre de paliers atteints
                    const tiersReached = Math.floor((count - bonusThreshold) / bonusStep) + 1;

                    // R√©cup√©rer les transactions de bonus existantes pour ce mois
                    const existingBonus = await db.collection('transactions')
                        .where('userId', '==', userId)
                        .where('type', '==', 'bonus')
                        .get();

                    const existingTiers = new Set();
                    existingBonus.docs.forEach(doc => {
                        const data = doc.data();
                        if (data.bonusTier) {
                            existingTiers.add(data.bonusTier);
                        }
                    });

                    // Cr√©er les transactions de bonus manquantes
                    for (let tier = 1; tier <= tiersReached; tier++) {
                        if (existingTiers.has(tier)) continue; // Bonus d√©j√† cr√©√© pour ce palier

                        const transactionData = {
                            userId: userId,
                            type: 'bonus',
                            amount: bonusAmount,
                            label: `Bonus Palier ${tier} - ${count} RDV honor√©s`,
                            date: new Date(),
                            bonusTier: tier,
                            bonusCount: bonusThreshold + (tier - 1) * bonusStep,
                            hidden: false,
                            createdAt: new Date()
                        };

                        await db.collection('transactions').add(transactionData);
                    }
                } catch (err) {
                    console.error('Erreur cr√©ation transactions bonus:', err);
                }
            };

            const currentFullDateLabel = computed(() => new Date().toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }));
            const conversionRate = computed(() => {
                // Utiliser les filtres du dashboard ou le mois/ann√©e actuel par d√©faut
                const selectedMonth = dashboardFilters.mois ? parseInt(dashboardFilters.mois) - 1 : new Date().getMonth();
                const selectedYear = dashboardFilters.annee ? parseInt(dashboardFilters.annee) : new Date().getFullYear();
                const currentMonth = selectedMonth;
                const currentYear = selectedYear;
                
                let filteredRdvs = rdvList.value;
                
                // Filtrer par commercial si s√©lectionn√©
                if (dashboardFilters.commercialId && dashboardFilters.agencyId) {
                    // R√©cup√©rer les RDV du bilan qui ont ce commercial
                    const bilanRdvsWithCommercial = bilanRows.value.filter(b => {
                        const sameAgency = b.clientId === dashboardFilters.agencyId || 
                                          (agences.value.find(a => a.id === dashboardFilters.agencyId)?.nom === b.agence);
                        return sameAgency && b.commercial === dashboardFilters.commercialId;
                    });
                    
                    // Extraire tous les rdvIds
                    const rdvIds = new Set();
                    bilanRdvsWithCommercial.forEach(b => {
                        if (b.rdvId) rdvIds.add(b.rdvId);
                        if (b.rdvIds && Array.isArray(b.rdvIds)) {
                            b.rdvIds.forEach(id => rdvIds.add(id));
                        }
                    });
                    
                    // Filtrer rdvList avec ces IDs
                    if (rdvIds.size > 0) {
                        filteredRdvs = filteredRdvs.filter(r => rdvIds.has(r.id));
                    } else {
                        // Si aucun RDV trouv√© dans le bilan pour ce commercial, retourner 100% si c'est le d√©but du mois
                        const today = new Date();
                        if (today.getDate() === 1 && today.getMonth() === currentMonth && today.getFullYear() === currentYear) {
                            return 100;
                        }
                        return 0;
                    }
                }
                
                // Appliquer les autres filtres
                if (dashboardFilters.agencyId) {
                    filteredRdvs = filteredRdvs.filter(r => r.agenceId === dashboardFilters.agencyId);
                }
                if (dashboardFilters.userId) {
                    filteredRdvs = filteredRdvs.filter(r => r.createdBy === dashboardFilters.userId);
                }
                
                // Filtrer par mois/ann√©e s√©lectionn√©
                const honored = filteredRdvs.filter(r => {
                    if (r.statut !== 'honore' || !r.date) return false;
                    const d = new Date(r.date);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                }).length;
                
                const noshow = filteredRdvs.filter(r => {
                    if (r.statut !== 'pas_venu' || !r.date) return false;
                    const d = new Date(r.date);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                }).length;
                
                const totalFinished = honored + noshow;
                // Si aucun rendez-vous termin√© ce mois : 100% au d√©but du mois, sinon 0
                if (totalFinished === 0) {
                    const today = new Date();
                    // Si c'est le premier du mois et qu'on est dans le mois s√©lectionn√©, retourner 100%
                    if (today.getDate() === 1 && today.getMonth() === currentMonth && today.getFullYear() === currentYear) {
                        return 100;
                    }
                    return 0;
                }
                return Math.round((honored / totalFinished) * 100);
            });
            const conversionRateColor = computed(() => { const rate = conversionRate.value; if (rate < 50) return 'bg-red-50 border-red-200 text-red-700'; if (rate < 80) return 'bg-orange-50 border-orange-200 text-orange-700'; return 'bg-green-50 border-green-200 text-green-700'; });
            // V√©rification de l'√©tat de connexion Google Calendar
            const isGoogleCalendarConnected = computed(() => {
                // Pour l'admin, utiliser le token admin
                if (user.role === 'admin') {
                    return googleCalendarConnected.value && googleAccessToken.value && googleAccessToken.value.trim() !== '';
                }
                // Pour les prospecteurs : si l'admin est connect√©, ils sont automatiquement connect√©s
                // OU si le prospecteur a son propre token valide
                return (googleCalendarConnected.value && googleAccessToken.value && googleAccessToken.value.trim() !== '') ||
                       (prospecteurGoogleCalendarConnected.value && prospecteurGoogleCalendarToken.value && prospecteurGoogleCalendarToken.value.trim() !== '' && !prospecteurGoogleCalendarTokenExpired.value);
            });
            
            // Fonction pour obtenir le token actif (admin ou prospecteur)
            const getActiveGoogleToken = () => {
                // Admin utilise son propre token
                if (user.role === 'admin' && googleCalendarConnected.value && googleAccessToken.value) {
                    return googleAccessToken.value;
                }
                // Prospecteurs : d'abord v√©rifier si l'admin est connect√© (connexion automatique)
                if (user.role !== 'admin' && googleCalendarConnected.value && googleAccessToken.value && googleAccessToken.value.trim() !== '') {
                    return googleAccessToken.value; // Utiliser le token admin automatiquement
                }
                // Sinon, utiliser leur propre token s'ils en ont un
                if (user.role !== 'admin' && prospecteurGoogleCalendarConnected.value && prospecteurGoogleCalendarToken.value && !prospecteurGoogleCalendarTokenExpired.value) {
                    return prospecteurGoogleCalendarToken.value;
                }
                return null;
            };
            
            // Variable computed pour le token actif
            const activeGoogleToken = computed(() => getActiveGoogleToken());
            
            // √âtat r√©el de la validit√© du token (mis √† jour dynamiquement)
            const googleCalendarTokenValid = ref(false);
            const checkingToken = ref(false);
            const tokenExpirationTime = ref(null); // Timestamp d'expiration du token
            const lastTokenValue = ref(null); // Pour d√©tecter si le token a chang√©
            
            // √âtat r√©el de la validit√© du token prospecteur
            const prospecteurGoogleCalendarTokenValid = ref(false);
            const checkingProspecteurToken = ref(false);
            const lastProspecteurTokenValue = ref(null); // Pour d√©tecter si le token a chang√©
            
            // Fonction pour v√©rifier et mettre √† jour l'√©tat r√©el du token (ADMIN)
            const checkAndUpdateTokenStatus = async (manual = false) => {
                // 1. SI C'EST UN CLIC MANUEL : On force l'affichage √† 55min TOUT DE SUITE
                if (manual) {
                    tokenExpirationTime.value = Date.now() + (55 * 60 * 1000);
                    tokenTimerTick.value = Date.now(); // Force le rafra√Æchissement du calcul
                    showNotification('‚úÖ Token actualis√© et compteur r√©initialis√© !', 'success', 'fa-rotate-right');
                }

                if (checkingToken.value) return; 
                checkingToken.value = true;
                
                if (!googleCalendarConnected.value || !googleAccessToken.value) {
                    googleCalendarTokenValid.value = false;
                    tokenExpirationTime.value = null;
                    lastTokenValue.value = null;
                    checkingToken.value = false;
                    return;
                }
                
                try {
                    const isValid = await checkGoogleCalendarTokenValid();
                    const currentToken = googleAccessToken.value;
                    const tokenChanged = currentToken !== lastTokenValue.value;
                    
                    googleCalendarTokenValid.value = isValid;
                    
                    if (isValid) {
                        // Si le token a chang√© ou si on n'a pas de timer, on initialise
                        if (tokenChanged || !tokenExpirationTime.value) {
                            tokenExpirationTime.value = Date.now() + (55 * 60 * 1000);
                            lastTokenValue.value = currentToken;
                        }
                    } else {
                        tokenExpirationTime.value = null;
                        lastTokenValue.value = null;
                    }
                } catch (err) {
                    console.error('Erreur v√©rification token:', err);
                    googleCalendarTokenValid.value = false;
                    tokenExpirationTime.value = null;
                } finally {
                    checkingToken.value = false;
                }
            };
          // Fonction pour forcer un rafra√Æchissement GLOBAL (Admin only)
            const forceGlobalRefresh = () => {
                if (user.role === 'admin' && googleCalendarConnected.value && googleTokenClient) {
                    showNotification('üîÑ Actualisation manuelle du jeton...', 'info', 'fa-rotate');
                    
                    // On enl√®ve le prompt: 'none' pour le mode manuel.
                    // Comme √ßa, si la session est expir√©e, la fen√™tre s'ouvre pour te laisser te reconnecter proprement.
                    // Si la session est bonne, la fen√™tre s'ouvrira et se fermera toute seule instantan√©ment.
                    googleTokenClient.requestAccessToken({ prompt: '' }); 
                } else {
                    showNotification('Erreur : Admin non connect√© √† Google', 'error');
                }
            };
            // Fonction pour v√©rifier et mettre √† jour l'√©tat r√©el du token prospecteur
            const checkAndUpdateProspecteurTokenStatus = async () => {
                if (checkingProspecteurToken.value) return;
                checkingProspecteurToken.value = true;
                
                if (!prospecteurGoogleCalendarConnected.value || !prospecteurGoogleCalendarToken.value) {
                    prospecteurGoogleCalendarTokenValid.value = false;
                    checkingProspecteurToken.value = false;
                    return;
                }
                
                try {
                    // Tester le token en faisant une requ√™te simple √† l'API Google Calendar
                    const response = await fetch('https://www.googleapis.com/calendar/v3/users/me/calendarList?maxResults=1', {
                        headers: {
                            'Authorization': `Bearer ${prospecteurGoogleCalendarToken.value}`
                        }
                    });
                    
                    // Si 401 ou 403, le token est invalide ou expir√©
                    if (response.status === 401 || response.status === 403) {
                        prospecteurGoogleCalendarTokenValid.value = false;
                        prospecteurGoogleCalendarTokenExpired.value = true;
                        prospecteurTokenExpirationTime.value = null;
                    } else {
                        prospecteurGoogleCalendarTokenValid.value = response.ok;
                        if (response.ok) {
                            prospecteurGoogleCalendarTokenExpired.value = false;
                            const currentProspecteurToken = prospecteurGoogleCalendarToken.value;
                            const prospecteurTokenChanged = currentProspecteurToken !== lastProspecteurTokenValue.value;
                            
                            // Ne r√©initialiser le timer que si le token a chang√© ou si on n'a pas encore de timestamp
                            if (prospecteurTokenChanged || !prospecteurTokenExpirationTime.value) {
                                prospecteurTokenExpirationTime.value = Date.now() + (55 * 60 * 1000);
                                lastProspecteurTokenValue.value = currentProspecteurToken;
                            }
                        }
                    }
                } catch (err) {
                    console.error('Erreur v√©rification token prospecteur:', err);
                    prospecteurGoogleCalendarTokenValid.value = false;
                    prospecteurGoogleCalendarTokenExpired.value = true;
                    prospecteurTokenExpirationTime.value = null;
                } finally {
                    checkingProspecteurToken.value = false;
                }
            };
            
            // Variable r√©active pour forcer la mise √† jour du compteur en temps r√©el
            const tokenTimerTick = ref(Date.now());
            // 1. AJOUTER CETTE FONCTION DANS LE SETUP
const reportStatus = async (force = false) => {
    if (!user.logged || user.role === 'admin') return;

    // On envoie l'√©tat toutes les 10 secondes (pour ne pas surcharger) ou si le statut change
    const now = Date.now();
    if (!force && window.lastReportTime && (now - window.lastReportTime < 10000)) return;
    window.lastReportTime = now;

    try {
        await db.collection('users').doc(user.id).update({
            googleStatus: prospecteurGoogleCalendarConnected.value ? 'connected' : 'disconnected',
            googleTokenExpires: prospecteurTokenExpirationTime.value || null,
            lastSeen: new Date().toISOString()
        });
    } catch (e) { console.log("Erreur rapport statut", e); }
};

// Watcher pour mettre √† jour le statut imm√©diatement quand la connexion change
watch(prospecteurGoogleCalendarConnected, (newVal) => {
    if (user.logged && user.role !== 'admin') {
        reportStatus(true); // Force la mise √† jour imm√©diate
    }
});

// 2. CHERCHE TON INTERVALLE EXISTANT (celui du timer) ET AJOUTE L'APPEL
setInterval(() => {
    // ... ton code existant pour le timer ...
    if (prospecteurTokenExpirationTime.value && prospecteurGoogleCalendarTokenValid.value) {
        prospecteurTokenTimerTick.value = Date.now();
    }
    
    // üëá AJOUTE CETTE LIGNE ICI üëá
    reportStatus(); 
    
}, 1000);
            
            // Mettre √† jour le temps toutes les secondes pour que le compteur diminue en temps r√©el
            setInterval(() => {
                if (tokenExpirationTime.value && googleCalendarTokenValid.value) {
                    // Forcer la mise √† jour en cr√©ant une nouvelle valeur
                    tokenTimerTick.value = Date.now();
                }
                // Mettre √† jour aussi pour les prospecteurs
                if (prospecteurTokenExpirationTime.value && prospecteurGoogleCalendarTokenValid.value) {
                    // Forcer la mise √† jour en cr√©ant une nouvelle valeur
                    prospecteurTokenTimerTick.value = Date.now();
                }
            }, 1000);
            
            // Mettre √† jour aussi toutes les 100ms pour un affichage plus fluide des secondes
            setInterval(() => {
                if (tokenExpirationTime.value && googleCalendarTokenValid.value) {
                    tokenTimerTick.value = Date.now();
                }
                if (prospecteurTokenExpirationTime.value && prospecteurGoogleCalendarTokenValid.value) {
                    prospecteurTokenTimerTick.value = Date.now();
                }
            }, 100);
            
            // Calcul du temps restant avant expiration (mis √† jour en temps r√©el)
            const tokenTimeRemaining = computed(() => {
                if (!tokenExpirationTime.value || !googleCalendarTokenValid.value) {
                    return null;
                }
                const remaining = tokenExpirationTime.value - tokenTimerTick.value;
                if (remaining <= 0) {
                    // Si le temps est √©coul√©, v√©rifier √† nouveau le token
                    setTimeout(() => {
                        checkAndUpdateTokenStatus();
                    }, 1000);
                    return null;
                }
                
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);
                return { minutes, seconds };
            });
            
            // Charger les messages de report quand on ouvre l'onglet Motifs
            watch(() => settingsModal.tab, (newTab) => {
                if (newTab === 'Motifs' && user.role === 'admin') {
                    loadRescheduleSMSMessages();
                }
            });
            
            // V√©rifier le token quand on ouvre les param√®tres Google Calendar
            watch(() => settingsModal.tab, (newTab) => {
                if (newTab === 'GoogleCalendar' && user.role === 'admin') {
                    checkAndUpdateTokenStatus();
                }
                if (newTab === 'Logs' && user.role === 'admin') {
                    loadDetailedLogs();
                }
                if (newTab === 'Dashboard' && user.role === 'admin') {
                    calculatePerformanceStats();
                    calculateWorkloadPrediction();
                }
                if (newTab === 'Fermetures' && user.role === 'admin') {
                    loadFermetures();
                }
            });
            
            const conversionEmoji = computed(() => { const rate = conversionRate.value; if (rate < 50) return 'üò≠'; if (rate < 80) return 'ü§®'; return 'ü§©'; });

           const login = () => { 
                // Code secret Admin (inchang√©)
                if(loginEmail.value === 'contact@cetn-solutions.fr' && loginPass.value === '130724') {
                    loginAdminSelection.value = true;
                    return;
                }

                // V√©rifier si teamList est charg√©
                if (!teamList.value || teamList.value.length === 0) {
                    loginErrorModal.message = 'Chargement en cours, veuillez r√©essayer dans quelques instants.';
                    loginErrorModal.show = true;
                    return;
                }

                const match = teamList.value.find(u => u.email === loginEmail.value && u.password === loginPass.value);
                
                if(match) {
                    if(match.blocked) { 
                        blockedLoginMessage.show = true;
                        return; 
                    }
                    
                    // 1. On connecte l'utilisateur
                    setUserSession('prospecteur', match.name, match.email, match.id);
                    
                    // 2. On affiche le message de bienvenue
                    checkAndShowWelcome(match.email, match.name);

                    // --- AJOUT MAGIQUE ICI ---
                    // 3. On force la v√©rification Google TOUT DE SUITE
                    setTimeout(() => {
                        // Si c'est un prospecteur, on v√©rifie son token ou le token partag√©
                        checkAndUpdateProspecteurTokenStatus();
                        // On force aussi la mise √† jour visuelle du timer
                        if (prospecteurTokenExpirationTime.value) {
                             prospecteurTokenTimerTick.value = Date.now();
                        }
                    }, 500); // Petit d√©lai de 500ms pour √™tre s√ªr que la vue est charg√©e
                    
                    // 4. D√©marrer le listener pour v√©rifier le statut en temps r√©el
                    if (user.id) {
                        if (userStatusListener) userStatusListener(); // Nettoyer l'ancien listener si existe
                        let previousBlockedState = match.blocked; // Stocker l'√©tat initial
                        userStatusListener = db.collection('users').doc(user.id).onSnapshot(doc => {
                            if (!doc.exists) {
                                // Le profil a √©t√© supprim√©
                                forcedLogoutModal.type = 'deleted';
                                forcedLogoutModal.open = true;
                                return;
                            }
                            const data = doc.data();
                            if (data) {
                                const isBlocked = data.blocked === true;
                                // Ne d√©connecter que si on passe de non-bloqu√© √† bloqu√©
                                if (isBlocked && !previousBlockedState) {
                                    forcedLogoutModal.type = 'blocked';
                                    forcedLogoutModal.open = true;
                                }
                                previousBlockedState = isBlocked; // Mettre √† jour l'√©tat pr√©c√©dent
                            }
                        });
                    }
                } else {
                    loginErrorModal.message = 'Mot de passe ou identifiant incorrect. R√©essayez.';
                    loginErrorModal.show = true;
                }
            };
            const finalizeAdminLogin = (name) => {
                setUserSession('admin', name);
                checkAndShowWelcome(loginEmail.value, name);
                loginAdminSelection.value = false;
                // --- AJOUT MAGIQUE POUR ADMIN ---
                setTimeout(() => {
                    checkAndUpdateTokenStatus();
                     // On force aussi la mise √† jour visuelle du timer
                    if (tokenExpirationTime.value) {
                         tokenTimerTick.value = Date.now();
                    }
                }, 500);
            };
          
            

            const setUserSession = (role, name, email = '', id = '') => {
                user.logged = true; user.role = role; user.name = name; user.email = email; user.id = id;
                localStorage.setItem('crm_user', JSON.stringify({ role, name, email, id }));
                
                // Log de connexion
                logAction('connexion', {
                    utilisateur: name,
                    role: role,
                    email: loginEmail.value,
                    heure: new Date().toLocaleTimeString('fr-FR'),
                    date: new Date().toISOString().split('T')[0]
                });
                
                loadRdvData();
                
                // Initialiser Google Calendar pour les prospecteurs apr√®s connexion
                if (role !== 'admin' && typeof google !== 'undefined' && google.accounts) {
                    setTimeout(() => {
                        initProspecteurGoogleCalendar();
                        // Restaurer la session Google Calendar si elle existe
                        const savedProspecteurToken = localStorage.getItem('prospecteur_google_calendar_token');
                        const savedProspecteurEmail = localStorage.getItem('prospecteur_google_calendar_email');
                        
                        if (savedProspecteurToken && savedProspecteurEmail) {
                            // Tester si le token est encore valide
                            fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                                headers: { 'Authorization': `Bearer ${savedProspecteurToken}` }
                            })
                            .then(async (res) => {
                                if (res.ok) {
                                    // Le token est bon, on r√©tablit la connexion
                                    prospecteurGoogleCalendarToken.value = savedProspecteurToken;
                                    prospecteurGoogleCalendarConnected.value = true;
                                    prospecteurGoogleCalendarTokenValid.value = true;
                                    prospecteurGoogleCalendarTokenExpired.value = false;
                                    console.log("‚úÖ Session Google Agenda prospecteur restaur√©e");
                                    // V√©rifier le token pour confirmer
                                    checkAndUpdateProspecteurTokenStatus();
                                } else {
                                    // Le token est expir√©, on nettoie
                                    console.warn("‚ö†Ô∏è Token Google prospecteur expir√©");
                                    localStorage.removeItem('prospecteur_google_calendar_token');
                                    localStorage.removeItem('prospecteur_google_calendar_email');
                                    localStorage.removeItem('prospecteur_google_calendar_token_date');
                                    prospecteurGoogleCalendarConnected.value = false;
                                    prospecteurGoogleCalendarTokenValid.value = false;
                                }
                            })
                            .catch(() => {
                                prospecteurGoogleCalendarConnected.value = false;
                                prospecteurGoogleCalendarTokenValid.value = false;
                            });
                        }
                    }, 500);
                }
            };

            const logout = () => { 
                // Log de d√©connexion
                if(user.logged && user.name) {
                    logAction('deconnexion', {
                        utilisateur: user.name,
                        role: user.role,
                        heure: new Date().toLocaleTimeString('fr-FR'),
                        date: new Date().toISOString().split('T')[0]
                    });
                }
                
                // Arr√™ter le listener de statut
                if (userStatusListener) {
                    userStatusListener();
                    userStatusListener = null;
                }
                
                user.logged=false; user.email=''; user.id=''; loginPass.value=''; loginEmail.value=''; rdvList.value = [];
                checksDone.value = false; 
                localStorage.removeItem('crm_user'); 
                if(rdvListener) rdvListener();
                if(transactionListener) {
                    transactionListener();
                    transactionListener = null;
                }
                if(adminTransactionListener) {
                    adminTransactionListener();
                    adminTransactionListener = null;
                }
            };

            const addTeamMember = async () => { if(!newMember.name || !newMember.email || !newMember.password) return; await db.collection('users').add({ ...newMember, role: 'prospecteur', blocked: false, created: new Date() }); newMember.name = ''; newMember.email = ''; newMember.password = ''; newMember.assignedAgencies = []; };
            const toggleBlockTeamMember = async (member) => { 
                const wasBlocked = member.blocked;
                const willBeBlocked = !member.blocked;
                await db.collection('users').doc(member.id).update({ blocked: willBeBlocked });
                // Si on BLOQUE l'utilisateur (pas d√©bloque) ET qu'il est actuellement connect√©, le d√©connecter
                if (willBeBlocked && !wasBlocked && user.logged && user.email === member.email) {
                    forcedLogoutModal.type = 'blocked';
                    forcedLogoutModal.open = true;
                }
            };
            const deleteTeamMember = async (member) => { 
                openCustomConfirm("Supprimer un membre", "Voulez-vous vraiment supprimer l'acc√®s de " + member.name + " ?", async () => {
                    customConfirmModal.open = false;
                    // Si l'utilisateur est actuellement connect√©, le d√©connecter AVANT de supprimer
                    if (user.logged && user.email === member.email) {
                        // Ouvrir la modal de d√©connexion
                        forcedLogoutModal.type = 'deleted';
                        forcedLogoutModal.open = true;
                        // Supprimer le document apr√®s un court d√©lai pour que la modal s'affiche
                        setTimeout(async () => {
                            await db.collection('users').doc(member.id).delete();
                        }, 200);
                    } else {
                        // Si l'utilisateur n'est pas connect√©, supprimer directement
                        await db.collection('users').doc(member.id).delete();
                    }
                });
            };
            
            const openTeamEdit = (member) => {
                teamEditModal.member = member;
                teamEditModal.name = member.name;
                teamEditModal.email = member.email;
                teamEditModal.password = ''; 
                teamEditModal.assignedAgencies = member.assignedAgencies || [];
                teamEditModal.open = true;
            };

            const saveTeamMemberEdit = async () => {
                if (!teamEditModal.member) return;
                const updateData = { 
                    name: teamEditModal.name, 
                    email: teamEditModal.email, 
                    assignedAgencies: teamEditModal.assignedAgencies
                };
                if(teamEditModal.password && teamEditModal.password.trim() !== '') { updateData.password = teamEditModal.password; }
                await db.collection('users').doc(teamEditModal.member.id).update(updateData);
                teamEditModal.open = false;
            };

            const openPasswordEdit = (member) => {
                passwordEditModal.member = member;
                passwordEditModal.password = '';
                passwordEditModal.open = true;
            };

            const savePasswordEdit = async () => {
                if (!passwordEditModal.member || !passwordEditModal.password || passwordEditModal.password.trim() === '') {
                    return;
                }
                await db.collection('users').doc(passwordEditModal.member.id).update({ password: passwordEditModal.password });
                passwordEditModal.open = false;
                passwordEditModal.password = '';
                showNotification('Mot de passe modifi√© avec succ√®s', 'success');
            };

            const addAdminName = async () => { if(!newAdminName.value) return; const updated = [...adminNamesList.value, newAdminName.value]; await db.collection('settings').doc('global').set({adminNames: updated}, {merge:true}); newAdminName.value = ''; };
            const removeAdminName = async (name) => { const updated = adminNamesList.value.filter(n => n !== name); await db.collection('settings').doc('global').set({adminNames: updated}, {merge:true}); };

            const addNote = async () => {
                if(!newNoteText.value.trim() || !clientModal.rdv) return;
                const noteObj = { text: newNoteText.value, author: user.name, date: new Date().toISOString() };
                if(!clientModal.rdv.notes) clientModal.rdv.notes = [];
                clientModal.rdv.notes.push(noteObj);
                await db.collection('rendezvous').doc(clientModal.rdv.id).update({ notes: clientModal.rdv.notes });
                newNoteText.value = '';
            };
            const deleteNote = async (rdv, index) => {
                openCustomConfirm("Supprimer la note", "Voulez-vous supprimer cette note ?", async () => {
                    rdv.notes.splice(index, 1);
                    await db.collection('rendezvous').doc(rdv.id).update({ notes: rdv.notes });
                    customConfirmModal.open = false;
                });
            };
            
            const editMainNote = async (rdv) => {
                editNoteModal.rdv = rdv;
                editNoteModal.note = rdv.note || '';
                editNoteModal.open = true;
            };
            
            const saveNoteEdit = async () => {
                if (!editNoteModal.rdv) return;
                const newNote = editNoteModal.note.trim();
                if (newNote !== (editNoteModal.rdv.note || '')) {
                    await db.collection('rendezvous').doc(editNoteModal.rdv.id).update({ note: newNote });
                    editNoteModal.rdv.note = newNote;
                    showNotification('Note modifi√©e avec succ√®s', 'success');
                }
                editNoteModal.open = false;
                editNoteModal.rdv = null;
                editNoteModal.note = '';
            };
            
            const deleteMainNote = async (rdv) => {
                openCustomConfirm("Supprimer la note", "Voulez-vous supprimer cette note ?", async () => {
                    await db.collection('rendezvous').doc(rdv.id).update({ note: '' });
                    rdv.note = '';
                    customConfirmModal.open = false;
                    showNotification('Note supprim√©e avec succ√®s', 'success');
                });
            };

            const formatName = (name) => {
                if (!name) return '';
                // Nettoyer les espaces multiples et mettre une majuscule apr√®s chaque espace
                return name.trim().split(/\s+/).map(word => {
                    if (word.length === 0) return word;
                    return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
                }).join(' ');
            };
            const formatNameRealTime = (e) => {
                const input = e.target;
                const cursorPos = input.selectionStart;
                let value = input.value;
                
                // Formater : premi√®re lettre en majuscule, et apr√®s chaque espace
                let formatted = value;
                
                // Premi√®re lettre en majuscule
                if (formatted.length > 0 && /^[a-z]/.test(formatted)) {
                    formatted = formatted.charAt(0).toUpperCase() + formatted.slice(1);
                }
                
                // Mettre en majuscule la lettre apr√®s chaque espace
                formatted = formatted.replace(/(\s+)([a-z])/g, (match, spaces, letter) => {
                    return spaces + letter.toUpperCase();
                });
                
                // Si la valeur a chang√©, mettre √† jour
                if (formatted !== value) {
                    const oldLength = value.length;
                    const newLength = formatted.length;
                    const lengthDiff = newLength - oldLength;
                    
                    // Calculer la nouvelle position du curseur
                    let newCursorPos = cursorPos;
                    if (lengthDiff !== 0) {
                        // Si on est juste apr√®s un espace et qu'on a transform√© la lettre suivante
                        if (cursorPos > 0 && cursorPos <= oldLength && value[cursorPos - 1] === ' ') {
                            newCursorPos = cursorPos;
                        } else if (cursorPos === oldLength) {
                            newCursorPos = newLength;
                        }
                    }
                    
                    input.value = formatted;
                    // Utiliser nextTick pour s'assurer que Vue a mis √† jour le DOM
                    setTimeout(() => {
                        input.setSelectionRange(newCursorPos, newCursorPos);
                    }, 0);
                    form.nom = formatted;
                } else {
                    form.nom = value;
                }
            };
            const formatNameRealTimeEdit = (e) => {
                const input = e.target;
                const cursorPos = input.selectionStart;
                let value = input.value;
                
                // Formater : premi√®re lettre en majuscule, et apr√®s chaque espace
                let formatted = value;
                
                // Premi√®re lettre en majuscule
                if (formatted.length > 0 && /^[a-z]/.test(formatted)) {
                    formatted = formatted.charAt(0).toUpperCase() + formatted.slice(1);
                }
                
                // Mettre en majuscule la lettre apr√®s chaque espace
                formatted = formatted.replace(/(\s+)([a-z])/g, (match, spaces, letter) => {
                    return spaces + letter.toUpperCase();
                });
                
                // Si la valeur a chang√©, mettre √† jour
                if (formatted !== value) {
                    const oldLength = value.length;
                    const newLength = formatted.length;
                    const lengthDiff = newLength - oldLength;
                    
                    // Calculer la nouvelle position du curseur
                    let newCursorPos = cursorPos;
                    if (lengthDiff !== 0) {
                        // Si on est juste apr√®s un espace et qu'on a transform√© la lettre suivante
                        if (cursorPos > 0 && cursorPos <= oldLength && value[cursorPos - 1] === ' ') {
                            newCursorPos = cursorPos;
                        } else if (cursorPos === oldLength) {
                            newCursorPos = newLength;
                        }
                    }
                    
                    input.value = formatted;
                    // Utiliser nextTick pour s'assurer que Vue a mis √† jour le DOM
                    setTimeout(() => {
                        input.setSelectionRange(newCursorPos, newCursorPos);
                    }, 0);
                    editModal.form.nom = formatted;
                } else {
                    editModal.form.nom = value;
                }
            };
            const onWizardNameBlur = (e) => {
                form.nom = formatName(e.target.value);
            };
            const onWizardNamePaste = (e) => {
                // Attendre que le collage soit termin√© avant de formater
                setTimeout(() => {
                    form.nom = formatName(form.nom);
                }, 10);
            };
            const onEditModalNameBlur = (e) => {
                editModal.form.nom = formatName(e.target.value);
            };
            const onEditModalNamePaste = (e) => {
                // Attendre que le collage soit termin√© avant de formater
                setTimeout(() => {
                    editModal.form.nom = formatName(editModal.form.nom);
                }, 10);
            };
            const onWizardPhoneInput = (e) => { const digits = normalizePhone(e.target.value).slice(0, 10); form.telephone = formatPhone(digits); if (digits.length === 10) { const exist = rdvList.value.find(r => normalizePhone(r.telephone) === digits); if (exist) { form.nom = exist.nom; form.civilite = exist.civilite; form.modele = exist.modele; clientExists.value = true; } else { clientExists.value = false; } } else { clientExists.value = false; } };
            const onModalPhoneInput = (e) => { const digits = normalizePhone(e.target.value).slice(0, 10); if (!clientModal.rdv) return; clientModal.rdv.telephone = formatPhone(digits); };
            
            // Variable pour le chargement du lien annonce
            const loadingLienAnnonce = ref(false);
            const intelligentPaste = ref('');
            
            // Fonction pour extraire automatiquement le mod√®le, le prix et les caract√©ristiques depuis le texte coll√© (Le Bon Coin et Facebook)
            const handleIntelligentPaste = () => {
                if (!intelligentPaste.value || !intelligentPaste.value.trim()) {
                    return;
                }
                
                const text = intelligentPaste.value.trim();
                const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);
                const isFacebook = form.source === 'Facebook';
                
                // 0. EXTRAIRE LE LIEN (chercher une URL Le Bon Coin ou Facebook dans le texte)
                if (!isFacebook) {
                    const urlPattern = /https?:\/\/(www\.)?(leboncoin\.fr|leboncoin\.com)\/[^\s\)]+/gi;
                    const urlMatch = text.match(urlPattern);
                    if (urlMatch && urlMatch.length > 0) {
                        const lien = urlMatch[0].trim();
                        form.lienAnnonce = lien;
                        console.log('‚úÖ Lien extrait:', lien);
                    }
                } else {
                    const fbUrlPattern = /https?:\/\/(www\.)?(facebook\.com|fb\.com|m\.facebook\.com)\/[^\s\)]+/gi;
                    const fbUrlMatch = text.match(fbUrlPattern);
                    if (fbUrlMatch && fbUrlMatch.length > 0) {
                        const lien = fbUrlMatch[0].trim();
                        form.lienAnnonce = lien;
                        console.log('‚úÖ Lien Facebook extrait:', lien);
                    }
                }
                
                // 1. EXTRAIRE LE MOD√àLE (premi√®re ligne non vide qui ne contient pas de prix)
                let modele = '';
                for (const line of lines) {
                    // Ignorer les lignes qui contiennent uniquement un prix (ex: "26 990 ‚Ç¨")
                    const isPriceOnly = /^\s*(\d[\d\s]*)\s*‚Ç¨\s*$/.test(line);
                    // Ignorer les lignes avec "ou d√®s" (ex: "ou d√®s 438 ‚Ç¨ / mois")
                    const isMonthlyPayment = /ou\s+d√®s/i.test(line);
                    // Ignorer les lignes avec des dates (ex: "1 janvier 2026")
                    const isDate = /\d{1,2}\s+(janvier|f√©vrier|mars|avril|mai|juin|juillet|ao√ªt|septembre|octobre|novembre|d√©cembre)/i.test(line);
                    // Ignorer les lignes Facebook comme "Publi√© il y a un jour" ou "√Ä propos de ce v√©hicule"
                    const isFacebookMeta = isFacebook && /publi√©|√† propos|ce v√©hicule|dans\s+\w+/i.test(line);
                    
                    if (!isPriceOnly && !isMonthlyPayment && !isDate && !isFacebookMeta) {
                        // Nettoyer le mod√®le (enlever les caract√®res sp√©ciaux en fin si n√©cessaire)
                        modele = line.replace(/\s*¬∑\s*$/, '').trim();
                        if (modele && modele.length > 2) { // Au moins 3 caract√®res
                            form.modele = modele.toUpperCase();
                            console.log('‚úÖ Mod√®le extrait:', form.modele);
                            break;
                        }
                    }
                }
                
                // 2. EXTRAIRE LE PRIX (chercher un nombre suivi de ‚Ç¨, mais pas "ou d√®s X ‚Ç¨ / mois")
                let prix = null;
                
                // Pour Facebook et Le Bon Coin : chercher ligne par ligne d'abord (plus pr√©cis)
                // On cherche une ligne qui contient UN PRIX suivi de ‚Ç¨ (pas un m√©lange avec une ann√©e)
                for (const line of lines) {
                    // Ignorer les lignes avec "ou d√®s" ou "/ mois"
                    if (/ou\s+d√®s|\/\s*mois/i.test(line)) {
                        continue;
                    }
                    
                    // Chercher une ligne qui contient principalement un prix (ligne de prix seule ou avec peu de texte)
                    // Pattern plus strict : ligne qui commence par un prix ou contient un prix suivi directement de ‚Ç¨
                    const prixPatternStrict = /^[\s]*(\d[\d\s]*)\s*‚Ç¨[\s]*$/; // Ligne avec seulement le prix et ‚Ç¨
                    const prixPatternLoose = /(\d[\d\s]*)\s*‚Ç¨/; // Ligne avec du texte et un prix avec ‚Ç¨
                    
                    let match = line.match(prixPatternStrict);
                    if (!match) {
                        // Si pas de ligne avec prix seul, chercher dans les lignes avec texte
                        // Mais s'assurer que c'est bien un prix (pas une ann√©e ou autre)
                        match = line.match(prixPatternLoose);
                        // V√©rifier que ce n'est pas juste une ann√©e (ex: "2007" suivi de texte)
                        if (match) {
                            const prixText = match[1].replace(/\s/g, '');
                            const prixNum = parseFloat(prixText);
                            // Ignorer si c'est un nombre de 4 chiffres qui ressemble √† une ann√©e (1900-2099)
                            // et que la ligne contient beaucoup de texte (probablement une ann√©e dans un titre)
                            if (prixNum >= 1900 && prixNum <= 2099 && line.trim().length > 10) {
                                // Probablement une ann√©e, pas un prix
                                continue;
                            }
                        }
                    }
                    
                    if (match) {
                        const prixText = match[1].replace(/\s/g, ''); // Enlever les espaces
                        const prixNum = parseFloat(prixText);
                        // V√©rifier que c'est un prix raisonnable (entre 1 et 10 millions)
                        if (prixNum && prixNum >= 1 && prixNum < 10000000) {
                            prix = prixNum;
                            console.log('‚úÖ Prix extrait depuis ligne:', prix, 'depuis:', line);
                            break;
                        }
                    }
                }
                
                // Si pas trouv√© ligne par ligne, chercher dans tout le texte (fallback)
                if (!prix) {
                    const prixPatterns = [
                        /(\d[\d\s]*)\s*‚Ç¨(?!\s*\/\s*mois)/g,  // "26 990 ‚Ç¨" mais pas "438 ‚Ç¨ / mois"
                        /(\d[\d\s]*)\s*euros?(?!\s*\/\s*mois)/gi,  // "26990 euros"
                    ];
                    
                    for (const pattern of prixPatterns) {
                        const matches = Array.from(text.matchAll(pattern));
                        // Prendre le plus grand nombre raisonnable (le prix principal, pas les mensualit√©s)
                        // Mais exclure les nombres de 4 chiffres qui ressemblent √† des ann√©es
                        let maxPrix = 0;
                        for (const match of matches) {
                            const prixText = match[1].replace(/\s/g, ''); // Enlever les espaces
                            const prixNum = parseFloat(prixText);
                            // Ignorer les ann√©es (1900-2099) et prendre seulement les prix raisonnables
                            if (prixNum && prixNum >= 1 && prixNum < 10000000 && !(prixNum >= 1900 && prixNum <= 2099 && prixNum < 10000)) {
                                if (prixNum > maxPrix) {
                                    maxPrix = prixNum;
                                }
                            }
                        }
                        if (maxPrix > 0) {
                            prix = maxPrix;
                            console.log('‚úÖ Prix extrait (fallback):', prix);
                            break;
                        }
                    }
                }
                
                // Mettre √† jour le prix si trouv√©
                if (prix) {
                    form.prix = prix;
                    // Formater le prix dans le champ en utilisant formatPrixInput
                    setTimeout(() => {
                        const prixInput = document.querySelector('input[placeholder*="Prix du v√©hicule"]');
                        if (prixInput) {
                            // Mettre la valeur brute (sans formatage) et laisser formatPrixInput faire le travail
                            prixInput.value = prix.toString().replace(/\s/g, ''); // Enlever les espaces existants
                            // D√©clencher l'√©v√©nement input pour formater correctement
                            const inputEvent = new Event('input', { bubbles: true });
                            prixInput.dispatchEvent(inputEvent);
                        }
                    }, 100);
                }
                
                // 3. POUR FACEBOOK : EXTRAIRE LES CARACT√âRISTIQUES
                if (isFacebook) {
                    // Trouver o√π commencent les caract√©ristiques (apr√®s "√Ä propos de ce v√©hicule" ou apr√®s le prix)
                    let caracteristiquesStart = -1;
                    for (let i = 0; i < lines.length; i++) {
                        if (/√† propos|ce v√©hicule/i.test(lines[i])) {
                            caracteristiquesStart = i + 1;
                            break;
                        }
                    }
                    
                    // Si pas trouv√©, chercher apr√®s le prix
                    if (caracteristiquesStart === -1) {
                        for (let i = 0; i < lines.length; i++) {
                            if (/\d[\d\s]*\s*‚Ç¨/.test(lines[i])) {
                                caracteristiquesStart = i + 1;
                                break;
                            }
                        }
                    }
                    
                    // Si toujours pas trouv√©, prendre √† partir de la ligne apr√®s le mod√®le
                    if (caracteristiquesStart === -1) {
                        caracteristiquesStart = 1;
                    }
                    
                    // Extraire les caract√©ristiques (toutes les lignes apr√®s le d√©but)
                    const caracteristiques = lines.slice(caracteristiquesStart)
                        .filter(l => {
                            // Filtrer les lignes qui ne sont pas des caract√©ristiques
                            return !/publi√©|facebook|‚Ç¨|lien|http/i.test(l) && l.length > 3;
                        })
                        .join('\n');
                    
                    if (caracteristiques && caracteristiques.trim().length > 0) {
                        form.facebookCaracteristiques = caracteristiques.trim();
                        // Formater les caract√©ristiques comme avant
                        parseAndFormatFacebookCaracteristiques();
                        console.log('‚úÖ Caract√©ristiques Facebook extraites:', caracteristiques);
                    }
                }
                
                // D√©finir automatiquement la source si pas d√©j√† d√©fini
                if (!form.source || form.source === '') {
                    if (text.toLowerCase().includes('facebook') || text.toLowerCase().includes('publi√©')) {
                        form.source = 'Facebook';
                    } else {
                        form.source = 'Leboncoin';
                    }
                }
                
                // Afficher une notification
                const extracted = [];
                if (form.lienAnnonce) extracted.push('lien');
                if (form.modele) extracted.push('mod√®le');
                if (prix) extracted.push('prix');
                if (isFacebook && form.facebookCaracteristiques) extracted.push('caract√©ristiques');
                
                if (extracted.length >= 3) {
                    showNotification(`‚úÖ ${extracted.join(', ')} extraits automatiquement !`, 'success', 'fa-check-circle');
                } else if (extracted.length === 2) {
                    showNotification(`‚úÖ ${extracted.join(' et ')} extraits automatiquement !`, 'success', 'fa-check-circle');
                } else if (extracted.length === 1) {
                    showNotification(`‚úÖ ${extracted[0]} extrait !`, 'info', 'fa-info-circle');
                } else {
                    showNotification('‚ö†Ô∏è Impossible d\'extraire les informations. V√©rifiez le format du texte.', 'warning', 'fa-exclamation-triangle');
                }
                
                // Vider le champ intelligent apr√®s extraction
                setTimeout(() => {
                    intelligentPaste.value = '';
                }, 2000);
            };
            
            // Obtenir l'heure de fermeture de l'agence pour une date donn√©e
            const getHeureFermetureAgence = (agence, date) => {
                if (!agence) return null;
                
                let heureFermeture = null;
                
                if (date) {
                    const d = new Date(date);
                    const dayOfWeek = d.getDay();
                    
                    if (agence.horairesIdentiques) {
                        heureFermeture = agence.heureFermeture || null;
                    } else {
                        heureFermeture = agence[`horaires_${dayOfWeek}_fermeture`] || null;
                    }
                } else {
                    heureFermeture = agence.heureFermeture || null;
                }
                
                return heureFermeture;
            };
            
            // V√©rifier si une heure touche l'heure de fermeture (dans les 30 minutes avant)
            const isHeureProcheFermeture = (heure, agence, date) => {
                if (!heure || !agence) return false;
                
                const heureFermeture = getHeureFermetureAgence(agence, date);
                if (!heureFermeture) return false;
                
                // Convertir les heures en minutes
                const parseTime = (timeStr) => {
                    const [hours, minutes] = timeStr.split(':').map(Number);
                    return hours * 60 + minutes;
                };
                
                const heureMinutes = parseTime(heure);
                const fermetureMinutes = parseTime(heureFermeture);
                
                // Si l'heure est dans les 30 minutes avant la fermeture
                return heureMinutes >= fermetureMinutes - 30 && heureMinutes < fermetureMinutes;
            };
            
            // V√©rifier si une heure est apr√®s l'heure de fermeture
            const isHeureApresFermeture = (heure, agence, date) => {
                if (!heure || !agence) return false;
                
                const heureFermeture = getHeureFermetureAgence(agence, date);
                if (!heureFermeture) return false;
                
                // Convertir les heures en minutes
                const parseTime = (timeStr) => {
                    const [hours, minutes] = timeStr.split(':').map(Number);
                    return hours * 60 + minutes;
                };
                
                const heureMinutes = parseTime(heure);
                const fermetureMinutes = parseTime(heureFermeture);
                
                // Si l'heure est apr√®s la fermeture
                return heureMinutes >= fermetureMinutes;
            };
            
            // V√©rifier si une heure est dans les heures d'ouverture
            const isHeureValide = (heure, agence, date) => {
                if (!heure || !agence) return true; // Si pas d'agence, on accepte toutes les heures
                
                let heureOuverture = null;
                let heureFermeture = null;
                let heurePauseDebut = null;
                let heurePauseFin = null;
                
                if (date) {
                    const d = new Date(date);
                    const dayOfWeek = d.getDay();
                    
                    if (agence.horairesIdentiques) {
                        heureOuverture = agence.heureOuverture || null;
                        heureFermeture = agence.heureFermeture || null;
                        heurePauseDebut = agence.heurePauseDebut || null;
                        heurePauseFin = agence.heurePauseFin || null;
                    } else {
                        heureOuverture = agence[`horaires_${dayOfWeek}_ouverture`] || null;
                        heureFermeture = agence[`horaires_${dayOfWeek}_fermeture`] || null;
                        heurePauseDebut = agence[`horaires_${dayOfWeek}_pauseDebut`] || null;
                        heurePauseFin = agence[`horaires_${dayOfWeek}_pauseFin`] || null;
                    }
                } else {
                    heureOuverture = agence.heureOuverture || null;
                    heureFermeture = agence.heureFermeture || null;
                    heurePauseDebut = agence.heurePauseDebut || null;
                    heurePauseFin = agence.heurePauseFin || null;
                }
                
                if (!heureOuverture || !heureFermeture) return true; // Si pas d'horaires, on accepte
                
                const parseTime = (timeStr) => {
                    const [hours, minutes] = timeStr.split(':').map(Number);
                    return hours * 60 + minutes;
                };
                
                const heureMinutes = parseTime(heure);
                const ouvertureMinutes = parseTime(heureOuverture);
                const fermetureMinutes = parseTime(heureFermeture);
                
                // V√©rifier si l'heure est dans les heures d'ouverture
                if (heureMinutes < ouvertureMinutes || heureMinutes >= fermetureMinutes) {
                    return false;
                }
                
                // V√©rifier si l'heure est dans la pause
                if (heurePauseDebut && heurePauseFin) {
                    const pauseDebutMinutes = parseTime(heurePauseDebut);
                    const pauseFinMinutes = parseTime(heurePauseFin);
                    if (heureMinutes >= pauseDebutMinutes && heureMinutes < pauseFinMinutes) {
                        return false;
                    }
                }
                
                return true;
            };
            
            // Confirmer l'heure proche de la fermeture
            const confirmHeureFermeture = () => {
                if (heureFermetureConfirmModal.onConfirm) {
                    heureFermetureConfirmModal.onConfirm();
                }
                heureFermetureConfirmModal.open = false;
                heureFermetureConfirmModal.heure = '';
                heureFermetureConfirmModal.heureFermeture = '';
                heureFermetureConfirmModal.onConfirm = null;
            };
            
            // V√©rifier si l'heure d√©passe l'heure limite exceptionnelle
            const isHeureApresLimiteExceptionnelle = (heure, agence, date) => {
                if (!heure || !agence || !agence.heureLimiteExceptionnelle) return false;
                
                const parseTime = (timeStr) => {
                    const [hours, minutes] = timeStr.split(':').map(Number);
                    return hours * 60 + minutes;
                };
                
                // Obtenir l'heure de fermeture du jour
                const heureFermeture = getHeureFermetureAgence(agence, date);
                if (!heureFermeture) return false;
                
                const heureMinutes = parseTime(heure);
                const limiteMinutes = parseTime(agence.heureLimiteExceptionnelle);
                const fermetureMinutes = parseTime(heureFermeture);
                
                // L'heure limite exceptionnelle ne s'applique que si elle est AVANT l'heure de fermeture du jour
                // Si l'agence ferme naturellement plus t√¥t (ex: 13h), l'heure limite exceptionnelle ne s'applique pas
                if (limiteMinutes >= fermetureMinutes) {
                    return false; // L'heure limite n'est pas pertinente pour ce jour
                }
                
                // Utiliser > au lieu de >= pour que l'heure limite elle-m√™me soit encore autoris√©e
                return heureMinutes > limiteMinutes;
            };
            
            // Confirmer l'heure apr√®s la fermeture
            const confirmHeureApresFermeture = () => {
                if (heureApresFermetureModal.onConfirm) {
                    heureApresFermetureModal.onConfirm();
                }
                heureApresFermetureModal.open = false;
                heureApresFermetureModal.heure = '';
                heureApresFermetureModal.heureFermeture = '';
                heureApresFermetureModal.onConfirm = null;
            };
            
            // Fonction pour v√©rifier et demander confirmation si l'heure touche la fermeture
            const checkHeureFermetureAndConfirm = (callback) => {
                // D'abord v√©rifier l'heure limite exceptionnelle (avec la date pour v√©rifier si elle s'applique ce jour)
                if (isHeureApresLimiteExceptionnelle(form.heure, form.agence, form.date)) {
                    heureLimiteExceptionnelleModal.heure = form.heure;
                    heureLimiteExceptionnelleModal.heureLimite = form.agence.heureLimiteExceptionnelle;
                    heureLimiteExceptionnelleModal.motif = form.agence.motifHeureLimite || '';
                    heureLimiteExceptionnelleModal.open = true;
                    return; // Ne pas continuer
                }
                
                // Ensuite v√©rifier si apr√®s la fermeture
                if (isHeureApresFermeture(form.heure, form.agence, form.date)) {
                    const heureFermeture = getHeureFermetureAgence(form.agence, form.date);
                    heureApresFermetureModal.heure = form.heure;
                    heureApresFermetureModal.heureFermeture = heureFermeture;
                    heureApresFermetureModal.onConfirm = callback;
                    heureApresFermetureModal.open = true;
                    return;
                }
                
                // Ensuite v√©rifier si proche de la fermeture
                if (isHeureProcheFermeture(form.heure, form.agence, form.date)) {
                    const heureFermeture = getHeureFermetureAgence(form.agence, form.date);
                    heureFermetureConfirmModal.heure = form.heure;
                    heureFermetureConfirmModal.heureFermeture = heureFermeture;
                    heureFermetureConfirmModal.onConfirm = callback;
                    heureFermetureConfirmModal.open = true;
                } else {
                    callback();
                }
            };
            
            // Fonction pour g√©rer la saisie rapide de l'heure (14 -> 14:00)
            const handleTimeInput = (e) => {
                const value = e.target.value;
                // Si l'utilisateur tape juste un nombre (1-2 chiffres) sans ":"
                // Le champ type="time" peut accepter diff√©rents formats
                if (value) {
                    // Si c'est juste un nombre (ex: "14")
                    const match = value.match(/^(\d{1,2})$/);
                    if (match) {
                        const hour = parseInt(match[1]);
                        if (hour >= 0 && hour <= 23) {
                            // Formater avec ":00" et mettre √† jour
                            const formattedTime = `${hour.toString().padStart(2, '0')}:00`;
                            form.heure = formattedTime;
                            // Mettre √† jour la valeur de l'input apr√®s un court d√©lai
                            setTimeout(() => {
                                e.target.value = formattedTime;
                            }, 10);
                        }
                    }
                    // Si c'est au format "HH" (ex: "14" sans les minutes)
                    else if (value.match(/^\d{2}$/) && !value.includes(':')) {
                        const hour = parseInt(value);
                        if (hour >= 0 && hour <= 23) {
                            const formattedTime = `${hour.toString().padStart(2, '0')}:00`;
                            form.heure = formattedTime;
                            setTimeout(() => {
                                e.target.value = formattedTime;
                            }, 10);
                        }
                    }
                }
            };
            
            // Fonction pour r√©cup√©rer les informations depuis un lien Le Bon Coin
            // Fonction pour extraire les informations depuis Le Bon Coin
            const extractLeboncoinInfo = async (lien) => {
                if (!lien || !lien.trim()) {
                    console.log('‚ùå Pas de lien fourni');
                    return;
                }
                
                // V√©rifier si c'est un lien Le Bon Coin
                if (!lien.includes('leboncoin.fr') && !lien.includes('www.leboncoin.fr')) {
                    console.log('‚ùå Ce n\'est pas un lien Le Bon Coin:', lien);
                    return;
                }
                
                console.log('üîç D√©but extraction Le Bon Coin pour:', lien);
                
                // D√©finir automatiquement la source sur "Leboncoin"
                if (form.source !== 'Leboncoin') {
                    form.source = 'Leboncoin';
                }
                
                loadingLienAnnonce.value = true;
                
                try {
                    // Utiliser un proxy CORS pour r√©cup√©rer le contenu
                    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(lien)}`;
                    console.log('üì° Appel proxy:', proxyUrl);
                    
                    const response = await fetch(proxyUrl);
                    console.log('üì• R√©ponse re√ßue, status:', response.status);
                    
                    const data = await response.json();
                    console.log('üì¶ Donn√©es re√ßues:', data ? 'Oui' : 'Non', data?.contents ? `(${data.contents.length} caract√®res)` : '');
                    
                    if (data.contents) {
                        // Parser le HTML pour extraire les informations
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(data.contents, 'text/html');
                        
                        console.log('üìÑ HTML pars√©, titre de la page:', doc.title);
                        
                        // Essayer d'abord les meta tags Open Graph (souvent pr√©sents m√™me sans JS)
                        const ogTitle = doc.querySelector('meta[property="og:title"]')?.getAttribute('content');
                        const ogDescription = doc.querySelector('meta[property="og:description"]')?.getAttribute('content');
                        console.log('üè∑Ô∏è Meta OG Title:', ogTitle);
                        console.log('üìù Meta OG Description:', ogDescription);
                        
                        // 1. R√âCUP√âRER LE PRIX
                        let prix = null;
                        // Chercher le prix dans diff√©rents s√©lecteurs possibles
                        const prixSelectors = [
                            '[data-qa-id="adview_price"]',
                            '.price',
                            '[itemprop="price"]',
                            'span[data-qa-id="adview_price"]',
                            '.adview_price',
                            'h2[data-qa-id="adview_price"]'
                        ];
                        
                        for (const selector of prixSelectors) {
                            const prixElement = doc.querySelector(selector);
                            if (prixElement) {
                                let prixText = prixElement.textContent || prixElement.innerText || '';
                                // Nettoyer le texte du prix (enlever ‚Ç¨, espaces, etc.)
                                prixText = prixText.replace(/[^\d,.]/g, '').replace(/\s/g, '');
                                // Remplacer virgule par point pour parseFloat
                                prixText = prixText.replace(',', '.');
                                const prixNum = parseFloat(prixText);
                                if (prixNum && prixNum > 0) {
                                    prix = prixNum;
                                    break;
                                }
                            }
                        }
                        
                        // Si pas trouv√©, chercher dans les meta tags
                        if (!prix) {
                            const metaPrice = doc.querySelector('meta[property="product:price:amount"]')?.getAttribute('content');
                            if (metaPrice) {
                                const prixNum = parseFloat(metaPrice);
                                if (prixNum && prixNum > 0) {
                                    prix = prixNum;
                                    console.log('üí∞ Prix trouv√© dans meta:', prix);
                                }
                            }
                        }
                        
                        // Si pas trouv√©, chercher dans le texte de la page
                        if (!prix) {
                            const bodyText = doc.body?.textContent || '';
                            // Chercher un pattern de prix (ex: "15 000 ‚Ç¨" ou "15000‚Ç¨")
                            const prixMatch = bodyText.match(/(\d[\d\s]*)\s*‚Ç¨/);
                            if (prixMatch) {
                                const prixText = prixMatch[1].replace(/\s/g, '');
                                const prixNum = parseFloat(prixText);
                                if (prixNum && prixNum > 0) {
                                    prix = prixNum;
                                    console.log('üí∞ Prix trouv√© dans le texte:', prix);
                                }
                            }
                        }
                        
                        console.log('üí∞ Prix final:', prix);
                        
                        // 2. R√âCUP√âRER LE MOD√àLE
                        let titre = '';
                        
                        // Essayer d'abord les meta tags Open Graph (plus fiable)
                        const metaTitle = doc.querySelector('meta[property="og:title"]');
                        if (metaTitle) {
                            titre = metaTitle.getAttribute('content') || '';
                            console.log('üìå Titre depuis OG:', titre);
                        }
                        
                        // Sinon chercher dans le HTML
                        if (!titre) {
                            const titleElement = doc.querySelector('h1[data-qa-id="adview_title"]') || 
                                              doc.querySelector('h1') || 
                                              doc.querySelector('[data-qa-id="adview_title"]') ||
                                              doc.querySelector('span[data-qa-id="adview_title"]');
                            
                            if (titleElement) {
                                titre = titleElement.textContent.trim();
                                console.log('üìå Titre depuis HTML:', titre);
                            }
                        }
                        
                        // Si toujours rien, utiliser le titre de la page
                        if (!titre && doc.title) {
                            titre = doc.title;
                            console.log('üìå Titre depuis document.title:', titre);
                        }
                        
                        // Chercher aussi dans les d√©tails de l'annonce
                        const detailsElements = doc.querySelectorAll('[data-qa-id="criteria_item"]') || 
                                               doc.querySelectorAll('.properties .property') ||
                                               doc.querySelectorAll('[data-qa-id="adview_criteria_item"]');
                        
                        let marque = '';
                        let modele = '';
                        let annee = '';
                        
                        detailsElements.forEach(el => {
                            const label = el.querySelector('span')?.textContent?.toLowerCase() || '';
                            const value = el.textContent?.trim() || '';
                            
                            if (label.includes('marque') || label.includes('brand')) {
                                marque = value.replace(/marque|brand/gi, '').trim();
                            }
                            if (label.includes('mod√®le') || label.includes('model')) {
                                modele = value.replace(/mod√®le|model/gi, '').trim();
                            }
                            if (label.includes('ann√©e') || label.includes('year')) {
                                annee = value.replace(/ann√©e|year/gi, '').trim();
                            }
                        });
                        
                        // Mettre √† jour le formulaire
                        let infoRecuperees = false;
                        
                        // Mettre √† jour le mod√®le (seulement si pas d√©j√† rempli ou si on a trouv√© mieux)
                        if (titre || (marque && modele)) {
                            if (!form.modele || !form.modele.trim()) {
                                if (marque && modele) {
                                    form.modele = `${marque} ${modele}${annee ? ' ' + annee : ''}`.trim();
                                } else if (titre) {
                                    form.modele = titre.trim();
                                }
                                infoRecuperees = true;
                            }
                        }
                        
                        // Mettre √† jour le prix (seulement si pas d√©j√† rempli)
                        if (prix && (!form.prix || form.prix === 0)) {
                            form.prix = prix;
                            // Formater le prix dans le champ
                            const prixFormatted = prix.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ') + ',00';
                            // Trouver l'input prix et mettre √† jour sa valeur
                            setTimeout(() => {
                                const prixInput = document.querySelector('input[placeholder*="Prix du v√©hicule"]');
                                if (prixInput) {
                                    prixInput.value = prixFormatted;
                                }
                            }, 100);
                            infoRecuperees = true;
                        }
                        
                        if (infoRecuperees) {
                            showNotification('‚úÖ Informations r√©cup√©r√©es depuis Le Bon Coin (mod√®le' + (prix ? ' et prix' : '') + ')', 'success', 'fa-check-circle');
                            console.log('‚úÖ Succ√®s! Mod√®le:', form.modele, 'Prix:', form.prix);
                        } else {
                            console.log('‚ö†Ô∏è Aucune information r√©cup√©r√©e. Titre trouv√©:', titre, 'Prix trouv√©:', prix);
                            showNotification('‚ö†Ô∏è Impossible de r√©cup√©rer les informations. Le Bon Coin charge peut-√™tre le contenu via JavaScript. Ouvrez la console (F12) pour voir les d√©tails.', 'warning', 'fa-exclamation-triangle');
                        }
                    } else {
                        console.log('‚ùå Pas de contenu dans la r√©ponse');
                        showNotification('‚ö†Ô∏è Impossible de r√©cup√©rer le contenu de la page', 'error', 'fa-exclamation-triangle');
                    }
                } catch (error) {
                    console.error('‚ùå Erreur lors de la r√©cup√©ration des informations Le Bon Coin:', error);
                    showNotification('‚ö†Ô∏è Erreur: ' + (error.message || 'Impossible de r√©cup√©rer les informations'), 'error', 'fa-exclamation-triangle');
                } finally {
                    loadingLienAnnonce.value = false;
                }
            };
            
            // Fonction appel√©e au blur (quand on quitte le champ)
            const handleLienAnnonceBlur = async () => {
                await extractLeboncoinInfo(form.lienAnnonce);
            };
            
            // Fonction appel√©e au collage
            const handleLienAnnoncePaste = async (e) => {
                // Attendre un peu pour que le paste soit termin√©
                setTimeout(async () => {
                    await extractLeboncoinInfo(form.lienAnnonce);
                }, 100);
            };
            
            // Fonction pour ouvrir Le Bon Coin dans un nouvel onglet
            const openLeboncoinInNewTab = () => {
                if (form.lienAnnonce) {
                    window.open(form.lienAnnonce, '_blank');
                    showNotification('üìã Ouvrez la console (F12) et copiez les infos depuis la page Le Bon Coin', 'info', 'fa-info-circle');
                }
            };
            const startWizard = async (skipSteps = false) => { 
                Object.assign(form, { agence:null, civilite:'M.', nom:'', telephone:'', date:'', heure:'', modele:'', source:'', pasDeNumero: false, lienAnnonce:'', motif:'', motifCustom:'', prix: null, facebookCaracteristiques: '', facebookCaracteristiquesFormatees: '' }); 
                clientExists.value = false; 
                wizard.step = skipSteps && form.agence && form.date && form.heure ? 2 : 1; 
                wizard.open = true; 
                wizard.loading = false; 
                agencySearch.value = ''; 
                showCustomTime.value = false;
                
                // V√©rifier la connexion Google Calendar au d√©marrage
                // Pour les prospecteurs : si l'admin est connect√©, ils sont automatiquement connect√©s
                let isConnected = false;
                
                if (user.role === 'admin') {
                    const isTokenValid = await checkGoogleCalendarTokenValid();
                    isConnected = isGoogleCalendarConnected.value && isTokenValid;
                } else {
                    // Pour les prospecteurs : v√©rifier si l'admin est connect√© (connexion automatique)
                    // OU si le prospecteur a son propre token
                    const adminConnected = googleCalendarConnected.value && googleAccessToken.value && googleAccessToken.value.trim() !== '';
                    const prospecteurConnected = prospecteurGoogleCalendarConnected.value && prospecteurGoogleCalendarToken.value && prospecteurGoogleCalendarToken.value.trim() !== '' && !prospecteurGoogleCalendarTokenExpired.value;
                    
                    if (adminConnected) {
                        // L'admin est connect√©, les prospecteurs utilisent automatiquement son token
                        isConnected = true;
                    } else if (prospecteurConnected) {
                        // Le prospecteur a son propre token valide
                        const isTokenValid = await checkGoogleCalendarTokenValid();
                        isConnected = isTokenValid;
                    } else {
                        // Pas de connexion disponible
                        isConnected = false;
                    }
                }
                
                if (!isConnected) {
                    // Afficher le modal de connexion si pas connect√©
                    googleCalendarDisconnectedModal.fromWizard = true;
                    googleCalendarDisconnectedModal.open = true;
                }
            };
            
            // G√©rer la fermeture du modal de connexion
            const handleCloseDisconnectedModal = () => {
                googleCalendarDisconnectedModal.open = false;
                
                // Si le modal vient du wizard et que la connexion est obligatoire, fermer le wizard
                if (googleCalendarDisconnectedModal.fromWizard && googleCalendarRequired.value) {
                    wizard.open = false;
                }
                // Si pas obligatoire, le wizard reste ouvert et on peut continuer
                
                googleCalendarDisconnectedModal.fromWizard = false;
            };
            
            // Sauvegarder le param√®tre de connexion obligatoire
            const saveGoogleCalendarRequired = async () => {
                try {
                    await db.collection('settings').doc('google_calendar_required').set({
                        required: googleCalendarRequired.value
                    });
                } catch (err) {
                    console.error('Erreur sauvegarde param√®tre:', err);
                }
            };
            // Fonction pour v√©rifier si une date est dans une p√©riode de fermeture
            const isDateInFermeture = (date, ag) => {
                if(!ag || !ag.fermeturesExceptionnelles || !Array.isArray(ag.fermeturesExceptionnelles)) return false;
                const checkDate = new Date(date);
                for(const fermeture of ag.fermeturesExceptionnelles) {
                    if(fermeture.date_debut && fermeture.date_fin) {
                        const debut = new Date(fermeture.date_debut);
                        const fin = new Date(fermeture.date_fin);
                        // V√©rifier si la date est dans la plage (inclus)
                        if(checkDate >= debut && checkDate <= fin) {
                            return true;
                        }
                    }
                }
                return false;
            };
            
            // Fonction pour obtenir le message de fermeture pour une date donn√©e
            const getFermetureMessage = (date, ag) => {
                if(!ag || !ag.fermeturesExceptionnelles || !Array.isArray(ag.fermeturesExceptionnelles)) return null;
                const checkDate = new Date(date);
                for(const fermeture of ag.fermeturesExceptionnelles) {
                    if(fermeture.date_debut && fermeture.date_fin) {
                        const debut = new Date(fermeture.date_debut);
                        const fin = new Date(fermeture.date_fin);
                        if(checkDate >= debut && checkDate <= fin) {
                            const dateDebut = new Date(fermeture.date_debut).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });
                            const dateFin = new Date(fermeture.date_fin).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });
                            if(fermeture.date_debut === fermeture.date_fin) {
                                return `Cette agence est ferm√©e le ${dateDebut}.`;
                            } else {
                                return `Cette agence est ferm√©e du ${dateDebut} au ${dateFin}.`;
                            }
                        }
                    }
                }
                return null;
            };
            
            // Fonction helper pour v√©rifier si une agence est ferm√©e aujourd'hui
            const isAgenceFermeeAujourdhui = (ag) => {
                if(!ag) return false;
                const today = new Date().toISOString().split('T')[0];
                return isDateInFermeture(today, ag);
            };
            
            const checkAgenceAndProceed = async (ag) => { 
                // V√©rifier les vacances expir√©es
                if(ag.statut_activite === 'pause' && ag.motif_pause === 'Vacances' && ag.date_pause_fin) { 
                    const today = new Date().toISOString().split('T')[0]; 
                    if (today > ag.date_pause_fin) { 
                        await db.collection('agences').doc(ag.id).update({ statut_activite: 'actif', motif_pause: '', date_pause_debut: '', date_pause_fin: '' }); 
                        ag.statut_activite = 'actif'; 
                    } 
                } 
                // V√©rifier les fermetures exceptionnelles aujourd'hui
                const today = new Date().toISOString().split('T')[0];
                if(isDateInFermeture(today, ag)) {
                    pausedAgencyModal.agency = ag;
                    pausedAgencyModal.open = true;
                    return;
                }
                // V√©rifier si l'agence est en pause
                if(ag.statut_activite === 'pause') { 
                    pausedAgencyModal.agency = ag; 
                    pausedAgencyModal.open = true; 
                    return; 
                } 
                form.agence = ag; 
                wizard.step++; 
            };
            
            const getPauseMessage = (ag) => { 
                if(!ag) return ''; 
                // V√©rifier d'abord les fermetures exceptionnelles
                const today = new Date().toISOString().split('T')[0];
                const fermetureMsg = getFermetureMessage(today, ag);
                if(fermetureMsg) {
                    return fermetureMsg + ' (Fermeture exceptionnelle)';
                }
                // Ensuite v√©rifier les pauses normales
                if (ag.motif_pause === 'Vacances') {
                    if (ag.date_pause_debut && ag.date_pause_fin) {
                        const start = new Date(ag.date_pause_debut).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long' });
                        const end = new Date(ag.date_pause_fin).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long' });
                        return `Cette agence est en vacances du ${start} au ${end}.`; 
                    } else { return "Cette agence est en vacances (Dates non pr√©cis√©es)."; }
                }
                if(ag.motif_pause === 'Complet') return "Cette agence est compl√®te (Surcharg√©e)."; 
                if(ag.motif_pause === 'Travaux') return "Cette agence est ferm√©e pour travaux."; 
                return `Cette agence est indisponible pour le motif suivant : ${ag.motif_pause || 'Pause momentan√©e'}.`; 
            };
            
            const selectSource = async (src) => { 
                form.source = src; 
                
                // R√©initialiser le champ intelligent
                intelligentPaste.value = '';
                
                // Si ce n'est plus Facebook, r√©initialiser les caract√©ristiques Facebook
                if (src !== 'Facebook') {
                    form.facebookCaracteristiques = '';
                    form.facebookCaracteristiquesFormatees = '';
                } else {
                    // Si on passe √† Facebook, r√©initialiser aussi les caract√©ristiques pour repartir √† z√©ro
                    form.facebookCaracteristiques = '';
                    form.facebookCaracteristiquesFormatees = '';
                }
                
                // Si Google est s√©lectionn√© comme source, v√©rifier et connecter automatiquement si n√©cessaire
                if (src === 'Google' && user.role !== 'admin') {
                    const isTokenValid = await checkGoogleCalendarTokenValid();
                    const adminConnected = googleCalendarConnected.value && googleAccessToken.value && googleAccessToken.value.trim() !== '';
                    const prospecteurConnected = prospecteurGoogleCalendarConnected.value && prospecteurGoogleCalendarToken.value && prospecteurGoogleCalendarToken.value.trim() !== '' && !prospecteurGoogleCalendarTokenExpired.value;
                    
                    // Si pas connect√© (ni via admin ni via token propre valide), lancer la connexion automatiquement
                    if ((!adminConnected && !prospecteurConnected) || !isTokenValid) {
                        connectingFromSelectSource.value = true;
                        connectProspecteurGoogleCalendar();
                        // Ne pas passer √† l'√©tape suivante imm√©diatement, attendre la connexion
                        return;
                    }
                }
                
                wizard.step++; 
            };
            
            // Dictionnaire de traduction anglais -> fran√ßais
            const translateToFrench = (text) => {
                const translations = {
                    'Black': 'Noir', 'White': 'Blanc', 'Gray': 'Gris', 'Grey': 'Gris',
                    'Red': 'Rouge', 'Blue': 'Bleu', 'Green': 'Vert', 'Yellow': 'Jaune',
                    'Silver': 'Argent', 'Brown': 'Marron', 'Beige': 'Beige', 'Orange': 'Orange',
                    'Manual': 'Manuelle', 'Automatic': 'Automatique',
                    'Diesel': 'Diesel', 'Petrol': 'Essence', 'Gasoline': 'Essence', 'Electric': '√âlectrique',
                    'Hybrid': 'Hybride', 'LPG': 'GPL'
                };
                let translated = text;
                Object.keys(translations).forEach(eng => {
                    const regex = new RegExp(`\\b${eng}\\b`, 'gi');
                    translated = translated.replace(regex, translations[eng]);
                });
                return translated;
            };

            // Fonction pour formater un nombre avec des espaces comme s√©parateurs de milliers
            const formatNumber = (num) => {
                return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
            };

            // Fonction pour parser et formater les caract√©ristiques Facebook
            const parseAndFormatFacebookCaracteristiques = () => {
                if (form.source !== 'Facebook' || !form.facebookCaracteristiques || !form.facebookCaracteristiques.trim()) {
                    form.facebookCaracteristiquesFormatees = '';
                    return;
                }

                const text = form.facebookCaracteristiques.trim();
                const lines = text.split('\n').map(l => l.trim()).filter(l => l);
                const formatted = [];

                lines.forEach(line => {
                    // Ignorer les lignes qui contiennent uniquement "Couleur int√©rieure" (sans "ext√©rieure")
                    if (line.toLowerCase().includes('couleur int√©rieure') && !line.toLowerCase().includes('couleur ext√©rieure')) {
                        return;
                    }

                    // Kilom√©trage
                    const kmMatch = line.match(/(\d+(?:\s?\d+)*)\s*km/i);
                    if (kmMatch) {
                        const km = kmMatch[1].replace(/\s/g, '');
                        formatted.push(`Kilom√©trage : ${formatNumber(km)} km`);
                        return;
                    }

                    // Bo√Æte de vitesse
                    if (line.toLowerCase().includes('bo√Æte de vitesse') || line.toLowerCase().includes('transmission')) {
                        let transmission = line.replace(/.*bo√Æte de vitesse\s*/i, '').replace(/.*transmission\s*/i, '');
                        transmission = translateToFrench(transmission);
                        formatted.push(`Bo√Æte de vitesse : ${transmission}`);
                        return;
                    }

                    // Couleur ext√©rieure
                    if (line.toLowerCase().includes('couleur ext√©rieure')) {
                        let color = line.replace(/.*couleur ext√©rieure\s*:\s*/i, '');
                        // Enlever "Couleur int√©rieure : ..." si pr√©sent (s√©par√© par ¬∑ ou autre)
                        if (color.includes('¬∑')) {
                            color = color.split('¬∑')[0].trim();
                        } else if (color.toLowerCase().includes('couleur int√©rieure')) {
                            color = color.split(/couleur int√©rieure/i)[0].trim();
                        }
                        color = translateToFrench(color);
                        formatted.push(`Couleur : ${color}`);
                        return;
                    }

                    // Type de carburant
                    if (line.toLowerCase().includes('type de carburant') || line.toLowerCase().includes('carburant')) {
                        let fuel = line.replace(/.*type de carburant\s*:\s*/i, '').replace(/.*carburant\s*:\s*/i, '');
                        fuel = translateToFrench(fuel);
                        formatted.push(`Type de carburant : ${fuel}`);
                        return;
                    }

                    // Nombre de propri√©taires
                    const ownersMatch = line.match(/(\d+)\s*propri√©taires?/i);
                    if (ownersMatch) {
                        formatted.push(`Propri√©taires : ${ownersMatch[1]}`);
                        return;
                    }

                    // Autres lignes (on les garde telles quelles mais on traduit)
                    if (line && !line.toLowerCase().includes('couleur int√©rieure')) {
                        formatted.push(translateToFrench(line));
                    }
                });

                form.facebookCaracteristiquesFormatees = formatted.join('\n');
                
                // Mettre √† jour le mod√®le avec les caract√©ristiques format√©es (seulement si n√©cessaire)
                // On attend un peu pour √©viter les mises √† jour multiples pendant la saisie
                clearTimeout(window.facebookUpdateTimeout);
                window.facebookUpdateTimeout = setTimeout(() => {
                    updateModeleFromFacebook();
                }, 300);
            };

            // Fonction pour g√©rer le collage depuis Facebook
            const handleFacebookPaste = (e) => {
                // Laisser le collage se faire normalement, puis parser
                setTimeout(() => {
                    parseAndFormatFacebookCaracteristiques();
                }, 10);
            };

            // Fonction pour extraire le mod√®le de base (sans les caract√©ristiques)
            const getBaseModele = (modeleText) => {
                if (!modeleText) return '';
                // Si le mod√®le contient " - ", on prend seulement la partie avant
                if (modeleText.includes(' - ')) {
                    return modeleText.split(' - ')[0].trim();
                }
                // Si le mod√®le contient des caract√©ristiques format√©es (avec " : "), c'est probablement juste les caract√©ristiques
                if (modeleText.includes('Kilom√©trage :') || modeleText.includes('Bo√Æte de vitesse :')) {
                    return '';
                }
                return modeleText.trim();
            };

            // Fonction pour mettre √† jour automatiquement le mod√®le avec les caract√©ristiques Facebook format√©es
            // NOTE: Pour Facebook, on ne met PLUS les caract√©ristiques dans le mod√®le automatiquement
            // Le titre du v√©hicule reste s√©par√© des caract√©ristiques
            const updateModeleFromFacebook = () => {
                // D√©sactiv√© : les caract√©ristiques Facebook restent s√©par√©es du mod√®le
                // Le titre du v√©hicule est extrait s√©par√©ment et ne contient pas les caract√©ristiques
                return;
                
                /* ANCIEN CODE (d√©sactiv√©)
                if (form.source !== 'Facebook' || !form.facebookCaracteristiquesFormatees || !form.facebookCaracteristiquesFormatees.trim()) {
                    return;
                }
                
                const caracteristiques = form.facebookCaracteristiquesFormatees.trim();
                const caracteristiquesFormatees = caracteristiques.replace(/\n/g, ' | ');
                
                // Extraire le mod√®le de base actuel (sans les caract√©ristiques d√©j√† pr√©sentes)
                let baseModele = getBaseModele(form.modele);
                
                // V√©rifier si les caract√©ristiques sont d√©j√† dans le mod√®le
                // On compare la premi√®re caract√©ristique pour √©viter les doublons
                const firstCarac = caracteristiques.split('\n')[0];
                if (form.modele && form.modele.includes(firstCarac)) {
                    // Les caract√©ristiques sont d√©j√† pr√©sentes, on ne fait rien
                    return;
                }
                
                // Construire le mod√®le final
                if (baseModele && baseModele.trim()) {
                    form.modele = `${baseModele} - ${caracteristiquesFormatees}`;
                } else {
                    form.modele = caracteristiquesFormatees;
                }
                */
            };
            
            // Fonction pour formater l'affichage des caract√©ristiques de mani√®re propre
            const formatCaracteristiquesForDisplay = (modeleText) => {
                if (!modeleText || typeof modeleText !== 'string') return { base: '', caracteristiques: [] };
                
                // S√©parer le mod√®le de base et les caract√©ristiques
                let base = '';
                let caracteristiques = [];
                
                if (modeleText.includes(' - ')) {
                    const parts = modeleText.split(' - ');
                    base = parts[0].trim();
                    const caracteristiquesText = parts.slice(1).join(' - ');
                    
                    // Parser les caract√©ristiques s√©par√©es par " | "
                    caracteristiques = caracteristiquesText.split(' | ').filter(c => c.trim()).map(c => {
                        const trimmed = c.trim();
                        // Si c'est format√© "Label : valeur", on le garde tel quel
                        if (trimmed.includes(' : ')) {
                            let [label, value] = trimmed.split(' : ').map(s => s.trim());
                            // Normaliser les labels
                            if (label === 'Couleur ext√©rieure') label = 'Couleur';
                            if (label === 'Nombre de propri√©taires') label = 'Propri√©taires';
                            return { label, value };
                        }
                        return { label: '', value: trimmed };
                    });
                } else if (modeleText.includes('Kilom√©trage :') || modeleText.includes('Bo√Æte de vitesse :')) {
                    // C'est juste des caract√©ristiques, pas de mod√®le de base
                    caracteristiques = modeleText.split(' | ').filter(c => c.trim()).map(c => {
                        const trimmed = c.trim();
                        if (trimmed.includes(' : ')) {
                            let [label, value] = trimmed.split(' : ').map(s => s.trim());
                            // Normaliser les labels
                            if (label === 'Couleur ext√©rieure') label = 'Couleur';
                            if (label === 'Nombre de propri√©taires') label = 'Propri√©taires';
                            return { label, value };
                        }
                        return { label: '', value: trimmed };
                    });
                } else {
                    // C'est juste le mod√®le de base
                    base = modeleText.trim();
                }
                
                return { base, caracteristiques };
            };
            
            // Fonction pour valider et envoyer le SMS (avec v√©rification Google Calendar)
            const validateAndSendSMS = async () => {
                // Emp√™cher les doubles clics
                if (wizard.loading) return;
                
                // OUVRIR LE SMS IMM√âDIATEMENT avec les donn√©es du formulaire
                const tempRdv = {
                    ...form,
                    agenceId: form.agence.id,
                    statut: 'confirme'
                };
                const smsLink = generateMsgLink(tempRdv, 'confirm');
                if (smsLink) {
                    window.open(smsLink, '_blank');
                }
                
                // Cr√©er le RDV en arri√®re-plan (sans bloquer)
                finalizeRdv('confirme', false).catch(err => {
                    console.error('Erreur cr√©ation RDV:', err);
                });
            };
            
            // Fonction pour cr√©er un RDV "a_confirmer" avec SMS
            const finalizeRdvWithSMS = async (statut) => {
                // Emp√™cher les doubles clics
                if (wizard.loading) return;
                
                // Cr√©er le RDV
                await finalizeRdv(statut, false);
                
                // Ouvrir le SMS apr√®s cr√©ation
                const tempRdv = {
                    ...form,
                    agenceId: form.agence.id,
                    statut: statut
                };
                const smsLink = generateMsgLink(tempRdv, 'confirm');
                if (smsLink) {
                    window.open(smsLink, '_blank');
                }
            };
            
            const confirmRappelSent = async (rdv) => {
                if (!rdv || !rdv.id) return;
                
                try {
                    const now = new Date();
                    const rappelData = {
                        date: now.toISOString().split('T')[0],
                        heure: now.toTimeString().split(' ')[0].substring(0, 5),
                        par: user.name,
                        userId: user.id,
                        timestamp: now
                    };
                    
                    await db.collection('rendezvous').doc(rdv.id).update({
                        rappelSent: rappelData
                    });
                    
                    // Mettre √† jour le rdv local
                    if (clientModal.rdv && clientModal.rdv.id === rdv.id) {
                        clientModal.rdv.rappelSent = rappelData;
                    }
                    
                    // Mettre √† jour dans la liste des rdv
                    const rdvIndex = rdvList.value.findIndex(r => r.id === rdv.id);
                    if (rdvIndex !== -1) {
                        rdvList.value[rdvIndex].rappelSent = rappelData;
                    }
                    
                    rappelConfirmModal.open = false;
                    showNotification('Rappel enregistr√© avec succ√®s', 'success');
                } catch (error) {
                    console.error('Erreur lors de l\'enregistrement du rappel:', error);
                    showNotification('Erreur lors de l\'enregistrement du rappel', 'error');
                }
            };
            
            const handleSendRappel = (rdv) => {
                if (!rdv) return;
                const smsLink = generateMsgLink(rdv, getRappelType(rdv));
                // Ouvrir le SMS dans un nouvel onglet
                window.open(smsLink, '_blank');
                // Apr√®s 2 secondes, ouvrir le modal de confirmation
                setTimeout(() => {
                    rappelConfirmModal.rdv = rdv;
                    rappelConfirmModal.smsLink = smsLink;
                    rappelConfirmModal.open = true;
                }, 2000);
            };
            
            const createQuickRdv = async () => {
                if (!quickRdvModal.agenceId || !quickRdvModal.source) {
                    showNotification('Veuillez remplir tous les champs obligatoires', 'error');
                    return;
                }
                
                // V√©rifier si l'agence a des commerciaux
                // Une valeur vide (cha√Æne vide '') signifie "Je ne sais pas", ce qui est valide
                // On accepte donc une cha√Æne vide comme valeur valide
                // La validation est donc toujours pass√©e car commercialId est initialis√© √† '' et peut rester vide pour "Je ne sais pas"
                // Pas besoin de validation suppl√©mentaire ici
                
                try {
                    const agence = agences.value.find(a => a.id === quickRdvModal.agenceId);
                    if (!agence) {
                        showNotification('Agence introuvable', 'error');
                        return;
                    }
                    
                    // Utiliser la date d'aujourd'hui si non fournie
                    const today = new Date().toISOString().split('T')[0];
                    const rdvDate = quickRdvModal.date || today;
                    // Utiliser 12:00 par d√©faut si l'heure n'est pas fournie
                    const rdvHeure = quickRdvModal.heure || '12:00';
                    
                    // Sauvegarder l'√©tat honore avant r√©initialisation
                    const wasHonore = quickRdvModal.honore;
                    
                    const rdvData = {
                        nom: quickRdvModal.nom || '',
                        modele: quickRdvModal.modele || '',
                        note: quickRdvModal.note || '',
                        agenceId: quickRdvModal.agenceId,
                        commercialId: quickRdvModal.commercialId || '',
                        date: rdvDate,
                        heure: rdvHeure,
                        statut: wasHonore ? 'honore' : 'confirme',
                        honorBilling: wasHonore ? 'facture' : null,
                        prix: parseFloat(agence.prix) || 0,
                        created: new Date(),
                        createdBy: user.name,
                        source: quickRdvModal.source.toUpperCase(),
                        rappelFait: false,
                        dansAgenda: false,
                        enAttenteAgenda: false
                    };
                    
                    const docRef = await db.collection('rendezvous').add(rdvData);
                    const newRdv = { id: docRef.id, ...rdvData };
                    
                    // Si le RDV est honor√©, le synchroniser automatiquement au bilan
                    if (wasHonore) {
                        try {
                            // R√©cup√©rer le nom du commercial si un commercialId est fourni
                            let commercialName = '';
                            if (quickRdvModal.commercialId && quickRdvModal.commercialId !== '') {
                                // Chercher dans teamList d'abord
                                let commercial = teamList.value.find(u => u.id === quickRdvModal.commercialId);
                                if (!commercial) {
                                    // Si pas trouv√© dans teamList, chercher dans les commerciaux des r√©glages
                                    const ag = agences.value.find(a => a.id === quickRdvModal.agenceId);
                                    if (ag) {
                                        if (ag.commerciauxDetails && ag.commerciauxDetails.length > 0) {
                                            const settingCommercial = ag.commerciauxDetails.find(c => {
                                                const name = typeof c === 'string' ? c : c.name;
                                                return `setting_${name.replace(/\s+/g, '_')}` === quickRdvModal.commercialId;
                                            });
                                            if (settingCommercial) {
                                                commercialName = typeof settingCommercial === 'string' ? settingCommercial : settingCommercial.name;
                                            }
                                        } else if (ag.commerciaux && ag.commerciaux.length > 0) {
                                            const settingCommercial = ag.commerciaux.find(name => 
                                                `setting_${name.replace(/\s+/g, '_')}` === quickRdvModal.commercialId
                                            );
                                            if (settingCommercial) {
                                                commercialName = settingCommercial;
                                            }
                                        }
                                    }
                                } else {
                                    commercialName = commercial.name;
                                }
                            } else if (quickRdvHasCommerciaux.value) {
                                // Si "Je ne sais pas" est s√©lectionn√© (valeur vide) ou si l'agence a des commerciaux mais aucun n'est s√©lectionn√©
                                commercialName = '√Ä traiter';
                            }
                            await syncRdvToBilan(newRdv, commercialName, quickRdvHasCommerciaux.value && !quickRdvModal.commercialId);
                        } catch (syncError) {
                            console.error('Erreur lors de la synchronisation au bilan:', syncError);
                            // Ne pas bloquer la cr√©ation du RDV si la sync √©choue
                        }
                    }
                    
                    // R√©initialiser le modal
                    quickRdvModal.nom = '';
                    quickRdvModal.modele = '';
                    quickRdvModal.note = '';
                    quickRdvModal.agenceId = '';
                    quickRdvModal.commercialId = '';
                    quickRdvModal.date = '';
                    quickRdvModal.heure = '';
                    quickRdvModal.source = '';
                    quickRdvModal.honore = false;
                    quickRdvModal.open = false;
                    
                    const statutMsg = wasHonore ? 'Rendez-vous honor√© cr√©√© avec succ√®s et synchronis√© au bilan' : 'Rendez-vous cr√©√© avec succ√®s';
                    showNotification(statutMsg, 'success');
                } catch (error) {
                    console.error('Erreur lors de la cr√©ation du RDV rapide:', error);
                    showNotification('Erreur lors de la cr√©ation du rendez-vous', 'error');
                }
            };
            
            const finalizeRdv = async (statut, openSMS = false) => {
                // Emp√™cher les doubles clics
                if (wizard.loading) return;
                wizard.loading = true;
                
                try {
                    // V√âRIFIER LA CONNEXION √Ä L'AGENDA AVANT D'ENVOYER LE SMS
                    const isTokenValid = await checkGoogleCalendarTokenValid();
                    const isConnected = isGoogleCalendarConnected.value && isTokenValid;
                    
                    const motifFinal = form.motif === '__CUSTOM__' ? (form.motifCustom || '') : (form.motif || '');
                    const rdvLinkId = generateRdvLinkId();
                    // Utiliser le prix du formulaire s'il existe, sinon celui de l'agence
                    const prixFinal = form.prix !== null && form.prix !== undefined ? parseFloat(form.prix) : (parseFloat(form.agence.prix) || 0);
                    const rdvData = {
                        ...form,
                        agenceId: form.agence.id,
                        prix: prixFinal,
                        statut,
                        motif: motifFinal,
                        created: new Date(),
                        createdBy: user.name,
                        rappelFait: false,
                        dansAgenda: false,
                        enAttenteAgenda: !isConnected, // Mettre en attente si pas connect√©
                        rdvLinkId: rdvLinkId // Lien unique pour le client
                    };
                    delete rdvData.motifCustom;
                    // Garder les caract√©ristiques format√©es pour Google Agenda, mais ne pas sauvegarder le texte brut
                    if (rdvData.source === 'Facebook' && form.facebookCaracteristiquesFormatees) {
                        rdvData.facebookCaracteristiquesFormatees = form.facebookCaracteristiquesFormatees;
                    }
                    delete rdvData.facebookCaracteristiques; // Ne pas sauvegarder le texte brut, seulement le format√©
                    
                    const docRef = await db.collection('rendezvous').add(rdvData);
                    const newRdv = { id: docRef.id, ...rdvData };
                    
                    // Log de la cr√©ation
                    logAction('creation_rdv', {
                        rdvId: docRef.id,
                        client: `${form.civilite} ${form.nom}`,
                        date: form.date,
                        heure: form.heure,
                        agence: getAgenceName(form.agenceId),
                        source: form.source,
                        statut: statut
                    });
                    
                    let placedInAgenda = false;
                    
                    // Ajouter automatiquement √† Google Calendar seulement si connect√©
                    if (isConnected) {
                        try {
                            const eventResult = await createGoogleCalendarEvent(newRdv);
                            // Marquer comme ajout√© dans l'agenda et stocker l'ID de l'√©v√©nement
                            await db.collection('rendezvous').doc(docRef.id).update({ 
                                dansAgenda: true,
                                googleCalendarEventId: eventResult.eventId || eventResult.id,
                                enAttenteAgenda: false
                            });
                            newRdv.dansAgenda = true;
                            newRdv.googleCalendarEventId = eventResult.eventId || eventResult.id;
                            newRdv.enAttenteAgenda = false;
                            placedInAgenda = true;
                        } catch (err) {
                            console.error('Erreur lors de l\'ajout √† Google Calendar:', err);
                            
                            // D√©tecter les erreurs de token m√™me apr√®s v√©rification
                            const errorMessage = err.message || '';
                            const isTokenError = errorMessage.includes('401') || 
                                               errorMessage.includes('403') || 
                                               errorMessage.includes('Invalid Credentials') ||
                                               errorMessage.includes('expired') ||
                                               errorMessage.includes('token');
                            
                            if (isTokenError) {
                                // Mettre en attente si erreur de token
                                await db.collection('rendezvous').doc(docRef.id).update({ 
                                    enAttenteAgenda: true
                                });
                            }
                            // Ne pas bloquer la cr√©ation du RDV si l'ajout √† Google Calendar √©choue
                        }
                    }
                    
                    // Afficher le message de confirmation moderne
                    if (placedInAgenda) {
                        showNotification('Rendez-vous cr√©√© et plac√© dans l\'agenda Google Calendar', 'success', 'fa-calendar-check');
                    } else if (!isConnected) {
                        // Ne pas afficher de notification si on n'est pas connect√© (le modal s'en charge)
                    } else {
                        showNotification('Rendez-vous cr√©√©. Connectez Google Calendar dans les param√®tres pour l\'ajouter √† l\'agenda', 'warning', 'fa-calendar-plus');
                    }
                    
                    // Ouvrir le SMS si demand√© et si le statut est "confirme"
                    if (openSMS && statut === 'confirme') {
                        const smsLink = generateMsgLink(newRdv, 'confirm');
                        if (smsLink) {
                            window.open(smsLink, '_blank');
                        }
                    }
                    
                    wizard.open = false;
                    
                    // Retourner le RDV cr√©√© pour pouvoir v√©rifier son √©tat
                    return newRdv;
                } catch (err) {
                    console.error('Erreur lors de la cr√©ation du rendez-vous:', err);
                    alert('‚ùå Erreur lors de la cr√©ation du rendez-vous. Veuillez r√©essayer.');
                    return null;
                } finally {
                    wizard.loading = false;
                }
            };
            
            const openRdvFiche = async (r) => { 
                // Charger les donn√©es compl√®tes depuis Firestore pour avoir les notes √† jour
                try {
                    const doc = await db.collection('rendezvous').doc(r.id).get();
                    const data = doc.data();
                    // Convertir les timestamps Firestore en conservant le format original pour compatibilit√©
                    const fullData = { 
                        id: doc.id, 
                        ...data,
                        // Conserver le timestamp Firestore tel quel, on le convertira √† l'affichage
                        created: data.created || r.created
                    };
                    clientModal.rdv = fullData; 
                    showDiscountInput.value = !!fullData.geste_commercial; 
                    clientModal.view = 'main';
                    clientModal.open = true;
                } catch (error) {
                    // Fallback si erreur
                    clientModal.rdv = { ...r }; 
                    showDiscountInput.value = !!r.geste_commercial; 
                    clientModal.view = 'main';
                    clientModal.open = true;
                }
            };
            const updateRdv = async (r) => { await db.collection('rendezvous').doc(r.id).update(r); clientModal.open = false; };
            const toggleOkM = async (rdv, e) => {
                if (e) e.stopPropagation();
                const newTag = rdv.tag === 'OK M' ? null : 'OK M';
                await db.collection('rendezvous').doc(rdv.id).update({ tag: newTag });
                rdv.tag = newTag;
            };
            const resendReminder = async (r) => {
                const rappelType = getRappelType(r);
                const link = generateMsgLink(r, rappelType);
                if(link) {
                    window.open(link, '_blank');
                }
            };
            
            // Fonction pour envoyer un rappel manuel depuis un rendez-vous √† venir
            const sendManualRappel = async (rdv, event) => {
                if (event) {
                    event.stopPropagation(); // Emp√™cher l'ouverture de la fiche
                }
                
                // V√©rifier si le rendez-vous est dans 5 jours ou moins
                if (!rdv.date) return;
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const rdvDate = new Date(rdv.date);
                rdvDate.setHours(0, 0, 0, 0);
                const diffDays = Math.round((rdvDate - today) / 86400000);
                
                if (diffDays < 0) {
                    showNotification('‚ö†Ô∏è Ce rendez-vous est d√©j√† pass√©', 'error', 'fa-exclamation-triangle');
                    return;
                }
                
                if (diffDays > 5) {
                    showNotification('‚ÑπÔ∏è Les rappels sont envoy√©s automatiquement pour les rendez-vous dans 5 jours ou moins', 'info', 'fa-info-circle');
                    return;
                }
                
                // D√©terminer le type de rappel selon le nombre de jours
                let rappelType = 'rappel';
                if (diffDays === 0) {
                    rappelType = 'rappel_today';
                } else if (diffDays === 1) {
                    rappelType = 'rappel';
                } else {
                    // Pour les rendez-vous dans 2 √† 5 jours, utiliser le type 'rappel'
                    rappelType = 'rappel';
                }
                
                const link = generateMsgLink(rdv, rappelType);
                if (link) {
                    window.open(link, '_blank');
                    
                    // Marquer comme rappel fait si ce n'est pas d√©j√† fait
                    if (!rdv.rappelFait) {
                        const now = new Date();
                        const note = { 
                            text: `üîî Rappel envoy√© manuellement`, 
                            author: user.name, 
                            date: now.toISOString(),
                            type: 'rappel'
                        };
                        let notes = rdv.notes || []; 
                        notes.push(note);
                        await db.collection('rendezvous').doc(rdv.id).update({ 
                            rappelFait: true,
                            rappelFaitDate: now.toISOString(),
                            rappelFaitHeure: now.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'}),
                            notes: notes
                        }); 
                        rdv.rappelFait = true;
                        rdv.rappelFaitDate = now.toISOString();
                        rdv.rappelFaitHeure = now.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});
                        rdv.notes = notes;
                        if(clientModal.rdv && clientModal.rdv.id === rdv.id) {
                            clientModal.rdv.rappelFait = true;
                            clientModal.rdv.rappelFaitDate = now.toISOString();
                            clientModal.rdv.rappelFaitHeure = now.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});
                            clientModal.rdv.notes = notes;
                        }
                    }
                    
                    showNotification('üì± Application SMS ouverte', 'success', 'fa-mobile-alt');
                }
            };
            
            // Fonction pour v√©rifier et envoyer les SMS programm√©s
            const checkAndSendScheduledSMS = async () => {
                try {
                    const now = new Date();
                    const nowISO = now.toISOString();
                    
                    // R√©cup√©rer les SMS programm√©s qui doivent √™tre envoy√©s maintenant (dans les 2 prochaines minutes)
                    const twoMinutesLater = new Date(now.getTime() + 2 * 60 * 1000).toISOString();
                    
                    const scheduledQuery = await db.collection('scheduledSMS')
                        .where('status', '==', 'pending')
                        .where('scheduledFor', '<=', twoMinutesLater)
                        .get();
                    
                    for(const doc of scheduledQuery.docs) {
                        const sms = doc.data();
                        
                        // Cr√©er le lien SMS et l'ouvrir automatiquement
                        const smsLink = `sms:${sms.telephone}?body=${encodeURIComponent(sms.message)}`;
                        
                        // Marquer comme envoy√©
                        await db.collection('scheduledSMS').doc(doc.id).update({
                            status: 'sent',
                            sentAt: nowISO
                        });
                        
                        // Ouvrir le SMS (cela d√©clenchera l'application SMS)
                        window.open(smsLink, '_blank');
                        
                        // Log de l'envoi
                        logAction('sms_programme_envoye', {
                            rdvId: sms.rdvId,
                            client: sms.client,
                            telephone: sms.telephone,
                            type: sms.type,
                            programmePour: sms.scheduledFor
                        });
                    }
                } catch(err) {
                    console.error('Erreur v√©rification SMS programm√©s:', err);
                }
            };
            
            // D√©marrer la v√©rification p√©riodique (toutes les minutes)
            const startScheduledSMSChecker = () => {
                // V√©rifier imm√©diatement
                checkAndSendScheduledSMS();
                // Puis toutes les minutes
                setInterval(checkAndSendScheduledSMS, 60 * 1000);
            };
            
            // G√©n√©rer un identifiant unique pour le lien client
            const generateRdvLinkId = () => {
                return Date.now().toString(36) + Math.random().toString(36).substring(2, 11);
            };
            
            // G√©n√©rer l'URL du lien client
            const getRdvClientLink = (rdvLinkId) => {
                if (!rdvLinkId) return '';
                // Utiliser l'URL configur√©e dans les r√©glages, sinon utiliser l'origine actuelle
                const baseUrl = globalSettings.value.rdvLinkBaseUrl || window.location.origin;
                // Nettoyer l'URL (enlever le slash final si pr√©sent)
                const cleanBaseUrl = baseUrl.replace(/\/$/, '');
                return `${cleanBaseUrl}/rdv.html?id=${rdvLinkId}`;
            };
            
            const softDeleteRdv = (r) => { selectedIds.value = [r.id]; clientModal.open = false; openBulkConfirm('soft_delete', 'Envoyer ce RDV √† la corbeille ?'); };
            const deleteRdv = softDeleteRdv;
            
            const openCancelChoice = (r) => { 
                cancelModal.rdv = r; 
                cancelModal.motif = ''; 
                cancelModal.motifCustom = ''; 
                cancelModal.selectedMotif = ''; 
                cancelModal.sendSMS = false; 
                cancelModal.who = ''; 
                cancelModal.open = true; 
            };
            const confirmCancel = async (r, who, motif, sendSMS) => { 
                // Le motif est obligatoire seulement si c'est le client qui annule
                if (who === 'client' && !motif) return;
                
                // --- 1. ENVOI SMS EN PRIORIT√â (AVANT TOUTE ATTENTE) ---
                // On le fait tout de suite pour que le navigateur ne bloque pas la fen√™tre
                if (sendSMS && r.telephone) {
                    const smsType = who === 'client' ? 'cancel_clt' : 'cancel_ag';
                    // On injecte temporairement le motif pour que le lien SMS soit g√©n√©r√© avec le bon motif
                    const tempRdvForSms = { ...r, motif: motif, statut: 'annule' };
                    const smsLink = generateLink(tempRdvForSms, smsType);
                    
                    if (smsLink) {
                        window.open(smsLink, '_blank');
                    }
                }
                // -------------------------------------------------------

                const wasHonored = r.statut === 'honore';
                
                // 2. Mise √† jour base de donn√©es
                await db.collection('rendezvous').doc(r.id).update({ 
                    statut: 'annule', 
                    motif: motif,
                    honorBilling: null 
                });
                
                // Log de l'action
                logAction('annulation', {
                    rdvId: r.id,
                    client: `${r.civilite} ${r.nom}`,
                    date: r.date,
                    heure: r.heure,
                    qui: who,
                    motif: motif,
                    smsEnvoye: sendSMS
                }); 
                
                // 3. Mise √† jour Agenda Google
                if (r.dansAgenda && r.googleCalendarEventId) {
                    // On force les donn√©es locales pour le titre et la description
                    r.statut = 'annule'; 
                    r.motif = motif; 
                    
                    if (googleCalendarConnected.value || prospecteurGoogleCalendarConnected.value) {
                         // On lance la mise √† jour en fond
                         updateGoogleCalendarEvent(r).then(() => console.log("Agenda mis √† jour (Annul√©)"));
                    }
                }
                
                // 4. Nettoyage si c'√©tait un RDV honor√©
                if (wasHonored) {
                    await deleteTransactionsForRdv(r.id);
                    await removeRdvFromBilan(r.id); 
                }
                
                // 5. Mise √† jour affichage local (Agenda visuel)
                if (r.date && calendarEvents.value[r.date]) {
                    const eventIndex = calendarEvents.value[r.date].findIndex(e => e.type === 'rdv' && e.id === r.id);
                    if (eventIndex >= 0) {
                        calendarEvents.value[r.date][eventIndex] = {
                            ...calendarEvents.value[r.date][eventIndex],
                            statut: 'annule',
                            motif: motif
                        };
                    }
                }
                
                // 6. Mise √† jour liste
                const rdvIndex = rdvList.value.findIndex(rdv => rdv.id === r.id);
                if (rdvIndex >= 0) {
                    rdvList.value[rdvIndex].statut = 'annule';
                    rdvList.value[rdvIndex].motif = motif;
                }
                
                if (view.value === 'calendar') {
                    setTimeout(() => {
                        refreshCalendarEvents();
                    }, 300);
                }
                
                // 7. Fermeture modales
                cancelModal.open = false; 
                cancelModal.motif = ''; 
                cancelModal.motifCustom = ''; 
                cancelModal.selectedMotif = ''; 
                cancelModal.sendSMS = false; 
                cancelModal.who = ''; 
                clientModal.open = false; 
            };
            const quickCancel = async (r) => { 
                // Utiliser le m√™me modal d'annulation avec motif
                openCancelChoice(r);
            };
            
            const openEdit = (r) => { 
                if (!r) return;
                editModal.rdv = r; 
                try {
                    const parsed = formatCaracteristiquesForDisplay(r.modele || '');
                    editModal.form = { 
                        civilite: r.civilite || 'M.', 
                        nom: r.nom || '', 
                        telephone: r.telephone || '', 
                        baseModele: parsed.base || '',
                        caracteristiques: parsed.caracteristiques && parsed.caracteristiques.length > 0 ? parsed.caracteristiques : [],
                        source: r.source || '', 
                        agenceId: r.agenceId || '',
                        prix: r.prix || null,
                        modele: r.modele || ''
                    }; 
                } catch (e) {
                    console.error('Erreur dans openEdit:', e);
                    editModal.form = { 
                        civilite: r.civilite || 'M.', 
                        nom: r.nom || '', 
                        telephone: r.telephone || '', 
                        baseModele: r.modele || '',
                        caracteristiques: [],
                        source: r.source || '', 
                        agenceId: r.agenceId || '',
                        prix: r.prix || null,
                        modele: r.modele || ''
                    };
                }
                editModal.open = true; 
            };
            
            // Fonction pour mettre √† jour le mod√®le complet √† partir du mod√®le de base et des caract√©ristiques
            const updateEditModalModele = () => {
                if (!editModal.form) return;
                const base = editModal.form.baseModele || '';
                const caracteristiques = editModal.form.caracteristiques || [];
                if (caracteristiques.length > 0) {
                    const caracStr = caracteristiques.map(c => `${c.label} : ${c.value}`).join(' | ');
                    editModal.form.modele = base ? `${base} - ${caracStr}` : caracStr;
                } else {
                    editModal.form.modele = base;
                }
            };
            
            // Fonction pour ajouter une nouvelle caract√©ristique
            const addNewCaracteristique = () => {
                if (!editModal.form.caracteristiques) {
                    editModal.form.caracteristiques = [];
                }
                editModal.form.caracteristiques.push({ label: '', value: '' });
            };
            
            // Fonction pour supprimer une caract√©ristique
            const removeCaracteristique = (idx) => {
                if (editModal.form.caracteristiques && editModal.form.caracteristiques.length > idx) {
                    editModal.form.caracteristiques.splice(idx, 1);
                    updateEditModalModele();
                }
            };
           const saveEdit = async () => {
                if(!editModal.rdv) return;

                // Mettre √† jour le mod√®le complet avant de sauvegarder
                updateEditModalModele();
                
                // Pr√©parer les caract√©ristiques format√©es pour Facebook si n√©cessaire
                if (editModal.form.source === 'Facebook' && editModal.form.caracteristiques && editModal.form.caracteristiques.length > 0) {
                    editModal.form.facebookCaracteristiquesFormatees = editModal.form.caracteristiques
                        .map(c => `${c.label} : ${c.value}`)
                        .join('\n');
                }

                // 1. D√©tection du changement d'agence
                const oldAgencyId = editModal.rdv.agenceId;
                const newAgencyId = editModal.form.agenceId;
                const agencyChanged = oldAgencyId !== newAgencyId;

                // On pr√©pare les donn√©es mises √† jour
                const updatedRdvData = { ...editModal.rdv, ...editModal.form };

                // Mise √† jour du prix si l'agence change (optionnel, selon ta logique)
                if (agencyChanged) {
                    const newAgency = agences.value.find(a => a.id === newAgencyId);
                    if (newAgency) { editModal.form.prix = parseFloat(newAgency.prix) || 0; }
                }

                // 2. Sauvegarde en Base de Donn√©es (Firebase)
                await db.collection('rendezvous').doc(editModal.rdv.id).update(editModal.form);

                // 3. GESTION INTELLIGENTE GOOGLE CALENDAR
                if (editModal.rdv.dansAgenda && editModal.rdv.googleCalendarEventId && googleCalendarConnected.value && googleAccessToken.value) {
                    try {
                        if (agencyChanged) {
                            // üö® CAS CRITIQUE : CHANGEMENT D'AGENCE
                            console.log("üîÑ Changement d'agence d√©tect√© : D√©placement du RDV...");

                            // A. On supprime l'√©v√©nement de l'ANCIEN agenda (en utilisant l'ancien ID agence)
                            // On cr√©e un faux objet RDV avec les vieilles infos juste pour la suppression
                            const oldRdvRef = { 
                                ...editModal.rdv, 
                                agenceId: oldAgencyId 
                            };
                            await deleteGoogleCalendarEvent(oldRdvRef);

                            // B. On cr√©e l'√©v√©nement dans le NOUVEL agenda
                            // On s'assure que les donn√©es envoy√©es ont le bon nouvel ID d'agence
                            updatedRdvData.agenceId = newAgencyId; 
                            const newEventResult = await createGoogleCalendarEvent(updatedRdvData);

                            // C. On met √† jour le nouvel ID Google dans la base de donn√©es
                            await db.collection('rendezvous').doc(editModal.rdv.id).update({
                                googleCalendarEventId: newEventResult.id
                            });

                            // D. Mise √† jour locale pour que l'interface soit juste
                            editModal.rdv.googleCalendarEventId = newEventResult.id;
                            console.log("‚úÖ RDV d√©plac√© avec succ√®s vers la nouvelle agence !");

                        } else {
                            // CAS STANDARD : M√™me agence, juste une modif d'heure/nom/etc.
                            await updateGoogleCalendarEvent(updatedRdvData);
                            console.log("‚úÖ RDV mis √† jour (m√™me agence)");
                        }
                    } catch (err) {
                        console.error('Erreur lors de la synchro Google Calendar:', err);
                        alert("‚ö†Ô∏è Donn√©es sauvegard√©es, mais erreur de synchro Google Calendar : " + err.message);
                    }
                }
                
                // Mise √† jour de l'affichage local final
                Object.assign(editModal.rdv, editModal.form);
                editModal.open = false;
            };

            const openHonorCheck = (r) => {
                honorModal.rdv = r;
                honorModal.commercial = '';
                honorModal.error = '';
                // V√©rifier si l'agence a des commerciaux
                const ag = agences.value.find(a => a.id === r.agenceId);
                if(ag && ((ag.commerciaux && ag.commerciaux.length > 0) || (ag.commerciauxDetails && ag.commerciauxDetails.length > 0))) {
                    honorModal.needsCommercial = true;
                } else {
                    honorModal.needsCommercial = false;
                }
                honorModal.open = true;
            };
           const finalizeHonor = async (withMandat) => {
                if(!honorModal.rdv) return;
                
                const r = honorModal.rdv;
                
                // R√©cup√©rer l'agence pour v√©rifier si elle a des commerciaux
                const ag = agences.value.find(a => a.id === r.agenceId);
                const hasCommerciaux = ag && ((ag.commerciaux && ag.commerciaux.length > 0) || (ag.commerciauxDetails && ag.commerciauxDetails.length > 0));
                
                // V√©rifier si un commercial doit √™tre s√©lectionn√©
                if (honorModal.needsCommercial && (!honorModal.commercial || honorModal.commercial.trim() === '')) {
                    honorModal.error = 'Merci de s√©lectionner un commercial ou de choisir "Je ne sais pas"';
                    return;
                }
                
                // R√©initialiser l'erreur
                honorModal.error = '';
                
                // On r√©cup√®re la valeur choisie
                let commercialChoice = honorModal.commercial;
                if (!hasCommerciaux) {
                    commercialChoice = ''; // Pas de commercial si l'agence n'en a pas
                }
                
                // Mise √† jour du RDV (Statut Vert)
                const patch = { statut: 'honore', honorBilling: 'facture', tag: withMandat ? 'OK M' : null };
                await db.collection('rendezvous').doc(r.id).update(patch);
                
                // Mise √† jour locale
                Object.assign(r, patch);
                if(clientModal.rdv && clientModal.rdv.id === r.id) { Object.assign(clientModal.rdv, patch); }
                
                // Cr√©ation transaction (si applicable)
                await createTransactionForRdv(r);
                
                // SYNCHRO BILAN : 
                // Si l'agence a des commerciaux ET que le choix est "Je ne sais pas" ou vide, on envoie TRUE pour forcer le "√Ä traiter"
                // Si l'agence n'a PAS de commerciaux, on va quand m√™me dans le bilan mais sans needsCommercial
                const isUrgent = hasCommerciaux && (commercialChoice === 'Je ne sais pas' || !commercialChoice || commercialChoice.trim() === '');
                await syncRdvToBilan(r, commercialChoice, isUrgent);
                
                launchFireworks();
                honorModal.open = false;
                clientModal.open = false;
            };
            
            // Fonction pour r√©cup√©rer les commerciaux de l'agence du RDV honor√©
            const getHonorCommerciaux = () => {
                if(!honorModal.rdv) return [];
                const ag = agences.value.find(a => a.id === honorModal.rdv.agenceId);
                if(!ag) return [];
                if(ag.commerciauxDetails) return ag.commerciauxDetails.map(c => c.name);
                if(ag.commerciaux) return ag.commerciaux;
                return [];
            };

            // Fonction pour r√©cup√©rer les commerciaux d'une agence
            const getAgencyCommerciaux = (agencyId) => {
                if(!agencyId) return [];
                const ag = agences.value.find(a => a.id === agencyId);
                if(!ag) return [];
                if(ag.commerciauxDetails) return ag.commerciauxDetails.map(c => c.name);
                if(ag.commerciaux) return ag.commerciaux;
                return [];
            };
            
            // Fonction de synchronisation vers le Bilan (VERSION STRICTE : Je ne sais pas = √Ä traiter)
            const syncRdvToBilan = async (rdv, commercial = '', forceNeedsCommercial = false) => {
                try {
                    if (!rdv) return;

                    // 1. On r√©cup√®re l'agence
                    let ag = null;
                    if (rdv.agenceId) {
                        ag = agences.value.find(a => a.id === rdv.agenceId);
                    }
                    if (!ag) {
                        ag = { id: 'sans-agence', nom: 'Ind√©pendant / Hors Agence', prix: 0, commerciaux: [] };
                    }

                    // V√©rifier si l'agence a des commerciaux
                    const hasCommerciaux = (ag.commerciaux && ag.commerciaux.length > 0) || (ag.commerciauxDetails && ag.commerciauxDetails.length > 0);

                    // 2. V√©rification anti-doublon (On ne cr√©e pas deux fois la ligne)
                    const existingRdv = await db.collection('bilan_rdv').where('rdvIds', 'array-contains', rdv.id).get();
                    if (!existingRdv.empty) { 
                        console.log('RDV d√©j√† dans le bilan:', rdv.id); 
                        return; 
                    }
                    
                    console.log('üîÑ Synchronisation RDV vers Bilan:', rdv.id, 'Agence:', ag.nom, 'Commercial:', commercial);

                    // 3. Pr√©paration finances
                    const rdvDate = rdv.date || new Date().toISOString().split('T')[0];
                    const targetMonth = monthKey(rdvDate);
                    
                    // 4. LOGIQUE "√Ä TRAITER" (SECURIT√â TOTALE) - DOIT √äTRE AVANT L'UTILISATION
                    let finalCommercial = commercial;
                    let needsCommercial = forceNeedsCommercial;
                    
                    // Si l'agence a des commerciaux ET que le commercial n'est pas choisi -> "√Ä traiter" avec alerte
                    if (hasCommerciaux && (!finalCommercial || finalCommercial === '' || finalCommercial === 'Je ne sais pas')) {
                        finalCommercial = '√Ä traiter'; // On force ce nom exact
                        needsCommercial = true;        // On active l'alerte
                    } else if (!hasCommerciaux) {
                        // Si l'agence n'a pas de commerciaux, on va dans le bilan avec commercial vide
                        finalCommercial = commercial || ''; // Commercial vide si pas de commerciaux dans l'agence
                        needsCommercial = false; // Pas d'alerte car pas de commercial requis
                    }
                    
                    // 5. V√©rifier si un tarif personnalis√© doit √™tre appliqu√© (apr√®s avoir d√©termin√© finalCommercial)
                    let prix = parseFloat(rdv.prix) || parseFloat(ag.prix) || 0;
                    const tarifPerso = getTarifPersonnalise(ag.id, finalCommercial, targetMonth);
                    if(tarifPerso !== null) {
                        prix = tarifPerso;
                    }
                    
                    const geste = parseFloat(rdv.geste_commercial) || 0;

                    // Si l'agence a des commerciaux ET que le commercial n'est pas choisi -> "√Ä traiter" avec alerte
                    if (hasCommerciaux && (!finalCommercial || finalCommercial === '' || finalCommercial === 'Je ne sais pas')) {
                        finalCommercial = '√Ä traiter'; // On force ce nom exact
                        needsCommercial = true;        // On active l'alerte
                    } else if (!hasCommerciaux) {
                        // Si l'agence n'a pas de commerciaux, on va dans le bilan avec commercial vide
                        finalCommercial = commercial || ''; // Commercial vide si pas de commerciaux dans l'agence
                        needsCommercial = false; // Pas d'alerte car pas de commercial requis
                    }

                    // 5. REGROUPEMENT (On cherche une ligne identique pour l'incr√©menter)
                    const existingLine = await db.collection('bilan_rdv')
                        .where('clientId', '==', ag.id)
                        .where('periodDate', '==', rdvDate)
                        .where('commercial', '==', finalCommercial) // On cherche la ligne '√Ä traiter'
                        .where('reporte', '==', false)
                        .get();

                    if (!existingLine.empty) {
                        // --- MISE √Ä JOUR (On ajoute +1 au compteur) ---
                        const existingDoc = existingLine.docs[0];
                        const existingData = existingDoc.data();
                        
                        const newRdvCount = (existingData.rdv || 0) + 1;
                        const newTotal = existingData.tarif * newRdvCount;
                        const newGeste = (existingData.gesteMontant || 0) + geste;
                        const newNetTotal = newTotal - newGeste;

                        const rdvIds = existingData.rdvIds || [];
                        if (!rdvIds.includes(rdv.id)) rdvIds.push(rdv.id);

                        await db.collection('bilan_rdv').doc(existingDoc.id).update({
                            rdv: newRdvCount,
                            total: newTotal,
                            netTotal: newNetTotal,
                            geste: newGeste > 0,
                            gesteMontant: newGeste,
                            rdvIds: rdvIds,
                            agence: ag.nom,
                            // Si c'est marqu√© "needsCommercial", √ßa reste true
                            needsCommercial: needsCommercial || existingData.needsCommercial || false
                        });
                        console.log('‚úÖ Bilan mis √† jour (ligne existante):', existingDoc.id);

                    } else {
                        // --- CR√âATION (Nouvelle ligne) ---
                        const newDocRef = await db.collection('bilan_rdv').add({
                            rdvId: rdv.id,
                            rdvIds: [rdv.id],
                            clientId: ag.id,
                            agence: ag.nom,
                            tarifPersonnalise: tarifPerso !== null,
                            commercial: finalCommercial, // Sera "√Ä traiter" si doute
                            rdv: 1,
                            tarif: prix,
                            total: prix,
                            netTotal: prix - geste,
                            date: rdvDate,
                            periodDate: rdvDate,
                            periodMonth: targetMonth,
                            reporte: false,
                            geste: geste > 0,
                            gesteMontant: geste,
                            needsCommercial: needsCommercial, // C'est ce true qui met l'alerte 
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        console.log('‚úÖ Nouvelle ligne bilan cr√©√©e:', newDocRef.id);
                    }
                } catch (e) {
                    console.error('‚ùå Erreur synchronisation Bilan:', e, rdv);
                    throw e; // Re-lancer l'erreur pour que l'appelant puisse la g√©rer
                }
            };
            
            const openDiscountModal = () => { discountModal.amount = null; discountModal.reason = ''; discountModal.customReason = ''; discountModal.error = ''; discountModal.open = true; };
            const saveDiscount = async () => {
                discountModal.error = '';
                if (!discountModal.amount && discountModal.amount !== 0) { discountModal.error = "Veuillez entrer un montant."; return; }
                let finalReason = discountModal.reason;
                if (finalReason === 'Autre') finalReason = discountModal.customReason;
                if (!finalReason) { discountModal.error = "Veuillez choisir ou saisir un motif."; return; }
                if (clientModal.rdv) {
                    clientModal.rdv.geste_commercial = discountModal.amount;
                    clientModal.rdv.motif_geste = finalReason;
                    await db.collection('rendezvous').doc(clientModal.rdv.id).update({ geste_commercial: discountModal.amount, motif_geste: finalReason });
                }
                discountModal.open = false;
            };
            const removeDiscount = async () => {
                openCustomConfirm("Supprimer le geste", "Voulez-vous retirer le geste commercial ?", async () => {
                    if (clientModal.rdv) {
                        clientModal.rdv.geste_commercial = null; clientModal.rdv.motif_geste = null;
                        await db.collection('rendezvous').doc(clientModal.rdv.id).update({ geste_commercial: firebase.firestore.FieldValue.delete(), motif_geste: firebase.firestore.FieldValue.delete() });
                        discountModal.open = false; customConfirmModal.open = false;
                    }
                });
            }

            // Fonction pour retirer un RDV du bilan
            const removeRdvFromBilan = async (rdvId) => {
                try {
                    if (!rdvId) return;
                    
                    // Chercher toutes les entr√©es du bilan qui contiennent ce RDV
                    const bilanEntries = await db.collection('bilan_rdv')
                        .where('rdvIds', 'array-contains', rdvId)
                        .get();
                    
                    if (bilanEntries.empty) {
                        // Essayer aussi avec rdvId (ancien format)
                        const oldFormatEntries = await db.collection('bilan_rdv')
                            .where('rdvId', '==', rdvId)
                            .get();
                        
                        if (!oldFormatEntries.empty) {
                            // Supprimer directement les entr√©es avec l'ancien format
                            const batch = db.batch();
                            oldFormatEntries.forEach(doc => {
                                batch.delete(doc.ref);
                            });
                            await batch.commit();
                        }
                        return;
                    }
                    
                    const batch = db.batch();
                    
                    bilanEntries.forEach(doc => {
                        const data = doc.data();
                        const rdvIds = data.rdvIds || [];
                        
                        // Si c'est le seul RDV dans cette ligne, supprimer la ligne compl√®te
                        if (rdvIds.length === 1) {
                            batch.delete(doc.ref);
                        } else {
                            // Sinon, retirer ce RDV de la liste et recalculer
                            const newRdvIds = rdvIds.filter(id => id !== rdvId);
                            const newRdvCount = newRdvIds.length;
                            const newTotal = data.tarif * newRdvCount;
                            
                            // Recalculer le geste commercial (on retire celui du RDV supprim√©)
                            // Note: on ne peut pas facilement r√©cup√©rer le geste du RDV supprim√©,
                            // donc on garde le gesteMontant actuel mais on ajuste le netTotal
                            const gesteMontant = data.gesteMontant || 0;
                            const newNetTotal = Math.max(0, newTotal - gesteMontant);
                            
                            batch.update(doc.ref, {
                                rdvIds: newRdvIds,
                                rdv: newRdvCount,
                                total: newTotal,
                                netTotal: newNetTotal
                            });
                        }
                    });
                    
                    await batch.commit();
                } catch (e) {
                    console.error('Erreur lors de la suppression du RDV du bilan:', e);
                }
            };

            const updateStatus = async (r, s) => { 
                if(s==='honor_fact') { openHonorCheck(r); return; } 
                
                // V√©rifier si le RDV √©tait honor√© avant le changement
                const wasHonored = r.statut === 'honore';
                
                const patch = { statut: s };
                if(s==='honor_free') { patch.statut='honore'; patch.honorBilling='gratuit'; launchFireworks(); } 
                if(s==='noshow') { patch.statut='pas_venu'; patch.honorBilling=null; const today = new Date().toISOString().split('T')[0]; let type = 'noshow'; if(r.date === today) type = 'noshow_today'; const link = generateMsgLink(r, type); if(link) window.open(link, '_blank'); } 
                if(s==='reset') { patch.statut='confirme'; patch.honorBilling=null; patch.motif=null; delete patch.geste_commercial; delete patch.motif_geste; patch.tag = null; } 
                // --- AJOUT : REMETTRE L'AGENDA COMME AVANT ---
                    if (r.dansAgenda && r.googleCalendarEventId) {
                        // On cr√©e une copie propre du RDV avec les nouvelles valeurs (statut confirm√©, plus de motif)
                        const cleanRdv = { ...r, ...patch };
                        // On lance la mise √† jour vers Google (qui va remettre la couleur et le titre d'origine)
                        if (googleCalendarConnected.value || prospecteurGoogleCalendarConnected.value) {
                             updateGoogleCalendarEvent(cleanRdv).then(() => console.log("Agenda r√©tabli (Reset)"));
                        }
                    }
                
                await db.collection('rendezvous').doc(r.id).update(patch); 
                Object.assign(r, patch);
                if(clientModal.rdv && clientModal.rdv.id === r.id) Object.assign(clientModal.rdv, patch);
                
                // Log de l'action
                logAction('changement_statut', {
                    rdvId: r.id,
                    client: `${r.civilite} ${r.nom}`,
                    ancienStatut: r.statut,
                    nouveauStatut: patch.statut,
                    date: r.date,
                    heure: r.heure
                });
                
                // Si le RDV √©tait honor√© et ne l'est plus, supprimer les transactions associ√©es et retirer du bilan
                if(wasHonored && patch.statut !== 'honore') {
                    await deleteTransactionsForRdv(r.id);
                    await removeRdvFromBilan(r.id); // Retirer automatiquement du bilan
                }
                
                // Cr√©er la transaction si le RDV est honor√©
                if(s==='honor_free') {
                    await createTransactionForRdv(r);
                    await checkAndCreateBonusTransactions(r.createdBy);
                    // Synchroniser avec le Bilan (sans commercial car honor_free)
                    await syncRdvToBilan(r, '');
                }
                
                clientModal.open = false; 
            };

            const launchFireworks = () => { for(let i=0; i<50; i++) { const c = document.createElement('div'); c.className = 'confetti'; c.style.left = Math.random() * 100 + 'vw'; c.style.top = -10 + 'px'; c.style.backgroundColor = ['#ff0', '#f00', '#0f0', '#00f', '#f0f'][Math.floor(Math.random()*5)]; c.style.animationDuration = (Math.random() * 2 + 1) + 's'; document.body.appendChild(c); setTimeout(() => c.remove(), 3000); } };

            const openRescheduleModal = async (r) => { 
                // V√©rifier la connexion Google avant d'ouvrir la modal
                if (!isGoogleCalendarConnected.value) {
                    showNotification('‚ö†Ô∏è Vous devez √™tre connect√© √† Google Calendar pour reporter un rendez-vous', 'error', 'fa-exclamation-triangle');
                    // Proposer de se connecter
                    if (user.role === 'admin') {
                        connectGoogleCalendar();
                    } else {
                        handleProspecteurGoogleCalendar();
                    }
                    return;
                }
                rescheduleModal.rdv = r; 
                rescheduleModal.date = r.date; 
                rescheduleModal.heure = r.heure; 
                rescheduleModal.oldDate = r.date; 
                rescheduleModal.oldHeure = r.heure; 
                rescheduleModal.motif = ''; 
                rescheduleModal.motifType = ''; 
                rescheduleModal.demandePar = ''; 
                rescheduleModal.autoSMS = false; 
                rescheduleModal.step = 1; 
                rescheduleModal.open = true; 
            };
            const handleMotifTypeChange = async () => {
                // R√©cup√©rer les textes de motifs depuis les settings globaux
                const rdv = rescheduleModal.rdv;
                let motifTexts = {
                    'meteo_route_dangereuse': 'Le rendez-vous a √©t√© report√© en raison des conditions m√©t√©orologiques (conditions de la route dangereuse : neige, verglas ou forte inondations)',
                    'vehicule_immobilise': 'Le rendez-vous a √©t√© report√© car le v√©hicule ne peut pas bouger',
                    'contrainte_pro': 'Le rendez-vous a √©t√© report√© car le client ne peut pas quitter son poste ou une r√©union de derni√®re minute l\'emp√™che de venir au rendez-vous',
                    'contrainte_personnelle': 'Le rendez-vous a √©t√© report√© car le client ne peut pas se d√©placer pour des raisons personnelles. Nous sommes dans l\'obligation de d√©placer le rendez-vous.',
                    'documents_manquants': 'Le rendez-vous a √©t√© report√© car le client se rend compte qu\'il n\'a pas tous les documents avec lui',
                    'empechement_medical': 'Le rendez-vous a √©t√© report√© pour motif de sant√© : incapacit√© de conduire, maladie soudaine, blessure ou fatigue extr√™me, rendant la conduite dangereuse pour le client',
                    // Motifs internes
                    'agence_fermee': 'Le rendez-vous a √©t√© report√© car notre agence sera ferm√©e ce jour-l√†',
                    'commercial_retard': 'Le rendez-vous a √©t√© report√© car le commercial aura un peu de retard',
                    'agence_retard': 'Le rendez-vous a √©t√© report√© car notre agence aura un peu de retard ce jour-l√†',
                    'intemperie': 'Le rendez-vous a √©t√© report√© en raison des intemp√©ries',
                    'absence_imprevue': 'Le rendez-vous a √©t√© report√© en raison d\'une absence impr√©vue'
                };
                
                // Charger les messages personnalis√©s depuis les settings globaux
                try {
                    const settingsDoc = await db.collection('settings').doc('rescheduleMessages').get();
                    const globalMessages = settingsDoc.exists ? settingsDoc.data() : {};
                    const customMessagesClient = globalMessages.rescheduleSMSMessagesClient || {};
                    const customMessagesInterne = globalMessages.rescheduleSMSMessages || {};
                    
                    // Si un message personnalis√© existe pour ce motif et que c'est une demande client, l'utiliser
                    if (rescheduleModal.demandePar === 'client' && rescheduleModal.motifType && customMessagesClient[rescheduleModal.motifType] && customMessagesClient[rescheduleModal.motifType].trim()) {
                        motifTexts[rescheduleModal.motifType] = customMessagesClient[rescheduleModal.motifType];
                    }
                    
                    // Si c'est une demande interne, charger le label du motif depuis rescheduleMotifsListInterne
                    if (rescheduleModal.demandePar === 'interne' && rescheduleModal.motifType && rescheduleMotifsListInterne[rescheduleModal.motifType]) {
                        // Utiliser le label du motif interne comme texte de motif
                        motifTexts[rescheduleModal.motifType] = `Le rendez-vous a √©t√© report√© : ${rescheduleMotifsListInterne[rescheduleModal.motifType]}`;
                    }
                } catch (err) {
                    console.error('Erreur chargement messages client:', err);
                }
                
                // Messages SMS automatiques pour certains motifs (avec vraies infos)
                const getSMSMessage = async (motifType) => {
                    const rdv = rescheduleModal.rdv;
                    if (!rdv) return '';
                    const ag = agences.value.find(a => a.id === rdv.agenceId) || {};
                    const baseModele = getBaseModele(rdv.modele || '');
                    
                    // Si demande interne : utiliser la date initiale, sinon la nouvelle date
                    let dateStr, heureStr;
                    if (rescheduleModal.demandePar === 'interne') {
                        dateStr = formatDateLong(rdv.date || '');
                        heureStr = rdv.heure || '';
                    } else {
                        dateStr = formatDateLong(rescheduleModal.date || rdv.date || '');
                        heureStr = rescheduleModal.heure || rdv.heure || '';
                    }
                    
                    try {
                        // Charger depuis les settings globaux
                        const settingsDoc = await db.collection('settings').doc('rescheduleMessages').get();
                        const globalMessages = settingsDoc.exists ? settingsDoc.data() : {};
                        
                        if (rescheduleModal.demandePar === 'interne') {
                            const customMessages = globalMessages.rescheduleSMSMessages || {};
                            // V√©rifier d'abord dans les messages personnalis√©s
                            if (customMessages[motifType] && customMessages[motifType].trim()) {
                                return customMessages[motifType]
                                    .replace(/{{DATE_LONG}}/g, dateStr)
                                    .replace(/{{HEURE}}/g, heureStr)
                                    .replace(/{{MODELE}}/g, baseModele)
                                    .replace(/{{AGENCE}}/g, ag.nom || '');
                            }
                            // Sinon utiliser les messages par d√©faut pour motifs internes
                            const defaultMessagesInterne = {
                                'agence_fermee': `Bonjour, nous vous informons que votre rendez-vous pr√©vu le ${dateStr} √† ${heureStr} √† notre agence ${ag.nom || ''} pour votre v√©hicule ${baseModele} doit √™tre report√© car notre agence sera ferm√©e ce jour-l√†. Nous vous contacterons prochainement pour convenir d'une nouvelle date. Merci de votre compr√©hension.`,
                                'commercial_retard': `Bonjour, nous vous informons que votre rendez-vous pr√©vu le ${dateStr} √† ${heureStr} √† notre agence ${ag.nom || ''} pour votre v√©hicule ${baseModele} doit √™tre report√© car le commercial aura un peu de retard. Nous vous contacterons prochainement pour convenir d'une nouvelle date. Merci de votre compr√©hension.`,
                                'agence_retard': `Bonjour, nous vous informons que votre rendez-vous pr√©vu le ${dateStr} √† ${heureStr} √† notre agence ${ag.nom || ''} pour votre v√©hicule ${baseModele} doit √™tre report√© car notre agence aura un peu de retard ce jour-l√†. Nous vous contacterons prochainement pour convenir d'une nouvelle date. Merci de votre compr√©hension.`,
                                'intemperie': `Bonjour, nous vous informons que votre rendez-vous pr√©vu le ${dateStr} √† ${heureStr} √† notre agence ${ag.nom || ''} pour votre v√©hicule ${baseModele} doit √™tre report√© en raison des intemp√©ries. Nous vous contacterons prochainement pour convenir d'une nouvelle date. Merci de votre compr√©hension.`,
                                'absence_imprevue': `Bonjour, nous vous informons que votre rendez-vous pr√©vu le ${dateStr} √† ${heureStr} √† notre agence ${ag.nom || ''} pour votre v√©hicule ${baseModele} doit √™tre report√© en raison d'une absence impr√©vue. Nous vous contacterons prochainement pour convenir d'une nouvelle date. Merci de votre compr√©hension.`
                            };
                            // V√©rifier si c'est un motif interne sp√©cifique
                            if (defaultMessagesInterne[motifType]) {
                                return defaultMessagesInterne[motifType];
                            }
                            // Message par d√©faut g√©n√©rique pour demande interne
                            return `Bonjour, nous vous informons que votre rendez-vous pr√©vu le ${dateStr} √† ${heureStr} √† notre agence ${ag.nom || ''} pour votre v√©hicule ${baseModele} doit √™tre report√©. Nous vous contacterons prochainement pour convenir d'une nouvelle date.`;
                        } else {
                            // √Ä la demande du client : pas de SMS
                            return '';
                        }
                    } catch (err) {
                        console.error('Erreur chargement message:', err);
                        // Fallback sur message par d√©faut
                        if (rescheduleModal.demandePar === 'interne') {
                            return `Bonjour, nous vous informons que votre rendez-vous pr√©vu le ${dateStr} √† ${heureStr} √† notre agence ${ag.nom || ''} pour votre v√©hicule ${baseModele} doit √™tre report√©. Nous vous contacterons prochainement pour convenir d'une nouvelle date.`;
                        }
                        return '';
                    }
                };
                
                if (rescheduleModal.motifType && motifTexts[rescheduleModal.motifType]) {
                    // Utiliser le message personnalis√© pour le motif (pour Google Agenda et la fiche)
                    if (rescheduleModal.demandePar === 'client') {
                        // √Ä la demande du client : utiliser le message configur√© (pas de SMS)
                        rescheduleModal.motif = motifTexts[rescheduleModal.motifType];
                        rescheduleModal.autoSMS = false;
                        rescheduleModal.smsMessage = '';
                    } else {
                        // Demande interne : utiliser le texte d√©taill√© par d√©faut
                        rescheduleModal.motif = motifTexts[rescheduleModal.motifType];
                        // Calculer le message SMS instantan√©ment (synchrone)
                        const rdv = rescheduleModal.rdv;
                        if (rdv) {
                            const ag = agences.value.find(a => a.id === rdv.agenceId) || {};
                            const baseModele = getBaseModele(rdv.modele || '');
                            let dateStr = formatDateLong(rdv.date || '');
                            let heureStr = rdv.heure || '';
                            
                            // Messages par d√©faut pour motifs internes (synchrone)
                            const defaultMessagesInterne = {
                                'agence_fermee': `Bonjour, nous vous informons que votre rendez-vous pr√©vu le ${dateStr} √† ${heureStr} √† notre agence ${ag.nom || ''} pour votre v√©hicule ${baseModele} doit √™tre report√© car notre agence sera ferm√©e ce jour-l√†. Nous vous contacterons prochainement pour convenir d'une nouvelle date. Merci de votre compr√©hension.`,
                                'commercial_retard': `Bonjour, nous vous informons que votre rendez-vous pr√©vu le ${dateStr} √† ${heureStr} √† notre agence ${ag.nom || ''} pour votre v√©hicule ${baseModele} doit √™tre report√© car le commercial aura un peu de retard. Nous vous contacterons prochainement pour convenir d'une nouvelle date. Merci de votre compr√©hension.`,
                                'agence_retard': `Bonjour, nous vous informons que votre rendez-vous pr√©vu le ${dateStr} √† ${heureStr} √† notre agence ${ag.nom || ''} pour votre v√©hicule ${baseModele} doit √™tre report√© car notre agence aura un peu de retard ce jour-l√†. Nous vous contacterons prochainement pour convenir d'une nouvelle date. Merci de votre compr√©hension.`,
                                'intemperie': `Bonjour, nous vous informons que votre rendez-vous pr√©vu le ${dateStr} √† ${heureStr} √† notre agence ${ag.nom || ''} pour votre v√©hicule ${baseModele} doit √™tre report√© en raison des intemp√©ries. Nous vous contacterons prochainement pour convenir d'une nouvelle date. Merci de votre compr√©hension.`,
                                'absence_imprevue': `Bonjour, nous vous informons que votre rendez-vous pr√©vu le ${dateStr} √† ${heureStr} √† notre agence ${ag.nom || ''} pour votre v√©hicule ${baseModele} doit √™tre report√© en raison d'une absence impr√©vue. Nous vous contacterons prochainement pour convenir d'une nouvelle date. Merci de votre compr√©hension.`
                            };
                            
                            // Charger les messages personnalis√©s de fa√ßon asynchrone mais mettre √† jour imm√©diatement avec le d√©faut
                            rescheduleModal.smsMessage = defaultMessagesInterne[rescheduleModal.motifType] || '';
                            rescheduleModal.autoSMS = !!rescheduleModal.smsMessage;
                            
                            // Ensuite charger depuis Firebase si disponible (mise √† jour en arri√®re-plan)
                            getSMSMessage(rescheduleModal.motifType).then(smsMsg => {
                                if (smsMsg && smsMsg.trim()) {
                                    rescheduleModal.smsMessage = smsMsg;
                                }
                            });
                        }
                    }
                } else if (rescheduleModal.motifType === 'autre') {
                    rescheduleModal.motif = '';
                    rescheduleModal.autoSMS = false;
                    rescheduleModal.smsMessage = '';
                }
            };
            
            // Fonction pour s√©lectionner un motif depuis le modal moderne
            const selectMotif = (motifType) => {
                rescheduleModal.motifType = motifType;
                motifSelectionModal.open = false;
                handleMotifTypeChange();
            };
            
            // Fonction pour obtenir le label d'un motif
            const getMotifLabel = (motifType) => {
                // Utiliser les motifs personnalis√©s depuis l'agence si disponibles
                const rdv = rescheduleModal.rdv;
                const demandePar = rescheduleModal.demandePar;
                
                // Si demande interne, utiliser les motifs internes
                if (demandePar === 'interne') {
                    if (rdv) {
                        const ag = agences.value.find(a => a.id === rdv.agenceId);
                        if (ag && ag.rescheduleMotifsListInterne && ag.rescheduleMotifsListInterne[motifType]) {
                            return ag.rescheduleMotifsListInterne[motifType];
                        }
                    }
                    return rescheduleMotifsListInterne[motifType] || 'üìã S√©lectionner un motif...';
                }
                
                // Sinon utiliser les motifs pour demande client
                if (rdv) {
                    const ag = agences.value.find(a => a.id === rdv.agenceId);
                    if (ag && ag.rescheduleMotifsList && ag.rescheduleMotifsList[motifType]) {
                        return ag.rescheduleMotifsList[motifType];
                    }
                }
                return rescheduleMotifsList[motifType] || 'üìã S√©lectionner un motif...';
            };
            const confirmRescheduleStep1 = async () => { 
                if (!rescheduleModal.demandePar) return alert('Veuillez s√©lectionner le type de demande');
                if (rescheduleModal.demandePar === 'client' && (!rescheduleModal.date || !rescheduleModal.heure)) return alert('Date/Heure requises pour un report √† la demande du client'); 
                if(!rescheduleModal.motif || rescheduleModal.motif.trim() === '') {
                    return alert('Le motif du d√©placement est obligatoire');
                }
                
                // Si demande interne, garder la date/heure initiale
                const newDate = rescheduleModal.demandePar === 'interne' ? rescheduleModal.rdv.date : rescheduleModal.date;
                const newHeure = rescheduleModal.demandePar === 'interne' ? rescheduleModal.rdv.heure : rescheduleModal.heure;
                const oldInfo = `Ancien : ${formatDateFr(rescheduleModal.rdv.date)} √† ${rescheduleModal.rdv.heure}`;
                const motifText = rescheduleModal.motif ? ` Motif: ${rescheduleModal.motif}` : '';
                const note = { text: `üìÖ RDV Report√©. ${oldInfo}${motifText}`, author: 'Syst√®me', date: new Date().toISOString() };
                let notes = rescheduleModal.rdv.notes || []; notes.push(note);
                
                // Mettre √† jour le RDV avec le motif de d√©placement
                const updateData = { 
                    date: newDate, 
                    heure: newHeure, 
                    notes: notes, 
                    rappelFait: false,
                    motifDeplacement: rescheduleModal.motif || null,
                    oldDate: rescheduleModal.oldDate,
                    oldHeure: rescheduleModal.oldHeure
                };
                
                await db.collection('rendezvous').doc(rescheduleModal.rdv.id).update(updateData); 
                
                // Mettre √† jour l'objet local
                Object.assign(rescheduleModal.rdv, updateData);
                if(clientModal.rdv && clientModal.rdv.id === rescheduleModal.rdv.id) { 
                    Object.assign(clientModal.rdv, updateData);
                }
                
                // Mettre √† jour l'√©v√©nement Google Calendar si pr√©sent
                if (googleCalendarConnected.value && googleAccessToken.value && rescheduleModal.rdv.dansAgenda && rescheduleModal.rdv.googleCalendarEventId) {
                    try {
                        await updateGoogleCalendarEvent(rescheduleModal.rdv);
                    } catch (err) {
                        console.error('Erreur lors de la mise √† jour Google Calendar:', err);
                    }
                }
                
                rescheduleModal.step = 2; 
            };
            const sendRescheduleSMS = () => {
                // Si un SMS automatique est d√©fini, l'utiliser
                if (rescheduleModal.autoSMS && rescheduleModal.smsMessage) {
                    const smsLink = generateMsgLink(rescheduleModal.rdv, 'reschedule', rescheduleModal.smsMessage);
                    if (smsLink) window.open(smsLink, '_blank');
                } else {
                    const link = generateMsgLink(rescheduleModal.rdv, 'reschedule');
                    if (link) window.open(link, '_blank');
                }
                rescheduleModal.open = false;
                clientModal.open = false;
                rescheduleModal.step = 1;
            };
            const openReschedule = (r) => openRescheduleModal(r);
            
            const changeView = async (v) => { 
                view.value = v; 
                displayLimit.value = 20; 
                if(v !== 'list') { currentFilter.value = 'all'; } 
                selectedIds.value = [];
                
                // Charger les transactions si on acc√®de au portefeuille (prospecteur)
                if (v === 'portefeuille' && user.role !== 'admin' && user.name) {
                    await loadUserTransactions();
                }
            };
            
            const loadUserTransactions = async () => {
                try {
                    // D√©truire l'ancien listener s'il existe
                    if (transactionListener) {
                        transactionListener();
                        transactionListener = null;
                    }
                    
                    // Cr√©er les transactions manquantes pour les RDV d√©j√† honor√©s
                    await createMissingTransactionsForUser(user.name);
                    
                    // Charger d'abord les transactions une fois pour avoir les donn√©es imm√©diatement
                try {
                    const transSnapshot = await db.collection('transactions')
                        .where('userId', '==', user.name)
                        .get();
                    
                    transactions.value = transSnapshot.docs.map(doc => {
                        const data = doc.data();
                        return {
                            id: doc.id,
                            ...data,
                            date: data.date && data.date.toDate ? data.date.toDate() : (data.date ? new Date(data.date) : new Date())
                        };
                        });
                        
                        // Trier par date d√©croissante
                        transactions.value.sort((a, b) => {
                            const dateA = a.date instanceof Date ? a.date.getTime() : new Date(a.date).getTime();
                            const dateB = b.date instanceof Date ? b.date.getTime() : new Date(b.date).getTime();
                            return dateB - dateA;
                        });
                    } catch (loadErr) {
                        console.error('Erreur chargement initial transactions:', loadErr);
                    }
                    
                    // Cr√©er un listener en temps r√©el pour les transactions (sans orderBy pour √©viter les probl√®mes d'index)
                    const query = db.collection('transactions')
                        .where('userId', '==', user.name);
                    
                    transactionListener = query.onSnapshot(snap => {
                        const newTransactions = snap.docs.map(doc => {
                            const data = doc.data();
                            return {
                                id: doc.id,
                                ...data,
                                date: data.date && data.date.toDate ? data.date.toDate() : (data.date ? new Date(data.date) : new Date())
                            };
                        });
                        
                        // Trier par date d√©croissante
                        newTransactions.sort((a, b) => {
                            const dateA = a.date instanceof Date ? a.date.getTime() : new Date(a.date).getTime();
                            const dateB = b.date instanceof Date ? b.date.getTime() : new Date(b.date).getTime();
                            return dateB - dateA;
                        });
                        
                        transactions.value = newTransactions;
                    }, err => {
                        console.error('Erreur listener transactions:', err);
                        // En cas d'erreur, recharger une fois
                        db.collection('transactions')
                            .where('userId', '==', user.name)
                            .get()
                            .then(transSnapshot => {
                                transactions.value = transSnapshot.docs.map(doc => {
                                    const data = doc.data();
                                    return {
                                        id: doc.id,
                                        ...data,
                                        date: data.date && data.date.toDate ? data.date.toDate() : (data.date ? new Date(data.date) : new Date())
                                    };
                                });
                                transactions.value.sort((a, b) => {
                                    const dateA = a.date instanceof Date ? a.date.getTime() : new Date(a.date).getTime();
                                    const dateB = b.date instanceof Date ? b.date.getTime() : new Date(b.date).getTime();
                                    return dateB - dateA;
                                });
                            });
                    });
                } catch (err) {
                    console.error('Erreur chargement transactions utilisateur:', err);
                    transactions.value = [];
                }
            };

            // Cr√©er les transactions manquantes pour les RDV honor√©s qui n'ont pas encore de transaction
            const createMissingTransactionsForUser = async (userId) => {
                try {
                    // R√©cup√©rer tous les RDV honor√©s de cet utilisateur
                    const honoredRdvs = rdvList.value.filter(r => 
                        r.statut === 'honore' && r.createdBy === userId
                    );
                    
                    if (honoredRdvs.length === 0) return;
                    
                    // R√©cup√©rer toutes les transactions existantes pour cet utilisateur
                    const existingTrans = await db.collection('transactions')
                        .where('userId', '==', userId)
                        .get();
                    
                    const existingRdvIds = new Set();
                    existingTrans.docs.forEach(doc => {
                        const data = doc.data();
                        if (data.rdvId && data.type === 'rdv_honore') {
                            existingRdvIds.add(data.rdvId);
                        }
                    });
                    
                    // Cr√©er les transactions manquantes
                    const transactionsToCreate = [];
                    
                    const basePrice = parseFloat(globalCommission.base) || 10;
                    
                    for (const rdv of honoredRdvs) {
                        if (existingRdvIds.has(rdv.id)) continue;
                        
                        const transactionData = {
                            userId: userId,
                            type: 'rdv_honore',
                            amount: basePrice,
                            label: `RDV honor√© - ${rdv.civilite} ${rdv.nom}${rdv.tag === 'OK M' ? ' (OK M)' : ''}`,
                            date: rdv.date ? new Date(rdv.date) : new Date(),
                            rdvId: rdv.id,
                            agenceId: rdv.agenceId || null,
                            hidden: false,
                            createdAt: new Date()
                        };
                        
                        transactionsToCreate.push(transactionData);
                    }
                    
                    // Cr√©er les transactions par batch de 500
                    if (transactionsToCreate.length > 0) {
                        for (let i = 0; i < transactionsToCreate.length; i += 500) {
                            const batch = db.batch();
                            const batchData = transactionsToCreate.slice(i, i + 500);
                            
                            batchData.forEach(transactionData => {
                                const transactionRef = db.collection('transactions').doc();
                                batch.set(transactionRef, transactionData);
                            });
                            
                            await batch.commit();
                        }
                    }
                    
                    // V√©rifier et cr√©er les transactions de bonus apr√®s avoir cr√©√© les transactions RDV
                    await checkAndCreateBonusTransactions(userId);
                } catch (err) {
                    console.error('Erreur cr√©ation transactions manquantes:', err);
                }
            };
            const resetListFilters = () => { search.value = ''; listFilters.agenceId = ''; listFilters.date = ''; listFilters.prospecteur = ''; currentFilter.value = 'all'; displayLimit.value=20; };
            const showUpcoming = () => { currentFilter.value = 'upcoming'; view.value = 'list'; displayLimit.value=20; fromDashboard.value = true; };
            const showLive = () => { currentFilter.value = 'live'; view.value = 'list'; displayLimit.value=20; fromDashboard.value = true; };
            const showHonored = () => { currentFilter.value = 'honored'; view.value = 'list'; displayLimit.value=20; fromDashboard.value = true; };
            const showNoShow = () => { currentFilter.value = 'noshow'; view.value = 'list'; displayLimit.value=20; fromDashboard.value = true; };
            const showCancelled = () => { currentFilter.value = 'cancelled'; view.value = 'list'; displayLimit.value=20; fromDashboard.value = true; };
            const goBackFromList = () => { if (fromDashboard.value) { view.value = 'dashboard'; fromDashboard.value = false; resetListFilters(); } else { resetListFilters(); } };

            const filteredAgences = computed(() => { 
                let source = visibleAgencies.value;
                // Ne pas filtrer les agences ferm√©es, on veut les afficher avec un message
                if(!agencySearch.value) return source; 
                const s = agencySearch.value.toLowerCase(); 
                return source.filter(ag => ag.nom.toLowerCase().includes(s)); 
            });
            const trashList = computed(() => rdvList.value.filter(r => r.statut === 'poubelle'));
            const trashCount = computed(() => trashList.value.length);
            const restoreRdv = (r) => { selectedIds.value = [r.id]; openBulkConfirm('restore_trash', 'Restaurer ce rendez-vous ?'); };
            const hardDeleteRdv = (r) => { selectedIds.value = [r.id]; openBulkConfirm('delete_trash', 'Supprimer D√âFINITIVEMENT ce rendez-vous ? (Irr√©versible)'); };

            const isEnCours = (r) => { if(!r.date || !r.heure) return false; const start = new Date(r.date+'T'+r.heure); const end = new Date(start.getTime() + 60*60*1000); return now.value >= start && now.value < end && ['confirme','a_confirmer'].includes(r.statut); };
            const activeRdvCount = computed(() => rdvList.value.filter(r => isEnCours(r)).length);

            const filteredList = computed(() => { 
                let l = rdvList.value.filter(r => r.statut !== 'poubelle'); 
                if (listFilters.agenceId) l = l.filter(r => r.agenceId === listFilters.agenceId);
                if (listFilters.prospecteur) l = l.filter(r => r.createdBy === listFilters.prospecteur);
                if (listFilters.date) l = l.filter(r => r.date === listFilters.date);
                if (currentFilter.value === 'upcoming') { if (!listFilters.date) { const today = new Date().toISOString().split('T')[0]; l = l.filter(r => r.statut === 'confirme' && r.date >= today); } } 
                else if (currentFilter.value === 'live') l = l.filter(r => isEnCours(r));
                else if (currentFilter.value === 'honored') {
                    l = l.filter(r => r.statut === 'honore');
                    // Filtrer par mois actuel par d√©faut (utiliser les filtres du dashboard si on vient du dashboard)
                    const moisFilter = fromDashboard.value && dashboardFilters.mois ? dashboardFilters.mois : null;
                    const anneeFilter = fromDashboard.value && dashboardFilters.annee ? dashboardFilters.annee : null;
                    if (!listFilters.date) {
                        // Si on vient du dashboard, utiliser ses filtres, sinon utiliser le mois/ann√©e actuels
                        const targetDate = new Date();
                        const targetMonth = moisFilter ? parseInt(moisFilter) - 1 : targetDate.getMonth();
                        const targetYear = anneeFilter ? parseInt(anneeFilter) : targetDate.getFullYear();
                        l = l.filter(r => {
                            if (!r.date) return false;
                            const d = new Date(r.date);
                            return d.getMonth() === targetMonth && d.getFullYear() === targetYear;
                        });
                    }
                }
                else if (currentFilter.value === 'noshow') l = l.filter(r => r.statut === 'pas_venu');
                else if (currentFilter.value === 'cancelled') l = l.filter(r => r.statut === 'annule');
                if (search.value) { const s = search.value.toLowerCase(); const sDigits = normalizePhone(search.value); l = l.filter(r => (r.nom || '').toLowerCase().includes(s) || (r.modele || '').toLowerCase().includes(s) || (sDigits && normalizePhone(r.telephone).includes(sDigits))); } 
                const noBaseFilter = currentFilter.value === 'all' && !listFilters.agenceId && !listFilters.prospecteur && !listFilters.date && !search.value;
                if (noBaseFilter) return [];
                return l.sort((a, b) => { if (a.date !== b.date) return a.date.localeCompare(b.date); return (a.heure || '').localeCompare(b.heure || ''); });
            });
            const displayedList = computed(() => filteredList.value.slice(0, displayLimit.value));

            const allProspectors = computed(() => { const activeTeam = teamList.value.map(u => u.name); const admins = adminNamesList.value; return Array.from(new Set([...activeTeam, ...admins])).sort(); });
            
            // Filtrer uniquement les prospecteurs (sans les admins)
            const onlyProspectors = computed(() => {
                return teamList.value.filter(u => {
                    const isAdminName = adminNamesList.value.includes(u.name);
                    const isAdminRole = u.role === 'admin';
                    return !isAdminName && !isAdminRole;
                });
            });
            
            // Computed pour les commerciaux d'une agence dans le modal RDV rapide
            const quickRdvCommerciaux = computed(() => {
                if (!quickRdvModal.agenceId) return [];
                const ag = agences.value.find(a => a.id === quickRdvModal.agenceId);
                if (!ag) return [];
                
                // R√©cup√©rer les commerciaux depuis teamList
                const teamCommerciaux = teamList.value.filter(u => 
                    u.role === 'commercial' && 
                    (u.agenceId === quickRdvModal.agenceId || 
                     (u.assignedAgencies && u.assignedAgencies.includes(quickRdvModal.agenceId)))
                );
                
                // R√©cup√©rer les commerciaux depuis les r√©glages de l'agence
                const settingsCommerciaux = [];
                if (ag.commerciauxDetails && ag.commerciauxDetails.length > 0) {
                    // Si commerciauxDetails existe, utiliser les noms
                    ag.commerciauxDetails.forEach(c => {
                        const commercialName = typeof c === 'string' ? c : c.name;
                        // V√©rifier si ce commercial n'est pas d√©j√† dans teamCommerciaux
                        if (!teamCommerciaux.find(tc => tc.name === commercialName)) {
                            settingsCommerciaux.push({
                                id: `setting_${commercialName.replace(/\s+/g, '_')}`,
                                name: commercialName
                            });
                        }
                    });
                } else if (ag.commerciaux && ag.commerciaux.length > 0) {
                    // Si commerciaux existe (tableau de strings)
                    ag.commerciaux.forEach(commercialName => {
                        // V√©rifier si ce commercial n'est pas d√©j√† dans teamCommerciaux
                        if (!teamCommerciaux.find(tc => tc.name === commercialName)) {
                            settingsCommerciaux.push({
                                id: `setting_${commercialName.replace(/\s+/g, '_')}`,
                                name: commercialName
                            });
                        }
                    });
                }
                
                // Combiner les deux listes
                return [...teamCommerciaux, ...settingsCommerciaux];
            });
            
            const quickRdvHasCommerciaux = computed(() => {
                if (!quickRdvModal.agenceId) return false;
                const ag = agences.value.find(a => a.id === quickRdvModal.agenceId);
                if (!ag) return false;
                // V√©rifier si l'agence a des commerciaux dans ses settings
                const hasCommerciauxInSettings = (ag.commerciaux && ag.commerciaux.length > 0) || (ag.commerciauxDetails && ag.commerciauxDetails.length > 0);
                // V√©rifier aussi dans teamList
                const hasCommerciauxInTeam = quickRdvCommerciaux.value.length > 0;
                return hasCommerciauxInSettings || hasCommerciauxInTeam;
            });
            const selectAll = (e) => { const list = view.value === 'trash' ? trashList.value : filteredList.value; if(e.target.checked) { selectedIds.value = list.map(r => r.id); } else { selectedIds.value = []; } };
            const toggleSelection = (id) => { if(selectedIds.value.includes(id)) { selectedIds.value = selectedIds.value.filter(i => i !== id); } else { selectedIds.value.push(id); } };
            const isAllSelected = computed(() => { const list = view.value === 'trash' ? trashList.value : filteredList.value; return list.length > 0 && selectedIds.value.length === list.length; });

            const openBulkConfirm = (action, label) => { bulkModal.action = action; bulkModal.label = label; bulkModal.open = true; };
            const openCustomConfirm = (title, message, onConfirm) => { customConfirmModal.title = title; customConfirmModal.message = message; customConfirmModal.onConfirm = onConfirm; customConfirmModal.open = true; };
            const executeBulkAction = async () => {
                const batch = db.batch();
                if (bulkModal.action === 'soft_delete') { 
                    // Capturer les IDs √† supprimer
                    const idsToDelete = [...selectedIds.value];
                    
                    // Vider selectedIds.value IMM√âDIATEMENT
                    selectedIds.value = [];
                    
                    // Fermer la modale IMM√âDIATEMENT
                    bulkModal.open = false;
                    
                    // Mettre √† jour la liste locale IMM√âDIATEMENT (changer le statut visuellement)
                    idsToDelete.forEach(id => {
                        const rdv = rdvList.value.find(r => r.id === id);
                        if(rdv) {
                            rdv.statut = 'poubelle';
                            rdv.dansAgenda = false;
                            rdv.googleCalendarEventId = null;
                        }
                    });
                    
                    // Effectuer ensuite la suppression Firebase
                    idsToDelete.forEach(id => { 
                        const ref = db.collection('rendezvous').doc(id); 
                        
                        // --- AJOUT : SUPPRESSION AUTOMATIQUE DE GOOGLE AGENDA ---
                        // On retrouve le RDV complet dans la liste pour avoir son ID Google
                        const rdvToDelete = rdvList.value.find(r => r.id === id);
                        
                        if (rdvToDelete && rdvToDelete.dansAgenda && rdvToDelete.googleCalendarEventId) {
                            // On lance la suppression Google
                            if (googleCalendarConnected.value || prospecteurGoogleCalendarConnected.value) {
                                deleteGoogleCalendarEvent(rdvToDelete).catch(err => console.error(err));
                            }
                            // On met √† jour la base pour dire qu'il n'est plus dans l'agenda
                            batch.update(ref, { statut: 'poubelle', dansAgenda: false, googleCalendarEventId: null }); 
                        } else {
                            // Si pas dans l'agenda, on met juste √† la poubelle
                        batch.update(ref, { statut: 'poubelle' }); 
                        }
                        // --------------------------------------------------------
                    }); 
                    await batch.commit();
                    
                    // Retirer du bilan tous les RDV supprim√©s
                    for (const id of idsToDelete) {
                        await removeRdvFromBilan(id);
                    }
                }
                else if (bulkModal.action === 'restore_selection' || bulkModal.action === 'restore_trash') { 
                    selectedIds.value.forEach(id => { 
                        const ref = db.collection('rendezvous').doc(id); 
                        batch.update(ref, { statut: 'confirme' }); 
                    }); 
                    await batch.commit();
                }
                else if (bulkModal.action === 'delete_selection' || bulkModal.action === 'delete_trash') { 
                    // 1. Capturer les IDs √† supprimer dans une constante
                    const idsToDelete = [...selectedIds.value];
                    
                    // 2. Vider selectedIds.value IMM√âDIATEMENT
                    selectedIds.value = [];
                    
                    // 3. Fermer la modale IMM√âDIATEMENT
                    bulkModal.open = false;
                    
                    // 4. Mettre √† jour la liste locale IMM√âDIATEMENT (retirer visuellement)
                    rdvList.value = rdvList.value.filter(r => !idsToDelete.includes(r.id));
                    
                    // 5. Effectuer ensuite la boucle de suppression Firebase (Bilan, Google Calendar et Firestore)
                    // Retirer du bilan avant de supprimer d√©finitivement
                    for (const id of idsToDelete) {
                        await removeRdvFromBilan(id);
                    }
                    // Supprimer les √©v√©nements Google Calendar avant de supprimer les RDV
                    if (googleCalendarConnected.value && googleAccessToken.value) {
                        for (const id of idsToDelete) {
                            const rdv = rdvList.value.find(r => r.id === id);
                            if (rdv && rdv.dansAgenda && rdv.googleCalendarEventId) {
                                try {
                                    await deleteGoogleCalendarEvent(rdv);
                                } catch (err) {
                                    console.error('Erreur suppression Google Calendar:', err);
                                }
                            }
                        }
                    }
                    // Supprimer de Firestore
                    idsToDelete.forEach(id => { 
                        const ref = db.collection('rendezvous').doc(id); 
                        batch.delete(ref); 
                    }); 
                    await batch.commit();
                }
                else if (bulkModal.action === 'empty_trash') { 
                    // Capturer les IDs √† supprimer
                    const idsToDelete = trashList.value.map(r => r.id);
                    
                    // Fermer la modale IMM√âDIATEMENT
                    bulkModal.open = false;
                    
                    // Mettre √† jour la liste locale IMM√âDIATEMENT (retirer visuellement)
                    rdvList.value = rdvList.value.filter(r => !idsToDelete.includes(r.id));
                    
                    // Effectuer ensuite la suppression Firebase
                    // Retirer du bilan avant de vider la corbeille
                    for (const id of idsToDelete) {
                        const r = trashList.value.find(rdv => rdv.id === id);
                        if(r) {
                            await removeRdvFromBilan(r.id);
                        }
                    }
                    // Supprimer les √©v√©nements Google Calendar avant de vider la corbeille
                    if (googleCalendarConnected.value && googleAccessToken.value) {
                        for (const r of trashList.value) {
                            if (r.dansAgenda && r.googleCalendarEventId) {
                                try {
                                    await deleteGoogleCalendarEvent(r);
                                } catch (err) {
                                    console.error('Erreur suppression Google Calendar:', err);
                                }
                            }
                        }
                    }
                    // Supprimer de Firestore
                    trashList.value.forEach(r => { 
                        const ref = db.collection('rendezvous').doc(r.id); 
                        batch.delete(ref); 
                    }); 
                    await batch.commit();
                }
                else { 
                    let patch = {}; 
                    if (bulkModal.action === 'honor_fact') { 
                        patch = { statut: 'honore', honorBilling: 'facture' }; 
                    } else if (bulkModal.action === 'noshow') { 
                        patch = { statut: 'pas_venu', honorBilling: null }; 
                    } 
                    if(Object.keys(patch).length > 0) { 
                        // Retirer du bilan les RDV qui √©taient honor√©s et ne le sont plus
                        if (bulkModal.action === 'noshow') {
                            for (const id of selectedIds.value) {
                                const rdv = rdvList.value.find(r => r.id === id);
                                if (rdv && rdv.statut === 'honore') {
                                    await removeRdvFromBilan(id);
                                }
                            }
                        }
                        selectedIds.value.forEach(id => { 
                            const ref = db.collection('rendezvous').doc(id); 
                            batch.update(ref, patch); 
                        }); 
                    } 
                    await batch.commit();
                }
                
                // Cr√©er les transactions pour les RDV honor√©s en masse
                if (bulkModal.action === 'honor_fact') {
                    for (const id of selectedIds.value) {
                        const rdv = rdvList.value.find(r => r.id === id);
                        if (rdv) {
                            await createTransactionForRdv(rdv);
                        }
                    }
                }
                
                // Ne pas vider selectedIds ici car c'est d√©j√† fait dans chaque bloc de suppression
                // bulkModal.open est aussi d√©j√† ferm√© dans chaque bloc
                // S'assurer que selectedIds est vide si on arrive ici et que la modale n'a pas √©t√© ferm√©e
                if(selectedIds.value.length > 0 && bulkModal.action !== 'delete_selection' && bulkModal.action !== 'delete_trash' && bulkModal.action !== 'soft_delete' && bulkModal.action !== 'empty_trash') {
                    selectedIds.value = [];
                }
                // Fermer la modale si elle n'a pas √©t√© ferm√©e dans le bloc sp√©cifique
                if(bulkModal.open && (bulkModal.action === 'restore_selection' || bulkModal.action === 'restore_trash' || bulkModal.action === 'honor_fact' || bulkModal.action === 'noshow')) {
                    bulkModal.open = false;
                }
            };

            const formatDateFr = (d) => d ? new Date(d).toLocaleDateString('fr-FR') : '';
            const formatDateShort = (d) => d ? new Date(d).toLocaleDateString('fr-FR', {day:'numeric', month:'short'}) : '';
            const formatDateLong = (d) => d ? new Date(d).toLocaleDateString('fr-FR', {weekday:'long', day:'numeric', month:'long'}) : '';
            const formatPrice = (p) => new Intl.NumberFormat('fr-FR', {style:'currency', currency:'EUR'}).format(p);
            
            // Fonction pour formater le prix avec des espaces et d√©cimales (ex: 1111111 -> 1 111 111,00)
            const formatPrixInput = (e) => {
                let value = e.target.value;
                
                // Enlever tous les espaces existants
                value = value.replace(/\s/g, '');
                
                // Remplacer les points par des virgules (format fran√ßais)
                value = value.replace(/\./g, ',');
                
                // Garder seulement les chiffres et virgules
                value = value.replace(/[^\d,]/g, '');
                
                // S'assurer qu'il n'y a qu'une seule virgule
                const parts = value.split(',');
                if (parts.length > 2) {
                    value = parts[0] + ',' + parts.slice(1).join('');
                }
                
                // Si la valeur est vide ou juste une virgule
                if (!value || value === ',') {
                    form.prix = null;
                    e.target.value = '';
                    return;
                }
                
                // Limiter √† 2 d√©cimales apr√®s la virgule
                let partsForFormat = value.split(',');
                if (partsForFormat.length === 2 && partsForFormat[1].length > 2) {
                    value = partsForFormat[0] + ',' + partsForFormat[1].substring(0, 2);
                    partsForFormat = value.split(',');
                }
                
                // Convertir en nombre (remplacer virgule par point pour parseFloat)
                const numValue = parseFloat(value.replace(',', '.')) || 0;
                if (numValue < 0 || isNaN(numValue)) {
                    form.prix = null;
                    e.target.value = '';
                    return;
                }
                
                // Formater avec des espaces pour les milliers et virgule pour les d√©cimales
                const integerPart = partsForFormat[0] || '0';
                let decimalPart = partsForFormat[1] || '';
                
                // Si l'utilisateur est en train de taper (pas de virgule encore), ne pas ajouter ,00
                if (!value.includes(',')) {
                    const formatted = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
                    form.prix = numValue;
                    e.target.value = formatted;
                    return;
                }
                
                // Si on a une virgule, formater avec les d√©cimales
                if (decimalPart.length === 0) {
                    decimalPart = '00';
                } else if (decimalPart.length === 1) {
                    decimalPart = decimalPart + '0';
                } else {
                    decimalPart = decimalPart.substring(0, 2);
                }
                
                const formatted = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ' ') + ',' + decimalPart;
                
                form.prix = numValue;
                e.target.value = formatted;
            };
            
            // Fonction pour g√©rer le collage dans le champ prix
            const handlePrixPaste = (e) => {
                e.preventDefault();
                const pastedText = (e.clipboardData || window.clipboardData).getData('text');
                
                // Nettoyer le texte coll√©
                let cleaned = pastedText.replace(/\s/g, ''); // Enlever les espaces
                cleaned = cleaned.replace(/‚Ç¨/g, ''); // Enlever le symbole ‚Ç¨
                cleaned = cleaned.replace(/EUR/g, ''); // Enlever EUR
                cleaned = cleaned.replace(/euros?/gi, ''); // Enlever "euro" ou "euros"
                
                // Remplacer les points par des virgules (format fran√ßais)
                cleaned = cleaned.replace(/\./g, ',');
                
                // Garder seulement les chiffres et virgules
                cleaned = cleaned.replace(/[^\d,]/g, '');
                
                // S'assurer qu'il n'y a qu'une seule virgule
                let parts = cleaned.split(',');
                if (parts.length > 2) {
                    cleaned = parts[0] + ',' + parts.slice(1).join('');
                    parts = cleaned.split(',');
                }
                
                if (!cleaned || cleaned === ',') {
                    form.prix = null;
                    e.target.value = '';
                    return;
                }
                
                // Limiter √† 2 d√©cimales apr√®s la virgule
                if (parts.length === 2 && parts[1].length > 2) {
                    cleaned = parts[0] + ',' + parts[1].substring(0, 2);
                    parts = cleaned.split(',');
                }
                
                // Convertir en nombre
                const numValue = parseFloat(cleaned.replace(',', '.')) || 0;
                if (numValue < 0 || isNaN(numValue)) {
                    form.prix = null;
                    e.target.value = '';
                    return;
                }
                
                // Formater avec des espaces pour les milliers et virgule pour les d√©cimales
                const integerPart = parts[0] || '0';
                let decimalPart = parts[1] || '00';
                
                // Si pas de d√©cimales, ajouter ,00
                if (parts.length === 1) {
                    decimalPart = '00';
                } else if (decimalPart.length === 0) {
                    decimalPart = '00';
                } else if (decimalPart.length === 1) {
                    decimalPart = decimalPart + '0';
                } else {
                    decimalPart = decimalPart.substring(0, 2);
                }
                
                const formatted = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ' ') + ',' + decimalPart;
                
                form.prix = numValue;
                e.target.value = formatted;
            };
            
            // Fonction pour formater le nom du v√©hicule (premi√®re lettre en majuscule, acronymes en majuscules)
            const formatModeleName = (text) => {
                if (!text) return '';
                // Mettre tout en majuscules
                return text.toUpperCase();
            };
            
            // Helper pour convertir les timestamps Firestore en Date
            const getCreatedDate = (rdv) => {
                if (!rdv || !rdv.created) return null;
                try {
                    let date = null;
                    if (rdv.created && typeof rdv.created.toDate === 'function') {
                        date = rdv.created.toDate();
                    } else if (rdv.created && rdv.created.seconds) {
                        date = new Date(rdv.created.seconds * 1000);
                    } else if (rdv.created) {
                        date = new Date(rdv.created);
                    }
                    // V√©rifier que la date est valide
                    if (date && !isNaN(date.getTime())) {
                        return date;
                    }
                } catch (e) {
                    console.error('Erreur conversion date:', e);
                }
                return null;
            };
            
            const getCreatedTime = (rdv) => {
                const date = getCreatedDate(rdv);
                if (!date) return '';
                try {
                    return date.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});
                } catch (e) {
                    return '';
                }
            };
            const getAgenceName = (id) => agences.value.find(a=>a.id===id)?.nom || 'Inconnue';
            // Fonction pour obtenir le prix de l'agence (utilise le prix de l'agence, pas celui du RDV)
            const getAgencePrice = (rdv) => {
                if (!rdv || !rdv.agenceId) return 0;
                const agence = agences.value.find(a => a.id === rdv.agenceId);
                return agence ? parseFloat(agence.prix) || 0 : 0;
            };
            const getRappelType = (r) => { if (!r.date) return 'rappel'; const today = new Date(); today.setHours(0,0,0,0); const d = new Date(r.date); d.setHours(0,0,0,0); const diffDays = Math.round((d - today) / 86400000); if (diffDays === 0) return 'rappel_today'; return 'rappel'; };
            const getRappelLabel = (r) => { const type = getRappelType(r); if(type === 'rappel_today') return 'Rappel Aujourd\'hui'; return 'Rappel Demain'; };
            
            // Fonction pour d√©tecter les p√©riodes de f√™tes et retourner un message appropri√©
            const getFeteMessage = () => {
                const now = new Date();
                const month = now.getMonth() + 1; // 1-12
                const day = now.getDate();
                const year = now.getFullYear();
                
                // Nouvel An (tout le mois de janvier)
                if(month === 1) {
                    return "üéâ Bonne ann√©e ! üéâ\n\n";
                }
                
                // Saint-Valentin (14 f√©vrier)
                if(month === 2 && day === 14) {
                    return "üíù Joyeuse Saint-Valentin ! üíù\n\n";
                }
                
                // P√¢ques (calcul approximatif : premier dimanche apr√®s la premi√®re pleine lune apr√®s l'√©quinoxe de printemps)
                // Pour simplifier, on prend g√©n√©ralement entre fin mars et fin avril
                // Approximation : entre le 22 mars et le 25 avril
                const easterDate = getEasterDate(year);
                const easterDay = easterDate.getDate();
                const easterMonth = easterDate.getMonth() + 1;
                if(month === easterMonth && day >= easterDay && day <= easterDay + 7) {
                    return "üê∞ Joyeuses P√¢ques ! üê∞\n\n";
                }
                
                // F√™te du Travail (1er mai)
                if(month === 5 && day === 1) {
                    return "üåπ Bon 1er mai ! üåπ\n\n";
                }
                
                // F√™te des M√®res (approximation : dernier dimanche de mai ou premier dimanche de juin)
                // Pour simplifier, on prend la p√©riode autour du 1er juin
                if(month === 6 && day >= 1 && day <= 7) {
                    return "üíê Joyeuse f√™te des M√®res ! üíê\n\n";
                }
                
                // F√™te des P√®res (approximation : troisi√®me dimanche de juin)
                if(month === 6 && day >= 15 && day <= 21) {
                    return "üëî Joyeuse f√™te des P√®res ! üëî\n\n";
                }
                
                // F√™te Nationale (14 juillet)
                if(month === 7 && day === 14) {
                    return "üá´üá∑ Bonne f√™te nationale ! üá´üá∑\n\n";
                }
                
                // Assomption (15 ao√ªt)
                if(month === 8 && day === 15) {
                    return "üôè Bonne f√™te de l'Assomption ! üôè\n\n";
                }
                
                // Toussaint (1er novembre)
                if(month === 11 && day === 1) {
                    return "üïØÔ∏è Bonne Toussaint ! üïØÔ∏è\n\n";
                }
                
                // Armistice (11 novembre)
                if(month === 11 && day === 11) {
                    return "üá´üá∑ Jour du Souvenir üá´üá∑\n\n";
                }
                
                // No√´l (24-26 d√©cembre)
                if(month === 12 && day >= 24 && day <= 26) {
                    return "üéÑ Joyeux No√´l ! üéÑ\n\n";
                }
                
                // Nouvel An (31 d√©cembre)
                if(month === 12 && day === 31) {
                    return "üéä Bonne ann√©e ! üéä\n\n";
                }
                
                return '';
            };
            
            // Fonction pour calculer la date de P√¢ques (algorithme de Gauss)
            const getEasterDate = (year) => {
                const a = year % 19;
                const b = Math.floor(year / 100);
                const c = year % 100;
                const d = Math.floor(b / 4);
                const e = b % 4;
                const f = Math.floor((b + 8) / 25);
                const g = Math.floor((b - f + 1) / 3);
                const h = (19 * a + b - d - g + 15) % 30;
                const i = Math.floor(c / 4);
                const k = c % 4;
                const l = (32 + 2 * e + 2 * i - h - k) % 7;
                const m = Math.floor((a + 11 * h + 22 * l) / 451);
                const month = Math.floor((h + l - 7 * m + 114) / 31);
                const day = ((h + l - 7 * m + 114) % 31) + 1;
                return new Date(year, month - 1, day);
            };
            
            const generateMsgLink = (data, type, customMessage = null) => {
                // 1. On r√©cup√®re l'agence concern√©e
                const ag = agences.value.find(a => a.id === data.agenceId) || data.agence || {};
                
                // 2. On r√©cup√®re vos mod√®les personnalis√©s (depuis R√©glages > Messages)
                const tpls = ag.templates || {}; 
                
                // 3. Si un message personnalis√© est fourni, l'utiliser directement
                let tpl = customMessage;
                
                // 4. Sinon, on essaie de trouver le message personnalis√© correspondant au type (ex: 'cancel_clt')
                if (!tpl) tpl = tpls[type]; 
                
                // 5. Si vous n'avez pas cr√©√© de message perso, on prend le message par d√©faut
                if (!tpl) tpl = getDefaultTemplate(type); 
                
                // Pr√©paration des variables sp√©ciales
                const showPrice = user.role === 'admin'; 
                const prixStr = (showPrice && ag.prix) ? (ag.prix + '‚Ç¨ ' + (ag.tva ? 'TTC' : 'HT')) : ''; 
                
                let dateRappelStr = ''; 
                if (data.date) { 
                    const today = new Date(); 
                    today.setHours(0,0,0,0); 
                    today.setMinutes(0,0,0);
                    today.setSeconds(0,0);
                    today.setMilliseconds(0);
                    let d;
                    if (typeof data.date === 'string') {
                        // Si c'est une cha√Æne au format YYYY-MM-DD, on la parse correctement
                        if (data.date.match(/^\d{4}-\d{2}-\d{2}/)) {
                            d = new Date(data.date + 'T00:00:00');
                        } else if (data.date.match(/^\d{2}\/\d{2}\/\d{4}/)) {
                            // Format DD/MM/YYYY
                            const parts = data.date.split('/');
                            d = new Date(parts[2] + '-' + parts[1] + '-' + parts[0] + 'T00:00:00');
                        } else {
                            d = new Date(data.date);
                        }
                    } else if (data.date instanceof Date) {
                        d = new Date(data.date.getTime());
                    } else {
                        d = new Date(data.date);
                    }
                    d.setHours(0,0,0,0);
                    d.setMinutes(0,0,0);
                    d.setSeconds(0,0);
                    d.setMilliseconds(0);
                    const diffDays = Math.floor((d.getTime() - today.getTime()) / 86400000); 
                    if (diffDays === 0) {
                        dateRappelStr = "aujourd'hui";
                    } else if (diffDays === 1) {
                        dateRappelStr = "demain le " + formatDateLong(data.date);
                    } else {
                        dateRappelStr = "le " + formatDateLong(data.date);
                    } 
                }
                
                let oldDateLong = ''; let oldHeure = ''; 
                if(type === 'reschedule' && rescheduleModal.oldDate) { 
                    oldDateLong = formatDateLong(rescheduleModal.oldDate); 
                    oldHeure = rescheduleModal.oldHeure || ''; 
                }

                // 5. On remplace les balises (dont {{MOTIF}} et {{RDV_LINK}})
                const rdvLink = data.rdvLinkId ? getRdvClientLink(data.rdvLinkId) : '';
                let msg = tpl
                    .replace(/{{CIVILITE}}/g, data.civilite||'')
                    .replace(/{{NOM}}/g, data.nom||'')
                    .replace(/{{PRENOM}}/g, data.nom||'')
                    .replace(/{{DATE_LONG}}/g, formatDateLong(data.date))
                    .replace(/{{DATE_RAPPEL}}/g, dateRappelStr || formatDateLong(data.date))
                    .replace(/{{HEURE}}/g, data.heure||'')
                    .replace(/{{MODELE}}/g, data.modele||'')
                    .replace(/{{AGENCE}}/g, ag.nom||'')
                    .replace(/{{ADRESSE}}/g, ag.adresse||'')
                    .replace(/{{PLAN}}/g, ag.maps||'')
                    .replace(/{{PRIX}}/g, prixStr)
                    .replace(/{{TAGLINE}}/g, ag.tagline||ag.nom||'')
                    .replace(/{{RDV_LINK}}/g, rdvLink)
                    // C'est ici que le motif d'annulation est inject√© dans votre message perso
                    .replace(/{{MOTIF}}/g, data.motif || ''); 

                if(type === 'reschedule' && rescheduleModal.oldDate) { 
                    msg = msg.replace(/{{OLD_DATE_LONG}}/g, oldDateLong).replace(/{{OLD_HEURE}}/g, oldHeure); 
                }
                
                // Remplacer "demain" en dur dans le template personnalis√© par la date calcul√©e (pour les rappels)
                if((type === 'rappel' || type === 'rappel_today') && data.date && dateRappelStr) {
                    // On remplace "demain" par la date calcul√©e selon si c'est aujourd'hui, demain ou apr√®s-demain
                    // On utilise \b pour matcher uniquement le mot "demain" et pas "demain" dans d'autres mots
                    msg = msg.replace(/\bdemain\b/gi, dateRappelStr);
                }
                
                // Ajouter le message de f√™te au d√©but pour les confirmations
                if(type === 'confirm') {
                    const feteMsg = getFeteMessage();
                    if(feteMsg) {
                        msg = feteMsg + msg;
                    }
                }
                
                const sep = navigator.userAgent.toLowerCase().includes('iphone') ? '&' : '?'; 
                return `sms:${normalizePhone(data.telephone)}${sep}body=${encodeURIComponent(msg)}`;
            };
            
            // Fonction pour obtenir le texte du message format√© (pour l'aper√ßu d√©roulable)
            const getMessagePreviewText = (rdv, type) => {
                // Si rdv.agence est un objet, l'utiliser directement, sinon chercher par ID
                const ag = rdv.agence && typeof rdv.agence === 'object' ? rdv.agence : (agences.value.find(a => a.id === rdv.agenceId) || rdv.agence || {});
                const tpls = ag.templates || {};
                let tpl = tpls[type] || getDefaultTemplate(type);
                
                const showPrice = user.role === 'admin';
                const prixStr = (showPrice && ag.prix) ? (ag.prix + '‚Ç¨ ' + (ag.tva ? 'TTC' : 'HT')) : '';
                
                let dateRappelStr = '';
                if (rdv.date) {
                    const today = new Date();
                    today.setHours(0,0,0,0);
                    today.setMinutes(0,0,0);
                    today.setSeconds(0,0);
                    today.setMilliseconds(0);
                    let d;
                    if (typeof rdv.date === 'string') {
                        // Si c'est une cha√Æne au format YYYY-MM-DD, on la parse correctement
                        if (rdv.date.match(/^\d{4}-\d{2}-\d{2}/)) {
                            d = new Date(rdv.date + 'T00:00:00');
                        } else if (rdv.date.match(/^\d{2}\/\d{2}\/\d{4}/)) {
                            // Format DD/MM/YYYY
                            const parts = rdv.date.split('/');
                            d = new Date(parts[2] + '-' + parts[1] + '-' + parts[0] + 'T00:00:00');
                        } else {
                            d = new Date(rdv.date);
                        }
                    } else if (rdv.date instanceof Date) {
                        d = new Date(rdv.date.getTime());
                    } else {
                        d = new Date(rdv.date);
                    }
                    d.setHours(0,0,0,0);
                    d.setMinutes(0,0,0);
                    d.setSeconds(0,0);
                    d.setMilliseconds(0);
                    const diffDays = Math.floor((d.getTime() - today.getTime()) / 86400000);
                    if (diffDays === 0) {
                        dateRappelStr = "aujourd'hui";
                    } else if (diffDays === 1) {
                        dateRappelStr = "demain le " + formatDateLong(rdv.date);
                    } else {
                        dateRappelStr = "le " + formatDateLong(rdv.date);
                    }
                }
                
                const rdvLink = rdv.rdvLinkId ? getRdvClientLink(rdv.rdvLinkId) : '';
                let msg = tpl
                    .replace(/{{CIVILITE}}/g, rdv.civilite||'')
                    .replace(/{{NOM}}/g, rdv.nom||'')
                    .replace(/{{PRENOM}}/g, rdv.nom||'')
                    .replace(/{{DATE_LONG}}/g, formatDateLong(rdv.date))
                    .replace(/{{DATE_RAPPEL}}/g, dateRappelStr || formatDateLong(rdv.date))
                    .replace(/{{HEURE}}/g, rdv.heure||'')
                    .replace(/{{MODELE}}/g, rdv.modele||'')
                    .replace(/{{AGENCE}}/g, ag.nom||'')
                    .replace(/{{ADRESSE}}/g, ag.adresse||'')
                    .replace(/{{PLAN}}/g, ag.maps||'')
                    .replace(/{{PRIX}}/g, prixStr)
                    .replace(/{{TAGLINE}}/g, ag.tagline||ag.nom||'')
                    .replace(/{{RDV_LINK}}/g, rdvLink)
                    .replace(/{{MOTIF}}/g, rdv.motif || '');
                
                // Remplacer "demain" en dur dans le template personnalis√© par la date calcul√©e (pour les rappels)
                if((type === 'rappel' || type === 'rappel_today') && rdv.date && dateRappelStr) {
                    // On remplace "demain" par la date calcul√©e selon si c'est aujourd'hui, demain ou apr√®s-demain
                    // On utilise \b pour matcher uniquement le mot "demain" et pas "demain" dans d'autres mots
                    msg = msg.replace(/\bdemain\b/gi, dateRappelStr);
                }
                
                if(type === 'confirm') {
                    const feteMsg = getFeteMessage();
                    if(feteMsg) {
                        msg = feteMsg + msg;
                    }
                }
                
                return msg;
            };
            
            // Fonction pour afficher l'aper√ßu du message (modale)
            const showMessagePreview = (rdv, type) => {
                const message = getMessagePreviewText(rdv, type);
                messagePreviewModal.message = message;
                messagePreviewModal.title = type === 'confirm' ? 'Aper√ßu - Message de confirmation' : (type === 'rappel' || type === 'rappel_today' ? 'Aper√ßu - Message de rappel' : 'Aper√ßu du message');
                messagePreviewModal.open = true;
            };
            
            const getDefaultTemplate = (t) => { 
                if(t==='confirm') return "Bonjour {{NOM}}, RDV confirm√© le {{DATE_LONG}} √† {{HEURE}} chez {{AGENCE}}.\n\nüìÖ G√©rez votre rendez-vous : {{RDV_LINK}}"; 
                if(t==='reschedule') return "Report Confirm√© ‚Äì {{AGENCE}}\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\nBonjour,\nVotre rendez-vous du {{OLD_DATE_LONG}} √† {{OLD_HEURE}} est report√©.\n\n‚óÜ Nouveau RDV :\n‚Üí Date & Heure : {{DATE_LONG}} √† {{HEURE}}\n‚Üí Mod√®le : {{MODELE}}\n‚óÜ Lieu : {{ADRESSE}}\n\nMerci de nous pr√©venir en cas d'impr√©vu\n\n√Ä bient√¥t,\nL'√©quipe {{AGENCE}}"; 
                if(t==='rappel') return "Bonjour, vous avez un rendez-vous {{DATE_RAPPEL}} √† {{HEURE}} chez {{AGENCE}}."; 
                if(t==='rappel_today') return "Bonjour, vous avez un rendez-vous aujourd'hui √† {{HEURE}} chez {{AGENCE}}."; 
                if(t==='noshow') return "Bonjour {{NOM}}, vous n'√™tes pas venu au RDV."; 
                if(t==='noshow_today') return "Bonjour {{NOM}}, vous aviez RDV aujourd'hui √† {{HEURE}} chez {{AGENCE}}. Vous n'√™tes pas venu."; 
                if(t==='cancel_clt') return "Bonjour {{NOM}},\n\nVotre rendez-vous du {{DATE_LONG}} √† {{HEURE}} chez {{AGENCE}} a √©t√© annul√©.\n\nMotif : {{MOTIF}}\n\nNous restons √† votre disposition pour reprogrammer un nouveau rendez-vous.\n\nCordialement,\nL'√©quipe {{AGENCE}}"; 
                if(t==='cancel_ag') return "Bonjour {{NOM}},\n\nNous sommes au regret de vous informer que votre rendez-vous du {{DATE_LONG}} √† {{HEURE}} chez {{AGENCE}} a √©t√© annul√©.\n\nMotif : {{MOTIF}}\n\nNous vous contacterons prochainement pour reprogrammer un nouveau rendez-vous.\n\nCordialement,\nL'√©quipe {{AGENCE}}"; 
                return ""; 
            };
            // Fonction pour g√©n√©rer l'aper√ßu du message avec variables remplac√©es
            const getMessagePreview = (ag, type) => {
                if(!ag) return '';
                
                // R√©cup√©rer le template
                const tpls = ag.templates || {};
                let tpl = tpls[type] || getDefaultTemplate(type);
                
                // Donn√©es d'exemple pour l'aper√ßu
                const exempleData = {
                    nom: 'Dupont',
                    civilite: 'M.',
                    date: new Date().toISOString().split('T')[0],
                    heure: '14:30',
                    modele: 'Peugeot 308',
                    agence: ag.nom || 'Nom de l\'agence',
                    adresse: ag.adresse || 'Adresse de l\'agence',
                    maps: ag.maps || 'https://maps.google.com',
                    prix: ag.prix ? (ag.prix + '‚Ç¨ ' + (ag.tva ? 'TTC' : 'HT')) : '',
                    tagline: ag.tagline || ag.nom || ''
                };
                
                // Calculer la date pour l'aper√ßu
                const today = new Date();
                today.setHours(0,0,0,0);
                const rdvDate = new Date(exempleData.date);
                rdvDate.setHours(0,0,0,0);
                const diffDays = Math.round((rdvDate - today) / 86400000);
                let dateRappelStr = '';
                if (diffDays === 0) dateRappelStr = "aujourd'hui";
                else if (diffDays === 1) dateRappelStr = "demain";
                else dateRappelStr = formatDateLong(exempleData.date);
                
                // Remplacer les variables
                let msg = tpl
                    .replace(/{{CIVILITE}}/g, exempleData.civilite)
                    .replace(/{{NOM}}/g, exempleData.nom)
                    .replace(/{{PRENOM}}/g, exempleData.nom)
                    .replace(/{{DATE_LONG}}/g, formatDateLong(exempleData.date))
                    .replace(/{{DATE_RAPPEL}}/g, dateRappelStr)
                    .replace(/{{HEURE}}/g, exempleData.heure)
                    .replace(/{{MODELE}}/g, exempleData.modele)
                    .replace(/{{AGENCE}}/g, exempleData.agence)
                    .replace(/{{ADRESSE}}/g, exempleData.adresse)
                    .replace(/{{PLAN}}/g, exempleData.maps)
                    .replace(/{{PRIX}}/g, exempleData.prix)
                    .replace(/{{TAGLINE}}/g, exempleData.tagline)
                    .replace(/{{MOTIF}}/g, '');
                
                // Ajouter le message de f√™te pour les confirmations
                if(type === 'confirm') {
                    const feteMsg = getFeteMessage();
                    if(feteMsg) {
                        msg = feteMsg + msg;
                    }
                }
                
                return msg;
            };
            
            const openSettings = () => { 
                settingsModal.open = true; 
                if(agences.value.length) {
                    editingMsgAgence.value = agences.value[0];
                    // Si on est dans l'onglet SMS Reports, charger les messages
                    if(settingsModal.tab === 'SMSReports') {
                        loadRescheduleSMSMessages();
                    }
                }
            };
            const openAgencyEdit = async (ag) => { 
                if(ag) { 
                    editingAgency.value = JSON.parse(JSON.stringify(ag)); 
                    if(editingAgency.value.motif_pause && !['Vacances','Complet','Travaux'].includes(editingAgency.value.motif_pause)) { 
                        pauseReasonSelect.value = 'Autre'; 
                    } else { 
                        pauseReasonSelect.value = editingAgency.value.motif_pause || 'Vacances'; 
                    }
                    // Initialiser la liste des commerciaux pour l'√©dition
                    if(editingAgency.value.commerciauxDetails) {
                        editingAgencyCommerciaux.value = JSON.parse(JSON.stringify(editingAgency.value.commerciauxDetails));
                    } else if(editingAgency.value.commerciaux) {
                        editingAgencyCommerciaux.value = editingAgency.value.commerciaux.map(name => ({ name, obj: 0 }));
                    } else {
                        editingAgencyCommerciaux.value = [];
                    }
                    // Initialiser la liste des fermetures exceptionnelles
                    if(editingAgency.value.fermeturesExceptionnelles && Array.isArray(editingAgency.value.fermeturesExceptionnelles)) {
                        editingAgencyFermetures.value = JSON.parse(JSON.stringify(editingAgency.value.fermeturesExceptionnelles));
                    } else {
                        editingAgencyFermetures.value = [];
                    }
                } else { 
                    editingAgency.value = { nom:'', adresse:'', maps:'', tagline:'', agendaEmail:'', agendaColor:'3', tva:true, prix:0, templates:{}, heureOuverture:'', heureFermeture:'', heurePauseDebut:'', heurePauseFin:'', horairesIdentiques:false, dimancheFerme:false, samediFerme:false, heureLimiteExceptionnelle:'', motifHeureLimite:'' }; 
                    editingAgencyCommerciaux.value = [];
                    editingAgencyFermetures.value = [];
                } 
                if(!editingAgency.value.statut_activite) editingAgency.value.statut_activite = 'actif'; 
                if(!editingAgency.value.agendaColor) editingAgency.value.agendaColor = '3'; 
                if(!editingAgency.value.heureOuverture) editingAgency.value.heureOuverture = '08:00'; 
                if(!editingAgency.value.heureFermeture) editingAgency.value.heureFermeture = '19:00';
                
                // Plus besoin de charger la liste des agendas, on utilise directement l'email 
            // Initialiser les horaires par jour si non d√©finis
            for(let i = 0; i < 7; i++) {
                if(!editingAgency.value[`horaires_${i}_ouverture`]) editingAgency.value[`horaires_${i}_ouverture`] = '';
                if(!editingAgency.value[`horaires_${i}_fermeture`]) editingAgency.value[`horaires_${i}_fermeture`] = '';
            }
            if(editingAgency.value.horairesIdentiques === undefined) editingAgency.value.horairesIdentiques = false;
            if(editingAgency.value.dimancheFerme === undefined) editingAgency.value.dimancheFerme = false;
            if(editingAgency.value.samediFerme === undefined) editingAgency.value.samediFerme = false;
            if(!editingAgency.value.heureLimiteExceptionnelle) editingAgency.value.heureLimiteExceptionnelle = '';
            if(!editingAgency.value.motifHeureLimite) editingAgency.value.motifHeureLimite = '';
            };
            
            const addAgencyCommercial = () => {
                editingAgencyCommerciaux.value.push({ name: '', obj: 0 });
            };
            
            const removeAgencyCommercial = (idx) => {
                editingAgencyCommerciaux.value.splice(idx, 1);
            };
            
            const addAgencyFermeture = () => {
                editingAgencyFermetures.value.push({ date_debut: '', date_fin: '' });
            };
            
            const removeAgencyFermeture = (idx) => {
                editingAgencyFermetures.value.splice(idx, 1);
            };
            
            const isFermetureValide = (fermeture) => {
                return fermeture.date_debut && fermeture.date_fin && fermeture.date_debut <= fermeture.date_fin;
            };
            
            const saveFermetureIndividuelle = async (idx) => {
                const fermeture = editingAgencyFermetures.value[idx];
                if(!fermeture.date_debut || !fermeture.date_fin) {
                    alert('Veuillez remplir les deux dates');
                    return;
                }
                if(fermeture.date_debut > fermeture.date_fin) {
                    alert('La date de fin doit √™tre sup√©rieure ou √©gale √† la date de d√©but');
                    return;
                }
                // Sauvegarder imm√©diatement si l'agence existe d√©j√†
                if(editingAgency.value && editingAgency.value.id) {
                    if(!editingAgency.value.fermeturesExceptionnelles) {
                        editingAgency.value.fermeturesExceptionnelles = [];
                    }
                    // Mettre √† jour la fermeture dans l'agence
                    const existingIdx = editingAgency.value.fermeturesExceptionnelles.findIndex(f => 
                        f.date_debut === fermeture.date_debut && f.date_fin === fermeture.date_fin
                    );
                    if(existingIdx === -1) {
                        editingAgency.value.fermeturesExceptionnelles.push({...fermeture});
                    } else {
                        editingAgency.value.fermeturesExceptionnelles[existingIdx] = {...fermeture};
                    }
                    await db.collection('agences').doc(editingAgency.value.id).update({
                        fermeturesExceptionnelles: editingAgency.value.fermeturesExceptionnelles
                    });
                    showNotification('‚úÖ Fermeture exceptionnelle enregistr√©e !', 'success', 'fa-calendar-times');
                } else {
                    showNotification('‚úÖ Fermeture ajout√©e (sera enregistr√©e avec l\'agence)', 'success', 'fa-calendar-times');
                }
            };
            
            const applyHorairesToAllDays = () => {
                if(editingAgency.value.horairesIdentiques && editingAgency.value.heureOuverture && editingAgency.value.heureFermeture) {
                    for(let i = 0; i < 6; i++) { // Pas le dimanche
                        editingAgency.value[`horaires_${i}_ouverture`] = editingAgency.value.heureOuverture;
                        editingAgency.value[`horaires_${i}_fermeture`] = editingAgency.value.heureFermeture;
                    }
                }
            };
            const updatePauseReason = () => { if(pauseReasonSelect.value !== 'Autre') { editingAgency.value.motif_pause = pauseReasonSelect.value; } else { editingAgency.value.motif_pause = ''; } };
            const calculateTTC = () => { const ht = parseFloat(editingAgency.value.prix_ht) || 0; const tva = parseFloat(editingAgency.value.tva_taux) || 0; editingAgency.value.prix = (ht * (1 + (tva / 100))).toFixed(2); };
            const saveEditingAgency = async () => { 
                if(!editingAgency.value.nom) return;
                
                // Nettoyer les commerciaux vides et pr√©parer les donn√©es
                const cleanedCommerciaux = editingAgencyCommerciaux.value.filter(c => c.name && c.name.trim() !== '');
                editingAgency.value.commerciaux = cleanedCommerciaux.map(c => c.name);
                editingAgency.value.commerciauxDetails = cleanedCommerciaux;
                
                // Sauvegarder les fermetures exceptionnelles (nettoyer celles sans dates)
                const cleanedFermetures = editingAgencyFermetures.value.filter(f => f.date_debut && f.date_fin);
                editingAgency.value.fermeturesExceptionnelles = cleanedFermetures;
                
                if(editingAgency.value.id) { 
                    await db.collection('agences').doc(editingAgency.value.id).update(editingAgency.value); 
                } else { 
                    await db.collection('agences').add(editingAgency.value); 
                } 
                editingAgency.value = null;
                editingAgencyCommerciaux.value = [];
                editingAgencyFermetures.value = [];
            };
            const saveAgency = async (ag) => { await db.collection('agences').doc(ag.id).update(ag); };
            const deleteAgency = async (id) => { openCustomConfirm("Supprimer Agence", "Voulez-vous vraiment supprimer cette agence ?", async () => { await db.collection('agences').doc(id).delete(); customConfirmModal.open = false; }); };
            const addSource = async () => { if(!newSource.value) return; const updated = [...sourcesList.value, newSource.value]; await db.collection('settings').doc('global').set({sources:updated}, {merge:true}); newSource.value = ''; };
            const removeSource = async (src) => { const updated = sourcesList.value.filter(s => s !== src); await db.collection('settings').doc('global').set({sources:updated}, {merge:true}); };
            const addMotif = async () => { if(!newMotif.value) return; const updated = [...motifsList.value, newMotif.value]; await db.collection('settings').doc('global').set({motifs:updated}, {merge:true}); newMotif.value = ''; };
            const removeMotif = async (motif) => { const updated = motifsList.value.filter(m => m !== motif); await db.collection('settings').doc('global').set({motifs:updated}, {merge:true}); };
            const addCancelMotif = async () => { if(!newCancelMotif.value) return; const updated = [...cancelMotifsList.value, newCancelMotif.value]; await db.collection('settings').doc('global').set({cancelMotifs:updated}, {merge:true}); newCancelMotif.value = ''; };
            const removeCancelMotif = async (motif) => { const updated = cancelMotifsList.value.filter(m => m !== motif); await db.collection('settings').doc('global').set({cancelMotifs:updated}, {merge:true}); };
            const changeSourceLogo = async (src) => { const url = prompt("Entrez l'URL de l'image pour " + src + " :"); if(url) { const newLogos = { ...sourceLogos.value, [src]: url }; await db.collection('settings').doc('global').set({ logos: newLogos }, { merge: true }); } };
            const getLogo = (src) => { if(!src) return ''; if(sourceLogos.value && sourceLogos.value[src]) return sourceLogos.value[src]; const s = (src||'').toLowerCase().trim().replace(/\s+/g, ''); if(s.includes('coin') || s === 'leboncoin' || s === 'leboncoin') return 'https://upload.wikimedia.org/wikipedia/commons/e/e1/Leboncoin_Logo_2016.svg'; if(s.includes('centrale')) return 'https://play-lh.googleusercontent.com/y3t-tGfqK_uJ0XQYV9xLqXoXwzX_zXwX_XwX_XwX_XwX_XwX_XwX_XwX_XwX_XwX_XwX_XwX_XwX_XwX_XwX_XwX_XwX_Xw'; if(s.includes('facebook')) return 'https://upload.wikimedia.org/wikipedia/commons/b/b8/2021_Facebook_icon.svg'; if(s.includes('google')) return 'https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg'; return `https://www.google.com/s2/favicons?domain=${s.replace(/\s+/g,'')}.com&sz=64`; };
            const insertTag = (tag) => { if(!editingMsgAgence.value) return; const area = document.querySelector('textarea'); if(area) { area.setRangeText(tag, area.selectionStart, area.selectionEnd, 'end'); editingMsgAgence.value.templates[editingMsgType.value] = area.value; } };
            
            const dateOptions = computed(() => { const arr = []; const today = new Date(); const days = ['Dim','Lun','Mar','Mer','Jeu','Ven','Sam']; const months = ['Jan','F√©v','Mar','Avr','Mai','Juin','Juil','Ao√ªt','Sep','Oct','Nov','D√©c']; for(let i=0; i<14; i++) { const d = new Date(); d.setDate(today.getDate()+i); const year = d.getFullYear(); const month = String(d.getMonth() + 1).padStart(2, '0'); const day = String(d.getDate()).padStart(2, '0'); const localDateString = `${year}-${month}-${day}`; arr.push({ val: localDateString, dayName: days[d.getDay()], dayNum: d.getDate(), month: months[d.getMonth()], isToday: i === 0 }); } return arr; });
            // Cr√©neaux horaires respectant les heures d'ouverture/fermeture de l'agence
            const timeSlots = computed(() => {
                const slots = [];
                const agence = form.agence;
                
                // S√©curit√© de base
                if (!agence || !form.date) return [];

                // --- 1. CALCUL DU JOUR (100% FIABLE) ---
                const dateParts = form.date.split('-'); 
                const safeDate = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]); 
                const jsDay = safeDate.getDay(); 
                // Conversion : 0=Lundi ... 5=Samedi, 6=Dimanche
                const dayIndex = jsDay === 0 ? 6 : jsDay - 1;

                // --- 2. V√âRIFICATION DES FERMETURES STRICTES ---
                if (dayIndex === 6 && agence.dimancheFerme) return []; // Dimanche ferm√©
                if (dayIndex === 5 && agence.samediFerme) return [];   // Samedi ferm√©

                // --- 3. LOGIQUE INTELLIGENTE DES HORAIRES ---
                let heureOuverture = null;
                let heureFermeture = null;
                let heurePauseDebut = null;
                let heurePauseFin = null;

                // A. On regarde d'abord si ce jour a des horaires SP√âCIFIQUES remplis
                const specificOpen = agence[`horaires_${dayIndex}_ouverture`];
                const specificClose = agence[`horaires_${dayIndex}_fermeture`];

                if (specificOpen && specificClose) {
                    // PRIORIT√â 1 : L'utilisateur a rempli ce jour pr√©cis (ex: Samedi 09h-13h)
                    // On utilise ces heures-l√†, PEU IMPORTE si "M√™me horaire" est coch√© ou pas.
                    heureOuverture = specificOpen;
                    heureFermeture = specificClose;
                    heurePauseDebut = agence[`horaires_${dayIndex}_pauseDebut`] || null;
                    heurePauseFin = agence[`horaires_${dayIndex}_pauseFin`] || null;
                } 
                else if (agence.horairesIdentiques) {
                    // PRIORIT√â 2 : Rien de sp√©cifique n'est rempli, mais "M√™me horaire" est coch√©
                    // On utilise les horaires g√©n√©raux
                    heureOuverture = agence.heureOuverture || '09:00';
                    heureFermeture = agence.heureFermeture || '19:00';
                    heurePauseDebut = agence.heurePauseDebut || null;
                    heurePauseFin = agence.heurePauseFin || null;
                } 
                else {
                    // PRIORIT√â 3 : Rien de sp√©cifique et "M√™me horaire" d√©coch√© => C'est ferm√©
                    return [];
                }

                // --- 4. CALCUL DES CR√âNEAUX ---
                const parseTime = (timeStr) => {
                    if (!timeStr) return null;
                    const [hours, minutes] = timeStr.split(':').map(Number);
                    return hours * 60 + minutes;
                };
                
                const openMinutes = parseTime(heureOuverture);
                const closeMinutes = parseTime(heureFermeture);
                const pauseStartMinutes = parseTime(heurePauseDebut);
                const pauseEndMinutes = parseTime(heurePauseFin);
                
                // Si les heures sont invalides ou si ouverture >= fermeture
                if (openMinutes === null || closeMinutes === null || openMinutes >= closeMinutes) return [];
                
                // Boucle de 30 minutes
                for (let minutes = openMinutes; minutes < closeMinutes; minutes += 30) {
                    
                    // Gestion de la pause d√©jeuner
                    if (pauseStartMinutes !== null && pauseEndMinutes !== null) {
                        if (minutes >= pauseStartMinutes && minutes < pauseEndMinutes) continue;
                    }

                    // Gestion de l'heure limite exceptionnelle (ex: Hiver)
                    if (agence.heureLimiteExceptionnelle) {
                        const limiteMinutes = parseTime(agence.heureLimiteExceptionnelle);
                        // La limite s'applique seulement si elle est avant la fermeture normale
                        if (limiteMinutes && limiteMinutes < closeMinutes) {
                            if (minutes > limiteMinutes) continue; 
                        }
                    }
                    
                    // Cr√©ation du format HH:mm
                    const hours = Math.floor(minutes / 60);
                    const mins = minutes % 60;
                    const hStr = String(hours).padStart(2, '0');
                    const mStr = String(mins).padStart(2, '0');
                    slots.push(`${hStr}:${mStr}`);
                }
                
                return slots;
            });

            const commonCars = ref([
                "Renault Clio", "Renault Megane", "Renault Captur", "Renault Austral", "Renault Arkana", "Renault Zoe", "Renault Scenic", "Renault Espace", "Renault Twingo", "Renault Kangoo",
                "Peugeot 208", "Peugeot 2008", "Peugeot 308", "Peugeot 3008", "Peugeot 5008", "Peugeot 508", "Peugeot Rifter", "Peugeot Traveller",
                "Citroen C3", "Citroen C3 Aircross", "Citroen C4", "Citroen C5 Aircross", "Citroen C5 X", "Citroen Berlingo",
                "Volkswagen Golf", "Volkswagen Polo", "Volkswagen Tiguan", "Volkswagen T-Roc", "Volkswagen T-Cross", "Volkswagen Passat", "Volkswagen Touareg", "Volkswagen ID.3", "Volkswagen ID.4", "Volkswagen Golf R-Line",
                "Audi A1", "Audi A3", "Audi A4", "Audi A5", "Audi A6", "Audi Q2", "Audi Q3", "Audi Q5", "Audi Q7", "Audi Q8", "Audi RS3", "Audi RSQ3",
                "BMW S√©rie 1", "BMW S√©rie 3", "BMW S√©rie 5", "BMW X1", "BMW X3", "BMW X5", "BMW M2", "BMW M3", "BMW M4",
                "Mercedes Classe A", "Mercedes Classe C", "Mercedes Classe E", "Mercedes GLA", "Mercedes CLA", "Mercedes GLE", "Mercedes GLC",
                "Toyota Yaris", "Toyota Corolla", "Toyota C-HR", "Toyota RAV4", "Toyota Aygo", "Toyota Highlander",
                "Ford Fiesta", "Ford Puma", "Ford Focus", "Ford Kuga", "Ford Ranger", "Ford Mustang",
                "Fiat 500", "Fiat Panda", "Fiat Tipo", "Fiat 500X",
                "Dacia Sandero", "Dacia Duster", "Dacia Jogger", "Dacia Spring",
                "Hyundai Tucson", "Hyundai Kona", "Hyundai i20", "Hyundai i30", "Hyundai Ioniq 5",
                "Kia Sportage", "Kia Niro", "Kia Picanto", "Kia Rio", "Kia EV6",
                "Tesla Model 3", "Tesla Model Y", "Tesla Model S", "Tesla Model X",
                "Nissan Qashqai", "Nissan Juke", "Nissan X-Trail", "Nissan Leaf",
                "Mini Cooper", "Mini Countryman", "Mini Clubman",
                "Seat Ibiza", "Seat Leon", "Seat Arona", "Seat Ateca", "Seat Cupra",
                "Skoda Fabia", "Skoda Octavia", "Skoda Kamiq", "Skoda Karoq", "Skoda Kodiaq",
                "Volvo XC40", "Volvo XC60", "Volvo XC90",
                "Land Rover Evoque", "Land Rover Velar", "Land Rover Sport",
                "Porsche Macan", "Porsche Cayenne", "Porsche 911"
            ]);

            const getCalendarColor = (colorId) => {
                const colors = {
                    1: '#7986CB', // Lavender
                    2: '#33B679', // Sage
                    3: '#8E24AA', // Grape (Raisin)
                    4: '#E67C73', // Flamingo
                    5: '#F6BF26', // Banana
                    6: '#F4511E', // Tangerine
                    7: '#039BE5', // Peacock
                    8: '#616161', // Graphite
                    9: '#3F51B5', // Blueberry
                    10: '#0B8043', // Basil
                    11: '#D50000'  // Tomato
                };
                return colors[colorId] || colors[3]; // Par d√©faut Raisin
            };
            
            const pastePhoneNumber = async () => {
                try {
                    const text = await navigator.clipboard.readText();
                    if (text) {
                        let cleaned = text.replace(/^\+33/, '0').replace(/^0033/, '0').replace(/\D/g, '');
                        if (cleaned.startsWith('33') && cleaned.length === 11) cleaned = '0' + cleaned.substring(2);
                        if (cleaned.length > 10) cleaned = cleaned.substring(0, 10);
                        if (cleaned.length === 10) {
                            form.telephone = formatPhone(cleaned);
                            const digits = normalizePhone(form.telephone);
                            const exist = rdvList.value.find(r => normalizePhone(r.telephone) === digits);
                            if (exist) {
                                form.nom = exist.nom;
                                form.civilite = exist.civilite;
                                form.modele = exist.modele;
                                clientExists.value = true;
                            } else {
                                clientExists.value = false;
                            }
                        }
                    }
                } catch (err) {
                    console.error('Erreur collage:', err);
                }
            };
            
            // Fonctions Google Calendar API
            // IMPORTANT : Vous devez obtenir un Client ID Google OAuth 2.0
            // 1. Allez sur https://console.cloud.google.com/
            // 2. Cr√©ez un projet ou s√©lectionnez-en un
            // 3. Activez l'API Google Calendar
            // 4. Cr√©ez des identifiants OAuth 2.0 (Application Web)
            // 5. Ajoutez votre domaine dans les URI de redirection autoris√©s
            // 6. Copiez le Client ID et collez-le ci-dessous
            const GOOGLE_CLIENT_ID = '827395252951-arojm83q4sthmlf0gk8bvn9aa95kgijc.apps.googleusercontent.com';
            
           const initGoogleCalendar = () => {
                if (typeof google !== 'undefined' && google.accounts && GOOGLE_CLIENT_ID) {
                    googleTokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: GOOGLE_CLIENT_ID,
                        scope: 'https://www.googleapis.com/auth/calendar.events https://www.googleapis.com/auth/calendar.readonly',
                        callback: (tokenResponse) => {
                            if (tokenResponse.access_token) {
                                // 1. On r√©cup√®re l'email pour confirmer qui est connect√©
                                fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                                    headers: { 'Authorization': `Bearer ${tokenResponse.access_token}` }
                                })
                                .then(res => res.json())
                                .then(async (data) => {
                                    const email = data.email || '';
                                    
                                    // 2. SAUVEGARDE CLOUD (FIREBASE)
                                    // Seul l'admin a le droit d'√©craser le token global
                                    if (user.role === 'admin') {
                                        
                                        try {
                                            await db.collection('settings').doc('google_token').set({
                                                token: tokenResponse.access_token,
                                                email: 'agendacetnsolutions@gmail.com',
                                                updatedAt: new Date().toISOString()
                                            });
                                            
                                            // Mise √† jour locale imm√©diate pour l'admin
                                            googleAccessToken.value = tokenResponse.access_token;
                                            googleCalendarUserEmail.value = 'agendacetnsolutions@gmail.com';
                                            googleCalendarConnected.value = true;
                                            
                                            // Charger la liste des agendas
                                            await fetchGoogleCalendarList();
                                            
                                            // V√©rifier le token apr√®s connexion
                                            setTimeout(() => {
                                                checkAndUpdateTokenStatus();
                                            }, 1000);
                                            
                                            showNotification("‚úÖ Connexion Google r√©ussie avec agendacetnsolutions@gmail.com et synchronis√©e avec toute l'√©quipe !", 'success', 'fa-check-circle', false, null, 2000);
                                            
                                            // Si on venait du wizard, fermer le modal de connexion
                                            if (googleCalendarDisconnectedModal.fromWizard) {
                                                googleCalendarDisconnectedModal.open = false;
                                                googleCalendarDisconnectedModal.fromWizard = false;
                                            }
                                        } catch (e) {
                                            console.error("Erreur sauvegarde token:", e);
                                            showNotification("Erreur lors de la sauvegarde de la connexion.", 'error', 'fa-exclamation-triangle', false);
                                        }
                                    } else {
                                        showNotification("Seul un administrateur peut modifier la connexion Google Agenda principale.", 'error', 'fa-exclamation-triangle', false);
                                    }
                                })
                                .catch(err => console.error('Erreur r√©cup√©ration email:', err));
                            }
                        }
                    });
                    
                    // V√©rifier et restaurer le token sauvegard√© si admin
                    if (user.role === 'admin') {
                        const savedToken = localStorage.getItem('google_calendar_token');
                        const savedEmail = localStorage.getItem('google_calendar_email');
                        if (savedToken && savedEmail) {
                            // V√©rifier si le token est encore valide en testant une requ√™te
                            fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                                headers: { 'Authorization': `Bearer ${savedToken}` }
                            })
                            .then(async (res) => {
                                if (res.ok) {
                                    googleAccessToken.value = savedToken;
                                    googleCalendarUserEmail.value = savedEmail;
                                    googleCalendarConnected.value = true;
                                    // Charger la liste des agendas au d√©marrage
                                    await fetchGoogleCalendarList();
                                } else {
                                    // Token invalide, nettoyer
                                    localStorage.removeItem('google_calendar_token');
                                    localStorage.removeItem('google_calendar_email');
                                    localStorage.removeItem('google_calendar_token_date');
                                }
                            })
                            .catch(() => {
                                // Erreur, nettoyer
                                localStorage.removeItem('google_calendar_token');
                                localStorage.removeItem('google_calendar_email');
                                localStorage.removeItem('google_calendar_token_date');
                            });
                        }
                    }
                }
            };
            
            const connectGoogleCalendar = () => {
                // R√©voquer le token existant pour forcer le choix du compte √† chaque fois
                const revokeAndConnect = () => {
                    // R√©initialiser le TokenClient √† chaque connexion pour forcer le choix
                    if (typeof google !== 'undefined' && google.accounts && GOOGLE_CLIENT_ID) {
                        googleTokenClient = google.accounts.oauth2.initTokenClient({
                            client_id: GOOGLE_CLIENT_ID,
                            scope: 'https://www.googleapis.com/auth/calendar.events https://www.googleapis.com/auth/calendar.readonly',
                            callback: (tokenResponse) => {
                                if (tokenResponse.access_token) {
                                    // 1. On r√©cup√®re l'email pour confirmer qui est connect√©
                                    fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                                        headers: { 'Authorization': `Bearer ${tokenResponse.access_token}` }
                                    })
                                    .then(res => res.json())
                                    .then(async (data) => {
                                        const email = data.email || '';
                                        
                                        // 2. SAUVEGARDE CLOUD (FIREBASE)
                                        // Seul l'admin a le droit d'√©craser le token global
                                        if (user.role === 'admin') {
                                          
                                            
                                            try {
                                                await db.collection('settings').doc('google_token').set({
                                                    token: tokenResponse.access_token,
                                                    email: 'agendacetnsolutions@gmail.com',
                                                    updatedAt: new Date().toISOString()
                                                });
                                                
                                                // Mise √† jour locale imm√©diate pour l'admin
                                                googleAccessToken.value = tokenResponse.access_token;
                                                googleCalendarUserEmail.value = 'agendacetnsolutions@gmail.com';
                                                googleCalendarConnected.value = true;
                                                
                                                // Charger la liste des agendas
                                                await fetchGoogleCalendarList();
                                                
                                                // V√©rifier le token apr√®s connexion
                                                setTimeout(() => {
                                                    checkAndUpdateTokenStatus();
                                                }, 1000);
                                                
                                                showNotification("‚úÖ Connexion Google r√©ussie avec agendacetnsolutions@gmail.com et synchronis√©e avec toute l'√©quipe !", 'success', 'fa-check-circle', false, null, 2000);
                                                
                                                // Si on venait du wizard, fermer le modal de connexion
                                                if (googleCalendarDisconnectedModal.fromWizard) {
                                                    googleCalendarDisconnectedModal.open = false;
                                                    googleCalendarDisconnectedModal.fromWizard = false;
                                                }
                                            } catch (e) {
                                                console.error("Erreur sauvegarde token:", e);
                                                showNotification("Erreur lors de la sauvegarde de la connexion.", 'error', 'fa-exclamation-triangle', false);
                                            }
                                        } else {
                                            showNotification("Seul un administrateur peut modifier la connexion Google Agenda principale.", 'error', 'fa-exclamation-triangle', false);
                                        }
                                    })
                                    .catch(err => console.error('Erreur r√©cup√©ration email:', err));
                                }
                            }
                        });
                        
                        // Forcer l'affichage du s√©lecteur de compte avec 'select_account' uniquement
                        // Cela garantit que l'utilisateur peut choisir son compte √† chaque fois
                        googleTokenClient.requestAccessToken({ prompt: 'consent select_account' });
                    }
                };
                
                // Si on vient du wizard avec connexion obligatoire, noter qu'on attend la connexion
                const wasFromWizard = googleCalendarDisconnectedModal.fromWizard && googleCalendarRequired.value;
                const wasConnectedBefore = googleCalendarConnected.value;
                
                // R√©voquer le token existant avant de demander un nouveau compte
                if (googleAccessToken.value && typeof google !== 'undefined' && google.accounts) {
                    google.accounts.oauth2.revoke(googleAccessToken.value, () => {
                        // Petit d√©lai pour s'assurer que la r√©vocation est bien prise en compte
                        setTimeout(() => {
                            revokeAndConnect();
                        }, 300);
                    });
                } else {
                    // Pas de token existant, demander directement avec choix du compte
                    revokeAndConnect();
                }
                
                // Si on vient du wizard avec connexion obligatoire, v√©rifier apr√®s un d√©lai si on s'est connect√©
                if (wasFromWizard) {
                    setTimeout(async () => {
                        // V√©rifier si on est maintenant connect√©
                        const isTokenValid = await checkGoogleCalendarTokenValid();
                        const isConnected = isGoogleCalendarConnected.value && isTokenValid;
                        
                        // Si on n'est toujours pas connect√© et que c'√©tait obligatoire, fermer le wizard
                        if (!isConnected && googleCalendarRequired.value && googleCalendarDisconnectedModal.fromWizard) {
                            wizard.open = false;
                            googleCalendarDisconnectedModal.open = false;
                            googleCalendarDisconnectedModal.fromWizard = false;
                        }
                    }, 2000); // Attendre 2 secondes pour laisser le temps √† la popup de se fermer
                }
            };
            
            const disconnectGoogleCalendar = async () => {
                if (googleAccessToken.value && typeof google !== 'undefined' && google.accounts) {
                    google.accounts.oauth2.revoke(googleAccessToken.value);
                }
                
                // Si c'est l'admin qui se d√©connecte, supprimer le token de Firestore pour d√©connecter tout le monde
                if (user.role === 'admin') {
                    try {
                        await db.collection('settings').doc('google_token').delete();
                    } catch (err) {
                        console.error('Erreur lors de la suppression du token:', err);
                    }
                }
                
                googleCalendarConnected.value = false;
                googleCalendarUserEmail.value = '';
                googleAccessToken.value = '';
                googleCalendarTokenValid.value = false; // R√©initialiser l'√©tat du token
                localStorage.removeItem('google_calendar_token');
                localStorage.removeItem('google_calendar_email');
                googleCalendarList.value = [];
            };
            
            // ====================================================================================
            // CORRECTION PROSPECTEUR GOOGLE CALENDAR
            // ====================================================================================

            // 1. Initialisation de l'outil (uniquement pour le rafra√Æchissement automatique, PAS pour la connexion)
            const initProspecteurGoogleCalendar = () => {
                // V√©rifier si le script Google est charg√©
                if (typeof google === 'undefined' || !google.accounts) {
                    console.warn("Librairie Google non charg√©e.");
                    return false;
                }

                // Si d√©j√† initialis√©, on ne refait pas
                if (prospecteurGoogleTokenClient) return true;

                try {
                    // TokenClient pour le rafra√Æchissement automatique uniquement
                    // Le callback de connexion est dans connectProspecteurGoogleCalendar
                    prospecteurGoogleTokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: GOOGLE_CLIENT_ID,
                        scope: 'https://www.googleapis.com/auth/calendar.events https://www.googleapis.com/auth/calendar.readonly',
                        callback: (tokenResponse) => {
                            // Ce callback est pour le rafra√Æchissement automatique ET manuel
                            // La connexion manuelle utilise connectProspecteurGoogleCalendar
                            if (tokenResponse.access_token) {
                                // Mise √† jour du token et remise du compteur √† 55 minutes
                                prospecteurGoogleCalendarToken.value = tokenResponse.access_token;
                                prospecteurGoogleCalendarTokenValid.value = true;
                                prospecteurGoogleCalendarTokenExpired.value = false;
                                prospecteurTokenExpirationTime.value = Date.now() + (55 * 60 * 1000); // Remettre √† 55 minutes
                                lastProspecteurTokenValue.value = tokenResponse.access_token;
                                
                                // Mettre √† jour le timer tick pour forcer la mise √† jour du compteur
                                prospecteurTokenTimerTick.value = Date.now();
                                
                                localStorage.setItem('prospecteur_google_calendar_token', tokenResponse.access_token);
                                localStorage.setItem('prospecteur_google_calendar_token_date', new Date().toISOString());
                                
                                // Sauvegarder dans Firestore
                                if (user.logged && user.role !== 'admin' && user.id) {
                                    db.collection('users').doc(user.id).update({
                                        googleToken: {
                                            token: tokenResponse.access_token,
                                            expires: prospecteurTokenExpirationTime.value,
                                            updatedAt: new Date().toISOString()
                                        },
                                        googleTokenExpires: prospecteurTokenExpirationTime.value,
                                        lastSeen: new Date().toISOString()
                                    }).catch(e => console.log("Erreur save Firestore", e));
                                }
                                
                                showNotification('‚úÖ Token recharg√© avec succ√®s ! Compte √† rebours r√©initialis√© √† 55 minutes', 'success', 'fa-check-circle');
                                console.log("‚úÖ Token prospecteur rafra√Æchi automatiquement");
                            }
                        }
                    });
                    return true;
                } catch (e) {
                    console.error("Erreur init client:", e);
                    return false;
                }
            };

            // 2. Gestion du clic sur le bouton (D√©connexion ou Connexion)
            const handleProspecteurGoogleCalendar = async () => {
                // TOUJOURS v√©rifier la validit√© r√©elle du token avant toute action
                const isTokenValid = await checkGoogleCalendarTokenValid();
                
                // V√©rifier si on est vraiment connect√© (token valide)
                const adminConnected = googleCalendarConnected.value && googleAccessToken.value && googleAccessToken.value.trim() !== '';
                const prospecteurConnected = prospecteurGoogleCalendarConnected.value && 
                                           prospecteurGoogleCalendarToken.value && 
                                           prospecteurGoogleCalendarToken.value.trim() !== '' && 
                                           !prospecteurGoogleCalendarTokenExpired.value;
                
                // Si vraiment connect√© ET token valide, afficher simplement le temps restant (token propre)
                if (isTokenValid && prospecteurConnected && !prospecteurGoogleCalendarTokenExpired.value) {
                    // Le prospecteur a son propre token valide, afficher le temps restant
                    const timeRemaining = prospecteurTokenTimeRemaining.value;
                    let message = '‚úÖ Vous √™tes connect√© √† Google Calendar';
                    if (timeRemaining) {
                        message += `\n‚è±Ô∏è Temps restant : ${timeRemaining.minutes} minutes ${timeRemaining.seconds} secondes`;
                    } else {
                        message += '\n‚è±Ô∏è Session active';
                    }
                    showNotification(message, 'success', 'fa-check-circle');
                    return;
                }
                
                // Si connect√© via admin ET token valide, afficher le temps restant
                if (isTokenValid && adminConnected && user.role !== 'admin') {
                    const timeRemaining = tokenTimeRemaining.value;
                    let message = '‚úÖ Connect√© via Admin';
                    if (timeRemaining) {
                        message += `\n‚è±Ô∏è Temps restant : ${timeRemaining.minutes} minutes ${timeRemaining.seconds} secondes`;
                    } else {
                        message += '\n‚è±Ô∏è Session active';
                    }
                    showNotification(message, 'success', 'fa-check-circle');
                    return;
                }
                
                // Dans TOUS les autres cas (pas connect√©, token invalide, token expir√©), lancer la connexion automatiquement
                // Pas de confirmation, on lance directement
                connectProspecteurGoogleCalendar();
            };

            // 3. La fonction qui lance la popup - EXACTEMENT COMME ADMIN
            const connectProspecteurGoogleCalendar = () => {
                // R√©voquer le token existant pour forcer le choix du compte √† chaque fois (COMME ADMIN)
                const revokeAndConnect = () => {
                    // R√©initialiser le TokenClient √† chaque connexion pour forcer le choix (COMME ADMIN)
                    if (typeof google !== 'undefined' && google.accounts && GOOGLE_CLIENT_ID) {
                        prospecteurGoogleTokenClient = google.accounts.oauth2.initTokenClient({
                            client_id: GOOGLE_CLIENT_ID,
                            scope: 'https://www.googleapis.com/auth/calendar.events https://www.googleapis.com/auth/calendar.readonly',
                            callback: (tokenResponse) => {
                                if (tokenResponse.access_token) {
                                    // 1. On r√©cup√®re l'email pour confirmer qui est connect√© (COMME ADMIN)
                                    fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                                        headers: { 'Authorization': `Bearer ${tokenResponse.access_token}` }
                                    })
                                    .then(res => res.json())
                                    .then(async (data) => {
                                        const email = data.email || '';
                                        
                                        // 2. SAUVEGARDE DU TOKEN (COMME ADMIN mais pour prospecteur)
                                        try {
                                            // Expiration 55 minutes
                                            const expiresTime = Date.now() + (55 * 60 * 1000);
                                            
                                            // Mise √† jour locale imm√©diate - TOUS LES FLAGS EN M√äME TEMPS (COMME ADMIN)
                                            prospecteurGoogleCalendarToken.value = tokenResponse.access_token;
                                            prospecteurGoogleCalendarConnected.value = true;
                                            prospecteurGoogleCalendarTokenValid.value = true;
                                            prospecteurGoogleCalendarTokenExpired.value = false;
                                            prospecteurTokenExpirationTime.value = expiresTime;
                                            
                                            // Mettre √† jour l'email (COMME ADMIN)
                                            prospecteurGoogleCalendarUserEmail.value = email;
                                            
                                            // Mettre √† jour lastProspecteurTokenValue pour √©viter que checkAndUpdateProspecteurTokenStatus invalide le token
                                            lastProspecteurTokenValue.value = tokenResponse.access_token;
                                            
                                            // Forcer la mise √† jour du statut pour que l'interface refl√®te la connexion
                                            // Pas besoin de v√©rifier le token, on vient de le recevoir de Google

                                            // Sauvegarde locale
                                            localStorage.setItem('prospecteur_google_calendar_token', tokenResponse.access_token);
                                            localStorage.setItem('prospecteur_google_calendar_email', email);
                                            localStorage.setItem('prospecteur_google_calendar_token_date', new Date().toISOString());

                                            // D√©marrer le refresh auto
                                            startProspecteurTokenRefresh();

                                            // Sauvegarder dans Firestore pour cet utilisateur sp√©cifique
                                            if (user.logged && user.role !== 'admin' && user.id) {
                                                await db.collection('users').doc(user.id).update({
                                                    googleStatus: 'connected',
                                                    googleToken: {
                                                        token: tokenResponse.access_token,
                                                        email: email,
                                                        expires: expiresTime,
                                                        updatedAt: new Date().toISOString()
                                                    },
                                                    googleTokenExpires: expiresTime,
                                                    lastSeen: new Date().toISOString()
                                                });
                                            }
                                            
                                            // Charger la liste des agendas (COMME ADMIN)
                                            await fetchGoogleCalendarList();
                                            
                                            // NE PAS v√©rifier le token imm√©diatement apr√®s connexion
                                            // Le token vient d'√™tre cr√©√© par Google, il est forc√©ment valide
                                            // La v√©rification se fera automatiquement plus tard si n√©cessaire
                                            // On √©vite ainsi que checkAndUpdateProspecteurTokenStatus invalide le token juste apr√®s connexion
                                            
                                            // Forcer la mise √† jour de l'interface IMM√âDIATEMENT pour que le bouton affiche "Connect√©"
                                            // On s'assure que tous les flags sont bien √† jour AVANT l'alert
                                            // Double v√©rification pour forcer Vue √† d√©tecter les changements
                                            prospecteurGoogleCalendarConnected.value = true;
                                            prospecteurGoogleCalendarToken.value = tokenResponse.access_token; // R√©assigner pour forcer la r√©activit√©
                                            prospecteurGoogleCalendarTokenValid.value = true;
                                            prospecteurGoogleCalendarTokenExpired.value = false;
                                            
                                            // Utiliser alert comme l'admin
                                            alert("‚úÖ Connexion Google r√©ussie avec " + email + " !");
                                            
                                            // Si on vient de selectSource, fermer le modal et continuer le wizard
                                            if (googleCalendarDisconnectedModal.fromWizard) {
                                                googleCalendarDisconnectedModal.open = false;
                                                googleCalendarDisconnectedModal.fromWizard = false;
                                            }
                                            
                                            // Si la connexion vient de la s√©lection de Google comme source, continuer le wizard
                                            if (connectingFromSelectSource.value) {
                                                connectingFromSelectSource.value = false;
                                                wizard.step++;
                                            }
                                        } catch (e) {
                                            console.error("Erreur sauvegarde token:", e);
                                            showNotification("Erreur lors de la sauvegarde de la connexion.", 'error', 'fa-exclamation-triangle', false);
                                        }
                                    })
                                    .catch(err => {
                                        console.error('Erreur r√©cup√©ration email:', err);
                                        connectingFromSelectSource.value = false;
                                    });
                                }
                            }
                        });
                        
                        // Forcer l'affichage du s√©lecteur de compte avec 'select_account consent' (COMME ADMIN - m√™me ordre)
                        prospecteurGoogleTokenClient.requestAccessToken({ prompt: 'consent select_account' });
                    }
                };
                
                // Si on vient du wizard avec connexion obligatoire, noter qu'on attend la connexion (COMME ADMIN)
                const wasFromWizard = googleCalendarDisconnectedModal.fromWizard && googleCalendarRequired.value;
                const wasConnectedBefore = prospecteurGoogleCalendarConnected.value;
                
                // R√©voquer le token existant avant de demander un nouveau compte (COMME ADMIN)
                if (prospecteurGoogleCalendarToken.value && typeof google !== 'undefined' && google.accounts) {
                    google.accounts.oauth2.revoke(prospecteurGoogleCalendarToken.value, () => {
                        // Petit d√©lai pour s'assurer que la r√©vocation est bien prise en compte
                        setTimeout(() => {
                            revokeAndConnect();
                        }, 300);
                    });
                } else {
                    // Pas de token existant, demander directement avec choix du compte
                    revokeAndConnect();
                }
                
                // Si on vient du wizard avec connexion obligatoire, v√©rifier apr√®s un d√©lai si on s'est connect√© (COMME ADMIN)
                if (wasFromWizard) {
                    setTimeout(async () => {
                        // V√©rifier si on est maintenant connect√©
                        const isTokenValid = await checkGoogleCalendarTokenValid();
                        const adminConnected = googleCalendarConnected.value && googleAccessToken.value && googleAccessToken.value.trim() !== '';
                        const prospecteurConnected = prospecteurGoogleCalendarConnected.value && 
                                                   prospecteurGoogleCalendarToken.value && 
                                                   prospecteurGoogleCalendarToken.value.trim() !== '' && 
                                                   !prospecteurGoogleCalendarTokenExpired.value;
                        const isConnected = (adminConnected || prospecteurConnected) && isTokenValid;
                        
                        // Si on n'est toujours pas connect√© et que c'√©tait obligatoire, fermer le wizard
                        if (!isConnected && googleCalendarRequired.value && googleCalendarDisconnectedModal.fromWizard) {
                            wizard.open = false;
                            googleCalendarDisconnectedModal.open = false;
                            googleCalendarDisconnectedModal.fromWizard = false;
                        }
                    }, 2000); // Attendre 2 secondes pour laisser le temps √† la popup de se fermer
                }
            };
            
            // Fonction pour se d√©connecter de Google Calendar (prospecteurs) - EXACTEMENT COMME ADMIN
         const disconnectProspecteurGoogleCalendar = async () => {
    if (prospecteurGoogleCalendarToken.value && typeof google !== 'undefined' && google.accounts) {
        google.accounts.oauth2.revoke(prospecteurGoogleCalendarToken.value);
    }
    
    // Supprimer le token de Firestore pour le prospecteur
    if (user.logged && user.role !== 'admin' && user.id) {
        try {
            await db.collection('users').doc(user.id).update({
                googleToken: null,
                googleStatus: 'disconnected'
            });
        } catch (err) {
            console.error('Erreur lors de la suppression du token:', err);
        }
    }
    
    prospecteurGoogleCalendarConnected.value = false;
    prospecteurGoogleCalendarUserEmail.value = '';
    prospecteurGoogleCalendarToken.value = '';
    prospecteurGoogleCalendarTokenValid.value = false; // R√©initialiser l'√©tat du token
    localStorage.removeItem('prospecteur_google_calendar_token');
    localStorage.removeItem('prospecteur_google_calendar_email');
    localStorage.removeItem('prospecteur_google_calendar_token_date');
};
            
         
           // Fonction pour recharger manuellement le token
            const reloadProspecteurToken = () => {
                // Pour les prospecteurs, simplement recharger la page
                if (user.role !== 'admin') {
                    location.reload();
                    return;
                }
                
                // Pour l'admin, garder l'ancien comportement
                if (user.role === 'admin') {
                    checkAndUpdateTokenStatus(true);
                    showNotification('Token v√©rifi√© et actualis√©', 'success', 'fa-check-circle');
                }
            };
            
            // Fonction pour d√©marrer le rafra√Æchissement automatique du token (toutes les 45 minutes)
            const startProspecteurTokenRefresh = () => {
                // Arr√™ter l'ancien intervalle si existe
                if (prospecteurTokenRefreshInterval) {
                    clearInterval(prospecteurTokenRefreshInterval);
                    prospecteurTokenRefreshInterval = null;
                }
                
                // Rafra√Æchir toutes les 45 minutes
                prospecteurTokenRefreshInterval = setInterval(() => {
                    if (prospecteurGoogleCalendarConnected.value && prospecteurGoogleCalendarToken.value && prospecteurGoogleTokenClient) {
                        console.log("üîÑ Rafra√Æchissement automatique du token Google Agenda (prospecteur)...");
                        prospecteurGoogleTokenClient.requestAccessToken({ prompt: 'none' });
                    }
                }, 45 * 60 * 1000); // 45 minutes
            };
            
          // Fonction pour v√©rifier l'expiration du token
            const checkProspecteurTokenExpiration = async () => {
                // Si l'admin est connect√©, on utilise son token
                if (googleCalendarConnected.value && googleAccessToken.value) {
                    prospecteurGoogleCalendarConnected.value = true;
                    prospecteurGoogleCalendarToken.value = googleAccessToken.value;
                    prospecteurGoogleCalendarTokenExpired.value = false;
                    // Utiliser le token admin, donc pas d'expiration pour le prospecteur
                    prospecteurTokenExpirationTime.value = null;
                    return;
                }
                
                // V√©rifier le token local du prospecteur
                if (prospecteurGoogleCalendarToken.value) {
                    try {
                        const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                            headers: { 'Authorization': `Bearer ${prospecteurGoogleCalendarToken.value}` }
                        });
                        
                        if (!response.ok) {
                            // Token expir√©
                            prospecteurGoogleCalendarTokenExpired.value = true;
                            prospecteurGoogleCalendarConnected.value = false;
                            prospecteurTokenExpirationTime.value = null;
                            
                            // --- LIGNE SUPPRIM√âE ICI ---
                            // showNotification('‚ö†Ô∏è Votre session Google Agenda a expir√©. Veuillez vous reconnecter.', 'warning', 'fa-exclamation-triangle'); 
                            
                        } else {
                            prospecteurGoogleCalendarTokenExpired.value = false;
                            // D√©finir l'expiration du token (55 minutes)
                            prospecteurTokenExpirationTime.value = Date.now() + (55 * 60 * 1000);
                        }
                    } catch (err) {
                        console.error('Erreur v√©rification token:', err);
                        prospecteurGoogleCalendarTokenExpired.value = true;
                        prospecteurTokenExpirationTime.value = null;
                    }
                }
            };
            
            // Liste des agendas Google
            const googleCalendarList = ref([]);
            const loadingCalendars = ref(false);
            
            // R√©cup√©rer la liste des agendas Google
            const fetchGoogleCalendarList = async () => {
                if (!googleAccessToken.value || !googleCalendarConnected.value) {
                    googleCalendarList.value = [];
                    return;
                }
                
                loadingCalendars.value = true;
                try {
                    // R√©cup√©rer TOUS les calendriers (sans aucun filtre)
                    const response = await fetch('https://www.googleapis.com/calendar/v3/users/me/calendarList?maxResults=250', {
                        headers: {
                            'Authorization': `Bearer ${googleAccessToken.value}`
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('üìÖ Calendriers re√ßus de Google:', data.items?.length || 0);
                        
                        // Prendre TOUS les calendriers sans filtre
                        const allCalendars = (data.items || []).map(cal => ({
                            id: cal.id,
                            summary: cal.summary || cal.id,
                            description: cal.description || '',
                            primary: cal.primary || false,
                            accessRole: cal.accessRole || '',
                            backgroundColor: cal.backgroundColor || '#8b5cf6',
                            foregroundColor: cal.foregroundColor || '#000000'
                        }));
                        
                        // Trier : agenda principal en premier, puis par nom
                        googleCalendarList.value = allCalendars.sort((a, b) => {
                            if (a.primary && !b.primary) return -1;
                            if (!a.primary && b.primary) return 1;
                            return a.summary.localeCompare(b.summary, 'fr');
                        });
                        
                        console.log('‚úÖ Liste finale des calendriers:', googleCalendarList.value.length);
                        
                        // SYNCHRONISER LES STATUTS apr√®s avoir charg√© la liste
                        try {
                            const now = new Date();
                            const startDate = new Date(now);
                            startDate.setDate(startDate.getDate() - 7);
                            startDate.setHours(0, 0, 0, 0);
                            const endDate = new Date(now);
                            endDate.setDate(endDate.getDate() + 7);
                            endDate.setHours(23, 59, 59, 999);
                            
                            const timeMin = startDate.toISOString();
                            const timeMax = endDate.toISOString();
                            
                            // R√©cup√©rer tous les calendriers (primary + agences)
                            const calendarIds = ['primary'];
                            agences.value.forEach(agence => {
                                if (agence.agendaEmail && agence.agendaEmail.trim()) {
                                    calendarIds.push(agence.agendaEmail.trim());
                                }
                            });
                            
                            const allGoogleEvents = [];
                            for (const calendarId of calendarIds) {
                                try {
                                    const encodedId = encodeURIComponent(calendarId);
                                    const url = `https://www.googleapis.com/calendar/v3/calendars/${encodedId}/events?timeMin=${timeMin}&timeMax=${timeMax}&singleEvents=true&orderBy=startTime`;
                                    
                                    const eventResponse = await fetch(url, {
                                        headers: {
                                            'Authorization': `Bearer ${googleAccessToken.value}`
                                        }
                                    });
                                    
                                    if (eventResponse.ok) {
                                        const eventData = await eventResponse.json();
                                        if (eventData.items) {
                                            allGoogleEvents.push(...eventData.items);
                                        }
                                    }
                                } catch (err) {
                                    console.warn(`Erreur synchronisation calendrier ${calendarId}:`, err);
                                }
                            }
                        } catch (syncErr) {
                            console.error('Erreur lors de la synchronisation des statuts:', syncErr);
                        }
                    } else if (response.status === 401) {
                        // Token expir√© ou invalide
                        console.error('‚ùå Token expir√© ou invalide');
                        googleCalendarList.value = [];
                        googleCalendarConnected.value = false;
                        googleAccessToken.value = '';
                        alert('‚ö†Ô∏è Votre session Google Calendar a expir√©. Veuillez vous reconnecter en cliquant sur "Se connecter avec Google".');
                    } else {
                        const errorData = await response.json().catch(() => ({}));
                        const errorMessage = errorData.error?.message || 'Erreur inconnue';
                        console.error('‚ùå Erreur lors de la r√©cup√©ration des agendas:', errorMessage);
                        alert('‚ùå Erreur lors de la r√©cup√©ration des calendriers : ' + errorMessage);
                        googleCalendarList.value = [];
                    }
                } catch (err) {
                    console.error('‚ùå Erreur lors de la r√©cup√©ration des agendas Google:', err);
                    alert('‚ùå Erreur lors de la r√©cup√©ration des calendriers. Veuillez r√©essayer ou vous reconnecter √† Google Calendar.');
                    googleCalendarList.value = [];
                } finally {
                    loadingCalendars.value = false;
                }
            };
            
// ============================================================
            // ‚úÖ SYST√àME API DIRECTE (Stable & Sans doublons)
            // ============================================================

            // 0. V√âRIFICATION DE LA VALIDIT√â DU TOKEN
            const checkGoogleCalendarTokenValid = async () => {
                const token = getActiveGoogleToken();
                if (!token) return false;
                
                try {
                    // Tester le token en faisant une requ√™te simple √† l'API Google Calendar
                    const response = await fetch('https://www.googleapis.com/calendar/v3/users/me/calendarList?maxResults=1', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    // Si 401 ou 403, le token est invalide ou expir√©
                    if (response.status === 401 || response.status === 403) {
                        return false;
                    }
                    
                    return response.ok;
                } catch (err) {
                    console.error('Erreur v√©rification token:', err);
                    return false;
                }
            };

            // 1. CR√âATION (Donne un vrai ID Google)
            const createGoogleCalendarEvent = async (rdv) => {
                // V√©rif s√©curit√© - utiliser le token actif (admin ou prospecteur)
                const token = getActiveGoogleToken();
                if (!token) throw new Error("Non connect√© √† Google.");

                const agence = agences.value.find(a => a.id === rdv.agenceId);
                // On utilise l'email de l'agence comme ID de calendrier, ou 'primary' par d√©faut
                const calendarId = (agence?.agendaEmail && agence.agendaEmail.trim()) ? agence.agendaEmail.trim() : 'primary';
                const agendaColor = agence?.agendaColor || '10'; 

               let prefixTitre = '';
                if (rdv.statut === 'annule') prefixTitre = '[ANNUL√â] ';
                const baseModeleTitre = getBaseModele(rdv.modele) || rdv.modele || '';
                const titre = `${prefixTitre}C&N - ${rdv.civilite || ''} ${rdv.nom || ''} - ${rdv.telephone || ''} - ${baseModeleTitre}`;
                
                let startDateTime, endDateTime;
                if (rdv.date && rdv.heure) {
                    const [year, month, day] = rdv.date.split('-').map(Number);
                    const [hours, minutes] = rdv.heure.split(':').map(Number);
                    const rdvDate = new Date(year, month - 1, day, hours, minutes, 0);
                    const endDate = new Date(rdvDate);
                    endDate.setHours(endDate.getHours() + 1); // Dur√©e 1h
                    
                    startDateTime = rdvDate.toISOString();
                    endDateTime = endDate.toISOString();
                }

                let description = '';
                
                // Ajouter le mod√®le de base du v√©hicule
                const baseModele = getBaseModele(rdv.modele);
                if (baseModele) {
                    description += `<b>V√©hicule :</b> ${baseModele}<br><br>`;
                }
                
                // Ajouter le prix si disponible
                if (rdv.prix && rdv.prix > 0) {
                    const prixFormate = Math.floor(rdv.prix).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
                    description += `<b>Prix :</b> ${prixFormate} ‚Ç¨<br><br>`;
                }
                
                if (rdv.lienAnnonce) description += `<b>Lien annonce :</b> ${rdv.lienAnnonce}<br><br>`;
                
                // Ajouter les caract√©ristiques (Facebook ou personnalis√©es)
                const caracteristiquesParsed = formatCaracteristiquesForDisplay(rdv.modele);
                if (caracteristiquesParsed.caracteristiques && caracteristiquesParsed.caracteristiques.length > 0) {
                    const caracteristiques = caracteristiquesParsed.caracteristiques
                        .map(c => `<b>${c.label} :</b> ${c.value}`)
                        .join('<br>');
                    description += caracteristiques + '<br><br>';
                } else if (rdv.source === 'Facebook' && rdv.facebookCaracteristiquesFormatees) {
                    // Fallback pour anciens formats Facebook
                    const caracteristiques = rdv.facebookCaracteristiquesFormatees.split('\n').map(line => {
                        if (line.includes(':')) {
                            const [label, value] = line.split(':').map(s => s.trim());
                            return `<b>${label} :</b> ${value}`;
                        }
                        return line;
                    }).join('<br>');
                    description += caracteristiques + '<br><br>';
                }
                
                // Ajouter "Rendez-vous initial" si le RDV a √©t√© report√©
                if (rdv.motifDeplacement && rdv.oldDate && rdv.oldHeure) {
                    const oldDate = new Date(rdv.oldDate);
                    const formattedOldDate = oldDate.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });
                    description += `<b>Rendez-vous initial :</b> ${formattedOldDate} √† ${rdv.oldHeure}<br><br>`;
                }
                
                // Modification pour afficher "Motif d'annulation" si annul√©
                const labelMotif = rdv.statut === 'annule' ? "Motif d'annulation" : "Motif";
                if (rdv.motif) description += `<b>${labelMotif} :</b> ${rdv.motif}<br><br>`;
                
                if (rdv.motifDeplacement) description += `<b>Motif report :</b> ${rdv.motifDeplacement}`;

                const eventPayload = {
                    summary: titre,
                    location: agence ? agence.nom : '',
                    description: description,
                    start: { dateTime: startDateTime },
                    end: { dateTime: endDateTime },
                    colorId: agendaColor
                };

                // Appel DIRECT √† Google
                const response = await fetch(`https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calendarId)}/events`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(eventPayload)
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error?.message || "Erreur Google API");
                }

                const data = await response.json();
                console.log("‚úÖ RDV cr√©√© via API Directe, ID:", data.id);
                
                // IMPORTANT : On retourne le VRAI ID Google pour pouvoir le supprimer plus tard
                return { id: data.id, eventId: data.id };
            };

            // 2. MISE √Ä JOUR (Utilise PATCH pour √©viter les doublons)
            const updateGoogleCalendarEvent = async (rdv) => {
                const token = getActiveGoogleToken();
                if (!token) return;
                
                // Si c'est un ancien RDV (robot), on le recr√©e car on ne peut pas le modifier proprement
                if (!rdv.googleCalendarEventId || rdv.googleCalendarEventId.startsWith('evt_robot_')) {
                    console.warn("Ancien format d√©tect√©, on recr√©e l'√©v√©nement...");
                    return await createGoogleCalendarEvent(rdv);
                }

                const agence = agences.value.find(a => a.id === rdv.agenceId);
                const calendarId = (agence?.agendaEmail && agence.agendaEmail.trim()) ? agence.agendaEmail.trim() : 'primary';

               // 1. DATES
                let startDateTime, endDateTime;
                if (rdv.date && rdv.heure) {
                    const [year, month, day] = rdv.date.split('-').map(Number);
                    const [hours, minutes] = rdv.heure.split(':').map(Number);
                    const rdvDate = new Date(year, month - 1, day, hours, minutes, 0);
                    const endDate = new Date(rdvDate);
                    endDate.setHours(endDate.getHours() + 1);
                    startDateTime = rdvDate.toISOString();
                    endDateTime = endDate.toISOString();
                }

                // 2. COULEUR (Rouge '11' si annul√©, sinon couleur agence)
                const agendaColor = rdv.statut === 'annule' ? '11' : (agence?.agendaColor || '10');

                // 3. TITRE
                let prefixTitre = '';
                if (rdv.statut === 'annule') prefixTitre = '[ANNUL√â] ';
                const baseModeleTitre = getBaseModele(rdv.modele) || rdv.modele || '';
                const titre = `${prefixTitre}C&N - ${rdv.civilite || ''} ${rdv.nom || ''} - ${rdv.telephone || ''} - ${baseModeleTitre}`;

                // 4. DESCRIPTION
                let description = '';
                
                // Ajouter le mod√®le de base du v√©hicule
                const baseModele = getBaseModele(rdv.modele);
                if (baseModele) {
                    description += `<b>V√©hicule :</b> ${baseModele}<br><br>`;
                }
                
                // Ajouter le prix si disponible
                if (rdv.prix && rdv.prix > 0) {
                    const prixFormate = Math.floor(rdv.prix).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
                    description += `<b>Prix :</b> ${prixFormate} ‚Ç¨<br><br>`;
                }
                
                if (rdv.lienAnnonce) description += `<b>Lien annonce :</b> ${rdv.lienAnnonce}<br><br>`;
                
                // Ajouter les caract√©ristiques (Facebook ou personnalis√©es)
                const caracteristiquesParsed = formatCaracteristiquesForDisplay(rdv.modele);
                if (caracteristiquesParsed.caracteristiques && caracteristiquesParsed.caracteristiques.length > 0) {
                    const caracteristiques = caracteristiquesParsed.caracteristiques
                        .map(c => `<b>${c.label} :</b> ${c.value}`)
                        .join('<br>');
                    description += caracteristiques + '<br><br>';
                } else if (rdv.source === 'Facebook' && rdv.facebookCaracteristiquesFormatees) {
                    // Fallback pour anciens formats Facebook
                    const caracteristiques = rdv.facebookCaracteristiquesFormatees.split('\n').map(line => {
                        if (line.includes(':')) {
                            const [label, value] = line.split(':').map(s => s.trim());
                            return `<b>${label} :</b> ${value}`;
                        }
                        return line;
                    }).join('<br>');
                    description += caracteristiques + '<br><br>';
                }
                
                // Ajouter "Rendez-vous initial" si le RDV a √©t√© report√©
                if (rdv.motifDeplacement && rdv.oldDate && rdv.oldHeure) {
                    const oldDate = new Date(rdv.oldDate);
                    const formattedOldDate = oldDate.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });
                    description += `<b>Rendez-vous initial :</b> ${formattedOldDate} √† ${rdv.oldHeure}<br><br>`;
                }
                
                // Si annul√©, on √©crit "Motif d'annulation", sinon "Motif"
                const labelMotif = rdv.statut === 'annule' ? "Motif d'annulation" : "Motif";
                if (rdv.motif) description += `<b>${labelMotif} :</b> ${rdv.motif}<br><br>`;
                
                if (rdv.motifDeplacement) description += `<b>Motif report :</b> ${rdv.motifDeplacement}`;

                // PATCH modifie seulement les champs n√©cessaires sans effacer le reste
                const response = await fetch(`https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calendarId)}/events/${rdv.googleCalendarEventId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        summary: titre,
                        description: description,
                        start: { dateTime: startDateTime },
                        end: { dateTime: endDateTime }
                    })
                });

                if (!response.ok) {
                    // Si l'√©v√©nement n'existe plus, on le recr√©e
                    if (response.status === 404 || response.status === 410) {
                        return await createGoogleCalendarEvent(rdv);
                    }
                    // Sinon on ignore l'erreur silencieusement ou on log
                    console.warn("Impossible de modifier l'√©v√©nement Google");
                    return; 
                }

                const data = await response.json();
                console.log("‚úÖ RDV modifi√© via API Directe !");
                return { id: data.id };
            };

            // 3. SUPPRESSION DIRECTE
            const deleteGoogleCalendarEvent = async (rdv) => {
                const token = getActiveGoogleToken();
                if (!token) return;
                
                // S√©curit√© pour les vieux RDV
                if (!rdv.googleCalendarEventId || rdv.googleCalendarEventId.startsWith('evt_robot_')) {
                    alert("‚ö†Ô∏è Cet √©v√©nement date de l'ancien syst√®me. Veuillez le supprimer manuellement de Google Agenda (une seule fois).");
                    return;
                }

                const agence = agences.value.find(a => a.id === rdv.agenceId);
                const calendarId = (agence?.agendaEmail && agence.agendaEmail.trim()) ? agence.agendaEmail.trim() : 'primary';

                const response = await fetch(`https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calendarId)}/events/${rdv.googleCalendarEventId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok || response.status === 404 || response.status === 410) {
                    console.log("‚úÖ RDV supprim√© de Google Agenda");
                } else {
                    console.error("Erreur suppression", await response.json());
                    alert("Erreur lors de la suppression sur Google Agenda.");
                }
            };
            // G√©rer le clic sur le bouton "Agenda" dans la liste des confirmations
            const handleAddToAgendaClick = async (rdv) => {
                // V√©rifier d'abord si le token est vraiment valide
                const isTokenValid = await checkGoogleCalendarTokenValid();
                const isConnected = isGoogleCalendarConnected.value && isTokenValid;
                
                if (!isConnected) {
                    // Afficher le modal de reconnexion
                    reconnectAgendaModal.rdv = rdv;
                    reconnectAgendaModal.open = true;
                    return;
                }
                
                // Si connect√©, ajouter directement √† l'agenda
                await addToAgenda(rdv);
            };
            
            // G√©rer la reconnexion et ajout automatique √† l'agenda
            const handleReconnectForAgenda = async (rdv) => {
                reconnectAgendaModal.open = false;
                
             // Se reconnecter
                if (user.role === 'admin') {
                    connectGoogleCalendar();
                } else {
                    // Pour les prospecteurs, utiliser la fonction existante qui g√®re d√©j√† le choix du compte
                    connectProspecteurGoogleCalendar();
                }
                
                // Attendre un peu que la connexion soit √©tablie
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                // V√©rifier si on est maintenant connect√©
                const isTokenValid = await checkGoogleCalendarTokenValid();
                const isConnected = isGoogleCalendarConnected.value && isTokenValid;
                
                if (isConnected && rdv) {
                    // Ajouter automatiquement √† l'agenda
                    try {
                        await addToAgenda(rdv);
                        showNotification('‚úÖ C\'est bon, c\'est plac√© dans l\'agenda !', 'success', 'fa-calendar-check');
                    } catch (err) {
                        console.error('Erreur ajout automatique:', err);
                    }
                }
            };
            
            // Ajouter un rendez-vous √† l'agenda Google
            const addToAgenda = async (rdv) => {
                try {
                    // V√©rifier d'abord si le token est vraiment valide
                    const isTokenValid = await checkGoogleCalendarTokenValid();
                    if (!isTokenValid || !isGoogleCalendarConnected.value) {
                        // Afficher le modal de reconnexion au lieu d'alert
                        reconnectAgendaModal.rdv = rdv;
                        reconnectAgendaModal.open = true;
                        return;
                    }
                    
                    const eventResult = await createGoogleCalendarEvent(rdv);
                    
                    // Mettre √† jour le RDV dans Firestore
                    await db.collection('rendezvous').doc(rdv.id).update({
                        dansAgenda: true,
                        googleCalendarEventId: eventResult.id || eventResult.eventId,
                        enAttenteAgenda: false
                    });
                    
                    // Mettre √† jour localement
                    rdv.dansAgenda = true;
                    rdv.googleCalendarEventId = eventResult.id || eventResult.eventId;
                    if (rdv.enAttenteAgenda !== undefined) rdv.enAttenteAgenda = false;
                    
                    if (clientModal.rdv && clientModal.rdv.id === rdv.id) {
                        clientModal.rdv.dansAgenda = true;
                        clientModal.rdv.googleCalendarEventId = eventResult.id || eventResult.eventId;
                        if (clientModal.rdv.enAttenteAgenda !== undefined) clientModal.rdv.enAttenteAgenda = false;
                    }
                    
                    showNotification('‚úÖ Rendez-vous ajout√© √† l\'agenda avec succ√®s !', 'success', 'fa-calendar-check');
                } catch (err) {
                    console.error('Erreur lors de l\'ajout √† l\'agenda:', err);
                    
                    // D√©tecter les erreurs de token (401, 403)
                    const errorMessage = err.message || '';
                    const isTokenError = errorMessage.includes('401') || 
                                       errorMessage.includes('403') || 
                                       errorMessage.includes('Invalid Credentials') ||
                                       errorMessage.includes('expired') ||
                                       errorMessage.includes('token');
                    
                    if (isTokenError) {
                        // Afficher le modal de reconnexion
                        reconnectAgendaModal.rdv = rdv;
                        reconnectAgendaModal.open = true;
                    } else {
                        alert('‚ùå Erreur lors de l\'ajout √† l\'agenda : ' + errorMessage);
                    }
                }
            };
            
            // G√©rer le clic sur "Retirer de l'agenda" avec v√©rification de connexion
            const handleRemoveFromAgendaClick = async (rdv) => {
                // V√©rifier d'abord si le token est vraiment valide
                const isTokenValid = await checkGoogleCalendarTokenValid();
                const isConnected = isGoogleCalendarConnected.value && isTokenValid;
                
                if (!isConnected) {
                    // Afficher le modal de reconnexion
                    reconnectAgendaModal.rdv = rdv;
                    reconnectAgendaModal.open = true;
                    return;
                }
                
                // Si connect√©, ouvrir le modal de confirmation
                removeAgendaConfirmModal.rdv = rdv;
                removeAgendaConfirmModal.open = true;
            };
            
            // Confirmer la suppression de l'agenda
            const confirmRemoveFromAgenda = async () => {
                if (!removeAgendaConfirmModal.rdv) return;
                await removeFromAgenda(removeAgendaConfirmModal.rdv);
            };
            
            // Charger les fermetures depuis Firestore
            const loadFermetures = async () => {
                try {
                    const fermeturesSnapshot = await db.collection('fermetures')
                        .where('dateFin', '>=', new Date().toISOString().split('T')[0])
                        .orderBy('dateFin', 'asc')
                        .get();
                    
                    fermeturesList.value = fermeturesSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                } catch (err) {
                    console.error('Erreur chargement fermetures:', err);
                }
            };
            
            // Cr√©er une fermeture et les √©v√©nements Google Calendar pour tous les professionnels
            const createFermeture = async () => {
                try {
                    if (!fermetureModal.dateDebut || !fermetureModal.dateFin) {
                        showNotification('Veuillez remplir les dates de d√©but et de fin', 'error', 'fa-exclamation-triangle');
                        return;
                    }
                    
                    // V√©rifier que la date de fin est apr√®s la date de d√©but
                    if (fermetureModal.dateFin < fermetureModal.dateDebut) {
                        showNotification('La date de fin doit √™tre apr√®s la date de d√©but', 'error', 'fa-exclamation-triangle');
                        return;
                    }
                    
                    // R√©cup√©rer tous les professionnels (agences avec agendaEmail)
                    const professionnelsAvecAgenda = agences.value.filter(ag => ag.agendaEmail && ag.agendaEmail.trim());
                    
                    if (professionnelsAvecAgenda.length === 0) {
                        showNotification('Aucun professionnel avec agenda configur√©', 'error', 'fa-exclamation-triangle');
                        return;
                    }
                    
                    // V√©rifier la connexion Google Calendar
                    const token = getActiveGoogleToken();
                    if (!token) {
                        showNotification('Vous devez √™tre connect√© √† Google Calendar pour cr√©er une fermeture', 'error', 'fa-exclamation-triangle');
                        // Proposer de se connecter via le modal de reconnexion
                        if (user.role === 'admin') {
                            setTimeout(() => {
                                reconnectAgendaModal.open = true;
                            }, 500);
                        }
                        return;
                    }
                    
                    // Cr√©er les √©v√©nements pour chaque professionnel
                    const eventIds = [];
                    const motif = fermetureModal.motif ? fermetureModal.motif.trim() : '';
                    const titre = 'C&N FERM√â'; // Titre sans motif
                    const description = motif ? `<b>Motif :</b> ${motif}` : ''; // Motif uniquement dans la description
                    
                    // Calculer toutes les dates entre dateDebut et dateFin (inclus)
                    const dates = [];
                    const startDate = new Date(fermetureModal.dateDebut);
                    const endDate = new Date(fermetureModal.dateFin);
                    
                    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                        dates.push(new Date(d).toISOString().split('T')[0]);
                    }
                    
                    // Pour chaque professionnel et chaque date, cr√©er un √©v√©nement toute la journ√©e
                    for (const agence of professionnelsAvecAgenda) {
                        const calendarId = agence.agendaEmail.trim();
                        
                        for (const date of dates) {
                            try {
                                const eventPayload = {
                                    summary: titre,
                                    description: description,
                                    start: { date: date }, // Toute la journ√©e
                                    end: { date: date }, // Toute la journ√©e
                                    colorId: '11' // Rouge pour fermeture
                                };
                                
                                const response = await fetch(`https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calendarId)}/events`, {
                                    method: 'POST',
                                    headers: {
                                        'Authorization': `Bearer ${token}`,
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify(eventPayload)
                                });
                                
                                if (!response.ok) {
                                    const err = await response.json();
                                    console.error(`Erreur cr√©ation √©v√©nement pour ${agence.nom} le ${date}:`, err);
                                    continue;
                                }
                                
                                const data = await response.json();
                                eventIds.push({
                                    calendarId: calendarId,
                                    eventId: data.id,
                                    date: date,
                                    agenceNom: agence.nom
                                });
                            } catch (err) {
                                console.error(`Erreur cr√©ation √©v√©nement pour ${agence.nom} le ${date}:`, err);
                            }
                        }
                    }
                    
                    // Sauvegarder la fermeture dans Firestore
                    const fermetureData = {
                        dateDebut: fermetureModal.dateDebut,
                        dateFin: fermetureModal.dateFin,
                        motif: motif,
                        tousProfessionnels: true,
                        eventIds: eventIds,
                        createdAt: new Date().toISOString()
                    };
                    
                    // Fermer le modal imm√©diatement pour am√©liorer l'UX
                    fermetureModal.open = false;
                    const dateDebutTemp = fermetureModal.dateDebut;
                    const dateFinTemp = fermetureModal.dateFin;
                    const motifTemp = fermetureModal.motif;
                    
                    // R√©initialiser le modal
                    fermetureModal.dateDebut = '';
                    fermetureModal.dateFin = '';
                    fermetureModal.motif = '';
                    fermetureModal.tousProfessionnels = false;
                    
                    // Cr√©er la fermeture en arri√®re-plan
                    await db.collection('fermetures').add(fermetureData);
                    
                    showNotification(`Fermeture cr√©√©e pour ${dates.length} jour(s) dans ${professionnelsAvecAgenda.length} agenda(s)`, 'success', 'fa-calendar-check');
                    
                    // Recharger la liste
                    await loadFermetures();
                } catch (err) {
                    console.error('Erreur cr√©ation fermeture:', err);
                    showNotification('Erreur lors de la cr√©ation de la fermeture', 'error', 'fa-exclamation-triangle');
                }
            };
            
            // Ouvrir le modal en mode √©dition
            const editFermeture = (ferm) => {
                fermetureModal.editingId = ferm.id;
                fermetureModal.dateDebut = ferm.dateDebut || '';
                fermetureModal.dateFin = ferm.dateFin || '';
                fermetureModal.motif = ferm.motif || '';
                fermetureModal.tousProfessionnels = ferm.tousProfessionnels !== undefined ? ferm.tousProfessionnels : true;
                fermetureModal.professionnels = ferm.professionnels || [];
                fermetureModal.open = true;
            };
            
            // Mettre √† jour une fermeture et ses √©v√©nements Google Calendar
            const updateFermeture = async () => {
                try {
                    if (!fermetureModal.dateDebut || !fermetureModal.dateFin) {
                        showNotification('Veuillez remplir les dates de d√©but et de fin', 'error', 'fa-exclamation-triangle');
                        return;
                    }
                    
                    if (!fermetureModal.editingId) {
                        showNotification('Erreur: ID de fermeture manquant', 'error', 'fa-exclamation-triangle');
                        return;
                    }
                    
                    // V√©rifier que la date de fin est apr√®s la date de d√©but
                    if (fermetureModal.dateFin < fermetureModal.dateDebut) {
                        showNotification('La date de fin doit √™tre apr√®s la date de d√©but', 'error', 'fa-exclamation-triangle');
                        return;
                    }
                    
                    // R√©cup√©rer l'ancienne fermeture
                    const oldFermetureDoc = await db.collection('fermetures').doc(fermetureModal.editingId).get();
                    if (!oldFermetureDoc.exists) {
                        showNotification('Fermeture introuvable', 'error', 'fa-exclamation-triangle');
                        return;
                    }
                    
                    const oldFermeture = oldFermetureDoc.data();
                    const oldEventIds = oldFermeture.eventIds || [];
                    
                    // V√©rifier la connexion Google Calendar
                    const token = getActiveGoogleToken();
                    if (!token) {
                        showNotification('Vous devez √™tre connect√© √† Google Calendar pour modifier une fermeture', 'error', 'fa-exclamation-triangle');
                        if (user.role === 'admin') {
                            setTimeout(() => {
                                reconnectAgendaModal.open = true;
                            }, 500);
                        }
                        return;
                    }
                    
                    // Supprimer les anciens √©v√©nements Google Calendar
                    if (oldEventIds.length > 0) {
                        for (const eventInfo of oldEventIds) {
                            try {
                                if (eventInfo.calendarId && eventInfo.eventId) {
                                    await fetch(`https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(eventInfo.calendarId)}/events/${eventInfo.eventId}`, {
                                        method: 'DELETE',
                                        headers: {
                                            'Authorization': `Bearer ${token}`
                                        }
                                    });
                                }
                            } catch (err) {
                                console.error(`Erreur suppression ancien √©v√©nement ${eventInfo.eventId}:`, err);
                            }
                        }
                    }
                    
                    // R√©cup√©rer tous les professionnels (agences avec agendaEmail)
                    const professionnelsAvecAgenda = agences.value.filter(ag => ag.agendaEmail && ag.agendaEmail.trim());
                    
                    if (professionnelsAvecAgenda.length === 0) {
                        showNotification('Aucun professionnel avec agenda configur√©', 'error', 'fa-exclamation-triangle');
                        return;
                    }
                    
                    // Cr√©er les nouveaux √©v√©nements
                    const eventIds = [];
                    const motif = fermetureModal.motif ? fermetureModal.motif.trim() : '';
                    const titre = 'C&N FERM√â';
                    const description = motif ? `<b>Motif :</b> ${motif}` : '';
                    
                    // Calculer toutes les dates entre dateDebut et dateFin (inclus)
                    const dates = [];
                    const startDate = new Date(fermetureModal.dateDebut);
                    const endDate = new Date(fermetureModal.dateFin);
                    
                    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                        dates.push(new Date(d).toISOString().split('T')[0]);
                    }
                    
                    // Pour chaque professionnel et chaque date, cr√©er un √©v√©nement toute la journ√©e
                    for (const agence of professionnelsAvecAgenda) {
                        const calendarId = agence.agendaEmail.trim();
                        
                        for (const date of dates) {
                            try {
                                const eventPayload = {
                                    summary: titre,
                                    description: description,
                                    start: { date: date },
                                    end: { date: date },
                                    colorId: '11' // Rouge pour fermeture
                                };
                                
                                const response = await fetch(`https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calendarId)}/events`, {
                                    method: 'POST',
                                    headers: {
                                        'Authorization': `Bearer ${token}`,
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify(eventPayload)
                                });
                                
                                if (!response.ok) {
                                    const err = await response.json();
                                    console.error(`Erreur cr√©ation √©v√©nement pour ${agence.nom} le ${date}:`, err);
                                    continue;
                                }
                                
                                const data = await response.json();
                                eventIds.push({
                                    calendarId: calendarId,
                                    eventId: data.id,
                                    date: date,
                                    agenceNom: agence.nom
                                });
                            } catch (err) {
                                console.error(`Erreur cr√©ation √©v√©nement pour ${agence.nom} le ${date}:`, err);
                            }
                        }
                    }
                    
                    // Mettre √† jour la fermeture dans Firestore
                    const fermetureData = {
                        dateDebut: fermetureModal.dateDebut,
                        dateFin: fermetureModal.dateFin,
                        motif: motif,
                        tousProfessionnels: true,
                        eventIds: eventIds,
                        updatedAt: new Date().toISOString()
                    };
                    
                    await db.collection('fermetures').doc(fermetureModal.editingId).update(fermetureData);
                    
                    showNotification(`Fermeture mise √† jour pour ${dates.length} jour(s) dans ${professionnelsAvecAgenda.length} agenda(s)`, 'success', 'fa-calendar-check');
                    
                    // Fermer et r√©initialiser le modal
                    fermetureModal.open = false;
                    fermetureModal.dateDebut = '';
                    fermetureModal.dateFin = '';
                    fermetureModal.motif = '';
                    fermetureModal.tousProfessionnels = false;
                    fermetureModal.editingId = null;
                    
                    // Recharger la liste
                    await loadFermetures();
                } catch (err) {
                    console.error('Erreur mise √† jour fermeture:', err);
                    showNotification('Erreur lors de la mise √† jour de la fermeture', 'error', 'fa-exclamation-triangle');
                }
            };
            
            // Ouvrir le modal de confirmation pour supprimer une fermeture
            const deleteFermeture = (id) => {
                fermetureDeleteConfirmModal.fermetureId = id;
                fermetureDeleteConfirmModal.open = true;
            };
            
            // Confirmer et supprimer une fermeture et ses √©v√©nements Google Calendar
            const confirmDeleteFermeture = async () => {
                try {
                    const id = fermetureDeleteConfirmModal.fermetureId;
                    if (!id) {
                        fermetureDeleteConfirmModal.open = false;
                        return;
                    }
                    
                    // Fermer le modal imm√©diatement
                    fermetureDeleteConfirmModal.open = false;
                    fermetureDeleteConfirmModal.fermetureId = null;
                    
                    // R√©cup√©rer la fermeture
                    const fermetureDoc = await db.collection('fermetures').doc(id).get();
                    if (!fermetureDoc.exists) {
                        showNotification('Fermeture introuvable', 'error', 'fa-exclamation-triangle');
                        return;
                    }
                    
                    const fermeture = fermetureDoc.data();
                    const eventIds = fermeture.eventIds || [];
                    
                    // V√©rifier la connexion Google Calendar pour supprimer les √©v√©nements
                    const token = getActiveGoogleToken();
                    if (!token && eventIds.length > 0) {
                        showNotification('Vous devez √™tre connect√© √† Google Calendar pour supprimer les √©v√©nements', 'error', 'fa-exclamation-triangle');
                        // Proposer de se connecter
                        if (user.role === 'admin') {
                            setTimeout(() => {
                                reconnectAgendaModal.open = true;
                            }, 500);
                        }
                        return;
                    }
                    
                    // Supprimer la fermeture de Firestore d'abord
                    await db.collection('fermetures').doc(id).delete();
                    
                    if (eventIds.length === 0) {
                        showNotification('Fermeture supprim√©e', 'success', 'fa-calendar-times');
                        await loadFermetures();
                        return;
                    }
                    
                    // Supprimer tous les √©v√©nements Google Calendar en arri√®re-plan
                    let deletedCount = 0;
                    for (const eventInfo of eventIds) {
                        try {
                            if (!eventInfo.calendarId || !eventInfo.eventId) {
                                console.warn('EventInfo incomplet:', eventInfo);
                                continue;
                            }
                            
                            const response = await fetch(`https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(eventInfo.calendarId)}/events/${eventInfo.eventId}`, {
                                method: 'DELETE',
                                headers: {
                                    'Authorization': `Bearer ${token}`
                                }
                            });
                            
                            if (response.ok || response.status === 404) {
                                deletedCount++;
                            } else {
                                const errorText = await response.text();
                                console.error(`Erreur suppression √©v√©nement ${eventInfo.eventId}:`, errorText);
                            }
                        } catch (err) {
                            console.error(`Erreur suppression √©v√©nement ${eventInfo.eventId}:`, err);
                        }
                    }
                    
                    showNotification(`Fermeture supprim√©e (${deletedCount}/${eventIds.length} √©v√©nements retir√©s)`, 'success', 'fa-calendar-times');
                    await loadFermetures();
                } catch (err) {
                    console.error('Erreur suppression fermeture:', err);
                    showNotification('Erreur lors de la suppression de la fermeture', 'error', 'fa-exclamation-triangle');
                }
            };
            
            // Retirer un rendez-vous de l'agenda Google
            const removeFromAgenda = async (rdv) => {
                try {
                    if (!googleCalendarConnected.value || !googleAccessToken.value) {
                        alert('‚ö†Ô∏è Vous n\'√™tes pas connect√© √† Google Calendar.');
                        return;
                    }
                    
                    // Activer l'indicateur de chargement
                    if (clientModal.rdv && clientModal.rdv.id === rdv.id) {
                        clientModal.removingFromAgenda = true;
                    }
                    
                    // Supprimer l'√©v√©nement Google Calendar si l'ID existe
                    if (rdv.googleCalendarEventId) {
                        try {
                            await deleteGoogleCalendarEvent(rdv);
                            console.log('‚úÖ √âv√©nement supprim√© de Google Calendar');
                        } catch (deleteErr) {
                            // Si l'√©v√©nement n'existe plus (404), c'est OK
                            if (deleteErr.message && !deleteErr.message.includes('404') && !deleteErr.message.includes('not found')) {
                                console.warn('‚ö†Ô∏è Erreur lors de la suppression de l\'√©v√©nement Google Calendar:', deleteErr);
                                // On continue quand m√™me pour mettre √† jour la base de donn√©es
                            } else {
                                console.log('‚ÑπÔ∏è √âv√©nement d√©j√† supprim√© ou introuvable');
                            }
                        }
                    }
                    
                    // Mettre √† jour le RDV dans Firestore
                    await db.collection('rendezvous').doc(rdv.id).update({
                        dansAgenda: false,
                        googleCalendarEventId: null
                    });
                    
                    // Mettre √† jour localement
                    rdv.dansAgenda = false;
                    rdv.googleCalendarEventId = null;
                    
                    if (clientModal.rdv && clientModal.rdv.id === rdv.id) {
                        clientModal.rdv.dansAgenda = false;
                        clientModal.rdv.googleCalendarEventId = null;
                    }
                    
                    showNotification('Rendez-vous retir√© de l\'agenda avec succ√®s', 'success', 'fa-calendar-times');
                    removeAgendaConfirmModal.open = false;
                } catch (err) {
                    console.error('Erreur lors de la suppression de l\'agenda:', err);
                    showNotification('Erreur lors de la suppression', 'error', 'fa-exclamation-triangle');
                    removeAgendaConfirmModal.open = false;
                } finally {
                    // D√©sactiver l'indicateur de chargement
                    if (clientModal.rdv && clientModal.rdv.id === rdv.id) {
                        clientModal.removingFromAgenda = false;
                    }
                }
            };
            
            const copyToAgenda = async (rdv, event) => {
                try {
                    // Si connect√© √† Google Calendar, cr√©er l'√©v√©nement via l'API
                    if (googleCalendarConnected.value && googleAccessToken.value) {
                        await createGoogleCalendarEvent(rdv);
                        
                        if (event) {
                            const btn = event.target.closest('button');
                            if (btn) {
                                const originalText = btn.innerHTML;
                                btn.innerHTML = '<i class="fa-solid fa-check text-[10px]"></i> <span>Cr√©√© !</span>';
                                btn.classList.add('bg-green-100', 'text-green-700', 'border-green-300');
                                setTimeout(() => {
                                    btn.innerHTML = originalText;
                                    btn.classList.remove('bg-green-100', 'text-green-700', 'border-green-300');
                                }, 2000);
                            }
                        }
                        return;
                    }
                    
                    // Sinon, utiliser l'ancienne m√©thode (ouvrir Google Calendar)
                    const civilite = rdv.civilite || '';
                    const nom = rdv.nom || '';
                    const telephone = rdv.telephone || '';
                    const modele = rdv.modele || '';
                    const agenceNom = getAgenceName(rdv.agenceId) || '';
                    
let prefixTitre = '';
                if (rdv.statut === 'annule') prefixTitre = '[ANNUL√â] ';
                const titre = `${prefixTitre}C&N - ${civilite} ${nom} - ${telephone} - ${modele}`;                    
                    const agence = agences.value.find(a => a.id === rdv.agenceId);
                    const agendaEmail = agence?.agendaEmail || '';
                    const agendaColor = agence?.agendaColor || '3';
                    
                    let dateStart = '';
                    let dateEnd = '';
                    
                    if (rdv.date && rdv.heure) {
                        const [year, month, day] = rdv.date.split('-').map(Number);
                        const [hours, minutes] = rdv.heure.split(':').map(Number);
                        const rdvDate = new Date(year, month - 1, day, hours, minutes, 0);
                        const startDate = new Date(rdvDate);
                        const startStr = startDate.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                        const endDate = new Date(rdvDate);
                        endDate.setHours(endDate.getHours() + 1);
                        const endStr = endDate.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                        dateStart = startStr;
                        dateEnd = endStr;
                    }
                    
                    const params = new URLSearchParams();
                    // Pour les agendas partag√©s, utiliser le param√®tre src avec l'email du calendrier
                    if (agendaEmail && agendaEmail.trim() !== '') {
                        // Nettoyer l'email et l'encoder correctement
                        const cleanEmail = agendaEmail.trim();
                        params.append('src', cleanEmail);
                    }
                    params.append('action', 'TEMPLATE');
                    params.append('text', titre);
                    if (dateStart && dateEnd) {
                        params.append('dates', `${dateStart}/${dateEnd}`);
                    }
                    if (agenceNom) {
                        params.append('location', agenceNom);
                    }
                    const colorIdNum = parseInt(agendaColor) || 3;
                    if (colorIdNum >= 1 && colorIdNum <= 11) {
                        params.append('colorId', colorIdNum.toString());
                    }
                    
                    // Construire l'URL avec le param√®tre src pour l'agenda partag√©
                    const googleCalendarUrl = `https://calendar.google.com/calendar/u/0/r/eventedit?${params.toString()}`;
                    window.open(googleCalendarUrl, '_blank');
                    
                    if (event) {
                        const btn = event.target.closest('button');
                        if (btn) {
                            const originalText = btn.innerHTML;
                            btn.innerHTML = '<i class="fa-solid fa-check text-[10px]"></i> <span>Ouvert !</span>';
                            btn.classList.add('bg-green-100', 'text-green-700', 'border-green-300');
                            setTimeout(() => {
                                btn.innerHTML = originalText;
                                btn.classList.remove('bg-green-100', 'text-green-700', 'border-green-300');
                            }, 2000);
                        }
                    }
                } catch (err) {
                    console.error('Erreur Google Calendar:', err);
                    const errorMessage = err.message || 'Erreur lors de la cr√©ation de l\'√©v√©nement';
                    
                    // Afficher un message d'erreur plus clair
                    if (event) {
                        const btn = event.target.closest('button');
                        if (btn) {
                            const originalText = btn.innerHTML;
                            btn.innerHTML = '<i class="fa-solid fa-exclamation-triangle text-[10px]"></i> <span>Erreur</span>';
                            btn.classList.add('bg-red-100', 'text-red-700', 'border-red-300');
                            setTimeout(() => {
                                btn.innerHTML = originalText;
                                btn.classList.remove('bg-red-100', 'text-red-700', 'border-red-300');
                            }, 3000);
                        }
                    }
                    
                    // Afficher une alerte avec le message d'erreur d√©taill√©
                    alert('‚ùå Erreur Google Calendar\n\n' + errorMessage + '\n\nüí° V√©rifiez que :\n- L\'email de l\'agenda partag√© est correct dans les param√®tres de l\'agence\n- Vous avez les permissions d\'√©criture sur cet agenda partag√©\n- Vous √™tes bien connect√© √† Google Calendar');
                }
            };

            // Variables pour le calendrier semaine
            const getWeekStart = (date) => {
                const d = new Date(date);
                d.setHours(0, 0, 0, 0);
                const day = d.getDay();
                // Convertir dimanche (0) en 7 pour faciliter le calcul
                const dayOfWeek = day === 0 ? 7 : day;
                // Calculer le lundi de la semaine (jour 1)
                const diff = d.getDate() - dayOfWeek + 1;
                const monday = new Date(d);
                monday.setDate(diff);
                return monday;
            };

            const currentWeekStart = ref(getWeekStart(new Date()));
            const calendarEvents = ref({}); // { '2024-01-15': [{type: 'google', ...}, {type: 'rdv', ...}] }
            const calendarLoading = ref(false);
            const calendarAgencyFilter = ref('');
            const calendarHours = Array.from({length: 16}, (_, i) => {
                const hour = 8 + i;
                return `${String(hour).padStart(2, '0')}:00`;
            });

            // Navigation du calendrier
            const previousWeek = () => {
                const newDate = new Date(currentWeekStart.value);
                newDate.setDate(newDate.getDate() - 7);
                currentWeekStart.value = newDate;
                loadCalendarEvents();
            };

            const nextWeek = () => {
                const newDate = new Date(currentWeekStart.value);
                newDate.setDate(newDate.getDate() + 7);
                currentWeekStart.value = newDate;
                loadCalendarEvents();
            };

            const goToToday = () => {
                currentWeekStart.value = getWeekStart(new Date());
                loadCalendarEvents();
            };

            // Calculer les jours de la semaine
            const calendarWeekDays = computed(() => {
                const days = [];
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayStr = today.toISOString().split('T')[0];

                const dayNames = ['DIM.', 'LUN.', 'MAR.', 'MER.', 'JEU.', 'VEN.', 'SAM.'];

                // S'assurer que currentWeekStart est bien un lundi
                const weekStart = new Date(currentWeekStart.value);
                weekStart.setHours(0, 0, 0, 0);

                for (let i = 0; i < 7; i++) {
                    const date = new Date(weekStart);
                    date.setDate(weekStart.getDate() + i);
                    date.setHours(0, 0, 0, 0);
                    
                    // Utiliser toLocaleDateString pour √©viter les probl√®mes de timezone
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const dateStr = `${year}-${month}-${day}`;
                    
                    const isToday = dateStr === todayStr;
                    const dayOfWeek = date.getDay(); // 0 = dimanche, 1 = lundi, etc.

                    days.push({
                        date: dateStr,
                        dayName: dayNames[dayOfWeek],
                        dayNumber: date.getDate(),
                        isToday,
                        dayOfWeek
                    });
                }

                return days;
            });

            // R√©cup√©rer les √©v√©nements Google Calendar
            const fetchGoogleCalendarEvents = async () => {
                if (!googleAccessToken.value) return;

                calendarLoading.value = true;
                try {
                    // R√©cup√©rer les agendas selon le filtre
                    const calendarIds = [];
                    
                    if (calendarAgencyFilter.value) {
                        // Si un filtre d'agence est s√©lectionn√©, utiliser UNIQUEMENT cet agenda
                        const agence = agences.value.find(a => a.id === calendarAgencyFilter.value);
                        if (agence && agence.agendaEmail && agence.agendaEmail.trim()) {
                            calendarIds.push(agence.agendaEmail.trim());
                        } else {
                            // Si l'agence n'a pas d'email sp√©cifique, utiliser primary
                            calendarIds.push('primary');
                        }
                    } else {
                        // Sinon, r√©cup√©rer tous les agendas partag√©s
                        calendarIds.push('primary');
                        agences.value.forEach(agence => {
                            if (agence.agendaEmail && agence.agendaEmail.trim()) {
                                calendarIds.push(agence.agendaEmail.trim());
                            }
                        });
                    }

                    // Calculer la plage de dates (semaine en cours)
                    const startDate = new Date(currentWeekStart.value);
                    startDate.setHours(0, 0, 0, 0);
                    const endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 7);
                    endDate.setHours(23, 59, 59, 999);
                    
                    const timeMin = startDate.toISOString();
                    const timeMax = endDate.toISOString();

                    const allEvents = [];
                    const allGoogleEvents = []; // Pour la synchronisation des statuts

                    // R√©cup√©rer les √©v√©nements de chaque calendrier
                    for (const calendarId of calendarIds) {
                        try {
                            const encodedId = encodeURIComponent(calendarId);
                            const url = `https://www.googleapis.com/calendar/v3/calendars/${encodedId}/events?timeMin=${timeMin}&timeMax=${timeMax}&singleEvents=true&orderBy=startTime`;
                            
                            const response = await fetch(url, {
                                headers: {
                                    'Authorization': `Bearer ${googleAccessToken.value}`
                                }
                            });

                            if (response.ok) {
                                const data = await response.json();
                                if (data.items) {
                                    // Ajouter tous les √©v√©nements pour la synchronisation
                                    allGoogleEvents.push(...data.items);
                                    
                                    data.items.forEach(event => {
                                        const start = event.start?.dateTime || event.start?.date;
                                        if (start) {
                                            const eventDate = new Date(start);
                                            // Utiliser toLocaleDateString pour √©viter les probl√®mes de timezone
                                            const year = eventDate.getFullYear();
                                            const month = String(eventDate.getMonth() + 1).padStart(2, '0');
                                            const day = String(eventDate.getDate()).padStart(2, '0');
                                            const dateStr = `${year}-${month}-${day}`;
                                            
                                            if (!allEvents[dateStr]) {
                                                allEvents[dateStr] = [];
                                            }
                                            
                                            // Filtrer par agence si un filtre est actif
                                            if (calendarAgencyFilter.value) {
                                                const agence = agences.value.find(a => a.id === calendarAgencyFilter.value);
                                                // Ne garder que les √©v√©nements de l'agence s√©lectionn√©e
                                                if (agence && agence.agendaEmail && agence.agendaEmail.trim() === calendarId) {
                                                    allEvents[dateStr].push({
                                                        type: 'google',
                                                        id: event.id,
                                                        summary: event.summary || 'Sans titre',
                                                        start: event.start,
                                                        end: event.end,
                                                        location: event.location || '',
                                                        color: getCalendarColor(parseInt(agence.agendaColor || '3'))
                                                    });
                                                }
                                            } else {
                                                // Si pas de filtre, afficher tous les √©v√©nements
                                                allEvents[dateStr].push({
                                                    type: 'google',
                                                    id: event.id,
                                                    summary: event.summary || 'Sans titre',
                                                    start: event.start,
                                                    end: event.end,
                                                    location: event.location || '',
                                                    color: getCalendarColor(parseInt(agences.value.find(a => a.agendaEmail === calendarId)?.agendaColor || '3'))
                                                });
                                            }
                                        }
                                    });
                                }
                            }
                        } catch (err) {
                            console.warn(`Erreur lors de la r√©cup√©ration du calendrier ${calendarId}:`, err);
                        }
                    }

                    // Mettre √† jour les √©v√©nements (remplacer les anciens √©v√©nements Google)
                    Object.keys(allEvents).forEach(dateStr => {
                        if (!calendarEvents.value[dateStr]) {
                            calendarEvents.value[dateStr] = [];
                        }
                        // Supprimer les anciens √©v√©nements Google et ajouter les nouveaux
                        calendarEvents.value[dateStr] = [
                            ...calendarEvents.value[dateStr].filter(e => e.type !== 'google'),
                            ...allEvents[dateStr]
                        ];
                    });

                } catch (err) {
                    console.error('Erreur lors de la r√©cup√©ration des √©v√©nements Google Calendar:', err);
                } finally {
                    calendarLoading.value = false;
                }
            };

            const saveSyncSettings = async () => {
                try {
                    await db.collection('settings').doc('calendar_sync').set({
                        syncAfterRdvTime: syncSettings.syncAfterRdvTime,
                        syncInterval: syncSettings.syncInterval,
                        updatedAt: new Date().toISOString()
                    }, { merge: true });
                } catch (err) {
                    console.error('Erreur lors de la sauvegarde des r√©glages de synchronisation:', err);
                }
            };

            // Fonction de synchronisation manuelle (pour forcer la synchronisation imm√©diatement)
            const manualSyncGoogleCalendar = async () => {
                if (!googleCalendarConnected.value || !googleAccessToken.value) {
                    alert('Google Calendar n\'est pas connect√©.');
                    return;
                }

                try {
                    // Afficher un indicateur de chargement
                    const loadingMsg = 'Synchronisation en cours...';
                    console.log(loadingMsg);

                    // R√©cup√©rer les √©v√©nements des 7 derniers jours et 7 prochains jours
                    const now = new Date();
                    const startDate = new Date(now);
                    startDate.setDate(startDate.getDate() - 7);
                    startDate.setHours(0, 0, 0, 0);
                    const endDate = new Date(now);
                    endDate.setDate(endDate.getDate() + 7);
                    endDate.setHours(23, 59, 59, 999);
                    
                    const timeMin = startDate.toISOString();
                    const timeMax = endDate.toISOString();
                    
                    // R√©cup√©rer tous les calendriers
                    const calendarIds = ['primary'];
                    agences.value.forEach(agence => {
                        if (agence.agendaEmail && agence.agendaEmail.trim()) {
                            calendarIds.push(agence.agendaEmail.trim());
                        }
                    });
                    
                    const allGoogleEvents = [];
                    for (const calendarId of calendarIds) {
                        try {
                            const encodedId = encodeURIComponent(calendarId);
                            const url = `https://www.googleapis.com/calendar/v3/calendars/${encodedId}/events?timeMin=${timeMin}&timeMax=${timeMax}&singleEvents=true&orderBy=startTime`;
                            
                            const response = await fetch(url, {
                                headers: {
                                    'Authorization': `Bearer ${googleAccessToken.value}`
                                }
                            });
                            
                            if (response.ok) {
                                const data = await response.json();
                                if (data.items) {
                                    allGoogleEvents.push(...data.items);
                                }
                            }
                        } catch (err) {
                            console.warn(`Erreur synchronisation calendrier ${calendarId}:`, err);
                        }
                    }
                    
                    alert('‚úÖ Synchronisation termin√©e !');
                    console.log('‚úÖ Synchronisation manuelle Google Calendar effectu√©e');
                } catch (err) {
                    console.error('Erreur synchronisation manuelle:', err);
                    alert('‚ùå Erreur lors de la synchronisation. V√©rifiez la console pour plus de d√©tails.');
                }
            };

            // Charger les √©v√©nements du calendrier (Google + RDV)
            const loadCalendarEvents = () => {
                // R√©initialiser les √©v√©nements pour la semaine en cours
                const startDate = new Date(currentWeekStart.value);
                startDate.setHours(0, 0, 0, 0);
                const endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 7);
                
                // Nettoyer les anciens √©v√©nements qui ne sont plus dans la plage
                Object.keys(calendarEvents.value).forEach(dateStr => {
                    const date = new Date(dateStr);
                    if (date < startDate || date >= endDate) {
                        delete calendarEvents.value[dateStr];
                    }
                });

                // Charger les RDV de l'application avec filtre d'agence
                rdvList.value.forEach(rdv => {
                    if (rdv.date && rdv.statut !== 'poubelle') {
                        // Filtrer par agence si un filtre est s√©lectionn√©
                        if (calendarAgencyFilter.value && rdv.agenceId !== calendarAgencyFilter.value) {
                            return;
                        }

                        // Utiliser directement la date string pour √©viter les probl√®mes de timezone
                        const dateStr = rdv.date;
                        const rdvDateOnly = new Date(dateStr + 'T00:00:00');
                        const startDateOnly = new Date(startDate.toISOString().split('T')[0] + 'T00:00:00');
                        const endDateOnly = new Date(endDate.toISOString().split('T')[0] + 'T00:00:00');
                        
                        if (rdvDateOnly >= startDateOnly && rdvDateOnly < endDateOnly) {
                            if (!calendarEvents.value[dateStr]) {
                                calendarEvents.value[dateStr] = [];
                            }
                            // V√©rifier si le RDV n'est pas d√©j√† dans la liste
                            const existingIndex = calendarEvents.value[dateStr].findIndex(e => e.type === 'rdv' && e.id === rdv.id);
                            if (existingIndex >= 0) {
                                // Mettre √† jour l'√©v√©nement existant
                                calendarEvents.value[dateStr][existingIndex] = {
                                    type: 'rdv',
                                    id: rdv.id,
                                    ...rdv
                                };
                            } else {
                                // Ajouter le nouvel √©v√©nement
                                calendarEvents.value[dateStr].push({
                                    type: 'rdv',
                                    id: rdv.id,
                                    ...rdv
                                });
                            }
                        }
                    }
                });

                // Charger les √©v√©nements Google Calendar si connect√©
                if (googleCalendarConnected.value) {
                    fetchGoogleCalendarEvents();
                }
            };

            const refreshCalendarEvents = () => {
                calendarEvents.value = {};
                loadCalendarEvents();
            };

            // Obtenir les horaires pour un jour sp√©cifique
            const getDayHours = (agence, dateStr) => {
                if (!agence) return null;
                
                const date = new Date(dateStr + 'T00:00:00');
                const dayIndex = date.getDay(); // 0 = dimanche, 1 = lundi, etc.
                // Convertir dimanche (0) en 6 pour correspondre √† notre index
                const adjustedDayIndex = dayIndex === 0 ? 6 : dayIndex - 1;
                
                // V√©rifier si des horaires sp√©cifiques existent pour ce jour
                const dayOpen = agence[`horaires_${adjustedDayIndex}_ouverture`];
                const dayClose = agence[`horaires_${adjustedDayIndex}_fermeture`];
                
                if (dayOpen && dayClose) {
                    return { open: dayOpen, close: dayClose };
                }
                
                // Sinon utiliser les horaires par d√©faut
                if (agence.heureOuverture && agence.heureFermeture) {
                    return { open: agence.heureOuverture, close: agence.heureFermeture };
                }
                
                return null;
            };

            // V√©rifier si un cr√©neau est dans une p√©riode de fermeture
            const isClosedSlot = (dateStr, hourStr) => {
                if (!calendarAgencyFilter.value) return false;
                
                const agence = agences.value.find(a => a.id === calendarAgencyFilter.value);
                if (!agence) return false;
                
                const dayHours = getDayHours(agence, dateStr);
                if (!dayHours) return false;
                
                const [hour, minute] = hourStr.split(':').map(Number);
                const [openHour, openMinute] = dayHours.open.split(':').map(Number);
                const [closeHour, closeMinute] = dayHours.close.split(':').map(Number);
                
                const currentTime = hour * 60 + minute;
                const openTime = openHour * 60 + openMinute;
                const closeTime = closeHour * 60 + closeMinute;
                
                // V√©rifier si c'est avant l'ouverture ou apr√®s la fermeture
                if (currentTime < openTime || currentTime >= closeTime) {
                    return true;
                }
                
                // V√©rifier si c'est pendant la pause d√©jeuner
                if (agence.heurePauseDebut && agence.heurePauseFin) {
                    const [pauseStartHour, pauseStartMin] = agence.heurePauseDebut.split(':').map(Number);
                    const [pauseEndHour, pauseEndMin] = agence.heurePauseFin.split(':').map(Number);
                    const pauseStart = pauseStartHour * 60 + pauseStartMin;
                    const pauseEnd = pauseEndHour * 60 + pauseEndMin;
                    if (currentTime >= pauseStart && currentTime < pauseEnd) {
                        return true;
                    }
                }
                
                return false;
            };

            // Obtenir le message de fermeture pour un cr√©neau
            const getClosedMessage = (dateStr, hourStr) => {
                if (!calendarAgencyFilter.value) return '';
                
                const agence = agences.value.find(a => a.id === calendarAgencyFilter.value);
                if (!agence) return '';
                
                const dayHours = getDayHours(agence, dateStr);
                if (!dayHours) return '';
                
                const [hour, minute] = hourStr.split(':').map(Number);
                const [openHour, openMinute] = dayHours.open.split(':').map(Number);
                const [closeHour, closeMinute] = dayHours.close.split(':').map(Number);
                
                const currentTime = hour * 60 + minute;
                const openTime = openHour * 60 + openMinute;
                const closeTime = closeHour * 60 + closeMinute;
                
                if (currentTime < openTime) {
                    return `Ferm√© - Ouverture √† ${dayHours.open}`;
                }
                
                if (currentTime >= closeTime) {
                    return `Ferm√© - Fermeture √† ${dayHours.close}`;
                }
                
                if (agence.heurePauseDebut && agence.heurePauseFin) {
                    const [pauseStartHour, pauseStartMin] = agence.heurePauseDebut.split(':').map(Number);
                    const [pauseEndHour, pauseEndMin] = agence.heurePauseFin.split(':').map(Number);
                    const pauseStart = pauseStartHour * 60 + pauseStartMin;
                    const pauseEnd = pauseEndHour * 60 + pauseEndMin;
                    if (currentTime >= pauseStart && currentTime < pauseEnd) {
                        return `Ferm√© - Pause de ${agence.heurePauseDebut} √† ${agence.heurePauseFin}`;
                    }
                }
                
                return '';
            };

            // Obtenir l'heure d'ouverture pour un jour sp√©cifique (pour la ligne visuelle)
            const getOpeningTime = (day) => {
                if (!calendarAgencyFilter.value) return null;
                
                const agence = agences.value.find(a => a.id === calendarAgencyFilter.value);
                if (!agence) return null;
                
                const dayHours = getDayHours(agence, day.date);
                if (!dayHours) return null;
                
                return dayHours.open;
            };

            // Obtenir les infos d'ouverture pour l'affichage dans l'en-t√™te
            const getDayHoursInfo = (day) => {
                if (!calendarAgencyFilter.value) return null;
                
                const agence = agences.value.find(a => a.id === calendarAgencyFilter.value);
                if (!agence) return null;
                
                const dayHours = getDayHours(agence, day.date);
                if (!dayHours) return null;
                
                const pause = agence.heurePauseDebut && agence.heurePauseFin 
                    ? `${agence.heurePauseDebut} - ${agence.heurePauseFin}` 
                    : null;
                
                return {
                    open: dayHours.open,
                    close: dayHours.close,
                    pause: pause
                };
            };

            // V√©rifier si un jour est compl√®tement ferm√©
            const isDayClosed = (day) => {
                if (!calendarAgencyFilter.value) return false;
                
                const agence = agences.value.find(a => a.id === calendarAgencyFilter.value);
                if (!agence) return false;
                
                const date = new Date(day.date + 'T00:00:00');
                const dayIndex = date.getDay();
                const adjustedDayIndex = dayIndex === 0 ? 6 : dayIndex - 1;
                
                // V√©rifier si le samedi est marqu√© comme ferm√©
                if (adjustedDayIndex === 5 && agence.samediFerme) {
                    return true;
                }
                
                // V√©rifier si le dimanche est marqu√© comme ferm√©
                if (adjustedDayIndex === 6 && agence.dimancheFerme) {
                    return true;
                }
                
                return false;
            };

            // Obtenir les √©v√©nements pour un cr√©neau horaire sp√©cifique
            const getEventsForSlot = (dateStr, hourStr) => {
                const events = calendarEvents.value[dateStr] || [];
                const [hour] = hourStr.split(':').map(Number);
                
                return events.filter(event => {
                    if (event.type === 'rdv') {
                        if (!event.heure) return false;
                        const [eventHour] = event.heure.split(':').map(Number);
                        return eventHour === hour;
                    } else if (event.type === 'google') {
                        const start = event.start?.dateTime || event.start?.date;
                        if (!start) return false;
                        const eventDate = new Date(start);
                        const eventHour = eventDate.getHours();
                        return eventHour === hour;
                    }
                    return false;
                });
            };

            // Obtenir le style d'un √©v√©nement (position et taille)
            const getEventStyle = (event, dateStr, hourStr) => {
                const [hour] = hourStr.split(':').map(Number);
                let top = 0;
                let height = 60; // Hauteur par d√©faut d'un cr√©neau (1 heure)

                if (event.type === 'google') {
                    const start = new Date(event.start?.dateTime || event.start?.date);
                    const end = new Date(event.end?.dateTime || event.end?.date);
                    const startHour = start.getHours();
                    const startMinute = start.getMinutes();
                    const duration = (end - start) / (1000 * 60); // Dur√©e en minutes
                    
                    if (startHour === hour) {
                        top = (startMinute / 60) * 60;
                        height = Math.max(20, (duration / 60) * 60);
                    } else {
                        return { display: 'none' };
                    }
                } else if (event.type === 'rdv') {
                    if (event.heure) {
                        const [eventHour, eventMinute] = event.heure.split(':').map(Number);
                        if (eventHour === hour) {
                            top = (eventMinute / 60) * 60;
                        } else {
                            return { display: 'none' };
                        }
                    }
                }

                // Couleur selon le type
                let backgroundColor = '#8b5cf6';
                if (event.type === 'google') {
                    backgroundColor = event.color || '#4285f4';
                } else if (event.type === 'rdv') {
                    // Si le rendez-vous est annul√©, utiliser la couleur rouge
                    if (event.statut === 'annule') {
                        backgroundColor = '#ef4444'; // Rouge
                    } else {
                    backgroundColor = getAgenceColor(event.agenceId);
                    }
                }

                return {
                    top: `${top}px`,
                    height: `${height}px`,
                    backgroundColor: backgroundColor
                };
            };

            // Obtenir le titre d'un √©v√©nement
            const getEventTitle = (event) => {
                if (event.type === 'rdv') {
                    let title = `${event.civilite || ''} ${event.nom || ''} ${event.modele ? '- ' + event.modele : ''}`.trim();
                    // Ajouter "(ANNULE)" devant le titre si le rendez-vous est annul√©
                    if (event.statut === 'annule') {
                        title = `(ANNULE) ${title}`;
                    }
                    return title;
                } else if (event.type === 'google') {
                    return event.summary || 'Sans titre';
                }
                return '';
            };

            // Obtenir l'heure d'un √©v√©nement
            const getEventTime = (event) => {
                if (event.type === 'rdv') {
                    return event.heure || '';
                } else if (event.type === 'google') {
                    const start = event.start?.dateTime || event.start?.date;
                    if (!start) return '';
                    const date = new Date(start);
                    return date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                }
                return '';
            };

            // V√©rifier si c'est le cr√©neau horaire actuel
            const isCurrentTimeSlot = (dateStr, hourStr) => {
                const now = new Date();
                const todayStr = now.toISOString().split('T')[0];
                const [hour] = hourStr.split(':').map(Number);
                return dateStr === todayStr && now.getHours() === hour;
            };

            // Obtenir le style pour la ligne d'ouverture
            const getOpeningLineStyle = (day) => {
                const openingTime = getOpeningTime(day);
                if (!openingTime) return { display: 'none' };
                
                const [hour, minute] = openingTime.split(':').map(Number);
                // Calculer la position exacte en pixels
                // Chaque cr√©neau horaire fait 60px de haut
                // Si l'ouverture est √† 9h30, c'est 1h30 apr√®s 8h00 = 1.5 cr√©neaux = 90px
                const hoursFromStart = hour - 8;
                const minutesInPixels = (minute / 60) * 60; // Convertir les minutes en pixels
                const topPosition = (hoursFromStart * 60) + minutesInPixels;
                
                return {
                    top: `${topPosition}px`
                };
            };

            // Cr√©er un RDV depuis un cr√©neau horaire
            const createRdvFromTimeSlot = (dateStr, hourStr) => {
                const [hour, minute = 0] = hourStr.split(':').map(Number);
                const timeStr = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
                
                // Ouvrir le wizard d'abord
                startWizard();
                
                // Pr√©-remplir le formulaire apr√®s l'initialisation
                setTimeout(() => {
                    form.date = dateStr;
                    form.heure = timeStr;
                    
                    // Pr√©-s√©lectionner l'agence si un filtre est actif
                    if (calendarAgencyFilter.value) {
                        const selectedAgence = agences.value.find(a => a.id === calendarAgencyFilter.value);
                        if (selectedAgence) {
                            form.agence = selectedAgence;
                            form.agenceId = calendarAgencyFilter.value;
                            // Passer directement √† l'√©tape 2 (Informations Client) car agence, date et heure sont d√©j√† d√©finis
                            wizard.step = 2;
                        }
                    }
                }, 100);
            };

            // Ouvrir les d√©tails d'un √©v√©nement
            const openEventDetails = (event) => {
                if (event.type === 'rdv') {
                    openRdvFiche(event);
                } else {
                    // Pour les √©v√©nements Google, on pourrait ouvrir une modal ou le lien
                    alert(`${event.summary}\n\n${getEventTime(event)}\n${event.location || ''}`);
                }
            };

            // Formater le titre de la semaine
            const formatCalendarWeekTitle = () => {
                const start = new Date(currentWeekStart.value);
                const end = new Date(start);
                end.setDate(start.getDate() + 6);
                
                const startStr = start.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long' });
                const endStr = end.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });
                
                if (start.getMonth() === end.getMonth()) {
                    return `${startStr} - ${end.getDate()} ${end.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' })}`;
                }
                return `${startStr} - ${endStr}`;
            };

            // Obtenir la couleur d'une agence
            const getAgenceColor = (agenceId) => {
                const agence = agences.value.find(a => a.id === agenceId);
                if (agence && agence.agendaColor) {
                    return getCalendarColor(parseInt(agence.agendaColor));
                }
                return '#8b5cf6';
            };

            // Auto-refresh toutes les 2 minutes
            let autoRefreshInterval = null;
            
            
            watch(() => view.value, (newView) => {
                // V√©rifier le token quand on arrive sur le dashboard
                if (newView === 'dashboard' && user.role === 'admin' && googleCalendarConnected.value) {
                    // V√©rifier le token apr√®s un court d√©lai pour laisser le temps √† la page de se charger
                    setTimeout(() => {
                        checkAndUpdateTokenStatus();
                    }, 500);
                }
                
                if (newView === 'agenda') {
                    loadCalendarEvents();
                    // D√©marrer l'auto-refresh
                    if (autoRefreshInterval) clearInterval(autoRefreshInterval);
                    autoRefreshInterval = setInterval(() => {
                        if (view.value === 'agenda' && googleCalendarConnected.value) {
                            refreshCalendarEvents();
                        }
                    }, 120000); // 2 minutes
                } else {
                    // Arr√™ter l'auto-refresh si on quitte la vue agenda
                    if (autoRefreshInterval) {
                        clearInterval(autoRefreshInterval);
                        autoRefreshInterval = null;
                    }
                }
            });

            // Charger les √©v√©nements quand on change de vue ou quand les donn√©es changent
            watch([() => currentWeekStart.value, () => calendarAgencyFilter.value, () => rdvList.value.length], () => {
                if (view.value === 'agenda') {
                    loadCalendarEvents();
                }
            });

            const filteredDaily = computed(() => { 
    if (!rdvList.value) return [];
    
    // 1. On prend l'horloge syst√®me (qui tourne toute seule)
    const d = new Date(now.value);
    
    // 2. Si le bouton "Demain" est activ√©, on ajoute 1 jour √† l'horloge
    if (isTimelineTomorrow.value) {
        d.setDate(d.getDate() + 1);
    }

    // 3. On formate la date cible
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    const targetDate = `${year}-${month}-${day}`;
    
    // 4. On filtre
    let list = rdvList.value.filter(r => r.date === targetDate && r.statut !== 'poubelle');
    
    // Filtres habituels
    if (dashboardFilters.agencyId) list = list.filter(r => r.agenceId === dashboardFilters.agencyId);
    if (dashboardFilters.userId) list = list.filter(r => r.createdBy === dashboardFilters.userId);
    if (dashboardFilters.onlyLive) list = list.filter(r => isEnCours(r));
    
    return list.sort((a,b) => a.heure.localeCompare(b.heure)).map(r => ({...r, agenceNom: agences.value.find(a=>a.id===r.agenceId)?.nom})); 
});
            const displayedDaily = computed(() => filteredDaily.value.slice(0, dashboardLimit.value));
            const sortedDaily = computed(() => displayedDaily.value);
            const rdvTodayCount = computed(() => filteredDaily.value.length);
            const timelineActiveCount = computed(() => {
                if (!rdvList.value) return 0;
                // Utiliser la m√™me logique que filteredDaily pour la date
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                const tomorrowStr = tomorrow.toISOString().split('T')[0];
                
                // Si on est en mode "demain", utiliser demain, sinon TOUJOURS utiliser aujourd'hui
                const targetDate = timelineShowTomorrow.value ? tomorrowStr : todayStr;
                
                let list = rdvList.value.filter(r => r.date === targetDate && r.statut !== 'poubelle');
                if (dashboardFilters.agencyId) list = list.filter(r => r.agenceId === dashboardFilters.agencyId);
                if (dashboardFilters.userId) list = list.filter(r => r.createdBy === dashboardFilters.userId);
                return list.filter(r => isEnCours(r)).length;
            });
            
            const isTimelineTomorrow = computed(() => timelineShowTomorrow.value);
            
            const showTimelineTomorrow = () => {
                // Basculer entre "aujourd'hui" et "demain"
                timelineShowTomorrow.value = !timelineShowTomorrow.value;
                // Mettre √† jour filters.date pour la coh√©rence (mais on ne l'utilise plus pour la logique)
                const today = new Date();
                if (timelineShowTomorrow.value) {
                    // Aller √† demain
                    const tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    filters.date = tomorrow.toISOString().split('T')[0];
                } else {
                    // Revenir √† aujourd'hui
                    filters.date = today.toISOString().split('T')[0];
                }
            };
            
            // Notifications visuelles
            const isNewRdvFromOther = (rdv) => {
                if (!rdv.created || !rdv.createdBy) return false;
                if (rdv.createdBy === user.name) return false; // Pas un RDV cr√©√© par moi
                try {
                    const createdDate = rdv.created && rdv.created.toDate ? rdv.created.toDate() : (rdv.created ? new Date(rdv.created) : null);
                    if (!createdDate) return false;
                    const now = new Date();
                    const diffMinutes = (now - createdDate) / (1000 * 60);
                    return diffMinutes > 0 && diffMinutes <= 30; // Nouveau si cr√©√© il y a moins de 30 minutes
                } catch (e) {
                    return false;
                }
            };
            
            const isRdvApproaching = (rdv) => {
                if (!rdv.date || !rdv.heure || rdv.statut === 'poubelle') return false;
                const today = new Date().toISOString().split('T')[0];
                if (rdv.date !== today) return false;
                
                const [hours, minutes] = rdv.heure.split(':').map(Number);
                const rdvTime = new Date();
                rdvTime.setHours(hours, minutes, 0, 0);
                
                const now = new Date();
                const diffMinutes = (rdvTime - now) / (1000 * 60);
                
                return diffMinutes > 0 && diffMinutes <= 15; // Entre maintenant et 15 minutes
            };
            
            const needsRappel = (rdv) => {
                if (!rdv.date || rdv.rappelFait) return false;
                if (!['confirme', 'a_confirmer'].includes(rdv.statut)) return false;
                // Exclure les rendez-vous qui ont √©t√© report√©s (un message de report a d√©j√† √©t√© envoy√©)
                if (rdv.motifDeplacement) return false;
                return isSoon(rdv.date) && !isCreatedToday(rdv.created);
            };
            
            const isSoon = (dStr) => {
                if (!dStr) return false;
                const nowDate = now.value ? new Date(now.value) : new Date();
                const today = new Date(nowDate); today.setHours(0, 0, 0, 0);
                const d = new Date(dStr); d.setHours(0, 0, 0, 0);
                const diffDays = Math.round((d - today) / 86400000);
                if (diffDays === 0) return true;
                if (diffDays === 1) { const hour = nowDate.getHours(); return hour >= 16; }
                return false;
            };

            const isCreatedToday = (d) => {
                if (!d) return false;
                const date = new Date(d);
                const today = new Date();
                return (date.getDate() === today.getDate() && date.getMonth() === today.getMonth() && date.getFullYear() === today.getFullYear());
            };

            const getDayDiff = (dStr) => {
                if (!dStr) return null;
                const base = now.value ? new Date(now.value) : new Date(); base.setHours(0, 0, 0, 0);
                const d = new Date(dStr); d.setHours(0, 0, 0, 0);
                return Math.round((d - base) / 86400000);
            };

            const rappelsList = computed(() => rdvList.value.filter((r) => ['confirme', 'a_confirmer'].includes(r.statut) && !r.rappelFait && !r.motifDeplacement && isSoon(r.date) && !isCreatedToday(r.created) && (getDayDiff(r.date) !== 0 || (r.heure && r.heure > new Date().toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'})))));
            const rappelFilters = reactive({ day: 'today', agenceId: '', userId: '' });
            const isRappelToday = (r) => getDayDiff(r.date) === 0;
            const isRappelTomorrow = (r) => getDayDiff(r.date) === 1;
            const rappelsDisplay = computed(() => {
                let list = rappelsList.value;
                if (rappelFilters.day === 'today') { list = list.filter((r) => isRappelToday(r)); } else if (rappelFilters.day === 'tomorrow') { list = list.filter((r) => isRappelTomorrow(r)); }
                if (rappelFilters.agenceId) { list = list.filter((r) => r.agenceId === rappelFilters.agenceId); }
                if (rappelFilters.userId) { list = list.filter((r) => r.createdBy === rappelFilters.userId); }
                return list;
            });
            const rappelsVeilleCount = computed(() => rappelsList.value.filter(r => isRappelTomorrow(r)).length);
            const rappelsJourCount = computed(() => rappelsList.value.filter(r => isRappelToday(r)).length);
            const confirmList = computed(() => rdvList.value.filter((r) => r.statut === 'a_confirmer'));
            const rappelCount = computed(() => rappelsList.value.length);
            const confirmCount = computed(() => confirmList.value.length);
            
            const detailedStats = computed(() => {
                // Utiliser les filtres de la modale, sinon ceux du dashboard, sinon le mois/ann√©e actuel
                const moisFilter = statsFilterMonth.value || dashboardFilters.mois;
                const anneeFilter = statsFilterYear.value || dashboardFilters.annee;
                const selectedMonth = moisFilter ? parseInt(moisFilter) - 1 : new Date().getMonth();
                const selectedYear = anneeFilter ? parseInt(anneeFilter) : new Date().getFullYear();
                const currentMonth = selectedMonth;
                const currentYear = selectedYear;
                
                let targetUser = statsFilterUser.value;
                if (user.role !== 'admin') {
                    targetUser = user.name;
                }

                let filteredList = rdvList.value.filter(r => { 
                    if (!r.date) return false; 
                    if (r.statut === 'poubelle') return false; 
                    const d = new Date(r.date); 
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear; 
                });
                if(statsFilterAgency.value) { filteredList = filteredList.filter(r => r.agenceId === statsFilterAgency.value); }
                if(targetUser) { filteredList = filteredList.filter(r => r.createdBy === targetUser); }
                
                const total = filteredList.length; 
                const honored = filteredList.filter(r => r.statut === 'honore').length; 
                const noshow = filteredList.filter(r => r.statut === 'pas_venu').length; 
                const finished = honored + noshow; 
                // Taux de conversion : 100% au d√©but du mois (quand finished = 0), sinon calcul normal
                const rate = finished > 0 ? Math.round((honored / finished) * 100) : (new Date().getDate() === 1 && new Date().getMonth() === currentMonth && new Date().getFullYear() === currentYear ? 100 : 0);
                return { total, honored, noshow, rate };
            });

            // Stats filtr√©es par commercial pour l'onglet Vue Commercial
            const commercialStatsFiltered = computed(() => {
                if (!stats.perfByCommercial || Object.keys(stats.perfByCommercial).length === 0) {
                    return {};
                }
                
                // Si l'utilisateur n'est pas admin, on montre seulement ses stats
                if (user.role !== 'admin') {
                    const userStats = stats.perfByCommercial[user.name];
                    return userStats ? { [user.name]: userStats } : {};
                }
                
                // Si c'est un admin et qu'un commercial est s√©lectionn√©, on montre seulement ce commercial
                if (statsFilterUser.value) {
                    const selectedStats = stats.perfByCommercial[statsFilterUser.value];
                    return selectedStats ? { [statsFilterUser.value]: selectedStats } : {};
                }
                
                // Sinon, on montre tous les commerciaux
                return stats.perfByCommercial;
            });
            
            // Statistiques mandats par agence
            const mandatsParAgence = computed(() => {
                // Utiliser les filtres de la modale, sinon ceux du dashboard, sinon le mois/ann√©e actuel
                const moisFilter = statsFilterMonth.value || dashboardFilters.mois;
                const anneeFilter = statsFilterYear.value || dashboardFilters.annee;
                const selectedMonth = moisFilter ? parseInt(moisFilter) - 1 : new Date().getMonth();
                const selectedYear = anneeFilter ? parseInt(anneeFilter) : new Date().getFullYear();
                const currentMonth = selectedMonth;
                const currentYear = selectedYear;
                
                let targetUser = statsFilterUser.value;
                if (user.role !== 'admin') {
                    targetUser = user.name;
                }
                
                // Filtrer UNIQUEMENT les RDV honor√©s du mois/ann√©e s√©lectionn√©
                let filteredList = rdvList.value.filter(r => {
                    if (!r.date) return false;
                    if (r.statut !== 'honore') return false; // SEULEMENT les RDV honor√©s
                    if (r.statut === 'poubelle') return false;
                    const d = new Date(r.date);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                });
                
                // Appliquer le filtre par agence si une agence est s√©lectionn√©e
                if(statsFilterAgency.value) {
                    // Convertir en string pour √©viter les probl√®mes de type
                    const selectedAgencyId = String(statsFilterAgency.value);
                    filteredList = filteredList.filter(r => {
                        // Si le RDV n'a pas d'agence, on l'exclut quand on filtre par agence
                        if (!r.agenceId) return false;
                        return String(r.agenceId) === selectedAgencyId;
                    });
                }
                
                if(targetUser) {
                    filteredList = filteredList.filter(r => r.createdBy === targetUser);
                }
                
                // Grouper par agence
                const statsByAgency = {};
                
                filteredList.forEach(rdv => {
                    const agenceId = rdv.agenceId || 'sans-agence';
                    if (!statsByAgency[agenceId]) {
                        statsByAgency[agenceId] = {
                            agenceId: agenceId,
                            nom: getAgenceName(agenceId),
                            total: 0,
                            mandatsSignes: 0
                        };
                    }
                    statsByAgency[agenceId].total++; // Total des RDV honor√©s
                    if (rdv.tag === 'OK M') {
                        statsByAgency[agenceId].mandatsSignes++;
                    }
                });
                
                // Convertir en tableau et trier par nombre de mandats sign√©s
                return Object.values(statsByAgency)
                    .sort((a, b) => b.mandatsSignes - a.mandatsSignes);
            });
            
            // Computed pour afficher le mois/ann√©e s√©lectionn√© dans la modale
            const statsModalSelectedPeriod = computed(() => {
                const moisFilter = statsFilterMonth.value || dashboardFilters.mois;
                const anneeFilter = statsFilterYear.value || dashboardFilters.annee;
                if (moisFilter && anneeFilter) {
                    const monthIndex = parseInt(moisFilter) - 1;
                    const MONTHS_FR = ["janvier","f√©vrier","mars","avril","mai","juin","juillet","ao√ªt","septembre","octobre","novembre","d√©cembre"];
                    return `${MONTHS_FR[monthIndex]} ${anneeFilter}`;
                }
                return new Date().toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
            });
            
            const openStatsModal = () => { 
                statsFilterAgency.value = ''; 
                statsFilterUser.value = ''; 
                // Initialiser avec les valeurs du dashboard ou le mois/ann√©e actuel
                const now = new Date();
                if (!statsFilterMonth.value) {
                    statsFilterMonth.value = dashboardFilters.mois || pad(now.getMonth() + 1);
                }
                if (!statsFilterYear.value) {
                    statsFilterYear.value = dashboardFilters.annee || now.getFullYear().toString();
                }
                statsModal.open = true; 
            };
            
            // Fonction pour r√©initialiser les filtres date du dashboard
            const resetDashboardDateFilters = () => {
                const now = new Date();
                dashboardFilters.mois = pad(now.getMonth() + 1);
                dashboardFilters.annee = now.getFullYear().toString();
            };
            
            // Fonction pour r√©initialiser les filtres date de la modale stats
            const resetStatsModalDateFilters = () => {
                const now = new Date();
                statsFilterMonth.value = pad(now.getMonth() + 1);
                statsFilterYear.value = now.getFullYear().toString();
            };
            
       // Fonction d'export des Statistiques (Version C&N Solutions + Filtres Agence/Commercial)
            const exportStatsPdf = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'portrait' });
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();

                // Palette de couleurs C&N
                const colorHeader = [30, 58, 138]; // Bleu nuit profond
                const colorBg = [248, 250, 252];   // Fond tr√®s clair
                const colorText = [51, 65, 85];    // Texte gris fonc√©
                const colorBlue = [37, 99, 235];   // Bleu vif
                const colorGreen = [22, 163, 74];  // Vert succ√®s
                const colorRed = [220, 38, 38];    // Rouge alerte
                
                // --- 1. DONN√âES & RECUPERATION DES FILTRES ---
                const statsData = detailedStats.value; 
                const rate = statsData.rate;

                const now = new Date();
                const monthNames = ['JANVIER', 'F√âVRIER', 'MARS', 'AVRIL', 'MAI', 'JUIN', 'JUILLET', 'AO√õT', 'SEPTEMBRE', 'OCTOBRE', 'NOVEMBRE', 'D√âCEMBRE'];
                const currentMonthLabel = monthNames[now.getMonth()];
                const currentYear = now.getFullYear();

                // R√©cup√©ration des noms pour l'affichage dans l'en-t√™te
                let agencyName = "Toutes les agences";
                if (statsFilterAgency.value) {
                    const ag = agences.value.find(a => a.id === statsFilterAgency.value);
                    if (ag) agencyName = ag.nom;
                }

                let commercialName = "Toute l'√©quipe";
                let targetUser = statsFilterUser.value;
                // Si ce n'est pas un admin, on force le nom de l'utilisateur connect√©
                if (user.role !== 'admin') {
                    targetUser = user.name;
                }
                if (targetUser) {
                    commercialName = targetUser;
                }

                // --- 2. EN-T√äTE MARQUE C&N SOLUTIONS ---
                
                // Fond de l'en-t√™te (Bandeau bleu haut)
                doc.setFillColor(...colorHeader);
                doc.rect(0, 0, pageWidth, 55, 'F'); // Agrandissement pour faire tenir les infos agence/comm

                // LOGO / NOM ENTREPRISE (Gauche)
                if (bilanConfig.logo) {
                    try {
                        doc.addImage(bilanConfig.logo, 'JPEG', 14, 10, 25, 25, undefined, 'FAST');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(20);
                        doc.setFont('helvetica', 'bold');
                        doc.text("C&N Solutions", 45, 22);
                    } catch (e) { 
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(22);
                        doc.setFont('helvetica', 'bold');
                        doc.text("C&N Solutions", 14, 25);
                    }
                } else {
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(22);
                    doc.setFont('helvetica', 'bold');
                    doc.text("C&N Solutions", 14, 25);
                }

                // TITRE & DATE (Haut Droite)
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text("RAPPORT DE PERFORMANCE", pageWidth - 14, 18, { align: 'right' });

                // Le Mois en Gros
                doc.setFontSize(24);
                doc.setFont('helvetica', 'bold');
                doc.text(currentMonthLabel, pageWidth - 14, 28, { align: 'right' });
                doc.setFontSize(14);
                doc.text(String(currentYear), pageWidth - 14, 35, { align: 'right' });

                // --- INFO FILTRES (Agence / Commercial) ---
                // Affichage en bas du bandeau bleu
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(203, 213, 225); // Gris clair
                
                let infoY = 48;
                doc.text(`AGENCE : ${agencyName.toUpperCase()}`, 14, infoY);
                
                // On affiche le commercial √† droite si un filtre est actif ou si c'est un prospecteur
                doc.text(`COMMERCIAL : ${commercialName.toUpperCase()}`, pageWidth - 14, infoY, { align: 'right' });

                let y = 75;

                // --- 3. JAUGE DE CONVERSION ---
                // Cadre
                doc.setDrawColor(226, 232, 240);
                doc.setFillColor(255, 255, 255);
                doc.roundedRect(14, y - 10, pageWidth - 28, 45, 3, 3, 'FD');

                doc.setTextColor(...colorText);
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text("Taux de Transformation Global", pageWidth / 2, y + 5, { align: 'center' });

                // Barre fond
                const barWidth = 150;
                const barHeight = 12;
                const barX = (pageWidth - barWidth) / 2;
                const barY = y + 12;

                doc.setFillColor(226, 232, 240);
                doc.roundedRect(barX, barY, barWidth, barHeight, 3, 3, 'F');

                // Barre remplissage
                let gaugeColor = rate < 50 ? colorRed : (rate < 80 ? [249, 115, 22] : colorGreen);
                if (rate > 0) {
                    doc.setFillColor(...gaugeColor);
                    doc.roundedRect(barX, barY, (rate / 100) * barWidth, barHeight, 3, 3, 'F');
                }
                
                // Score
                doc.setTextColor(...colorText);
                doc.text(`${rate}%`, pageWidth / 2, barY + 9, { align: 'center' });

                y += 50;

                // --- 4. CARTES KPI (Align√©es) ---
                const kpiY = y;
                const boxW = (pageWidth - 28 - 30) / 4; // 4 boites
                const boxH = 25;

                // Fonction petite boite
                const drawMiniBox = (offsetX, label, val, color) => {
                    doc.setFillColor(255, 255, 255);
                    doc.setDrawColor(226, 232, 240);
                    doc.roundedRect(offsetX, kpiY, boxW, boxH, 2, 2, 'FD');
                    
                    // Indicateur couleur
                    doc.setFillColor(...color);
                    doc.rect(offsetX, kpiY, 2, boxH, 'F'); // Ligne √† gauche

                    doc.setFontSize(8);
                    doc.setTextColor(100, 116, 139);
                    doc.text(label, offsetX + 6, kpiY + 8);

                    doc.setFontSize(14);
                    doc.setTextColor(...colorText);
                    doc.setFont('helvetica', 'bold');
                    doc.text(val.toString(), offsetX + 6, kpiY + 19);
                };

                drawMiniBox(14, "TOTAL PLAC√âS", statsData.total, colorBlue);
                drawMiniBox(14 + boxW + 10, "HONOR√âS", statsData.honored, colorGreen);
                drawMiniBox(14 + (boxW + 10)*2, "PAS VENUS", statsData.noshow, colorRed);
                drawMiniBox(14 + (boxW + 10)*3, "ANNUL√âS", (statsData.total - statsData.honored - statsData.noshow), [148, 163, 184]);

                y += 40;

                // --- 5. TABLEAU ---
                doc.setFontSize(14);
                doc.setTextColor(...colorHeader);
                doc.text("D√©tail par Agence", 14, y);
                y += 5;

                const tableData = mandatsParAgence.value.map(s => {
                    const taux = s.total > 0 ? Math.round((s.mandatsSignes / s.total) * 100) : 0;
                    return [
                        s.nom || 'Ind√©pendant',
                        s.total,
                        s.mandatsSignes, // "Honor√©s"
                        s.noshow || 0,
                        `${taux}%`
                    ];
                });

                doc.autoTable({
                    head: [['AGENCE', 'TOTAL', 'HONOR√âS', 'PAS VENUS', 'TAUX']],
                    body: tableData,
                    startY: y,
                    theme: 'striped',
                    headStyles: {
                        fillColor: colorHeader,
                        textColor: 255,
                        fontStyle: 'bold',
                        halign: 'center',
                        cellPadding: 4
                    },
                    bodyStyles: {
                        textColor: colorText,
                        fontSize: 10,
                        halign: 'center',
                        cellPadding: 4
                    },
                    columnStyles: {
                        0: { halign: 'left', fontStyle: 'bold' },
                        2: { textColor: colorGreen, fontStyle: 'bold' },
                        4: { fontStyle: 'bold' }
                    },
                    alternateRowStyles: {
                        fillColor: colorBg
                    },
                    margin: { left: 14, right: 14 }
                });

                // Pied de page
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text(`C&N Solutions - Document g√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')}`, pageWidth - 14, pageHeight - 10, { align: 'right' });

                doc.save(`Performance_${currentMonthLabel}_${currentYear}.pdf`);
            };
            
            // Calcul des commissions pour le commercial connect√© (AVEC LOGIQUE RECURRENTE)
            const userCommissionStats = computed(() => {
                if (user.role === 'admin') return null; 
                
                const basePrice = parseFloat(globalCommission.base) || 0;
                const bonusThreshold = parseInt(globalCommission.threshold) || 21;
                const bonusStep = parseInt(globalCommission.step) || 10;
                const bonusAmount = parseFloat(globalCommission.amount) || 100;

                const now = new Date(); const currentMonth = now.getMonth(); const currentYear = now.getFullYear();
                
                const honoredRdvs = rdvList.value.filter(r => {
                    if (r.statut !== 'honore' || r.createdBy !== user.name || !r.date) return false;
                    const d = new Date(r.date);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                });

                const count = honoredRdvs.length;
                let baseEarnings = count * basePrice;
                let bonusEarnings = 0;

                // Logique r√©currente: 
                // Si threshold=21, step=10, amount=100.
                // 21 -> 100
                // 31 -> 200
                if (count >= bonusThreshold) {
                    // (21-21)/10 + 1 = 1 * 100 = 100
                    // (31-21)/10 + 1 = 2 * 100 = 200
                    const multiplier = Math.floor((count - bonusThreshold) / bonusStep) + 1;
                    bonusEarnings = multiplier * bonusAmount;
                }

                // Add Tips
                const currentMonthKey = `${currentMonth}-${currentYear}`;
                // Get tip for this user from loaded tips object (reactive)
                const myUserEntry = teamList.value.find(u => u.name === user.name);
                let tipEarnings = 0;
                if(myUserEntry && tips[myUserEntry.id]) {
                    tipEarnings = tips[myUserEntry.id];
                }

                const totalEarnings = baseEarnings + bonusEarnings + tipEarnings;

                return { 
                    count, 
                    baseEarnings, 
                    bonusEarnings, 
                    tipEarnings, 
                    totalEarnings,
                    justReachedTier: (count >= bonusThreshold) && ((count - bonusThreshold) % bonusStep === 0) // Visual effect trigger
                };
            });

           // STATS ADMIN AVEC CALCUL MARGE (CORRIG√â : EXCLURE ADMINS DES COMMISSIONS) + FILTRES DASHBOARD
            const stats = computed(() => {
                const nowStr = new Date().toISOString().split('T')[0];
                // Utiliser les filtres du dashboard ou le mois/ann√©e actuel par d√©faut
                const selectedMonth = dashboardFilters.mois ? parseInt(dashboardFilters.mois) - 1 : new Date().getMonth();
                const selectedYear = dashboardFilters.annee ? parseInt(dashboardFilters.annee) : new Date().getFullYear();
                const currentMonth = selectedMonth;
                const currentYear = selectedYear;

                // Appliquer les filtres du dashboard
                let filteredRdvs = rdvList.value.filter(r => r.statut !== 'poubelle');
                if (dashboardFilters.agencyId) {
                    filteredRdvs = filteredRdvs.filter(r => r.agenceId === dashboardFilters.agencyId);
                }
                if (dashboardFilters.userId) {
                    filteredRdvs = filteredRdvs.filter(r => r.createdBy === dashboardFilters.userId);
                }
                if (dashboardFilters.commercialId && dashboardFilters.agencyId) {
                    filteredRdvs = filteredRdvs.filter(r => r.createdBy === dashboardFilters.commercialId);
                }

                const upcoming = filteredRdvs.filter(r => r.statut==='confirme' && r.date >= nowStr).length;
                
                // Filtrer les statistiques par mois en cours
                const honored = filteredRdvs.filter(r => {
                    if (r.statut !== 'honore' || !r.date) return false;
                    const d = new Date(r.date);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                }).length;
                
                const noshow = filteredRdvs.filter(r => {
                    if (r.statut !== 'pas_venu' || !r.date) return false;
                    const d = new Date(r.date);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                }).length;
                
                const cancelled = filteredRdvs.filter(r => {
                    if (r.statut !== 'annule' || !r.date) return false;
                    const d = new Date(r.date);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                }).length;

                // CA BRUT (Tout le monde compte pour le CA) - avec filtres - SEULEMENT CE MOIS
                const ca = filteredRdvs.filter(r => {
                    if (r.honorBilling !== 'facture' || !r.date) return false;
                    const d = new Date(r.date);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                }).reduce((acc,r) => { 
                    const price = getAgencePrice(r); 
                    const discount = parseFloat(r.geste_commercial) || 0; 
                    return acc + (price - discount); 
                }, 0);

                // CA Journalier - avec filtres
                const ca_daily = filteredRdvs.filter(r => r.honorBilling==='facture' && r.date === nowStr).reduce((acc,r) => { 
                    const price = getAgencePrice(r); 
                    const discount = parseFloat(r.geste_commercial) || 0; 
                    return acc + (price - discount); 
                }, 0);

                // Commissions Totales (Filtrage des Admins) - avec filtres
                const commissionMap = {}; 
                filteredRdvs.forEach(r => {
                    if (r.statut === 'honore' && r.date) {
                        const d = new Date(r.date);
                        if (d.getMonth() === currentMonth && d.getFullYear() === currentYear) {
                            const uName = r.createdBy || 'Syst√®me';
                            if (!commissionMap[uName]) commissionMap[uName] = 0;
                            commissionMap[uName]++;
                        }
                    }
                });

                let totalCommissions = 0;
                
                const basePrice = parseFloat(globalCommission.base) || 0;
                const bonusThreshold = parseInt(globalCommission.threshold) || 21;
                const bonusStep = parseInt(globalCommission.step) || 10;
                const bonusAmount = parseFloat(globalCommission.amount) || 100;

                for (const [userName, count] of Object.entries(commissionMap)) {
                    // --- NOUVELLE LOGIQUE : V√âRIFIER SI C'EST UN ADMIN ---
                    // 1. V√©rifier dans la liste des noms admins (hardcod√©/settings)
                    const isNameInAdminList = adminNamesList.value.includes(userName);
                    // 2. V√©rifier dans la liste des utilisateurs (r√¥le)
                    const userObj = teamList.value.find(u => u.name === userName);
                    const isRoleAdmin = userObj && userObj.role === 'admin';

                    // Si c'est un admin, on ne calcule PAS de commission (co√ªt = 0)
                    if (isNameInAdminList || isRoleAdmin) {
                        continue; 
                    }
                    // -----------------------------------------------------

                    let userTotal = count * basePrice;
                    if (count >= bonusThreshold) {
                        const multiplier = Math.floor((count - bonusThreshold) / bonusStep) + 1;
                        userTotal += (multiplier * bonusAmount);
                    }
                    
                    // Add Tips from teamList (seulement pour les non-admins)
                    if (userObj && tips[userObj.id]) {
                        userTotal += parseFloat(tips[userObj.id]);
                    }

                    totalCommissions += userTotal;
                }

                const net = ca - totalCommissions;

                // Statistiques avanc√©es - avec filtres - SEULEMENT CE MOIS
                const totalRdv = filteredRdvs.filter(r => {
                    if (!r.date) return false;
                    const d = new Date(r.date);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                }).length;
                // Taux de conversion : 100% au d√©but du mois (quand totalRdv = 0), sinon calcul normal
                const tauxConversion = totalRdv > 0 ? ((honored / totalRdv) * 100).toFixed(1) : '100.0';
                const tauxAnnulation = totalRdv > 0 ? ((cancelled / totalRdv) * 100).toFixed(1) : 0;
                const tauxNoShow = totalRdv > 0 ? ((noshow / totalRdv) * 100).toFixed(1) : 0;
                const caMoyenParRdv = honored > 0 ? (ca / honored).toFixed(2) : 0; // CA moyen par RDV honor√©
                
                // CA par jour (7 derniers jours) - avec filtres - SEULEMENT CE MOIS
                const caParJour = {};
                const honoredRdv = filteredRdvs.filter(r => {
                    if (r.honorBilling !== 'facture' || !r.date) return false;
                    const d = new Date(r.date);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                });
                honoredRdv.forEach(r => {
                    const price = getAgencePrice(r);
                    const discount = parseFloat(r.geste_commercial) || 0;
                    const netPrice = price - discount;
                    if (!caParJour[r.date]) caParJour[r.date] = 0;
                    caParJour[r.date] += netPrice;
                });
                
                // Top 5 clients (par nombre de RDV honor√©s)
                const clientStats = {};
                honoredRdv.forEach(r => {
                    const clientKey = `${r.civilite} ${r.nom}`.trim();
                    if (!clientStats[clientKey]) {
                        clientStats[clientKey] = { nom: clientKey, count: 0, ca: 0, telephone: r.telephone || '' };
                    }
                    clientStats[clientKey].count++;
                    const price = getAgencePrice(r);
                    const discount = parseFloat(r.geste_commercial) || 0;
                    clientStats[clientKey].ca += (price - discount);
                });
                const topClients = Object.values(clientStats)
                    .sort((a, b) => b.count - a.count)
                    .slice(0, 5);
                
                // Performance par commercial (ce mois) - avec filtres
                const perfByCommercial = {};
                filteredRdvs.forEach(r => {
                    if (r.statut === 'honore' && r.date && r.createdBy) {
                        const d = new Date(r.date);
                        if (d.getMonth() === currentMonth && d.getFullYear() === currentYear) {
                            const commercial = r.createdBy;
                            if (!perfByCommercial[commercial]) {
                                perfByCommercial[commercial] = { count: 0, ca: 0 };
                            }
                            perfByCommercial[commercial].count++;
                            const price = getAgencePrice(r);
                            const discount = parseFloat(r.geste_commercial) || 0;
                            perfByCommercial[commercial].ca += (price - discount);
                        }
                    }
                });
                
                // Statistiques par source
                const statsBySource = {};
                honoredRdv.forEach(r => {
                    if (r.source) {
                        if (!statsBySource[r.source]) {
                            statsBySource[r.source] = { count: 0, ca: 0 };
                        }
                        statsBySource[r.source].count++;
                        const price = getAgencePrice(r);
                        const discount = parseFloat(r.geste_commercial) || 0;
                        statsBySource[r.source].ca += (price - discount);
                    }
                });
                
                // Statistiques par agence - SEULEMENT CE MOIS
                const statsByAgency = {};
                // D'abord, compter tous les RDV par agence (total) - CE MOIS
                filteredRdvs.forEach(r => {
                    if (r.agenceId && r.date) {
                        const d = new Date(r.date);
                        if (d.getMonth() === currentMonth && d.getFullYear() === currentYear) {
                            const agenceName = getAgenceName(r.agenceId);
                            if (!statsByAgency[agenceName]) {
                                statsByAgency[agenceName] = { total: 0, count: 0, countWithMandat: 0, ca: 0 };
                            }
                            statsByAgency[agenceName].total++;
                        }
                    }
                });
                // Ensuite, compter les RDV honor√©s (avec mandat sign√© si possible)
                honoredRdv.forEach(r => {
                    if (r.agenceId) {
                        const agenceName = getAgenceName(r.agenceId);
                        if (!statsByAgency[agenceName]) {
                            statsByAgency[agenceName] = { total: 0, count: 0, countWithMandat: 0, ca: 0 };
                        }
                        statsByAgency[agenceName].count++;
                        // Compter ceux avec mandat sign√© (tag === 'OK M')
                        if (r.tag === 'OK M') {
                            statsByAgency[agenceName].countWithMandat++;
                        }
                        const price = getAgencePrice(r);
                        const discount = parseFloat(r.geste_commercial) || 0;
                        statsByAgency[agenceName].ca += (price - discount);
                    }
                });
                
                // CA par jour de la semaine (lundi=0, dimanche=6) - Ce mois
                const caParJourSemaine = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0 };
                honoredRdv.forEach(r => {
                    if (r.date) {
                        const d = new Date(r.date);
                        if (d.getMonth() === currentMonth && d.getFullYear() === currentYear) {
                            const jourSemaine = d.getDay();
                            const price = getAgencePrice(r);
                            const discount = parseFloat(r.geste_commercial) || 0;
                            caParJourSemaine[jourSemaine] += (price - discount);
                        }
                    }
                });
                
                // CA par jour de la semaine - Mois pr√©c√©dent
                const previousMonth = currentMonth === 0 ? 11 : currentMonth - 1;
                const previousYear = currentMonth === 0 ? currentYear - 1 : currentYear;
                const caParJourSemainePrevious = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0 };
                honoredRdv.forEach(r => {
                    if (r.date) {
                        const d = new Date(r.date);
                        if (d.getMonth() === previousMonth && d.getFullYear() === previousYear) {
                            const jourSemaine = d.getDay();
                            const price = getAgencePrice(r);
                            const discount = parseFloat(r.geste_commercial) || 0;
                            caParJourSemainePrevious[jourSemaine] += (price - discount);
                        }
                    }
                });
                
                // ANALYSE DE TENDANCES : Jours les plus rentables
                const joursRentables = Object.entries(caParJourSemaine)
                    .map(([jour, ca]) => ({ jour: parseInt(jour), jourNom: ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'][jour], ca }))
                    .sort((a, b) => b.ca - a.ca);
                const jourLePlusRentable = joursRentables[0];
                
                // ANALYSE DE TENDANCES : Heures optimales
                const caParHeure = {};
                honoredRdv.forEach(r => {
                    if (r.heure) {
                        const heure = r.heure.split(':')[0]; // Extraire l'heure (ex: "14" de "14:30")
                        const price = getAgencePrice(r);
                        const discount = parseFloat(r.geste_commercial) || 0;
                        if (!caParHeure[heure]) caParHeure[heure] = { ca: 0, count: 0 };
                        caParHeure[heure].ca += (price - discount);
                        caParHeure[heure].count++;
                    }
                });
                const heuresOptimales = Object.entries(caParHeure)
                    .map(([heure, data]) => ({ heure: parseInt(heure), ca: data.ca, count: data.count, caMoyen: data.ca / data.count }))
                    .sort((a, b) => b.ca - a.ca)
                    .slice(0, 5); // Top 5 heures
                
                return { 
                    upcoming, honored, noshow, cancelled, ca, ca_daily, commissions: totalCommissions, net,
                    totalRdv, tauxConversion, tauxAnnulation, tauxNoShow, caMoyenParRdv,
                    statsBySource, statsByAgency, caParJour, topClients, perfByCommercial, caParJourSemaine, caParJourSemainePrevious
                };
            });

            // STATS POUR LA MODALE AVEC FILTRES (Agence/Commercial/Mois/Ann√©e)
            const statsModalData = computed(() => {
                const nowStr = new Date().toISOString().split('T')[0];
                // Utiliser les filtres de la modale, sinon ceux du dashboard, sinon le mois/ann√©e actuel
                const moisFilter = statsFilterMonth.value || dashboardFilters.mois;
                const anneeFilter = statsFilterYear.value || dashboardFilters.annee;
                const selectedMonth = moisFilter ? parseInt(moisFilter) - 1 : new Date().getMonth();
                const selectedYear = anneeFilter ? parseInt(anneeFilter) : new Date().getFullYear();
                const currentMonth = selectedMonth;
                const currentYear = selectedYear;

                // Appliquer les filtres de la modale
                let filteredRdvs = rdvList.value.filter(r => r.statut !== 'poubelle');
                
                // Filtre par agence
                if (statsFilterAgency.value) {
                    filteredRdvs = filteredRdvs.filter(r => r.agenceId === statsFilterAgency.value);
                }
                
                // Filtre par commercial
                let targetUser = statsFilterUser.value;
                if (user.role !== 'admin') {
                    targetUser = user.name;
                }
                if (targetUser) {
                    filteredRdvs = filteredRdvs.filter(r => r.createdBy === targetUser);
                }

                const upcoming = filteredRdvs.filter(r => r.statut==='confirme' && r.date >= nowStr).length;
                
                // Filtrer les statistiques par mois/ann√©e s√©lectionn√©
                const honored = filteredRdvs.filter(r => {
                    if (r.statut !== 'honore' || !r.date) return false;
                    const d = new Date(r.date);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                }).length;
                
                const noshow = filteredRdvs.filter(r => {
                    if (r.statut !== 'pas_venu' || !r.date) return false;
                    const d = new Date(r.date);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                }).length;
                
                const cancelled = filteredRdvs.filter(r => {
                    if (r.statut !== 'annule' || !r.date) return false;
                    const d = new Date(r.date);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                }).length;

                // CA BRUT avec filtres - SEULEMENT LE MOIS/ANN√âE S√âLECTIONN√â
                const ca = filteredRdvs.filter(r => {
                    if (r.honorBilling !== 'facture' || !r.date) return false;
                    const d = new Date(r.date);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                }).reduce((acc,r) => { 
                    const price = getAgencePrice(r); 
                    const discount = parseFloat(r.geste_commercial) || 0; 
                    return acc + (price - discount); 
                }, 0);

                // Statistiques avanc√©es avec filtres - SEULEMENT LE MOIS/ANN√âE S√âLECTIONN√â
                const totalRdv = filteredRdvs.filter(r => {
                    if (!r.date) return false;
                    const d = new Date(r.date);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                }).length;
                // Taux de conversion : 100% au d√©but du mois (quand totalRdv = 0), sinon calcul normal
                const tauxConversion = totalRdv > 0 ? ((honored / totalRdv) * 100).toFixed(1) : '100.0';
                const tauxAnnulation = totalRdv > 0 ? ((cancelled / totalRdv) * 100).toFixed(1) : 0;
                const tauxNoShow = totalRdv > 0 ? ((noshow / totalRdv) * 100).toFixed(1) : 0;
                const caMoyenParRdv = honored > 0 ? (ca / honored).toFixed(2) : 0;

                // RDV honor√©s avec filtres - SEULEMENT LE MOIS/ANN√âE S√âLECTIONN√â
                const honoredRdv = filteredRdvs.filter(r => {
                    if (r.honorBilling !== 'facture' || !r.date) return false;
                    const d = new Date(r.date);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                });

                // Statistiques par source avec filtres
                const statsBySource = {};
                honoredRdv.forEach(r => {
                    if (r.source) {
                        if (!statsBySource[r.source]) {
                            statsBySource[r.source] = { count: 0, ca: 0 };
                        }
                        statsBySource[r.source].count++;
                        const price = getAgencePrice(r);
                        const discount = parseFloat(r.geste_commercial) || 0;
                        statsBySource[r.source].ca += (price - discount);
                    }
                });

                // Statistiques par agence avec filtres
                const statsByAgency = {};
                honoredRdv.forEach(r => {
                    if (r.agenceId) {
                        const agenceName = getAgenceName(r.agenceId);
                        if (!statsByAgency[agenceName]) {
                            statsByAgency[agenceName] = { count: 0, ca: 0 };
                        }
                        statsByAgency[agenceName].count++;
                        const price = getAgencePrice(r);
                        const discount = parseFloat(r.geste_commercial) || 0;
                        statsByAgency[agenceName].ca += (price - discount);
                    }
                });

                // Performance par commercial avec filtres
                const perfByCommercial = {};
                filteredRdvs.forEach(r => {
                    if (r.statut === 'honore' && r.date && r.createdBy) {
                        const d = new Date(r.date);
                        if (d.getMonth() === currentMonth && d.getFullYear() === currentYear) {
                            const commercial = r.createdBy;
                            if (!perfByCommercial[commercial]) {
                                perfByCommercial[commercial] = { count: 0, ca: 0 };
                            }
                            perfByCommercial[commercial].count++;
                            const price = getAgencePrice(r);
                            const discount = parseFloat(r.geste_commercial) || 0;
                            perfByCommercial[commercial].ca += (price - discount);
                        }
                    }
                });

                // CA par jour de la semaine - Ce mois avec filtres
                const caParJourSemaine = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0 };
                honoredRdv.forEach(r => {
                    if (r.date) {
                        const d = new Date(r.date);
                        if (d.getMonth() === currentMonth && d.getFullYear() === currentYear) {
                            const jourSemaine = d.getDay();
                            const price = getAgencePrice(r);
                            const discount = parseFloat(r.geste_commercial) || 0;
                            caParJourSemaine[jourSemaine] += (price - discount);
                        }
                    }
                });

                // CA par jour de la semaine - Mois pr√©c√©dent avec filtres
                const previousMonth = currentMonth === 0 ? 11 : currentMonth - 1;
                const previousYear = currentMonth === 0 ? currentYear - 1 : currentYear;
                const caParJourSemainePrevious = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0 };
                honoredRdv.forEach(r => {
                    if (r.date) {
                        const d = new Date(r.date);
                        if (d.getMonth() === previousMonth && d.getFullYear() === previousYear) {
                            const jourSemaine = d.getDay();
                            const price = getAgencePrice(r);
                            const discount = parseFloat(r.geste_commercial) || 0;
                            caParJourSemainePrevious[jourSemaine] += (price - discount);
                        }
                    }
                });

                return {
                    totalRdv, tauxConversion, tauxAnnulation, tauxNoShow, caMoyenParRdv,
                    statsBySource, statsByAgency, perfByCommercial, caParJourSemaine, caParJourSemainePrevious, honored
                };
            });

            const isLateAndNoStatus = (r) => { if(!r.date || !r.heure) return false; const start = new Date(r.date+'T'+r.heure); const end = new Date(start.getTime() + 60*60*1000); return now.value >= end && ['confirme','a_confirmer'].includes(r.statut); };
            const getProgressPercent = (r) => { if(!r.date || !r.heure) return 0; const start = new Date(r.date+'T'+r.heure).getTime(); const end = start + 3600000; const current = now.value.getTime(); if(current < start) return 0; if(current > end) return 100; return ((current - start) / (end - start)) * 100; };
            const getRdvTimeStatus = (r) => { if(!r.date || !r.heure) return 'futur'; const start = new Date(r.date+'T'+r.heure).getTime(); const current = now.value.getTime(); if(current >= start && current < start + 3600000) return 'en_cours'; if(current < start && (start - current) < 172800000) return 'bientot'; return 'futur'; };
            const getRelativeRdvLabel = (r) => { if (!r.date || !r.heure) return ''; const nowDate = now.value ? new Date(now.value) : new Date(); const start = new Date(r.date + 'T' + r.heure); const dureeRdvMs = 60 * 60 * 1000; const diffMs = start - nowDate; if (diffMs <= -dureeRdvMs) return ''; if (diffMs < 0 && diffMs > -dureeRdvMs) { return 'RDV en cours'; } const diffMin = Math.round(diffMs / 60000); if (diffMin < 1) { return "RDV dans moins d‚Äô1 minute"; } if (diffMin < 60) { return `RDV dans ${diffMin} min`; } const diffHours = Math.floor(diffMin / 60); const restMin = diffMin % 60; if (diffHours < 24) { if (restMin === 0) { return `RDV dans ${diffHours}h`; } return `RDV dans ${diffHours}h ${restMin}min`; } const diffDays = Math.round(diffMin / (24 * 60)); if (diffDays === 1) { return 'RDV dans 1 jour'; } return `RDV dans ${diffDays} jours`; };
            const nextRdvLabel = computed(() => { if (!rdvList.value || rdvList.value.length === 0) return ''; const todayStr = new Date().toISOString().split('T')[0]; const nowDate = now.value ? new Date(now.value) : new Date(); const candidates = rdvList.value.filter(r => r.date === todayStr && r.statut !== 'poubelle' && r.heure).map(r => ({ rdv: r, start: new Date(r.date + 'T' + r.heure) })).filter(o => o.start > nowDate); if (candidates.length === 0) return ''; candidates.sort((a, b) => a.start - b.start); return getRelativeRdvLabel(candidates[0].rdv); });
            const pendingStatusList = computed(() => { return rdvList.value.filter(r => { if(!['confirme', 'a_confirmer'].includes(r.statut)) return false; if(!r.date || !r.heure) return false; const end = new Date(r.date+'T'+r.heure).getTime() + 3600000; return now.value.getTime() > end; }); });
            const pendingStatusCount = computed(() => pendingStatusList.value.length);

            // Computed pour les stats du prospecteur
            const prospecteurStats = computed(() => {
                if (!selectedProspecteur.value) return { ca: 0, honoredCount: 0, commissions: 0, tips: 0, net: 0, tiers: [] };

                // Utiliser les filtres du dashboard ou le mois/ann√©e actuel par d√©faut
                const selectedMonth = dashboardFilters.mois ? parseInt(dashboardFilters.mois) - 1 : new Date().getMonth();
                const selectedYear = dashboardFilters.annee ? parseInt(dashboardFilters.annee) : new Date().getFullYear();
                const currentMonth = selectedMonth;
                const currentYear = selectedYear;
                
                // CA g√©n√©r√© (RDV honor√©s ce mois)
                const honoredRdv = rdvList.value.filter(r => {
                    if (r.statut !== 'honore' || r.createdBy !== selectedProspecteur.value) return false;
                    if (!r.date) return false;
                    const d = new Date(r.date);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                });

                const ca = honoredRdv.reduce((acc, r) => {
                    const price = getAgencePrice(r);
                    const discount = parseFloat(r.geste_commercial) || 0;
                    return acc + (price - discount);
                }, 0);

                const honoredCount = honoredRdv.length;

                // Calcul des commissions
                const basePrice = parseFloat(globalCommission.base) || 0;
                const bonusThreshold = parseInt(globalCommission.threshold) || 21;
                const bonusStep = parseInt(globalCommission.step) || 10;
                const bonusAmount = parseFloat(globalCommission.amount) || 100;

                let commissions = honoredCount * basePrice;
                if (honoredCount >= bonusThreshold) {
                    const multiplier = Math.floor((honoredCount - bonusThreshold) / bonusStep) + 1;
                    commissions += (multiplier * bonusAmount);
                }

                // Pourboires (calcul√©s depuis les transactions)
                const member = teamList.value.find(m => m.name === selectedProspecteur.value);
                const currentMonthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
                const tips = (member && member.tips && member.tips[currentMonthKey]) || 0;

                const net = ca - commissions - tips;

                // Paliers
                const tiers = [];
                for (let i = bonusThreshold; i <= honoredCount + bonusStep; i += bonusStep) {
                    tiers.push({
                        level: Math.floor((i - bonusThreshold) / bonusStep) + 1,
                        count: i,
                        reached: honoredCount >= i
                    });
                }

                return { ca, honoredCount, commissions, tips, net, tiers };
            });

            // Toutes les transactions (admin)
            const allTransactions = computed(() => {
                if (!selectedProspecteur.value) return [];
                return transactions.value;
            });

            // Transactions visibles (prospecteur) - Afficher TOUTES les transactions
            const visibleTransactions = computed(() => {
                // Afficher toutes les transactions, m√™me celles cach√©es (elles auront un indicateur visuel)
                return transactions.value.filter(t => t.userId === user.name);
            });

            // Portefeuille utilisateur (prospecteur) - Calcul bas√© sur les transactions non cach√©es
            const userPortefeuille = computed(() => {
                // Calculer le total uniquement avec les transactions non cach√©es
                const total = transactions.value
                    .filter(t => t.userId === user.name && !t.hidden)
                    .reduce((acc, t) => acc + (parseFloat(t.amount) || 0), 0);
                return { total };
            });

            // Stats de chaque prospecteur (pour les cartes)
            const prospectorsWithStats = computed(() => {
                // Utiliser les filtres du dashboard ou le mois/ann√©e actuel par d√©faut
                const selectedMonth = dashboardFilters.mois ? parseInt(dashboardFilters.mois) - 1 : new Date().getMonth();
                const selectedYear = dashboardFilters.annee ? parseInt(dashboardFilters.annee) : new Date().getFullYear();
                const currentMonth = selectedMonth;
                const currentYear = selectedYear;
                
                return onlyProspectors.value.map(prosp => {
                    const honoredRdv = rdvList.value.filter(r => {
                        if (r.statut !== 'honore' || r.createdBy !== prosp.name) return false;
                        if (!r.date) return false;
                        const d = new Date(r.date);
                        return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                    });

                    const ca = honoredRdv.reduce((acc, r) => {
                        const price = getAgencePrice(r);
                        const discount = parseFloat(r.geste_commercial) || 0;
                        return acc + (price - discount);
                    }, 0);

                    const honoredCount = honoredRdv.length;

                    // Calcul des commissions
                    const basePrice = parseFloat(globalCommission.base) || 0;
                    const bonusThreshold = parseInt(globalCommission.threshold) || 21;
                    const bonusStep = parseInt(globalCommission.step) || 10;
                    const bonusAmount = parseFloat(globalCommission.amount) || 100;

                    let commissions = honoredCount * basePrice;
                    if (honoredCount >= bonusThreshold) {
                        const multiplier = Math.floor((honoredCount - bonusThreshold) / bonusStep) + 1;
                        commissions += (multiplier * bonusAmount);
                    }

                    const currentMonthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
                    const tips = (prosp.tips && prosp.tips[currentMonthKey]) || 0;

                    const net = ca - commissions - tips;

                    return {
                        name: prosp.name,
                        ca,
                        honoredCount,
                        net
                    };
                });
            });

            // Prospecteurs filtr√©s par recherche
            const displayedProspectors = computed(() => {
                if (!portefeuilleSearch.value) return prospectorsWithStats.value;
                const search = portefeuilleSearch.value.toLowerCase();
                return prospectorsWithStats.value.filter(p => p.name.toLowerCase().includes(search));
            });

            // Stats admin (solde jour brut, solde mois brut, solde mois net)
            const adminStats = computed(() => {
                const today = new Date().toISOString().split('T')[0];
                // Utiliser les filtres du dashboard ou le mois/ann√©e actuel par d√©faut
                const selectedMonth = dashboardFilters.mois ? parseInt(dashboardFilters.mois) - 1 : new Date().getMonth();
                const selectedYear = dashboardFilters.annee ? parseInt(dashboardFilters.annee) : new Date().getFullYear();
                const currentMonth = selectedMonth;
                const currentYear = selectedYear;

                // CA du jour (brut) = prix des RDV honor√©s aujourd'hui
                const caDaily = rdvList.value
                    .filter(r => r.statut === 'honore' && r.date === today)
                    .reduce((acc, r) => {
                        const price = getAgencePrice(r);
                        const discount = parseFloat(r.geste_commercial) || 0;
                        return acc + (price - discount);
                    }, 0);

                // CA du mois (brut) = prix des RDV honor√©s ce mois
                const caMonthly = rdvList.value
                    .filter(r => {
                        if (r.statut !== 'honore' || !r.date) return false;
                        const d = new Date(r.date);
                        return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                    })
                    .reduce((acc, r) => {
                        const price = getAgencePrice(r);
                        const discount = parseFloat(r.geste_commercial) || 0;
                        return acc + (price - discount);
                    }, 0);

                // Calcul des commissions du mois (ce qu'on verse aux prospecteurs)
                const basePrice = parseFloat(globalCommission.base) || 10;
                const bonusThreshold = parseInt(globalCommission.threshold) || 21;
                const bonusStep = parseInt(globalCommission.step) || 10;
                const bonusAmount = parseFloat(globalCommission.amount) || 100;
                const currentMonthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
                
                let monthlyCommissions = 0;
                const monthlyCommissionMap = {};
                
                // Compter les RDV honor√©s par prospecteur ce mois
                rdvList.value.forEach(r => {
                    if (r.statut === 'honore' && r.createdBy && r.date) {
                        const d = new Date(r.date);
                        if (d.getMonth() === currentMonth && d.getFullYear() === currentYear) {
                            const uName = r.createdBy;
                            const userObj = teamList.value.find(u => u.name === uName);
                            const isRoleAdmin = userObj && userObj.role === 'admin';
                            const isNameInAdminList = adminNamesList.value.includes(uName);
                            
                            // Exclure les admins des commissions
                            if (!isNameInAdminList && !isRoleAdmin) {
                                if (!monthlyCommissionMap[uName]) monthlyCommissionMap[uName] = 0;
                                monthlyCommissionMap[uName]++;
                            }
                        }
                    }
                });

                // Calculer les commissions totales du mois (primes + bonus + pourboires)
                for (const [userName, count] of Object.entries(monthlyCommissionMap)) {
                    let userTotal = count * basePrice;
                    if (count >= bonusThreshold) {
                        const multiplier = Math.floor((count - bonusThreshold) / bonusStep) + 1;
                        userTotal += (multiplier * bonusAmount);
                    }
                    
                    // Ajouter les pourboires du mois
                    const userObj = teamList.value.find(u => u.name === userName);
                    if (userObj && userObj.tips && userObj.tips[currentMonthKey]) {
                        userTotal += parseFloat(userObj.tips[currentMonthKey]) || 0;
                    }

                    monthlyCommissions += userTotal;
                }

                // CA net du mois = CA brut du mois - commissions du mois
                const netMonthly = caMonthly - monthlyCommissions;

                return { 
                    caDaily,      // Solde du jour (brut)
                    caMonthly,    // Solde du mois (brut)
                    netMonthly    // Solde du mois (net = brut - commissions)
                };
            });
            const displayStatus = (r) => { if(r.statut === 'honore') return user.role==='admin' ? (r.honorBilling==='facture'?'Honor√© ‚Ä¢ Factur√©':'Honor√© ‚Ä¢ Non factur√©') : 'Honor√©'; if(r.statut === 'pas_venu') return 'Pas Venu'; if(r.statut === 'annule') return 'Annul√©'; if(r.statut === 'a_confirmer') return '√Ä Confirmer'; return 'Confirm√©'; };
            const statusClass = (s) => ({ 'honore': 'bg-green-100 text-green-700', 'pas_venu': 'bg-red-100 text-red-700', 'annule': 'bg-gray-200 text-gray-500', 'a_confirmer': 'bg-orange-100 text-orange-700', 'confirme': 'bg-blue-100 text-blue-700' }[s] || 'bg-gray-100');

            // ================= FONCTIONS BILAN =================
            const MONTHS_FR = ["janvier","f√©vrier","mars","avril","mai","juin","juillet","ao√ªt","septembre","octobre","novembre","d√©cembre"];
            const pad = (n) => String(n).padStart(2,'0');
            const formatBilanPrice = (n) => { let x = Number(n||0).toFixed(2); return x.replace('.',',').replace(/\B(?=(\d{3})+(?!\d))/g," "); };
            const formatBilanDate = (s) => { if(!s) return '-'; return new Date(s).toLocaleDateString('fr-FR'); };
            const monthKey = (d) => { if(typeof d==='string') d=new Date(d); return `${d.getFullYear()}-${pad(d.getMonth()+1)}`; };
            const getNextMonthKey = (s) => { const d = new Date(s); d.setDate(1); d.setMonth(d.getMonth()+1); return monthKey(d); };
            const labelMonth = (m) => { if(!m) return ''; const [y,mo] = m.split('-'); return `${MONTHS_FR[parseInt(mo)-1]} ${y}`; };
            const isBilanTvaApplicable = (rDate) => { if(!bilanConfig.tvaActive) return false; if(!bilanConfig.tvaStart) return false; return rDate >= bilanConfig.tvaStart; };
            const getBilanLineVals = (r) => { 
                const applicable = isBilanTvaApplicable(r.date); 
                // TOUJOURS utiliser le prix de l'agence actuel (comme dans le Tableau de bord)
                let prixUnitaire = 0;
                // Chercher par agenceId d'abord
                if (r.agenceId) {
                    const agence = agences.value.find(a => a.id === r.agenceId);
                    if (agence && agence.prix) {
                        prixUnitaire = parseFloat(agence.prix) || 0;
                    }
                }
                // Si pas trouv√©, chercher par clientId (qui contient l'ID de l'agence dans le bilan)
                if (prixUnitaire === 0 && r.clientId) {
                    const agence = agences.value.find(a => a.id === r.clientId);
                    if (agence && agence.prix) {
                        prixUnitaire = parseFloat(agence.prix) || 0;
                    }
                }
                // Si pas trouv√©, chercher par nom d'agence
                if (prixUnitaire === 0 && r.agence) {
                    const agence = agences.value.find(a => a.nom === r.agence);
                    if (agence && agence.prix) {
                        prixUnitaire = parseFloat(agence.prix) || 0;
                    }
                }
                // Fallback sur r.tarif seulement si vraiment pas d'agence trouv√©e
                if (prixUnitaire === 0 && r.tarif) {
                    prixUnitaire = parseFloat(r.tarif) || 0;
                }
                // Recalculer TOUJOURS avec le prix r√©el de l'agence (ignorer r.total et r.netTotal)
                const totalHT = r.rdv * prixUnitaire;
                // Si il y a un geste commercial, le soustraire
                const ht = totalHT - (r.geste ? (r.gesteMontant || 0) : 0);
                const tva = applicable ? (ht * bilanConfig.tvaRate / 100) : 0; 
                return { ht: Math.max(0, ht), tva, ttc: Math.max(0, ht) + tva, applicable }; 
            };

            const loadBilanConfig = async () => {
                try {
                    const d = await db.collection('bilan_config').doc('settings').get();
                    if(d.exists) Object.assign(bilanConfig, d.data());
                } catch(e) { console.error('Erreur chargement config bilan:', e); }
            };

            const loadBilanData = () => {
                db.collection('bilan_rdv').onSnapshot(s => {
                    bilanRows.value = [];
                    s.forEach(d => {
                        const r = d.data();
                        r.total = Number(r.total || (r.rdv * r.tarif));
                        r.netTotal = Math.max(0, r.total - (r.geste ? (r.gesteMontant || 0) : 0));
                        bilanRows.value.push({id: d.id, ...r});
                    });
                    buildBilanMonthOptions();
                    renderBilanTable();
                    
                    // Charger les objectifs et tarifs personnalis√©s
                    loadObjectifsData();
                    loadTarifsPersonnalises();
                    
                    // V√©rifier les rappels commerciaux apr√®s chargement des donn√©es
                    if (user.logged) {
                        setTimeout(() => {
                            checkCommercialReminders();
                        }, 1000);
                    }
                });
            };

            const buildBilanMonthOptions = () => {
                const now = new Date();
                const endY = now.getFullYear();
                const startY = 2024;
                
                // G√©n√©rer les options d'ann√©es (en strings pour la compatibilit√© avec v-model)
                const years = [];
                for(let y = startY; y <= endY; y++) {
                    years.push(y.toString());
                }
                bilanYearOptions.value = years;
                dashboardYearOptions.value = years;
                
                // G√©n√©rer les options de mois (pour compatibilit√© avec l'ancien code)
                const endM = now.getMonth() + 2;
                let y = startY, m = 1;
                const options = [];
                while(y < endY || (y === endY && m <= endM)) {
                    options.push({ value: `${y}-${pad(m)}`, label: labelMonth(`${y}-${pad(m)}`) });
                    m++;
                    if(m > 12) { m = 1; y++; }
                }
                bilanMonthOptions.value = options;
                
                // Initialiser mois et ann√©e si vides pour le bilan
                if(!bilanFilters.mois) {
                    bilanFilters.mois = pad(now.getMonth() + 1);
                }
                if(!bilanFilters.annee) {
                    bilanFilters.annee = now.getFullYear().toString();
                }
                
                // Initialiser mois et ann√©e si vides pour le dashboard
                if(!dashboardFilters.mois) {
                    dashboardFilters.mois = pad(now.getMonth() + 1);
                }
                if(!dashboardFilters.annee) {
                    dashboardFilters.annee = now.getFullYear().toString();
                }
            };
            
            // Initialiser les options d'ann√©e au d√©marrage pour le dashboard et le bilan
            const initDashboardYearOptions = () => {
                const now = new Date();
                const endY = now.getFullYear();
                const startY = 2024;
                const years = [];
                for(let y = startY; y <= endY; y++) {
                    years.push(y.toString());
                }
                // Initialiser les options pour le dashboard ET le bilan
                dashboardYearOptions.value = years;
                bilanYearOptions.value = years;
                
                // Initialiser les valeurs par d√©faut pour le dashboard
                if(!dashboardFilters.mois) {
                    dashboardFilters.mois = pad(now.getMonth() + 1);
                }
                if(!dashboardFilters.annee) {
                    dashboardFilters.annee = now.getFullYear().toString();
                }
                
                // Initialiser les valeurs par d√©faut pour le bilan
                if(!bilanFilters.mois) {
                    bilanFilters.mois = pad(now.getMonth() + 1);
                }
                if(!bilanFilters.annee) {
                    bilanFilters.annee = now.getFullYear().toString();
                }
            };

            const getBilanCommerciaux = (idx) => {
                const block = bilanForm.blocks[idx];
                if(!block || !block.agenceId) return [];
                const ag = agences.value.find(a => a.id === block.agenceId);
                if(!ag) return [];
                if(ag.commerciauxDetails) return ag.commerciauxDetails.map(c => c.name);
                if(ag.commerciaux) return ag.commerciaux;
                return [];
            };
            
            const hasBilanCommerciaux = (idx) => {
                return getBilanCommerciaux(idx).length > 0;
            };

            const onBilanAgenceChange = (idx) => {
                const block = bilanForm.blocks[idx];
                const ag = agences.value.find(a => a.id === block.agenceId);
                if(ag && ag.prix) block.tarif = parseFloat(ag.prix) || 0;
                block.commercial = '';
            };

            const addBilanBlock = () => {
                bilanForm.blocks.push({ agenceId: '', commercial: '', rdv: 1, tarif: 0 });
            };

            const removeBilanBlock = (idx) => {
                bilanForm.blocks.splice(idx, 1);
            };

            const toggleBilanReport = () => {
                bilanForm.reporte = !bilanForm.reporte;
            };

            // Fonction pour obtenir le tarif personnalis√© selon le nombre de RDV d√©j√† factur√©s
            const getTarifPersonnalise = (agenceId, commercial, mois) => {
                const tarifsPerso = tarifsPersonnalises.value[agenceId];
                if(!tarifsPerso || !tarifsPerso.tarifs || tarifsPerso.tarifs.length === 0) {
                    return null; // Pas de tarif personnalis√©
                }

                // Compter le nombre de RDV d√©j√† factur√©s pour cette agence/commercial ce mois
                const rdvDejaFactures = bilanRows.value
                    .filter(r => {
                        const rMois = r.periodMonth || monthKey(r.date);
                        const rAgence = agences.value.find(a => a.nom === r.agence);
                        if(!rAgence || rAgence.id !== agenceId) return false;
                        if(rMois !== mois) return false;
                        const rComm = r.commercial || '';
                        const comm = commercial || '';
                        return rComm === comm;
                    })
                    .reduce((sum, r) => sum + (r.rdv || 0), 0);

                // Trier les tarifs par rdvMin d√©croissant pour trouver le bon palier
                const tarifsTries = [...tarifsPerso.tarifs].sort((a, b) => b.rdvMin - a.rdvMin);
                
                // Trouver le tarif applicable selon le nombre de RDV d√©j√† factur√©s
                for(const tarif of tarifsTries) {
                    if(rdvDejaFactures >= tarif.rdvMin - 1) {
                        return tarif.montant;
                    }
                }

                // Si aucun palier n'est atteint, retourner le premier tarif (le plus bas)
                return tarifsTries[tarifsTries.length - 1]?.montant || null;
            };

            const saveBilanRdv = async () => {
                if(!bilanForm.date) return alert("Date requise");
                const isReport = bilanForm.reporte;
                const targetMonth = isReport ? getNextMonthKey(bilanForm.date) : monthKey(bilanForm.date);
                const batch = db.batch();
                
                bilanForm.blocks.forEach(block => {
                    if(!block.agenceId) return;
                    const ag = agences.value.find(a => a.id === block.agenceId);
                    if(!ag) return;
                    
                    // V√©rifier si un tarif personnalis√© doit √™tre appliqu√©
                    let tarif = Number(block.tarif);
                    const tarifPerso = getTarifPersonnalise(block.agenceId, block.commercial || '', targetMonth);
                    if(tarifPerso !== null) {
                        tarif = tarifPerso;
                        // Mettre √† jour le tarif dans le formulaire pour affichage
                        block.tarif = tarif;
                    }
                    
                    const rdv = Number(block.rdv);
                    if(rdv > 0) {
                        const ref = db.collection('bilan_rdv').doc();
                        batch.set(ref, {
                            clientId: block.agenceId,
                            agence: ag.nom,
                            commercial: block.commercial || '',
                            rdv,
                            tarif,
                            total: rdv * tarif,
                            date: bilanForm.date,
                            periodDate: bilanForm.date,
                            periodMonth: targetMonth,
                            reporte: isReport,
                            geste: false,
                            tarifPersonnalise: tarifPerso !== null,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                });
                
                await batch.commit();
                bilanForm.blocks = [{ agenceId: '', commercial: '', rdv: 1, tarif: 0 }];
                bilanForm.reporte = false;
                showNotification('‚úÖ RDV factur√©s enregistr√©s', 'success', 'fa-check-circle');
            };

            const getFilteredBilanData = () => {
                const jour = bilanFilters.jour;
                const mois = bilanFilters.mois;
                const annee = bilanFilters.annee;
                // Construire la cl√© de mois √† partir de mois et ann√©e
                const m = (mois && annee) ? `${annee}-${mois}` : '';
                const ag = bilanFilters.agence;
                const co = bilanFilters.commercial;
                const search = bilanFilters.search?.toLowerCase().trim();
                
                // Si on a une recherche par nom/commercial, on ne filtre pas par mois/ann√©e pour permettre la recherche sur toutes les ann√©es
                const hasSearch = search && search.trim() !== '';
                
                let data = bilanRows.value.filter(r => {
                    if(jour) return (r.date === jour || r.periodDate === jour);
                    // Si on a une recherche active, on ignore le filtre de mois/ann√©e pour permettre la recherche sur toutes les ann√©es
                    if(hasSearch) return true; // Afficher tous les r√©sultats de recherche
                    if(!m) return true; // Si pas de filtre mois/ann√©e, tout afficher
                    const billingM = r.periodMonth || monthKey(r.date);
                    const activityM = monthKey(r.periodDate || r.date);
                    return (billingM === m) || (activityM === m && r.reporte);
                });
                if(ag) data = data.filter(r => r.agence === ag);
                if(co) data = data.filter(r => r.commercial === co);
                if(search) {
                    // Recherche dans agence ET commercial, et si on trouve un commercial, on affiche aussi son agence
                    data = data.filter(r => {
                        const agenceMatch = r.agence?.toLowerCase().includes(search);
                        const commercialMatch = r.commercial?.toLowerCase().includes(search);
                        return agenceMatch || commercialMatch;
                    });
                }
                return data.sort((a,b) => (a.periodDate || a.date).localeCompare(b.periodDate || b.date));
            };

            const bilanStats = computed(() => {
                // Calculer directement depuis rdvList comme le tableau de bord pour garantir la coh√©rence
                const mois = bilanFilters.mois;
                const annee = bilanFilters.annee;
                const ag = bilanFilters.agence;
                const co = bilanFilters.commercial;
                
                // D√©terminer le mois et l'ann√©e √† utiliser
                const selectedMonth = mois ? parseInt(mois) - 1 : new Date().getMonth();
                const selectedYear = annee ? parseInt(annee) : new Date().getFullYear();
                
                // Filtrer les RDV honor√©s factur√©s du mois s√©lectionn√©
                let filteredRdvs = rdvList.value.filter(r => {
                    if (r.honorBilling !== 'facture' || !r.date || r.statut !== 'honore') return false;
                    const d = new Date(r.date);
                    if (d.getMonth() !== selectedMonth || d.getFullYear() !== selectedYear) return false;
                    // Filtrer par agence si s√©lectionn√©e
                    if (ag) {
                        const agenceName = getAgenceName(r.agenceId);
                        if (agenceName !== ag) return false;
                    }
                    // Filtrer par commercial si s√©lectionn√©
                    if (co) {
                        const commercialName = r.createdBy || '';
                        if (commercialName !== co) return false;
                    }
                    return true;
                });
                
                // Calculer HT, TVA, TTC comme le tableau de bord
                let rdv = 0, ht = 0, tva = 0, ttc = 0;
                filteredRdvs.forEach(r => {
                    rdv++;
                    const price = getAgencePrice(r);
                    const discount = parseFloat(r.geste_commercial) || 0;
                    const htLine = price - discount;
                    const applicable = isBilanTvaApplicable(r.date);
                    const tvaLine = applicable ? (htLine * bilanConfig.tvaRate / 100) : 0;
                    const ttcLine = htLine + tvaLine;
                    
                    ht += htLine;
                    tva += tvaLine;
                    ttc += ttcLine;
                });
                
                return { rdv, ht, tva, ttc };
            });
// --- LOGIQUE FACTURATION RAPIDE ---
            const billingSummaryModal = reactive({ open: false });
            const billingSummarySearch = ref('');

            const openBillingSummary = () => {
                billingSummarySearch.value = '';
                billingSummaryModal.open = true;
            };

            const billingStatsGrouped = computed(() => {
                // On r√©cup√®re les donn√©es filtr√©es actuelles (Mois/Ann√©e s√©lectionn√©)
                const data = getFilteredBilanData();
                const grouped = {};

                data.forEach(r => {
                    const agName = r.agence || 'Agence Inconnue';
                    const commName = r.commercial || '';
                    
                    if (!grouped[agName]) {
                        grouped[agName] = { totalHT: 0, totalTVA: 0, totalTTC: 0, commerciaux: {} };
                    }

                    const vals = getBilanLineVals(r); // R√©cup√®re HT, TVA, TTC calcul√©s

                    // Ajout aux totaux agence
                    grouped[agName].totalHT += vals.ht;
                    grouped[agName].totalTVA += vals.tva;
                    grouped[agName].totalTTC += vals.ttc;

                    // D√©tail par commercial
                    if (!grouped[agName].commerciaux[commName]) {
                        grouped[agName].commerciaux[commName] = { nom: commName, rdv: 0, ht: 0, tva: 0, ttc: 0 };
                    }
                    grouped[agName].commerciaux[commName].rdv += r.rdv;
                    grouped[agName].commerciaux[commName].ht += vals.ht;
                    grouped[agName].commerciaux[commName].tva += vals.tva;
                    grouped[agName].commerciaux[commName].ttc += vals.ttc;
                });

                // Convertir l'objet commerciaux en tableau pour l'affichage
                Object.keys(grouped).forEach(key => {
                    grouped[key].commerciaux = Object.values(grouped[key].commerciaux);
                });

                return grouped;
            });

            // Filtrage des statistiques par recherche
            const filteredBillingStatsGrouped = computed(() => {
                const search = billingSummarySearch.value?.toLowerCase().trim();
                if (!search) return billingStatsGrouped.value;
                
                const filtered = {};
                Object.keys(billingStatsGrouped.value).forEach(agName => {
                    if (agName.toLowerCase().includes(search)) {
                        filtered[agName] = billingStatsGrouped.value[agName];
                    }
                });
                return filtered;
            });

            const displayedBilanRows = computed(() => {
                const data = getFilteredBilanData();
                const totalPages = Math.ceil(data.length / ITEMS_PER_PAGE_BILAN);
                if(bilanCurrentPage.value < 1) bilanCurrentPage.value = 1;
                if(bilanCurrentPage.value > totalPages && totalPages > 0) bilanCurrentPage.value = totalPages;
                const start = (bilanCurrentPage.value - 1) * ITEMS_PER_PAGE_BILAN;
                return data.slice(start, start + ITEMS_PER_PAGE_BILAN);
            });

            const bilanTotalPages = computed(() => {
                return Math.ceil(getFilteredBilanData().length / ITEMS_PER_PAGE_BILAN) || 1;
            });

            const renderBilanTable = () => {
                bilanCurrentPage.value = 1;
            };

            const goToPreviousMonth = () => {
                const currentDate = new Date();
                if (bilanFilters.mois && bilanFilters.annee) {
                    // Si on a d√©j√† un mois/ann√©e s√©lectionn√©, aller au mois pr√©c√©dent
                    const year = parseInt(bilanFilters.annee);
                    const month = parseInt(bilanFilters.mois) - 1; // -1 car on veut l'index du mois (0-11)
                    const targetDate = new Date(year, month, 1);
                    targetDate.setMonth(targetDate.getMonth() - 1); // Aller au mois pr√©c√©dent
                    bilanFilters.annee = String(targetDate.getFullYear());
                    bilanFilters.mois = String(targetDate.getMonth() + 1).padStart(2, '0');
                } else {
                    // Sinon, aller au mois pr√©c√©dent depuis le mois actuel
                    currentDate.setMonth(currentDate.getMonth() - 1);
                    bilanFilters.annee = String(currentDate.getFullYear());
                    bilanFilters.mois = String(currentDate.getMonth() + 1).padStart(2, '0');
                }
                bilanFilters.jour = '';
                renderBilanTable();
            };

            const clearBilanFilters = () => {
                bilanFilters.jour = '';
                // Remettre le mois/ann√©e au mois actuel au lieu de vider
                const currentDate = new Date();
                bilanFilters.mois = String(currentDate.getMonth() + 1).padStart(2, '0');
                bilanFilters.annee = String(currentDate.getFullYear());
                bilanFilters.agence = '';
                bilanFilters.commercial = '';
                bilanFilters.search = '';
                renderBilanTable();
            };

            const deleteSelectedBilan = async () => {
                if(!confirm('Supprimer ?')) return;
                const batch = db.batch();
                selectedBilanIds.value.forEach(id => {
                    batch.delete(db.collection('bilan_rdv').doc(id));
                });
                await batch.commit();
                selectedBilanIds.value = [];
            };

            const isAllBilanSelected = computed(() => {
                return displayedBilanRows.value.length > 0 && 
                       displayedBilanRows.value.every(r => selectedBilanIds.value.includes(r.id));
            });

            const toggleAllBilan = (event) => {
                if(event.target.checked) {
                    selectedBilanIds.value = displayedBilanRows.value.map(r => r.id);
                } else {
                    selectedBilanIds.value = [];
                }
            };

            const changeBilanPage = (delta) => {
                bilanCurrentPage.value += delta;
            };

            const openBilanEdit = (r) => {
                bilanEditModal.rdv = r;
                bilanEditModal.form = { date: r.date, agence: r.agence, commercial: r.commercial || '', rdv: r.rdv, tarif: r.tarif, reporte: r.reporte || false };
                bilanEditModal.open = true;
            };

            const saveBilanEdit = async () => {
                if(!bilanEditModal.rdv) return;
                const r = bilanEditModal.rdv;
                const f = bilanEditModal.form;
                const isReport = f.reporte;
                const tm = isReport ? getNextMonthKey(f.date) : monthKey(f.date);
                await db.collection('bilan_rdv').doc(r.id).update({
                    date: f.date,
                    periodDate: f.date,
                    periodMonth: tm,
                    commercial: f.commercial,
                    rdv: Number(f.rdv),
                    tarif: Number(f.tarif),
                    total: Number(f.rdv) * Number(f.tarif),
                    reporte: isReport
                });
                bilanEditModal.open = false;
                showNotification('‚úÖ RDV modifi√©', 'success', 'fa-check-circle');
            };

            const showBilanCommercialModal = () => {
                const mm = (bilanFilters.mois && bilanFilters.annee) ? `${bilanFilters.annee}-${bilanFilters.mois}` : monthKey(new Date());
                const year = mm.split('-')[0];
                let data;
                if(bilanPeriod.value === 'year') {
                    data = bilanRows.value.filter(r => (r.periodMonth || monthKey(r.date)).startsWith(year));
                } else {
                    data = bilanRows.value.filter(r => (r.periodMonth || monthKey(r.date)) === mm);
                }
                
                // Statistiques globales
                let totalRdv = 0;
                let totalHT = 0;
                let totalTVA = 0;
                let totalTTC = 0;
                
                // Calculs par agence
                let map = {};
                data.forEach(r => {
                    let k = r.agence;
                    if(!map[k]) map[k] = { rdvTotal: 0, details: {} };
                    let c = r.commercial || "";
                    if(!map[k].details[c]) map[k].details[c] = {rdv: 0, total: 0};
                    map[k].details[c].rdv += r.rdv;
                    const lineTotal = r.netTotal || r.total || 0;
                    map[k].details[c].total += lineTotal;
                    map[k].rdvTotal += r.rdv;
                    
                    // Totaux globaux
                    totalRdv += r.rdv;
                    const vals = getBilanLineVals(r);
                    totalHT += vals.ht;
                    totalTVA += vals.tva;
                    totalTTC += vals.ttc;
                });

                // HTML avec statistiques en haut
                let html = `<div class="mb-6 grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-blue-50 rounded-xl p-4 border border-blue-200">
                        <div class="text-xs font-bold text-blue-600 uppercase mb-1">Total RDV</div>
                        <div class="text-2xl font-black text-blue-700">${totalRdv}</div>
                    </div>
                    <div class="bg-green-50 rounded-xl p-4 border border-green-200">
                        <div class="text-xs font-bold text-green-600 uppercase mb-1">Total HT</div>
                        <div class="text-2xl font-black text-green-700">${formatBilanPrice(totalHT)}‚Ç¨</div>
                    </div>`;
                
                if(bilanConfig.tvaActive) {
                    html += `<div class="bg-orange-50 rounded-xl p-4 border border-orange-200">
                        <div class="text-xs font-bold text-orange-600 uppercase mb-1">TVA</div>
                        <div class="text-2xl font-black text-orange-700">${formatBilanPrice(totalTVA)}‚Ç¨</div>
                    </div>
                    <div class="bg-purple-50 rounded-xl p-4 border border-purple-200">
                        <div class="text-xs font-bold text-purple-600 uppercase mb-1">Total TTC</div>
                        <div class="text-2xl font-black text-purple-700">${formatBilanPrice(totalTTC)}‚Ç¨</div>
                    </div>`;
                } else {
                    html += `<div class="bg-purple-50 rounded-xl p-4 border border-purple-200 col-span-2">
                        <div class="text-xs font-bold text-purple-600 uppercase mb-1">Total</div>
                        <div class="text-2xl font-black text-purple-700">${formatBilanPrice(totalHT)}‚Ç¨</div>
                    </div>`;
                }
                
                html += `</div><div class="overflow-x-auto"><table class="w-full"><thead><tr class="bg-slate-50"><th class="px-4 py-3 text-left text-xs font-bold">Agence</th><th class="px-4 py-3 text-left text-xs font-bold">Commercial</th><th class="px-4 py-3 text-right text-xs font-bold">RDV</th><th class="px-4 py-3 text-right text-xs font-bold">Total HT</th><th class="px-4 py-3 text-right text-xs font-bold">Action</th></tr></thead><tbody>`;
                
                Object.keys(map).sort().forEach(ag => {
                    let first = true;
                    // Trier les commerciaux : d'abord ceux avec nom, puis "Autre", puis ""
                    const commKeys = Object.keys(map[ag].details).sort((a, b) => {
                        if(a === "" && b !== "") return 1;
                        if(a !== "" && b === "") return -1;
                        if(a === "Autre" && b !== "Autre" && b !== "") return 1;
                        if(a !== "Autre" && b === "Autre" && a !== "") return -1;
                        return a.localeCompare(b);
                    });
                    
                    commKeys.forEach(comm => {
                        const d = map[ag].details[comm];
                        const commDisplay = comm || "Sans commercial";
                        html += `<tr class="border-t border-slate-100">
                            <td class="px-4 py-3 ${first ? 'font-bold text-blue-600' : ''}">${first ? ag : ''}</td>
                            <td class="px-4 py-3">${commDisplay}</td>
                            <td class="px-4 py-3 text-right font-bold">${d.rdv}</td>
                            <td class="px-4 py-3 text-right">${formatBilanPrice(d.total)}‚Ç¨</td>
                            <td class="px-4 py-3 text-right"><button data-scope="commercial" data-agence="${ag}" data-commercial="${comm}" class="bilan-export-pdf bg-blue-100 text-blue-600 px-3 py-1 rounded-lg text-xs font-bold hover:bg-blue-200"><i class="fa-solid fa-file-pdf"></i></button></td>
                        </tr>`;
                        first = false;
                    });
                });
                html += `</tbody></table></div>`;
                
                const contentDiv = document.getElementById('bilanContent');
                if(contentDiv) {
                    contentDiv.innerHTML = html;
                    // Attacher les √©v√©nements apr√®s l'insertion du HTML
                    setTimeout(() => {
                        contentDiv.querySelectorAll('.bilan-export-pdf').forEach(btn => {
                            btn.addEventListener('click', () => {
                                exportBilanPdf(btn.dataset.scope, btn.dataset.agence, btn.dataset.commercial);
                            });
                        });
                    }, 100);
                }
                bilanModal.open = true;
            };

            const exportComptaExcel = () => {
                const data = getFilteredBilanData();
                if(data.length === 0) return alert("Rien √† exporter");
                const rowsExcel = data.map(r => {
                    const v = getBilanLineVals(r);
                    return {
                        "Date": r.periodDate || r.date,
                        "Agence": r.agence,
                        "Commercial": r.commercial || "",
                        "Nb RDV": r.rdv,
                        "Tarif Unit": r.tarif,
                        "Total HT": v.ht,
                        "TVA": v.tva,
                        "Total TTC": bilanConfig.tvaActive ? v.ttc : v.ht,
                        "Report√©": r.reporte ? "OUI" : "NON"
                    };
                });
                const ws = XLSX.utils.json_to_sheet(rowsExcel);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Facturation");
                const m = (bilanFilters.mois && bilanFilters.annee) ? `${bilanFilters.annee}-${bilanFilters.mois}` : monthKey(new Date());
                XLSX.writeFile(wb, `Export_Compta_${m}.xlsx`);
            };

            const exportBilanPdf = (scope, agence, commercial) => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: (scope==='commercial')?'landscape':'portrait' });
                const m = bilanFilters.mois || monthKey(new Date());
                const jour = bilanFilters.jour;
                const year = m.split('-')[0];
                
                // En-t√™te avec logo et design moderne
                let headerY = 15;
                if(bilanConfig.logo) {
                    try {
                        // Logo √† gauche
                        doc.addImage(bilanConfig.logo, 'JPEG', 14, headerY, 40, 40);
                        headerY = 20;
                    } catch(e) {
                        console.error('Erreur logo:', e);
                    }
                }
                
                // Titre principal avec design
                doc.setFillColor(30, 58, 138);
                doc.rect(0, 0, doc.internal.pageSize.getWidth(), 25, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text("BILAN DE PRESTATION", doc.internal.pageSize.getWidth() / 2, 18, { align: 'center' });
                
                // Sous-titre
                let data, labelP;
                if(jour) {
                    data = bilanRows.value.filter(r => (r.date === jour || r.periodDate === jour));
                    labelP = "JOURN√âE DU " + formatBilanDate(jour).toUpperCase();
                } else {
                    if(bilanPeriod.value === 'year') {
                        data = bilanRows.value.filter(r => (r.periodMonth || monthKey(r.date)).startsWith(year));
                        labelP = "ANN√âE " + year;
                    } else {
                        data = bilanRows.value.filter(r => (r.periodMonth || monthKey(r.date)) === m);
                        labelP = labelMonth(m).toUpperCase();
                    }
                }
                if(scope==='agency') data = data.filter(r => r.agence === agence);
                if(scope==='commercial') data = data.filter(r => r.agence === agence && (r.commercial||'Autre') === commercial);

                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                doc.text(labelP, doc.internal.pageSize.getWidth() / 2, 25, { align: 'center' });
                
                // Informations en haut
                const totalRDV = data.reduce((acc, r) => acc + r.rdv, 0);
                doc.setFillColor(245, 247, 250);
                doc.rect(14, 32, doc.internal.pageSize.getWidth() - 28, 8, 'F');
                doc.setTextColor(50, 50, 50);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text(`Nombre de RDV : ${totalRDV}`, 20, 37);
                doc.text(`Date d'√©dition : ${new Date().toLocaleDateString('fr-FR')}`, doc.internal.pageSize.getWidth() - 20, 37, { align: 'right' });

                // Tableau avec style am√©lior√©
                let cols = ['Date', 'Agence', 'Comm.', 'RDV', 'Tarif'];
                if(bilanConfig.tvaActive) { cols.push('HT', 'TVA', 'TTC'); } else { cols.push('Total TTC'); }
                cols.push('Note');
                let body = data.map(r => {
                    const v = getBilanLineVals(r);
                    let row = [formatBilanDate(r.periodDate || r.date), r.agence, r.commercial||'', r.rdv, formatBilanPrice(r.tarif)];
                    if(bilanConfig.tvaActive) {
                        if(v.applicable) row.push(formatBilanPrice(v.ht), formatBilanPrice(v.tva), formatBilanPrice(v.ttc));
                        else row.push(formatBilanPrice(v.ht), "-", formatBilanPrice(v.ht));
                    } else {
                        row.push(formatBilanPrice(v.ht));
                    }
                    let note = "";
                    if(r.reporte) note = "REPORT√â";
                    if(r.geste) note += ` (Geste ${formatBilanPrice(r.gesteMontant)}‚Ç¨)`;
                    row.push(note);
                    return row;
                });
                
                doc.autoTable({
                    head: [cols],
                    body: body,
                    startY: 45,
                    margin: { left: 14, right: 14 },
                    theme: 'striped',
                    headStyles: {
                        fillColor: [30, 58, 138],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold',
                        fontSize: 10
                    },
                    bodyStyles: {
                        fontSize: 9,
                        textColor: [50, 50, 50]
                    },
                    alternateRowStyles: {
                        fillColor: [245, 247, 250]
                    },
                    styles: {
                        cellPadding: 4,
                        lineColor: [200, 200, 200],
                        lineWidth: 0.1
                    }
                });

                // Totaux avec style
                let totalHT = data.reduce((acc,r) => acc + (r.netTotal || r.total), 0);
                let y = doc.lastAutoTable.finalY + 15;
                
                // Ligne de s√©paration
                doc.setDrawColor(200, 200, 200);
                doc.setLineWidth(0.5);
                doc.line(14, y - 5, doc.internal.pageSize.getWidth() - 14, y - 5);
                
                doc.setFontSize(11);
                doc.setTextColor(50, 50, 50);
                doc.setFont('helvetica', 'normal');
                
                if(bilanConfig.tvaActive) {
                    let totTva = data.reduce((acc,r) => acc + getBilanLineVals(r).tva, 0);
                    let totTTC = totalHT + totTva;
                    
                    // Encadr√© pour les totaux
                    doc.setFillColor(240, 245, 250);
                    doc.roundedRect(14, y, doc.internal.pageSize.getWidth() - 28, 25, 3, 3, 'F');
                    
                    doc.text(`Total HT : ${formatBilanPrice(totalHT)} ‚Ç¨`, 20, y + 8);
                    doc.text(`TVA (${bilanConfig.tvaRate}%) : ${formatBilanPrice(totTva)} ‚Ç¨`, 20, y + 15);
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(13);
                    doc.setTextColor(30, 58, 138);
                    doc.text(`TOTAL TTC : ${formatBilanPrice(totTTC)} ‚Ç¨`, doc.internal.pageSize.getWidth() - 20, y + 12, { align: 'right' });
                } else {
                    // Encadr√© pour le total
                    doc.setFillColor(240, 245, 250);
                    doc.roundedRect(14, y, doc.internal.pageSize.getWidth() - 28, 15, 3, 3, 'F');
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(13);
                    doc.setTextColor(30, 58, 138);
                    doc.text(`TOTAL TTC : ${formatBilanPrice(totalHT)} ‚Ç¨`, doc.internal.pageSize.getWidth() - 20, y + 10, { align: 'right' });
                }

                // Signature en bas
                if(bilanConfig.signature) {
                    try {
                        let sigY = y + 30;
                        if(sigY > 250) { doc.addPage(); sigY = 20; }
                        doc.setFontSize(8);
                        doc.setFont('helvetica', 'normal');
                        doc.setTextColor(100, 100, 100);
                        doc.text("Cachet / Signature :", 14, sigY);
                        doc.addImage(bilanConfig.signature, 'PNG', 14, sigY + 2, 50, 25);
                    } catch(e) {
                        console.error('Erreur signature:', e);
                    }
                }
                
                // Pied de page
                const pageCount = doc.internal.getNumberOfPages();
                for(let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(150, 150, 150);
                    doc.text(`Page ${i} / ${pageCount}`, doc.internal.pageSize.getWidth() / 2, doc.internal.pageSize.getHeight() - 10, { align: 'center' });
                }
                
                doc.save(`Bilan_${scope}_${labelP.replace(/\s+/g, '_')}.pdf`);
            };

            const exportMonthPdfAll = () => {
                const prev = bilanPeriod.value;
                bilanPeriod.value = 'month';
                exportBilanPdf('global');
                bilanPeriod.value = prev;
            };

            // Export PDF complet pour une agence
            const exportBilanAgencePDF = (agenceNom, agData) => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'portrait' });
                const m = (bilanFilters.mois && bilanFilters.annee) ? `${bilanFilters.annee}-${bilanFilters.mois}` : monthKey(new Date());
                const labelP = labelMonth(m).toUpperCase();
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 15;
                let currentY = 15;

                // Logo √† gauche si pr√©sent
                if(bilanConfig.logo) {
                    try {
                        doc.addImage(bilanConfig.logo, 'JPEG', margin, currentY, 30, 30);
                    } catch(e) {
                        console.error('Erreur logo:', e);
                    }
                }

                // Titre principal - Bandeau avec couleurs du site
                doc.setFillColor(102, 126, 234);
                doc.rect(0, 0, pageWidth, 35, 'F');
                doc.setFillColor(118, 75, 162);
                doc.rect(0, 0, pageWidth, 5, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text("BILAN DE FACTURATION", pageWidth / 2, 18, { align: 'center' });
                
                doc.setFontSize(10);
                doc.text(agenceNom.toUpperCase(), pageWidth / 2, 28, { align: 'center' });

                currentY = 40;

                // Informations de p√©riode
                doc.setFillColor(239, 246, 255);
                doc.rect(margin, currentY, pageWidth - (margin * 2), 7, 'F');
                doc.setDrawColor(102, 126, 234);
                doc.setLineWidth(0.3);
                doc.rect(margin, currentY, pageWidth - (margin * 2), 7, 'S');
                
                doc.setTextColor(30, 41, 59);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.text(`P√©riode : ${labelP}`, margin + 3, currentY + 4.5);
                doc.text(`Date d'√©dition : ${new Date().toLocaleDateString('fr-FR')}`, pageWidth - margin - 3, currentY + 4.5, { align: 'right' });

                currentY += 12;

                // R√©cup√©rer les donn√©es d√©taill√©es
                const data = getFilteredBilanData().filter(r => r.agence === agenceNom);
                
                // Statistiques globales
                let totalRdv = 0, totalHT = 0, totalTVA = 0, totalTTC = 0;
                data.forEach(r => {
                    totalRdv += r.rdv;
                    const v = getBilanLineVals(r);
                    totalHT += v.ht;
                    totalTVA += v.tva;
                    totalTTC += v.ttc;
                });

                // R√âSUM√â - Structure en tableau pour alignement parfait
                const resumeY = currentY;
                const resumeWidth = pageWidth - (margin * 2);
                const resumeHeight = 12;
                
                doc.setFillColor(239, 246, 255);
                doc.roundedRect(margin, resumeY, resumeWidth, resumeHeight, 2, 2, 'F');
                doc.setDrawColor(102, 126, 234);
                doc.setLineWidth(0.4);
                doc.roundedRect(margin, resumeY, resumeWidth, resumeHeight, 2, 2, 'S');
                
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(102, 126, 234);
                doc.text("R√âSUM√â", margin + 3, resumeY + 5);
                
                doc.setDrawColor(102, 126, 234);
                doc.setLineWidth(0.3);
                doc.line(margin + 3, resumeY + 6.5, margin + 40, resumeY + 6.5);
                
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(30, 41, 59);
                
                // Colonne gauche
                doc.text(`Nombre total de RDV : ${totalRdv}`, margin + 3, resumeY + 9.5);
                doc.text(`Total HT : ${formatBilanPrice(totalHT)} ‚Ç¨`, margin + 3, resumeY + 13);
                
                // Colonne droite - ALIGN√âE VERTICALEMENT
                if(bilanConfig.tvaActive) {
                    doc.text(`TVA (${bilanConfig.tvaRate}%) : ${formatBilanPrice(totalTVA)} ‚Ç¨`, margin + resumeWidth / 2 + 3, resumeY + 9.5);
                    doc.text(`Total TTC : ${formatBilanPrice(totalTTC)} ‚Ç¨`, margin + resumeWidth / 2 + 3, resumeY + 13);
                } else {
                    doc.text(`Total TTC : ${formatBilanPrice(totalHT)} ‚Ç¨`, margin + resumeWidth / 2 + 3, resumeY + 9.5);
                }

                currentY = resumeY + resumeHeight + 8;

                // Tableau d√©taill√© par commercial
                let cols = ['Date', 'Commercial', 'Nb RDV', 'Tarif unit.'];
                if(bilanConfig.tvaActive) {
                    cols.push('HT', 'TVA', 'TTC');
                } else {
                    cols.push('Total');
                }
                
                let body = [];
                const groupedByComm = {};
                data.forEach(r => {
                    const comm = r.commercial || 'Agence (Direct)';
                    if(!groupedByComm[comm]) {
                        groupedByComm[comm] = { rdv: 0, ht: 0, tva: 0, ttc: 0, lignes: [] };
                    }
                    groupedByComm[comm].rdv += r.rdv;
                    const v = getBilanLineVals(r);
                    groupedByComm[comm].ht += v.ht;
                    groupedByComm[comm].tva += v.tva;
                    groupedByComm[comm].ttc += v.ttc;
                    groupedByComm[comm].lignes.push(r);
                });

                Object.keys(groupedByComm).sort().forEach(comm => {
                    const d = groupedByComm[comm];
                    d.lignes.forEach(r => {
                        const v = getBilanLineVals(r);
                        let row = [
                            formatBilanDate(r.periodDate || r.date),
                            comm.length > 18 ? comm.substring(0, 16) + '..' : comm,
                            String(r.rdv),
                            formatBilanPrice(r.tarif) + ' ‚Ç¨'
                        ];
                        if(bilanConfig.tvaActive) {
                            row.push(formatBilanPrice(v.ht) + ' ‚Ç¨', formatBilanPrice(v.tva) + ' ‚Ç¨', formatBilanPrice(v.ttc) + ' ‚Ç¨');
                        } else {
                            row.push(formatBilanPrice(v.ht) + ' ‚Ç¨');
                        }
                        body.push(row);
                    });
                });

                doc.autoTable({
                    head: [cols],
                    body: body,
                    startY: currentY,
                    margin: { left: margin, right: margin },
                    theme: 'striped',
                    headStyles: {
                        fillColor: [102, 126, 234],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold',
                        fontSize: 8,
                        halign: 'center',
                        cellPadding: 2.5
                    },
                    bodyStyles: {
                        fontSize: 7.5,
                        textColor: [30, 41, 59],
                        cellPadding: 1.5,
                        halign: 'left'
                    },
                    alternateRowStyles: {
                        fillColor: [248, 250, 252]
                    },
                    columnStyles: {
                        0: { cellWidth: 22, halign: 'left' },
                        1: { cellWidth: 30, halign: 'left' },
                        2: { cellWidth: 12, halign: 'center' },
                        3: { cellWidth: 18, halign: 'right' },
                        4: { cellWidth: 18, halign: 'right' },
                        5: { cellWidth: 18, halign: 'right' },
                        6: { cellWidth: 18, halign: 'right' }
                    },
                    styles: {
                        lineColor: [203, 213, 225],
                        lineWidth: 0.15,
                        cellPadding: 1.5,
                        fontSize: 7.5
                    },
                    didParseCell: function(data) {
                        if(data.cell.text && typeof data.cell.text === 'string' && data.column.index === 1 && data.cell.text.length > 18) {
                            data.cell.text = data.cell.text.substring(0, 16) + '..';
                        }
                    }
                });

                // Totaux en bas
                let y = doc.lastAutoTable.finalY + 10;
                
                // Ligne de s√©paration
                doc.setDrawColor(102, 126, 234);
                doc.setLineWidth(0.5);
                doc.line(margin, y, pageWidth - margin, y);
                
                y += 8;
                
                // Encadr√© totaux
                const totalBoxWidth = 75;
                const totalBoxHeight = bilanConfig.tvaActive ? 18 : 10;
                const totalBoxX = pageWidth - margin - totalBoxWidth;
                
                doc.setFillColor(239, 246, 255);
                doc.roundedRect(totalBoxX, y - 4, totalBoxWidth, totalBoxHeight, 2, 2, 'F');
                doc.setDrawColor(102, 126, 234);
                doc.setLineWidth(0.3);
                doc.roundedRect(totalBoxX, y - 4, totalBoxWidth, totalBoxHeight, 2, 2, 'S');
                
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(30, 41, 59);
                
                if(bilanConfig.tvaActive) {
                    doc.text(`TOTAL HT`, totalBoxX + 3, y);
                    doc.text(`${formatBilanPrice(totalHT)} ‚Ç¨`, totalBoxX + totalBoxWidth - 3, y, { align: 'right' });
                    doc.text(`TVA (${bilanConfig.tvaRate}%)`, totalBoxX + 3, y + 5.5);
                    doc.text(`${formatBilanPrice(totalTVA)} ‚Ç¨`, totalBoxX + totalBoxWidth - 3, y + 5.5, { align: 'right' });
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(102, 126, 234);
                    doc.text(`TOTAL TTC`, totalBoxX + 3, y + 12);
                    doc.text(`${formatBilanPrice(totalTTC)} ‚Ç¨`, totalBoxX + totalBoxWidth - 3, y + 12, { align: 'right' });
                } else {
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(102, 126, 234);
                    doc.text(`TOTAL TTC`, totalBoxX + 3, y);
                    doc.text(`${formatBilanPrice(totalHT)} ‚Ç¨`, totalBoxX + totalBoxWidth - 3, y, { align: 'right' });
                }

                // Signature
                if(bilanConfig.signature) {
                    try {
                        let sigY = y + totalBoxHeight + 8;
                        if(sigY > pageHeight - 30) { 
                            doc.addPage(); 
                            sigY = 20; 
                        }
                        doc.setFontSize(7.5);
                        doc.setFont('helvetica', 'normal');
                        doc.setTextColor(100, 100, 100);
                        doc.text("Cachet / Signature :", margin, sigY);
                        doc.addImage(bilanConfig.signature, 'PNG', margin, sigY + 2, 50, 25);
                    } catch(e) {
                        console.error('Erreur signature:', e);
                    }
                }

                const fileName = `Bilan_${agenceNom.replace(/\s+/g, '_')}_${labelP.replace(/\s+/g, '_')}.pdf`;
                doc.save(fileName);
            };

            // Export PDF complet pour un commercial
            const exportBilanCommercialPDF = (agenceNom, commercialNom, commData) => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'portrait' });
                const m = (bilanFilters.mois && bilanFilters.annee) ? `${bilanFilters.annee}-${bilanFilters.mois}` : monthKey(new Date());
                const labelP = labelMonth(m).toUpperCase();
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 15;
                let currentY = 15;

                // Logo √† gauche si pr√©sent
                if(bilanConfig.logo) {
                    try {
                        doc.addImage(bilanConfig.logo, 'JPEG', margin, currentY, 30, 30);
                    } catch(e) {
                        console.error('Erreur logo:', e);
                    }
                }

                // Titre principal - Bandeau avec couleurs du site
                doc.setFillColor(102, 126, 234);
                doc.rect(0, 0, pageWidth, 35, 'F');
                doc.setFillColor(118, 75, 162);
                doc.rect(0, 0, pageWidth, 5, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text("BILAN DE FACTURATION", pageWidth / 2, 18, { align: 'center' });
                
                doc.setFontSize(10);
                doc.text(`${agenceNom.toUpperCase()} - ${commercialNom.toUpperCase()}`, pageWidth / 2, 28, { align: 'center' });

                currentY = 40;

                // Informations de p√©riode
                doc.setFillColor(239, 246, 255);
                doc.rect(margin, currentY, pageWidth - (margin * 2), 7, 'F');
                doc.setDrawColor(102, 126, 234);
                doc.setLineWidth(0.3);
                doc.rect(margin, currentY, pageWidth - (margin * 2), 7, 'S');
                
                doc.setTextColor(30, 41, 59);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.text(`P√©riode : ${labelP}`, margin + 3, currentY + 4.5);
                doc.text(`Date d'√©dition : ${new Date().toLocaleDateString('fr-FR')}`, pageWidth - margin - 3, currentY + 4.5, { align: 'right' });

                currentY += 12;

                // R√©cup√©rer les donn√©es
                const data = getFilteredBilanData().filter(r => 
                    r.agence === agenceNom && (r.commercial || 'Agence (Direct)') === commercialNom
                );

                // Statistiques
                let totalRdv = commData.rdv || 0;
                let totalHT = commData.ht || 0;
                let totalTVA = commData.tva || 0;
                let totalTTC = commData.ttc || commData.ht || 0;

                // R√âSUM√â - Structure en tableau pour alignement parfait
                const resumeY = currentY;
                const resumeWidth = pageWidth - (margin * 2);
                const resumeHeight = 12;
                
                doc.setFillColor(239, 246, 255);
                doc.roundedRect(margin, resumeY, resumeWidth, resumeHeight, 2, 2, 'F');
                doc.setDrawColor(102, 126, 234);
                doc.setLineWidth(0.4);
                doc.roundedRect(margin, resumeY, resumeWidth, resumeHeight, 2, 2, 'S');
                
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(102, 126, 234);
                doc.text("R√âSUM√â", margin + 3, resumeY + 5);
                
                doc.setDrawColor(102, 126, 234);
                doc.setLineWidth(0.3);
                doc.line(margin + 3, resumeY + 6.5, margin + 40, resumeY + 6.5);
                
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(30, 41, 59);
                
                // Colonne gauche
                doc.text(`Nombre total de RDV : ${totalRdv}`, margin + 3, resumeY + 9.5);
                doc.text(`Total HT : ${formatBilanPrice(totalHT)} ‚Ç¨`, margin + 3, resumeY + 13);
                
                // Colonne droite - ALIGN√âE VERTICALEMENT
                if(bilanConfig.tvaActive) {
                    doc.text(`TVA (${bilanConfig.tvaRate}%) : ${formatBilanPrice(totalTVA)} ‚Ç¨`, margin + resumeWidth / 2 + 3, resumeY + 9.5);
                    doc.text(`Total TTC : ${formatBilanPrice(totalTTC)} ‚Ç¨`, margin + resumeWidth / 2 + 3, resumeY + 13);
                } else {
                    doc.text(`Total TTC : ${formatBilanPrice(totalHT)} ‚Ç¨`, margin + resumeWidth / 2 + 3, resumeY + 9.5);
                }

                currentY = resumeY + resumeHeight + 8;

                // Tableau d√©taill√©
                let cols = ['Date', 'Nb RDV', 'Tarif unit.'];
                if(bilanConfig.tvaActive) {
                    cols.push('HT', 'TVA', 'TTC');
                } else {
                    cols.push('Total');
                }
                
                let body = data.map(r => {
                    const v = getBilanLineVals(r);
                    let row = [
                        formatBilanDate(r.periodDate || r.date),
                        String(r.rdv),
                        formatBilanPrice(r.tarif) + ' ‚Ç¨'
                    ];
                    if(bilanConfig.tvaActive) {
                        row.push(formatBilanPrice(v.ht) + ' ‚Ç¨', formatBilanPrice(v.tva) + ' ‚Ç¨', formatBilanPrice(v.ttc) + ' ‚Ç¨');
                    } else {
                        row.push(formatBilanPrice(v.ht) + ' ‚Ç¨');
                    }
                    return row;
                });

                doc.autoTable({
                    head: [cols],
                    body: body,
                    startY: currentY,
                    margin: { left: margin, right: margin },
                    theme: 'striped',
                    headStyles: {
                        fillColor: [102, 126, 234],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold',
                        fontSize: 8,
                        halign: 'center',
                        cellPadding: 2.5
                    },
                    bodyStyles: {
                        fontSize: 7.5,
                        textColor: [30, 41, 59],
                        cellPadding: 1.5,
                        halign: 'left'
                    },
                    alternateRowStyles: {
                        fillColor: [248, 250, 252]
                    },
                    columnStyles: {
                        0: { cellWidth: 35, halign: 'left' },
                        1: { cellWidth: 20, halign: 'center' },
                        2: { cellWidth: 30, halign: 'right' },
                        3: { cellWidth: 30, halign: 'right' },
                        4: { cellWidth: 30, halign: 'right' },
                        5: { cellWidth: 30, halign: 'right' }
                    },
                    styles: {
                        lineColor: [203, 213, 225],
                        lineWidth: 0.15,
                        cellPadding: 1.5,
                        fontSize: 7.5
                    }
                });

                // Totaux en bas
                let y = doc.lastAutoTable.finalY + 10;
                
                // Ligne de s√©paration
                doc.setDrawColor(102, 126, 234);
                doc.setLineWidth(0.5);
                doc.line(margin, y, pageWidth - margin, y);
                
                y += 8;
                
                // Encadr√© totaux
                const totalBoxWidth = 75;
                const totalBoxHeight = bilanConfig.tvaActive ? 18 : 10;
                const totalBoxX = pageWidth - margin - totalBoxWidth;
                
                doc.setFillColor(239, 246, 255);
                doc.roundedRect(totalBoxX, y - 4, totalBoxWidth, totalBoxHeight, 2, 2, 'F');
                doc.setDrawColor(102, 126, 234);
                doc.setLineWidth(0.3);
                doc.roundedRect(totalBoxX, y - 4, totalBoxWidth, totalBoxHeight, 2, 2, 'S');
                
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(30, 41, 59);
                
                if(bilanConfig.tvaActive) {
                    doc.text(`TOTAL HT`, totalBoxX + 3, y);
                    doc.text(`${formatBilanPrice(totalHT)} ‚Ç¨`, totalBoxX + totalBoxWidth - 3, y, { align: 'right' });
                    doc.text(`TVA (${bilanConfig.tvaRate}%)`, totalBoxX + 3, y + 5.5);
                    doc.text(`${formatBilanPrice(totalTVA)} ‚Ç¨`, totalBoxX + totalBoxWidth - 3, y + 5.5, { align: 'right' });
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(102, 126, 234);
                    doc.text(`TOTAL TTC`, totalBoxX + 3, y + 12);
                    doc.text(`${formatBilanPrice(totalTTC)} ‚Ç¨`, totalBoxX + totalBoxWidth - 3, y + 12, { align: 'right' });
                } else {
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(102, 126, 234);
                    doc.text(`TOTAL TTC`, totalBoxX + 3, y);
                    doc.text(`${formatBilanPrice(totalHT)} ‚Ç¨`, totalBoxX + totalBoxWidth - 3, y, { align: 'right' });
                }

                // Signature
                if(bilanConfig.signature) {
                    try {
                        let sigY = y + totalBoxHeight + 8;
                        if(sigY > pageHeight - 30) { 
                            doc.addPage(); 
                            sigY = 20; 
                        }
                        doc.setFontSize(7.5);
                        doc.setFont('helvetica', 'normal');
                        doc.setTextColor(100, 100, 100);
                        doc.text("Cachet / Signature :", margin, sigY);
                        doc.addImage(bilanConfig.signature, 'PNG', margin, sigY + 2, 50, 25);
                    } catch(e) {
                        console.error('Erreur signature:', e);
                    }
                }

                const fileName = `Bilan_${agenceNom.replace(/\s+/g, '_')}_${commercialNom.replace(/\s+/g, '_')}_${labelP.replace(/\s+/g, '_')}.pdf`;
                doc.save(fileName);
            };

            const openBilanSettings = () => {
                bilanSettingsModal.open = true;
            };

            const setBilanPeriod = (p) => {
                bilanPeriod.value = p;
            };

            const handleBilanLogo = (e) => {
                if(e.target.files[0]) {
                    const r = new FileReader();
                    r.onload = (ev) => {
                        bilanConfig.logo = ev.target.result;
                    };
                    r.readAsDataURL(e.target.files[0]);
                }
            };

            const handleBilanSignature = (e) => {
                if(e.target.files[0]) {
                    const r = new FileReader();
                    r.onload = (ev) => {
                        bilanConfig.signature = ev.target.result;
                    };
                    r.readAsDataURL(e.target.files[0]);
                }
            };

            const saveBilanSettings = async () => {
                await db.collection('bilan_config').doc('settings').set(bilanConfig, {merge: true});
                bilanSettingsModal.open = false;
                showNotification('‚úÖ R√©glages sauvegard√©s', 'success', 'fa-check-circle');
            };

            // RDV urgents (sans commercial assign√©)
            const urgentBilanRows = computed(() => {
                return bilanRows.value.filter(r => 
                    r.commercial === '√Ä traiter' || 
                    r.commercial === 'Je ne sais pas' ||
                    r.needsCommercial === true
                );
            });

            const urgentBilanCount = computed(() => {
                return urgentBilanRows.value.length;
            });

            // RDV urgents pour les prospecteurs (cr√©√©s par eux)
            const prospecteurUrgentRows = computed(() => {
                if (user.role === 'admin') return [];
                return bilanRows.value.filter(r => {
                    const hasUrgentFlag = r.commercial === '√Ä traiter' || 
                                         r.commercial === 'Je ne sais pas' ||
                                         r.needsCommercial === true;
                    if (!hasUrgentFlag) return false;
                    
                    // V√©rifier si le RDV a √©t√© cr√©√© par le prospecteur actuel
                    const rdvId = r.rdvId || (r.rdvIds && r.rdvIds.length > 0 ? r.rdvIds[0] : null);
                    if (!rdvId) return false;
                    const rdv = rdvList.value.find(rdv => rdv.id === rdvId);
                    return rdv && rdv.createdBy === user.name;
                });
            });

            const prospecteurUrgentCount = computed(() => {
                return prospecteurUrgentRows.value.length;
            });

            // Watch pour d√©tecter imm√©diatement quand il y a des RDV √† traiter
            let lastUrgentCount = 0;
            watch([() => urgentBilanCount.value, () => prospecteurUrgentCount.value], ([adminCount, prospecteurCount]) => {
                if (!user.logged) return;
                
                const currentCount = user.role === 'admin' ? adminCount : prospecteurCount;
                
                // Si le nombre augmente (nouveau RDV √† traiter), afficher imm√©diatement
                if (currentCount > 0 && currentCount > lastUrgentCount) {
                    checkCommercialReminders(true);
                }
                
                lastUrgentCount = currentCount;
            });

            // R√©cup√©rer les infos du client depuis le RDV original
            const getUrgentRdvClient = (bilanRdv) => {
                // Essayer d'abord rdvId, puis rdvIds (pour les RDV regroup√©s)
                const rdvId = bilanRdv.rdvId || (bilanRdv.rdvIds && bilanRdv.rdvIds.length > 0 ? bilanRdv.rdvIds[0] : null);
                if(!rdvId) return '-';
                const rdv = rdvList.value.find(r => r.id === rdvId);
                if(rdv) return `${rdv.civilite || ''} ${rdv.nom || ''}`.trim() || '-';
                return '-';
            };

            const getUrgentRdvPhone = (bilanRdv) => {
                // Essayer d'abord rdvId, puis rdvIds (pour les RDV regroup√©s)
                const rdvId = bilanRdv.rdvId || (bilanRdv.rdvIds && bilanRdv.rdvIds.length > 0 ? bilanRdv.rdvIds[0] : null);
                if(!rdvId) return '-';
                const rdv = rdvList.value.find(r => r.id === rdvId);
                if(rdv) return rdv.telephone || '-';
                return '-';
            };

            const openUrgentCommercialModal = (bilanRdv) => {
                urgentCommercialModal.rdv = bilanRdv;
                urgentCommercialModal.commercial = '';
                urgentCommercialModal.open = true;
            };

            const getUrgentCommerciaux = () => {
                if(!urgentCommercialModal.rdv) return [];
                const ag = agences.value.find(a => a.nom === urgentCommercialModal.rdv.agence);
                if(!ag) return [];
                if(ag.commerciauxDetails) return ag.commerciauxDetails.map(c => c.name);
                if(ag.commerciaux) return ag.commerciaux;
                return [];
            };

            const saveUrgentCommercial = async () => {
                if(!urgentCommercialModal.rdv || !urgentCommercialModal.commercial) {
                    showNotification('‚ö†Ô∏è Veuillez s√©lectionner un commercial', 'warning', 'fa-exclamation-triangle');
                    return;
                }

                const bilanRdv = urgentCommercialModal.rdv;
                await db.collection('bilan_rdv').doc(bilanRdv.id).update({
                    commercial: urgentCommercialModal.commercial,
                    needsCommercial: false
                });

                showNotification('‚úÖ Commercial assign√© avec succ√®s', 'success', 'fa-check-circle');
                urgentCommercialModal.open = false;
            };

            // ================= FONCTIONS OBJECTIFS =================
            const loadObjectifsData = async () => {
                try {
                    const snap = await db.collection('objectifs').get();
                    objectifsData.value = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    updateObjectifsStats();
                } catch(e) {
                    console.error('Erreur chargement objectifs:', e);
                }
            };

            const loadTarifsPersonnalises = async () => {
                try {
                    const snap = await db.collection('tarifs_personnalises').get();
                    const tarifs = {};
                    snap.docs.forEach(d => {
                        tarifs[d.id] = d.data();
                    });
                    tarifsPersonnalises.value = tarifs;
                } catch(e) {
                    console.error('Erreur chargement tarifs personnalis√©s:', e);
                }
            };

            const updateObjectifsStats = () => {
                // Initialiser le mois si vide
                if(!objectifsFilters.mois) {
                    objectifsFilters.mois = monthKey(new Date());
                }
                const mois = objectifsFilters.mois;
                const agenceId = objectifsFilters.agence;
                
                // Filtrer les donn√©es du bilan selon les filtres
                let data = bilanRows.value.filter(r => {
                    const billingM = r.periodMonth || monthKey(r.date);
                    return billingM === mois;
                });
                
                if(agenceId) {
                    const ag = agences.value.find(a => a.id === agenceId);
                    if(ag) {
                        data = data.filter(r => r.agence === ag.nom);
                    }
                }

                // Grouper par agence
                const statsByAgence = {};
                
                data.forEach(r => {
                    const agName = r.agence || 'Agence Inconnue';
                    const ag = agences.value.find(a => a.nom === agName);
                    const agId = ag ? ag.id : null;
                    
                    if(!statsByAgence[agName]) {
                        statsByAgence[agName] = {
                            agenceId: agId,
                            agenceNom: agName,
                            totalRdv: 0,
                            objectifAgence: null,
                            commerciaux: {}
                        };
                    }
                    
                    statsByAgence[agName].totalRdv += r.rdv;
                    
                    // Normaliser le nom du commercial : toutes les valeurs vides/null/undefined deviennent une cl√© unique
                    let commName = r.commercial;
                    if(!commName || commName === '' || commName === null || commName === undefined) {
                        commName = ''; // Cl√© unique pour "Agence (Direct)"
                    }
                    
                    // V√©rifier si l'agence a des commerciaux
                    const hasCommerciaux = ag && ((ag.commerciaux && ag.commerciaux.length > 0) || (ag.commerciauxDetails && ag.commerciauxDetails.length > 0));
                    
                    // Si l'agence n'a pas de commerciaux, toutes les lignes sans commercial sont "Agence (Direct)"
                    // Si l'agence a des commerciaux mais que le commercial est vide ou "√Ä traiter", c'est aussi "Agence (Direct)"
                    if(!hasCommerciaux || commName === '' || commName === '√Ä traiter') {
                        commName = ''; // Normaliser √† une cl√© unique
                    }
                    
                    if(!statsByAgence[agName].commerciaux[commName]) {
                        statsByAgence[agName].commerciaux[commName] = {
                            nom: commName || 'Agence (Direct)',
                            rdv: 0,
                            objectif: null
                        };
                    }
                    statsByAgence[agName].commerciaux[commName].rdv += r.rdv;
                });

                // Charger les objectifs
                objectifsData.value.forEach(obj => {
                    const ag = agences.value.find(a => a.id === obj.agenceId);
                    if(!ag) return;
                    
                    const agName = ag.nom;
                    if(!statsByAgence[agName]) {
                        // Si l'agence n'a pas encore d'entr√©e, on en cr√©e une vide (mais normalement elle devrait d√©j√† exister)
                        statsByAgence[agName] = {
                            agenceId: obj.agenceId,
                            agenceNom: agName,
                            totalRdv: 0,
                            objectifAgence: null,
                            commerciaux: {}
                        };
                    }
                    
                    // V√©rifier si l'objectif correspond √† la p√©riode
                    const objMois = obj.periode === 'month' ? mois : mois.split('-')[0];
                    const currentMois = obj.periode === 'month' ? mois : mois.split('-')[0];
                    
                    if(objMois === currentMois || obj.periode === 'year') {
                        if(obj.commercial && obj.commercial.trim() !== '') {
                            // Objectif pour un commercial sp√©cifique
                            const commKey = obj.commercial;
                            if(!statsByAgence[agName].commerciaux[commKey]) {
                                statsByAgence[agName].commerciaux[commKey] = {
                                    nom: obj.commercial,
                                    rdv: 0,
                                    objectif: null
                                };
                            }
                            statsByAgence[agName].commerciaux[commKey].objectif = obj.objectif;
                        } else {
                            // Objectif pour toute l'agence (Agence Direct)
                            statsByAgence[agName].objectifAgence = obj.objectif;
                            
                            // IMPORTANT : On met l'objectif sur la ligne "Agence (Direct)" existante qui a d√©j√† les RDV
                            // On ne cr√©e PAS une nouvelle ligne si une ligne avec des RDV existe d√©j√†
                            if(!statsByAgence[agName].commerciaux['']) {
                                // Si aucune ligne "Agence (Direct)" n'existe, on en cr√©e une
                                statsByAgence[agName].commerciaux[''] = {
                                    nom: 'Agence (Direct)',
                                    rdv: 0,
                                    objectif: obj.objectif
                                };
                            } else {
                                // Si la ligne existe d√©j√†, on ajoute juste l'objectif (les RDV sont d√©j√† l√†)
                                statsByAgence[agName].commerciaux[''].objectif = obj.objectif;
                            }
                        }
                    }
                });

                // Convertir en tableau et filtrer les commerciaux vides (sans RDV et sans objectif)
                objectifsStats.value = Object.values(statsByAgence).map(ag => {
                    // Filtrer les commerciaux : garder seulement ceux qui ont des RDV OU un objectif d√©fini
                    // IMPORTANT : S'assurer qu'il n'y a qu'une seule ligne "Agence (Direct)" par agence
                    const commerciauxMap = {};
                    Object.values(ag.commerciaux).forEach(comm => {
                        // Normaliser le nom pour √©viter les doublons
                        const nomNormalise = comm.nom || 'Agence (Direct)';
                        if(nomNormalise === 'Agence (Direct)' || nomNormalise === '') {
                            // Si c'est "Agence (Direct)", on regroupe tout sous une seule cl√©
                            if(!commerciauxMap['_direct']) {
                                commerciauxMap['_direct'] = {
                                    nom: 'Agence (Direct)',
                                    rdv: 0,
                                    objectif: null
                                };
                            }
                            commerciauxMap['_direct'].rdv += comm.rdv;
                            // Si un objectif existe, on le prend (priorit√© au plus r√©cent)
                            if(comm.objectif !== null) {
                                commerciauxMap['_direct'].objectif = comm.objectif;
                            }
                        } else {
                            // Pour les commerciaux nomm√©s, on garde tel quel
                            commerciauxMap[comm.nom] = comm;
                        }
                    });
                    
                    const commerciauxFiltres = Object.values(commerciauxMap).filter(comm => {
                        return comm.rdv > 0 || comm.objectif !== null;
                    });
                    
                    return {
                        ...ag,
                        commerciaux: commerciauxFiltres
                    };
                }).filter(ag => !agenceId || ag.agenceId === agenceId);
            };

            const openObjectifModal = (agenceId, commercial) => {
                objectifModal.agenceId = agenceId || '';
                objectifModal.commercial = commercial || '';
                objectifModal.objectif = 0;
                objectifModal.periode = 'month';
                
                // Charger l'objectif existant si pr√©sent
                if(agenceId) {
                    const existing = objectifsData.value.find(obj => 
                        obj.agenceId === agenceId && 
                        (commercial ? obj.commercial === commercial : !obj.commercial)
                    );
                    if(existing) {
                        objectifModal.objectif = existing.objectif;
                        objectifModal.periode = existing.periode || 'month';
                    }
                }
                
                objectifModal.open = true;
            };

            const hasObjectifCommerciaux = () => {
                if(!objectifModal.agenceId) return false;
                const ag = agences.value.find(a => a.id === objectifModal.agenceId);
                if(!ag) return false;
                return (ag.commerciaux && ag.commerciaux.length > 0) || (ag.commerciauxDetails && ag.commerciauxDetails.length > 0);
            };

            const getObjectifCommerciaux = () => {
                if(!objectifModal.agenceId) return [];
                const ag = agences.value.find(a => a.id === objectifModal.agenceId);
                if(!ag) return [];
                if(ag.commerciauxDetails) return ag.commerciauxDetails.map(c => c.name);
                if(ag.commerciaux) return ag.commerciaux;
                return [];
            };

            const onObjectifAgenceChange = () => {
                objectifModal.commercial = '';
            };

            const saveObjectif = async () => {
                if(!objectifModal.agenceId || !objectifModal.objectif || objectifModal.objectif <= 0) {
                    showNotification('‚ö†Ô∏è Veuillez remplir tous les champs requis', 'warning', 'fa-exclamation-triangle');
                    return;
                }

                try {
                    const key = objectifModal.commercial ? `${objectifModal.agenceId}_${objectifModal.commercial}` : `${objectifModal.agenceId}_agence`;
                    const existing = objectifsData.value.find(obj => 
                        obj.agenceId === objectifModal.agenceId && 
                        (objectifModal.commercial ? obj.commercial === objectifModal.commercial : !obj.commercial)
                    );

                    const data = {
                        agenceId: objectifModal.agenceId,
                        commercial: objectifModal.commercial || '',
                        objectif: objectifModal.objectif,
                        periode: objectifModal.periode
                    };

                    if(existing) {
                        await db.collection('objectifs').doc(existing.id).update(data);
                    } else {
                        await db.collection('objectifs').add(data);
                    }

                    await loadObjectifsData();
                    objectifModal.open = false;
                    showNotification('‚úÖ Objectif enregistr√© avec succ√®s', 'success', 'fa-check-circle');
                } catch(e) {
                    console.error('Erreur sauvegarde objectif:', e);
                    showNotification('‚ùå Erreur lors de la sauvegarde', 'error', 'fa-exclamation-circle');
                }
            };

            const openTarifPersonnaliseModal = async (agenceId) => {
                tarifPersonnaliseModal.agenceId = agenceId || '';
                
                // Charger les tarifs existants
                const existing = tarifsPersonnalises.value[agenceId];
                if(existing && existing.tarifs && existing.tarifs.length > 0) {
                    tarifPersonnaliseModal.tarifs = JSON.parse(JSON.stringify(existing.tarifs));
                } else {
                    tarifPersonnaliseModal.tarifs = [{ rdvMin: 1, montant: 0 }];
                }
                
                tarifPersonnaliseModal.open = true;
            };

            const addTarifPersonnalise = () => {
                const lastTarif = tarifPersonnaliseModal.tarifs[tarifPersonnaliseModal.tarifs.length - 1];
                tarifPersonnaliseModal.tarifs.push({
                    rdvMin: (lastTarif.rdvMin || 1) + 1,
                    montant: 0
                });
            };

            const removeTarifPersonnalise = (idx) => {
                if(tarifPersonnaliseModal.tarifs.length > 1) {
                    tarifPersonnaliseModal.tarifs.splice(idx, 1);
                }
            };

            const saveTarifPersonnalise = async () => {
                if(!tarifPersonnaliseModal.agenceId) {
                    showNotification('‚ö†Ô∏è Veuillez s√©lectionner une agence', 'warning', 'fa-exclamation-triangle');
                    return;
                }

                // V√©rifier que tous les tarifs sont valides
                for(const tarif of tarifPersonnaliseModal.tarifs) {
                    if(!tarif.rdvMin || tarif.rdvMin < 1 || !tarif.montant || tarif.montant < 0) {
                        showNotification('‚ö†Ô∏è Veuillez remplir tous les champs des tarifs', 'warning', 'fa-exclamation-triangle');
                        return;
                    }
                }

                try {
                    await db.collection('tarifs_personnalises').doc(tarifPersonnaliseModal.agenceId).set({
                        agenceId: tarifPersonnaliseModal.agenceId,
                        tarifs: tarifPersonnaliseModal.tarifs
                    });

                    await loadTarifsPersonnalises();
                    tarifPersonnaliseModal.open = false;
                    showNotification('‚úÖ Tarifs personnalis√©s enregistr√©s avec succ√®s', 'success', 'fa-check-circle');
                } catch(e) {
                    console.error('Erreur sauvegarde tarifs personnalis√©s:', e);
                    showNotification('‚ùå Erreur lors de la sauvegarde', 'error', 'fa-exclamation-circle');
                }
            };

            const getObjectifProgressPercent = (rdv, objectif) => {
                if(!objectif || objectif <= 0) return 0;
                return Math.min(100, Math.round((rdv / objectif) * 100));
            };

            const getObjectifProgressClass = (rdv, objectif) => {
                if(!objectif || objectif <= 0) return 'bg-slate-300';
                const percent = (rdv / objectif) * 100;
                if(percent >= 100) return 'bg-green-500';
                if(percent >= 75) return 'bg-blue-500';
                if(percent >= 50) return 'bg-yellow-500';
                return 'bg-orange-500';
            };

            const getObjectifStatusClass = (rdv, objectif) => {
                if(!objectif || objectif <= 0) return 'text-slate-500';
                if(rdv >= objectif) return 'text-green-600';
                if(rdv >= objectif * 0.75) return 'text-blue-600';
                if(rdv >= objectif * 0.5) return 'text-yellow-600';
                return 'text-orange-600';
            };

            // Fonction pour synchroniser tous les RDV honor√©s du mois en cours
            const syncAllHonoredRdv = async () => {
                if(!confirm('Synchroniser tous les RDV honor√©s de ce mois dans le Bilan ?')) return;
                
                try {
                    showNotification('üîÑ Synchronisation en cours...', 'info', 'fa-sync-alt');
                    
                    const currentMonth = new Date().getMonth();
                    const currentYear = new Date().getFullYear();
                    
                    // R√©cup√©rer tous les RDV honor√©s du mois en cours avec agenceId
                    const honoredRdvs = rdvList.value.filter(r => {
                        if(r.statut !== 'honore' || !r.date || !r.agenceId) return false;
                        const d = new Date(r.date);
                        return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                    });
                    
                    if(honoredRdvs.length === 0) {
                        showNotification('‚ÑπÔ∏è Aucun RDV honor√© ce mois-ci avec agence', 'info', 'fa-info-circle');
                        return;
                    }
                    
                    // R√©cup√©rer tous les RDV d√©j√† synchronis√©s pour √©viter les doublons
                    const allBilanRdvs = await db.collection('bilan_rdv').get();
                    const syncedRdvIds = new Set();
                    allBilanRdvs.forEach(doc => {
                        const data = doc.data();
                        if(data.rdvId) syncedRdvIds.add(data.rdvId);
                        if(data.rdvIds && Array.isArray(data.rdvIds)) {
                            data.rdvIds.forEach(id => syncedRdvIds.add(id));
                        }
                    });
                    
                    let synced = 0;
                    let skipped = 0;
                    let errors = 0;
                    
                    // Synchroniser chaque RDV
                    for(const rdv of honoredRdvs) {
                        try {
                            // V√©rifier si d√©j√† synchronis√©
                            if(syncedRdvIds.has(rdv.id)) {
                                skipped++;
                                continue;
                            }
                            
                            // Synchroniser (la fonction g√®re le regroupement automatiquement)
                            await syncRdvToBilan(rdv, '');
                            syncedRdvIds.add(rdv.id); // Marquer comme synchronis√©
                            synced++;
                        } catch(e) {
                            console.error('Erreur sync RDV:', rdv.id, e);
                            errors++;
                        }
                    }
                    
                    const message = `‚úÖ Synchronisation termin√©e : ${synced} RDV ajout√©s, ${skipped} d√©j√† pr√©sents${errors > 0 ? `, ${errors} erreurs` : ''}`;
                    showNotification(message, synced > 0 ? 'success' : 'info', 'fa-check-circle');
                    
                    // Recharger les donn√©es
                    setTimeout(() => {
                        loadBilanData();
                        // V√©rifier imm√©diatement s'il y a des RDV √† traiter apr√®s synchronisation
                        setTimeout(() => {
                            checkCommercialReminders(true);
                        }, 1500);
                    }, 500);
                    
                } catch(e) {
                    console.error('Erreur synchronisation:', e);
                    showNotification('‚ùå Erreur lors de la synchronisation', 'warning', 'fa-exclamation-triangle');
                }
            };
            
            // Fonction pour nettoyer et regrouper les doublons existants
            const cleanAndRegroupBilan = async () => {
                if(!confirm('Nettoyer et regrouper les lignes du Bilan ? Cette op√©ration peut prendre quelques instants.')) return;
                
                try {
                    showNotification('üîÑ Nettoyage en cours...', 'info', 'fa-sync-alt');
                    
                    const allBilan = await db.collection('bilan_rdv').get();
                    const grouped = {};
                    const toDelete = [];
                    
                    // Grouper par agence + date + commercial
                    allBilan.forEach(doc => {
                        const data = doc.data();
                        const key = `${data.clientId || ''}_${data.periodDate || data.date}_${data.commercial || ''}_${data.reporte || false}`;
                        
                        if(!grouped[key]) {
                            grouped[key] = {
                                doc: doc,
                                data: data,
                                rdvIds: new Set(data.rdvIds || (data.rdvId ? [data.rdvId] : [])),
                                rdvCount: data.rdv || 1,
                                total: data.total || 0,
                                geste: data.gesteMontant || 0
                            };
                        } else {
                            // Doublon trouv√©, fusionner
                            const existing = grouped[key];
                            existing.rdvCount += (data.rdv || 1);
                            existing.total += (data.total || 0);
                            existing.geste += (data.gesteMontant || 0);
                            
                            // Fusionner les rdvIds
                            if(data.rdvIds) {
                                data.rdvIds.forEach(id => existing.rdvIds.add(id));
                            }
                            if(data.rdvId) {
                                existing.rdvIds.add(data.rdvId);
                            }
                            
                            toDelete.push(doc.id);
                        }
                    });
                    
                    // Mettre √† jour les lignes regroup√©es
                    const batch = db.batch();
                    let updated = 0;
                    
                    Object.values(grouped).forEach(group => {
                        if(toDelete.includes(group.doc.id)) return; // On garde la premi√®re ligne
                        
                        const rdvIdsArray = Array.from(group.rdvIds);
                        const newTotal = group.data.tarif * group.rdvCount;
                        const newNetTotal = newTotal - group.geste;
                        
                        batch.update(db.collection('bilan_rdv').doc(group.doc.id), {
                            rdv: group.rdvCount,
                            total: newTotal,
                            netTotal: newNetTotal,
                            geste: group.geste > 0,
                            gesteMontant: group.geste,
                            rdvIds: rdvIdsArray
                        });
                        updated++;
                    });
                    
                    // Supprimer les doublons
                    toDelete.forEach(id => {
                        batch.delete(db.collection('bilan_rdv').doc(id));
                    });
                    
                    await batch.commit();
                    
                    showNotification(`‚úÖ Nettoyage termin√© : ${updated} lignes mises √† jour, ${toDelete.length} doublons supprim√©s`, 'success', 'fa-check-circle');
                    
                    setTimeout(() => {
                        loadBilanData();
                    }, 500);
                    
                } catch(e) {
                    console.error('Erreur nettoyage:', e);
                    showNotification('‚ùå Erreur lors du nettoyage', 'warning', 'fa-exclamation-triangle');
                }
            };

            // Charger les donn√©es au montage si on est sur la vue bilan
            watch(() => view.value, (newView) => {
                if(newView === 'bilan') {
                    loadBilanConfig();
                    loadBilanData();
                    // Initialiser les filtres des objectifs avec le mois en cours
                    if(!objectifsFilters.mois) {
                        objectifsFilters.mois = monthKey(new Date());
                    }
                }
                if(newView === 'connexions' && user.role === 'admin') {
                    loadConnexionsHistory();
                    startConnexionsListener();
                    // Actualiser toutes les 10 secondes pour voir les changements en temps r√©el
                    connexionsInterval = setInterval(() => {
                        if(view.value === 'connexions' && user.role === 'admin' && !isDeletingLogs.value) {
                            loadConnexionsHistory();
                        } else if(view.value !== 'connexions') {
                            stopConnexionsListener();
                        }
                    }, 10000); // Toutes les 10 secondes
                } else {
                    stopConnexionsListener();
                }
            });
            
            // Initialiser la v√©rification mensuelle au d√©marrage
            if(user.role === 'admin') {
                checkAndGenerateMonthlySummary();
            }

            // Mettre √† jour les statistiques des objectifs quand on change d'onglet ou de donn√©es
            watch(() => bilanTab.value, () => {
                if(bilanTab.value === 'objectifs') {
                    updateObjectifsStats();
                }
            });

            watch(() => bilanRows.value, () => {
                if(bilanTab.value === 'objectifs') {
                    updateObjectifsStats();
                }
            }, { deep: true });
            
            const validateAction = async (r, type) => { 
                if(type==='rappels') {
                    // Si le rappel a d√©j√† √©t√© fait, ne pas r√©ouvrir le SMS - juste confirmer
                    if(r.rappelFait) {
                        showNotification('‚úÖ Ce rappel a d√©j√† √©t√© envoy√©', 'info', 'fa-bell');
                        return;
                    }
                    
                    // Marquer le rappel comme fait AVANT d'ouvrir le SMS
                    const now = new Date();
                    const note = { 
                        text: `üîî Rappel envoy√©`, 
                        author: user.name, 
                        date: now.toISOString(),
                        type: 'rappel'
                    };
                    let notes = r.notes || []; 
                    notes.push(note);
                    
                    // Mettre √† jour imm√©diatement dans l'interface
                    r.rappelFait = true;
                    r.rappelFaitDate = now.toISOString();
                    r.rappelFaitHeure = now.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});
                    r.notes = notes;
                    if(clientModal.rdv && clientModal.rdv.id === r.id) {
                        clientModal.rdv.rappelFait = true;
                        clientModal.rdv.rappelFaitDate = now.toISOString();
                        clientModal.rdv.rappelFaitHeure = now.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});
                        clientModal.rdv.notes = notes;
                    }
                    
                    // Sauvegarder dans Firebase
                    await db.collection('rendezvous').doc(r.id).update({ 
                        rappelFait: true,
                        rappelFaitDate: now.toISOString(),
                        rappelFaitHeure: now.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'}),
                        notes: notes
                    });
                    
                    // Ouvrir directement l'application SMS Android avec le message pr√©-rempli
                    const rappelType = getRappelType(r);
                    const smsLink = generateMsgLink(r, rappelType);
                    
                    // Pour Android, on ouvre directement l'app SMS avec le message
                    // L'utilisateur pourra ensuite programmer l'envoi dans l'app SMS Android
                    if(smsLink) {
                        window.open(smsLink, '_blank');
                    }
                    
                    showNotification('‚úÖ Rappel marqu√© comme envoy√© - Application SMS ouverte', 'success', 'fa-mobile-alt');
                }
                if(type==='confirmations') {
                    // V√©rifier si le RDV est dans l'agenda avant de valider
                    if (!r.dansAgenda) {
                        // Afficher un modal moderne au lieu d'un confirm()
                        return new Promise((resolve) => {
                            confirmAgendaModal.rdv = r;
                            confirmAgendaModal.onConfirm = async (confirmed) => {
                                if (confirmed) {
                                    // L'utilisateur confirme qu'il a ajout√© √† l'agenda, on valide
                                    await db.collection('rendezvous').doc(r.id).update({ statut:'confirme' });
                                    r.statut = 'confirme';
                                } else {
                                    // L'utilisateur veut d'abord ajouter √† l'agenda
                                    // Ne rien faire, il pourra cliquer sur le bouton Agenda
                                }
                                confirmAgendaModal.open = false;
                                confirmAgendaModal.rdv = null;
                                confirmAgendaModal.onConfirm = null;
                                resolve();
                            };
                            confirmAgendaModal.open = true;
                        });
                    } else {
                        await db.collection('rendezvous').doc(r.id).update({ statut:'confirme' }); 
                    }
                }
            };
            const generateLink = (r, type) => generateMsgLink(r, type);

            return {
                user, loginEmail, loginPass, view, login, logout, loginAdminSelection, finalizeAdminLogin,
                rdvList, agences, sourcesList, stats, sortedDaily, filteredList, displayedList, rappelsList, confirmList, rappelCount, confirmCount,
                wizard, form, clientModal, settingsModal, cancelModal,
                rescheduleModal, motifSelectionModal, messagePreviewModal, rescheduleSMSMessages, rescheduleSMSMessagesClient, rescheduleMotifsList, rescheduleMotifsListInterne, newRescheduleMotif, newRescheduleMotifInterne, editingRescheduleType, openMotifs, loadRescheduleSMSMessages, saveRescheduleSMSMessages, addRescheduleMotif, removeRescheduleMotif, addRescheduleMotifInterne, removeRescheduleMotifInterne, copyToClipboard, insertVariable, getReschedulePreview, updateReschedulePreview, selectMotif, getMotifLabel, openRescheduleModal, handleMotifTypeChange, confirmRescheduleStep1, sendRescheduleSMS, showMessagePreview, deleteRdv: softDeleteRdv, softDeleteRdv,
                changeView, showUpcoming, showLive, showHonored, showNoShow, showCancelled, goBackFromList, fromDashboard, // NEW EXPORTS
                currentFilter, listFilters, resetListFilters, displayLimit,
                startWizard, finalizeRdv, selectSource, validateAndSendSMS, finalizeRdvWithSMS, parseAndFormatFacebookCaracteristiques, handleFacebookPaste, updateModeleFromFacebook, getBaseModele, formatCaracteristiquesForDisplay, updateEditModalModele, addNewCaracteristique, removeCaracteristique, getFormatagePreview, saveFormatageSettings, formatageSettings, formatPrixInput, handlePrixPaste, formatModeleName, googleCalendarDisconnectedModal,
                openRdvFiche, updateRdv, toggleOkM, resendReminder, sendManualRappel, openCancelChoice, confirmCancel, quickCancel, updateStatus, rdvMenuOpen,
                openSettings, openAgencyEdit, saveEditingAgency, editingAgency, saveAgency, deleteAgency, addSource, removeSource, changeSourceLogo, getLogo,
                editingAgencyCommerciaux, addAgencyCommercial, removeAgencyCommercial,
                editingAgencyFermetures, addAgencyFermeture, removeAgencyFermeture, saveFermetureIndividuelle, isFermetureValide,
                newSource, motifsList, newMotif, addMotif, removeMotif, cancelMotifsList, newCancelMotif, addCancelMotif, removeCancelMotif, editingMsgAgence, editingMsgType, clientExists, insertTag, msgLabels, getMessagePreview,
                globalSearchModal, performGlobalSearch, selectFirstResult, actionHistory, logAction,
                detailedLogs, performanceStats, workloadPrediction, loadDetailedLogs, calculatePerformanceStats, calculateWorkloadPrediction,
                connectedUsers, connexionsHistory, connectedUsersCount, loadConnexionsHistory, calculateConnectedUsers, loadingConnexions,
                selectedConnexionLogs, connexionDeleteModal, toggleConnexionLogSelection, deleteConnexionLogs,
                userHistoryModal, openUserHistoryModal, monthlySummaries,
                generateMsgLink, generateLink, validateAction,
                dateOptions, timeSlots, commonCars, pastePhoneNumber, copyToAgenda, showCustomTime, updateGoogleCalendarEvent, deleteGoogleCalendarEvent, addToAgenda, removeFromAgenda, fetchGoogleCalendarList, googleCalendarList, loadingCalendars,
                syncSettings, saveSyncSettings, 
                filters, search, 
                formatDateFr, formatDateShort, formatDateLong, formatPrice, isEnCours, isLateAndNoStatus, displayStatus, statusClass, getAgenceName, getCreatedDate, getCreatedTime, isNewRdvFromOther, isRdvApproaching, needsRappel, getCalendarColor,
                normalizePhone, onWizardPhoneInput, onModalPhoneInput, formatName, formatNameRealTime, formatNameRealTimeEdit, onWizardNameBlur, onWizardNamePaste, onEditModalNameBlur, onEditModalNamePaste, getRdvClientLink,
                getRappelType, getRappelLabel,
                intelligentPaste, handleIntelligentPaste, showIntelligentModeHelp,
                openReschedule,
                currentFullDateLabel, checkAgenceAndProceed, pausedAgencyModal, pauseReasonSelect, updatePauseReason,
                getPauseMessage, isDateInFermeture, getFermetureMessage, isAgenceFermeeAujourdhui, getProgressPercent, getRdvTimeStatus,
                pendingStatusList, pendingStatusCount, getRelativeRdvLabel,
                selectedIds, selectAll, toggleSelection, isAllSelected, bulkModal, openBulkConfirm, executeBulkAction, 
                trashList, trashCount, restoreRdv, hardDeleteRdv,
                agencySearch, filteredAgences,
                calculateTTC, conversionRate, conversionRateColor, conversionEmoji, activeRdvCount,
                // NEW VARS
                teamList, newMember, addTeamMember, toggleBlockTeamMember, deleteTeamMember, mobileMenuOpen, welcomeModal, tutorialModal, tutorialVideoModal, forcedLogoutModal, blockedLoginMessage, loginErrorModal, quickRdvCommerciaux, quickRdvHasCommerciaux,
                adminNamesList, newAdminName, addAdminName, removeAdminName,
                newNoteText, addNote,showDiscountInput, allProspectors, dashboardFilters, dashboardLimit, filteredDaily,rdvTodayCount, nextRdvLabel, currentTheme, isTimelineTomorrow, showTimelineTomorrow,
                googleCalendarConnected, googleCalendarUserEmail, isGoogleCalendarConnected, googleCalendarTokenValid, checkingToken, checkAndUpdateTokenStatus, tokenTimeRemaining, connectGoogleCalendar, disconnectGoogleCalendar, manualSyncGoogleCalendar,
                prospecteurGoogleCalendarConnected, prospecteurGoogleCalendarTokenExpired, prospecteurTokenTimeRemaining, prospecteurDisplayTimeRemaining, prospecteurGoogleCalendarTokenValid, checkingProspecteurToken, checkAndUpdateProspecteurTokenStatus, handleProspecteurGoogleCalendar, reloadProspecteurToken,forceGlobalRefresh, getActiveGoogleToken, activeGoogleToken,
                confirmAgendaModal, reconnectAgendaModal, googleCalendarInfoModal, handleAddToAgendaClick, handleRemoveFromAgendaClick, confirmRemoveFromAgenda, removeAgendaConfirmModal, handleReconnectForAgenda, handleCloseDisconnectedModal, saveGoogleCalendarRequired, googleCalendarRequired,
                // CALENDRIER
                currentWeekStart, calendarWeekDays, calendarHours, calendarEvents, calendarLoading, calendarAgencyFilter,
                previousWeek, nextWeek, goToToday, refreshCalendarEvents, createRdvFromTimeSlot, openEventDetails,
                getEventsForSlot, getEventStyle, getEventTitle, getEventTime, isCurrentTimeSlot, formatCalendarWeekTitle, getAgenceColor,
                isClosedSlot, getClosedMessage, getOpeningTime, getOpeningLineStyle, getDayHoursInfo, isDayClosed,
                applyHorairesToAllDays,
                honorModal, openHonorCheck, finalizeHonor, syncRdvToBilan, removeRdvFromBilan, getHonorCommerciaux, getAgencyCommerciaux,
                editModal, openEdit, saveEdit, deleteNote, editMainNote, deleteMainNote, editNoteModal, saveNoteEdit,
                
                discountModal, openDiscountModal, saveDiscount, removeDiscount,
                reminderAlertModal, rappelsVeilleCount, rappelsJourCount,
                teamEditModal, openTeamEdit, saveTeamMemberEdit, passwordEditModal, openPasswordEdit, savePasswordEdit, 
                customConfirmModal, openCustomConfirm, rappelFilters, rappelsDisplay,
                globalSettings, saveGlobalSettings,
                pendingStatusModal,
                notificationToast, showNotification, 
                
                // NEW STATS & PRICING
                statsModal, openStatsModal, detailedStats, statsModalData, commercialStatsFiltered, mandatsParAgence, statsModalSelectedPeriod, statsFilterAgency, statsFilterUser, statsFilterMonth, statsFilterYear, resetDashboardDateFilters, resetStatsModalDateFilters, visibleAgencies, userCommissionStats, exportStatsPdf,
                globalCommission, tips, saveTip,
                
                // PORTAFEUILLE
                portefeuilleSearch, selectedProspecteur, filteredProspectors, transactions, prospecteurEdit,
                filterProspectors, selectProspecteur, loadProspecteurData, saveProspecteurSettings,
                hideTransaction, showTransaction, deleteTransaction, getTransactionIcon, loadUserTransactions,
                prospecteurStats, allTransactions, visibleTransactions, userPortefeuille,
                onlyProspectors, prospectorsWithStats, displayedProspectors, adminStats,
                createTransactionForRdv, checkAndCreateBonusTransactions, deleteTransactionsForRdv, createMissingTransactionsForUser, getRdvFromTransaction, tipModal, openTipModal, saveTipTransaction,
                
                // RAPPELS ET RDV RAPIDE
                rappelConfirmModal, confirmRappelSent, quickRdvModal, createQuickRdv, handleSendRappel,
                
                // BILAN
                bilanRows, bilanConfig, bilanForm, bilanFilters, selectedBilanIds, bilanCurrentPage, bilanPeriod, bilanModal, bilanEditModal, bilanSettingsModal,
                formatBilanPrice, formatBilanDate, getBilanLineVals, getBilanCommerciaux, onBilanAgenceChange, addBilanBlock, removeBilanBlock, saveBilanRdv,
                toggleBilanReport, renderBilanTable, clearBilanFilters, goToPreviousMonth, deleteSelectedBilan, toggleAllBilan, isAllBilanSelected, changeBilanPage, displayedBilanRows, bilanTotalPages, bilanStats,
                showBilanCommercialModal, exportMonthPdfAll, exportComptaExcel, openBilanSettings, openBilanEdit, saveBilanEdit, exportBilanPdf, setBilanPeriod,
                exportBilanAgencePDF, exportBilanCommercialPDF, getTarifPersonnalise,
                loadBilanConfig, loadBilanData, buildBilanMonthOptions, handleBilanLogo, handleBilanSignature, saveBilanSettings,
                bilanTab, urgentBilanRows, urgentBilanCount, prospecteurUrgentRows, prospecteurUrgentCount, openUrgentCommercialModal, saveUrgentCommercial, getUrgentRdvClient, getUrgentRdvPhone, urgentCommercialModal, getUrgentCommerciaux,
                bilanMonthOptions, bilanYearOptions, dashboardYearOptions, syncAllHonoredRdv, hasBilanCommerciaux, cleanAndRegroupBilan, billingSummaryModal, openBillingSummary, billingStatsGrouped, billingSummarySearch, filteredBillingStatsGrouped,
                
                // OBJECTIFS
                objectifsFilters, objectifsStats, objectifModal, tarifPersonnaliseModal,
                openObjectifModal, saveObjectif, hasObjectifCommerciaux, getObjectifCommerciaux, onObjectifAgenceChange,
                openTarifPersonnaliseModal, addTarifPersonnalise, removeTarifPersonnalise, saveTarifPersonnalise,
                getObjectifProgressPercent, getObjectifProgressClass, getObjectifStatusClass, updateObjectifsStats,
                fermetureModal, fermeturesList, deleteFermeture, createFermeture, loadFermetures, fermetureDeleteConfirmModal, confirmDeleteFermeture, editFermeture, updateFermeture,
                heureFermetureConfirmModal, confirmHeureFermeture, checkHeureFermetureAndConfirm, getHeureFermetureAgence, isHeureProcheFermeture, isHeureValide, handleTimeInput,
                heureLimiteExceptionnelleModal, isHeureApresLimiteExceptionnelle, heureApresFermetureModal, confirmHeureApresFermeture, isHeureApresFermeture
            };
        }
    }).mount('#app');
</script>
</body> 
</html>
