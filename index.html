 <!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>RDV ‚Äî C&N Solutions</title>

<!-- Tailwind & Icons -->
<script src="https://cdn.tailwindcss.com"></script>
<script> window.FontAwesomeConfig = { autoReplaceSvg: 'nest' };</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<link href="https://fonts.googleapis.com/css?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
/* ===================== THEME SYSTEM ‚Äî lisible en clair & sombre ===================== */
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial,sans-serif;-webkit-font-smoothing:antialiased;color-scheme: light dark}

/* -- Base (clair) */
:root{
  --bg:#f8fafc;           /* fond page */
  --card:#ffffff;         /* cartes, rang√©es RDV, boutons neutres */
  --surface:#ffffff;      /* champs */
  --tile:#f1f5f9;         /* petites pastilles (chips/badges) */
  --ink:#0b1320;          /* texte principal */
  --muted:#6b7280;        /* texte secondaire */
  --line:#e2e8f0;         /* bordures */
  --blue:#3b82f6;  --blue-bg:#eff6ff;
  --green:#10b981; --green-bg:#ecfdf5;
  --amber:#f59e0b; --amber-bg:#fffbeb;
  --violet:#8b5cf6;--violet-bg:#f5f3ff;
  --danger:#ef4444;
  --g:12px;
}

/* -- Sombre (manuel) */
html[data-theme="dark"]{
  --bg:#0b1220;
  --card:#0f172a;
  --surface:#0f172a;
  --tile:#0b1220;
  --ink:#e5e7eb;
  --muted:#9aa3b2;
  --line:#273349;
  --blue:#60a5fa;  --blue-bg:#0b1b33;
  --green:#34d399; --green-bg:#0b1f18;
  --amber:#fbbf24; --amber-bg:#2a1f08;
  --violet:#a78bfa;--violet-bg:#1a1330;
  --danger:#f87171;
}

/* -- Sombre (auto, si aucun data-theme explicitement light) */
@media (prefers-color-scheme: dark){
  html:not([data-theme="light"]){
    --bg:#0b1220;
    --card:#0f172a;
    --surface:#0f172a;
    --tile:#0b1220;
    --ink:#e5e7eb;
    --muted:#9aa3b2;
    --line:#273349;
    --blue:#60a5fa;  --blue-bg:#0b1b33;
    --green:#34d399; --green-bg:#0b1f18;
    --amber:#fbbf24; --amber-bg:#2a1f08;
    --violet:#a78bfa;--violet-bg:#1a1330;
    --danger:#f87171;
  }
}

/* --- Fond global + couleurs par d√©faut --- */
html,body{background:var(--bg); color:var(--ink)}
h1,h2,h3{margin:0 0 10px; color:var(--ink)}
h2{font-size:22px;letter-spacing:.2px}

/* --- Layouts existants (inchang√©s) --- */
.flex-gap{margin:calc(var(--g)*-0.5);display:flex;flex-wrap:wrap}.flex-gap>*{margin:calc(var(--g)*0.5)}
.row{display:flex;flex-wrap:wrap}.row-child{margin:calc(var(--g)*0.5)}
.tabs{display:flex;flex-wrap:wrap}.tabs>*{margin:calc(var(--g)*0.5)}
.rdv-actions{display:flex;flex-wrap:wrap;align-items:center;justify-content:flex-end}.rdv-actions>*{margin:calc(var(--g)*0.5)}
.kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(210px,1fr));gap:14px}
@supports not (display:grid){.kpis{display:flex;flex-wrap:wrap}.kpis>*{margin:7px;flex:1 1 210px}}

/* --- Inputs & boutons (couleurs via tokens) --- */
.input,select,textarea,button{font-family:inherit;-webkit-appearance:none;appearance:none;outline:none;color:var(--ink)}
select{padding-right:40px;background-repeat:no-repeat;background-position:calc(100% - 18px) center;background-size:10px}

.card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:18px;margin:18px 0}
.label{font-size:15px;color:var(--muted);margin:8px 0 6px}

.input,select,textarea{
  width:100%;padding:14px 15px;border:1.5px solid var(--line);border-radius:12px;font-size:17px;transition:.18s;background:var(--surface);color:var(--ink)
}
.input:focus,select:focus,textarea:focus{border-color:#cfd8e6;box-shadow:0 0 0 3px rgba(37,99,235,.085)}

.btn{border:none;border-radius:10px;padding:10px 11px;font-weight:700;cursor:pointer;font-size:14px;color:var(--ink)}
.btn:hover{transform:translateY(-1px)} .btn:active{transform:translateY(0)}
.btn-xs{padding:7px 9px;font-size:12px;border-radius:9px}
.btn-ghost{background:transparent;border:1.5px solid var(--line);color:var(--ink)}
.btn-primary{background:#111827;color:#fff}
.btn-neutral{background:var(--card);border:1.5px solid var(--line);color:var(--ink)}
.btn-warn{background:var(--card);border:1.5px dashed var(--danger);color:var(--danger)}
.icon-only{width:34px;height:34px;display:flex;align-items:center;justify-content:center;padding:0;font-size:16px}

.small{font-size:14px;color:var(--muted)}
.mt6{margin-top:6px}.mt8{margin-top:8px}.mt12{margin-top:12px}.mt16{margin-top:16px}.mt20{margin-top:20px}

/* --- KPI (utilise fonds lisibles) --- */
.kpi{border:1px solid var(--line);border-radius:12px;padding:14px;background:var(--card)}
.kpi b{display:block;font-size:30px;margin-bottom:6px}
.kpi.blue b{color:var(--blue)} .kpi.blue{background:var(--blue-bg)}
.kpi.green b{color:var(--green)} .kpi.green{background:var(--green-bg)}
.kpi.amber b{color:var(--amber)} .kpi.amber{background:var(--amber-bg)}
.kpi.violet b{color:var(--violet)} .kpi.violet{background:var(--violet-bg)}

/* --- Tabs --- */
.tab{padding:6px 10px;border:1.5px solid var(--line);border-radius:10px;background:var(--card);color:var(--ink);cursor:pointer;font-size:12.5px;font-weight:600;line-height:1.1;transition:all .18s}
.tab:hover{background:var(--tile);border-color:#cbd5e1}
.tab.active{background:#111827;border-color:#111827;color:#fff}
.tab .pill{margin-left:6px;padding:2px 6px;font-size:11px;border-width:1px}
.tab.active .pill{color:#111827;background:#fff;border-color:#e5e7eb}
.tabs>*{margin:4px}

/* Divers */
.hide{display:none!important}
.list{display:grid;gap:12px}
.rdv{display:flex;justify-content:space-between;align-items:center;gap:10px;border:1px solid var(--line);border-radius:12px;background:var(--card);padding:12px;min-height:98px}
.rdv .title{font-size:17px;font-weight:800;color:var(--ink)}
.rdv .meta{font-size:14px;color:var(--muted)}
.badge{display:inline-block;border-radius:999px;padding:5px 9px;border:1px solid var(--line);font-size:12px;background:var(--tile);color:var(--ink)}
.wiz .step{display:none}.wiz .step.active{display:block;animation:fade .15s ease}
.wiz .nav{display:flex;justify-content:space-between;margin-top:12px;gap:8px;position:sticky;bottom:0;background:var(--card);padding-top:8px}
.err{color:var(--danger);font-size:14px;margin-top:6px;display:none}
@keyframes fade{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}
.chips{display:flex;flex-wrap:wrap}.chip{background:var(--tile);border:1px solid var(--line);border-radius:999px;padding:8px 12px;font-size:14px;cursor:pointer;color:var(--ink)}
.toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.2);opacity:0;pointer-events:none;transition:.25s;z-index:9999}
.toast.show{opacity:1;transform:translateX(-50%) translateY(-6px)} .toast.ok{background:#16a34a}.toast.warn{background:#ef4444}
@keyframes pulseBlink{0%,100%{box-shadow:0 0 0 0 rgba(59,130,246,0)}50%{box-shadow:0 0 0 8px rgba(59,130,246,.18)}} .blink{animation:pulseBlink 1.4s ease-in-out infinite}
.pager{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:10px}
.pill{display:inline-flex;align-items:center;gap:6px;border:1.5px solid var(--line);background:var(--card);border-radius:999px;padding:6px 10px;font-size:12.5px;color:var(--ink)}
.bubble{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);border-radius:999px;padding:6px 12px;font-size:12px;font-weight:500;background:var(--card);color:var(--ink)}
.bubble.blue{background:#eff6ff;border-color:#93c5fd}
.bubble.orange{background:#fff7ed;border-color:#fdba74}
.bubble.green{background:#ecfdf5;border-color:#86efac}
.bubble.gray{background:#f8fafc;border-color:#cbd5e1}
.bubble.wa{background:#ecfdf5;border-color:#86efac}
.bubble.sms{background:#eff6ff;border-color:#93c5fd}
.ag-card{border:1px solid var(--line);border-radius:14px;padding:14px;background:var(--card);display:flex;gap:12px;justify-content:space-between;align-items:flex-start}
.ag-name{font-weight:800;font-size:16px}
.tokenbar{display:flex;flex-wrap:wrap;margin:8px 0}.token{border:2px dashed #cbd5e1;border-radius:10px;padding:6px 10px;font-weight:500;background:var(--tile);color:var(--ink)}
.template-tabs{display:flex;gap:6px;margin:8px 0}
.template-tabs .t{padding:8px 14px;border:2px solid var(--line);border-radius:10px;font-weight:500;background:var(--card);color:var(--ink)}
.template-tabs .t.active{font-weight:700;border-color:#111827;background:#111827;color:#fff}
.preview{white-space:pre-wrap;background:var(--tile);border:1px solid var(--line);border-radius:8px;padding:10px;font-size:13.5px;color:var(--ink)}
::-webkit-scrollbar{display:none}

/* Surcouche esth√©tique d‚Äôorigine */
#cn-app{border-radius:20px;box-shadow:0 8px 32px rgba(0,0,0,.12);background:var(--card)!important;color:var(--ink)!important}
.icon-only{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center}
.kpi{border-radius:16px;padding:20px;box-shadow:0 2px 6px rgba(0,0,0,.05)}
.kpi.blue{background:#eff6ff;border-color:#93c5fd}
.kpi.green{background:#ecfdf5;border-color:#86efac}
.kpi.amber{background:#fffbeb;border-color:#fcd34d}
.kpi.violet{background:#f5f3ff;border-color:#c4b5fd}
.rdv{gap:12px;border-radius:16px;padding:20px;min-height:110px;box-shadow:0 2px 8px rgba(0,0,0,.04);transition:all .2s}
.rdv:hover{box-shadow:0 4px 12px rgba(0,0,0,.08);transform:translateY(-1px)}
#search{display:none!important}

/* Stepper */
.cn-stepper{display:flex;align-items:center;gap:10px}
.cn-stepper--mini{gap:6px}
.cn-step{display:flex;align-items:center;gap:10px}
.cn-dot{width:26px;height:26px;border-radius:999px;border:2px solid var(--line);background:var(--card);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;color:#64748b;box-shadow:0 1px 0 rgba(0,0,0,.04);transition:.18s}
.cn-dot i{font-size:12px;line-height:1}
.cn-stepper--mini .cn-dot{width:14px;height:14px;border-width:2px;font-size:0}
.cn-step.is-done .cn-dot{background:var(--blue);border-color:var(--blue);color:#fff}
.cn-step.is-current .cn-dot{border-color:var(--blue)}
.cn-line{height:3px;flex:1;background:var(--line);border-radius:99px;position:relative;overflow:hidden;min-width:14px}
.cn-step.is-done + .cn-line::before{content:"";position:absolute;left:0;top:0;bottom:0;width:100%;background:linear-gradient(90deg,var(--blue),#60a5fa)}
.cn-stepper-labels{display:flex;justify-content:space-between;font-size:12.5px;color:#64748b;margin-top:8px}

/* Overlay modales */
#cn-white-overlay{position:fixed;inset:0;background:var(--bg);opacity:0;pointer-events:none;transition:opacity .24s ease;z-index:999}
#cn-white-overlay.is-visible{opacity:1;pointer-events:auto}
html.modal-open,body.modal-open{overflow:hidden!important;touch-action:none!important}

/* Placeholders & dialogs */
::placeholder{color:var(--muted);opacity:.9}
dialog{background:var(--card)!important;color:var(--ink)!important;border:1px solid var(--line)!important}
dialog .ag-card,dialog .card,dialog .preview{background:var(--tile)!important;border-color:var(--line)!important}
dialog .token{background:var(--tile)!important;color:var(--ink)!important;border-color:var(--line)!important}

/* Mobile tweaks (inchang√©s sauf couleurs via tokens) */
@media (max-width:520px){
  .btn{padding:9px 10px;font-size:13px}.btn-xs{padding:6px 8px;font-size:11.5px}.icon-only{width:30px;height:30px;font-size:15px}
  .toolbar{gap:6px}
  .date-group{flex:1 1 100%}.date-group .input{flex:1}
  dialog{max-width:100vw !important;width:100vw !important;margin:0;border-radius:0 !important}
  .dlg-body{display:flex;flex-direction:column;gap:12px;padding:14px}
  .sheet-actions{display:grid !important;grid-template-columns:1fr 1fr;gap:8px !important;flex-wrap:unset !important}
  .rdv-agency{order:999;margin-top:auto}
  .rdv-agency .ag-line{display:flex;align-items:flex-start;gap:8px;font-size:14px}
  .dlg-body .title{ font-size:16px !important; }
  .dlg-body a,.small,.badge,.bubble,.rdv .meta,.preview{word-break:break-word;overflow-wrap:anywhere}
}
/* Historique messages ‚Äì mobile safe */
@media (max-width:520px){ .history, .client-history, .messages{ overflow-x:hidden } }
.history-messages{ padding:8px }
.msg-row{ display:grid; grid-template-columns: 40px 1fr; gap:12px; align-items:start; padding:10px 0; border-bottom:1px solid var(--line) }
.msg-row:last-child{ border-bottom:0 }
.msg-avatar{ width:36px; height:36px; border-radius:9999px; background:var(--tile); display:grid; place-items:center; font-weight:600; font-size:12px; color:var(--blue); user-select:none }
.msg-main{ min-width:0 }
.msg-top{ display:flex; align-items:baseline; justify-content:space-between; gap:8px; margin-bottom:4px }
.msg-agency{ font-weight:600; font-size:14px; line-height:1.2; max-width:70%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
.msg-time{ font-size:12px; color:var(--muted); flex:0 0 auto }
.msg-bubble{ display:block; padding:10px 12px; background:var(--card); border:1px solid var(--line); border-radius:12px; font-size:14px; line-height:1.35; word-break:break-word; overflow-wrap:anywhere; hyphens:auto; color:var(--ink) }
.msg-tags{ margin-top:6px; display:flex; gap:6px; flex-wrap:wrap }
.msg-tag{ font-size:11px; padding:3px 6px; border:1px solid var(--line); border-radius:9999px; color:var(--muted); background:var(--card) }

/* Petites am√©liorations de lisibilit√© g√©n√©riques */
.label,.small,.rdv .meta,.badge{color:var(--muted)}
.rdv .title,h1,h2,h3{color:var(--ink)}
/* Tab actif en sombre : on inverse pour rester lisible */
html[data-theme="dark"] .tab.active,
@media (prefers-color-scheme: dark){
  html:not([data-theme="light"]) .tab.active { background:#e5e7eb!important;color:#0f172a!important;border-color:#e5e7eb!important }
}
/* ==== HOTFIX DARK MODE ‚Äî bulles color√©es & boutons visibles ==== */
/* Mode sombre auto (OS) */
@media (prefers-color-scheme: dark){
  /* Ne pas ‚Äúnoircir‚Äù le primaire */
  html:not([data-theme="light"]) .btn-primary{
    background:#e5e7eb !important; color:#0f172a !important; border-color:#e5e7eb !important;
  }
  /* Neutral/ghost en sombre lisibles */
  html:not([data-theme="light"]) .btn-neutral{
    background:#0f172a !important; color:var(--ink) !important; border-color:var(--line) !important;
  }
  html:not([data-theme="light"]) .btn-ghost{
    background:transparent !important; color:var(--ink) !important; border-color:var(--line) !important;
  }

  /* Bulles : restaurer les versions color√©es */
  html:not([data-theme="light"]) .bubble{
    color:var(--ink) !important;
  }
  html:not([data-theme="light"]) .bubble.blue{
    background:#0b1b33 !important; border-color:#1e3a8a !important;
  }
  html:not([data-theme="light"]) .bubble.orange{
    background:#2a1f08 !important; border-color:#92400e !important;
  }
  html:not([data-theme="light"]) .bubble.green{
    background:#0b1f18 !important; border-color:#166534 !important;
  }
  html:not([data-theme="light"]) .bubble.gray{
    background:#111827 !important; border-color:#334155 !important;
  }
  /* Tags canaux */
  html:not([data-theme="light"]) .bubble.wa{
    background:#0b1f18 !important; border-color:#166534 !important;
  }
  html:not([data-theme="light"]) .bubble.sms{
    background:#0b1b33 !important; border-color:#1e3a8a !important;
  }

  /* Pastilles de compte sur les onglets */
  html:not([data-theme="light"]) .tab .pill{
    background:#111827 !important; border-color:#334155 !important; color:var(--ink) !important;
  }
}

/* Mode sombre forc√© via data-theme="dark" */
html[data-theme="dark"] .btn-primary{
  background:#e5e7eb !important; color:#0f172a !important; border-color:#e5e7eb !important;
}
html[data-theme="dark"] .btn-neutral{
  background:#0f172a !important; color:var(--ink) !important; border-color:var(--line) !important;
}
html[data-theme="dark"] .btn-ghost{
  background:transparent !important; color:var(--ink) !important; border-color:var(--line) !important;
}

/* Bulles color√©es en sombre (th√®me forc√©) */
html[data-theme="dark"] .bubble{ color:var(--ink) !important; }
html[data-theme="dark"] .bubble.blue{
  background:#0b1b33 !important; border-color:#1e3a8a !important;
}
html[data-theme="dark"] .bubble.orange{
  background:#2a1f08 !important; border-color:#92400e !important;
}
html[data-theme="dark"] .bubble.green{
  background:#0b1f18 !important; border-color:#166534 !important;
}
html[data-theme="dark"] .bubble.gray{
  background:#111827 !important; border-color:#334155 !important;
}
html[data-theme="dark"] .bubble.wa{
  background:#0b1f18 !important; border-color:#166534 !important;
}
html[data-theme="dark"] .bubble.sms{
  background:#0b1b33 !important; border-color:#1e3a8a !important;
}

/* Pastilles de compte sur onglets (th√®me forc√©) */
html[data-theme="dark"] .tab .pill{
  background:#111827 !important; border-color:#334155 !important; color:var(--ink) !important;
}
/* ==== HOTFIX DARK MODE ‚Äî KPI bien color√©s ==== */

/* Sombre auto (OS) */
@media (prefers-color-scheme: dark){
  /* Fonds teint√©s + bordures plus visibles */
  html:not([data-theme="light"]) .kpi.blue{
    background: rgba(96,165,250,.16) !important;  /* bleu */
    border-color: rgba(96,165,250,.45) !important;
  }
  html:not([data-theme="light"]) .kpi.green{
    background: rgba(52,211,153,.18) !important;  /* vert */
    border-color: rgba(52,211,153,.50) !important;
  }
  html:not([data-theme="light"]) .kpi.amber{
    background: rgba(251,191,36,.18) !important;  /* ambre */
    border-color: rgba(251,191,36,.50) !important;
  }
  html:not([data-theme="light"]) .kpi.violet{
    background: rgba(167,139,250,.18) !important;  /* violet */
    border-color: rgba(167,139,250,.50) !important;
  }

  /* Chiffres en couleur franche */
  html:not([data-theme="light"]) .kpi.blue   b{ color:#60a5fa !important; }
  html:not([data-theme="light"]) .kpi.green  b{ color:#34d399 !important; }
  html:not([data-theme="light"]) .kpi.amber  b{ color:#fbbf24 !important; }
  html:not([data-theme="light"]) .kpi.violet b{ color:#a78bfa !important; }
}

/* Sombre forc√© via data-theme="dark" */
html[data-theme="dark"] .kpi.blue{
  background: rgba(96,165,250,.16) !important;
  border-color: rgba(96,165,250,.45) !important;
}
html[data-theme="dark"] .kpi.green{
  background: rgba(52,211,153,.18) !important;
  border-color: rgba(52,211,153,.50) !important;
}
html[data-theme="dark"] .kpi.amber{
  background: rgba(251,191,36,.18) !important;
  border-color: rgba(251,191,36,.50) !important;
}
html[data-theme="dark"] .kpi.violet{
  background: rgba(167,139,250,.18) !important;
  border-color: rgba(167,139,250,.50) !important;
}
html[data-theme="dark"] .kpi.blue   b{ color:#60a5fa !important; }
html[data-theme="dark"] .kpi.green  b{ color:#34d399 !important; }
html[data-theme="dark"] .kpi.amber  b{ color:#fbbf24 !important; }
html[data-theme="dark"] .kpi.violet b{ color:#a78bfa !important; }
/* === Segment status clair/sombre (s√©lection visible) === */
.seg {
  display:flex; flex-wrap:wrap; gap:8px; align-items:center;
}
.seg .opt {
  display:inline-flex; align-items:center; gap:8px;
  padding:8px 12px; border:1px solid var(--line); border-radius:10px;
  background: var(--tile); color: var(--ink); cursor:pointer; user-select:none;
  transition: background .15s ease, color .15s ease, border-color .15s ease, transform .06s ease;
}
.seg .opt:active { transform: translateY(1px); }
.seg .opt.is-active,
.seg .opt[aria-pressed="true"]{
  background: var(--ink); color: var(--bg); border-color: var(--ink);
}
.seg .opt .k { font-weight:700; font-variant-numeric: tabular-nums; }
/* === Clignotements RDV === */
@keyframes blinkBlue { 50% { outline-color: transparent; } }
@keyframes blinkRed  { 50% { outline-color: transparent; } }

.blink-blue {
  outline: 2px solid #3b82f6;        /* bleu */
  animation: blinkBlue 1s steps(2,end) infinite;
  border-radius: 10px;
}

.blink-red {
  outline: 2px solid #ef4444;        /* rouge */
  animation: blinkRed .8s steps(2,end) infinite;
  border-radius: 10px;
}
/* clignotement ultra-doux (subtil glow/pulse) */
:root{
  --blink-r: 220;
  --blink-g: 38;
  --blink-b: 38;
  --blink-a: 0.045;       /* alpha tr√®s faible = plus doux */
  --blink-duration: 2.6s; /* plus lent = plus doux */
  --blink-translate: 0.5px;
  --blink-radius: 6px;    /* arrondi du glow */
}

@keyframes blinkSoftSubtle {
  0% {
    transform: translateY(0);
    box-shadow: 0 0 0 0 rgba(var(--blink-r),var(--blink-g),var(--blink-b),0);
    opacity: 1;
  }
  50% {
    transform: translateY(calc(-1 * var(--blink-translate)));
    box-shadow: 0 6px 14px 4px rgba(var(--blink-r),var(--blink-g),var(--blink-b),var(--blink-a));
    opacity: 0.995;
  }
  100% {
    transform: translateY(0);
    box-shadow: 0 0 0 0 rgba(var(--blink-r),var(--blink-g),var(--blink-b),0);
    opacity: 1;
  }
}

.blink-red {
  position: relative; /* n√©cessaire pour ::after */
  animation: blinkSoftSubtle var(--blink-duration) ease-in-out infinite;
  /* bord l√©ger (optionnel, tr√®s discret) */
  border: 1px solid rgba(var(--blink-r),var(--blink-g),var(--blink-b),0.03);
  border-radius: var(--blink-radius);
}

/* pseudo-√©l√©ment pour un glow encore plus diffus (tr√®s subtil) */
.blink-red::after {
  content: "";
  pointer-events: none;
  position: absolute;
  inset: 0;
  border-radius: inherit;
  /* glow diffus tr√®s l√©ger ‚Äî visible m√™me si l'√©l√©ment n'accepte pas box-shadow directement */
  box-shadow: 0 6px 18px 6px rgba(var(--blink-r),var(--blink-g),var(--blink-b), calc(var(--blink-a) * 0.9));
  opacity: 0.9;
  transition: box-shadow 400ms ease, opacity 400ms ease;
}

/* accessible : si user r√©duit le mouvement, on coupe l'animation */
@media (prefers-reduced-motion: reduce) {
  .blink-red {
    animation: none !important;
  }
  .blink-red::after {
    transition: none !important;
    box-shadow: none !important;
  }
}

</style>

<script>
/* === Init th√®me (IIFE propre) === */
(() => {
  try {
    const saved = localStorage.getItem('cn_theme');
    if (saved === 'dark' || saved === 'light') {
      document.documentElement.dataset.theme = saved;
    }
    // Helper pour forcer le th√®me depuis la console / boutons
    window.CN_setTheme = (mode) => {
      try {
        if (mode !== 'dark' && mode !== 'light') {
          delete document.documentElement.dataset.theme;
          localStorage.removeItem('cn_theme');
          return;
        }
        document.documentElement.dataset.theme = mode;
        localStorage.setItem('cn_theme', mode);
      } catch (_) {}
    };
  } catch (err) {
    console.error('CN theme init error', err);
  }
})();
</script>

<script>
// === Renvoyer la confirmation (WA/SMS) ===
async function resendConfirmation(r){
  try{
    if (typeof r === 'string'){
      const snap = await db.collection('rdv').doc(r).get();
      if (!snap.exists){ alert('RDV introuvable'); return; }
      r = { id:snap.id, ...snap.data() };
    }
    if (!r || !r.id){ alert('RDV introuvable'); return; }
    const ch = ((r.channel || r.firstMsgChannel || 'wa') + '').toLowerCase();
    if (!(r.agency && r.dateText && r.timeText && r.model && r.phone)){
      alert('Champs manquants (agence, date, heure, mod√®le, t√©l√©phone).'); return;
    }
    const preWin = ch === 'wa' ? window.open('', '_blank') : null;
    const txt = msgFromTpl(
      'confirmation',
      r.agency,
      r.dateText,
      r.timeText,
      r.model,
      null,
      null,
      { CIV: r.civ || '', PRENOM: (r.name||'').trim() },
      ch
    );
    openChannelAndLog(r.phone, txt, ch, preWin);
    try{
      await db.collection('messages').add({
        type: 'confirmation_resent',
        rdvId: r.id,
        phone: r.phone,
        agency: r.agency || '',
        channel: ch,
        sentAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    }catch(_){}
    notify('Confirmation pr√™te ‚úîÔ∏è', 'ok');
  }catch(e){
    console.error('resendConfirmation error', e);
    notify('Erreur lors de l‚Äôenvoi', 'warn');
  }
}

// === Annuler un rappel d√©j√† marqu√© ===
async function undoReminder(r){
  try{
    if (typeof r === 'string'){
      const snap = await db.collection('rdv').doc(r).get();
      if (!snap.exists) return;
      r = { id:snap.id, ...snap.data() };
    }
    await db.collection('rdv').doc(r.id).set({
      reminderSent: false,
      reminderAt: firebase.firestore.FieldValue.delete(),
      reminderChannel: firebase.firestore.FieldValue.delete()
    }, { merge:true });
    patchRDV?.(r.id, { reminderSent:false, reminderAt:null, reminderChannel:null });
    refreshOpenSheet?.(r.id);
    try{
      await db.collection('messages').add({
        type: 'reminder_cancelled',
        rdvId: r.id,
        phone: r.phone,
        agency: r.agency || '',
        channel: (r.reminderChannel || r.channel || 'wa'),
        sentAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    }catch(_){}
    notify('Rappel annul√©', 'ok');
  }catch(e){
    console.error('undoReminder error', e);
    notify('Erreur lors de l‚Äôannulation du rappel', 'warn');
  }
}
</script>
</head>
<body>

<section id="cn-app" style="max-width:1100px;margin:auto;color:#0b1320;background:#fff;padding:18px">

<!-- ======================= CONNEXION ======================= -->
<div id="login" class="card">
  <h2>Connexion</h2>
  <div class="row">
    <div style="flex:1;min-width:260px" class="row-child">
      <div class="label">Administrateur</div>
      <button class="btn btn-primary btn-xs" id="btnLoginAdminPasskey">Face/Touch ID</button>
      <button class="btn btn-neutral btn-xs mt8" id="btnLoginAdminPin">Code PIN (secours)</button>
      <div class="small mt6">Active Face ID / empreinte sur ton t√©l√©phone.</div>
    </div>
    <div style="flex:1;min-width:260px" class="row-child">
      <div class="label">√âquipe</div>
      <input id="eqName" class="input" placeholder="Votre pr√©nom">
      <input id="eqPass" class="input mt8" type="password" placeholder="Mot de passe √©quipe">
      <button class="btn btn-neutral btn-xs mt8" id="btnLoginTeam">Entrer</button>
      <div class="small mt6">Ton pr√©nom s‚Äôaffichera sur les RDV.</div>
    </div>
  </div>
  <div class="small mt12">üí° (Optionnel) <button class="btn btn-ghost btn-xs" id="btnEnroll">Enregistrer ce t√©l√©phone (Passkey)</button></div>
</div>

<!-- ======================= APPLICATION ======================= -->
<div id="app" class="hide">
  <!-- Wizard -->
  <div class="card wiz">
    <h2>Confirmation de RDV</h2>

    <div class="step active" data-step="1">
      <div class="label">Agence</div>
      <select id="w_agency" class="input"></select>
      <div id="e1" class="err">Merci de s√©lectionner une agence.</div>
      <div class="nav">
        <button class="btn btn-neutral btn-xs" disabled>Retour</button>
        <button class="btn btn-primary btn-xs" id="n1">Suivant</button>
      </div>
    </div>

    <div class="step" data-step="2">
      <div class="row">
        <div style="flex:1;min-width:180px" class="row-child">
          <div class="label">Civilit√©</div>
          <select id="w_civ" class="input">
            <option value="">S√©lectionnez</option>
            <option value="M.">M.</option>
            <option value="Mme">Mme</option>
          </select>
        </div>
        <div style="flex:2;min-width:220px" class="row-child">
          <div class="label">Pr√©nom (obligatoire)</div>
          <input id="w_name" class="input" placeholder="Ex : Amine">
        </div>
      </div>
      <div id="e2" class="err">Merci d‚Äôindiquer la civilit√© et le pr√©nom.</div>
      <div class="nav">
        <button class="btn btn-neutral btn-xs" id="p2">Retour</button>
        <button class="btn btn-primary btn-xs" id="n2">Suivant</button>
      </div>
    </div>

    <div class="step" data-step="3">
      <div class="label">Num√©ro (WhatsApp / SMS) ‚Äî 06/07 ou +33 6/7</div>
      <div class="row" style="gap:8px;align-items:flex-end">
        <div style="flex:1">
          <input id="w_phone" class="input" inputmode="tel" placeholder="06 12 34 56 78 ou +33 6 12 34 56 78">
        </div>
        <button class="btn btn-neutral btn-xs" id="btnPastePhone">üìã Coller</button>
      </div>
      <div class="paste-suggest small" id="pasteSuggest" style="display:none;align-items:center;gap:8px;margin-top:6px">
        <span>üìã Num√©ro copi√© d√©tect√© :</span>
        <b id="psText"></b>
        <button class="btn btn-neutral btn-xs" id="psApply">Coller</button>
      </div>
      <div id="e3" class="err">Num√©ro invalide.</div>
      <div class="nav">
        <button class="btn btn-neutral btn-xs" id="p3">Retour</button>
        <button class="btn btn-primary btn-xs" id="n3">Suivant</button>
      </div>
    </div>

    <div class="step" data-step="4">
      <div class="label">Date (JJ/MM/AA)</div>
      <input id="w_date" class="input" inputmode="numeric" maxlength="8" placeholder="JJ/MM/AA">
      <div class="chips mt8" id="quickDateRow"></div>
      <div id="e4" class="err">Format attendu JJ/MM/AA.</div>
      <div class="nav">
        <button class="btn btn-neutral btn-xs" id="p4">Retour</button>
        <button class="btn btn-primary btn-xs" id="n4">Suivant</button>
      </div>
    </div>

    <div class="step" data-step="5">
      <div class="label">Heure (HH:MM)</div>
      <input id="w_time" class="input" inputmode="numeric" maxlength="5" placeholder="HH:MM">
      <div class="chips mt8" id="quickTimeRow"></div>
      <div id="e5" class="err">Format attendu HH:MM.</div>
      <div class="nav">
        <button class="btn btn-neutral btn-xs" id="p5">Retour</button>
        <button class="btn btn-primary btn-xs" id="n5">Suivant</button>
      </div>
    </div>

    <div class="step" data-step="6">
      <div class="label">Mod√®le du v√©hicule</div>
      <input id="w_model" class="input" placeholder="Ex : Peugeot 308, Mini Cooper‚Ä¶">
      <div id="e6" class="err">Merci d‚Äôindiquer le mod√®le.</div>
      <div class="nav">
        <button class="btn btn-neutral btn-xs" id="p6">Retour</button>
        <button class="btn btn-primary btn-xs" id="n6">Suivant</button>
      </div>
    </div>

    <div class="step" data-step="7">
      <div class="label">Source du RDV</div>
      <input id="w_source" class="input" list="sourcesList" placeholder="Leboncoin, Facebook, MyTrack‚Ä¶">
      <datalist id="sourcesList">
        <option value="Leboncoin"></option><option value="Facebook"></option><option value="MyTrack"></option><option value="T√©l√©phone"></option>
      </datalist>
      <div id="e7" class="err">Merci de pr√©ciser la source.</div>
      <div class="nav">
        <button class="btn btn-neutral btn-xs" id="p7">Retour</button>
        <button class="btn btn-primary btn-xs" id="n7">R√©capitulatif</button>
      </div>
    </div>

    <div class="step" data-step="8">
      <h3 style="font-size:18px">R√©capitulatif</h3>
      <div id="recap" class="chips mt12"></div>
      <div class="small mt8">Cliquer un √©l√©ment pour revenir √† l‚Äô√©tape.</div>
      <div class="nav">
        <button class="btn btn-neutral btn-xs" id="p8">Retour</button>
        <div class="row" style="gap:6px">
          <button class="btn btn-primary btn-xs" id="btnSMS">Envoyer par SMS</button>
          <button class="btn btn-neutral btn-xs" id="btnWA">Envoyer sur WhatsApp</button>
        </div>
      </div>
      <div id="sendErr" class="err">Erreur d‚Äôenregistrement ou d‚Äôenvoi.</div>
    </div>
  </div>

 <!-- Stats + filtres -->
  <div class="card">
    <div class="flex-gap" style="align-items:center;justify-content:space-between">
      <div style="display:flex;align-items:center;gap:10px">
        <h2 id="monthTitle">Mois en cours</h2>
      </div>
      <div class="toolbar">
        <button class="btn btn-neutral btn-xs admin-only hide" id="btnTeamPass">Mot de passe √©quipe</button>
        <button class="btn btn-warn btn-xs" id="btnPendingReq">Demandes en cours <span id="pendingCount" class="pill">0</span></button>
        <button class="btn btn-neutral btn-xs admin-only hide" id="btnAdminStats">Admin ‚Äì Stats</button>
        <button class="btn btn-neutral btn-xs admin-only hide" id="btnAgencies">Agences</button>
        <button class="btn btn-neutral btn-xs" id="btnReminders">Rappels <span id="remCount" class="pill">0</span></button>
        <button class="btn btn-neutral btn-xs" id="btnLogout">Se d√©connecter</button>
      </div>
    </div>

    <div class="kpis mt12">
      <div class="kpi green"><b id="k_upcoming">0</b>√Ä venir</div>
     <div class="kpi green admin-only hide"><b id="k_revenue">0‚Ç¨</b>Chiffre d'affaires du jour</div>
      <div class="kpi blue"><b id="k_due">0</b>Rappels √† faire aujourd‚Äôhui</div>
      <div class="kpi violet"><b id="k_honored">0</b>RDV honor√©s</div>
      <div class="kpi amber"><b id="k_noshow">0</b>Non honor√©s</div>
    </div>

    <div class="flex-gap mt12" style="align-items:flex-end">
      <button class="btn btn-neutral btn-xs" id="btnExportCur">Exporter mois</button>
      <button class="btn btn-neutral btn-xs" id="btnExportPrev">Mois pr√©c√©dent</button>
    </div>

    <div class="flex-gap mt12" style="align-items:center;gap:8px;margin-top:12px">
      <button class="btn btn-neutral btn-xs icon-only" id="btnOpenSearch" title="Recherche"><i class="fa-solid fa-magnifying-glass"></i></button>
      <input id="search" class="input" placeholder="Recherche : nom, t√©l√©phone, 3 derniers chiffres‚Ä¶ (Entr√©e = ouvrir la fiche)">
      <select id="filterAgency" class="input" style="max-width:240px"><option value="*">Toutes les agences</option></select>

      <div class="date-group">
        <div class="label-inline">Plac√©s le</div>
        <input id="filterPlacedOn" type="date" class="input">
        <button id="clearPlaced" class="btn btn-ghost btn-xs" title="Retirer le filtre">Retirer</button>
      </div>

      <div class="bulk admin-only hide" id="bulkBar" style="display:none">
        <button class="btn btn-neutral btn-xs" id="btnSelAll">Tout s√©lectionner</button>
        <button class="btn btn-neutral btn-xs" id="btnDeselAll">D√©s√©lectionner</button>
        <button class="btn btn-neutral btn-xs" id="btnBulkRestore">Restaurer</button>
        <button id="btnBulkDelete" class="btn btn-warn btn-xs" title="Supprimer d√©finitivement" aria-label="Supprimer d√©finitivement">
          <i class="fa-solid fa-trash" style="font-size:12px;line-height:1"></i>
        </button>
      </div>
      <button class="btn btn-neutral btn-xs" id="btnRefresh">Rafra√Æchir</button>
    </div>

    <!-- Onglets -->
    <div class="tabs" style="margin-top:10px">
      <button class="tab active" data-view="today">Aujourd‚Äôhui <span class="pill" id="count_today">0</span></button>
      <button class="tab" data-view="tomorrow">Demain <span class="pill" id="count_tomorrow">0</span></button>
      <button class="tab" data-view="upcoming">√Ä venir <span class="pill" id="count_upcoming">0</span></button>
      <button class="tab" data-view="todo">√Ä faire <span class="pill" id="todoCount">0</span></button>
      <button class="tab" data-view="messages">Messages</button>
      <button class="tab" data-view="trash">üóëÔ∏è Corbeille <span class="pill" id="count_trash">0</span></button>
    </div>
    <div id="cross" class="cross hide"></div>
  </div>

  <div class="list" id="rdvList" style="margin-top:14px"></div>

  <div class="pager" style="margin-top:12px">
    <button class="btn btn-neutral btn-xs" id="prevPage">Pr√©c√©dent</button>
    <span class="pill small">Page <b id="pageNum">1</b> / <b id="pageMax">1</b></span>
    <button class="btn btn-neutral btn-xs" id="nextPage">Suivant</button>
  </div>
</div>

<div id="toast" class="toast"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>

<script>
/* ---------- Firebase ---------- */
const firebaseConfig={apiKey:"AIzaSyA7-qZ8z9ET27RnWJiZBkYPsJdn3XU8ckg",authDomain:"rdv-message.firebaseapp.com",projectId:"rdv-message"};
if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();
firebase.auth().signInAnonymously().catch(()=>{});

/* ---------- Utils ---------- */
const $=(s,r=document)=>r.querySelector(s);
const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
const pad=n=>String(n).padStart(2,'0');
const todayISO=()=>{const d=new Date();return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`};
const addDays=(d,n)=>{const x=new Date(d);x.setDate(x.getDate()+n);return x}
const isoOf=(d)=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
const iso_to_jjmma=iso=>{const [Y,M,D]=(iso||'').split('-'); if(!Y) return ''; return `${D}/${M.slice(-2)}/${String(Y).slice(2)}`;}
const jjmma_to_iso=d=>{const m=d.match(/^(\d{2})\/(\d{2})\/(\d{2})$/);return m?`20${m[3]}-${m[2]}-${m[1]}`:""};
const phoneDigits=v=>(v||"").replace(/\D/g,"");
const toFR=v=>{let s=(v||"").replace(/\D/g,""); if(/^33[67]\d{8}$/.test(s)) s="0"+s.slice(2); return s.replace(/(\d{2})(?=\d)/g,"$1 ").trim();}
const phoneSMS=v=>{const s=(v||"").replace(/\D/g,""); if(/^0[67]\d{8}$/.test(s)) return s; if(/^33[67]\d{8}$/.test(s)) return "0"+s.slice(2); return s;};
const telHref=v=>`tel:${phoneSMS(v||'')}`;
function iconForChannel(r){ const ch=(r?.firstMsgChannel||r?.channel||null); if(ch==='sms') return '<i class="fa-solid fa-sms" title="SMS"></i>'; if(ch==='wa') return '<i class="fa-brands fa-whatsapp" title="WhatsApp"></i>'; return '';}
function fmtNice(iso,time){
  if(!iso||!time) return '--';
  const [Y,M,D]=iso.split('-').map(v=>+v);
  const d=new Date(Y,M-1,D);
  const j=['dimanche','lundi','mardi','mercredi','jeudi','vendredi','samedi'][d.getDay()];
  const mois=['janvier','f√©vrier','mars','avril','mai','juin','juillet','ao√ªt','septembre','octobre','novembre','d√©cembre'][d.getMonth()];
  const [HH,MM] = time.split(':'); const hTxt= `${+HH}h${MM}`;
  return `${j.charAt(0).toUpperCase()+j.slice(1)} ${D} ${mois} ${Y} √† ${hTxt}`;
}
function notify(text,type='ok'){ const t=$('#toast'); t.textContent=text; t.className='toast show '+type; setTimeout(()=>{ t.className='toast'; }, 1600); }
const fmtDT=(dt)=>{ if(!dt) return ''; const d=dt instanceof Date?dt: (dt?.toDate?dt.toDate():null); if(!d) return ''; return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`; }
function escapeHtml(s){return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}
function moisFR(i){return ['janvier','f√©vrier','mars','avril','mai','juin','juillet','ao√ªt','septembre','octobre','novembre','d√©cembre'][i];}
function dateLongueFR(isoJJMMA){ if(!isoJJMMA) return ''; const [jj,mm,aa]=isoJJMMA.split('/').map(v=>+v); const Y=2000+aa; return `${jj} ${moisFR(mm-1)} ${Y}`; }
function timeFR(t){ if(!t) return ''; const [H,Min]=t.split(':'); return `${+H}h${Min}`; }
function dateLongueISO(iso){ if(!iso) return ''; const [Y,M,D]=iso.split('-').map(v=>+v); return `${D} ${moisFR(M-1)} ${Y}`; }
function relativeWhen(iso, timeTxt){
  if(!iso || !timeTxt) return '';
  const t = todayISO(); const tomo = isoOf(addDays(new Date(), 1)); const long = dateLongueISO(iso); const h = timeFR(timeTxt);
  if(iso===t) return `aujourd‚Äôhui √† ${h}`; if(iso===tomo) return `demain (${long}) √† ${h}`; return `le ${long} √† ${h}`;
}
// Helpers utilis√©s par le bouton "Rappel" dans la liste
function patchRDV(id, patch){
  try{
    const i = (Array.isArray(ALL_R)? ALL_R.findIndex(x=>x.id===id) : -1);
    if(i>=0) ALL_R[i] = { ...ALL_R[i], ...patch };
  }catch(_){}
}

function refreshOpenSheet(id){
  try{
    // on se contente d‚Äôactualiser les compteurs + la liste
    computeDueToday?.();
    updateReminderButton?.();
    renderList?.();
  }catch(_){}
}
/* ---------- Normalisation FR +33 / 0033 ---------- */
function normalizeFR10(v){
  const d=(v||'').replace(/\D/g,'');
  if(/^0[67]\d{8}$/.test(d)) return d;
  if(/^33[67]\d{8}$/.test(d)) return '0'+d.slice(2);
  if(/^0033[67]\d{8}$/.test(d)) return '0'+d.slice(4);
  return null;
}
function formatFR10(d){ return (d||'').replace(/(\d{2})(?=\d)/g,'$1 ').trim(); }

/* ---------- Mot de passe √âQUIPE ---------- */
const TEAM_PASS_DEFAULT = "972";
let TEAM_PASS = TEAM_PASS_DEFAULT;
async function loadTeamPass(){
  try{
    const snap = await db.collection('config').doc('auth').get();
    if(snap.exists){
      const v = snap.data()?.teamPass;
      if(typeof v === 'string' && v.trim().length) TEAM_PASS = v.trim();
    }
  }catch(e){}
}
function openTeamPassDialog(){
  const dlg=document.createElement('dialog');
  dlg.innerHTML=`
    <div style="padding:14px 16px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:800">Mot de passe √©quipe</div>
      <button class="btn btn-neutral btn-xs" onclick="this.closest('dialog').close()">Fermer</button>
    </div>
    <div style="padding:16px">
      <div class="label">Nouveau mot de passe (visible aux membres de l‚Äô√©quipe)</div>
      <input id="tp_new" class="input" placeholder="Ex : 972" value="${TEAM_PASS}">
      <div class="small mt8">‚ö†Ô∏è Stock√© en clair dans Firestore.</div>
      <div class="row mt12" style="justify-content:flex-end;gap:8px">
        <button id="tp_save" class="btn btn-primary btn-xs">Enregistrer</button>
      </div>
    </div>`;
  document.body.appendChild(dlg); dlg.showModal?.() ?? dlg.setAttribute('open','');
  $('#tp_save',dlg).onclick=async()=>{
    const nv=$('#tp_new',dlg).value.trim(); if(!nv){ alert('Le mot de passe ne peut pas √™tre vide.'); return; }
    try{
      await db.collection('config').doc('auth').set({teamPass:nv,updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:true});
      TEAM_PASS=nv; notify('Mot de passe √©quipe mis √† jour ‚úîÔ∏è','ok'); dlg.close?.(); dlg.remove();
    }catch(e){ alert('Erreur lors de l‚Äôenregistrement.'); }
  };
}

/* ---------- State ---------- */
let VIEW='today'; let ALL_R=[];
let SELECTED=new Set();
let PAGE=1, PER_PAGE=4;
let FILTER_AGENCY='*';
let SHOW_ONLY_REQ=false;
let PLACED_ON=null;

/* ---------- Agences ---------- */
const AGENCIES={
  "ID Auto (La Roche sur Yon)":{
    name:"ID Auto",
    addr:"3 ZI La France, 85190 Venansault (en face de SPJ Menuiserie)",
    map:"https://share.google/CBsnXNWDWczFbf4qi",
    tagline:"ID Auto ‚Äì L‚Äôautomobile et vous"
  },
  "MVB Automobile":{
    name:"MVB Automobile",
    addr:"57 Av. du Mar√©chal de Lattre de Tassigny, 33610 Cestas",
    map:"https://share.google/bJPdap8BiqSPun9zs",
    tagline:"MVB Automobile ‚Äì votre conciergerie aupr√®s de vous"
  },
  "Elimat Auto":{
    name:"Elimat Auto",
    addr:"3bis Route du Fileur, 33750 Beychac-et-Caillau",
    map:"",
    tagline:"Notre passion et notre expertise √† votre disposition"
  },
  "BS Automobile":{
    name:"BS Automobile",
    addr:"Adresse √† pr√©ciser",
    map:"",
    tagline:"BS Automobile"
  }
};
let AGENCIES_DB = {};
async function loadAgenciesDB(){
  const snap = await db.collection('agencies').get().catch(()=>null);
  AGENCIES_DB = {};
  if(snap){
    snap.docs.forEach(d=>{
      const v = d.data() || {};
      const k = v.name || d.id;
      AGENCIES_DB[k] = {
        name: k,
        addr: v.addr || '',
        map: v.map || '',
        tagline: v.tagline || k,
        templates: v.templates || null,
        disabled: v.disabled === true,
        // ‚¨áÔ∏è NOUVEAU : prix TTC par RDV honor√©
        priceHonorTTC: (typeof v.priceHonorTTC === 'number' && !isNaN(v.priceHonorTTC)) ? v.priceHonorTTC : null
      };
    });
  }
}
function mergedAgencyKeys(){
  const set=new Set([...Object.keys(AGENCIES||{}), ...Object.keys(AGENCIES_DB||{})]);
  const filtered = Array.from(set).filter(k => AGENCIES_DB?.[k]?.disabled !== true);
  return filtered.sort((a,b)=>a.localeCompare(b));
}
function getAgencyByKey(k){
  const mem=AGENCIES?.[k]||{name:k,addr:'',map:'',tagline:k};
  const dbv=AGENCIES_DB?.[k]||{};
  return {...mem, ...dbv};
}
function getAgencyTemplates(k){ return (AGENCIES_DB?.[k]?.templates) || null; }

/* ---------- Templates (bi-canal WA/SMS) ---------- */
const TPL_DEFAULTS = {
  confirmation: {
    wa:
`{{AGENCE}} ‚Äì Confirmation de rendez-vous

Nous vous confirmons votre rendez-vous pr√©vu le {{DATE_LONG}} √† {{HEURE}} concernant votre {{MODELE}}.

Adresse : {{ADRESSE}}
{{PLAN}}

Merci de vous pr√©senter √† l‚Äôheure convenue, muni(e) de la carte grise et d‚Äôune pi√®ce d‚Äôidentit√©.

Nous restons √† votre disposition pour toute information compl√©mentaire.

L‚Äô√©quipe {{TAGLINE}}`,
    sms:
`{{AGENCE}}: RDV confirm√© le {{DATE_LONG}} √† {{HEURE}} ({{MODELE}}).
Adresse: {{ADRESSE}} {{PLAN}}
Carte grise + pi√®ce d'identit√©. ‚Äî {{TAGLINE}}`
  },
  rappel: {
    wa:
`{{AGENCE}} ‚Äì Rappel de rendez-vous

Bonjour,

Petit rappel : votre rendez-vous est pr√©vu le {{DATE_LONG}} √† {{HEURE}} √† notre agence.

Adresse : {{ADRESSE}}
{{PLAN}}

En cas d‚Äôimpr√©vu, merci de nous pr√©venir afin d‚Äôen informer nos clients.

√Ä bient√¥t,

L‚Äô√©quipe {{TAGLINE}}`,
    sms:
`Rappel RDV {{AGENCE}}: {{DATE_LONG}} √† {{HEURE}}.
Adresse: {{ADRESSE}} {{PLAN}}
Pr√©venez-nous si impr√©vu. ‚Äî {{TAGLINE}}`
  },
  report: {
    wa:
`{{AGENCE}} ‚Äì Confirmation de report

Bonjour,

Nous vous confirmons le report de votre rendez-vous initialement pr√©vu le {{OLD_DATE_LONG}} √† {{OLD_HEURE}}, d√©sormais fix√© au {{DATE_LONG}} √† {{HEURE}} concernant votre {{MODELE}}.

Adresse : {{ADRESSE}}
{{PLAN}}

En cas d‚Äôimpr√©vu, merci de nous pr√©venir afin d‚Äôen informer nos clients.

Nous restons √† votre disposition pour toute information compl√©mentaire.

L‚Äô√©quipe {{TAGLINE}}`,
    sms:
`Report RDV {{AGENCE}}:
{{OLD_DATE_LONG}} {{OLD_HEURE}} ‚ûú {{DATE_LONG}} {{HEURE}} ({{MODELE}})
Adresse: {{ADRESSE}} {{PLAN}} ‚Äî {{TAGLINE}}`
  },
  annulation: {
    wa:
`{{AGENCE}} ‚Äì Annulation de rendez-vous

Bonjour,

Nous vous confirmons l‚Äôannulation de votre rendez-vous.

Si vous souhaitez reprogrammer un cr√©neau pour votre v√©hicule, n‚Äôh√©sitez pas √† nous contacter directement depuis ce tchat.

Nous restons √† votre disposition pour toute demande.

L‚Äô√©quipe {{TAGLINE}}`,
    sms:
`Annulation RDV ‚Äî {{AGENCE}}.
Pour reprogrammer, r√©pondez √† ce message. ‚Äî {{TAGLINE}}`
  },
  no_show: {
    wa:
`{{AGENCE}} ‚Äì Suite √† votre rendez-vous

Bonjour {{CIV}} {{PRENOM}},

Nous avions rendez-vous aujourd‚Äôhui ({{DATE_TXT}}) √† {{HEURE}} pour la {{MODELE}}.
Vous ne vous √™tes pas pr√©sent√©(e).

Souhaitez-vous reporter ? Merci de nous le dire rapidement,
car un autre client attend un retour concernant la visite du v√©hicule.

L‚Äô√©quipe {{TAGLINE}}`,
    sms:
`{{AGENCE}} ‚Äî Vous ne vous √™tes pas pr√©sent√©(e) ({{DATE_TXT}} {{HEURE}}) pour {{MODELE}}.
Souhaitez-vous reporter ? ‚Äî {{TAGLINE}}`
  }
};

/* Compat ascendante: accepte l'ancien format (simple string) et le nouveau ({wa,sms}) */
function normalizeTplShape(tpls){
  const types = ['confirmation','rappel','report','annulation','no_show'];
  const out = {};
  for (const t of types){
    const v = tpls?.[t];
    if (!v) continue;
    if (typeof v === 'string'){
      out[t] = { wa: v, sms: v };
    } else if (typeof v === 'object'){
      out[t] = {
        wa: v.wa || v.whatsapp || v.default || '',
        sms: v.sms || v.default || v.wa || v.whatsapp || ''
      };
    }
  }
  return out;
}

function fillTokens(tpl, ctx){
  return (tpl||'').replace(/\{\{([A-Z0-9_]+)\}\}/g,(_,k)=>(ctx[k] ?? ''));
}

function buildCtx(agencyKey, dateTxt, timeTxt, model, oldD=null, oldT=null, extra=null){
  const ag = getAgencyByKey(agencyKey) || {};
  return {
    AGENCE: ag.name || agencyKey,
    ADRESSE: ag.addr || '',
    PLAN: ag.map ? `Plan d‚Äôacc√®s : ${ag.map}` : '',
    TAGLINE: ag.tagline || (ag.name || agencyKey),
    DATE_LONG: dateLongueFR(dateTxt||''),
    DATE_TXT: dateTxt || '',
    HEURE: timeFR(timeTxt||''),
    MODELE: model || '',
    OLD_DATE_LONG: dateLongueFR(oldD||''),
    OLD_HEURE: timeFR(oldT||''),
    CIV: extra?.CIV || '',
    PRENOM: extra?.PRENOM || ''
  };
}

/* Ajout du param√®tre channel ('wa' par d√©faut) + fallback intelligent */
function msgFromTpl(type, agency, dateTxt, timeTxt, model, oldD=null, oldT=null, extra=null, channel='wa'){
  const agencyTplsRaw = getAgencyTemplates(agency);
  const agencyTpls = normalizeTplShape(agencyTplsRaw || {});
  const def = TPL_DEFAULTS || {};
  const tpl =
    agencyTpls?.[type]?.[channel] ||
    def?.[type]?.[channel] ||
    ''; // dernier recours

  return fillTokens(tpl, buildCtx(agency, dateTxt, timeTxt, model, oldD, oldT, extra));
}
// === Prix agence & KPI CA du jour ===
function getAgencyPrice(key){
  const ag = getAgencyByKey(key);
  const p  = ag?.priceHonorTTC;
  return (typeof p === 'number' && !isNaN(p)) ? p : 0;
}

function computeRevenueToday(){
  const tISO = todayISO();
  const total = (ALL_R||[]).reduce((acc, r)=>{
    if (r.deleted) return acc;
    if (r.dateISO === tISO && r.status === 'honored' && r.honorBilling === 'factur√©'){
      return acc + getAgencyPrice(r.agency);
    }
    return acc;
  }, 0);
  const el = document.getElementById('k_revenue');
  if (el) el.textContent = `${Math.round(total).toLocaleString('fr-FR')}‚Ç¨`;
  return total;
}

// regroupe les KPI appel√©s par tes timers 1s
function refreshKpis(){
  try{ computeUpcoming(); }catch(e){}
  try{ computeDueToday(); }catch(e){}
  try{ computeTodo(); }catch(e){}
  try{ computeRevenueToday(); }catch(e){}
}
/* ---------- Login / r√¥les ---------- */
const ADMIN_PIN="972";
let ROLE={role:null,name:null};
async function tryPasskey(getOnly=false){
  if(!window.PublicKeyCredential) throw new Error('Passkey non support√©');
  const challenge=Uint8Array.from(crypto.getRandomValues(new Uint8Array(32)));
  if(getOnly){
    const enc=b=>Uint8Array.from(atob(b),c=>c.charCodeAt(0));
    const allowId=localStorage.getItem('cn_passkey_id');
    const allow=allowId?[{type:'public-key',id:enc(allowId)}]:[];
    return await navigator.credentials.get({publicKey:{challenge,allowCredentials:allow,timeout:60000,userVerification:'required'}});
  }else{
    const userId=crypto.getRandomValues(new Uint8Array(16));
    const cred=await navigator.credentials.create({publicKey:{
      challenge, rp:{name:'C&N Solutions'}, user:{id:userId,name:'admin@cn',displayName:'Admin C&N'},
      pubKeyCredParams:[{type:'public-key',alg:-7},{type:'public-key',alg:-257}],
      authenticatorSelection:{userVerification:'required',residentKey:'preferred'}, timeout:60000
    }});
    const idB64=btoa(String.fromCharCode(...new Uint8Array(cred.rawId)));
    localStorage.setItem('cn_passkey_id',idB64);
    return cred;
  }
}
$('#btnEnroll').onclick=async()=>{ try{ await tryPasskey(false); notify('T√©l√©phone enregistr√© (Face/Touch ID)','ok'); }catch{ notify('√âchec enregistrement passkey','warn'); } };
$('#btnLoginAdminPasskey').onclick=async()=>{ try{ await tryPasskey(true); ROLE={role:'admin',name:'Admin'}; enter(); }catch{ alert('√âchec Face/Touch ID. Utilise le PIN.'); } };
$('#btnLoginAdminPin').onclick=()=>{ const pin=prompt("Code administrateur :"); if(pin===ADMIN_PIN){ ROLE={role:'admin',name:'Admin'}; enter(); } else if(pin){ alert("Code incorrect."); } };

$('#btnLoginTeam').onclick=async()=>{ 
  const n=$('#eqName').value.trim(); 
  const p=($('#eqPass').value||'').trim();
  if(!n) return alert("Merci d‚Äôindiquer votre pr√©nom.");
  if(!p) return alert("Merci d‚Äôindiquer le mot de passe √©quipe.");
  await loadTeamPass();
  if(p!==TEAM_PASS) return alert("Mot de passe incorrect.");
  ROLE={role:'team',name:n}; 
  enter(); 
};

$('#btnLogout').onclick=()=>{ ROLE={role:null,name:null}; location.reload(); };

async function enter(){
  $('#login').classList.add('hide'); $('#app').classList.remove('hide');
  const m=new Date(); $('#monthTitle').textContent=`${m.toLocaleDateString('fr-FR',{month:'long',year:'numeric'})}`;
  if(ROLE.role==='admin'){ $$('.admin-only').forEach(x=>x.classList.remove('hide')); }
  else { $$('.admin-only').forEach(x=>x.classList.add('hide')); }
  populateAgencyFilter();
  populateWizardAgencies();
  bindTabs();
  bindStatusChips();
  await loadAllData();
}
$('#btnTeamPass').onclick=()=>{ if(ROLE.role!=='admin') return alert('R√©serv√© √† l‚Äôadmin.'); openTeamPassDialog(); };

/* ---------- Wizard ---------- */
let STEP=1; const stepsCount=8;
function showStep(k){
  document.querySelectorAll('.wiz .step').forEach(s=>s.classList.remove('active'));
  const target = document.querySelector(`.wiz .step[data-step="${k}"]`);
  if (target){
    target.classList.add('active'); STEP = k;
    try { if(k===3) maybeSuggestPaste?.(); } catch(_) {}
    try { if(k===4) buildQuickDates?.();   } catch(_) {}
    try { if(k===5) buildQuickTimes?.();   } catch(_) {}
  }else{
    const first = document.querySelector('.wiz .step[data-step="1"]');
    if(first){ first.classList.add('active'); STEP = 1; }
  }
}
(function ensureWizardVisible(){
  const hasActive = !!document.querySelector('.wiz .step.active');
  if(!hasActive){
    const first = document.querySelector('.wiz .step[data-step="1"]');
    if(first){ first.classList.add('active'); STEP = 1; }
  }
})();
function next(){ if(STEP<stepsCount) showStep(STEP+1); }
function prev(){ if(STEP>1) showStep(STEP-1); }
$('#n1').onclick=()=>{ if(!$('#w_agency').value){$('#e1').style.display='block';return;} $('#e1').style.display='none'; next(); };
$('#n2').onclick=()=>{ if(!$('#w_civ').value || !$('#w_name').value.trim()){ $('#e2').style.display='block'; return;} $('#e2').style.display='none'; next(); };

/* === T√©l√©phone === */
const phoneInput = $('#w_phone');
function setPhoneValueFrom10(n10){ phoneInput.value = formatFR10(n10); $('#e3').style.display='none'; }

phoneInput.addEventListener('input', (e) => {
  const n = normalizeFR10(e.target.value);
  if(n){
    setPhoneValueFrom10(n);
    if(n.length===10) setTimeout(()=>$('#n3').click(), 80);
  } else {
    const raw = (e.target.value||'').replace(/\D/g,'').slice(0,14);
    e.target.value = formatFR10(raw);
  }
});

/* Si l'utilisateur colle manuellement (Ctrl/Cmd+V), on formate apr√®s le paste */
phoneInput.addEventListener('paste', () => {
  setTimeout(()=>{ const n = normalizeFR10(phoneInput.value); if(n) setPhoneValueFrom10(n); }, 0);
});

/* Suite wizard */
$('#n3').onclick=()=>{ const p10=normalizeFR10($('#w_phone').value); if(!p10){ $('#e3').style.display='block'; return;} $('#e3').style.display='none'; next(); };
$('#n4').onclick=()=>{ const v=$('#w_date').value; if(!/^\d{2}\/\d{2}\/\d{2}$/.test(v)){ $('#e4').style.display='block'; return;} $('#e4').style.display='none'; next(); };
$('#n5').onclick=()=>{ const v=$('#w_time').value; if(!/^\d{2}:\d{2}$/.test(v)){ $('#e5').style.display='block'; return;} $('#e5').style.display='none'; next(); };
$('#n6').onclick=()=>{ if(!$('#w_model').value.trim()){ $('#e6').style.display='block'; return;} $('#e6').style.display='none'; next(); };
$('#n7').onclick=()=>{ if(!$('#w_source').value.trim()){ $('#e7').style.display='block'; return;} $('#e7').style.display='none'; buildRecap(); next(); };
$('#p2').onclick=prev; $('#p3').onclick=prev; $('#p4').onclick=prev; $('#p5').onclick=prev; $('#p6').onclick=prev; $('#p7').onclick=prev; $('#p8').onclick=prev;

/* Auto-format date/heure */
$('#w_date').addEventListener('input',e=>{ let v=e.target.value.replace(/[^0-9]/g,'').slice(0,6);
  if(v.length>=2 && v.length<=4) e.target.value=v.slice(0,2)+"/"+v.slice(2);
  else if(v.length>4) e.target.value=v.slice(0,2)+"/"+v.slice(2,4)+"/"+v.slice(4);
  else e.target.value=v;
  if(v.length===6) setTimeout(()=>$('#n4').click(),80);
});
$('#w_time').addEventListener('input',e=>{ let v=e.target.value.replace(/[^0-9]/g,'').slice(0,4); e.target.value=(v.length>=2)? v.slice(0,2)+":"+v.slice(2) : v; if(e.target.value.length===5) setTimeout(()=>$('#n5').click(),80); });

/* DATES RAPIDES / HEURES RAPIDES */
function dateToJJMMA(d){ return iso_to_jjmma(isoOf(d)); }
function startOfWeekMonday(d){ const x=new Date(d); const day=x.getDay(); const diff=(day+6)%7; x.setDate(x.getDate()-diff); return new Date(x.getFullYear(), x.getMonth(), x.getDate()); }
function buildQuickDates(){
  const cont = document.querySelector('#quickDateRow'); if(!cont) return; cont.innerHTML = '';
  const used = new Set();
  const addBtn = (label, dateObj)=>{
    const iso = isoOf(dateObj); if(used.has(iso)) return; used.add(iso);
    const b = document.createElement('button'); b.className = 'chip chip--mini'; b.textContent = label;
    b.onclick = ()=>{ document.querySelector('#w_date').value = dateToJJMMA(dateObj); const e4=$('#e4'); if(e4) e4.style.display='none'; setTimeout(()=>$('#n4')?.click(),80); };
    cont.appendChild(b);
  };
  const now=new Date();
  addBtn('Aujourd‚Äôhui', now);
  addBtn('Demain', addDays(now, 1));
  const monday = startOfWeekMonday(now);
  const jours=['Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi','Dimanche'];
  const todayIndex=(now.getDay()+6)%7;
  for(let i=todayIndex+1;i<7;i++){ addBtn(`Ce ${jours[i]}`, addDays(monday, i)); }
  const nextMonday = addDays(monday, 7);
  for(let i=0;i<7;i++){ addBtn(`${jours[i]} prochain`, addDays(nextMonday, i)); }
}
function buildQuickTimes(){
  const cont = document.querySelector('#quickTimeRow'); if(!cont) return; cont.innerHTML = '';
  const slots=[]; 
  for(let h=9; h<=18; h++){
    for(const m of ['00','30']){
      // J'ai enlev√© l'exclusion de 12:00 (midi) ‚Äî on n'exclut maintenant que 13:00 si tu veux le garder exclu
      if((h===13 && m==='00')) continue;
      slots.push(`${String(h).padStart(2,'0')}:${m}`);
    }
  }
  let list = slots.slice();
  try{
    const dTxt = $('#w_date')?.value || ''; const iso = jjmma_to_iso(dTxt);
    if(iso && iso===todayISO()){
      const now=new Date(); const nowM=now.getHours()*60+now.getMinutes()+30;
      list = list.filter(t=>{ const [H,M]=t.split(':').map(Number); return (H*60+M)>=nowM; });
      if(list.length===0) list = slots.slice();
    }
  }catch(_){}
  list.forEach(t=>{
    const b=document.createElement('button'); b.className='chip'; b.textContent=t;
    b.onclick=()=>{ $('#w_time').value=t; const e5=$('#e5'); if(e5) e5.style.display='none'; setTimeout(()=>$('#n5')?.click(),80); };
    cont.appendChild(b);
  });
}

/* R√©cap */
function buildRecap(){
  const chips=[
    {k:'Agence',v:$('#w_agency').value,step:1},
    {k:'Civilit√©',v:$('#w_civ').value||'‚Äî',step:2},
    {k:'Pr√©nom',v:$('#w_name').value.trim(),step:2},
    {k:'T√©l√©phone',v:toFR($('#w_phone').value),step:3},
    {k:'Date',v:$('#w_date').value,step:4},
    {k:'Heure',v:$('#w_time').value,step:5},
    {k:'Mod√®le',v:$('#w_model').value.trim(),step:6},
    {k:'Source',v:$('#w_source').value.trim(),step:7},
  ];
  const box=$('#recap'); box.innerHTML=''; chips.forEach(c=>{ const b=document.createElement('button'); b.className='chip'; b.textContent=`${c.k}: ${c.v||'‚Äî'}`; b.onclick=()=>showStep(c.step); box.appendChild(b); });
}
/* Envoi / Enregistrement */
$('#btnWA').onclick = ()=>submitRDV('wa');
$('#btnSMS').onclick = ()=>submitRDV('sms');

function openChannelAndLog(phone, text, channel, preWin=null){
  try{
    if(channel==='wa'){
      const url = `https://wa.me/${phone}?text=${encodeURIComponent(text)}`;
      if(preWin && !preWin.closed){ preWin.location.href=url; preWin.focus(); } else { const win=window.open(url,'_blank'); if(!win) throw new Error('popup'); }
    }else{
      const n=phoneSMS(phone); const isIOS=/iPhone|iPad|iPod/i.test(navigator.userAgent); const sep=isIOS?'&':'?';
      window.location.href=`sms:${n}${sep}body=${encodeURIComponent(text)}`;
      navigator.clipboard?.writeText(text).catch(()=>{});
      notify('Message pr√™t (copi√©). Ouvre l‚Äôapp SMS si besoin.','ok');
    }
  }catch{
    navigator.clipboard?.writeText(text).catch(()=>{});
    notify('Message copi√©. Ouvre l‚Äôapp WhatsApp/SMS.','ok');
  }
}

async function submitRDV(channel){
  const preWin = (channel==='wa') ? window.open('', '_blank') : null;

  const a=$('#w_agency').value, civ=$('#w_civ').value, name=$('#w_name').value.trim(),
        dateTxt=$('#w_date').value, timeTxt=$('#w_time').value, model=$('#w_model').value.trim(),
        source=$('#w_source').value.trim();
  const phone10 = normalizeFR10($('#w_phone').value);

  if(!a || !civ || !name || !phone10 || !/^\d{2}\/\d{2}\/\d{2}$/.test(dateTxt) || !/^\d{2}:\d{2}$/.test(timeTxt) || !model || !source){
    if(preWin && !preWin.closed) preWin.close();
    $('#sendErr').textContent='Champs invalides.'; $('#sendErr').style.display='block'; return;
  }
  $('#sendErr').style.display='none';

  const payload={ agency:a,civ,name,phone:"33"+phone10.slice(1),dateText:dateTxt,timeText:timeTxt,dateISO:jjmma_to_iso(dateTxt),
    model,source,channel,createdAt:firebase.firestore.FieldValue.serverTimestamp(),
    createdByName:ROLE.name,createdByRole:ROLE.role,deleted:false,status:null,statusAt:null,
    reminderSent:false,reminderAt:null, noteText:null, noteDueISO:null, noteUpdatedAt:null,
    gesteCommercial:false, gesteAmount:null, honorBilling:null, firstMsgChannel: channel, firstMsgAt: firebase.firestore.FieldValue.serverTimestamp()
  };

  try{
    const ref=await db.collection('rdv').add(payload);
    await db.collection('messages').add({rdvId:ref.id,phone:payload.phone,agency:payload.agency,channel, type:'confirmation', sentAt:firebase.firestore.FieldValue.serverTimestamp()});
    const idStat=`${new Date().getFullYear()}-${pad(new Date().getMonth()+1)}`;
    await db.collection('stats').doc(idStat).set({created:firebase.firestore.FieldValue.increment(1)},{merge:true});
const text = msgFromTpl('confirmation', payload.agency, dateTxt, timeTxt, model, null, null, null, channel);    openChannelAndLog(payload.phone, text, channel, preWin);
    showStep(1); ['w_civ','w_name','w_phone','w_date','w_time','w_model','w_source'].forEach(id=>$('#'+id).value=''); loadAll();
  }catch(e){ 
    console.error(e); 
    if(preWin && !preWin.closed) preWin.close();
    $('#sendErr').textContent='Erreur d‚Äôenregistrement ou d‚Äôenvoi.'; $('#sendErr').style.display='block'; 
  }
}

/* ---------- Dashboard + Liste + Pagination + Filtres ---------- */
function countPendingRequests(){ return ALL_R.filter(r=>r.deleted===true && !!r.deleteRequest).length; }
function updatePendingButton(){ const btn=$('#btnPendingReq'), cnt=$('#pendingCount'); if(!btn||!cnt) return; const n=countPendingRequests(); btn.classList.toggle('blink',n>0); cnt.textContent=String(n); btn.classList.remove('hide'); }
function populateAgencyFilter(){
  const sel=$('#filterAgency'); if(!sel) return;
  const keys=mergedAgencyKeys();
  sel.innerHTML='<option value="*">Toutes les agences</option>'+keys.map(k=>`<option value="${k}">${k}</option>`).join('');
  sel.value='*';
}
function populateWizardAgencies(){
  const sel=$('#w_agency'); if(!sel) return;
  const current=sel.value; const keys=mergedAgencyKeys();
  sel.innerHTML='<option value="">S√©lectionnez une agence</option>'+keys.map(k=>`<option>${k}</option>`).join('');
  if(current && keys.includes(current)) sel.value=current;
}
$('#filterAgency')?.addEventListener('change',()=>{ FILTER_AGENCY=$('#filterAgency').value||'*'; PAGE=1; renderList(); });
$('#filterPlacedOn')?.addEventListener('change',()=>{ PLACED_ON=$('#filterPlacedOn').value||null; PAGE=1; renderList(); });
$('#clearPlaced')?.addEventListener('click',()=>{ PLACED_ON=null; $('#filterPlacedOn').value=''; PAGE=1; renderList(); });

/* ====== RECHERCHE ====== */
function normTxt(s){ return (s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]/g,''); }
function lev(a,b){
  if(a===b) return 0; const al=a.length, bl=b.length; if(al===0||bl===0) return Math.max(al,bl);
  const dp=new Array(bl+1); for(let j=0;j<=bl;j++) dp[j]=j;
  for(let i=1;i<=al;i++){ let prev=dp[0]; dp[0]=i;
    for(let j=1;j<=bl;j++){ const temp=dp[j]; dp[j]= (a[i-1]===b[j-1])? prev : 1+Math.min(prev, dp[j], dp[j-1]); prev=temp; } }
  return dp[bl];
}
function scoreRow(r,qRaw){
  const qDigits=(qRaw||'').replace(/\D/g,''); const q=normTxt(qRaw); if(!q && !qDigits) return 0;
  const name=normTxt(((r.civ||'')+' '+(r.name||'')).trim()); const model=normTxt(r.model||''); const phone=(r.phone||'').replace(/\D/g,''); const frPhone=phone.replace(/^33/,'0');
  let score=0;
  if(qDigits){
    if(frPhone.endsWith(qDigits) || phone.endsWith(qDigits)) score=Math.max(score,100+Math.min(qDigits.length,10));
    else if(frPhone.includes(qDigits) || phone.includes(qDigits)) score=Math.max(score,85+Math.min(qDigits.length,10));
  }
  if(q.length>=2){
    if(name.startsWith(q)) score=Math.max(score,70); else if(name.includes(q)) score=Math.max(score,65);
    else{ const d=lev(name,q); if(d<=1) score=Math.max(score,62); else if(q.length>=4 && d<=2) score=Math.max(score,58); }
    if(model.startsWith(q)) score=Math.max(score,60); else if(model.includes(q)) score=Math.max(score,55);
    else{ const dm=lev(model,q); if(dm<=1) score=Math.max(score,52); else if(q.length>=4 && dm<=2) score=Math.max(score,48); }
  }
  return score;
}
function rowMatchesQuery(r,q){ return scoreRow(r,q)>0; }

$('#search').addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ const q=$('#search').value||''; openBestMatch(q); }});
function openBestMatch(q){
  const candidates = ALL_R.filter(r=>!r.deleted);
  let best=null, bestScore=-1;
  for(const r of candidates){
    const s=scoreRow(r,q);
    if(s>bestScore){ bestScore=s; best=r; }
    else if(s===bestScore && best){
      const keyA=((r.dateISO||'')+(r.timeText||'')); const keyB=((best.dateISO||'')+(best.timeText||'')); if(keyA>keyB) best=r;
    }
  }
  if(!best || bestScore<=0){ notify('Aucun r√©sultat','warn'); return; }
  openRDVSheet(best);
}

/* üîç Fen√™tre de recherche */
$('#btnOpenSearch').onclick = ()=>{
 const dlg=document.createElement('dialog'); window._searchDlg = dlg;
 dlg.style.padding='0'; dlg.style.maxWidth='880px'; dlg.style.width='min(92vw,880px)';
 dlg.innerHTML=`
    <div style="padding:12px 14px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between">
      <div style="font-weight:800">Recherche</div>
      <button class="btn btn-neutral btn-xs" id="btnCloseSearch">Fermer</button>
    </div>
    <div style="padding:14px">
      <input id="searchDlgInput" class="input" placeholder="Nom, mod√®le, t√©l√©phone (Entr√©e = ouvrir la meilleure fiche)">
      <div class="small mt8">Tapez pour voir les r√©sultats ici. Entr√©e ouvre directement la fiche la plus pertinente.</div>
      <div id="searchDlgList" style="margin-top:12px;display:grid;gap:10px;max-height:min(60vh,560px);overflow:auto"></div>
    </div>`;
 document.body.appendChild(dlg); dlg.showModal?.() ?? dlg.setAttribute('open','');
 const inp=$('#searchDlgInput',dlg); const list=$('#searchDlgList',dlg);
 inp.value = $('#search').value || ''; setTimeout(()=>{ inp.focus(); inp.select(); renderSearchList(inp.value); }, 0);
 $('#btnCloseSearch',dlg).onclick = ()=>{ $('#search').value = ''; $('#search').dispatchEvent(new Event('input',{bubbles:true})); dlg.close?.(); dlg.remove(); renderList(); };
 inp.addEventListener('input',()=>{ $('#search').value = inp.value || ''; $('#search').dispatchEvent(new Event('input',{bubbles:true})); renderSearchList(inp.value); });
 inp.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ const q=inp.value||''; dlg.close?.(); dlg.remove(); openBestMatch(q); }});
 function renderSearchList(qRaw){
   list.innerHTML=''; const q=(qRaw||'').trim(); if(!q){ list.innerHTML='<div class="small">Commencez √† taper‚Ä¶</div>'; return; }
   let arr=ALL_R.filter(r=>!r.deleted); if(FILTER_AGENCY!=='*') arr=arr.filter(r=>(r.agency||'')===FILTER_AGENCY);
   const scored=arr.map(r=>({r,s:scoreRow(r,q)})).filter(x=>x.s>0).sort((a,b)=> b.s-a.s || ((((b.r.dateISO||'')+(b.r.timeText||''))).localeCompare((a.r.dateISO||'')+(a.r.timeText||''))));
   const top=scored.slice(0,30);
   if(top.length===0){ list.innerHTML='<div class="small">Aucun r√©sultat</div>'; return; }
   top.forEach(({r})=>{
     const row=document.createElement('div'); row.className='rdv'; row.style.cursor='pointer';
     const civName=`${(r.civ||'').trim()} ${(r.name||'').trim()}`.trim();
     const agBadge=r.agency?`<span class="badge">${escapeHtml(r.agency)}</span>`:'';
     const statusTxt=r.status==='honored' ? ('Honor√©' + (r.honorBilling==='factur√©'?' ‚Ä¢ Factur√©': (r.honorBilling==='non_facturable'?' ‚Ä¢ Non facturable':''))) :
                     r.status==='no_show' ? 'Non honor√©' : r.status==='cancelled' ? 'Annul√©' : 'Pr√©vu';
     row.innerHTML=`
        <div>
          <div class="title">${fmtNice(r.dateISO,r.timeText)} ‚Äî ${escapeHtml(civName)}</div>
          <div class="meta">${toFR(r.phone)} ‚Ä¢ ${escapeHtml(r.model||'')}</div>
          <div class="mt8" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            ${agBadge} ${iconForChannel(r)} <span class="bubble gray">${statusTxt}</span>
            ${r.reminderSent?`<span class="bubble green">Rappel envoy√© ‚Ä¢ ${fmtDT(r.reminderAt)} ‚Ä¢ ${(r.reminderChannel||'').toUpperCase()}</span>`:''}
            ${r.gesteCommercial?`<span class="bubble blue">üéÅ Geste ${typeof r.gesteAmount==='number'&&!isNaN(r.gesteAmount)? (r.gesteAmount.toFixed(0)+'‚Ç¨') : ''}</span>`:''}
          </div>
          <div class="mt12">${progressMiniHTML(r)}</div>
        </div>
        <div class="rdv-actions"><button class="btn btn-neutral btn-xs">Ouvrir la fiche</button></div>`;
     row.addEventListener('click',()=>{ dlg.close?.(); dlg.remove(); openRDVSheet(r); });
     list.appendChild(row);
   });
 }
};

/* Pagination */
$('#prevPage').onclick = () => { const pager=$('.pager'); const before=pager?pager.getBoundingClientRect().top:0; const max=parseInt($('#pageMax').textContent,10)||1;
  if(PAGE>1){ PAGE--; renderList(); const after=pager?pager.getBoundingClientRect().top:0; window.scrollBy(0, after-before); } };
$('#nextPage').onclick = () => { const pager=$('.pager'); const before=pager?pager.getBoundingClientRect().top:0; const max=parseInt($('#pageMax').textContent,10)||1;
  if(PAGE<max){ PAGE++; renderList(); const after=pager?pager.getBoundingClientRect().top:0; window.scrollBy(0, after-before); } };

$('#btnSelAll').onclick=()=>{ document.querySelectorAll('.selbox').forEach(cb=>{cb.checked=true; SELECTED.add(cb.dataset.id)}); };
$('#btnDeselAll').onclick=()=>{ SELECTED.clear(); document.querySelectorAll('.selbox').forEach(cb=>cb.checked=false); };
$('#btnBulkRestore').onclick=async()=>{ if(SELECTED.size===0) return;
  for (const id of SELECTED){ await db.collection('rdv').doc(id).set({deleted:false,deletedAt:firebase.firestore.FieldValue.delete(),deleteRequest:firebase.firestore.FieldValue.delete()},{merge:true}); }
  SELECTED.clear(); loadAll();
};
$('#btnBulkDelete').onclick=async()=>{ if(VIEW!=='trash') return; if(SELECTED.size===0) return;
  if(!confirm('Supprimer d√©finitivement la s√©lection ?')) return;
  for (const id of SELECTED){ await db.collection('rdv').doc(id).delete(); }
  SELECTED.clear(); loadAll();
};
$('#btnPendingReq').onclick=()=>{ VIEW='trash'; SHOW_ONLY_REQ=true; $$('.tab').forEach(x=>x.classList.remove('active')); $(`.tab[data-view="trash"]`).classList.add('active'); PAGE=1; renderList(); notify(`${countPendingRequests()} demande(s) de suppression √† traiter`,'ok'); };

/* ---------- Chargements group√©s ---------- */
async function loadAllData(){ try{ await loadAgenciesDB(); populateAgencyFilter(); populateWizardAgencies(); }catch(e){ }
  await loadAll();
}

/* ---------- RDV : lecture + KPI ---------- */
async function loadAll(){
  try{
    const sid=`${new Date().getFullYear()}-${pad(new Date().getMonth()+1)}`;
    const s=await db.collection('stats').doc(sid).get(); const d=s.exists?s.data():{};
    const a=id=>document.getElementById(id); if(a('k_created')) a('k_created').textContent=d.created??0;
    if(a('k_reminders')) a('k_reminders').textContent=d.reminders??0;
    if(a('k_honored')) a('k_honored').textContent=d.honored??0;
  }catch(e){}
  try{
    const snap=await db.collection('rdv').get();
    ALL_R=snap.docs.map(d=>({id:d.id,...d.data()}));
  }catch(e){ ALL_R=[]; notify('Erreur de lecture Firestore','warn'); }
  const now=new Date(); const curYM=`${now.getFullYear()}-${pad(now.getMonth()+1)}`;
  const noshow=ALL_R.filter(r=>!r.deleted && r.status==='no_show' && (r.dateISO||'').startsWith(curYM)).length;
  $('#k_noshow').textContent=noshow;

  computeUpcoming(); computeDueToday(); computeTodo();
  computeRevenueToday();
  updateReminderButton(); 
  updatePendingButton();
  updateTabCounts();
  updateStatusChips();
  renderList();
}
/* ====== Rappels du jour ‚Äî helpers & panel ====== */
// Liste des RDV √† rappeler aujourd‚Äôhui (m√™me logique que computeDueToday)
function dueRemindersToday(){
  const now = new Date();
  const tISO = todayISO();
  const nowM = now.getHours()*60 + now.getMinutes();
  return (ALL_R||[])
    .filter(r=>{
      if(r.deleted || r.reminderSent || r.dateISO!==tISO) return false;
      // on ne rappelle pas ceux cr√©√©s aujourd‚Äôhui
      const created = r.createdAt?.toDate ? r.createdAt.toDate() : null;
      const createdISO = created ? isoOf(created) : null;
      if(createdISO===tISO) return false;
      // on rappelle seulement si l‚Äôheure est encore √† venir
      const m=(r.timeText||'').match(/(\d{2}):(\d{2})/); if(!m) return false;
      const minutes=+m[1]*60 + +m[2];
      return minutes>nowM;
    })
    .sort((a,b)=> (a.timeText||'').localeCompare(b.timeText||''));
}

// Met √† jour la pastille du bouton "Rappels"
function updateReminderButton(){
  const el = document.getElementById('remCount');
  const btn = document.getElementById('btnReminders');
  if(!el || !btn) return;
  const n = dueRemindersToday().length;
  el.textContent = String(n);
  btn.classList.toggle('blink', n>0);
}

// Ouvre un panel listant les rappels √† faire aujourd‚Äôhui (plein √©cran-ish + live refresh)
function openRemindersPanel(){
  const dlg = document.createElement('dialog');
  dlg.style.maxWidth = '980px';
  dlg.style.width = 'min(98vw,980px)';
  dlg.style.padding = '0';
  dlg.style.border = 'none';
  dlg.style.borderRadius = '12px';
  dlg.style.overflow = 'hidden';
  dlg.innerHTML = `
    <div style="padding:12px 14px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;background:var(--cardBg, #fff);position:sticky;top:0;z-index:2">
      <div style="font-weight:800">Rappels √† faire ‚Äî Aujourd'hui</div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-neutral btn-xs" id="rem_close">Fermer</button>
      </div>
    </div>
    <div style="padding:14px">
      <div class="small" id="rem_header"></div>
      <div id="rem_list" style="margin-top:12px;display:grid;gap:10px;max-height:min(70vh,680px);overflow:auto"></div>
    </div>`;

  // ID pour le rafra√Æchissement global (le script 1s la rep√®re via #remindersDlg)
  dlg.id = 'remindersDlg';

  document.body.appendChild(dlg);
  (dlg.showModal?.bind(dlg) ?? dlg.setAttribute.bind(dlg,'open',''))();

  const list = dlg.querySelector('#rem_list');
  const header = dlg.querySelector('#rem_header');
  dlg.querySelector('#rem_close').onclick = ()=>{ dlg.close?.(); dlg.remove(); };

  function renderList(){
    const items = (typeof dueRemindersToday === 'function') ? dueRemindersToday() : [];
    list.innerHTML = '';

    if(header) header.innerHTML = items.length
      ? `√Ä rappeler : <b id="rem_total">${items.length}</b>`
      : `Aucun rappel √† faire pour aujourd‚Äôhui.`;

    if(items.length===0){
      list.innerHTML = '<div class="small">Tout est √† jour ‚úîÔ∏è</div>';
      try { typeof updateReminderButton === 'function' && updateReminderButton(); } catch(e){}
      return;
    }

    for (const r of items){
      const row = document.createElement('div');
      row.className = 'rdv';
      const civName = `${(r.civ||'').trim()} ${(r.name||'').trim()}`.trim();
      const safe = (v)=> (typeof escapeHtml==='function' ? escapeHtml(v) : v);

      row.innerHTML = `
        <div style="min-width:0">
          <div class="title">${(typeof fmtNice==='function' ? fmtNice(r.dateISO,r.timeText) : `${r.dateISO} ${r.timeText||''}`)} ‚Äî ${safe(civName)}</div>
          <div class="meta">${(typeof toFR==='function'? toFR(r.phone) : (r.phone||''))} ‚Ä¢ ${safe(r.model||'')}</div>
          <div class="mt8" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            ${r.agency?`<span class="badge">${safe(r.agency)}</span>`:''}
            ${typeof iconForChannel==='function'? iconForChannel(r) : ''}
            <span class="bubble gray">Pr√©vu ${(typeof relativeWhen==='function'? relativeWhen(r.dateISO, r.timeText) : '')}</span>
          </div>
        </div>
        <div class="rdv-actions">
          <button class="btn btn-primary btn-xs" data-rem="1">Rappel</button>
        </div>`;

      // Action "Rappel" (envoie le message puis rafra√Æchit la liste)
      const remBtn = row.querySelector('[data-rem]');
      remBtn?.addEventListener('click', async ()=>{
        if (!remBtn) return;
        const prev = remBtn.textContent;
        remBtn.disabled = true;
        remBtn.textContent = '‚Ä¶';
        try {
          if (typeof sendReminder === 'function') {
            await sendReminder(r);
          }
        } catch(e) {
          console.error(e);
        } finally {
          remBtn.disabled = false;
          remBtn.textContent = prev;
          // Re-rendu + pastille
          renderList();
          try { typeof updateReminderButton === 'function' && updateReminderButton(); } catch(e){}
        }
      });

      list.appendChild(row);
    }
  }

  // Hook utilis√© par le rafra√Æchissement global (tick 1s)
  dlg.__rerender = renderList;

  renderList();
}
/* === Compteurs / filtres === */
function countUpcoming(){
  const now=new Date(); const tISO=todayISO(); const nowM=now.getHours()*60+now.getMinutes();
  let arr=ALL_R.filter(r=>!r.deleted && !r.status);
  if(FILTER_AGENCY!=='*') arr = arr.filter(r=>(r.agency||'')===FILTER_AGENCY);
  return arr.filter(r=>{
    if((r.dateISO||'')>tISO) return true;
    if((r.dateISO||'')<tISO) return false;
    const m=(r.timeText||'').match(/(\d{2}):(\d{2})/); if(!m) return false;
    const minutes=+m[1]*60+ +m[2];
    return minutes>=nowM;
  }).length;
}
function updateTabCounts(){
  const tISO=todayISO(), tomoISO=isoOf(addDays(new Date(),1));
  const byFilter = r => { if(r.deleted) return false; if(FILTER_AGENCY!=='*' && (r.agency||'')!==FILTER_AGENCY) return false; return true; };
  const todayCnt = ALL_R.filter(r=>byFilter(r) && !r.status && r.dateISO===tISO).length;
  const tomoCnt  = ALL_R.filter(r=>byFilter(r) && !r.status && r.dateISO===tomoISO).length;
  const upcoming = countUpcoming();
  const trash    = ALL_R.filter(r=>r.deleted===true).length;
  const todo     = computeTodo();
  const set=(id,val)=>{ const el=document.getElementById(id); if(el) el.textContent=String(val); };
  set('count_today', todayCnt); set('count_tomorrow', tomoCnt); set('count_upcoming', upcoming); set('count_trash', trash);
  const todoEl=document.getElementById('todoCount'); if(todoEl) todoEl.textContent=String(todo);
}
function computeUpcoming(){ const n=countUpcoming(); $('#k_upcoming').textContent=n; return n; }
function computeDueToday(){
  const now=new Date(); const tISO=todayISO(); const nowM=now.getHours()*60+now.getMinutes();
  const due=ALL_R.filter(r=>{
    if(r.deleted||r.reminderSent||r.dateISO!==tISO) return false;
    const created=r.createdAt?.toDate? r.createdAt.toDate() : null; const createdISO= created ? isoOf(created) : null;
    if(createdISO===tISO) return false;
    const m=(r.timeText||'').match(/(\d{2}):(\d{2})/); if(!m) return false; const minutes=+m[1]*60+ +m[2];
    return minutes>nowM;
  }).length;
  $('#k_due').textContent=due; return due;
}
function computeTodo(){
  const now=new Date(); const tISO=todayISO(); const nowM=now.getHours()*60+now.getMinutes();
  let arr=ALL_R.filter(r=>{
    if(r.deleted||r.status) return false;
    const d=(r.dateISO||'');
    const m=(r.timeText||'').match(/(\d{2}):(\d{2})/);
    const mins=m?(+m[1]*60+ +m[2]):-1;
    return (d && (d<tISO) || (d===tISO && mins>=0 && mins<=nowM));
  });
  if(FILTER_AGENCY!=='*') arr = arr.filter(r=>(r.agency||'')===FILTER_AGENCY);
  const n=arr.length;
  const el=document.getElementById('todoCount'); if(el) el.textContent=String(n);
  const tab=document.querySelector('.tab[data-view="todo"]'); if(tab){ tab.classList.toggle('blink', n>0); }
  return n;
}

/* Filtrage courant */
function currFiltered(){
  const q = ($('#search').value || '').trim();
  const hasQuery = q.length > 0;
  const now = new Date(), tISO = todayISO();

  if (hasQuery) {
    let arr = ALL_R.filter(r => !r.deleted);
    if (FILTER_AGENCY !== '*') arr = arr.filter(r => (r.agency || '') === FILTER_AGENCY);
    return arr.filter(r => rowMatchesQuery(r, q));
  }
  if (PLACED_ON){
    let arr = ALL_R.slice();
    if (FILTER_AGENCY !== '*') arr = arr.filter(r => (r.agency || '') === FILTER_AGENCY);
    arr = arr.filter(r=>{
      const created=r.createdAt?.toDate? r.createdAt.toDate():null;
      return created ? isoOf(created)===PLACED_ON : false;
    });
    return arr;
  }

  let arr = ALL_R.slice();
  if (VIEW === 'trash'){
    arr = arr.filter(r => r.deleted === true);
    if (SHOW_ONLY_REQ) arr = arr.filter(r => !!r.deleteRequest);
  } else if (VIEW === 'agencies'){
    return 'agencies';
  } else if (VIEW === 'messages'){
    return 'messages';
  } else if (VIEW === 'todo'){
    const nowM=now.getHours()*60+now.getMinutes();
    arr = arr.filter(r=>{
      if (r.deleted || r.status) return false;
      const d=(r.dateISO||'');
      const m=(r.timeText||'').match(/(\d{2}):(\d{2})/);
      const mins=m?(+m[1]*60+ +m[2]):-1;
      return (d && (d<tISO) || (d===tISO && mins>=0 && mins<= nowM));
    });
  } else {
    if (FILTER_AGENCY !== '*') arr = arr.filter(r => (r.agency||'') === FILTER_AGENCY);
    arr = arr.filter(r => !r.deleted);
    if (VIEW === 'today'){
      arr = arr.filter(r => r.dateISO === tISO && !r.status);
    } else if (VIEW === 'tomorrow'){
      const iso=isoOf(addDays(new Date(),1));
      arr = arr.filter(r => r.dateISO === iso && !r.status);
    } else if (VIEW === 'upcoming'){
      const nowM=now.getHours()*60+now.getMinutes();
      arr = arr.filter(r=>{
        if (r.status) return false;
        if ((r.dateISO||'') > tISO) return true;
        if ((r.dateISO||'') < tISO) return false;
        const m=(r.timeText||'').match(/(\d{2}):(\d{2})/); if(!m) return false;
        const minutes=+m[1]*60+ +m[2];
        return minutes>=nowM;
      });
    } else if (VIEW === 'past'){
      arr = arr.filter(r => r.dateISO < tISO || (!!r.status && r.dateISO===tISO));
    } else if (VIEW === 'honored'){
      arr = arr.filter(r => r.status === 'honored');
    } else if (VIEW === 'no_show'){
      arr = arr.filter(r => r.status === 'no_show');
    } else if (VIEW === 'cancelled'){
      arr = arr.filter(r => r.status === 'cancelled');
    }
  }

  return arr;
}
function calcMaxPage(arr){ if(arr==='messages'||arr==='agencies') return 1; const n=arr.length; return Math.max(1, Math.ceil(n/PER_PAGE)); }

/* --- Annuler RDV --- */
async function cancelRDV(r){
  if(!confirm('Confirmer l‚Äôannulation de ce rendez-vous ?')) return;
const ch = ((r.channel || r.firstMsgChannel || 'wa')+'').toLowerCase();
const text = msgFromTpl('annulation', r.agency, r.dateText||'', r.timeText||'', r.model||'', null, null, null, ch);  try{
    openChannelAndLog(r.phone, text, r.channel||'wa');
    await db.collection('rdv').doc(r.id).set({status:'cancelled',statusAt:firebase.firestore.FieldValue.serverTimestamp(), honorBilling: firebase.firestore.FieldValue.delete()},{merge:true});
    await db.collection('messages').add({type:'cancel',rdvId:r.id,phone:r.phone,agency:(r.agency||''),channel:(r.channel||'wa'), sentAt:firebase.firestore.FieldValue.serverTimestamp()});
    notify('RDV annul√© et message pr√™t ‚úîÔ∏è','ok');
  }catch{ notify('Annulation enregistr√©e (message copi√©).','ok'); }
}

/* ====== Demande de suppression / Admin ====== */
function openDeleteRequestDialog(r){
  const dlg=document.createElement('dialog');
  dlg.innerHTML=`<div class="dlg-head" style="padding:14px 16px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center">
    <div style="font-weight:800">Demander la suppression</div>
    <button class="btn btn-neutral btn-xs" onclick="this.closest('dialog').close()">Fermer</button></div>
    <div class="dlg-body" style="padding:16px">
      <div class="label">Motif (obligatoire)</div>
      <textarea id="req_reason" class="input" rows="4" placeholder="Ex : Doublon / erreur de saisie / v√©hicule vendu..."></textarea>
      <div class="row mt12" style="justify-content:flex-end;gap:8px">
        <button id="req_send" class="btn btn-primary btn-xs">Envoyer √† l‚Äôadmin</button>
      </div>
    </div>`;
  document.body.appendChild(dlg); dlg.showModal?.() ?? dlg.setAttribute('open','');
  $('#req_send',dlg).onclick=async()=>{
    const reason=$('#req_reason',dlg).value.trim(); if(!reason){ alert('Merci d‚Äôindiquer un motif.'); return; }
    const patch={ deleted:true, deletedAt:firebase.firestore.FieldValue.serverTimestamp(),
      deleteRequest:{ teamName: ROLE.name||'√âquipe', teamRole: ROLE.role||'team', reason, requestedAt: firebase.firestore.FieldValue.serverTimestamp() } };
    try{ await db.collection('rdv').doc(r.id).set(patch,{merge:true}); notify('Demande envoy√©e √† l‚Äôadmin ‚úîÔ∏è','ok'); dlg.close?.(); dlg.remove(); await loadAll(); }
    catch(e){ alert('Erreur lors de l‚Äôenvoi de la demande.'); }
  };
}
async function approveDelete(r){ if(!confirm('Valider la suppression d√©finitive ?')) return;
  try{ await db.collection('rdv').doc(r.id).delete(); notify('Supprim√© d√©finitivement ‚úîÔ∏è','ok'); loadAll(); } catch(e){ alert('Erreur lors de la suppression.'); } }
async function rejectDelete(r){
  try{ await db.collection('rdv').doc(r.id).set({deleteRequest: firebase.firestore.FieldValue.delete()},{merge:true});
    notify('Demande refus√©e (conserv√© en corbeille).','ok'); renderList(); updatePendingButton();
  }catch(e){ alert('Erreur lors du refus.'); }
}

/* ---------- Messages (onglet) ---------- */
async function renderMessages(container){
  container.innerHTML='';
  let snap=null;
  try{ snap = await db.collection('messages').get(); }
  catch(e){ container.innerHTML='<div class="small">Impossible de charger les messages.</div>'; $('#pageNum').textContent='1'; $('#pageMax').textContent='1'; return; }
  let items = snap ? snap.docs.map(d=>({id:d.id,...d.data()})) : [];
  if(FILTER_AGENCY!=='*') items = items.filter(m=> (m.agency||'')===FILTER_AGENCY);
  const rdvById = {}; (ALL_R||[]).forEach(r=>{ rdvById[r.id]=r; });
  items = items.map(m=>{
    const r = rdvById[m.rdvId]; const civ=(r?.civ||'').trim(); const name=(r?.name||'').trim(); const fullName=`${civ?civ+' ':''}${name}`.trim();
    const rawPhone=(r?.phone || m.phone || '').replace(/\D/g,''); const displayPhone=toFR(r?.phone || m.phone || '');
    return {...m,_name:fullName,_phoneDigits:rawPhone,_phoneDisplay:displayPhone};
  });
  items.sort((a,b)=>{ const da=a.sentAt?.toDate?a.sentAt.toDate():(a.sentAt instanceof Date?a.sentAt:null);
                      const dbb=b.sentAt?.toDate?b.sentAt.toDate():(b.sentAt instanceof Date?b.sentAt:null);
                      return (dbb?.getTime()||0)-(da?.getTime()||0); });
  const q = ($('#search').value||'').toLowerCase().trim();
  if(q){
    items = items.filter(m=>{
      const phone=(m._phoneDigits||''); const ag=(m.agency||'').toLowerCase(); const type=(m.type||'').toLowerCase(); const name=(m._name||'').toLowerCase();
      return ag.includes(q) || type.includes(q) || name.includes(q) || phone.includes(q) || phone.slice(-3)===q;
    });
  }
  const per=4; const max=Math.max(1,Math.ceil(items.length/per)); PAGE=Math.min(PAGE,max);
  $('#pageNum').textContent=PAGE; $('#pageMax').textContent=max;
  const arr = items.slice((PAGE-1)*per, PAGE*per);
  if(arr.length===0){ container.innerHTML='<div class="small">Aucun message.</div>'; return; }
  arr.forEach(m=>{
    const dt=m.sentAt?.toDate?m.sentAt.toDate():null;
    const dStr=dt?`${pad(dt.getDate())}/${pad(dt.getMonth()+1)}/${dt.getFullYear()} ${pad(dt.getHours())}:${pad(dt.getMinutes())}`:'‚Äî';
    const typeLabel = m.type==='reminder'?'Rappel': m.type==='reminder_cancelled'?'Rappel annul√©': m.type==='reschedule'?'Report confirm√©': m.type==='cancel'?'RDV annul√©': m.type==='no_show_msg'?'Message ‚Äúpas venu‚Äù': m.type==='confirmation_resent'?'Conf. renvoy√©e':'Confirmation';
    const chan=(m.channel||'').toUpperCase()||'‚Äî'; const chanClass=(m.channel==='wa'?'wa':'sms');
    const nameBubble = m._name ? `<span class="bubble gray">üë§ ${escapeHtml(m._name)}</span>` : '';
    const phoneBubble = m._phoneDisplay ? `<span class="bubble gray">üìû ${escapeHtml(m._phoneDisplay)}</span>` : '';
    const row=document.createElement('div'); row.className='rdv';
    row.innerHTML=`<div><div class="title">${typeLabel} ‚Äî ${escapeHtml(m.agency||'')}</div>
      <div class="mt8" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        ${nameBubble}${phoneBubble}<span class="bubble ${chanClass}">${chan}</span><span class="bubble gray">${dStr}</span>
      </div></div>`;
    container.appendChild(row);
  });
}

/* ---------- NOTE ---------- */
async function openNoteDialog(id){
  const snap = await db.collection('rdv').doc(id).get(); if(!snap.exists) return alert('RDV introuvable');
  const r = {id:snap.id, ...snap.data()};
  const txt = r.noteText || ''; const due = r.noteDueISO || ''; const tomo = isoOf(addDays(new Date(),1));
  const dlg = document.createElement('dialog');
  dlg.innerHTML = `
    <div class="dlg-head" style="padding:14px 16px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:800">üìù Note du rendez-vous</div>
      <button class="btn btn-neutral btn-xs" onclick="this.closest('dialog').close()">Fermer</button>
    </div>
    <div class="dlg-body" style="padding:16px;max-width:720px">
      <div class="small" style="margin-bottom:8px">${fmtNice(r.dateISO,r.timeText)} ‚Äî ${escapeHtml((r.civ||'')+' '+(r.name||''))}</div>
      <div class="label">Contenu de la note</div>
      <textarea id="note_text" class="input" rows="5" placeholder="Ex : Pr√©voir double des cl√©s, CT en cours, etc.">${escapeHtml(txt)}</textarea>
      <div class="row mt12" style="gap:8px;align-items:center">
        <div style="flex:1">
          <div class="label">√âch√©ance (optionnelle)</div>
          <input id="note_due" type="date" class="input" value="${due||''}">
        </div>
        <button id="note_tomorrow" class="btn btn-neutral btn-xs">Note demain</button>
        <button id="note_clear_due" class="btn btn-ghost btn-xs">Retirer √©ch√©ance</button>
      </div>
      <div class="row mt12" style="justify-content:flex-end;gap:8px">
        <button id="note_delete" class="btn btn-warn btn-xs">Effacer la note</button>
        <button id="note_save" class="btn btn-primary btn-xs">Enregistrer</button>
      </div>
    </div>`;
  document.body.appendChild(dlg); dlg.showModal?.() ?? dlg.setAttribute('open','');

  $('#note_tomorrow',dlg).onclick = ()=>{ $('#note_due',dlg).value = tomo; };
  $('#note_clear_due',dlg).onclick = ()=>{ $('#note_due',dlg).value = ''; };

  $('#note_delete',dlg).onclick = async ()=>{
    await db.collection('rdv').doc(id).set({
      noteText: firebase.firestore.FieldValue.delete(),
      noteDueISO: firebase.firestore.FieldValue.delete(),
      noteUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, {merge:true});
    notify('Note effac√©e','ok'); dlg.close?.(); dlg.remove(); loadAll();
  };

  $('#note_save',dlg).onclick = async ()=>{
    const t = $('#note_text',dlg).value.trim();
    const d = $('#note_due',dlg).value || null;
    await db.collection('rdv').doc(id).set({
      noteText: t || null,
      noteDueISO: d || null,
      noteUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, {merge:true});
    notify('Note enregistr√©e','ok'); dlg.close?.(); dlg.remove(); loadAll();
  };
}

/* ---------- Geste commercial ---------- */
async function openGesteDialog(rInput){
  const snap = await db.collection('rdv').doc(rInput.id).get().catch(()=>null);
  const r = snap?.exists ? {id:snap.id, ...snap.data()} : rInput;
  const dlg=document.createElement('dialog'); const amount=(typeof r.gesteAmount==='number'&&!isNaN(r.gesteAmount))?r.gesteAmount:'';
  dlg.innerHTML=`
    <div class="dlg-head" style="padding:14px 16px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:800">üéÅ Geste commercial</div>
      <button class="btn btn-neutral btn-xs" onclick="this.closest('dialog').close()">Fermer</button>
    </div>
    <div class="dlg-body" style="padding:16px">
      <div class="small" style="margin-bottom:8px">${fmtNice(r.dateISO,r.timeText)} ‚Äî ${escapeHtml(((r.civ||'')+' '+(r.name||'')).trim())}</div>
      <div class="label">Montant (en ‚Ç¨)</div>
      <input id="gc_amount" class="input" inputmode="decimal" placeholder="Ex : 50" value="${amount!==''?amount:''}">
      <div class="row mt12" style="justify-content:flex-end;gap:8px">
        ${r.gesteCommercial?`<button id="gc_remove" class="btn btn-ghost btn-xs">Retirer le geste</button>`:''}
        <button id="gc_save" class="btn btn-primary btn-xs">${r.gesteCommercial?'Mettre √† jour':'Enregistrer'}</button>
      </div>
    </div>`;
  document.body.appendChild(dlg); dlg.showModal?.() ?? dlg.setAttribute('open','');
  $('#gc_remove',dlg)?.addEventListener('click', async()=>{
    await db.collection('rdv').doc(r.id).set({gesteCommercial:false,gesteAmount:firebase.firestore.FieldValue.delete()},{merge:true});
    notify('Geste retir√©','ok'); dlg.close?.(); dlg.remove(); loadAll();
  });
  $('#gc_save',dlg).onclick=async()=>{
    const v=($('#gc_amount',dlg).value||'').trim().replace(',','.'); const n=parseFloat(v);
    if(isNaN(n)||n<0){ alert('Montant invalide'); return; }
    await db.collection('rdv').doc(r.id).set({gesteCommercial:true,gesteAmount:n},{merge:true});
    notify('Geste enregistr√©','ok'); dlg.close?.(); dlg.remove(); loadAll();
  };
}

/* ---------- Stepper ---------- */
function progressFromRDV(r){
  const lastLabel = r.status==='honored'   ? 'Honor√©' :
                    r.status==='no_show'   ? 'Non honor√©' :
                    r.status==='cancelled' ? 'Annul√©' : '√Ä venir';
  return { steps: [
      { key:'placed',   label:'Plac√©',        done:true },
      { key:'confirm',  label:'Confirmation', done: !!r.firstMsgAt },
      { key:'reminder', label:'Rappel',       done: !!r.reminderSent },
      { key:'status',   label:lastLabel,      done: !!r.status }
  ]};
}
function renderStepperHTML(state, mini=false){
  const steps  = state.steps || []; const labels=steps.map(s=>s.label);
  let html = `<div class="cn-stepper ${mini?'cn-stepper--mini':''}">`;
  steps.forEach((st,i)=>{ const prevDone=i>0?!!steps[i-1].done:true; const isDone=!!st.done; const isCurrent=!isDone && prevDone;
    html+=`<div class="cn-step ${isDone?'is-done':''} ${isCurrent?'is-current':''}"><div class="cn-dot">${isDone?'<i class="fa-solid fa-check"></i>':(i+1)}</div></div>`; if(i<steps.length-1) html+=`<div class="cn-line"></div>`;
  });
  html += `</div>`;
  if(!mini){ html += `<div class="cn-stepper-labels">${labels.map(l=>`<span>${escapeHtml(l)}</span>`).join('')}</div>`; }
  return html;
}
function progressMiniHTML(r){ return renderStepperHTML(progressFromRDV(r), true); }

/* ---------- Fiche RDV ---------- */
function openRDVSheet(r){
  const ag = getAgencyByKey(r.agency||'');
  const dueNote = r.noteDueISO ? (r.noteDueISO===todayISO() ? 'aujourd‚Äôhui' : (r.noteDueISO===isoOf(addDays(new Date(),1)) ? 'demain' : dateLongueISO(r.noteDueISO))) : null;
  const dlg=document.createElement('dialog');
  dlg.innerHTML=`
    <div class="dlg-head" style="padding:14px 16px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:800">Fiche rendez-vous</div>
      <button class="btn btn-neutral btn-xs" onclick="this.closest('dialog').close()">Fermer</button>
    </div>
    <div class="dlg-body" style="padding:16px;max-width:860px">
      <div class="title" style="margin-bottom:6px">${fmtNice(r.dateISO,r.timeText)} ‚Äî ${escapeHtml(((r.civ||'')+' '+(r.name||'')).trim())}</div>
      <div class="small">${toFR(r.phone)} ‚Ä¢ ${escapeHtml(r.model||'')} ‚Ä¢ Source : ${escapeHtml(r.source||'')}</div>
      <div class="mt8" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        ${r.agency?`<span class="badge">${escapeHtml(r.agency)}</span>`:''}
        ${iconForChannel(r)}
        ${r.status==='honored'?`<span class="bubble green">Honor√©${r.honorBilling? (r.honorBilling==='factur√©'?' ‚Ä¢ Factur√©':' ‚Ä¢ Non facturable') : ''}</span>`:''}
        ${r.status==='no_show'?`<span class="bubble orange">Non honor√©</span>`:''}
        ${r.status==='cancelled'?`<span class="bubble gray">Annul√©</span>`:''}
        ${r.reminderSent?`<span class="bubble green">Rappel envoy√© ‚Ä¢ ${fmtDT(r.reminderAt)} ‚Ä¢ ${(r.reminderChannel||'').toUpperCase()}</span>`:''}
        ${r.gesteCommercial?`<span class="bubble blue">üéÅ Geste ${typeof r.gesteAmount==='number'&&!isNaN(r.gesteAmount)? (r.gesteAmount.toFixed(0)+'‚Ç¨') : ''}</span>`:''}
        ${(r.noteText||'').trim()?`<span class="bubble blue">üìù ${escapeHtml((r.noteText||'').trim().length>80?(r.noteText||'').trim().slice(0,80)+'‚Ä¶':(r.noteText||'').trim())}${dueNote?(' ‚Ä¢ '+dueNote):''}</span>`:''}
      </div>

      <div class="card" style="margin-top:12px">
        <div class="label">Aper√ßu rapide</div>
        <div id="cn_progress_full">${renderStepperHTML(progressFromRDV(r), false)}</div>
      </div>

      <div class="row mt12 sheet-actions" style="gap:8px">
        <a class="btn btn-neutral btn-xs" href="${telHref(r.phone)}">Appeler</a>
        <button class="btn btn-neutral btn-xs" id="sheet_note">Note</button>
        <button class="btn btn-neutral btn-xs" id="sheet_resend">Renvoyer confirmation</button>
        ${(!r.reminderSent)?`<button class="btn btn-neutral btn-xs" id="sheet_remind">Rappel</button>`:`<button class="btn btn-ghost btn-xs" id="sheet_unremind">Annuler rappel</button>`}
        <button class="btn btn-neutral btn-xs" id="sheet_status">Statut</button>
        <button class="btn btn-neutral btn-xs" id="sheet_edit">Modifier</button>
        <button class="btn btn-ghost btn-xs" id="sheet_resched">Reporter</button>
        ${(r.status!=='honored' && r.status!=='cancelled')?`<button class="btn btn-warn btn-xs" id="sheet_cancel">Annuler RDV</button>`:''}
        <button class="btn btn-neutral btn-xs" id="sheet_geste">${r.gesteCommercial?('Geste '+(typeof r.gesteAmount==='number'&&!isNaN(r.gesteAmount)? r.gesteAmount.toFixed(0)+'‚Ç¨':'‚úì')):'Geste comm.'}</button>
      </div>

      <div class="card mt12 rdv-agency">
  <div class="label">Agence</div>
  <div class="small"><b>${escapeHtml(ag.name||r.agency||'')}</b></div>
  ${ag.addr ? `<div class="ag-line">üìç <span>${escapeHtml(ag.addr)}</span></div>` : ''}
  ${ag.map  ? `<div class="ag-line">üó∫Ô∏è <a href="${ag.map}" target="_blank" rel="noopener">Plan d‚Äôacc√®s</a></div>` : ''}
  ${ag.phone ? `<div class="ag-line">üìû <a href="tel:${ag.phone.replace(/\D/g,'')}">${escapeHtml(ag.phone)}</a></div>` : ''}
  ${ag.tagline ? `<div class="ag-line">üè∑Ô∏è <span>${escapeHtml(ag.tagline)}</span></div>` : ''}
</div>

      <div id="history_wrap" class="card">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div class="label">Historique du client</div>
          <button class="btn btn-warn btn-xs icon-only" id="btnWipeHistory" title="Effacer tout l‚Äôhistorique">üóëÔ∏è</button>
        </div>
        <div id="history_body"><div class="small">Chargement‚Ä¶</div></div>
      </div>
    </div>`;
  document.body.appendChild(dlg); dlg.showModal?.() ?? dlg.setAttribute('open','');

  $('#sheet_note',dlg).onclick = ()=>{ openNoteDialog(r.id); };
  $('#sheet_resend',dlg).onclick = ()=>{ resendConfirmation(r); };
  $('#sheet_remind',dlg)?.addEventListener('click', ()=>sendReminder(r));
  $('#sheet_unremind',dlg)?.addEventListener('click', ()=>undoReminder(r));
  $('#sheet_status',dlg).onclick = ()=>{ openStatusDialog(r.id); };
  $('#sheet_edit',dlg).onclick = ()=>{ openEditDialog(r.id); };
  $('#sheet_resched',dlg).onclick = ()=>{ openReschedDialog(r.id); };
  $('#sheet_cancel',dlg)?.addEventListener('click', ()=>{ cancelRDV(r); });
  $('#sheet_geste',dlg).onclick = ()=>{ openGesteDialog(r); };

  $('#btnWipeHistory',dlg).onclick = ()=> openWipeHistoryDialog(r);
  loadAndRenderHistory(r, $('#history_body',dlg));
}

/* Historique (wipe + rendu) */
function openWipeHistoryDialog(r){
  const dlg=document.createElement('dialog');
  dlg.innerHTML=`
    <div class="dlg-head" style="padding:14px 16px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:800">Effacer l‚Äôhistorique de ${escapeHtml((r.civ||'')+' '+(r.name||''))}</div>
      <button class="btn btn-neutral btn-xs" onclick="this.closest('dialog').close()">Fermer</button>
    </div>
    <div class="dlg-body" style="padding:16px">
      <div class="small">Num√©ro : <b>${toFR(r.phone)}</b></div>
      <div class="mt12"><label class="small" style="display:flex;align-items:center;gap:8px">
        <input type="checkbox" id="wipe_msgs" checked disabled> <span>Supprimer <b>tous les messages</b> li√©s √† ce num√©ro</span></label></div>
      <div class="mt8"><label class="small" style="display:flex;align-items:center;gap:8px">
        <input type="checkbox" id="wipe_rdv"> <span>Mettre √† la <b>corbeille</b> tous ses RDV</span></label></div>
      <div class="row mt12" style="justify-content:flex-end;gap:8px">
        <button class="btn btn-warn btn-xs" id="wipe_confirm">Effacer</button>
      </div>
    </div>`;
  document.body.appendChild(dlg); dlg.showModal?.() ?? dlg.setAttribute('open','');
  $('#wipe_confirm',dlg).onclick = async ()=>{
    if(!confirm('Confirmer la suppression de tout l‚Äôhistorique messages ?')) return;
    try{
      const msgSnap = await db.collection('messages').where('phone','==', r.phone).get();
      for(const doc of msgSnap.docs){ await db.collection('messages').doc(doc.id).delete(); }
      if($('#wipe_rdv',dlg).checked){
        const rdvSnap = await db.collection('rdv').where('phone','==', r.phone).get();
        for(const doc of rdvSnap.docs){
          await db.collection('rdv').doc(doc.id).set({deleted:true,deletedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:true});
        }
      }
      notify('Historique effac√© ‚úîÔ∏è','ok'); dlg.close?.(); dlg.remove(); loadAll();
      const sheets=document.querySelectorAll('dialog[open]'); const top=[...sheets].pop(); if(top){ const body=top.querySelector('#history_body'); if(body) loadAndRenderHistory(r, body); }
    }catch(e){ alert('Erreur pendant la suppression.'); }
  };
}

/* === ‚ú® Nouveau rendu "Messages" dans l'historique ‚Äî mobile-first, sans d√©bordement === */
async function loadAndRenderHistory(rInput, container){
  const phoneE164 = rInput.phone;
  try{
    const [rdvSnap, msgSnap] = await Promise.all([
      db.collection('rdv').where('phone','==', phoneE164).get(),
      db.collection('messages').where('phone','==', phoneE164).get()
    ]);

    // RDV (autres fiches)
    let rdvs = rdvSnap.docs.map(d=>({id:d.id,...d.data()}))
      .sort((a,b)=> (b.dateISO||'').localeCompare(a.dateISO||'') || (b.timeText||'').localeCompare(a.timeText||''));
    const totalRdvCount = rdvs.length;
    const rdvsToShow = rdvs.filter(rr => rr.id !== rInput.id);

    // Messages (tri r√©cents ‚Üí anciens)
    const msgs = msgSnap.docs.map(d=>({id:d.id,...d.data()}))
      .sort((a,b)=>{ const da=a.sentAt?.toDate?a.sentAt.toDate():null; const dbb=b.sentAt?.toDate?b.sentAt.toDate():null; return (dbb?.getTime()||0)-(da?.getTime()||0); });

    const statusLabel = (r)=>{
      if(r.status==='honored') return 'Honor√©'+(r.honorBilling? (r.honorBilling==='factur√©'?' ‚Ä¢ Factur√©':' ‚Ä¢ Non facturable') : '');
      if(r.status==='no_show') return 'Non honor√©';
      if(r.status==='cancelled') return 'Annul√©';
      return 'Pr√©vu';
    };

    const rdvHtml = rdvsToShow.map(r=>`
        <div class="rdv" style="cursor:pointer" data-open="${r.id}">
          <div>
            <div class="title">${fmtNice(r.dateISO,r.timeText)} ‚Äî ${escapeHtml(((r.civ||'')+' '+(r.name||'')).trim())}</div>
            <div class="meta">${escapeHtml(r.model||'')} ‚Ä¢ ${escapeHtml(r.agency||'')}</div>
            <div class="mt8" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
              <span class="bubble gray">${statusLabel(r)}</span>
              ${r.reminderSent?`<span class="bubble green">Rappel envoy√© ‚Ä¢ ${fmtDT(r.reminderAt)} ‚Ä¢ ${(r.reminderChannel||'').toUpperCase()}</span>`:''}
              ${r.gesteCommercial?`<span class="bubble blue">üéÅ Geste ${typeof r.gesteAmount==='number'&&!isNaN(r.gesteAmount)? (r.gesteAmount.toFixed(0)+'‚Ç¨') : ''}</span>`:''}
              ${(r.noteText||'').trim()?`<span class="bubble blue">üìù ${escapeHtml((r.noteText||'').trim().slice(0,60))}${(r.noteText||'').trim().length>60?'‚Ä¶':''}</span>`:''}
            </div>
            <div class="mt12">${progressMiniHTML(r)}</div>
          </div>
        </div>`).join('');

    // Helper pour avatar (2 lettres)
    const initials = (name, ch) => {
      const s = (name||'').trim();
      if(s) {
        const parts = s.split(/\s+|\(|\)|-|,|\./).filter(Boolean);
        const first = (parts[0]||'')[0]||'';
        const second = (parts[1]||'')[0] || (parts[0]||'')[1] || '';
        return (first+second).toUpperCase();
      }
      return (ch==='wa'?'WA':'SM');
    };
    const msgLabel=(t)=> t==='reminder'?'Rappel': t==='reminder_cancelled'?'Rappel annul√©': t==='reschedule'?'Report confirm√©': t==='cancel'?'RDV annul√©': t==='no_show_msg'?'Message ‚Äúpas venu‚Äù': t==='confirmation_resent'?'Conf. renvoy√©e':'Confirmation';

    // Nouveau: rendu en liste "chat"
    const msgsHtml = msgs.map(m=>{
      const d=m.sentAt?.toDate?m.sentAt.toDate():null;
      const dStr=d?`${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`:'‚Äî';
      const ag = m.agency || '';
      const chan = (m.channel||'').toLowerCase()==='wa' ? 'WA' : 'SMS';
      const type = msgLabel(m.type||'');
      const nameTag = (rInput.civ||rInput.name) ? `üë§ ${escapeHtml(((rInput.civ||'')+' '+(rInput.name||'')).trim())}` : '';
      const phoneTag = toFR(rInput.phone);
      return `
        <div class="msg-row">
          <div class="msg-avatar">${escapeHtml(initials(ag, m.channel))}</div>
          <div class="msg-main">
            <div class="msg-top">
              <div class="msg-agency" title="${escapeHtml(ag)}">${escapeHtml(ag)}</div>
              <time class="msg-time">${dStr}</time>
            </div>
            <p class="msg-bubble"><b>${escapeHtml(type)}</b></p>
            <div class="msg-tags">
              <span class="msg-tag">${chan}</span>
              ${nameTag ? `<span class="msg-tag">${nameTag}</span>` : ''}
              <span class="msg-tag">üìû ${escapeHtml(phoneTag)}</span>
            </div>
          </div>
        </div>`;
    }).join('');

    container.innerHTML = `
      <div class="small" style="margin-bottom:10px">T√©l√©phone : <b>${toFR(phoneE164)}</b> ‚Ä¢ Total RDV : <b>${totalRdvCount}</b> ‚Ä¢ Messages : <b>${msgs.length}</b></div>

      <div style="margin-bottom:16px"><b>Rendez-vous</b> <span class="small" style="opacity:.7">(hors fiche ouverte)</span></div>
      ${rdvsToShow.length? rdvHtml : '<div class="small">Aucun autre RDV.</div>'}

      <div style="margin-top:18px;margin-bottom:8px"><b>Messages</b></div>
      ${msgs.length? `<div class="history-messages">${msgsHtml}</div>` : '<div class="small">Aucun message.</div>'}
    `;

    // clic pour ouvrir une autre fiche
    container.closest('#history_wrap')?.querySelectorAll('[data-open]')?.forEach(el=>{
      el.addEventListener('click', ()=>{
        const id = el.getAttribute('data-open');
        const found = ALL_R.find(x=>x.id===id);
        if(found){ document.querySelector('dialog[open]')?.close?.(); openRDVSheet(found); }
      });
    });

  }catch(e){
    container.innerHTML='<div class="small">Historique indisponible.</div>';
  }
}

/* ---------- Panneau ‚öôÔ∏è R√©glages ---------- */
function openActionDialog(r){
  const tISO=todayISO(), now=new Date(), nowM=now.getHours()*60+now.getMinutes();
  const m=(r.timeText||'').match(/(\d{2}):(\d{2})/); const mins=m?(+m[1]*60 + +m[2]):-1;
  const isFuture = (r.dateISO>tISO) || (r.dateISO===tISO && mins>nowM);
  const allowReminder = isFuture;
  const dlg=document.createElement('dialog');
  dlg.style.maxWidth='720px'; dlg.style.width='min(92vw,720px)';
  dlg.innerHTML=`
    <div class="dlg-head" style="padding:12px 14px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:800;display:flex;gap:8px;align-items:center"><span>‚öôÔ∏è R√©glages ‚Äî</span> <span>${escapeHtml(((r.civ||'')+' '+(r.name||'')).trim())}</span></div>
      <button class="btn btn-neutral btn-xs" onclick="this.closest('dialog').close()">Fermer</button>
    </div>
    <div class="dlg-body" style="padding:14px">
      <div class="small" style="margin-bottom:8px">${fmtNice(r.dateISO,r.timeText)} ‚Ä¢ ${escapeHtml(r.agency||'')} ‚Ä¢ ${toFR(r.phone)} ‚Ä¢ ${escapeHtml(r.model||'')}</div>
      <div class="action-dialog__grid">
        <a class="btn btn-neutral btn-xs" href="${telHref(r.phone)}">üìû Appeler</a>
        <button class="btn btn-neutral btn-xs" id="act_open">üóÇÔ∏è Ouvrir la fiche</button>
        <button class="btn btn-neutral btn-xs" id="act_resend">‚úâÔ∏è Renvoyer confirmation</button>
        ${allowReminder && !r.reminderSent ? `<button class="btn btn-neutral btn-xs" id="act_remind">‚è∞ Rappel</button>` : ''}
        ${allowReminder && r.reminderSent ? `<button class="btn btn-ghost btn-xs" id="act_unremind">‚Ü©Ô∏è Annuler rappel</button>` : ''}
        <button class="btn btn-neutral btn-xs" id="act_note">üìù Note</button>
        <button class="btn btn-neutral btn-xs" id="act_geste">üéÅ Geste</button>
        <button class="btn btn-neutral btn-xs" id="act_edit">‚úèÔ∏è Modifier</button>
        ${r.status!=='honored' ? `<button class="btn btn-ghost btn-xs" id="act_resched">üìÖ Reporter</button>` : ''}
        ${r.status!=='honored' && r.status!=='cancelled' ? `<button class="btn btn-warn btn-xs" id="act_cancel">üö´ Annuler RDV</button>` : ''}
        ${r.status!=='honored' ? `<button class="btn btn-neutral btn-xs" id="act_noshow">üö∑ Pas venu (message)</button>` : ''}
        <button class="btn btn-neutral btn-xs" id="act_status">üè∑ Statut</button>
      </div>
      <div class="action-dialog__section">
        <div class="action-dialog__title">Suppression</div>
        <div class="action-dialog__grid">
          ${ROLE.role==='admin' ? `<button class="btn btn-neutral btn-xs" id="act_trash">üóëÔ∏è Mettre √† la corbeille</button>` : `<button class="btn btn-neutral btn-xs" id="act_req_del">üóëÔ∏è Demander suppression</button>`}
        </div>
      </div>
    </div>`;
  document.body.appendChild(dlg); dlg.showModal?.() ?? dlg.setAttribute('open','');

  $('#act_open',dlg).onclick=()=>{ dlg.close?.(); dlg.remove(); openRDVSheet(r); };
  $('#act_resend',dlg).onclick=()=>{ resendConfirmation(r); };
  $('#act_remind',dlg)?.addEventListener('click', ()=>{ sendReminder(r); });
  $('#act_unremind',dlg)?.addEventListener('click', ()=>{ undoReminder(r); });
  $('#act_note',dlg).onclick=()=>{ openNoteDialog(r.id); };
  $('#act_geste',dlg).onclick=()=>{ openGesteDialog(r); };
  $('#act_edit',dlg).onclick=()=>{ openEditDialog(r.id); };
  $('#act_resched',dlg)?.addEventListener('click', ()=>{ openReschedDialog(r.id); });
  $('#act_cancel',dlg)?.addEventListener('click', ()=>{ cancelRDV(r); });
  $('#act_noshow',dlg)?.addEventListener('click', ()=>{ sendNoShowMessage(r); });
  $('#act_status',dlg).onclick=()=>{ openStatusDialog(r.id); };

  if(ROLE.role==='admin'){
    $('#act_trash',dlg).onclick=async()=>{ if(confirm('Mettre ce RDV √† la corbeille ?')){ await db.collection('rdv').doc(r.id).set({deleted:true,deletedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:true}); dlg.close?.(); dlg.remove(); await loadAll(); } };
  }else{
    $('#act_req_del',dlg).onclick=()=>{ openDeleteRequestDialog(r); };
  }
}

/* ---------- Rendu principal ---------- */
function renderList(){
  if (VIEW==='agencies' && ROLE.role!=='admin') VIEW='today';
  $('#bulkBar').style.display=(ROLE.role==='admin' && VIEW==='trash')?'flex':'none';

  const list=$('#rdvList'); list.innerHTML='';
  if(VIEW==='agencies'){ return renderAgencies(list); }

  const arr = currFiltered();
  if(arr==='messages'){ return renderMessages(list); }

  if(arr.length===0){
    list.innerHTML+='<div class="small">Aucun √©l√©ment.</div>';
    $('#pageNum').textContent='1'; $('#pageMax').textContent='1';
    updateTabCounts(); updateStatusChips();
    return;
  }

  const tISO=todayISO(); const now=new Date(); const nowM=now.getHours()*60+now.getMinutes();
  if(VIEW==='past' && !PLACED_ON){ arr.sort((a,b)=> (b.dateISO||'').localeCompare(a.dateISO||'') || (b.timeText||'').localeCompare(b.timeText||'')); }
  else { arr.sort((a,b)=> (a.dateISO||'').localeCompare(b.dateISO||'') || (a.timeText||'').localeCompare(b.timeText||'')); }

  const max=calcMaxPage(arr); PAGE=Math.min(PAGE,max);
  $('#pageNum').textContent=PAGE; $('#pageMax').textContent=max;

  const pageItems=arr.slice((PAGE-1)*PER_PAGE,(PAGE)*PER_PAGE);
  pageItems.forEach(r=>{
    const row=document.createElement('div'); row.className='rdv';
    const createdStr = r.createdAt?fmtDT(r.createdAt):'';
    const left=document.createElement('div');

    const creatorColor = r.createdByRole==='team'?'orange':'blue';
    const reminderBubble = r.reminderSent ? `<span class="bubble green">Rappel envoy√© ‚Ä¢ ${fmtDT(r.reminderAt)} ‚Ä¢ ${(r.reminderChannel||'').toUpperCase()}</span>` : '';
    const civName = `${(r.civ||'').trim()} ${(r.name||'').trim()}`.trim();

    const m=(r.timeText||'').match(/(\d{2}):(\d{2})/);
    const mins=m?(+m[1]*60 + +m[2]):-1;
    const isPast = (r.dateISO||'') < tISO || ((r.dateISO||'')===tISO && mins>=0 && nowM>=mins);
    try {
  if (r.dateISO && r.timeText) {
    const [Y, Mo, Da] = (r.dateISO||'').split('-').map(v => Number(v));
    const [HH, MM] = (r.timeText||'00:00').split(':').map(v => Number(v));
    const appt = new Date(Y, Mo - 1, Da, HH, MM); // horaire local du RDV
    const nowDt = new Date();

    // Option A ‚Äî clignoter si on est pass√© +60 minutes (1 heure apr√®s l'heure) :
    const minutesSince = Math.round((nowDt - appt) / 60000); // >0 si on est apr√®s l'heure

    // Respecter les pr√©f√©rences d'accessibilit√© : pas d'animation si reduced-motion
    const prefersReduced = typeof window !== 'undefined'
      && window.matchMedia
      && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    if (minutesSince > 60 && !prefersReduced) { // <-- seuil 60 minutes
      row.classList.add('blink-red');
    } else {
      row.classList.remove('blink-red');
    }

  } else {
    row.classList.remove('blink-red');
  }
} catch (err) {
  // safe fallback : rien ne casse si parsing KO
  row.classList.remove('blink-red');
}
    let statutTxt='';
    if(r.status==='honored'){
      const bill = r.honorBilling=== 'factur√©' ? ' ‚Ä¢ Factur√©' : (r.honorBilling==='non_facturable' ? ' ‚Ä¢ Non facturable' : '');
      statutTxt='Statut : Honor√©'+bill;
    }
    else if(r.status==='no_show') statutTxt='Statut : Pas venu';
    else if(r.status==='cancelled') statutTxt='Statut : Annul√©';
    else if(isPast) statutTxt='√Ä faire : renseigner le statut';
    else statutTxt='Statut : Pr√©vu';

    const todoBubble = (!r.status && isPast) ? `<span class="bubble orange">√Ä faire ‚Äî renseigner le statut</span>` : '';
    let noteBubble = '';
    if((r.noteText||'').trim()){
      const snip = (r.noteText||'').trim(); const short = snip.length>60 ? snip.slice(0,60)+'‚Ä¶' : snip;
      let dueTxt = ''; if(r.noteDueISO){ const ti=todayISO(), tm=isoOf(addDays(new Date(),1));
        if(r.noteDueISO===ti) dueTxt=' ‚Ä¢ aujourd‚Äôhui'; else if(r.noteDueISO===tm) dueTxt=' ‚Ä¢ demain'; else dueTxt=' ‚Ä¢ '+dateLongueISO(r.noteDueISO); }
      noteBubble = `<span class="bubble blue">üìù ${escapeHtml(short)}${dueTxt}</span>`;
    }
    const gesteBubble = r.gesteCommercial ? `<span class="bubble blue">üéÅ Geste ${typeof r.gesteAmount==='number'&&!isNaN(r.gesteAmount)? (r.gesteAmount.toFixed(0)+'‚Ç¨') : ''}</span>` : '';
    let deleteReqBox = '';
    if (VIEW==='trash' && r.deleteRequest){
      const req=r.deleteRequest||{}; const who=req.teamName||'√âquipe'; const when=fmtDT(req.requestedAt); const reason=escapeHtml(req.reason||'');
      deleteReqBox = `<div class="mt8" style="border:1px dashed #f59e0b;background:#fff7ed;border-radius:8px;padding:8px">
        <div class="small"><b>Motif (demande de ${who})</b>${when?` ‚Äî ${when}`:''}</div><div class="small" style="white-space:pre-wrap">${reason}</div></div>`;
    }

    left.innerHTML=`
      <div class="title">${fmtNice(r.dateISO,r.timeText)} ‚Äî ${escapeHtml(civName)}</div>
      <div class="meta">${toFR(r.phone)} ‚Ä¢ ${escapeHtml(r.model||'')}</div>
      <div class="mt8" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        ${r.agency?`<span class="badge">${escapeHtml(r.agency)}</span>`:''}
        ${iconForChannel(r)}
        <span class="bubble gray">${statutTxt}</span>
        ${createdStr?`<span class="bubble ${creatorColor}">Plac√© par : ${escapeHtml(r.createdByName||'')} ‚Ä¢ ${createdStr}</span>`:''}
        ${reminderBubble}
        ${gesteBubble}
        ${noteBubble}
        ${todoBubble}
      </div>
      <div class="mt12">${progressMiniHTML(r)}</div>
      ${deleteReqBox}`;
// D√©sactive l'ouverture par clic sur la ligne : ‚öôÔ∏è uniquement
left.style.cursor='default';
left.onclick = (e)=>{ e?.stopPropagation?.(); /* no-op */ };
const actions=document.createElement('div'); actions.className='rdv-actions';
if (VIEW==='trash') {
  if (ROLE.role==='admin') {
    const cb=document.createElement('input'); cb.type='checkbox'; cb.className='selbox'; cb.dataset.id=r.id;
    cb.onchange=(e)=>{ if(e.target.checked) SELECTED.add(r.id); else SELECTED.delete(r.id); };
    actions.appendChild(cb);
  }
  const gear=document.createElement('button'); gear.className='btn btn-neutral btn-xs icon-only'; gear.title='R√©glages'; gear.innerHTML='<i class="fa-solid fa-gear"></i>';
  gear.onclick=()=>openTrashActionDialog(r); actions.appendChild(gear);
} else {
  // (ON) : bouton Rappel visible pour les RDV d'aujourd'hui non rappel√©s et encore √† venir
  try {
    const tISO = todayISO();
    const m = (r.timeText||'').match(/(\d{2}):(\d{2})/);
    const mins = m ? (+m[1]*60 + +m[2]) : -1;
    const now = new Date();
    const nowM = now.getHours()*60 + now.getMinutes();

    // Affiche le bouton uniquement si le RDV est pour aujourd'hui, pas encore rappel√©, et dans le futur
    if (r.dateISO === tISO && !r.reminderSent && mins > nowM) {
      const btnRappel = document.createElement('button');
      btnRappel.className = 'btn btn-primary btn-xs';
      btnRappel.textContent = 'Rappel';
      btnRappel.setAttribute('aria-label', 'Envoyer rappel');

      btnRappel.onclick = async (ev) => {
        // √©vite d'ouvrir la fiche si le clic d√©clenche aussi un click sur la ligne
        if (ev && ev.stopPropagation) ev.stopPropagation();

        // pr√©vention multi-clic + UI optimiste : cacher le bouton imm√©diatement
        btnRappel.disabled = true;
        btnRappel.style.display = 'none';

        try {
          // mise √† jour locale optimiste
          patchRDV(r.id, { reminderSent: true, reminderAt: new Date(), reminderChannel: (r.firstMsgChannel||r.channel||'wa') });
          refreshOpenSheet(r.id);

          // envoi r√©el (ouvre WA/SMS et marque en base)
          await sendReminder(r);

          // sendReminder/markReminder devraient rafra√Æchir la liste ou le statut automatiquement
        } catch (err) {
          console.error('Erreur rappel :', err);
          notify('Erreur lors de l\'envoi du rappel','warn');

          // restaurer l'affichage du bouton si √©chec + annuler le patch local
          btnRappel.disabled = false;
          btnRappel.style.display = 'inline-block';
          patchRDV(r.id, { reminderSent: false, reminderAt: undefined, reminderChannel: undefined });
          refreshOpenSheet(r.id);
        }
      };

      actions.appendChild(btnRappel);
    }
  } catch (e) {
    console.error('Patch rappel : erreur de calcul horaire', e);
  }

  // Gear (r√©glages) ‚Äî inchang√©, apr√®s le bouton Rappel
  const gear=document.createElement('button'); gear.className='btn btn-neutral btn-xs icon-only'; gear.title='R√©glages'; gear.innerHTML='<i class="fa-solid fa-gear"></i>';
  gear.onclick=()=>openActionDialog(r); actions.appendChild(gear);
}
if(!r.status && isPast){ row.classList.add('blink'); }
row.append(left,actions); $('#rdvList').appendChild(row);
});

updateTabCounts();
updateStatusChips();
}

/* Corbeille : panneau */
function openTrashActionDialog(r){
  const dlg=document.createElement('dialog');
  dlg.style.maxWidth='680px'; dlg.style.width='min(92vw,680px)';
  dlg.innerHTML=`
    <div class="dlg-head" style="padding:12px 14px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:800">üóëÔ∏è Corbeille ‚Äî ${escapeHtml(((r.civ||'')+' '+(r.name||'')).trim())}</div>
      <button class="btn btn-neutral btn-xs" onclick="this.closest('dialog').close()">Fermer</button>
    </div>
    <div class="dlg-body" style="padding:14px">
      ${r.deleteRequest?`
        <div class="small" style="margin-bottom:12px;border:1px dashed #f59e0b;background:#fff7ed;border-radius:8px;padding:8px">
          <b>Demande de suppression</b>${r.deleteRequest.requestedAt? ' ‚Äî '+fmtDT(r.deleteRequest.requestedAt):''}<br>
          Motif : ${escapeHtml(r.deleteRequest.reason||'')}
        </div>`:''}
      <div class="action-dialog__grid">
        <button class="btn btn-neutral btn-xs" id="t_restore">‚ôªÔ∏è Restaurer</button>
        ${ROLE.role==='admin'
          ? `<button id="t_delete" class="btn btn-warn btn-xs" title="Supprimer d√©finitivement" aria-label="Supprimer d√©finitivement" style="width:28px;height:28px;min-width:0;padding:0;display:inline-flex;align-items:center;justify-content:center;border-radius:8px;line-height:1"><i class="fa-solid fa-trash" style="font-size:12px;line-height:1"></i></button>
             ${r.deleteRequest? `<button class="btn btn-ghost btn-xs" id="t_reject">üö´ Refuser la demande</button>`:''}`
          : `<span class="small" style="align-self:center">En attente d√©cision de l‚Äôadmin‚Ä¶</span>`}
      </div>
    </div>`;
  document.body.appendChild(dlg); dlg.showModal?.() ?? dlg.setAttribute('open','');
  $('#t_restore',dlg).onclick=async()=>{ await db.collection('rdv').doc(r.id).set({deleted:false,deletedAt:firebase.firestore.FieldValue.delete(),deleteRequest:firebase.firestore.FieldValue.delete()},{merge:true}); dlg.close?.(); dlg.remove(); await loadAll(); };
  $('#t_delete',dlg)?.addEventListener('click', ()=>approveDelete(r));
  $('#t_reject',dlg)?.addEventListener('click', ()=>rejectDelete(r));
}

async function sendReminder(r){
  // Accepte un id de doc ou un objet RDV
  if (typeof r === 'string') {
    const s = await db.collection('rdv').doc(r).get();
    if (s.exists) r = { id: s.id, ...s.data() }; else return;
  }

  // Choix du canal: wa par d√©faut, sinon sms
  const ch = ((r.channel || r.firstMsgChannel || 'wa') + '').toLowerCase();

  // Texte depuis le template "rappel" (avec fallback agence -> d√©fauts)
  const text = msgFromTpl(
    'rappel',
    r.agency,
    r.dateText || '',
    r.timeText || '',
    r.model || '',
    null,
    null,
    null,
    ch
  );

  try {
    openChannelAndLog(r.phone, text, ch);
    await markReminder(r, ch);
    notify('Rappel envoy√© ‚úîÔ∏è', 'ok');
  } catch (e) {
    console.error(e);
    notify('Erreur envoi rappel', 'warn');
  }
}

/* Modifier RDV ‚Äî avec choix du canal par d√©faut */
async function openEditDialog(id){
  const snap=await db.collection('rdv').doc(id).get(); if(!snap.exists) return alert('RDV introuvable');
  const r={id:snap.id,...snap.data()};
  const frPhone = toFR(r.phone||'');
  const agencyOptions = mergedAgencyKeys().map(a=>`<option ${r.agency===a?'selected':''}>${a}</option>`).join('');

  // Canal actuel (pr√©f√©rence) : priorise r.channel, sinon firstMsgChannel, sinon WA
  const currentCh = ((r.channel || r.firstMsgChannel || 'wa')+'').toLowerCase();
  const dlg=document.createElement('dialog');
  dlg.innerHTML=`<div class="dlg-head" style="padding:14px 16px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center">
    <div style="font-weight:800">Modifier le rendez-vous</div>
    <button class="btn btn-neutral btn-xs" onclick="this.closest('dialog').close()">Fermer</button></div>
    <div class="dlg-body" style="padding:16px">
      <div class="row">
        <div style="flex:1"><div class="label">Agence</div><select id="ed_agency" class="input">${agencyOptions}</select></div>
      </div>
      <div class="row">
        <div style="flex:1"><div class="label">Civilit√©</div>
          <select id="ed_civ" class="input"><option ${r.civ==='M.'?'selected':''}>M.</option><option ${r.civ==='Mme'?'selected':''}>Mme</option></select>
        </div>
        <div style="flex:2"><div class="label">Pr√©nom</div><input id="ed_name" class="input" value="${r.name||''}"></div>
      </div>
      <div class="row">
        <div style="flex:1"><div class="label">Date (JJ/MM/AA)</div><input id="ed_date" class="input" value="${r.dateText||''}" inputmode="numeric"></div>
        <div style="flex:1"><div class="label">Heure (HH:MM)</div><input id="ed_time" class="input" value="${r.timeText||''}" inputmode="numeric"></div>
      </div>

      <div class="label">T√©l√©phone (06/07 ‚Äî 10 chiffres ou +33 6/7)</div>
      <input id="ed_phone" class="input" value="${frPhone}" inputmode="tel" placeholder="06 12 34 56 78 ou +33 6 12 34 56 78">

      <div class="label">Mod√®le</div><input id="ed_model" class="input" value="${r.model||''}">
      <div class="label">Source</div><input id="ed_source" class="input" value="${r.source||''}">

      <!-- ‚¨áÔ∏è NOUVEAU : Canal pr√©f√©r√© -->
      <div class="label">Canal par d√©faut pour les messages</div>
      <select id="ed_channel" class="input">
        <option value="wa" ${currentCh==='wa'?'selected':''}>WhatsApp</option>
        <option value="sms" ${currentCh==='sms'?'selected':''}>SMS</option>
      </select>

      <div class="row mt12" style="justify-content:flex-end;gap:8px">
        <button id="ed_save" class="btn btn-primary btn-xs">Enregistrer</button>
      </div>
    </div>`;
  document.body.appendChild(dlg); dlg.showModal?.() ?? dlg.setAttribute('open','');

  // Normalisation live du t√©l√©phone
  $('#ed_phone',dlg).addEventListener('input', e=>{
    const n = normalizeFR10(e.target.value);
    e.target.value = n ? formatFR10(n) : formatFR10((e.target.value||'').replace(/\D/g,''));
  });

  // Enregistrer
  $('#ed_save',dlg).onclick=async()=>{
    const agency=$('#ed_agency',dlg).value, civ=$('#ed_civ',dlg).value, name=$('#ed_name',dlg).value.trim(),
          d=$('#ed_date',dlg).value.trim(), t=$('#ed_time',dlg).value.trim(),
          p10=normalizeFR10($('#ed_phone',dlg).value), m=$('#ed_model',dlg).value.trim(), s=$('#ed_source',dlg).value.trim(),
          ch=$('#ed_channel',dlg).value; // 'wa' | 'sms'

    if(!agency||!civ||!name||!/^\d{2}\/\d{2}\/\d{2}$/.test(d)||!/^\d{2}:\d{2}$/.test(t)||!m||!p10){
      alert('V√©rifie agence, civilit√©, date/heure, mod√®le et t√©l√©phone (06/07 ou +33 6/7).'); return;
    }

    const patch={
      agency,civ,name,
      dateText:d, dateISO:jjmma_to_iso(d), timeText:t,
      model:m, source:s,
      phone:("33"+p10.slice(1)),
      channel: ch, // ‚¨ÖÔ∏è on enregistre la pr√©f√©rence
      updatedAt:firebase.firestore.FieldValue.serverTimestamp()
    };

    await db.collection('rdv').doc(id).set(patch,{merge:true});
    dlg.close?.(); dlg.remove(); loadAll();
  };
}

/* Reporter RDV */
async function openReschedDialog(id){
  const snap=await db.collection('rdv').doc(id).get(); if(!snap.exists) return alert('RDV introuvable');
  const r={id:snap.id,...snap.data()}; if(r.status==='honored'){ alert('Un RDV honor√© ne peut pas √™tre report√©.'); return; }
  const dlg=document.createElement('dialog');
  dlg.innerHTML=`<div class="dlg-head" style="padding:14px 16px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center">
    <div style="font-weight:800">Reporter le rendez-vous</div>
    <button class="btn btn-neutral btn-xs" onclick="this.closest('dialog').close()">Fermer</button></div>
    <div class="dlg-body" style="padding:16px">
      <div class="row">
        <div style="flex:1"><div class="label">Nouvelle date (JJ/MM/AA)</div><input id="rs_date" class="input" value="${r.dateText||''}"></div>
        <div style="flex:1"><div class="label">Nouvelle heure (HH:MM)</div><input id="rs_time" class="input" value="${r.timeText||''}"></div>
      </div>
      <div class="row mt12" style="justify-content:flex-end;gap:8px">
        <button id="rs_sms" class="btn btn-neutral btn-xs">Confirmer par SMS</button>
        <button id="rs_wa" class="btn btn-primary btn-xs">Confirmer par WhatsApp</button>
      </div>
    </div>`;
  document.body.appendChild(dlg); dlg.showModal?.() ?? dlg.setAttribute('open','');

  async function doResend(channel){
    const newD=$('#rs_date',dlg).value.trim(), newT=$('#rs_time',dlg).value.trim();
    if(!/^\d{2}\/\d{2}\/\d{2}$/.test(newD)||!/^\d{2}:\d{2}$/.test(newT)){ alert('V√©rifie la date/heure.'); return; }
    const patch={ dateText:newD, timeText:newT, dateISO:jjmma_to_iso(newD), updatedAt:firebase.firestore.FieldValue.serverTimestamp(),
      reminderSent:false, reminderAt:firebase.firestore.FieldValue.delete(), reminderChannel:firebase.firestore.FieldValue.delete() };
    if(r.status==='cancelled' || r.status==='no_show'){ patch.status=firebase.firestore.FieldValue.delete(); patch.statusAt=firebase.firestore.FieldValue.delete(); patch.honorBilling=firebase.firestore.FieldValue.delete(); }
    if(r.deleted===true){ patch.deleted=false; patch.deletedAt=firebase.firestore.FieldValue.delete(); patch.deleteRequest=firebase.firestore.FieldValue.delete(); }
    await db.collection('rdv').doc(id).set(patch,{merge:true});
const text = msgFromTpl('report', r.agency, newD, newT, r.model||'', r.dateText||'', r.timeText||'', null, channel);    try{
      openChannelAndLog(r.phone, text, channel);
      await db.collection('messages').add({ type:'reschedule', rdvId:r.id, phone:r.phone, agency:r.agency, channel, sentAt:firebase.firestore.FieldValue.serverTimestamp() });
      notify('Report confirm√© ‚úîÔ∏è','ok'); dlg.close?.(); dlg.remove(); loadAll();
    }catch{ notify('Erreur envoi confirmation','warn'); }
  }
  $('#rs_sms',dlg).onclick=()=>doResend('sms');
  $('#rs_wa',dlg).onclick=()=>doResend('wa');
}

/* Export CSV */
$('#btnExportCur').onclick=()=>exportMonth(false);
$('#btnExportPrev').onclick=()=>exportMonth(true);
async function exportMonth(prev=false){
  const d=new Date(); let y=d.getFullYear(), m=d.getMonth()+1; if(prev){ m--; if(m===0){m=12;y--;}}
  const start=`${y}-${pad(m)}-01`, endDate=new Date(y,m,0).getDate(), end=`${y}-${pad(m)}-${pad(endDate)}`;
  const label=`${pad(m)}/${y}`;
  let rows=[];
  try{
    const rdv=await db.collection('rdv').get();
    rows=rdv.docs.map(x=>({id:x.id,...x.data()})).filter(r=>!r.deleted && (r.dateISO||'')>=start && (r.dateISO||'')<=end);
  }catch(e){ notify('Erreur export','warn'); return; }
  const csv1='\uFEFF' + ['Agence;Nom;T√©l√©phone;Date;Heure;Mod√®le;Source;Statut'].concat(
    rows.map(r=>[(r.agency||''),(r.name||''),(r.phone||''),(r.dateText||''),(r.timeText||''),(r.model||''),(r.source||''),(r.status||'')].join(';'))
  ).join('\n');
  const byA={}; rows.forEach(r=>{ const k=r.agency||'(inconnu)'; if(!byA[k]) byA[k]={agence:k,total:0,honor√©s:0,non_venus:0,annul√©s:0};
    byA[k].total++; if(r.status==='honored') byA[k].honor√©s++; if(r.status==='no_show') byA[k].non_venus++; if(r.status==='cancelled') byA[k].annul√©s++; });
  const header2='Agence;Total;Honor√©s;Non venus;Annul√©s';
  const csv2='\uFEFF'+[header2].concat(Object.values(byA).map(a=>[a.agence,a.total,a.honor√©s,a.non_venus,a.annul√©s].join(';'))).join('\n');
  const dl=(content,name)=>{ const blob=new Blob([content],{type:'text/csv;charset=utf-8'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=name; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),1500); };
  dl(csv1,`stats-${label}.csv`); dl(csv2,`stats-par-agence-${label}.csv`);
}

/* Admin: r√©glages stats (simple) */
function openAdminDialog(){
  const dlg=document.createElement('dialog');
  dlg.innerHTML=`<div class="dlg-head" style="padding:14px 16px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center">
    <div style="font-weight:800">Stats admin</div>
    <button class="btn btn-neutral btn-xs" onclick="this.closest('dialog').close()">Fermer</button></div>
    <div class="dlg-body" style="padding:16px">
      <div class="row">
        <button class="btn btn-neutral btn-xs" id="setCreated">Fixer ‚ÄúEnregistr√©s‚Äù</button>
        <button class="btn btn-neutral btn-xs" id="setHonored">Fixer ‚ÄúHonor√©s‚Äù</button>
        <button class="btn btn-neutral btn-xs" id="setReminders">Fixer ‚ÄúRappels‚Äù</button>
      </div>
    </div>`;
  document.body.appendChild(dlg); dlg.showModal?.() ?? dlg.setAttribute('open','');
  const statId=`${new Date().getFullYear()}-${pad(new Date().getMonth()+1)}`;
  $('#setCreated',dlg).onclick=async()=>{ const cur=Number($('#k_created')?.textContent||'0'); const v=prompt('Nouveau ‚ÄúEnregistr√©s‚Äù :',cur); if(v==null) return; await db.collection('stats').doc(statId).set({created:parseInt(v,10)||0},{merge:true}); loadAll(); };
  $('#setHonored',dlg).onclick=async()=>{ const cur=Number($('#k_honored')?.textContent||'0'); const v=prompt('Nouveau ‚ÄúHonor√©s‚Äù :',cur); if(v==null) return; await db.collection('stats').doc(statId).set({honored:parseInt(v,10)||0},{merge:true}); loadAll(); };
  $('#setReminders',dlg).onclick=async()=>{ const cur=Number($('#k_reminders')?.textContent||'0'); const v=prompt('Nouveau ‚ÄúRappels‚Äù :',cur); if(v==null) return; await db.collection('stats').doc(statId).set({reminders:parseInt(v,10)||0},{merge:true}); loadAll(); };
}
$('#btnAdminStats').onclick=()=>{ if(ROLE.role!=='admin') return alert('R√©serv√© √† l‚Äôadmin.'); openAdminDialog(); };

/* Agences (liste + modale) */
$('#btnAgencies')?.addEventListener('click', ()=>{
    document.getElementById('btnReminders')?.addEventListener('click', ()=>{ openRemindersPanel(); });
  if (ROLE.role!=='admin') return alert('R√©serv√© √† l‚Äôadmin.');
  openAgenciesPanel();
});
// ...
document.getElementById('btnReminders')?.addEventListener('click', openRemindersPanel);
function renderAgencies(container){
  const isAdmin = (ROLE.role==='admin');
  container.innerHTML='';
  const keys = mergedAgencyKeys();
  const head=document.createElement('div'); head.className='row';
  head.innerHTML=`${isAdmin?'<button class="btn btn-primary btn-xs" id="btnNewAgency">+ Nouvelle agence</button>':''}<span class="small" style="align-self:center">Total : ${keys.length}</span>`;
  container.appendChild(head);
  if(keys.length===0){ const empty=document.createElement('div'); empty.className='small mt12'; empty.textContent='Aucune agence d√©finie.'; container.appendChild(empty); return; }
  keys.forEach(k=>{
    const ag=getAgencyByKey(k)||{};
    const name=ag.name||k, addr=ag.addr||'', map=ag.map||'', tag=ag.tagline||name;
    const card=document.createElement('div'); card.className='ag-card';
    card.innerHTML=`<div style="flex:1">
        <div class="ag-name">${escapeHtml(name)}</div>
        <div class="small">${addr ? escapeHtml(addr) : '<i>Adresse non renseign√©e</i>'}</div>
        <div class="small">${map ? `<a href="${map}" target="_blank">Plan d‚Äôacc√®s</a>` : '<i>Plan non renseign√©</i>'}</div>
        <div class="small">Slogan : ${escapeHtml(tag)}</div>
      </div>
      <div class="row" style="gap:6px">${isAdmin? `<button class="btn btn-neutral btn-xs" data-edit="${escapeHtml(k)}">Modifier</button>` : ''}</div>`;
    container.appendChild(card);
  });
  document.getElementById('btnNewAgency')?.addEventListener('click', ()=>openAgencyModal());
  container.querySelectorAll('button[data-edit]')?.forEach(b=>{ b.addEventListener('click', ()=>openAgencyModal(b.getAttribute('data-edit'))); });
}
function openAgencyModal(key=null){
  const cur = key ? getAgencyByKey(key) : {name:'',addr:'',map:'',tagline:'', priceHonorTTC: undefined, templates:null};
  const tplsRaw = (getAgencyTemplates(key)||{}) || {};

  // ‚ñ∂Ô∏é Normalisation: toujours { type: { wa: string, sms: string } }
  const TYPES = ['confirmation','rappel','report','annulation','no_show'];
  function normalizeTemplates(t){
    const out = {};
    for(const ty of TYPES){
      const v = t?.[ty];
      if(typeof v === 'string'){
        out[ty] = { wa: v, sms: v };
      }else if(v && typeof v === 'object'){
        const wa  = v.wa  ?? v.WA  ?? v.whatsapp ?? v.default ?? TPL_DEFAULTS[ty];
        const sms = v.sms ?? v.SMS ?? v.default  ?? TPL_DEFAULTS[ty];
        out[ty] = { wa: wa || sms || TPL_DEFAULTS[ty], sms: sms || wa || TPL_DEFAULTS[ty] };
      }else{
        out[ty] = { wa: TPL_DEFAULTS[ty], sms: TPL_DEFAULTS[ty] };
      }
    }
    return out;
  }
  const norm = normalizeTemplates(tplsRaw);

  const dlg=document.createElement('dialog');
  dlg.innerHTML=`
  <div class="dlg-head" style="padding:14px 16px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center">
    <div style="font-weight:800">${key?'Modifier':'Nouvelle'} agence</div>
    <button class="btn btn-neutral btn-xs" onclick="this.closest('dialog').close()">Fermer</button>
  </div>
  <div class="dlg-body" style="padding:16px;max-width:860px">
    <div class="row">
      <div style="flex:1;min-width:220px">
        <div class="label">Nom de l‚Äôagence</div>
        <input id="ag_name" class="input" placeholder="Ex : ID Auto (La Roche sur Yon)" value="${key||''}" ${key?'disabled':''}>
      </div>
      <div style="flex:1;min-width:220px">
        <div class="label">Slogan (tagline)</div>
        <input id="ag_tagline" class="input" placeholder="Ex : L‚Äôautomobile et vous" value="${cur.tagline||''}">
      </div>
    </div>

    <div class="label">Adresse</div>
    <input id="ag_addr" class="input" placeholder="Rue, CP Ville" value="${cur.addr||''}">

    <div class="label">Lien plan (Google Maps)</div>
    <input id="ag_map" class="input" placeholder="https://..." value="${cur.map||''}">

    <div class="label">Prix TTC par RDV honor√© (‚Ç¨)</div>
    <input id="ag_price" class="input" inputmode="decimal" placeholder="Ex : 50"
           value="${(typeof cur.priceHonorTTC==='number' && !isNaN(cur.priceHonorTTC)) ? cur.priceHonorTTC : ''}">

    <div class="label mt12">Jetons disponibles (cliquer pour ins√©rer)</div>
    <div class="tokenbar" id="ag_tokens">
      ${['{{AGENCE}}','{{ADRESSE}}','{{PLAN}}','{{TAGLINE}}','{{DATE_LONG}}','{{DATE_TXT}}','{{HEURE}}','{{MODELE}}','{{OLD_DATE_LONG}}','{{OLD_HEURE}}','{{CIV}}','{{PRENOM}}'].map(t=>`<span class="token" data-token="${t}">${t}</span>`).join('')}
    </div>

    <div class="label mt12">Canal</div>
    <div class="ch-tabs" id="ch_tabs" style="display:flex;gap:6px;flex-wrap:wrap">
      <button type="button" class="btn btn-neutral btn-xs ch-btn is-active" data-ch="wa">WhatsApp</button>
      <button type="button" class="btn btn-neutral btn-xs ch-btn" data-ch="sms">SMS</button>
    </div>

    <div class="template-tabs" style="margin-top:8px">
      <div class="t active" data-tab="confirmation">Confirmation</div>
      <div class="t" data-tab="rappel">Rappel</div>
      <div class="t" data-tab="report">Report</div>
      <div class="t" data-tab="annulation">Annulation</div>
      <div class="t" data-tab="no_show">Pas venu</div>
    </div>

    <div id="tpl_wrap">
      <textarea id="tpl_text" class="input" rows="10" placeholder="Mod√®le de message..."></textarea>
      <div class="label mt8">Aper√ßu</div>
      <div id="tpl_preview" class="preview"></div>
    </div>

    <div class="row mt12" style="justify-content:space-between;gap:8px">
      <div>${key?'<button class="btn btn-warn btn-xs" id="ag_delete">Supprimer agence</button>':''}</div>
      <div><button class="btn btn-neutral btn-xs" id="ag_save">Enregistrer</button></div>
    </div>
  </div>`;
  document.body.appendChild(dlg); dlg.showModal?.() ?? dlg.setAttribute('open','');

  const state = {
    currentTab: 'confirmation',
    currentChannel: 'wa',
    templates: norm // { type: { wa, sms } }
  };

  const $m=(s)=>$(s,dlg);
  const $$m=(s)=>$$(s,dlg);

  function refreshEditor(){
    const val = state.templates[state.currentTab]?.[state.currentChannel] || '';
    $m('#tpl_text').value = val;
    refreshPreview();
  }

  function refreshPreview(){
    const demoCtx = buildCtx(
      $m('#ag_name').value || (cur.name||'Agence'),
      iso_to_jjmma(todayISO()), '14:30', 'Peugeot 308',
      iso_to_jjmma(todayISO()), '10:00',
      {CIV:'M.', PRENOM:'Amine'}
    );
    $m('#tpl_preview').textContent = fillTokens($m('#tpl_text').value, demoCtx);
  }

  function setActiveTab(tab){
    state.currentTab=tab;
    $$m('.template-tabs .t').forEach(x=>x.classList.toggle('active', x.dataset.tab===tab));
    refreshEditor();
  }

  function setActiveChannel(ch){
    state.currentChannel = ch;
    $$m('.ch-btn').forEach(b=> b.classList.toggle('is-active', b.dataset.ch===ch));
    refreshEditor();
  }

  // Init UI interactions
  setActiveTab('confirmation');
  $$m('.template-tabs .t').forEach(x=> x.onclick=()=>setActiveTab(x.dataset.tab));
  $$m('.ch-btn').forEach(x=> x.onclick=()=>setActiveChannel(x.dataset.ch));

  $m('#tpl_text').addEventListener('input',()=>{
    const taVal = $m('#tpl_text').value;
    if(!state.templates[state.currentTab]) state.templates[state.currentTab] = {wa:'',sms:''};
    state.templates[state.currentTab][state.currentChannel] = taVal;
    refreshPreview();
  });

  $$m('#ag_tokens .token').forEach(t=> t.onclick=()=>{
    const ta=$m('#tpl_text'); const tok=t.dataset.token;
    const s=ta.selectionStart||0, e=ta.selectionEnd||0; const val=ta.value;
    ta.value=val.slice(0,s)+tok+val.slice(e);
    ta.focus(); ta.selectionStart=ta.selectionEnd=s+tok.length;
    state.templates[state.currentTab][state.currentChannel]=ta.value;
    refreshPreview();
  });

  // Prefill fields if editing
  if(key){
    $m('#ag_name').value   = key;
    $m('#ag_tagline').value= cur.tagline||'';
    $m('#ag_addr').value   = cur.addr||'';
    $m('#ag_map').value    = cur.map||'';
  }

  // First render
  refreshEditor();

  // Save
  $m('#ag_save').onclick=async()=>{
    const name=($m('#ag_name').value||'').trim(); if(!name) return alert('Nom d‚Äôagence obligatoire.');
    const docRef=db.collection('agencies').doc(name);
    const data={
      name,
      addr: ($m('#ag_addr').value||'').trim(),
      map: ($m('#ag_map').value||'').trim(),
      tagline: ($m('#ag_tagline').value||'').trim(),
      templates: state.templates, // <-- sauvegarde wa/sms
      disabled: false
    };

    // Prix TTC (euros / centimes)
    const rawPrix = ($m('#ag_price')?.value ?? '').trim();
    if (rawPrix !== '') {
      const cleaned = rawPrix.replace(/[^\d,.\-]/g, '').replace(',', '.');
      const prix = Number(cleaned);
      if (!Number.isFinite(prix) || prix < 0) {
        alert('Prix TTC invalide. Exemple : 50 ou 50,00');
        return;
      }
      data.priceHonorTTC   = Math.round(prix * 100) / 100;
      data.priceHonorCents = Math.round(prix * 100);
    }

    try{
      await docRef.set(data,{merge:true});
      notify('Agence enregistr√©e ‚úîÔ∏è','ok'); dlg.close?.(); dlg.remove();
      await loadAgenciesDB(); populateWizardAgencies(); populateAgencyFilter(); if(VIEW==='agencies') renderList();
    }catch(e){
      alert('Erreur enregistrement agence.');
    }
  };

  // Delete
  $m('#ag_delete')?.addEventListener('click', async()=>{
    if(!confirm('Supprimer cette agence ?')) return;
    try{
      const ref = db.collection('agencies').doc(key);
      if (AGENCIES[key]) { await ref.set({ disabled:true }, { merge:true }); }
      else { await ref.delete(); }
      notify('Agence supprim√©e ‚úîÔ∏è','ok'); dlg.close?.(); dlg.remove();
      await loadAgenciesDB(); populateWizardAgencies(); populateAgencyFilter(); if(VIEW==='agencies') renderList();
    }catch(e){ alert('Erreur suppression agence.'); }
  });
}
function openAgenciesPanel(){
  const keys = mergedAgencyKeys();
  const dlg = document.createElement('dialog');
  dlg.style.maxWidth = '900px'; dlg.style.width = 'min(96vw,900px)';
  dlg.innerHTML = `
    <div class="dlg-head" style="padding:12px 14px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between">
      <div style="font-weight:800">Agences</div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-neutral btn-xs" id="ag_new">+ Nouvelle agence</button>
        <button class="btn btn-neutral btn-xs" onclick="this.closest('dialog').close()">Fermer</button>
      </div>
    </div>
    <div class="dlg-body" style="padding:16px;max-height:70vh;overflow:auto">
      ${keys.length===0 ? `<div class="small">Aucune agence d√©finie.</div>` : `
        <div style="display:grid;gap:10px">
          ${keys.map(k=>{
            const ag = getAgencyByKey(k) || {};
            const name = ag.name || k; const addr = ag.addr || ''; const map  = ag.map  || ''; const tag  = ag.tagline || name;
            return `
              <div class="ag-card">
                <div style="flex:1">
                  <div class="ag-name">${escapeHtml(name)}</div>
                  <div class="small">${addr ? escapeHtml(addr) : '<i>Adresse non renseign√©e</i>'}</div>
                  <div class="small">${map ? `<a href="${map}" target="_blank">Plan d‚Äôacc√®s</a>` : '<i>Plan non renseign√©</i>'}</div>
                  <div class="small">Slogan : ${escapeHtml(tag)}</div>
                </div>
                <div class="row" style="gap:6px"><button class="btn btn-neutral btn-xs" data-edit="${escapeHtml(k)}">Modifier</button></div>
              </div>
            `;
          }).join('')}
        </div>`}
    </div>`;
  document.body.appendChild(dlg); dlg.showModal?.() ?? dlg.setAttribute('open','');
  dlg.querySelector('#ag_new')?.addEventListener('click', ()=>{ dlg.close?.(); dlg.remove(); openAgencyModal(); });
  dlg.querySelectorAll('button[data-edit]')?.forEach(btn=>{ btn.addEventListener('click', ()=>{ const key=btn.getAttribute('data-edit'); dlg.close?.(); dlg.remove(); openAgencyModal(key); }); });
}

/* Onglets : clics & active */
function bindTabs(){
  document.querySelectorAll('.tabs .tab').forEach(t=>{
    t.addEventListener('click', ()=>{
      const v=t.getAttribute('data-view'); VIEW=v; SHOW_ONLY_REQ=false; PAGE=1;
      document.querySelectorAll('.tabs .tab').forEach(x=>x.classList.toggle('active', x===t));
      renderList();
    });
  });
}

/* Chips statut (si pr√©sents) */
function currentYM(){ const d=new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}`; }
function isInCurrentMonthByDateISO(r){ const ym=currentYM(); return !!(r?.dateISO||'').startsWith(ym); }
function isInCurrentMonthByTS(ts){ const d=ts?.toDate ? ts.toDate() : (ts instanceof Date ? ts : null); if(!d) return false; const now=new Date(); return (d.getFullYear()===now.getFullYear() && d.getMonth()===now.getMonth()); }
function countMonthStatus(status){ return ALL_R.filter(r=>!r.deleted && r.status===status && isInCurrentMonthByDateISO(r)).length; }
function countRemindersMonth(){ return ALL_R.filter(r=>!r.deleted && r.reminderSent && isInCurrentMonthByTS(r.reminderAt)).length; }
function updateStatusChips(){
  const up=countUpcoming(); const todo=computeTodo(); const hon=countMonthStatus('honored'); const ns=countMonthStatus('no_show'); const ca=countMonthStatus('cancelled'); const rem=countRemindersMonth();
  const set=(id,val)=>{ const el=document.getElementById(id); if(el) el.textContent=String(val); };
  set('chip_upcoming',up); set('chip_todo',todo); set('chip_honored',hon); set('chip_noshow',ns); set('chip_cancelled',ca); set('chip_reminders',rem);
}
function bindStatusChips(){
  document.querySelectorAll('#statusChips .chip[data-go]')?.forEach(btn=>{
    btn.onclick=()=>{ const v=btn.getAttribute('data-go'); VIEW=v; PAGE=1; document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active', t.dataset.view===v)); renderList(); };
  });
}

/* Tick auto */
setInterval(()=>{ if($('#app').classList.contains('hide')) return; if(document.hidden) return;
  if(['today','past','upcoming','trash','todo','tomorrow','honored','no_show','cancelled'].includes(VIEW)) renderList();
  computeDueToday(); computeUpcoming(); computeTodo(); updatePendingButton();
  updateReminderButton();
},30*1000);

/* Overlay blanc + scroll-lock quand un <dialog> est ouvert */
(function(){
  let overlay=document.getElementById('cn-white-overlay'); if(!overlay){ overlay=document.createElement('div'); overlay.id='cn-white-overlay'; document.body.appendChild(overlay); }
  const root=document.documentElement;
  function showOverlay(){ overlay.classList.add('is-visible'); root.classList.add('modal-open'); document.body.classList.add('modal-open'); }
  function hideOverlay(){ overlay.classList.remove('is-visible'); root.classList.remove('modal-open'); document.body.classList.remove('modal-open'); }
  function syncOverlay(){ const anyOpen=!!document.querySelector('dialog[open]'); if(anyOpen) showOverlay(); else hideOverlay(); }
  const mo=new MutationObserver(syncOverlay); mo.observe(document.body,{subtree:true,childList:true,attributes:true,attributeFilter:['open']});
  window.addEventListener('keydown', e => { if(e.key==='Escape') setTimeout(syncOverlay,0); });
  document.addEventListener('close', e => { if(e.target?.nodeName==='DIALOG') setTimeout(syncOverlay,0); }, true);
  syncOverlay();
})();

/* Divers */
$('#btnRefresh').onclick=()=>loadAll();
// ======= üîÑ R√©activit√© fiche RDV (ajouts) =======
let CURRENT_SHEET = null;
function getRDVById(id){ return ALL_R.find(x=>x.id===id) || null; }
function patchRDV(id, patch={}){ const r=getRDVById(id); if(!r) return null; Object.assign(r, patch); return r; }

function sheetStatusLabel(r){
  if(r.status==='honored') return 'Honor√©' + (r.honorBilling==='factur√©' ? ' ‚Ä¢ Factur√©' : (r.honorBilling==='non_facturable'?' ‚Ä¢ Non facturable':''));
  if(r.status==='no_show') return 'Non honor√©';
  if(r.status==='cancelled') return 'Annul√©';
  return 'Pr√©vu';
}

function renderSheetBubblesHTML(r){
  const ag = getAgencyByKey(r.agency||'');
  const name = ((r.civ||'')+' '+(r.name||'')).trim();
  const dueNote = r.noteDueISO ? (r.noteDueISO===todayISO() ? 'aujourd‚Äôhui' : (r.noteDueISO===isoOf(addDays(new Date(),1)) ? 'demain' : dateLongueISO(r.noteDueISO))) : null;

  const statusB =
    r.status==='honored' ? `<span class="bubble green">Honor√©${r.honorBilling? (r.honorBilling==='factur√©'?' ‚Ä¢ Factur√©':' ‚Ä¢ Non facturable') : ''}</span>` :
    r.status==='no_show' ? `<span class="bubble orange">Non honor√©</span>` :
    r.status==='cancelled' ? `<span class="bubble gray">Annul√©</span>` : '';

  const remindB = r.reminderSent ? `<span class="bubble green">Rappel envoy√© ‚Ä¢ ${fmtDT(r.reminderAt)} ‚Ä¢ ${(r.reminderChannel||'').toUpperCase()}</span>` : '';
  const gesteB = r.gesteCommercial ? `<span class="bubble blue">üéÅ Geste ${typeof r.gesteAmount==='number'&&!isNaN(r.gesteAmount)? (r.gesteAmount.toFixed(0)+'‚Ç¨') : ''}</span>` : '';
  const noteB = (r.noteText||'').trim()
    ? `<span class="bubble blue">üìù ${escapeHtml(((r.noteText||'').trim().length>80)?(r.noteText||'').trim().slice(0,80)+'‚Ä¶':(r.noteText||'').trim())}${dueNote?(' ‚Ä¢ '+dueNote):''}</span>`
    : '';

  return `
    ${r.agency?`<span class="badge">${escapeHtml(r.agency)}</span>`:''}
    ${iconForChannel(r)}
    ${statusB}
    ${remindB}
    ${gesteB}
    ${noteB}
  `;
}

function renderSheetActionsHTML(r){
  const allowResched = r.status!=='honored';
  const allowCancel  = r.status!=='honored' && r.status!=='cancelled';
  const ch = (r.firstMsgChannel||r.channel||'').toUpperCase();
  const gesteLabel = r.gesteCommercial ? ('Geste '+(typeof r.gesteAmount==='number'&&!isNaN(r.gesteAmount)? r.gesteAmount.toFixed(0)+'‚Ç¨' : '‚úì')) : 'Geste comm.';
  return `
    <a class="btn btn-neutral btn-xs" href="${telHref(r.phone)}">Appeler</a>
    <button class="btn btn-neutral btn-xs" id="sheet_note">Note</button>
    <button class="btn btn-neutral btn-xs" id="sheet_resend">Renvoyer confirmation</button>
    ${!r.reminderSent
      ? `<button class="btn btn-neutral btn-xs" id="sheet_remind">Rappel</button>`
      : `<button class="btn btn-ghost btn-xs" id="sheet_unremind">Annuler rappel</button>`}
    <button class="btn btn-neutral btn-xs" id="sheet_status">Statut</button>
    <button class="btn btn-neutral btn-xs" id="sheet_edit">Modifier</button>
    ${allowResched ? `<button class="btn btn-ghost btn-xs" id="sheet_resched">Reporter</button>` : ''}
    ${allowCancel ? `<button class="btn btn-warn btn-xs" id="sheet_cancel">Annuler RDV</button>` : ''}
    <button class="btn btn-neutral btn-xs" id="sheet_geste">${gesteLabel}</button>
  `;
}

function wireSheetActionButtons(dlg, r){
  $('#sheet_note',dlg).onclick = ()=> openNoteDialog(r.id);
  $('#sheet_resend',dlg).onclick = ()=> resendConfirmation(r);
  $('#sheet_remind',dlg)?.addEventListener('click', ()=> sendReminder(r));
  $('#sheet_unremind',dlg)?.addEventListener('click', ()=> undoReminder(r));
  $('#sheet_status',dlg).onclick = ()=> openStatusDialog(r.id);
  $('#sheet_edit',dlg).onclick = ()=> openEditDialog(r.id);
  $('#sheet_resched',dlg)?.addEventListener('click', ()=> openReschedDialog(r.id));
  $('#sheet_cancel',dlg)?.addEventListener('click', ()=> cancelRDV(r));
  $('#sheet_geste',dlg).onclick = ()=> openGesteDialog(r);
}

function refreshOpenSheet(id){
  if(!CURRENT_SHEET || CURRENT_SHEET.id!==id) return;
  const dlg = CURRENT_SHEET.dlg;
  const r = getRDVById(id); if(!r) return;

  // Stepper
  const prog = dlg.querySelector('#cn_progress_full');
  if(prog) prog.innerHTML = renderStepperHTML(progressFromRDV(r), false);

  // Bubbles (ent√™te)
  const bubbles = dlg.querySelector('#sheet_bubbles');
  if(bubbles) bubbles.innerHTML = renderSheetBubblesHTML(r);

  // Actions (ligne boutons)
  const actions = dlg.querySelector('.sheet-actions');
  if(actions){ actions.innerHTML = renderSheetActionsHTML(r); wireSheetActionButtons(dlg, r); }
}

// ======= üõ†Ô∏è on remplace openRDVSheet pour poser 2 IDs (#sheet_bubbles + .sheet-actions) =======
const _openRDVSheet_original = openRDVSheet;
openRDVSheet = function(r){
  // on reconstruit la m√™me fiche mais avec un id sur les bulles
  const ag = getAgencyByKey(r.agency||'');
  const dueNote = r.noteDueISO ? (r.noteDueISO===todayISO() ? 'aujourd‚Äôhui' : (r.noteDueISO===isoOf(addDays(new Date(),1)) ? 'demain' : dateLongueISO(r.noteDueISO))) : null;
  const dlg=document.createElement('dialog');
  dlg.innerHTML=`
    <div class="dlg-head" style="padding:14px 16px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:800">Fiche rendez-vous</div>
      <button class="btn btn-neutral btn-xs" onclick="this.closest('dialog').close()">Fermer</button>
    </div>
    <div class="dlg-body" style="padding:16px;max-width:860px">
      <div class="title" style="margin-bottom:6px">${fmtNice(r.dateISO,r.timeText)} ‚Äî ${escapeHtml(((r.civ||'')+' '+(r.name||'')).trim())}</div>
      <div class="small">${toFR(r.phone)} ‚Ä¢ ${escapeHtml(r.model||'')} ‚Ä¢ Source : ${escapeHtml(r.source||'')}</div>

      <div id="sheet_bubbles" class="mt8" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        ${renderSheetBubblesHTML(r)}
      </div>

      <div class="card" style="margin-top:12px">
        <div class="label">Aper√ßu rapide</div>
        <div id="cn_progress_full">${renderStepperHTML(progressFromRDV(r), false)}</div>
      </div>

      <div class="row mt12 sheet-actions" style="gap:8px">
        ${renderSheetActionsHTML(r)}
      </div>

      <div class="card mt12 rdv-agency">
        <div class="label">Agence</div>
        <div class="small"><b>${escapeHtml(ag.name||r.agency||'')}</b></div>
        ${ag.addr ? `<div class="ag-line">üìç <span>${escapeHtml(ag.addr)}</span></div>` : ''}
        ${ag.map  ? `<div class="ag-line">üó∫Ô∏è <a href="${ag.map}" target="_blank" rel="noopener">Plan d‚Äôacc√®s</a></div>` : ''}
        ${ag.phone ? `<div class="ag-line">üìû <a href="tel:${ag.phone.replace(/\D/g,'')}">${escapeHtml(ag.phone)}</a></div>` : ''}
        ${ag.tagline ? `<div class="ag-line">üè∑Ô∏è <span>${escapeHtml(ag.tagline)}</span></div>` : ''}
      </div>

      <div id="history_wrap" class="card">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div class="label">Historique du client</div>
          <button class="btn btn-warn btn-xs icon-only" id="btnWipeHistory" title="Effacer tout l‚Äôhistorique">üóëÔ∏è</button>
        </div>
        <div id="history_body"><div class="small">Chargement‚Ä¶</div></div>
      </div>
    </div>`;
  document.body.appendChild(dlg); dlg.showModal?.() ?? dlg.setAttribute('open','');

  CURRENT_SHEET = { id: r.id, dlg };
  dlg.addEventListener('close', ()=>{ if(CURRENT_SHEET?.dlg===dlg) CURRENT_SHEET=null; });
  dlg.addEventListener('cancel',()=>{ if(CURRENT_SHEET?.dlg===dlg) CURRENT_SHEET=null; });

  wireSheetActionButtons(dlg, r);

  $('#btnWipeHistory',dlg).onclick = ()=> openWipeHistoryDialog(r);
  loadAndRenderHistory(r, $('#history_body',dlg));
};

// ======= ‚ö° Surcharges: mise √† jour imm√©diate apr√®s action =======
const _markReminder_original = markReminder;
markReminder = async function(r, channel){
  await _markReminder_original(r, channel);
  // optimiste + refresh
  const patched = patchRDV(r.id, {reminderSent:true, reminderChannel:channel, reminderAt: new Date()});
  refreshOpenSheet(r.id);
};

const _undoReminder_original = undoReminder;
undoReminder = async function(r){
  await _undoReminder_original(r);
  patchRDV(r.id, {reminderSent:false, reminderChannel:undefined, reminderAt:undefined});
  refreshOpenSheet(r.id);
};

const _setHonor_original = setHonor;
setHonor = async function(r, status, billing=null){
  await _setHonor_original(r, status, billing);
  const patch = { status, statusAt:new Date() };
  if(status==='honored'){ patch.honorBilling = billing || null; } else { patch.honorBilling = undefined; }
  patchRDV(r.id, patch);
  refreshOpenSheet(r.id);
};

const _clearHonor_original = clearHonor;
clearHonor = async function(r){
  await _clearHonor_original(r);
  patchRDV(r.id, {status:null, statusAt:undefined, honorBilling:undefined});
  refreshOpenSheet(r.id);
};

const _cancelRDV_original = cancelRDV;
cancelRDV = async function(r){
  await _cancelRDV_original(r);
  patchRDV(r.id, {status:'cancelled', statusAt:new Date(), honorBilling:undefined});
  refreshOpenSheet(r.id);
};

const _openReschedDialog_original = openReschedDialog;
openReschedDialog = async function(id){
  // on utilise l'original, mais on accroche une petite mise √† jour apr√®s succ√®s
  const before = JSON.stringify(getRDVById(id)||{});
  await _openReschedDialog_original(id);
  // Si la date/heure a boug√©, on rafra√Æchit
  const after = getRDVById(id);
  if(after){ refreshOpenSheet(id); }
};
// ======== Statut: UI qui se met √† jour imm√©diatement ========

// Si utilitaire absent, on le d√©finit (ne casse rien si d√©j√† d√©fini)
if (typeof getRDVById !== 'function') {
  window.getRDVById = (id)=> (window.ALL_R||[]).find(x=>x.id===id) || null;
}

function statusKeyOf(r){
  if(!r || !r.status) return 'none';
  if(r.status==='honored') return (r.honorBilling==='non_facturable' ? 'honor_nf' : 'honor_fact');
  if(r.status==='no_show') return 'no_show';
  if(r.status==='cancelled') return 'cancelled';
  return 'none';
}

function renderStatusSegmentHTML(r){
  const cur = statusKeyOf(r);
  const opt = (value, label, sub='')=>{
    const active = (cur===value) ? ' is-active aria-pressed="true"' : ' aria-pressed="false"';
    return `<button type="button" class="opt${active}" data-value="${value}">
      <span class="k">${label}</span>${sub?`<span class="sub">${sub}</span>`:''}
    </button>`;
  };
  return `<div class="seg" id="status_seg">
    ${opt('honor_fact','Honor√© ‚Ä¢ factur√©')}
    ${opt('honor_nf','Honor√© ‚Ä¢ non facturable')}
    ${opt('no_show','Non honor√©')}
    ${opt('cancelled','Annul√©')}
    ${opt('none','Retirer le statut')}
  </div>`;
}

// ‚Äî override soft: on remplace l‚Äôexistant proprement
const _openStatusDialog_original = window.openStatusDialog;

window.openStatusDialog = function(id){
  const r = getRDVById(id);
  const dlg = document.createElement('dialog');
  dlg.innerHTML = `
    <div style="padding:14px 16px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:800">Statut du rendez-vous</div>
      <button class="btn btn-neutral btn-xs" onclick="this.closest('dialog').close()">Fermer</button>
    </div>
    <div style="padding:16px;min-width:320px;max-width:520px">
      <div class="label">Choix</div>
      ${renderStatusSegmentHTML(r)}
      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn btn-neutral" id="stat_validate">Valider</button>
        <button class="btn btn-ghost" onclick="this.closest('dialog').close()">Annuler</button>
      </div>
    </div>`;
  document.body.appendChild(dlg); dlg.showModal?.() ?? dlg.setAttribute('open','');

  // S√©lection visuelle qui suit le clic
  let choice = statusKeyOf(r);
  const seg = dlg.querySelector('#status_seg');
  seg.addEventListener('click', (e)=>{
    const b = e.target.closest('.opt'); if(!b) return;
    choice = b.getAttribute('data-value');
    seg.querySelectorAll('.opt').forEach(x=>{
      x.classList.toggle('is-active', x===b);
      x.setAttribute('aria-pressed', x===b ? 'true' : 'false');
    });
  });

  // Action fonctionnelle (r√©utilise tes fonctions existantes patch√©es)
  dlg.querySelector('#stat_validate').addEventListener('click', async ()=>{
    try{
      if(choice==='honor_fact'){
        await setHonor(r, 'honored', 'factur√©');
      }else if(choice==='honor_nf'){
        await setHonor(r, 'honored', 'non_facturable');
      }else if(choice==='no_show'){
        await setHonor(r, 'no_show');
      }else if(choice==='cancelled'){
        await setHonor(r, 'cancelled');
      }else{
        await clearHonor(r);
      }
      // la fiche se rafra√Æchit d√©j√† gr√¢ce √† tes surcharges setHonor/clearHonor
    }finally{
      dlg.close();
      setTimeout(()=> dlg.remove(), 0);
    }
  });
};

// === AUTO-REFRESH GLOBAL ‚Äî √† coller juste avant </body> ===
(function(){
  const PERIOD = 1000; // 1 seconde

  // √âvite les doublons si inject√© deux fois
  if (window.__autoRefTimer) clearInterval(window.__autoRefTimer);

  function findRefreshButton(){
    const all = Array.from(document.querySelectorAll('button, [role="button"], [data-refresh], .btn'));
    return all.find(el=>{
      const t = (el.textContent||'').toLowerCase();
      const id = (el.id||'').toLowerCase();
      const title = (el.title||'').toLowerCase();
      return el.hasAttribute('data-refresh')
        || /refresh|rafraich|rafra√Æch|actualis/.test(id)
        || /refresh|rafraich|rafra√Æch|actualis/.test(title)
        || /rafra√Æchir|rafraichir|actualiser|refresh/.test(t);
    }) || null;
  }

  function doRefresh(){
    try{
      // 1) Ta/tes fonctions internes si elles existent
      if (typeof refreshAll === 'function') return void refreshAll();
      if (typeof reloadAll  === 'function') return void reloadAll();
      if (typeof loadData   === 'function') return void loadData();
      if (typeof renderAll  === 'function') return void renderAll();

      // 2) Clique le bouton "Rafra√Æchir" si pr√©sent
      const btn = findRefreshButton();
      if (btn) { btn.click(); return; }

      // 3) Si le panneau Rappels est ouvert, forcer juste son re-render
      const dlg = document.querySelector('#remindersDlg');
      if (dlg && typeof dlg.__rerender === 'function') dlg.__rerender();

      // 4) (Optionnel) Dernier recours : recharger la page en dur
      // location.reload(); // ‚Üê d√©commente si tu veux un vrai reload
    }catch(e){
      console.error('auto refresh error', e);
    }
  }

  // Lance maintenant puis toutes les 1 s
  doRefresh();
  window.__autoRefTimer = setInterval(doRefresh, PERIOD);

  // Optionnel : pause si onglet cach√© pour √©viter de spammer
  document.addEventListener('visibilitychange', ()=>{
    if (document.hidden) {
      if (window.__autoRefTimer){ clearInterval(window.__autoRefTimer); window.__autoRefTimer=null; }
    } else {
      if (!window.__autoRefTimer){
        window.__autoRefTimer = setInterval(doRefresh, PERIOD);
        doRefresh();
      }
    }
  });
})();

</script>
</section>
</body>
</html> 
